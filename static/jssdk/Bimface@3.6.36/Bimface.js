"use strict";function _toConsumableArray(e){if(Array.isArray(e)){for(var t=0,i=Array(e.length);t<e.length;t++)i[t]=e[t];return i}return Array.from(e)}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _possibleConstructorReturn(e,t){if(!e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!t||"object"!=typeof t&&"function"!=typeof t?e:t}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function, not "+typeof t);e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,enumerable:!1,writable:!0,configurable:!0}}),t&&(Object.setPrototypeOf?Object.setPrototypeOf(e,t):e.__proto__=t)}function LRUMap(e,t){"number"!=typeof e&&(t=e,e=0),this.size=0,this.limit=e,this.oldest=this.newest=void 0,this._keymap=new Map,t&&(this.assign(t),e<1&&(this.limit=this.size))}function Entry(e,t){this.key=e,this.value=t,this[NEWER]=void 0,this[OLDER]=void 0}function EntryIterator(e){this.entry=e}function KeyIterator(e){this.entry=e}function ValueIterator(e){this.entry=e}var _get=function e(t,i,n){null===t&&(t=Function.prototype);var r=Object.getOwnPropertyDescriptor(t,i);if(void 0===r){var a=Object.getPrototypeOf(t);return null===a?void 0:e(a,i,n)}if("value"in r)return r.value;var o=r.get;if(void 0!==o)return o.call(n)},_createClass=function(){function e(e,t){for(var i=0;i<t.length;i++){var n=t[i];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}return function(t,i,n){return i&&e(t.prototype,i),n&&e(t,n),t}}(),_typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},version="2019-11-12-17-18",Glodon=window.Glodon||{};Glodon.Version=version;var CLOUD=window.CLOUD||{};!function(){function e(e,t){for(var i=t.split("."),n=e,r=i.length,a=0;a<r;a++)void 0===n[i[a]]&&(n[i[a]]={}),n=n[i[a]];return n}e(Glodon,"Web.Lang.Utility.Namespace").ensureNamespace=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Common"),t=function(e){"string"==typeof e&&(e=JSON.parse(res)),this.code=e.code,this.message=e.message};t.prototype={getErrorCode:function(){return this.code},getErrorMessage:function(){return this.message}},e.Error=t}(),function(){function e(e){function t(){}return t.prototype=e,new t}function t(t,i){var n=e(i.prototype);n.constructor=t,t.prototype=n}Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Type").inheritPrototype=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),t=function(e){var t,i={type:"get",cache:!0,headers:{"Content-type":"application/x-www-form-urlencoded"},data:null,async:!0,success:null,failure:null},n=Object.assign(i,e);t=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),t.onreadystatechange=function(){if(4==t.readyState){var e=t.status;e>=200&&e<300||0==e?n.success&&n.success(t.responseText,t.responseXML):n.failure&&n.failure(e)}},t.open(n.type,n.url,n.async);for(var r in n.headers)t.setRequestHeader(r,n.headers[r]);t.send(n.data)},i=function(e,t){var i={};if(i[e])t&&t();else{var n=document.createElement("script");n.type="text/javascript",n.src=e,document.head.appendChild(n),i[e]=!0,n.readyState?n.onreadystatechange=function(){"loaded"!=n.readyState&&"complete"!=n.readyState||(n.onreadystatechange=null,t&&t())}:n.onload=function(){t&&t()}}},n=function(e,i){return new Promise(function(n,r){t({url:e,method:"GET",success:function(e){try{var t=JSON.parse(e)}catch(t){return n(e)}"success"==t.code||"noCode"==i?n("noCode"==i?t:t.data):r("requestErrorï¼ŒdataCode:"+t.code+", dataMessage:"+t.message)},failure:function(e){r(e)}})})};e.ajax=t,e.promiseJSONRequest=n,e.getScript=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.FullScreen"),t=function(e){if(!e)return!1;e.requestFullscreen?e.requestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.webkitRequestFullScreen?e.webkitRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen()},i=function(){document.exitFullscreen?document.exitFullscreen():document.mozCancelFullScreen?document.mozCancelFullScreen():document.webkitCancelFullScreen?document.webkitCancelFullScreen():document.msExitFullscreen&&document.msExitFullscreen()},n=function(){return document.webkitIsFullScreen||!!document.mozFullScreenElement||!!document.msFullScreenElement||!1},r=function(e){var t=function(){e&&e()};document.onfullscreenchange=t,document.onwebkitfullscreenchange=t,document.documentElement.onwebkitfullscreenchange=t,document.onmozfullscreenchange=t,document.onmsfullscreenchange=t};e.fullScreen=t,e.exitFullScreen=i,e.onFullScreenChanged=r,e.isFullScreen=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.ClientHelper"),t=function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,n=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=(/(?:Chrome|CriOS)/.test(e),/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e));return!(/(?:iPhone)/.test(e)&&!a||n||i||a)},i=function(){return/(?:iPhone)/.test(navigator.userAgent)},n=function(e){var t=function(e){return e.replace("viewToken.json","").replace(/\.\//g,"/").replace(/\/\//g,"/")};if(e.indexOf("://")>-1){var i=e.split("://");e=i[0]+"://"+t(i[1])}else e="./"!=e.slice(0,2)?t(e):"."+t(e.slice(1));return e},r=function(e,t,i){i=i||"asc";var n=!1;t?t.indexOf(".")>-1&&(n=!0):t="name",e=e.sort(function(e,r){if(n){var o=a(e,t),s=a(r,t);return"asc"==i?o.localeCompare(s):s.localeCompare(o)}return"asc"==i?e[t].localeCompare(r[t]):r[t].localeCompare(e[t])});var r=[],o=[],s=[],l=[];return e.map(function(e,i){var c;c=n?a(e,t):e[t],/^[a-zA-Z]*$/.test(c.slice(0,1))?r.push(e):/^[\u4e00-\u9fa5]*$/.test(c.slice(0,1))?o.push(e):/^\d+(\.\d+)?$/.test(c.slice(0,1))?s.push(e):l.push(e)}),l.concat(s,r,o)},a=function(e,t){var i=t.split("."),n=e;return i.map(function(e,t){n=n[e]}),n},o=function(){return!!(window.ActiveXObject||"ActiveXObject"in window)},s=function(e,t,i,n,r,a){var o=void 0,s=void 0,l=void 0,c=void 0,u=0,h=Math.sqrt((i-e)*(i-e)+(n-t)*(n-t));if(0===h)return[0,{x:i,y:n}];var d=Math.sqrt((r-e)*(r-e)+(a-t)*(a-t));if(0===d)return[0,{x:r,y:a}];var f=Math.sqrt((i-r)*(i-r)+(n-a)*(n-a));if(0===f)return u=h,[u,{x:i,y:n}];if(h<d){if(n===a?o=i<r?0:Math.PI:(c=(r-i)/f,c-1>1e-5&&(c=1),o=Math.acos(c),n>a&&(o=2*Math.PI-o)),c=(e-i)/h,c-1>1e-5&&(c=1),s=Math.acos(c),n>t&&(s=2*Math.PI-s),l=s-o,l<0&&(l=-l),l>Math.PI&&(l=2*Math.PI-l),l>Math.PI/2)return[h,{x:i,y:n}];if(i===r)return[d*Math.sin(l),{x:i,y:t}];if(n===a)return[d*Math.sin(l),{x:e,y:n}];var p=0,m=0,g=(a-n)/r-i,v=-1/g,y=t-e*v;return p=(a-r*g-y)/(v-g),m=v*p+y,[h*Math.sin(l),{x:p,y:m}]}if(n===a?o=i<r?Math.PI:0:(c=(i-r)/f,c-1>1e-5&&(c=1),o=Math.acos(c),a>n&&(o=2*Math.PI-o)),c=(e-r)/d,c-1>1e-5&&(c=1),s=Math.acos(c),a>t&&(s=2*Math.PI-s),l=s-o,l<0&&(l=-l),l>Math.PI&&(l=2*Math.PI-l),l>Math.PI/2)return[d,{x:r,y:a}];if(i===r)return[d*Math.sin(l),{x:i,y:t}];if(n===a)return[d*Math.sin(l),{x:e,y:n}];var E=0,x=0,b=(a-n)/r-i,C=-1/b,M=t-e*C;return E=(a-r*b-M)/(C-b),x=C*E+M,[d*Math.sin(l),{x:E,y:x}]};e.getIsDesktop=t,e.getIsIphone=i,e.getIsIE=o,e.formatURL=n,e.sortByName=r,e.PointToLineDistance=s}();var Cursor={pan:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABjRJREFUWAnFlstvU1cQxu/1fcR2HMd52DV5kVABUZ4tkIqIx6KRKBKbCqJukKjURbtghSr4S1gg0U2zQqjbthISYkElVCoEIZAQkiYpCXm/4zh+u7+xcoxDbCe0UjvS6B7fO2fmOzPfzLGm/c+i/4v4uXvT/9RPrpNiPpSdY9tIfovKbwmeylGW+xfluNgOsTFQEy1B1R55JyoSQyNoElWA5LlnZpQzbHeJ+iZBJHAZWurz+by2bSfD4XDK7/d/YllWgPWTqampYb7HUQEhgERVZljmFzlVPlHB5buNusvKysrr6uouezyer3UklUrFq6qq3IZhOBYXF58C5Ifl5eUxPqVXV1cX2bOGhtGimVApxG6HCAAJ7kQ9LpfLGQgEWg8ePHj+2rVrrZcuXXItLCykL1686Llx44YvFovVjo2NnaysrLxcXV39LeqLx+PDW1tbm+xXZWG5W4plwMLcS+DGAwcOfEPaewmUxrHW1dXlGR4ettfX1/XS0lK9ubk51tTU5Ozt7fU2NjYat2/f/hzbUTLShw9Virx8yJcBOb2w24WWE7znzJkzX1y/fj1ACSycagQ00un01uvXr9fcbrfe2trqXllZMQFjnjt3zkVJyvr7+xcTicQQ/FjFT8EsqLbCZpcIEAlkojplSJ89e1bDafjx48fh48ePl0HIyhcvXlhwwWhoaNCmp6ejb9++TbS3tyf53klJTuJDyigHVbxi+U4KZUAspDyukpISN+lsOnz48McAcFFrg/o72traTE4XHhkZCQHEcejQIWtoaChO3TXs3PPz85XPnj2bZ+8A79bxJR2xqwz5AGCXQSuI7Wg0Gie19cFgsAUQFt2QJNAGWUmfOHFCuGDCBcfp06ftN2/epMmCduTIEclchNbUKNkc+ie+pEUFxA4pBEAZGbSbTRYkSFVtbW2NnG50dNSizuaxY8eMpaWlyPj4+BYzwQSk/vLlyzCg06dOnfKQhcDAwMBcJBJ5yjtpyV1ZKARA1SuTBRxE6ILG+vr6jpaWFpPej7569WrdNE2ts7PTRUa0jY0NHXBO6Yry8nIDW3NtbS08MTERB/wMJJ0AgOoIdcDsKM2+YKGCqyHkJAslkNCi5BU1NTV+0u2h9hanN7q7u03mgwMSGl6v10EWLDTT3pDTJlPBwcHBWUA8gcBR/EtHZCVfBgSAOHCj3m21IdMqJ68j0KcdHR0G7ZkisF5RUZEJLMGx3SFOp1OHsFF4EmZ+TJOFKQwSaJYL7wOQ4OJIWqeCIdQCu78jnd9zmnaItQSjY2Shivq7JTijF9PCQocIT4JkbGZubu4JlpKFogAEVClaSeDenp6er65evVrNpPsIVjfMzs7WcPpysqAz/zErLtwdDpkNz58/n8dyFF7IU7KQacl8GZB3mSlIBj5jCnZduHChRGbA0aNHTUhlAiRGKRIAlItqT4GgMVo0DJARWnKUDdKSBQEoDrioYenMzEyAU/hhv0XNbSacRurj2223dwqIFAqFUnTKJu3bDykHtwFkypBhKy9yRT5Iu2xMTk7+To2dt27dsql925UrV5yc3BbN3bDXWuYCJIzBoezJ1Z73S6DeS3oESJqaLfCcg0R+xoFfLiJasjjzlJftJyM58uDBgyFK95D/CuO8FiLmLYHaqgBkyEINl0E/wz1QRTqDcEEXcinjYk9mh3b//n0H+hst+QuZXMa+IAlzfeWCSBF4NZlMUpVJH/1cS3sKFwplMOvn3r17oTt37gzRgr+SgT/4ICM5O4z2ciAgxFgQy//AENNsnAvHA5BaukBXU4/vO4SMaY8ePQr39fVtMrZ/JvhdhtkKRjsupb0AiFMFQoAkSWF4c3NzhFrq1LYGcunyR0X+mIixCExPS+CbN2+uwZ2fCP4jo3iaT1uoHCYr2U3ZN/kXYic1F/bLv2MfF5Hcjt1Mui8J3ow6uIgSZMkiWArm9/O8S+8/5ORC5BC66zLaLwD2vvuPwFoGlQCRu8LNPVANKYNMRjcl2qBz/oIzKqj8GZG6Z8rIc4d8CADZKPaiUjoZQnJniMpazRQplbSZUjm1vMvOf9ZZ+VAAslHtkaeURcCIym9RFUw9hUOieUU5y/txHy9z9+euiwbdh9//zuRvyW3yFM73IK0AAAAASUVORK5CYII=",orbit:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAB55JREFUWAntlltM1PkVx2eG28ww3EdA5CKgSBXEKO6Klxq3dsFbDTZa120Tre1ufdjY1sRoNqm1aaPxYetjEy/RxLrbpGiiVWQbUPfBW8CqRHe1UapVizCIIMMwwMz0852d34RycdOnvvSXnPld/7/zPed8z/mNxfI/btb/Qr/OjhbzeYjBaDF7b+y/CcBIhTHcNFJszM33QcYBZDjSazwSENPxm7lgvF3tSYmUxiHxiB1JiIxj6bUvRVI8iAwg/ogM0QuIwOnMuG0iALpYIiVSmoi4CgsLv52YmPhOfHx8ZUxMTGYoFEq0Wq2DwWCw3e/33+7v7//86dOnFwcHB19zvh8RIAERCMmYNh4AY7msdiIpRUVFNampqb9IS0vLqKmpCVRXV2fk5ubakpOTLT6fz/LkyZPQ+fPnXzU0NIRe0l69evXJo0ePPufbXsSLyDvjgpgIgNzuSElJmVRQUPA7FK3Ys2dP/Jw5cxzHjh3zXL58OeTxeBKHh4cT4uLifADzLV++3Lpp0yZ3S0uLd//+/UPd3d0NDx48+A3e8HBXXwSE4QbTr9tIABobkeuds2fP3mO323926tSphMOHD3vOnTvnwOK/9vX1Xezt7f2KcY/D4UgDYInL5VrG+LsrVqzwbd++3b1t27ZOADy4d+/eB4Do5D4DYkJOmJiLZC4kIyEhoRgQdZWVlYP0lzIyMr7D+gwkH8lBsiO95jPS09Ory8vLL61atcrT2dkZ2rBhQ0dZWdln7BUjaYiILD1jmhZNzNPz8vLKmE9GpiBTp02b9j59ISKlbkSXpY4QzbWeh5TNnDnzjwLR1dUVWrJkSTcc2sa67hKZFd5o00RuFwChc+Xk5JRkZ2efY9yIq3voffDqPr1YLTIppQTWpKTCpaZUFOOHsb6F0FX29PS4Nm7caL969WoZYOoCgYBSVOcUhnATAGO90KWB9iCuLiC9Sl+8eNHAmlJJIgLpvAtXT83Pz38PoGsYl5KOHvjgYy8MgN4CQb9C6fs7duxIrK+vt6C8DWI+ipzRXWpWXSiRNSnFxcXrsrKyNpw5cybl9OnTqeT6Cz76O3u6WEBd7H+rpKTkL4sXL160evXq+awtGBoa+pBaUO/1epV2utwKniDZUUiWuDHKdvfu3Tg88wV78qIBwPBr5Zkw+S3I5rly5coAFoXUa87625yZguRgbdW8efNCR48e1ZFo03zhwoW9KFzEuVxEpKzAS7tXrlzZifLg3Llz/8Ga7hKXxBkZHaP4hasd+f5zFAaqqqqUBRb18+fP76HCbW9tbf01S8FJkyatgtX+LVu2hM/onBpzy82bN2OoDSvx2LHS0tIavDcbhFnwxwkQq81my2H9o9jY2D7WWwD1KZ8G5FYbLiqnvP4gKSnJtm/fvm5deuDAgW5y26Z1wJWzFMelOQsWLBABx7RZs2bZuVyZE4v7n0PCH5MJVbW1tX7usaxbt65vzZo11aT2T7XPOekO/wQpIJOx9NDZs2cbKDou2G+BAwkUnqsDAwNHtc9ZeDX8L5CLyWPatWvXhrTPxtDjx49bKT5/ev36dXDnzp1yt2X37t1pmmudMt3KkjIh/EgpFjqk2LxNrNoUM9B3KoasVSCKaa5irFiPxwFxQxzhnGrFFHFnAk69xX4mIr02ZYCaQWPjknJevCwywgIQC8xtYl+vmx9vePFU0/37938ESf3t7e2248ePD+CpAaxeDQceck6PzxDnAnjuZXNzc9X69evtW7du7SOt9/HNjch9yoagipApREKUCh++h/z2xIkTacSs/+HDh9+HSF9GPqKzOAGZJ0IS82zy+3lHR0c9Z/7JnpTrYt0ZrisVFRV/4Ow8Fafbt29/wPpLRO+CUjtoPMA43GzkcidkrIWxdizwPXv2bAYKGtlVBZMMQqIeisxN5TVWNzPXi6diJU/qTmWWSBaC/X+jFtRi/YdwQBxRRZXycPxHA7BikU2uu3PnzrKDBw+mNzU1JXHBZFkQ+UhKVEh0iaw1l0mpA0ni7XgHj7QzDkDoLjz1ZwxpY26Um5D/x8Mgt6lZyeXnkKjgxo0b2YcOHXLz/ueotqu8Yq2UyjqBl+gNkeJkSvi06dOnfwKHPnK73VP5Y3IRg7w83V3sy0PmHRCAcBvtAS3KNSE+bsZ9i65fv+44cuSIWw8Lbv8h8S9yOp129mRxAkDzKc9L+If0k8zMzI/Xrl2bRg1JqqurK+JfVAyuv8Q5pa6Uh++mjzZjtVnQ3Fjlogi5qfu/Iv2qd+3aFUeqOU+ePNnV2Niov14O3gAH7vVjrXfp0qXWzZs3u2/duuXbu3fvIFbXkxkfA1x/RnyIwhaOO320jQagjXB1pJdrxeRksuJdrPkl1qfzf9BKfU9VeYUrFhRZ+CMa5P9g14ULF2IIXxfe+z3F5gLf6jkfE3fWom08ANo0IMy778QbSbh5Ge5/l3JaQQiyqenxPNte4txBhWsmg5ra2tq+4HulmVJy3LizHm0TAdAB7RmyCYgeIInqhbwjDuiMCBVOT3rFWkpNdsjtUcYzHtPeBECHtW/EsF6KNRY4NcVVSqRspBjCjYk756LtmwBEDzIwQEb2Zn+kMjM2e//v3+iBfwN/OI2ZyYaa1QAAAABJRU5ErkJggg==",measure:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAB0AAAAbCAYAAAH3zbSEAAAAAXNSR0IArs4c6QAAAn5JREFUSA29lr9uGkEQxu8A47MTKSf5j2RbjnDhAAUVVKbhBeiiNHmLPIxbt64i+QF4A3iBpEiUIkWUCEVBcSz/uXy/1S1aH3fxcoKM9LG7szv77c7MzhEEQRAKFWEutXkvCKoMqkmS3Foly+vCa6ugjdwBm907imoo+8QqwjCMavp5axVqzWTUarWuNKg6E/MurJvCS2F+lHR2Q+0XFkSiuU6VjxrRbaHg3OyyIJVut3sj7cHCjBTWOZ+zkzJKrLMa2UnGISvyJtAZy/F4vDDf6/VMUAaaOVyYDYKv6OpsPZ1Ok06nc6Hxs5yFharNfr9/qdmGkOvuIksTBjH/KVpQpJ9MJhF+fCha8ITe2EXcOU/+pdfGhrmQIC8E7mLuDEgzmwrufFGfI99iiIcJNv27FGqeliPuOhwOyekTwZu9KSPSeSAslRg8r7NljbhXLNBOBR/ZZhFOiRW7Tz4Wdo0y6QSmhrArfBd8xKzFcE+M33ws7Box7mN4qmh8sEqfVmXnFTHzjpuzaaWMkbEvbUg4ZjrzG7Uku49Qi2c4x01yH0PK4p013FJIfmWt4jg+H41G76SHpWzlyG5rxnwETqkaVFAeS7vdfi8duX8k8D0r7UfZ5gqbGtKUbKBxQ+CFLlWFtd5LcC+BfCHwQCkJPFDqifuB1rC0wAHwFiFK6KCoyb0fUQgIB8EDqwAeO9D+5MWesEHqQmyLXUv9mUC5XZXA8TzdjPYnt+QfxU6K3yiFVZMSPurljxSG9JjsdWUdYxEeC3VcC0zVVrtugQc+kyzN7M3cW6+iz/7iasJnWGH+n0JmcQJT4vj3t2Yx75Tsperwx9hm2DpuD5l9Gdd/AVIlXMI9fgkPAAAAAElFTkSuQmCC",section:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABBpJREFUWAntVUtLG1EUniRjEo2amKjVxBiFqlAXRUVFEBFKF6KLgii47kIKXVX36rra0lXRnd1IFftYqFAoBFyJ2AdUixqoMU18a3ylSZwk/b6pCRmfP6AZuJlz7znfd8797rkTQUg9KQVSCqQUSClwgwKxWEzV0NBgrq6u/tbf36/m/IZw2cUYxhJD7G0Y9XWEJGlsbKw5Ozv7qlKp7h8eHuoGBgZuLYAxjCWGWHKQ67o8VxISMDMz8yASiUyUlZUZV1ZWhNra2jvRaPTAarVGpqamHsF+AVLHObFbrVY/a21t/eDz+TSwc+bn57fKy8uF1dXVQ41G09HS0vIZvNGLhVyqjMmR4LEkSZ/a2tqMw8PDMgZzQzgc1kxPT7cj+WRzc7ODPg7aXKOPMYwliD5ykIucVymhKKCjo4MJXoFspKurS+jr6xOysrLkAtLS0rSwtfANIaEwODgo1NTUyIM21+hjDGMJIpYc5CInuZlDJjz/kQtgo9TV1VnW1tZGIftTVCr09PQkxwk4U7Xb7S5ErJ2EFx+u0RcKhQyMTfaTi5zkZg7mijenHNjZ2aluamoK4ux0ycBkGzvQYGeyHNzZdQ+SZzL2Oj9zMBdzMkb+qaysVB0dHaVXVVU9B/l7Vjs0NKTg4K4sFksIBDsjIyMKHydjY2MCfUjOY1I0N7nISW7mYC7mJE4hFSSKVVRUvMvPz39LQlwp4fj4mHGJJzc3943T6RR6e3uFhYUFgTeENtfgG00EwiCWHOQiJ7mZIzlGPJ/wegS0Wu02Agx2u33GYDD40LlPlpeX9YzBmUUxwkVFRU7s1DQ7O9uOpCb6cM38BQUFkzabzQmlwhjyUXZ3dwsulytYWlr62mw2f8f6b+bA9yEAmHwlE1KxOx0Ohx7yWJDADhkdfr+/en19vQsAa319/T1cJz9IbPDdxTsfI50FoLA/GNvAufD2iqJompubW0LP+IqLi8dMJtMX+NzAebKzs/fQzMGJiYkIsYlmWVpaimEHUcgYCgQCQZBIOp3uBIAf+/v7FbA/Go3GDRTBZpWADeN9iiL8SLoF28PkiDvd3d214mv4EB+ilzj3n/D9wvdhHfaex+MJxZOzgIQCnPBBs6hxVbR6vT4bUxtIefUkyOzC2sbBwUEMdgZGJpLLUsMfwtGdYARycnJUwWCwEDZVEjE2wOPF2lFJSUkY/Iqv4aUC4kXgLe7s7GShcgtsqJm2h/k+uldaXFwkToNzl/Gbm5tsrAh8MfjEvLw8M46NuDOc+R7m7GTpYnKsXVaAi3ywKxWaCCch6kAi4ljC2L1Cvn+Ryl/2ElTQZWRkaFE8TkwK4ZMsQQlF98dRimsYX+SbAAJxfQJer/cYf0LB8fFxhXzJ8XGbMYwlhtibkscxqXdKgf9bgb8e4D98kWiZrgAAAABJRU5ErkJggg==",rotate:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABUhJREFUWAntVmssZGcY/s6YGYPBYC3WfRsqS2tTiawUcUuUSFRdE3GtS2ormuxqJEK1iR9t0jaSjVtRIUII5U9VdhsjVSl1DSK2a+LaDcZl3OZiZk6fz8ZkzVKxPzZp6kuO855z3u99nu95L4OQ63WtwLUC/3cFmNcRIDMz03Rra0skEAiER0dHips3b8rq6up2GIZhrxrvUgIsy3KioqLeR/APARimUChcNRoNTIHa0NBQe3x8zCiVSgO1Ws2YmJisarXaYfh0ubq6/lJZWXlwGaELCZSVlXFHR0fvczicInNzc7PAwECBj48Px9nZmQCYQAGyvb1NhEIhsbKyInw+n6yurpLZ2Vl2YGBAvrCwwPB4vEYjI6MvW1tb1y8ici6B6OjoOzhxN8CcsrKyDHEqIhaLWRBiKKiBgQExNjYmUIHFycnh4SEjl8uJqakp8fT0ZAMCAhh3d3fS1dWlefLkiRyHyOru7m4/L0WvEEhMTPRCXoeys7OFLi4uTEVFBQVg7ezsjmxsbGQikUiFQMc4kQx3KrEAlzlSZQQ/7vr6unBzc9Nsd3eXk5aWRtzc3EhxcTHdc7+zs7Nen8QZAjU1NbzHjx9PJycnvw1H0tzcTLy8vKT29vbzAOjFyf/AXQK5VVBFg2ct8s/A5oAED8+2qA8f7P1AJpO9NzMzc8vJyYmTnp5OCgoKlI6Ojneqqqok8NUtrs6CMT4+7ge53vL29iYPHz5kkfdZSP0Nl8sVA3gXEivj4+OP9U9xGqO/v//vlZWVWZDqsrCw8PLz8/tseHg4fGxsjBcSEsIfGhr6tL29vTAhIUFzukdHAJu5TU1N9yA7B8yJtbX1HgroE+R5IiUl5egi0NNA9B4cHKzGjV6HANpBGlZsbW2tRkZG7gUFBTGTk5OB6BCaskNcJ4tKd7JQRAaQ6HBpaYnx8PAgGxsbgsXFRem/gUNaUWRk5HdQ50wqaUCcUgXya8vLy3ykkSAuLVo1UsR7gfjir44ATqtB1Y/jpGq0EImJieHPzc39FhsbG3QeAN67geQo/JMaGhqELweldlJS0q2enh6aCu/Q0FCmr6+PxWwQY1ZQhXRLR4DKh7V49+7dP6urqwmKh3nw4MEN5P9ngI2iNSMpEXrBDkOeJ8LDw28joAj9bkQj5ufnm2FoJcfFxfXu7+8v4HtYYWEht6ioiHbDhqWl5U9IrUKHDuOMdMgbH3kLRK8/Qs+7gwyDjiD19fWap0+ftkdERGSinz/Gvm9LSkoM6QDKy8tjUagSTEQrlUolxCnVyLcAs4BgIJG2tjaCmSAFga9B/ofc3FzZhQToB7SiMWQNQLAvnj179g7qQAibBZnK+fn55wcHB1+hlTgAIrDJ1NQULViCaUnoUKLpGxwcJKh+ggJUA3gJs+MRWrQlIyNDql/MZxSgBKjEvb29/LW1tduwY1E0CSBhgUD5GFDWExMT30N2k/LycoJnUlpaSjB4TsjQsQyZtbgOHBwctqGMGG39I2JM5eTk7OmDU7xXCNCXdAGc09LSQn/tbPHoiUADeGcOu2x6evojgAoxLQl+cFhfX99NFDH9cdqBz1/w6Yf/7xhQS7BlkJ1OznPXhQROvSmRxsZGPlpO2dHRwdnZ2bFH8ByJRJID+a0BrESxxaFYJZBZhj5X4p0cLad4eeCcxtO/X0pAfwMlhBF9A3MjRiqVfg41RCjOd1NTU59DYq2+/2XPukl4mePpdwoCEpu1tbVt+Edkxd/fPxwdIH8dcBrzygToJlpMWHso1l9RrGNmZmZnWov6vLEFIldO4xsjdw30n1DgH4y0hp8mM/gUAAAAAElFTkSuQmCC",translate:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAABLxJREFUWAntVllIZEcUvd1jOxrbNW7jihoRxQWhjaKixiUS42DEBZn8iCGifghxIWAQhsjgR0JIPiL4pRkTFDU/CsK4oOJCUHFBUVEEcUSNg6Ktjt3a7cupgtdp5fXrkTDkx4LuV6+We86799xbRfTQHjzwP3tAcR/8oqIij/Pz8xfY461Wq+svLy81RqPxCfq/9fT0vLmPLXGtUuxYe1ZVValPT0836urqvi4sLHx6cnKyEBQU9HtmZuYPZ2dnf7W1tdlZsyE1b9UDgiAo8vPz47C5VK/XV/b19XE7JSUl1NjYSDExMVRTU0MHBwcVIPgYk64RERE/ol1IAd4ds+qB4uLiGGyazMvLq3RwcKCZmRmysbGhtLQ0WllZ4faysrLo6Ojo19jY2F/S09Ofr66u9nR3dz+6Cyb1LktgdHTUxtbW9llSUpKqtLSUysrKaGhoyAQq9lNSUugRWkVFBdXW1pK/v/9nS0tLPlKAd8dkCWxsbNgGBgbqxC9lQAsLCwQhUlhYGCkUClpbWyPmmcTERAKoidzOzk4hwidrny22tuA6ODh4XKvVGkQgjUZD4+PjHAgCpOHhYROo2EcYCCL9tqOjw55PyvzJEigvLzeoVKp1X1/f16Jxc1DWZ2QMBgMxYru7u7S/v0+urq4UGRnptbi4+JEMNp+SJQAXCzCuBYHesbExDhQXF2cC8vLyooCAAC5MSIALc2RkhBtm5EColOlIjoQsAbYRIbh0c3P7E57QswxgQKmpqSQCsQyYnp7mGNnZ2TQ/P8/7TBPX19eV0JEDH7DwJ5kqLPchqE8hwJdTU1NPUe0mXVxcPt7b23vCwJ2dnQmVj3JzcykkJITXAmQLgShlZGSQUqnkqQoh2kA7r+bm5rYt4EsPI4ft8TVabBT6+/uFnJycNw0NDT8D8AZVD/wE4fj4mD/l/iYmJoSCgoKXra2tKmkkC1mAiucCl9v7+fnxr0TFc0cqfoWvNIgZwIRmrYWHh5NOp/scaWoxGyQ1AOEJUPVmfX09F1xCQgI1NTWpMa4Ss8EaOJt3cnKim5sbR/wsnhOSBLD3xMfH5zkq2t+szq+vr1N0dDShvrOaTzgF3wWfLi4uuBawXlJrzIgkAZRdPWL7Cqfdd1FRUbuIP0+10NBQ6uzsJHt7ix69RWxra4twVL9F6IRbE2YvkgRY/qMIaeG6Xm9v79r4+PjN5uZmQaz9Zvtlu4ODg+Tp6bmJrLi2tFCSAFsskkD6Dbi7u1cnJycvtbS0CF1dXZZs3RpHBtHs7KwRafoHbOluTZq9vNN9ADlvh7Neg1i+mJycxOGYpGQnH8t9qXZ4eMhPRWTBLLT0JUK6BRI3UmstekBczDyBO8ElyvEMYv8N7gEDy8vLV9XV1bwCokiJS+nq6ooGBgaIzaFE73t4eHyPydeWwNlGqx4wWUeHFRRcRoKRjlU4dJ5BZG4oTEoA8WXsIIJQdXD7NrzzE4TczbTEPsLcjnn/XgTYRnbTQXH5EMXqEwB8AaEmIDQfgJjRzs7uAEt6AdiHGrCNS+yFHDizd28CbBOAFe3t7Y/hcjUU7oifE7yiBwktps8cHR3fImz/xoZtel+NkWFewdOqnt4Xhwe7/8kD/wDeTzMCbKkf6QAAAABJRU5ErkJggg==",zoom:"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABGdBTUEAALGPC/xhBQAAA6pJREFUWAntVltIk2EY/rZ/bO7gNCx1aswrYzSGkKAYIUE3mg6TlPBwIcEoJnRVkCFOJAblTeAo5lUIEi5spLCbBCUSBIOh1KAbldIxSZdzOZ079L6jf/yb23/q0n7Yvu89Ps/3fkdC/n9nvQLUvxSgp6enqqKiwt3Q0DC/trYWEpNLKiYIY/r7+y/s7e3NG43G69iiLCaXKAI2m00TCAQ8bW1tNWNjYwRblFEvhoSgGACRt7S0zNvt9iTzQxn1aBeUUIgzAEpbW1tdg4ODyVgsxsRPyahHO/rxzSvh64hJodSOo6Oje3TMxMQEqa6uJuvr68RisdBqUlBQ8Gp2dtYqkUgSaWWejiyP/pTa5XKpzGbzVzB4gUzZzMyMrry8POWn0+kIRVGko6PDD6ABUH5Ff2jDKQeWP96l6uzsPFSpVK8B6ObW1tZdrVaLI02lxhZl1KMd/dCfBTdt4k0Ay9nb2xsqLCwM+P3+Mhw180MZ9WhHPz7lx3jeBBhgVDweN+YigHrwE3S4CSYQDAZlJycnNbkIoB7tDLKcXcEE1Go1EtDnIaBHOycqw0EwAZhbKhqNlsEdwEhDCBJCPdozDByCYALHx8cy+BVnVwAJoR7tHJgZZsEEYKtpEomEoqSkJCMRyqhHe4aBQxBEAA4gCWy1S9mjpzFQj3b0o3VcrSACCwsLFJTYxEYA7ejHBUzbWZniSOByeQBJn0NAem7b29uJ1Wqlc6Rbh8NB3G53WoZOTKFQPJybm3sBizPJNNB9VgLT09PK/f19M8zrk5WVlctw4eCFRMfmbeEiIk6nM1FXV/elsrLyaVFR0fuurq5IrgBWAliBqamp4nA4fOPg4MC2tLRkaGpqkgwMDBCp9PTswSIk4+PjZHFxMdnY2OiDY9mm0Wg+dHd3/xJVAWSMJCYnJ1Wwx6/AVWxbXl6+VlpaKhseHiYAkB4UECQjIyNkZ2cnVl9f/xEuKJtcLv/c19d3mA8cg1krkM4OHZgOeSgUqoHz/tHq6upt6CtHR0eJXq8nm5ubZGhoCG/EiMlkegs34jPof4OyR5k5cvV5E8BgIEEBcBWQsGxsbNz3+Xzn4A1A4G1ADAZDEB4nLwHcCeA/ADyeCzBbJ4gABsOUSGFKzkcikVu7u7uPvV7vxdra2u9wENmVSuU7KPlPKDnnS4gmIpjAXxISWOVaWIhXgdAdAHwDC/AT7BJ8B+TcbjRgdiuKAE3C4/HIt7e31XAP/G5ubo4KBc8mczblP8eTrmVjlSb0AAAAAElFTkSuQmCC"};if(function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.MouseMotion"),t=function(e){function t(){i&&"walk"==e.getViewer().getEditorManager().editor.name||(n.addClass("motion-zoom"),r=Date.now(),setTimeout(function(){Date.now()-r>180&&n.removeClass("motion-zoom")},200))}var i=!1,n=e.getDomElement(),r=void 0,a=!1,o=!1,s=null;Glodon.Bimface.Viewer.Viewer3D&&e instanceof Glodon.Bimface.Viewer.Viewer3D&&(i=!0),n.addEventListener("keydown",function(e){17==event.keyCode&&(a=!0)}),n.addEventListener("keyup",function(e){17==event.keyCode&&(a=!1)}),n.addEventListener("mousedown",function(t){e._opt.enableZoomRect||a||(s={x:t.clientX,y:t.clientY})}),n.addEventListener("mousemove",function(t){if(s&&!o&&!(Math.abs(s.x-t.clientX)<2&&Math.abs(s.y-t.clientY)<2)){if(i){var r=e.getUseLeftHandedInput();"walk"==e.getViewer().getEditorManager().editor.name?1==t.buttons&&n.addClass("motion-rotate"):1==t.buttons?n.addClass(r?"motion-rotate":"motion-translate"):n.addClass(r?"motion-translate":"motion-rotate")}else 1==t.buttons&&n.addClass("motion-translate");o=!0}}),n.addEventListener("mousewheel",t,!1),n.addEventListener("DOMMouseScroll",t,!1),n.addEventListener("mouseup",function(e){s=!1,o=!1,n.removeClass("motion-translate"),n.removeClass("motion-rotate")})};e.setCursor=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(e,t){var i=document.createElement(e);return i.setAttribute("class",t),i};e.create=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(e,t){var i=document.createElementNS("http://www.w3.org/2000/svg",e);return i.setAttribute("class",t),i};e.createNS=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(e){return e.indexof("#")?document.getElementById(e.replace("#","")):e.indexof(".")?document.getElementsByClassName(e.replace(".","")):document.getElementsByTagName(e)};e.select=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=Glodon.Web.Lang.Utility.ClientHelper.getIsDesktop(),i=function(e){var i={element:null,handle:null,axis:"all",cursor:"move",distance:0,start:null,move:null,stop:null},n=Object.assign(i,e),r=n.element;if(!r)return!1;var a=n.handle||r,o=void 0,s=!1,l=function(e){return Math.pow(e.x,2)+Math.pow(e.y,2)>Math.pow(n.distance,2)&&(n.start&&n.start(o),!0)},c=function(e){var t=navigator.userAgent;return t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1&&!isOpera?1==e:0==e},u=function(e){var t=r.offsetLeft,i=r.offsetTop,a=t+e.x<0?0:t+e.x,o=i+e.y<0?0:i+e.y;switch(n.axis){case"x":r.style.left=a+"px";break;case"y":r.style.top=o+"px";break;case"all":default:r.style.left=a+"px",r.style.top=o+"px"}},h=function(e){var i=e;if(t){if(!c(i.button))return;o={x:i.clientX,y:i.clientY},document.addEventListener("mousemove",d)}else o={x:i.touches[0].clientX,y:i.touches[0].clientY},a.addEventListener("touchmove",d);n.start&&n.start(o)},d=function(e){var i=e;if(t)var r={x:i.clientX,y:i.clientY};else var r={x:i.touches[0].clientX,y:i.touches[0].clientY};var a={x:r.x-o.x,y:r.y-o.y};s?(n.move&&n.move(o,r,a),o=r,u(a)):s=l(a)},f=function(){s&&n.end&&n.end(o),s=!1,document.removeEventListener("mousemove",d),a.removeEventListener("touchmove",d)};t?(a.style.cursor=n.cursor,a.style.userSelect="none",a.addEventListener("mousedown",h),document.addEventListener("mouseup",f)):(a.addEventListener("touchend",f),a.addEventListener("touchstart",h))};e.drag=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(t){var i={element:null,axis:"all",minWidth:100,minHeight:100,distance:0,start:null,sizable:null,stop:null},n=Object.assign(i,t),r=n.element;if(!r)return!1;var a,o,s=void 0,l=!1,c=e.create("div","bf-resize"),u=function(e){return Math.pow(e.x,2)+Math.pow(e.y,2)>Math.pow(n.distance,2)&&(n.start&&n.start(s),!0)},h=function(e){var t=navigator.userAgent;return t.indexOf("compatible")>-1&&t.indexOf("MSIE")>-1&&!isOpera?1==e:0==e},d=function(e){var t=r.offsetLeft,i=r.offsetTop,s=a+e.x<n.minWidth?n.minWidth:a+e.x,l=o+e.y<n.minHeight?n.minHeight:o+e.y;switch(n.resize&&n.resize(s,l),r.style.left=t+"px",r.style.top=i+"px",n.axis){case"x":r.style.width=s+"px";break;case"y":r.style.height=l+"px";break;case"all":default:r.style.width=s+"px",r.style.height=l+"px"}},f=function(e){a=r.clientWidth,o=r.clientHeight;var t=e;h(t.button)&&(s={x:t.clientX,y:t.clientY},document.addEventListener("mousemove",p),document.addEventListener("touchmove",p))},p=function(e){var t=e,i={x:t.clientX,y:t.clientY},r={x:i.x-s.x,y:i.y-s.y};l?(n.sizable&&n.sizable(s,i,r),d(r)):l=u(r)},m=function(){l&&n.end&&n.end(s),l=!1,document.removeEventListener("mousemove",p),document.removeEventListener("touchmove",p)};r.addClass("bf-sizable"),r.appendChild(c),c.addEventListener("mousedown",f),c.addEventListener("touchstart",f),document.addEventListener("mouseup",m),document.addEventListener("touchend",m)};e.sizable=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(t){var i=this,n={element:null,min:0,max:100,cur:50,step:1,isShowProgress:!0,input:null,change:null,currentColor:"#11dab7",defaultColor:"#999"},r=Object.assign(n,t);this._opt=r;var a=e.create("div","bf-range"),o=e.create("input","bf-input-range");i.input=o,o.setAttribute("type","range"),o.setAttribute("step",r.step),o.setAttribute("min",r.min),o.setAttribute("max",r.max),o.setAttribute("value",r.cur);var s=e.create("span","bf-range-min");s.innerText=r.min;var l=e.create("span","bf-range-cur");i.cur=l,l.innerText=r.cur;var c=e.create("span","bf-range-max");c.innerText=r.max;var u=e.create("span","bf-range-progress");a.appendChild(o),r.isShowProgress&&(a.appendChild(s),a.appendChild(l),a.appendChild(c)),a.appendChild(u),r.element.appendChild(a),i.setProgress(r.cur),o.addEventListener("input",function(){i.setProgress(this.value),r.input&&r.input(this.value)}),o.addEventListener("change",function(){i.setProgress(this.value),r.change&&r.change(this.value)})};t.prototype.setProgress=function(e){var t=this._opt,i=t.max-t.min,n=this.input,r=this.cur,a=(e-t.min)/i*100;n.value=e,n.style.background="linear-gradient(to right,"+t.currentColor+" 0%,"+t.currentColor+"  "+a+"%,"+t.defaultColor+" "+a+"%, "+t.defaultColor+" 100%)",r.innerText=e},t.prototype.reset=function(){this.setProgress(this._opt.cur)},e.range=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=function(e){var t={element:null,min:0,max:100,from:null,to:null,step:1,currentColor:"#11dab7",defaultColor:"#999",change:null};this._opt=Object.assign(t,e),this._opt.from=this._opt.from||this._opt.min,this._opt.to=this._opt.to||this._opt.max,this.init()};t.prototype={init:function(){var t=e.create("div","bf-multiple-range"),i=e.create("div","bf-range-track"),n=e.create("span","bf-slider bf-slider-min");n.id="minSlider",n.type="minimum";var r=e.create("span","bf-slider bf-slider-max");r.id="maxSlider",r.type="maximum",this._state={from:this._opt.from,to:this._opt.to},i.style.backgroundColor=this._opt.currentColor,t.style.backgroundColor=this._opt.defaultColor,t.appendChild(i),t.appendChild(n),t.appendChild(r),this._opt.element.appendChild(t),this._track=i,this._sliders={min:n,max:r},this._element=t,this.bindEvent(),this.update(!1)},bindEvent:function(){var e,t,i=this,n=!1,r=function(i){var i=i||event;t=i.screenX,e=this,n=!0},a=function(r){if(n){var r=r||event,a=r.screenX-t,o=Math.round(a/i._pix/i._opt.step)*i._opt.step;0!=o&&(t=o*i._pix+t,"minimum"==e.type?i._state.from+=o:i._state.to+=o,i.recalculate(e),i.update(!0))}},o=function(){e=null,n=!1};this._sliders.min.addEventListener("mousedown",r),this._sliders.max.addEventListener("mousedown",r),document.addEventListener("mousemove",a),document.addEventListener("mouseup",o)},update:function(e){var t=this._sliders.min.offsetWidth,i=this._sliders.max.offsetWidth;if(!this._pix){var n=this._element.offsetWidth,r=this._opt.max-this._opt.min,a=(n-t-i)/r;this._pix=a}var o=(this._state.from-this._opt.min)*this._pix,s=(this._state.to-this._opt.min)*this._pix+t+i;this._track.style.left=o+t/2+"px",this._track.style.width=s-o-t/2-i/2+"px",this._sliders.min.style.left=o+"px",this._sliders.max.style.left=s+"px",this._opt.change&&e&&this._opt.change(this._state)},recalculate:function(e){this._state.to>=this._opt.max&&(this._state.to=this._opt.max),this._state.from<=this._opt.min&&(this._state.from=this._opt.min),e&&("maximum"==e.type&&this._state.to<=this._state.from&&(this._state.to=this._state.from),"minimum"==e.type&&this._state.from>=this._state.to&&(this._state.from=this._state.to))},getProgress:function(){return this._state},setProgress:function(e){this._state=e,this.recalculate(),this.update(!1)}},e.multipleRange=t}(),function(){var e=function(e){var t,i;this.addEventListener("touchstart",function(e){t=Date.now()}),this.addEventListener("touchend",function(n){(i=Date.now())-t<200&&e(n)})};HTMLElement.prototype.tap=e}(),function(){(window.ActiveXObject||"ActiveXObject"in window)&&(HTMLElement.prototype.remove=function(){var e=this.parentNode||this.parentElement;e&&e.removeChild(this)},window.Element&&function(e){e.matches=e.matches||e.matchesSelector||e.webkitMatchesSelector||e.msMatchesSelector||function(e){for(var t=this,i=(t.parentNode||t.document).querySelectorAll(e),n=-1;i[++n]&&i[n]!=t;);return!!i[n]}}(Element.prototype),window.Element&&function(e){e.closest=e.closest||function(e){for(var t=this;t.matches&&!t.matches(e);)t=t.parentNode;return t.matches?t:null}}(Element.prototype))}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.UUID"),t=function(){for(var e=[],t="0123456789abcdef",i=0;i<36;i++)e[i]=t.substr(Math.floor(16*Math.random()),1);return e[14]="4",e[19]=t.substr(3&e[19]|8,1),e[8]=e[13]=e[18]=e[23]="-",e.join("")};e.createUUID=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang"),t=function(){this.container={}};t.prototype.addEvent=function(e,t){return"string"==typeof e&&"function"==typeof t&&(void 0===this.container[e]?this.container[e]=[t]:this.container[e].push(t)),this},t.prototype.fireEvent=function(e){if(e&&this.container[e]){var t=Array.prototype.slice.call(arguments);t.shift();for(var i=this.container[e].length,n=0;n<i;n++){this.container[e][n].apply(null,t)}}return this},t.prototype.removeEvent=function(e,t){if("function"==typeof t&&"string"==typeof e){var i=this.container[e];if(i instanceof Array){for(var n=0,r=i.length;n<r;n+=1)if(i[n]===t){i.splice(n,1);break}0==i.length&&delete this.container[e]}return this}},e.EventManager=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Geometry"),t=function(e,t,i){this.x=e,this.y=t,this.z=i};t.prototype={get:function(){return{x:this.x,y:this.y,z:this.z}},set:function(e,t,i){this.x=e,this.y=t,this.z=i}},e.Point3d=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Geometry"),t=function(t,i){var n={},r=new e.Point3d,a=new e.Point3d;return r.set(t.x,t.y,t.z),a.set(i.x,i.y,i.z),n.min=r,n.max=a,n};e.BoundingBox=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Graphics.Utility"),t=function(e){var t=e.toString(16);return 1==t.length&&(t="0"+t),t};e.RGBToHex=t}(),!hostConfig)var hostConfig={APIHost:"https://api.bimface.com",resourceHost:"https://m.bimface.com",staticHost:"https://static.bimface.com",dataEnvType:"BIMFACE"};!function(){function e(e,t){function i(e){return"FloorPlan"==e||"CeilingPlan"==e}if("DrawingSheet"!=t.viewType)return null
;var n=t.viewInfo,r=n.preview.width,a=n.preview.height,o=n.outline[0],s=n.outline[2],l=n.outline[1],c=n.outline[3],u=s-o,h=c-l;n=t;for(var d=n.portsAndViews,f=0;f<d.length;f++){var p=d[f];if(i(p.viewType)){var m=function(t,i,n,s,c){var d=e.x/r,f=(a-e.y)/a;if("Elevation"==c.viewType){f=(r-e.x)/r,d=e.y/a;var p=c.viewPoint.viewDirection;1!=Math.round(p[0])&&-1!=Math.round(p[1])||(d=(a-e.y)/a)}var m=(t-o)/u,g=(i-o)/u;if(d<m||d>g)return null;var v=(n-l)/h,y=(s-l)/h;if(f<v||f>y)return null;var E=(d-m)/(g-m),x=(f-v)/(y-v),b=((c.outline[2]-c.outline[0])*E+c.outline[0])*c.viewPoint.scale,C=((c.outline[3]-c.outline[1])*x+c.outline[1])*c.viewPoint.scale;return new THREE.Vector3(b,C,0)}(p.viewport[0],p.viewport[3],p.viewport[1],p.viewport[4],p);if(null!=m){if(i(p.viewType))null!==m&&(m.z=p.elevation);else if("Elevation"==p.viewType){var g=p.viewPoint.viewDirection,v=p.cropBox;0!=Math.round(g[0])?null!==m&&(m.z=m.y,m.y=m.x,m.x=g[0]<0?v[3]:v[0]):0!=Math.round(g[1])&&null!==m&&(m.z=m.y,m.y=g[1]<0?v[4]:v[1])}return m}}}return null}function t(e,t,i){if("DrawingSheet"!=t.viewType)return!1;var n=t.preview.width,r=t.preview.height,a=t.outline[0],o=t.outline[2],s=t.outline[1],l=t.outline[3],c=t.portsAndViews;for(var u in c){var h=c[u];if("FloorPlan"===h.viewType){var d=h.viewPoint.scale,f=h.outline[0]*d,p=h.outline[2]*d,m=h.outline[1]*d,g=h.outline[3]*d;if(!(e.x<f||e.x>p||e.y<m||e.y>g)){var v=(e.x-f)/(p-f),y=(e.y-m)/(g-m),E=h.viewport[3]-h.viewport[0],x=h.viewport[4]-h.viewport[1];i(n*((h.viewport[0]+E*v-a)/(o-a)),r-r*((h.viewport[1]+x*y-s)/(l-s)),h)}}}return!0}var i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Graphics.Utility.Relation"),n=function(e,t,i){Glodon.Web.Lang.Utility.HttpRequest.ajax({url:hostConfig.resourceHost+"/"+e+"/metadata/views.json",success:function(n){var r=JSON.parse(n).viewList,n=[];for(var a in r){var o=r[a];o.viewType==t&&(o.preview.path=hostConfig.resourceHost+"/"+e+"/"+o.preview.path,n.push(o))}i&&i(n)}})},r=function(e,t,i){Glodon.Web.Lang.Utility.HttpRequest.ajax({url:hostConfig.resourceHost+"/"+e+"/metadata/drawings.json",success:function(e){for(var n=JSON.parse(e).drawingList,r=0;r<n.length;r++){var a=n[r];if(a.viewInfo.id==t){i&&i(a);break}}}})},a=function(t,i){if("DrawingSheet"==i.viewType)return e(t,i);if("FloorPlan"!=i.viewType)return console.warn("Not support yet!"),null;var n=i.preview.width,r=i.preview.height,a=i.outline[0],o=i.outline[2],s=i.outline[1],l=i.outline[3],c=o-a,u=l-s,h=(0-a)/c,d=l/u,f=(t.x-n*h)/n,p=(r*d-t.y)/r;return f=f*c*i.viewPoint.scale,p=p*u*i.viewPoint.scale,new Glodon.Web.Geometry.Point3d(f,p,i.elevation)},o=function(e,i){var n=[];if(t(e,i,function(e,t,i){n.append({x:e,y:t})}))return 0==n.length?null:n;if("FloorPlan"!=i.viewType)return console.warn("Not support yet!"),null;var r=i.preview.width,a=i.preview.height,o=i.outline[0],s=i.outline[2],l=i.outline[1],c=i.outline[3],u=s-o,h=c-l,d=(0-o)/(s-o),f=c/(c-l),p=e.x/(u*i.viewPoint.scale),m=e.y/(h*i.viewPoint.scale);return p=p*r+r*d,m=a*f-m*a,{x:p,y:m,z:0}};i.getViews=n,i.getDrawingSheets=r,i.point2DToPoint3D=a,i.point3DToPoint2D=o}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Graphics.Utility"),t=function(e){var t=new Image;return new Promise(function(i,n){t.onload=function(){i(t)},t.onerror=function(e){n(e)},t.crossOrigin="anonymous",t.src=e,!0===t.complete&&i(t)})};e.ImageContainer=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Graphics"),t=Glodon.Web.Graphics.Utility.RGBToHex,i=function(e,t,i,n){this.red=e,this.green=t,this.blue=i,this.alpha=n},n=function(e,t){/^#[0-9a-fA-F]{6}$/.test(e)&&(this.red=parseInt(e.slice(1,3),16),this.green=parseInt(e.slice(3,5),16),this.blue=parseInt(e.slice(5),16)),"number"==typeof t?(t>1&&(t=1),t<0&&(t=0),this.alpha=t):this.alpha=1},r=function(){arguments.length<4?n.apply(this,arguments):i.apply(this,arguments)};r.prototype={getRGB:function(){return"rgba("+this.red+","+this.green+","+this.blue+")"},getRGBA:function(){return"rgba("+this.red+","+this.green+","+this.blue+","+this.alpha+")"},getHEX:function(){return""+t(this.red)+t(this.green)+t(this.blue)},getAlpha:function(){return this.alpha}},e.Color=r}(),function(){SVGElement.prototype.getClass=HTMLElement.prototype.getClass=function(e){return this.getAttribute("class")},SVGElement.prototype.hasClass=HTMLElement.prototype.hasClass=function(e){var t=this.getClass();return!!t&&(t&&t.split(" ")).indexOf(e)>-1},SVGElement.prototype.addClass=HTMLElement.prototype.addClass=function(e){var t=this.getClass(),i=t&&t.split(" ");return t?-1==i.indexOf(e)&&(i.push(e),t=i.join(" "),this.setAttribute("class",""+t)):this.setAttribute("class",""+e),this},SVGElement.prototype.removeClass=HTMLElement.prototype.removeClass=function(e){if(!this.hasClass(e))return this;var t=this.getClass().replace(e,"").trim();return t?this.setAttribute("class",""+t):this.removeAttribute("class"),this},SVGElement.prototype.toggleClass=HTMLElement.prototype.toggleClass=function(e,t){var i=(this.getClass(),this.hasClass(e));return void 0!=t?(t&&!i&&this.addClass(e),t||this.removeClass(e)):i?this.removeClass(e):this.addClass(e),!i}}(),function(){Array.prototype.getObjectByAttribute=function(e,t){for(var i=this,n=i.length,r=0;r<n;r++)if(i[r][e]==t)return i[r];return!1},Array.prototype.removeObjectByAttribute=function(e,t){for(var i=this,n=i.length,r=0;r<n;r++)if(i[r][e]==t)return i=i.splice(r,1);return!1},Array.prototype.getAllObjectByAttribute=function(e,t){for(var i=this,n=i.length,r=0,a=[];r<n;r++)i[r][e]==t&&a.push(i[r]);return a},Array.prototype.removeByValue=function(e){for(var t=this,i=t.length,n=i-1;n>=0;n--)t[n]==e&&t.splice(n,1);return t},Array.prototype.insert=function(e,t){return this.splice(e,0,t),this}}(),function(){SVGElement.prototype.setCss=HTMLElement.prototype.setCss=function(e){if(e)for(var t in e)this.style[t]=e[t]},SVGElement.prototype.getCss=HTMLElement.prototype.getCss=function(){return this.style}}(),function(e,t,i){!function(e){function t(n){if(i[n])return i[n].exports;var r=i[n]={exports:{},id:n,loaded:!1};return e[n].call(r.exports,r,r.exports,t),r.loaded=!0,r.exports}var i={};t.m=e,t.c=i,t.p="",t(0)}([function(e,t,i){i(1),i(50),i(51),i(52),i(54),i(55),i(58),i(59),i(60),i(61),i(62),i(63),i(64),i(65),i(66),i(68),i(70),i(72),i(74),i(77),i(78),i(79),i(83),i(86),i(87),i(88),i(89),i(91),i(92),i(93),i(94),i(95),i(97),i(99),i(100),i(101),i(103),i(104),i(105),i(107),i(108),i(109),i(111),i(112),i(113),i(114),i(115),i(116),i(117),i(118),i(119),i(120),i(121),i(122),i(123),i(124),i(126),i(130),i(131),i(132),i(133),i(137),i(139),i(140),i(141),i(142),i(143),i(144),i(145),i(146),i(147),i(148),i(149),i(150),i(151),i(152),i(158),i(159),i(161),i(162),i(163),i(167),i(168),i(169),i(170),i(171),i(173),i(174),i(175),i(176),i(179),i(181),i(182),i(183),i(185),i(187),i(189),i(190),i(191),i(193),i(194),i(195),i(196),i(203),i(206),i(207),i(209),i(210),i(211),i(212),i(213),i(214),i(215),i(216),i(217),i(218),i(219),i(220),i(222),i(223),i(224),i(225),i(226),i(227),i(228),i(229),i(231),i(234),i(235),i(237),i(238),i(239),i(240),i(241),i(242),i(243),i(244),i(245),i(246),i(247),i(249),i(250),i(251),i(252),i(253),i(254),i(255),i(256),i(258),i(259),i(261),i(262),i(263),i(264),i(267),i(268),i(269),i(270),i(271),i(272),i(273),i(274),i(276),i(277),i(278),i(279),i(280),i(281),i(282),i(283),i(284),i(285),i(286),i(287),i(288),i(291),i(156),i(293),i(292),i(294),i(295),i(296),i(297),i(298),i(300),i(301),i(302),i(304),e.exports=i(305)},function(e,t,n){var r=n(2),a=n(3),o=n(4),s=n(6),l=n(16),c=n(20).KEY,u=n(5),h=n(21),d=n(22),f=n(17),p=n(23),m=n(24),g=n(25),v=n(27),y=n(40),E=n(43),x=n(10),b=n(30),C=n(14),M=n(15),_=n(44),w=n(47),L=n(49),T=n(9),I=n(28),S=L.f,O=T.f,D=w.f,R=r.Symbol,A=r.JSON,U=A&&A.stringify,B="prototype",P=p("_hidden"),N=p("toPrimitive"),k={}.propertyIsEnumerable,F=h("symbol-registry"),H=h("symbols"),G=h("op-symbols"),V=Object[B],z="function"==typeof R,W=r.QObject,q=!W||!W[B]||!W[B].findChild,j=o&&u(function(){return 7!=_(O({},"a",{get:function(){return O(this,"a",{value:7}).a}})).a})?function(e,t,i){var n=S(V,t);n&&delete V[t],O(e,t,i),n&&e!==V&&O(V,t,n)}:O,X=function(e){var t=H[e]=_(R[B]);return t._k=e,t},Y=z&&"symbol"==_typeof(R.iterator)?function(e){return"symbol"==(void 0===e?"undefined":_typeof(e))}:function(e){return e instanceof R},Z=function(e,t,i){return e===V&&Z(G,t,i),x(e),t=C(t,!0),x(i),a(H,t)?(i.enumerable?(a(e,P)&&e[P][t]&&(e[P][t]=!1),i=_(i,{enumerable:M(0,!1)})):(a(e,P)||O(e,P,M(1,{})),e[P][t]=!0),j(e,t,i)):O(e,t,i)},K=function(e,t){x(e);for(var i,n=y(t=b(t)),r=0,a=n.length;a>r;)Z(e,i=n[r++],t[i]);return e},Q=function(e,t){return t===i?_(e):K(_(e),t)},J=function(e){var t=k.call(this,e=C(e,!0));return!(this===V&&a(H,e)&&!a(G,e))&&(!(t||!a(this,e)||!a(H,e)||a(this,P)&&this[P][e])||t)},$=function(e,t){if(e=b(e),t=C(t,!0),e!==V||!a(H,t)||a(G,t)){var i=S(e,t);return!i||!a(H,t)||a(e,P)&&e[P][t]||(i.enumerable=!0),i}},ee=function(e){for(var t,i=D(b(e)),n=[],r=0;i.length>r;)a(H,t=i[r++])||t==P||t==c||n.push(t);return n},te=function(e){for(var t,i=e===V,n=D(i?G:b(e)),r=[],o=0;n.length>o;)!a(H,t=n[o++])||i&&!a(V,t)||r.push(H[t]);return r};z||(R=function(){if(this instanceof R)throw TypeError("Symbol is not a constructor!");var e=f(arguments.length>0?arguments[0]:i),t=function t(i){this===V&&t.call(G,i),a(this,P)&&a(this[P],e)&&(this[P][e]=!1),j(this,e,M(1,i))};return o&&q&&j(V,e,{configurable:!0,set:t}),X(e)},l(R[B],"toString",function(){return this._k}),L.f=$,T.f=Z,n(48).f=w.f=ee,n(42).f=J,n(41).f=te,o&&!n(26)&&l(V,"propertyIsEnumerable",J,!0),m.f=function(e){return X(p(e))}),s(s.G+s.W+s.F*!z,{Symbol:R});for(var ie="hasInstance,isConcatSpreadable,iterator,match,replace,search,species,split,toPrimitive,toStringTag,unscopables".split(","),ne=0;ie.length>ne;)p(ie[ne++]);for(var ie=I(p.store),ne=0;ie.length>ne;)g(ie[ne++]);s(s.S+s.F*!z,"Symbol",{for:function(e){return a(F,e+="")?F[e]:F[e]=R(e)},keyFor:function(e){if(Y(e))return v(F,e);throw TypeError(e+" is not a symbol!")},useSetter:function(){q=!0},useSimple:function(){q=!1}}),s(s.S+s.F*!z,"Object",{create:Q,defineProperty:Z,defineProperties:K,getOwnPropertyDescriptor:$,getOwnPropertyNames:ee,getOwnPropertySymbols:te}),A&&s(s.S+s.F*(!z||u(function(){var e=R();return"[null]"!=U([e])||"{}"!=U({a:e})||"{}"!=U(Object(e))})),"JSON",{stringify:function(e){if(e!==i&&!Y(e)){for(var t,n,r=[e],a=1;arguments.length>a;)r.push(arguments[a++]);return t=r[1],"function"==typeof t&&(n=t),!n&&E(t)||(t=function(e,t){if(n&&(t=n.call(this,e,t)),!Y(t))return t}),r[1]=t,U.apply(A,r)}}}),R[B][N]||n(8)(R[B],N,R[B].valueOf),d(R,"Symbol"),d(Math,"Math",!0),d(r.JSON,"JSON",!0)},function(e,i){var n=e.exports="undefined"!=typeof window&&window.Math==Math?window:"undefined"!=typeof self&&self.Math==Math?self:Function("return this")();"number"==typeof t&&(t=n)},function(e,t){var i={}.hasOwnProperty;e.exports=function(e,t){return i.call(e,t)}},function(e,t,i){e.exports=!i(5)(function(){return 7!=Object.defineProperty({},"a",{get:function(){return 7}}).a})},function(e,t){e.exports=function(e){try{return!!e()}catch(e){return!0}}},function(e,t,n){var r=n(2),a=n(7),o=n(8),s=n(16),l=n(18),c="prototype",u=function e(t,n,u){var h,d,f,p,m=t&e.F,g=t&e.G,v=t&e.S,y=t&e.P,E=t&e.B,x=g?r:v?r[n]||(r[n]={}):(r[n]||{})[c],b=g?a:a[n]||(a[n]={}),C=b[c]||(b[c]={});g&&(u=n);for(h in u)d=!m&&x&&x[h]!==i,f=(d?x:u)[h],p=E&&d?l(f,r):y&&"function"==typeof f?l(Function.call,f):f,x&&s(x,h,f,t&e.U),b[h]!=f&&o(b,h,p),y&&C[h]!=f&&(C[h]=f)};r.core=a,u.F=1,u.G=2,u.S=4,u.P=8,u.B=16,u.W=32,u.U=64,u.R=128,e.exports=u},function(t,i){var n=t.exports={version:"2.4.0"};"number"==typeof e&&(e=n)},function(e,t,i){var n=i(9),r=i(15);e.exports=i(4)?function(e,t,i){return n.f(e,t,r(1,i))}:function(e,t,i){return e[t]=i,e}},function(e,t,i){var n=i(10),r=i(12),a=i(14),o=Object.defineProperty;t.f=i(4)?Object.defineProperty:function(e,t,i){if(n(e),t=a(t,!0),n(i),r)try{return o(e,t,i)}catch(e){}if("get"in i||"set"in i)throw TypeError("Accessors not supported!");return"value"in i&&(e[t]=i.value),e}},function(e,t,i){var n=i(11);e.exports=function(e){if(!n(e))throw TypeError(e+" is not an object!");return e}},function(e,t){e.exports=function(e){return"object"==(void 0===e?"undefined":_typeof(e))?null!==e:"function"==typeof e}},function(e,t,i){e.exports=!i(4)&&!i(5)(function(){return 7!=Object.defineProperty(i(13)("div"),"a",{get:function(){return 7}}).a})},function(e,t,i){var n=i(11),r=i(2).document,a=n(r)&&n(r.createElement);e.exports=function(e){return a?r.createElement(e):{}}},function(e,t,i){var n=i(11);e.exports=function(e,t){if(!n(e))return e;var i,r;if(t&&"function"==typeof(i=e.toString)&&!n(r=i.call(e)))return r;if("function"==typeof(i=e.valueOf)&&!n(r=i.call(e)))return r;if(!t&&"function"==typeof(i=e.toString)&&!n(r=i.call(e)))return r;throw TypeError("Can't convert object to primitive value")}},function(e,t){e.exports=function(e,t){return{enumerable:!(1&e),configurable:!(2&e),writable:!(4&e),value:t}}},function(e,t,i){var n=i(2),r=i(8),a=i(3),o=i(17)("src"),s="toString",l=Function[s],c=(""+l).split(s);i(7).inspectSource=function(e){return l.call(e)},(e.exports=function(e,t,i,s){var l="function"==typeof i;l&&(a(i,"name")||r(i,"name",t)),e[t]!==i&&(l&&(a(i,o)||r(i,o,e[t]?""+e[t]:c.join(String(t)))),e===n?e[t]=i:s?e[t]?e[t]=i:r(e,t,i):(delete e[t],r(e,t,i)))})(Function.prototype,s,function(){return"function"==typeof this&&this[o]||l.call(this)})},function(e,t){var n=0,r=Math.random();e.exports=function(e){return"Symbol(".concat(e===i?"":e,")_",(++n+r).toString(36))}},function(e,t,n){var r=n(19);e.exports=function(e,t,n){if(r(e),t===i)return e;switch(n){case 1:return function(i){return e.call(t,i)};case 2:return function(i,n){return e.call(t,i,n)};case 3:return function(i,n,r){return e.call(t,i,n,r)}}return function(){return e.apply(t,arguments)}}},function(e,t){e.exports=function(e){if("function"!=typeof e)throw TypeError(e+" is not a function!");return e}},function(e,t,i){var n=i(17)("meta"),r=i(11),a=i(3),o=i(9).f,s=0,l=Object.isExtensible||function(){return!0},c=!i(5)(function(){return l(Object.preventExtensions({}))}),u=function(e){o(e,n,{value:{i:"O"+ ++s,w:{}}})},h=function(e,t){if(!r(e))return"symbol"==(void 0===e?"undefined":_typeof(e))?e:("string"==typeof e?"S":"P")+e;if(!a(e,n)){if(!l(e))return"F";if(!t)return"E";u(e)}return e[n].i},d=function(e,t){if(!a(e,n)){if(!l(e))return!0;if(!t)return!1;u(e)}return e[n].w},f=function(e){return c&&p.NEED&&l(e)&&!a(e,n)&&u(e),e},p=e.exports={KEY:n,NEED:!1,fastKey:h,getWeak:d,onFreeze:f}},function(e,t,i){var n=i(2),r="__core-js_shared__",a=n[r]||(n[r]={});e.exports=function(e){return a[e]||(a[e]={})}},function(e,t,i){var n=i(9).f,r=i(3),a=i(23)("toStringTag");e.exports=function(e,t,i){e&&!r(e=i?e:e.prototype,a)&&n(e,a,{configurable:!0,value:t})}},function(e,t,i){var n=i(21)("wks"),r=i(17),a=i(2).Symbol,o="function"==typeof a;(e.exports=function(e){return n[e]||(n[e]=o&&a[e]||(o?a:r)("Symbol."+e))}).store=n},function(e,t,i){t.f=i(23)},function(e,t,i){var n=i(2),r=i(7),a=i(26),o=i(24),s=i(9).f;e.exports=function(e){var t=r.Symbol||(r.Symbol=a?{}:n.Symbol||{});"_"==e.charAt(0)||e in t||s(t,e,{value:o.f(e)})}},function(e,t){e.exports=!1},function(e,t,i){var n=i(28),r=i(30);e.exports=function(e,t){for(var i,a=r(e),o=n(a),s=o.length,l=0;s>l;)if(a[i=o[l++]]===t)return i}},function(e,t,i){var n=i(29),r=i(39);e.exports=Object.keys||function(e){return n(e,r)}},function(e,t,i){var n=i(3),r=i(30),a=i(34)(!1),o=i(38)("IE_PROTO");e.exports=function(e,t){var i,s=r(e),l=0,c=[];for(i in s)i!=o&&n(s,i)&&c.push(i);for(;t.length>l;)n(s,i=t[l++])&&(~a(c,i)||c.push(i));return c}},function(e,t,i){var n=i(31),r=i(33);e.exports=function(e){return n(r(e))}},function(e,t,i){var n=i(32);e.exports=Object("z").propertyIsEnumerable(0)?Object:function(e){return"String"==n(e)?e.split(""):Object(e)}},function(e,t){var i={}.toString;e.exports=function(e){return i.call(e).slice(8,-1)}},function(e,t){e.exports=function(e){if(e==i)throw TypeError("Can't call method on  "+e);return e}},function(e,t,i){var n=i(30),r=i(35),a=i(37);e.exports=function(e){return function(t,i,o){var s,l=n(t),c=r(l.length),u=a(o,c);if(e&&i!=i){for(;c>u;)if((s=l[u++])!=s)return!0}else for(;c>u;u++)if((e||u in l)&&l[u]===i)return e||u||0;return!e&&-1}}},function(e,t,i){var n=i(36),r=Math.min;e.exports=function(e){return e>0?r(n(e),9007199254740991):0}},function(e,t){var i=Math.ceil,n=Math.floor;e.exports=function(e){return isNaN(e=+e)?0:(e>0?n:i)(e)}},function(e,t,i){var n=i(36),r=Math.max,a=Math.min;e.exports=function(e,t){return e=n(e),e<0?r(e+t,0):a(e,t)}},function(e,t,i){var n=i(21)("keys"),r=i(17);e.exports=function(e){return n[e]||(n[e]=r(e))}},function(e,t){e.exports="constructor,hasOwnProperty,isPrototypeOf,propertyIsEnumerable,toLocaleString,toString,valueOf".split(",")},function(e,t,i){var n=i(28),r=i(41),a=i(42);e.exports=function(e){var t=n(e),i=r.f;if(i)for(var o,s=i(e),l=a.f,c=0;s.length>c;)l.call(e,o=s[c++])&&t.push(o);return t}},function(e,t){t.f=Object.getOwnPropertySymbols},function(e,t){t.f={}.propertyIsEnumerable},function(e,t,i){var n=i(32);e.exports=Array.isArray||function(e){return"Array"==n(e)}},function(e,t,n){var r=n(10),a=n(45),o=n(39),s=n(38)("IE_PROTO"),l=function(){},c="prototype",u=function(){var e,t=n(13)("iframe"),i=o.length;for(t.style.display="none",n(46).appendChild(t),t.src="javascript:",e=t.contentWindow.document,e.open(),e.write("<script>document.F=Object<\/script>"),e.close(),u=e.F;i--;)delete u[c][o[i]];return u()};e.exports=Object.create||function(e,t){var n;return null!==e?(l[c]=r(e),n=new l,l[c]=null,n[s]=e):n=u(),t===i?n:a(n,t)}},function(e,t,i){var n=i(9),r=i(10),a=i(28);e.exports=i(4)?Object.defineProperties:function(e,t){r(e);for(var i,o=a(t),s=o.length,l=0;s>l;)n.f(e,i=o[l++],t[i]);return e}},function(e,t,i){e.exports=i(2).document&&document.documentElement},function(e,t,i){var n=i(30),r=i(48).f,a={}.toString,o="object"==("undefined"==typeof window?"undefined":_typeof(window))&&window&&Object.getOwnPropertyNames?Object.getOwnPropertyNames(window):[],s=function(e){try{return r(e)}catch(e){return o.slice()}};e.exports.f=function(e){return o&&"[object Window]"==a.call(e)?s(e):r(n(e))}},function(e,t,i){var n=i(29),r=i(39).concat("length","prototype");t.f=Object.getOwnPropertyNames||function(e){return n(e,r)}},function(e,t,i){var n=i(42),r=i(15),a=i(30),o=i(14),s=i(3),l=i(12),c=Object.getOwnPropertyDescriptor;t.f=i(4)?c:function(e,t){if(e=a(e),t=o(t,!0),l)try{return c(e,t)}catch(e){}if(s(e,t))return r(!n.f.call(e,t),e[t])}},function(e,t,i){var n=i(6);n(n.S+n.F*!i(4),"Object",{defineProperty:i(9).f})},function(e,t,i){var n=i(6);n(n.S+n.F*!i(4),"Object",{defineProperties:i(45)})},function(e,t,i){var n=i(30),r=i(49).f;i(53)("getOwnPropertyDescriptor",function(){return function(e,t){return r(n(e),t)}})},function(e,t,i){var n=i(6),r=i(7),a=i(5);e.exports=function(e,t){var i=(r.Object||{})[e]||Object[e],o={};o[e]=t(i),n(n.S+n.F*a(function(){i(1)}),"Object",o)}},function(e,t,i){var n=i(6);n(n.S,"Object",{create:i(44)})},function(e,t,i){var n=i(56),r=i(57);i(53)("getPrototypeOf",function(){return function(e){return r(n(e))}})},function(e,t,i){var n=i(33);e.exports=function(e){return Object(n(e))}},function(e,t,i){var n=i(3),r=i(56),a=i(38)("IE_PROTO"),o=Object.prototype;e.exports=Object.getPrototypeOf||function(e){return e=r(e),n(e,a)?e[a]:"function"==typeof e.constructor&&e instanceof e.constructor?e.constructor.prototype:e instanceof Object?o:null}},function(e,t,i){var n=i(56),r=i(28);i(53)("keys",function(){return function(e){return r(n(e))}})},function(e,t,i){i(53)("getOwnPropertyNames",function(){return i(47).f})},function(e,t,i){var n=i(11),r=i(20).onFreeze;i(53)("freeze",function(e){return function(t){return e&&n(t)?e(r(t)):t}})},function(e,t,i){var n=i(11),r=i(20).onFreeze;i(53)("seal",function(e){return function(t){return e&&n(t)?e(r(t)):t}})},function(e,t,i){var n=i(11),r=i(20).onFreeze;i(53)("preventExtensions",function(e){return function(t){return e&&n(t)?e(r(t)):t}})},function(e,t,i){var n=i(11);i(53)("isFrozen",function(e){return function(t){return!n(t)||!!e&&e(t)}})},function(e,t,i){var n=i(11);i(53)("isSealed",function(e){return function(t){return!n(t)||!!e&&e(t)}})},function(e,t,i){var n=i(11);i(53)("isExtensible",function(e){return function(t){return!!n(t)&&(!e||e(t))}})},function(e,t,i){var n=i(6);n(n.S+n.F,"Object",{assign:i(67)})},function(e,t,i){var n=i(28),r=i(41),a=i(42),o=i(56),s=i(31),l=Object.assign;e.exports=!l||i(5)(function(){var e={},t={},i=Symbol(),n="abcdefghijklmnopqrst";return e[i]=7,n.split("").forEach(function(e){t[e]=e}),7!=l({},e)[i]||Object.keys(l({},t)).join("")!=n})?function(e,t){for(var i=o(e),l=arguments.length,c=1,u=r.f,h=a.f;l>c;)for(var d,f=s(arguments[c++]),p=u?n(f).concat(u(f)):n(f),m=p.length,g=0;m>g;)h.call(f,d=p[g++])&&(i[d]=f[d]);return i}:l},function(e,t,i){var n=i(6);n(n.S,"Object",{is:i(69)})},function(e,t){e.exports=Object.is||function(e,t){return e===t?0!==e||1/e==1/t:e!=e&&t!=t}},function(e,t,i){var n=i(6);n(n.S,"Object",{setPrototypeOf:i(71).set})},function(e,t,n){var r=n(11),a=n(10),o=function(e,t){if(a(e),!r(t)&&null!==t)throw TypeError(t+": can't set as prototype!")};e.exports={set:Object.setPrototypeOf||("__proto__"in{}?function(e,t,i){try{i=n(18)(Function.call,n(49).f(Object.prototype,"__proto__").set,2),i(e,[]),t=!(e instanceof Array)}catch(e){t=!0}return function(e,n){return o(e,n),t?e.__proto__=n:i(e,n),e}}({},!1):i),check:o}},function(e,t,i){var n=i(73),r={};r[i(23)("toStringTag")]="z",r+""!="[object z]"&&i(16)(Object.prototype,"toString",function(){return"[object "+n(this)+"]"},!0)},function(e,t,n){var r=n(32),a=n(23)("toStringTag"),o="Arguments"==r(function(){return arguments}()),s=function(e,t){try{return e[t]}catch(e){}};e.exports=function(e){var t,n,l;return e===i?"Undefined":null===e?"Null":"string"==typeof(n=s(t=Object(e),a))?n:o?r(t):"Object"==(l=r(t))&&"function"==typeof t.callee?"Arguments":l}},function(e,t,i){var n=i(6);n(n.P,"Function",{bind:i(75)})},function(e,t,i){var n=i(19),r=i(11),a=i(76),o=[].slice,s={},l=function(e,t,i){if(!(t in s)){for(var n=[],r=0;r<t;r++)n[r]="a["+r+"]";s[t]=Function("F,a","return new F("+n.join(",")+")")}return s[t](e,i)};e.exports=Function.bind||function(e){var t=n(this),i=o.call(arguments,1),s=function n(){var r=i.concat(o.call(arguments));return this instanceof n?l(t,r.length,r):a(t,r,e)};return r(t.prototype)&&(s.prototype=t.prototype),s}},function(e,t){e.exports=function(e,t,n){var r=n===i;switch(t.length){case 0:return r?e():e.call(n);case 1:return r?e(t[0]):e.call(n,t[0]);case 2:return r?e(t[0],t[1]):e.call(n,t[0],t[1]);case 3:return r?e(t[0],t[1],t[2]):e.call(n,t[0],t[1],t[2]);case 4:return r?e(t[0],t[1],t[2],t[3]):e.call(n,t[0],t[1],t[2],t[3])}return e.apply(n,t)}},function(e,t,i){var n=i(9).f,r=i(15),a=i(3),o=Function.prototype,s=/^\s*function ([^ (]*)/,l="name",c=Object.isExtensible||function(){return!0};l in o||i(4)&&n(o,l,{configurable:!0,get:function(){try{var e=this,t=(""+e).match(s)[1];return a(e,l)||!c(e)||n(e,l,r(5,t)),t}catch(e){return""}}})},function(e,t,i){var n=i(11),r=i(57),a=i(23)("hasInstance"),o=Function.prototype;a in o||i(9).f(o,a,{value:function(e){if("function"!=typeof this||!n(e))return!1;if(!n(this.prototype))return e instanceof this;for(;e=r(e);)if(this.prototype===e)return!0;return!1}})},function(e,t,i){var n=i(2),r=i(3),a=i(32),o=i(80),s=i(14),l=i(5),c=i(48).f,u=i(49).f,h=i(9).f,d=i(81).trim,f="Number",p=n[f],m=p,g=p.prototype,v=a(i(44)(g))==f,y="trim"in String.prototype,E=function(e){var t=s(e,!1);if("string"==typeof t&&t.length>2){t=y?t.trim():d(t,3);var i,n,r,a=t.charCodeAt(0);if(43===a||45===a){if(88===(i=t.charCodeAt(2))||120===i)return NaN}else if(48===a){switch(t.charCodeAt(1)){case 66:case 98:n=2,r=49;break;case 79:case 111:n=8,r=55;break;default:return+t}for(var o,l=t.slice(2),c=0,u=l.length;c<u;c++)if((o=l.charCodeAt(c))<48||o>r)return NaN;return parseInt(l,n)}}return+t};if(!p(" 0o1")||!p("0b1")||p("+0x1")){p=function(e){var t=arguments.length<1?0:e,i=this;return i instanceof p&&(v?l(function(){g.valueOf.call(i)}):a(i)!=f)?o(new m(E(t)),i,p):E(t)};for(var x,b=i(4)?c(m):"MAX_VALUE,MIN_VALUE,NaN,NEGATIVE_INFINITY,POSITIVE_INFINITY,EPSILON,isFinite,isInteger,isNaN,isSafeInteger,MAX_SAFE_INTEGER,MIN_SAFE_INTEGER,parseFloat,parseInt,isInteger".split(","),C=0;b.length>C;C++)r(m,x=b[C])&&!r(p,x)&&h(p,x,u(m,x));p.prototype=g,g.constructor=p,i(16)(n,f,p)}},function(e,t,i){var n=i(11),r=i(71).set;e.exports=function(e,t,i){var a,o=t.constructor;return o!==i&&"function"==typeof o&&(a=o.prototype)!==i.prototype&&n(a)&&r&&r(e,a),e}},function(e,t,i){var n=i(6),r=i(33),a=i(5),o=i(82),s="["+o+"]",l="â€‹Â…",c=RegExp("^"+s+s+"*"),u=RegExp(s+s+"*$"),h=function(e,t,i){var r={},s=a(function(){return!!o[e]()||l[e]()!=l}),c=r[e]=s?t(d):o[e];i&&(r[i]=c),n(n.P+n.F*s,"String",r)},d=h.trim=function(e,t){return e=String(r(e)),1&t&&(e=e.replace(c,"")),2&t&&(e=e.replace(u,"")),e};e.exports=h},function(e,t){e.exports="\t\n\v\f\r Â áš€á Žâ€€â€â€‚â€ƒâ€„â€…â€†â€‡â€ˆâ€‰â€Šâ€¯âŸã€€\u2028\u2029\ufeff"},function(e,t,i){var n=i(6),r=i(36),a=i(84),o=i(85),s=1..toFixed,l=Math.floor,c=[0,0,0,0,0,0],u="Number.toFixed: incorrect invocation!",h="0",d=function(e,t){for(var i=-1,n=t;++i<6;)n+=e*c[i],c[i]=n%1e7,n=l(n/1e7)},f=function(e){for(var t=6,i=0;--t>=0;)i+=c[t],c[t]=l(i/e),i=i%e*1e7},p=function(){for(var e=6,t="";--e>=0;)if(""!==t||0===e||0!==c[e]){var i=String(c[e]);t=""===t?i:t+o.call(h,7-i.length)+i}return t},m=function e(t,i,n){return 0===i?n:i%2==1?e(t,i-1,n*t):e(t*t,i/2,n)},g=function(e){for(var t=0,i=e;i>=4096;)t+=12,i/=4096;for(;i>=2;)t+=1,i/=2;return t};n(n.P+n.F*(!!s&&("0.000"!==8e-5.toFixed(3)||"1"!==.9.toFixed(0)||"1.25"!==1.255.toFixed(2)||"1000000000000000128"!==(0xde0b6b3a7640080).toFixed(0))||!i(5)(function(){s.call({})})),"Number",{toFixed:function(e){var t,i,n,s,l=a(this,u),c=r(e),v="",y=h;if(c<0||c>20)throw RangeError(u);if(l!=l)return"NaN";if(l<=-1e21||l>=1e21)return String(l);if(l<0&&(v="-",l=-l),l>1e-21)if(t=g(l*m(2,69,1))-69,i=t<0?l*m(2,-t,1):l/m(2,t,1),i*=4503599627370496,(t=52-t)>0){for(d(0,i),n=c;n>=7;)d(1e7,0),n-=7;for(d(m(10,n,1),0),n=t-1;n>=23;)f(1<<23),n-=23;f(1<<n),d(1,1),f(2),y=p()}else d(0,i),d(1<<-t,0),y=p()+o.call(h,c);return c>0?(s=y.length,y=v+(s<=c?"0."+o.call(h,c-s)+y:y.slice(0,s-c)+"."+y.slice(s-c))):y=v+y,y}})},function(e,t,i){var n=i(32);e.exports=function(e,t){if("number"!=typeof e&&"Number"!=n(e))throw TypeError(t);return+e}},function(e,t,i){var n=i(36),r=i(33);e.exports=function(e){var t=String(r(this)),i="",a=n(e);if(a<0||a==1/0)throw RangeError("Count can't be negative");for(;a>0;(a>>>=1)&&(t+=t))1&a&&(i+=t);return i}},function(e,t,n){var r=n(6),a=n(5),o=n(84),s=1..toPrecision;r(r.P+r.F*(a(function(){return"1"!==s.call(1,i)})||!a(function(){s.call({})})),"Number",{toPrecision:function(e){var t=o(this,"Number#toPrecision: incorrect invocation!");return e===i?s.call(t):s.call(t,e)}})},function(e,t,i){var n=i(6);n(n.S,"Number",{EPSILON:Math.pow(2,-52)})},function(e,t,i){var n=i(6),r=i(2).isFinite;n(n.S,"Number",{isFinite:function(e){return"number"==typeof e&&r(e)}})},function(e,t,i){var n=i(6);n(n.S,"Number",{isInteger:i(90)})},function(e,t,i){var n=i(11),r=Math.floor;e.exports=function(e){return!n(e)&&isFinite(e)&&r(e)===e}},function(e,t,i){var n=i(6);n(n.S,"Number",{isNaN:function(e){return e!=e}})},function(e,t,i){var n=i(6),r=i(90),a=Math.abs;n(n.S,"Number",{isSafeInteger:function(e){return r(e)&&a(e)<=9007199254740991}})},function(e,t,i){var n=i(6);n(n.S,"Number",{MAX_SAFE_INTEGER:9007199254740991})},function(e,t,i){var n=i(6);n(n.S,"Number",{MIN_SAFE_INTEGER:-9007199254740991})},function(e,t,i){var n=i(6),r=i(96);n(n.S+n.F*(Number.parseFloat!=r),"Number",{parseFloat:r})},function(e,t,i){var n=i(2).parseFloat,r=i(81).trim;e.exports=1/n(i(82)+"-0")!=-1/0?function(e){var t=r(String(e),3),i=n(t);return 0===i&&"-"==t.charAt(0)?-0:i}:n},function(e,t,i){var n=i(6),r=i(98);n(n.S+n.F*(Number.parseInt!=r),"Number",{parseInt:r})},function(e,t,i){var n=i(2).parseInt,r=i(81).trim,a=i(82),o=/^[\-+]?0[xX]/;e.exports=8!==n(a+"08")||22!==n(a+"0x16")?function(e,t){var i=r(String(e),3);return n(i,t>>>0||(o.test(i)?16:10))}:n},function(e,t,i){var n=i(6),r=i(98);n(n.G+n.F*(parseInt!=r),{parseInt:r})},function(e,t,i){var n=i(6),r=i(96);n(n.G+n.F*(parseFloat!=r),{parseFloat:r})},function(e,t,i){var n=i(6),r=i(102),a=Math.sqrt,o=Math.acosh;n(n.S+n.F*!(o&&710==Math.floor(o(Number.MAX_VALUE))&&o(1/0)==1/0),"Math",{acosh:function(e){return(e=+e)<1?NaN:e>94906265.62425156?Math.log(e)+Math.LN2:r(e-1+a(e-1)*a(e+1))}})},function(e,t){e.exports=Math.log1p||function(e){return(e=+e)>-1e-8&&e<1e-8?e-e*e/2:Math.log(1+e)}},function(e,t,i){function n(e){return isFinite(e=+e)&&0!=e?e<0?-n(-e):Math.log(e+Math.sqrt(e*e+1)):e}var r=i(6),a=Math.asinh;r(r.S+r.F*!(a&&1/a(0)>0),"Math",{asinh:n})},function(e,t,i){var n=i(6),r=Math.atanh;n(n.S+n.F*!(r&&1/r(-0)<0),"Math",{atanh:function(e){return 0==(e=+e)?e:Math.log((1+e)/(1-e))/2}})},function(e,t,i){var n=i(6),r=i(106);n(n.S,"Math",{cbrt:function(e){return r(e=+e)*Math.pow(Math.abs(e),1/3)}})},function(e,t){e.exports=Math.sign||function(e){return 0==(e=+e)||e!=e?e:e<0?-1:1}},function(e,t,i){var n=i(6);n(n.S,"Math",{clz32:function(e){return(e>>>=0)?31-Math.floor(Math.log(e+.5)*Math.LOG2E):32}})},function(e,t,i){var n=i(6),r=Math.exp;n(n.S,"Math",{cosh:function(e){return(r(e=+e)+r(-e))/2}})},function(e,t,i){var n=i(6),r=i(110);n(n.S+n.F*(r!=Math.expm1),"Math",{expm1:r})},function(e,t){var i=Math.expm1;e.exports=!i||i(10)>22025.465794806718||i(10)<22025.465794806718||-2e-17!=i(-2e-17)?function(e){return 0==(e=+e)?e:e>-1e-6&&e<1e-6?e+e*e/2:Math.exp(e)-1}:i},function(e,t,i){var n=i(6),r=i(106),a=Math.pow,o=a(2,-52),s=a(2,-23),l=a(2,127)*(2-s),c=a(2,-126),u=function(e){return e+1/o-1/o};n(n.S,"Math",{fround:function(e){var t,i,n=Math.abs(e),a=r(e);return n<c?a*u(n/c/s)*c*s:(t=(1+s/o)*n,i=t-(t-n),i>l||i!=i?a*(1/0):a*i)}})},function(e,t,i){var n=i(6),r=Math.abs;n(n.S,"Math",{hypot:function(e,t){for(var i,n,a=0,o=0,s=arguments.length,l=0;o<s;)i=r(arguments[o++]),l<i?(n=l/i,a=a*n*n+1,l=i):i>0?(n=i/l,a+=n*n):a+=i;return l===1/0?1/0:l*Math.sqrt(a)}})},function(e,t,i){var n=i(6),r=Math.imul;n(n.S+n.F*i(5)(function(){return-5!=r(4294967295,5)||2!=r.length}),"Math",{imul:function(e,t){var i=65535,n=+e,r=+t,a=i&n,o=i&r;return 0|a*o+((i&n>>>16)*o+a*(i&r>>>16)<<16>>>0)}})},function(e,t,i){var n=i(6);n(n.S,"Math",{log10:function(e){return Math.log(e)/Math.LN10}})},function(e,t,i){var n=i(6);n(n.S,"Math",{log1p:i(102)})},function(e,t,i){var n=i(6);n(n.S,"Math",{log2:function(e){return Math.log(e)/Math.LN2}})},function(e,t,i){var n=i(6);n(n.S,"Math",{sign:i(106)})},function(e,t,i){var n=i(6),r=i(110),a=Math.exp;n(n.S+n.F*i(5)(function(){return-2e-17!=!Math.sinh(-2e-17)}),"Math",{sinh:function(e){return Math.abs(e=+e)<1?(r(e)-r(-e))/2:(a(e-1)-a(-e-1))*(Math.E/2)}})},function(e,t,i){var n=i(6),r=i(110),a=Math.exp;n(n.S,"Math",{tanh:function(e){var t=r(e=+e),i=r(-e);return t==1/0?1:i==1/0?-1:(t-i)/(a(e)+a(-e))}})},function(e,t,i){var n=i(6);n(n.S,"Math",{trunc:function(e){return(e>0?Math.floor:Math.ceil)(e)}})},function(e,t,i){var n=i(6),r=i(37),a=String.fromCharCode,o=String.fromCodePoint;n(n.S+n.F*(!!o&&1!=o.length),"String",{fromCodePoint:function(e){for(var t,i=[],n=arguments.length,o=0;n>o;){if(t=+arguments[o++],r(t,1114111)!==t)throw RangeError(t+" is not a valid code point");i.push(t<65536?a(t):a(55296+((t-=65536)>>10),t%1024+56320))}return i.join("")}})},function(e,t,i){var n=i(6),r=i(30),a=i(35);n(n.S,"String",{raw:function(e){for(var t=r(e.raw),i=a(t.length),n=arguments.length,o=[],s=0;i>s;)o.push(String(t[s++])),s<n&&o.push(String(arguments[s]));return o.join("")}})},function(e,t,i){i(81)("trim",function(e){return function(){return e(this,3)}})},function(e,t,i){var n=i(6),r=i(125)(!1);n(n.P,"String",{codePointAt:function(e){return r(this,e)}})},function(e,t,n){var r=n(36),a=n(33);e.exports=function(e){return function(t,n){var o,s,l=String(a(t)),c=r(n),u=l.length;return c<0||c>=u?e?"":i:(o=l.charCodeAt(c),
o<55296||o>56319||c+1===u||(s=l.charCodeAt(c+1))<56320||s>57343?e?l.charAt(c):o:e?l.slice(c,c+2):s-56320+(o-55296<<10)+65536)}}},function(e,t,n){var r=n(6),a=n(35),o=n(127),s="endsWith",l=""[s];r(r.P+r.F*n(129)(s),"String",{endsWith:function(e){var t=o(this,e,s),n=arguments.length>1?arguments[1]:i,r=a(t.length),c=n===i?r:Math.min(a(n),r),u=String(e);return l?l.call(t,u,c):t.slice(c-u.length,c)===u}})},function(e,t,i){var n=i(128),r=i(33);e.exports=function(e,t,i){if(n(t))throw TypeError("String#"+i+" doesn't accept regex!");return String(r(e))}},function(e,t,n){var r=n(11),a=n(32),o=n(23)("match");e.exports=function(e){var t;return r(e)&&((t=e[o])!==i?!!t:"RegExp"==a(e))}},function(e,t,i){var n=i(23)("match");e.exports=function(e){var t=/./;try{"/./"[e](t)}catch(i){try{return t[n]=!1,!"/./"[e](t)}catch(e){}}return!0}},function(e,t,n){var r=n(6),a=n(127),o="includes";r(r.P+r.F*n(129)(o),"String",{includes:function(e){return!!~a(this,e,o).indexOf(e,arguments.length>1?arguments[1]:i)}})},function(e,t,i){var n=i(6);n(n.P,"String",{repeat:i(85)})},function(e,t,n){var r=n(6),a=n(35),o=n(127),s="startsWith",l=""[s];r(r.P+r.F*n(129)(s),"String",{startsWith:function(e){var t=o(this,e,s),n=a(Math.min(arguments.length>1?arguments[1]:i,t.length)),r=String(e);return l?l.call(t,r,n):t.slice(n,n+r.length)===r}})},function(e,t,n){var r=n(125)(!0);n(134)(String,"String",function(e){this._t=String(e),this._i=0},function(){var e,t=this._t,n=this._i;return n>=t.length?{value:i,done:!0}:(e=r(t,n),this._i+=e.length,{value:e,done:!1})})},function(e,t,n){var r=n(26),a=n(6),o=n(16),s=n(8),l=n(3),c=n(135),u=n(136),h=n(22),d=n(57),f=n(23)("iterator"),p=!([].keys&&"next"in[].keys()),m="keys",g="values",v=function(){return this};e.exports=function(e,t,n,y,E,x,b){u(n,t,y);var C,M,_,w=function(e){if(!p&&e in S)return S[e];switch(e){case m:case g:return function(){return new n(this,e)}}return function(){return new n(this,e)}},L=t+" Iterator",T=E==g,I=!1,S=e.prototype,O=S[f]||S["@@iterator"]||E&&S[E],D=O||w(E),R=E?T?w("entries"):D:i,A="Array"==t?S.entries||O:O;if(A&&(_=d(A.call(new e)))!==Object.prototype&&(h(_,L,!0),r||l(_,f)||s(_,f,v)),T&&O&&O.name!==g&&(I=!0,D=function(){return O.call(this)}),r&&!b||!p&&!I&&S[f]||s(S,f,D),c[t]=D,c[L]=v,E)if(C={values:T?D:w(g),keys:x?D:w(m),entries:R},b)for(M in C)M in S||o(S,M,C[M]);else a(a.P+a.F*(p||I),t,C);return C}},function(e,t){e.exports={}},function(e,t,i){var n=i(44),r=i(15),a=i(22),o={};i(8)(o,i(23)("iterator"),function(){return this}),e.exports=function(e,t,i){e.prototype=n(o,{next:r(1,i)}),a(e,t+" Iterator")}},function(e,t,i){i(138)("anchor",function(e){return function(t){return e(this,"a","name",t)}})},function(e,t,i){var n=i(6),r=i(5),a=i(33),o=/"/g,s=function(e,t,i,n){var r=String(a(e)),s="<"+t;return""!==i&&(s+=" "+i+'="'+String(n).replace(o,"&quot;")+'"'),s+">"+r+"</"+t+">"};e.exports=function(e,t){var i={};i[e]=t(s),n(n.P+n.F*r(function(){var t=""[e]('"');return t!==t.toLowerCase()||t.split('"').length>3}),"String",i)}},function(e,t,i){i(138)("big",function(e){return function(){return e(this,"big","","")}})},function(e,t,i){i(138)("blink",function(e){return function(){return e(this,"blink","","")}})},function(e,t,i){i(138)("bold",function(e){return function(){return e(this,"b","","")}})},function(e,t,i){i(138)("fixed",function(e){return function(){return e(this,"tt","","")}})},function(e,t,i){i(138)("fontcolor",function(e){return function(t){return e(this,"font","color",t)}})},function(e,t,i){i(138)("fontsize",function(e){return function(t){return e(this,"font","size",t)}})},function(e,t,i){i(138)("italics",function(e){return function(){return e(this,"i","","")}})},function(e,t,i){i(138)("link",function(e){return function(t){return e(this,"a","href",t)}})},function(e,t,i){i(138)("small",function(e){return function(){return e(this,"small","","")}})},function(e,t,i){i(138)("strike",function(e){return function(){return e(this,"strike","","")}})},function(e,t,i){i(138)("sub",function(e){return function(){return e(this,"sub","","")}})},function(e,t,i){i(138)("sup",function(e){return function(){return e(this,"sup","","")}})},function(e,t,i){var n=i(6);n(n.S,"Array",{isArray:i(43)})},function(e,t,n){var r=n(18),a=n(6),o=n(56),s=n(153),l=n(154),c=n(35),u=n(155),h=n(156);a(a.S+a.F*!n(157)(function(e){}),"Array",{from:function(e){var t,n,a,d,f=o(e),p="function"==typeof this?this:Array,m=arguments.length,g=m>1?arguments[1]:i,v=g!==i,y=0,E=h(f);if(v&&(g=r(g,m>2?arguments[2]:i,2)),E==i||p==Array&&l(E))for(t=c(f.length),n=new p(t);t>y;y++)u(n,y,v?g(f[y],y):f[y]);else for(d=E.call(f),n=new p;!(a=d.next()).done;y++)u(n,y,v?s(d,g,[a.value,y],!0):a.value);return n.length=y,n}})},function(e,t,n){var r=n(10);e.exports=function(e,t,n,a){try{return a?t(r(n)[0],n[1]):t(n)}catch(t){var o=e.return;throw o!==i&&r(o.call(e)),t}}},function(e,t,n){var r=n(135),a=n(23)("iterator"),o=Array.prototype;e.exports=function(e){return e!==i&&(r.Array===e||o[a]===e)}},function(e,t,i){var n=i(9),r=i(15);e.exports=function(e,t,i){t in e?n.f(e,t,r(0,i)):e[t]=i}},function(e,t,n){var r=n(73),a=n(23)("iterator"),o=n(135);e.exports=n(7).getIteratorMethod=function(e){if(e!=i)return e[a]||e["@@iterator"]||o[r(e)]}},function(e,t,i){var n=i(23)("iterator"),r=!1;try{var a=[7][n]();a.return=function(){r=!0},Array.from(a,function(){throw 2})}catch(e){}e.exports=function(e,t){if(!t&&!r)return!1;var i=!1;try{var a=[7],o=a[n]();o.next=function(){return{done:i=!0}},a[n]=function(){return o},e(a)}catch(e){}return i}},function(e,t,i){var n=i(6),r=i(155);n(n.S+n.F*i(5)(function(){function e(){}return!(Array.of.call(e)instanceof e)}),"Array",{of:function(){for(var e=0,t=arguments.length,i=new("function"==typeof this?this:Array)(t);t>e;)r(i,e,arguments[e++]);return i.length=t,i}})},function(e,t,n){var r=n(6),a=n(30),o=[].join;r(r.P+r.F*(n(31)!=Object||!n(160)(o)),"Array",{join:function(e){return o.call(a(this),e===i?",":e)}})},function(e,t,i){var n=i(5);e.exports=function(e,t){return!!e&&n(function(){t?e.call(null,function(){},1):e.call(null)})}},function(e,t,n){var r=n(6),a=n(46),o=n(32),s=n(37),l=n(35),c=[].slice;r(r.P+r.F*n(5)(function(){a&&c.call(a)}),"Array",{slice:function(e,t){var n=l(this.length),r=o(this);if(t=t===i?n:t,"Array"==r)return c.call(this,e,t);for(var a=s(e,n),u=s(t,n),h=l(u-a),d=Array(h),f=0;f<h;f++)d[f]="String"==r?this.charAt(a+f):this[a+f];return d}})},function(e,t,n){var r=n(6),a=n(19),o=n(56),s=n(5),l=[].sort,c=[1,2,3];r(r.P+r.F*(s(function(){c.sort(i)})||!s(function(){c.sort(null)})||!n(160)(l)),"Array",{sort:function(e){return e===i?l.call(o(this)):l.call(o(this),a(e))}})},function(e,t,i){var n=i(6),r=i(164)(0),a=i(160)([].forEach,!0);n(n.P+n.F*!a,"Array",{forEach:function(e){return r(this,e,arguments[1])}})},function(e,t,n){var r=n(18),a=n(31),o=n(56),s=n(35),l=n(165);e.exports=function(e,t){var n=1==e,c=2==e,u=3==e,h=4==e,d=6==e,f=5==e||d,p=t||l;return function(t,l,m){for(var g,v,y=o(t),E=a(y),x=r(l,m,3),b=s(E.length),C=0,M=n?p(t,b):c?p(t,0):i;b>C;C++)if((f||C in E)&&(g=E[C],v=x(g,C,y),e))if(n)M[C]=v;else if(v)switch(e){case 3:return!0;case 5:return g;case 6:return C;case 2:M.push(g)}else if(h)return!1;return d?-1:u||h?h:M}}},function(e,t,i){var n=i(166);e.exports=function(e,t){return new(n(e))(t)}},function(e,t,n){var r=n(11),a=n(43),o=n(23)("species");e.exports=function(e){var t;return a(e)&&(t=e.constructor,"function"!=typeof t||t!==Array&&!a(t.prototype)||(t=i),r(t)&&null===(t=t[o])&&(t=i)),t===i?Array:t}},function(e,t,i){var n=i(6),r=i(164)(1);n(n.P+n.F*!i(160)([].map,!0),"Array",{map:function(e){return r(this,e,arguments[1])}})},function(e,t,i){var n=i(6),r=i(164)(2);n(n.P+n.F*!i(160)([].filter,!0),"Array",{filter:function(e){return r(this,e,arguments[1])}})},function(e,t,i){var n=i(6),r=i(164)(3);n(n.P+n.F*!i(160)([].some,!0),"Array",{some:function(e){return r(this,e,arguments[1])}})},function(e,t,i){var n=i(6),r=i(164)(4);n(n.P+n.F*!i(160)([].every,!0),"Array",{every:function(e){return r(this,e,arguments[1])}})},function(e,t,i){var n=i(6),r=i(172);n(n.P+n.F*!i(160)([].reduce,!0),"Array",{reduce:function(e){return r(this,e,arguments.length,arguments[1],!1)}})},function(e,t,i){var n=i(19),r=i(56),a=i(31),o=i(35);e.exports=function(e,t,i,s,l){n(t);var c=r(e),u=a(c),h=o(c.length),d=l?h-1:0,f=l?-1:1;if(i<2)for(;;){if(d in u){s=u[d],d+=f;break}if(d+=f,l?d<0:h<=d)throw TypeError("Reduce of empty array with no initial value")}for(;l?d>=0:h>d;d+=f)d in u&&(s=t(s,u[d],d,c));return s}},function(e,t,i){var n=i(6),r=i(172);n(n.P+n.F*!i(160)([].reduceRight,!0),"Array",{reduceRight:function(e){return r(this,e,arguments.length,arguments[1],!0)}})},function(e,t,i){var n=i(6),r=i(34)(!1),a=[].indexOf,o=!!a&&1/[1].indexOf(1,-0)<0;n(n.P+n.F*(o||!i(160)(a)),"Array",{indexOf:function(e){return o?a.apply(this,arguments)||0:r(this,e,arguments[1])}})},function(e,t,i){var n=i(6),r=i(30),a=i(36),o=i(35),s=[].lastIndexOf,l=!!s&&1/[1].lastIndexOf(1,-0)<0;n(n.P+n.F*(l||!i(160)(s)),"Array",{lastIndexOf:function(e){if(l)return s.apply(this,arguments)||0;var t=r(this),i=o(t.length),n=i-1;for(arguments.length>1&&(n=Math.min(n,a(arguments[1]))),n<0&&(n=i+n);n>=0;n--)if(n in t&&t[n]===e)return n||0;return-1}})},function(e,t,i){var n=i(6);n(n.P,"Array",{copyWithin:i(177)}),i(178)("copyWithin")},function(e,t,n){var r=n(56),a=n(37),o=n(35);e.exports=[].copyWithin||function(e,t){var n=r(this),s=o(n.length),l=a(e,s),c=a(t,s),u=arguments.length>2?arguments[2]:i,h=Math.min((u===i?s:a(u,s))-c,s-l),d=1;for(c<l&&l<c+h&&(d=-1,c+=h-1,l+=h-1);h-- >0;)c in n?n[l]=n[c]:delete n[l],l+=d,c+=d;return n}},function(e,t,n){var r=n(23)("unscopables"),a=Array.prototype;a[r]==i&&n(8)(a,r,{}),e.exports=function(e){a[r][e]=!0}},function(e,t,i){var n=i(6);n(n.P,"Array",{fill:i(180)}),i(178)("fill")},function(e,t,n){var r=n(56),a=n(37),o=n(35);e.exports=function(e){for(var t=r(this),n=o(t.length),s=arguments.length,l=a(s>1?arguments[1]:i,n),c=s>2?arguments[2]:i,u=c===i?n:a(c,n);u>l;)t[l++]=e;return t}},function(e,t,n){var r=n(6),a=n(164)(5),o="find",s=!0;o in[]&&Array(1)[o](function(){s=!1}),r(r.P+r.F*s,"Array",{find:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),n(178)(o)},function(e,t,n){var r=n(6),a=n(164)(6),o="findIndex",s=!0;o in[]&&Array(1)[o](function(){s=!1}),r(r.P+r.F*s,"Array",{findIndex:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),n(178)(o)},function(e,t,n){var r=n(178),a=n(184),o=n(135),s=n(30);e.exports=n(134)(Array,"Array",function(e,t){this._t=s(e),this._i=0,this._k=t},function(){var e=this._t,t=this._k,n=this._i++;return!e||n>=e.length?(this._t=i,a(1)):"keys"==t?a(0,n):"values"==t?a(0,e[n]):a(0,[n,e[n]])},"values"),o.Arguments=o.Array,r("keys"),r("values"),r("entries")},function(e,t){e.exports=function(e,t){return{value:t,done:!!e}}},function(e,t,i){i(186)("Array")},function(e,t,i){var n=i(2),r=i(9),a=i(4),o=i(23)("species");e.exports=function(e){var t=n[e];a&&t&&!t[o]&&r.f(t,o,{configurable:!0,get:function(){return this}})}},function(e,t,n){var r=n(2),a=n(80),o=n(9).f,s=n(48).f,l=n(128),c=n(188),u=r.RegExp,h=u,d=u.prototype,f=/a/g,p=/a/g,m=new u(f)!==f;if(n(4)&&(!m||n(5)(function(){return p[n(23)("match")]=!1,u(f)!=f||u(p)==p||"/a/i"!=u(f,"i")}))){u=function(e,t){var n=this instanceof u,r=l(e),o=t===i;return!n&&r&&e.constructor===u&&o?e:a(m?new h(r&&!o?e.source:e,t):h((r=e instanceof u)?e.source:e,r&&o?c.call(e):t),n?this:d,u)};for(var g=s(h),v=0;g.length>v;)!function(e){e in u||o(u,e,{configurable:!0,get:function(){return h[e]},set:function(t){h[e]=t}})}(g[v++]);d.constructor=u,u.prototype=d,n(16)(r,"RegExp",u)}n(186)("RegExp")},function(e,t,i){var n=i(10);e.exports=function(){var e=n(this),t="";return e.global&&(t+="g"),e.ignoreCase&&(t+="i"),e.multiline&&(t+="m"),e.unicode&&(t+="u"),e.sticky&&(t+="y"),t}},function(e,t,n){n(190);var r=n(10),a=n(188),o=n(4),s="toString",l=/./[s],c=function(e){n(16)(RegExp.prototype,s,e,!0)};n(5)(function(){return"/a/b"!=l.call({source:"a",flags:"b"})})?c(function(){var e=r(this);return"/".concat(e.source,"/","flags"in e?e.flags:!o&&e instanceof RegExp?a.call(e):i)}):l.name!=s&&c(function(){return l.call(this)})},function(e,t,i){i(4)&&"g"!=/./g.flags&&i(9).f(RegExp.prototype,"flags",{configurable:!0,get:i(188)})},function(e,t,n){n(192)("match",1,function(e,t,n){return[function(n){var r=e(this),a=n==i?i:n[t];return a!==i?a.call(n,r):new RegExp(n)[t](String(r))},n]})},function(e,t,i){var n=i(8),r=i(16),a=i(5),o=i(33),s=i(23);e.exports=function(e,t,i){var l=s(e),c=i(o,l,""[e]),u=c[0],h=c[1];a(function(){var t={};return t[l]=function(){return 7},7!=""[e](t)})&&(r(String.prototype,e,u),n(RegExp.prototype,l,2==t?function(e,t){return h.call(e,this,t)}:function(e){return h.call(e,this)}))}},function(e,t,n){n(192)("replace",2,function(e,t,n){return[function(r,a){var o=e(this),s=r==i?i:r[t];return s!==i?s.call(r,o,a):n.call(String(o),r,a)},n]})},function(e,t,n){n(192)("search",1,function(e,t,n){return[function(n){var r=e(this),a=n==i?i:n[t];return a!==i?a.call(n,r):new RegExp(n)[t](String(r))},n]})},function(e,t,n){n(192)("split",2,function(e,t,r){var a=n(128),o=r,s=[].push,l="split",c="length",u="lastIndex";if("c"=="abbc"[l](/(b)*/)[1]||4!="test"[l](/(?:)/,-1)[c]||2!="ab"[l](/(?:ab)*/)[c]||4!="."[l](/(.?)(.?)/)[c]||"."[l](/()()/)[c]>1||""[l](/.?/)[c]){var h=/()??/.exec("")[1]===i;r=function(e,t){var n=String(this);if(e===i&&0===t)return[];if(!a(e))return o.call(n,e,t);var r,l,d,f,p,m=[],g=(e.ignoreCase?"i":"")+(e.multiline?"m":"")+(e.unicode?"u":"")+(e.sticky?"y":""),v=0,y=t===i?4294967295:t>>>0,E=new RegExp(e.source,g+"g");for(h||(r=new RegExp("^"+E.source+"$(?!\\s)",g));(l=E.exec(n))&&!((d=l.index+l[0][c])>v&&(m.push(n.slice(v,l.index)),!h&&l[c]>1&&l[0].replace(r,function(){for(p=1;p<arguments[c]-2;p++)arguments[p]===i&&(l[p]=i)}),l[c]>1&&l.index<n[c]&&s.apply(m,l.slice(1)),f=l[0][c],v=d,m[c]>=y));)E[u]===l.index&&E[u]++;return v===n[c]?!f&&E.test("")||m.push(""):m.push(n.slice(v)),m[c]>y?m.slice(0,y):m}}else"0"[l](i,0)[c]&&(r=function(e,t){return e===i&&0===t?[]:o.call(this,e,t)});return[function(n,a){var o=e(this),s=n==i?i:n[t];return s!==i?s.call(n,o,a):r.call(String(o),n,a)},r]})},function(e,t,n){var r,a,o,s=n(26),l=n(2),c=n(18),u=n(73),h=n(6),d=n(11),f=n(19),p=n(197),m=n(198),g=n(199),v=n(200).set,y=n(201)(),E="Promise",x=l.TypeError,b=l.process,C=l[E],b=l.process,M="process"==u(b),_=function(){},w=!!function(){try{var e=C.resolve(1),t=(e.constructor={})[n(23)("species")]=function(e){e(_,_)};return(M||"function"==typeof PromiseRejectionEvent)&&e.then(_)instanceof t}catch(e){}}(),L=function(e,t){return e===t||e===C&&t===o},T=function(e){var t;return!(!d(e)||"function"!=typeof(t=e.then))&&t},I=function(e){return L(C,e)?new S(e):new a(e)},S=a=function(e){var t,n;this.promise=new e(function(e,r){if(t!==i||n!==i)throw x("Bad Promise constructor");t=e,n=r}),this.resolve=f(t),this.reject=f(n)},O=function(e){try{e()}catch(e){return{error:e}}},D=function(e,t){if(!e._n){e._n=!0;var i=e._c;y(function(){for(var n=e._v,r=1==e._s,a=0;i.length>a;)!function(t){var i,a,o=r?t.ok:t.fail,s=t.resolve,l=t.reject,c=t.domain;try{o?(r||(2==e._h&&U(e),e._h=1),!0===o?i=n:(c&&c.enter(),i=o(n),c&&c.exit()),i===t.promise?l(x("Promise-chain cycle")):(a=T(i))?a.call(i,s,l):s(i)):l(n)}catch(e){l(e)}}(i[a++]);e._c=[],e._n=!1,t&&!e._h&&R(e)})}},R=function(e){v.call(l,function(){var t,n,r,a=e._v;if(A(e)&&(t=O(function(){M?b.emit("unhandledRejection",a,e):(n=l.onunhandledrejection)?n({promise:e,reason:a}):(r=l.console)&&r.error&&r.error("Unhandled promise rejection",a)}),e._h=M||A(e)?2:1),e._a=i,t)throw t.error})},A=function e(t){if(1==t._h)return!1;for(var i,n=t._a||t._c,r=0;n.length>r;)if(i=n[r++],i.fail||!e(i.promise))return!1;return!0},U=function(e){v.call(l,function(){var t;M?b.emit("rejectionHandled",e):(t=l.onrejectionhandled)&&t({promise:e,reason:e._v})})},B=function(e){var t=this;t._d||(t._d=!0,t=t._w||t,t._v=e,t._s=2,t._a||(t._a=t._c.slice()),D(t,!0))},P=function e(t){var i,n=this;if(!n._d){n._d=!0,n=n._w||n;try{if(n===t)throw x("Promise can't be resolved itself");(i=T(t))?y(function(){var r={_w:n,_d:!1};try{i.call(t,c(e,r,1),c(B,r,1))}catch(e){B.call(r,e)}}):(n._v=t,n._s=1,D(n,!1))}catch(e){B.call({_w:n,_d:!1},e)}}};w||(C=function(e){p(this,C,E,"_h"),f(e),r.call(this);try{e(c(P,this,1),c(B,this,1))}catch(e){B.call(this,e)}},r=function(e){this._c=[],this._a=i,this._s=0,this._d=!1,this._v=i,this._h=0,this._n=!1},r.prototype=n(202)(C.prototype,{then:function(e,t){var n=I(g(this,C));return n.ok="function"!=typeof e||e,n.fail="function"==typeof t&&t,n.domain=M?b.domain:i,this._c.push(n),this._a&&this._a.push(n),this._s&&D(this,!1),n.promise},catch:function(e){return this.then(i,e)}}),S=function(){var e=new r;this.promise=e,this.resolve=c(P,e,1),this.reject=c(B,e,1)}),h(h.G+h.W+h.F*!w,{Promise:C}),n(22)(C,E),n(186)(E),o=n(7)[E],h(h.S+h.F*!w,E,{reject:function(e){var t=I(this);return(0,t.reject)(e),t.promise}}),h(h.S+h.F*(s||!w),E,{resolve:function(e){if(e instanceof C&&L(e.constructor,this))return e;var t=I(this);return(0,t.resolve)(e),t.promise}}),h(h.S+h.F*!(w&&n(157)(function(e){C.all(e).catch(_)})),E,{all:function(e){var t=this,n=I(t),r=n.resolve,a=n.reject,o=O(function(){var n=[],o=0,s=1;m(e,!1,function(e){var l=o++,c=!1;n.push(i),s++,t.resolve(e).then(function(e){c||(c=!0,n[l]=e,--s||r(n))},a)}),--s||r(n)});return o&&a(o.error),n.promise},race:function(e){var t=this,i=I(t),n=i.reject,r=O(function(){m(e,!1,function(e){t.resolve(e).then(i.resolve,n)})});return r&&n(r.error),i.promise}})},function(e,t){e.exports=function(e,t,n,r){if(!(e instanceof t)||r!==i&&r in e)throw TypeError(n+": incorrect invocation!");return e}},function(e,t,i){var n=i(18),r=i(153),a=i(154),o=i(10),s=i(35),l=i(156),c={},u={},t=e.exports=function(e,t,i,h,d){var f,p,m,g,v=d?function(){return e}:l(e),y=n(i,h,t?2:1),E=0;if("function"!=typeof v)throw TypeError(e+" is not iterable!");if(a(v)){for(f=s(e.length);f>E;E++)if((g=t?y(o(p=e[E])[0],p[1]):y(e[E]))===c||g===u)return g}else for(m=v.call(e);!(p=m.next()).done;)if((g=r(m,y,p.value,t))===c||g===u)return g};t.BREAK=c,t.RETURN=u},function(e,t,n){var r=n(10),a=n(19),o=n(23)("species");e.exports=function(e,t){var n,s=r(e).constructor;return s===i||(n=r(s)[o])==i?t:a(n)}},function(e,t,i){var n,r,a,o=i(18),s=i(76),l=i(46),c=i(13),u=i(2),h=u.process,d=u.setImmediate,f=u.clearImmediate,p=u.MessageChannel,m=0,g={},v="onreadystatechange",y=function(){var e=+this;if(g.hasOwnProperty(e)){var t=g[e];delete g[e],t()}},E=function(e){y.call(e.data)};d&&f||(d=function(e){for(var t=[],i=1;arguments.length>i;)t.push(arguments[i++]);return g[++m]=function(){s("function"==typeof e?e:Function(e),t)},n(m),m},f=function(e){delete g[e]},"process"==i(32)(h)?n=function(e){h.nextTick(o(y,e,1))}:p?(r=new p,a=r.port2,r.port1.onmessage=E,n=o(a.postMessage,a,1)):u.addEventListener&&"function"==typeof postMessage&&!u.importScripts?(n=function(e){u.postMessage(e+"","*")},u.addEventListener("message",E,!1)):n=v in c("script")?function(e){l.appendChild(c("script"))[v]=function(){l.removeChild(this),y.call(e)}}:function(e){setTimeout(o(y,e,1),0)}),e.exports={set:d,clear:f}},function(e,t,n){var r=n(2),a=n(200).set,o=r.MutationObserver||r.WebKitMutationObserver,s=r.process,l=r.Promise,c="process"==n(32)(s);e.exports=function(){var e,t,n,u=function(){var r,a;for(c&&(r=s.domain)&&r.exit();e;){a=e.fn,e=e.next;try{a()}catch(r){throw e?n():t=i,r}}t=i,r&&r.enter()};if(c)n=function(){s.nextTick(u)};else if(o){var h=!0,d=document.createTextNode("");new o(u).observe(d,{characterData:!0}),n=function(){d.data=h=!h}}else if(l&&l.resolve){var f=l.resolve();n=function(){f.then(u)}}else n=function(){a.call(r,u)};return function(r){var a={fn:r,next:i};t&&(t.next=a),e||(e=a,n()),t=a}}},function(e,t,i){var n=i(16);e.exports=function(e,t,i){for(var r in t)n(e,r,t[r],i);return e}},function(e,t,n){var r=n(204);e.exports=n(205)("Map",function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},{get:function(e){var t=r.getEntry(this,e);return t&&t.v},set:function(e,t){return r.def(this,0===e?0:e,t)}},r,!0)},function(e,t,n){var r=n(9).f,a=n(44),o=n(202),s=n(18),l=n(197),c=n(33),u=n(198),h=n(134),d=n(184),f=n(186),p=n(4),m=n(20).fastKey,g=p?"_s":"size",v=function(e,t){var i,n=m(t);if("F"!==n)return e._i[n];for(i=e._f;i;i=i.n)if(i.k==t)return i};e.exports={getConstructor:function(e,t,n,h){var d=e(function(e,r){l(e,d,t,"_i"),e._i=a(null),e._f=i,e._l=i,e[g]=0,r!=i&&u(r,n,e[h],e)});return o(d.prototype,{clear:function(){for(var e=this,t=e._i,n=e._f;n;n=n.n)n.r=!0,n.p&&(n.p=n.p.n=i),delete t[n.i];e._f=e._l=i,e[g]=0},delete:function(e){var t=this,i=v(t,e);if(i){var n=i.n,r=i.p;delete t._i[i.i],i.r=!0,r&&(r.n=n),n&&(n.p=r),t._f==i&&(t._f=n),t._l==i&&(t._l=r),t[g]--}return!!i},forEach:function(e){l(this,d,"forEach");for(var t,n=s(e,arguments.length>1?arguments[1]:i,3);t=t?t.n:this._f;)for(n(t.v,t.k,this);t&&t.r;)t=t.p},has:function(e){return!!v(this,e)}}),p&&r(d.prototype,"size",{get:function(){return c(this[g])}}),d},def:function(e,t,n){var r,a,o=v(e,t);return o?o.v=n:(e._l=o={i:a=m(t,!0),k:t,v:n,p:r=e._l,n:i,r:!1},e._f||(e._f=o),r&&(r.n=o),e[g]++,"F"!==a&&(e._i[a]=o)),e},getEntry:v,setStrong:function(e,t,n){h(e,t,function(e,t){this._t=e,this._k=t,this._l=i},function(){for(var e=this,t=e._k,n=e._l;n&&n.r;)n=n.p;return e._t&&(e._l=n=n?n.n:e._t._f)?"keys"==t?d(0,n.k):"values"==t?d(0,n.v):d(0,[n.k,n.v]):(e._t=i,d(1))},n?"entries":"values",!n,!0),f(t)}}},function(e,t,n){var r=n(2),a=n(6),o=n(16),s=n(202),l=n(20),c=n(198),u=n(197),h=n(11),d=n(5),f=n(157),p=n(22),m=n(80);e.exports=function(e,t,n,g,v,y){var E=r[e],x=E,b=v?"set":"add",C=x&&x.prototype,M={},_=function(e){var t=C[e];o(C,e,"delete"==e?function(e){return!(y&&!h(e))&&t.call(this,0===e?0:e)}:"has"==e?function(e){return!(y&&!h(e))&&t.call(this,0===e?0:e)}:"get"==e?function(e){return y&&!h(e)?i:t.call(this,0===e?0:e)}:"add"==e?function(e){return t.call(this,0===e?0:e),this}:function(e,i){return t.call(this,0===e?0:e,i),this})};if("function"==typeof x&&(y||C.forEach&&!d(function(){(new x).entries().next()}))){var w=new x,L=w[b](y?{}:-0,1)!=w,T=d(function(){w.has(1)}),I=f(function(e){new x(e)}),S=!y&&d(function(){for(var e=new x,t=5;t--;)e[b](t,t);return!e.has(-0)});I||(x=t(function(t,n){u(t,x,e);var r=m(new E,t,x);return n!=i&&c(n,v,r[b],r),r}),x.prototype=C,C.constructor=x),(T||S)&&(_("delete"),_("has"),v&&_("get")),(S||L)&&_(b),y&&C.clear&&delete C.clear}else x=g.getConstructor(t,e,v,b),s(x.prototype,n),l.NEED=!0;return p(x,e),M[e]=x,a(a.G+a.W+a.F*(x!=E),M),y||g.setStrong(x,e,v),x}},function(e,t,n){var r=n(204);e.exports=n(205)("Set",function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},{add:function(e){return r.def(this,e=0===e?0:e,e)}},r)},function(e,t,n){var r,a=n(164)(0),o=n(16),s=n(20),l=n(67),c=n(208),u=n(11),h=s.getWeak,d=Object.isExtensible,f=c.ufstore,p={},m=function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},g={get:function(e){if(u(e)){var t=h(e);return!0===t?f(this).get(e):t?t[this._i]:i}},set:function(e,t){return c.def(this,e,t)}},v=e.exports=n(205)("WeakMap",m,g,c,!0,!0);7!=(new v).set((Object.freeze||Object)(p),7).get(p)&&(r=c.getConstructor(m),l(r.prototype,g),s.NEED=!0,a(["delete","has","get","set"],function(e){var t=v.prototype,i=t[e];o(t,e,function(t,n){if(u(t)&&!d(t)){this._f||(this._f=new r);var a=this._f[e](t,n);return"set"==e?this:a}return i.call(this,t,n)})}))},function(e,t,n){var r=n(202),a=n(20).getWeak,o=n(10),s=n(11),l=n(197),c=n(198),u=n(164),h=n(3),d=u(5),f=u(6),p=0,m=function(e){return e._l||(e._l=new g)},g=function(){this.a=[]},v=function(e,t){return d(e.a,function(e){return e[0]===t})};g.prototype={get:function(e){var t=v(this,e);if(t)return t[1]},has:function(e){return!!v(this,e)},set:function(e,t){var i=v(this,e);i?i[1]=t:this.a.push([e,t])},delete:function(e){var t=f(this.a,function(t){return t[0]===e});return~t&&this.a.splice(t,1),!!~t}},e.exports={getConstructor:function(e,t,n,o){var u=e(function(e,r){l(e,u,t,"_i"),e._i=p++,e._l=i,r!=i&&c(r,n,e[o],e)});return r(u.prototype,{delete:function(e){if(!s(e))return!1;var t=a(e);return!0===t?m(this).delete(e):t&&h(t,this._i)&&delete t[this._i]},has:function(e){if(!s(e))return!1;var t=a(e);return!0===t?m(this).has(e):t&&h(t,this._i)}}),u},def:function(e,t,i){var n=a(o(t),!0);return!0===n?m(e).set(t,i):n[e._i]=i,e},ufstore:m}},function(e,t,n){var r=n(208);n(205)("WeakSet",function(e){return function(){return e(this,arguments.length>0?arguments[0]:i)}},{add:function(e){return r.def(this,e,!0)}},r,!1,!0)},function(e,t,i){var n=i(6),r=i(19),a=i(10),o=(i(2).Reflect||{}).apply,s=Function.apply;n(n.S+n.F*!i(5)(function(){o(function(){})}),"Reflect",{apply:function(e,t,i){var n=r(e),l=a(i);return o?o(n,t,l):s.call(n,t,l)}})},function(e,t,i){var n=i(6),r=i(44),a=i(19),o=i(10),s=i(11),l=i(5),c=i(75),u=(i(2).Reflect||{}).construct,h=l(function(){function e(){}return!(u(function(){},[],e)instanceof e)}),d=!l(function(){u(function(){})});n(n.S+n.F*(h||d),"Reflect",{construct:function(e,t){a(e),o(t);var i=arguments.length<3?e:a(arguments[2]);if(d&&!h)return u(e,t,i);if(e==i){switch(t.length){case 0:return new e;case 1:return new e(t[0]);case 2:return new e(t[0],t[1]);case 3:return new e(t[0],t[1],t[2]);case 4:return new e(t[0],t[1],t[2],t[3])}var n=[null];return n.push.apply(n,t),new(c.apply(e,n))}var l=i.prototype,f=r(s(l)?l:Object.prototype),p=Function.apply.call(e,f,t);return s(p)?p:f}})},function(e,t,i){var n=i(9),r=i(6),a=i(10),o=i(14);r(r.S+r.F*i(5)(function(){Reflect.defineProperty(n.f({},1,{value:1}),1,{value:2})}),"Reflect",{defineProperty:function(e,t,i){a(e),t=o(t,!0),a(i);try{return n.f(e,t,i),!0}catch(e){return!1}}})},function(e,t,i){var n=i(6),r=i(49).f,a=i(10);n(n.S,"Reflect",{deleteProperty:function(e,t){var i=r(a(e),t);return!(i&&!i.configurable)&&delete e[t]}})},function(e,t,n){var r=n(6),a=n(10),o=function(e){this._t=a(e),this._i=0;var t,i=this._k=[];for(t in e)i.push(t)};n(136)(o,"Object",function(){var e,t=this,n=t._k;do{if(t._i>=n.length)return{value:i,done:!0}}while(!((e=n[t._i++])in t._t));return{value:e,done:!1}}),r(r.S,"Reflect",{enumerate:function(e){return new o(e)}})},function(e,t,n){function r(e,t){var n,l,h=arguments.length<3?e:arguments[2];return u(e)===h?e[t]:(n=a.f(e,t))?s(n,"value")?n.value:n.get!==i?n.get.call(h):i:c(l=o(e))?r(l,t,h):void 0}var a=n(49),o=n(57),s=n(3),l=n(6),c=n(11),u=n(10);l(l.S,"Reflect",{get:r})},function(e,t,i){var n=i(49),r=i(6),a=i(10);r(r.S,"Reflect",{getOwnPropertyDescriptor:function(e,t){return n.f(a(e),t)}})},function(e,t,i){var n=i(6),r=i(57),a=i(10);n(n.S,"Reflect",{getPrototypeOf:function(e){return r(a(e))}})},function(e,t,i){var n=i(6);n(n.S,"Reflect",{has:function(e,t){return t in e}})},function(e,t,i){var n=i(6),r=i(10),a=Object.isExtensible;n(n.S,"Reflect",{isExtensible:function(e){return r(e),!a||a(e)}})},function(e,t,i){var n=i(6);n(n.S,"Reflect",{ownKeys:i(221)})},function(e,t,i){var n=i(48),r=i(41),a=i(10),o=i(2).Reflect;e.exports=o&&o.ownKeys||function(e){var t=n.f(a(e)),i=r.f;return i?t.concat(i(e)):t}},function(e,t,i){var n=i(6),r=i(10),a=Object.preventExtensions;n(n.S,"Reflect",{preventExtensions:function(e){r(e);try{return a&&a(e),!0}catch(e){return!1}}})},function(e,t,n){function r(e,t,n){var c,f,p=arguments.length<4?e:arguments[3],m=o.f(h(e),t);if(!m){if(d(f=s(e)))return r(f,t,n,p);m=u(0)}return l(m,"value")?!(!1===m.writable||!d(p)||(c=o.f(p,t)||u(0),c.value=n,a.f(p,t,c),0)):m.set!==i&&(m.set.call(p,n),!0)}var a=n(9),o=n(49),s=n(57),l=n(3),c=n(6),u=n(15),h=n(10),d=n(11);c(c.S,"Reflect",{set:r})},function(e,t,i){var n=i(6),r=i(71);r&&n(n.S,"Reflect",{setPrototypeOf:function(e,t){r.check(e,t);try{return r.set(e,t),!0}catch(e){return!1}}})},function(e,t,i){var n=i(6);n(n.S,"Date",{now:function(){return(new Date).getTime()}})},function(e,t,i){var n=i(6),r=i(56),a=i(14);n(n.P+n.F*i(5)(function(){return null!==new Date(NaN).toJSON()||1!==Date.prototype.toJSON.call({toISOString:function(){return 1}})}),"Date",{toJSON:function(e){var t=r(this),i=a(t);return"number"!=typeof i||isFinite(i)?t.toISOString():null}})},function(e,t,i){var n=i(6),r=i(5),a=Date.prototype.getTime,o=function(e){return e>9?e:"0"+e};n(n.P+n.F*(r(function(){return"0385-07-25T07:06:39.999Z"!=new Date(-5e13-1).toISOString()})||!r(function(){new Date(NaN).toISOString()})),"Date",{toISOString:function(){if(!isFinite(a.call(this)))throw RangeError("Invalid time value");var e=this,t=e.getUTCFullYear(),i=e.getUTCMilliseconds(),n=t<0?"-":t>9999?"+":"";return n+("00000"+Math.abs(t)).slice(n?-6:-4)+"-"+o(e.getUTCMonth()+1)+"-"+o(e.getUTCDate())+"T"+o(e.getUTCHours())+":"+o(e.getUTCMinutes())+":"+o(e.getUTCSeconds())+"."+(i>99?i:"0"+o(i))+"Z"}})},function(e,t,i){var n=Date.prototype,r="Invalid Date",a="toString",o=n[a],s=n.getTime;new Date(NaN)+""!=r&&i(16)(n,a,function(){var e=s.call(this);return e===e?o.call(this):r})},function(e,t,i){var n=i(23)("toPrimitive"),r=Date.prototype;n in r||i(8)(r,n,i(230))},function(e,t,i){var n=i(10),r=i(14),a="number";e.exports=function(e){if("string"!==e&&e!==a&&"default"!==e)throw TypeError("Incorrect hint");return r(n(this),e!=a)}},function(e,t,n){var r=n(6),a=n(232),o=n(233),s=n(10),l=n(37),c=n(35),u=n(11),h=n(2).ArrayBuffer,d=n(199),f=o.ArrayBuffer,p=o.DataView,m=a.ABV&&h.isView,g=f.prototype.slice,v=a.VIEW,y="ArrayBuffer";r(r.G+r.W+r.F*(h!==f),{ArrayBuffer:f}),r(r.S+r.F*!a.CONSTR,y,{isView:function(e){return m&&m(e)||u(e)&&v in e}}),r(r.P+r.U+r.F*n(5)(function(){return!new f(2).slice(1,i).byteLength}),y,{slice:function(e,t){if(g!==i&&t===i)return g.call(s(this),e);for(var n=s(this).byteLength,r=l(e,n),a=l(t===i?n:t,n),o=new(d(this,f))(c(a-r)),u=new p(this),h=new p(o),m=0;r<a;)h.setUint8(m++,u.getUint8(r++));return o}}),n(186)(y)},function(e,t,i){for(var n,r=i(2),a=i(8),o=i(17),s=o("typed_array"),l=o("view"),c=!(!r.ArrayBuffer||!r.DataView),u=c,h=0,d="Int8Array,Uint8Array,Uint8ClampedArray,Int16Array,Uint16Array,Int32Array,Uint32Array,Float32Array,Float64Array".split(",");h<9;)(n=r[d[h++]])?(a(n.prototype,s,!0),a(n.prototype,l,!0)):u=!1;e.exports={ABV:c,CONSTR:u,TYPED:s,VIEW:l}},function(e,t,n){var r=n(2),a=n(4),o=n(26),s=n(232),l=n(8),c=n(202),u=n(5),h=n(197),d=n(36),f=n(35),p=n(48).f,m=n(9).f,g=n(180),v=n(22),y="ArrayBuffer",E="DataView",x="prototype",b="Wrong length!",C="Wrong index!",M=r[y],_=r[E],w=r.Math,L=r.RangeError,T=r.Infinity,I=M,S=w.abs,O=w.pow,D=w.floor,R=w.log,A=w.LN2,U="buffer",B="byteLength",P="byteOffset",N=a?"_b":U,k=a?"_l":B,F=a?"_o":P,H=function(e,t,i){var n,r,a,o=Array(i),s=8*i-t-1,l=(1<<s)-1,c=l>>1,u=23===t?O(2,-24)-O(2,-77):0,h=0,d=e<0||0===e&&1/e<0?1:0;for(e=S(e),e!=e||e===T?(r=e!=e?1:0,n=l):(n=D(R(e)/A),e*(a=O(2,-n))<1&&(n--,a*=2),e+=n+c>=1?u/a:u*O(2,1-c),e*a>=2&&(n++,a/=2),n+c>=l?(r=0,n=l):n+c>=1?(r=(e*a-1)*O(2,t),n+=c):(r=e*O(2,c-1)*O(2,t),n=0));t>=8;o[h++]=255&r,r/=256,t-=8);for(n=n<<t|r,s+=t;s>0;o[h++]=255&n,n/=256,s-=8);return o[--h]|=128*d,o},G=function(e,t,i){var n,r=8*i-t-1,a=(1<<r)-1,o=a>>1,s=r-7,l=i-1,c=e[l--],u=127&c;for(c>>=7;s>0;u=256*u+e[l],l--,s-=8);for(n=u&(1<<-s)-1,u>>=-s,s+=t;s>0;n=256*n+e[l],l--,s-=8);if(0===u)u=1-o;else{if(u===a)return n?NaN:c?-T:T;n+=O(2,t),u-=o}return(c?-1:1)*n*O(2,u-t)},V=function(e){return e[3]<<24|e[2]<<16|e[1]<<8|e[0]},z=function(e){return[255&e]},W=function(e){return[255&e,e>>8&255]},q=function(e){return[255&e,e>>8&255,e>>16&255,e>>24&255]},j=function(e){return H(e,52,8)},X=function(e){return H(e,23,4)},Y=function(e,t,i){m(e[x],t,{get:function(){return this[i]}})},Z=function(e,t,i,n){var r=+i,a=d(r);if(r!=a||a<0||a+t>e[k])throw L(C);var o=e[N]._b,s=a+e[F],l=o.slice(s,s+t);return n?l:l.reverse()},K=function(e,t,i,n,r,a){var o=+i,s=d(o);if(o!=s||s<0||s+t>e[k])throw L(C);for(var l=e[N]._b,c=s+e[F],u=n(+r),h=0;h<t;h++)l[c+h]=u[a?h:t-h-1]},Q=function(e,t){h(e,M,y);var i=+t,n=f(i);if(i!=n)throw L(b);return n};if(s.ABV){if(!u(function(){new M})||!u(function(){new M(.5)})){M=function(e){return new I(Q(this,e))};for(var J,$=M[x]=I[x],ee=p(I),te=0;ee.length>te;)(J=ee[te++])in M||l(M,J,I[J]);o||($.constructor=M)}var ie=new _(new M(2)),ne=_[x].setInt8;ie.setInt8(0,2147483648),ie.setInt8(1,2147483649),
!ie.getInt8(0)&&ie.getInt8(1)||c(_[x],{setInt8:function(e,t){ne.call(this,e,t<<24>>24)},setUint8:function(e,t){ne.call(this,e,t<<24>>24)}},!0)}else M=function(e){var t=Q(this,e);this._b=g.call(Array(t),0),this[k]=t},_=function(e,t,n){h(this,_,E),h(e,M,E);var r=e[k],a=d(t);if(a<0||a>r)throw L("Wrong offset!");if(n=n===i?r-a:f(n),a+n>r)throw L(b);this[N]=e,this[F]=a,this[k]=n},a&&(Y(M,B,"_l"),Y(_,U,"_b"),Y(_,B,"_l"),Y(_,P,"_o")),c(_[x],{getInt8:function(e){return Z(this,1,e)[0]<<24>>24},getUint8:function(e){return Z(this,1,e)[0]},getInt16:function(e){var t=Z(this,2,e,arguments[1]);return(t[1]<<8|t[0])<<16>>16},getUint16:function(e){var t=Z(this,2,e,arguments[1]);return t[1]<<8|t[0]},getInt32:function(e){return V(Z(this,4,e,arguments[1]))},getUint32:function(e){return V(Z(this,4,e,arguments[1]))>>>0},getFloat32:function(e){return G(Z(this,4,e,arguments[1]),23,4)},getFloat64:function(e){return G(Z(this,8,e,arguments[1]),52,8)},setInt8:function(e,t){K(this,1,e,z,t)},setUint8:function(e,t){K(this,1,e,z,t)},setInt16:function(e,t){K(this,2,e,W,t,arguments[2])},setUint16:function(e,t){K(this,2,e,W,t,arguments[2])},setInt32:function(e,t){K(this,4,e,q,t,arguments[2])},setUint32:function(e,t){K(this,4,e,q,t,arguments[2])},setFloat32:function(e,t){K(this,4,e,X,t,arguments[2])},setFloat64:function(e,t){K(this,8,e,j,t,arguments[2])}});v(M,y),v(_,E),l(_[x],s.VIEW,!0),t[y]=M,t[E]=_},function(e,t,i){var n=i(6);n(n.G+n.W+n.F*!i(232).ABV,{DataView:i(233).DataView})},function(e,t,i){i(236)("Int8",1,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,n){if(n(4)){var r=n(26),a=n(2),o=n(5),s=n(6),l=n(232),c=n(233),u=n(18),h=n(197),d=n(15),f=n(8),p=n(202),m=n(36),g=n(35),v=n(37),y=n(14),E=n(3),x=n(69),b=n(73),C=n(11),M=n(56),_=n(154),w=n(44),L=n(57),T=n(48).f,I=n(156),S=n(17),O=n(23),D=n(164),R=n(34),A=n(199),U=n(183),B=n(135),P=n(157),N=n(186),k=n(180),F=n(177),H=n(9),G=n(49),V=H.f,z=G.f,W=a.RangeError,q=a.TypeError,j=a.Uint8Array,X="ArrayBuffer",Y="Shared"+X,Z="BYTES_PER_ELEMENT",K="prototype",Q=Array[K],J=c.ArrayBuffer,$=c.DataView,ee=D(0),te=D(2),ie=D(3),ne=D(4),re=D(5),ae=D(6),oe=R(!0),se=R(!1),le=U.values,ce=U.keys,ue=U.entries,he=Q.lastIndexOf,de=Q.reduce,fe=Q.reduceRight,pe=Q.join,me=Q.sort,ge=Q.slice,ve=Q.toString,ye=Q.toLocaleString,Ee=O("iterator"),xe=O("toStringTag"),be=S("typed_constructor"),Ce=S("def_constructor"),Me=l.CONSTR,_e=l.TYPED,we=l.VIEW,Le="Wrong length!",Te=D(1,function(e,t){return Ae(A(e,e[Ce]),t)}),Ie=o(function(){return 1===new j(new Uint16Array([1]).buffer)[0]}),Se=!!j&&!!j[K].set&&o(function(){new j(1).set({})}),Oe=function(e,t){if(e===i)throw q(Le);var n=+e,r=g(e);if(t&&!x(n,r))throw W(Le);return r},De=function(e,t){var i=m(e);if(i<0||i%t)throw W("Wrong offset!");return i},Re=function(e){if(C(e)&&_e in e)return e;throw q(e+" is not a typed array!")},Ae=function(e,t){if(!(C(e)&&be in e))throw q("It is not a typed array constructor!");return new e(t)},Ue=function(e,t){return Be(A(e,e[Ce]),t)},Be=function(e,t){for(var i=0,n=t.length,r=Ae(e,n);n>i;)r[i]=t[i++];return r},Pe=function(e,t,i){V(e,t,{get:function(){return this._d[i]}})},Ne=function(e){var t,n,r,a,o,s,l=M(e),c=arguments.length,h=c>1?arguments[1]:i,d=h!==i,f=I(l);if(f!=i&&!_(f)){for(s=f.call(l),r=[],t=0;!(o=s.next()).done;t++)r.push(o.value);l=r}for(d&&c>2&&(h=u(h,arguments[2],2)),t=0,n=g(l.length),a=Ae(this,n);n>t;t++)a[t]=d?h(l[t],t):l[t];return a},ke=function(){for(var e=0,t=arguments.length,i=Ae(this,t);t>e;)i[e]=arguments[e++];return i},Fe=!!j&&o(function(){ye.call(new j(1))}),He=function(){return ye.apply(Fe?ge.call(Re(this)):Re(this),arguments)},Ge={copyWithin:function(e,t){return F.call(Re(this),e,t,arguments.length>2?arguments[2]:i)},every:function(e){return ne(Re(this),e,arguments.length>1?arguments[1]:i)},fill:function(e){return k.apply(Re(this),arguments)},filter:function(e){return Ue(this,te(Re(this),e,arguments.length>1?arguments[1]:i))},find:function(e){return re(Re(this),e,arguments.length>1?arguments[1]:i)},findIndex:function(e){return ae(Re(this),e,arguments.length>1?arguments[1]:i)},forEach:function(e){ee(Re(this),e,arguments.length>1?arguments[1]:i)},indexOf:function(e){return se(Re(this),e,arguments.length>1?arguments[1]:i)},includes:function(e){return oe(Re(this),e,arguments.length>1?arguments[1]:i)},join:function(e){return pe.apply(Re(this),arguments)},lastIndexOf:function(e){return he.apply(Re(this),arguments)},map:function(e){return Te(Re(this),e,arguments.length>1?arguments[1]:i)},reduce:function(e){return de.apply(Re(this),arguments)},reduceRight:function(e){return fe.apply(Re(this),arguments)},reverse:function(){for(var e,t=this,i=Re(t).length,n=Math.floor(i/2),r=0;r<n;)e=t[r],t[r++]=t[--i],t[i]=e;return t},some:function(e){return ie(Re(this),e,arguments.length>1?arguments[1]:i)},sort:function(e){return me.call(Re(this),e)},subarray:function(e,t){var n=Re(this),r=n.length,a=v(e,r);return new(A(n,n[Ce]))(n.buffer,n.byteOffset+a*n.BYTES_PER_ELEMENT,g((t===i?r:v(t,r))-a))}},Ve=function(e,t){return Ue(this,ge.call(Re(this),e,t))},ze=function(e){Re(this);var t=De(arguments[1],1),i=this.length,n=M(e),r=g(n.length),a=0;if(r+t>i)throw W(Le);for(;a<r;)this[t+a]=n[a++]},We={entries:function(){return ue.call(Re(this))},keys:function(){return ce.call(Re(this))},values:function(){return le.call(Re(this))}},qe=function(e,t){return C(e)&&e[_e]&&"symbol"!=(void 0===t?"undefined":_typeof(t))&&t in e&&String(+t)==String(t)},je=function(e,t){return qe(e,t=y(t,!0))?d(2,e[t]):z(e,t)},Xe=function(e,t,i){return!(qe(e,t=y(t,!0))&&C(i)&&E(i,"value"))||E(i,"get")||E(i,"set")||i.configurable||E(i,"writable")&&!i.writable||E(i,"enumerable")&&!i.enumerable?V(e,t,i):(e[t]=i.value,e)};Me||(G.f=je,H.f=Xe),s(s.S+s.F*!Me,"Object",{getOwnPropertyDescriptor:je,defineProperty:Xe}),o(function(){ve.call({})})&&(ve=ye=function(){return pe.call(this)});var Ye=p({},Ge);p(Ye,We),f(Ye,Ee,We.values),p(Ye,{slice:Ve,set:ze,constructor:function(){},toString:ve,toLocaleString:He}),Pe(Ye,"buffer","b"),Pe(Ye,"byteOffset","o"),Pe(Ye,"byteLength","l"),Pe(Ye,"length","e"),V(Ye,xe,{get:function(){return this[_e]}}),e.exports=function(e,t,n,c){c=!!c;var u=e+(c?"Clamped":"")+"Array",d="Uint8Array"!=u,p="get"+e,m="set"+e,v=a[u],y=v||{},E=v&&L(v),x=!v||!l.ABV,M={},_=v&&v[K],I=function(e,i){var n=e._d;return n.v[p](i*t+n.o,Ie)},S=function(e,i,n){var r=e._d;c&&(n=(n=Math.round(n))<0?0:n>255?255:255&n),r.v[m](i*t+r.o,n,Ie)},O=function(e,t){V(e,t,{get:function(){return I(this,t)},set:function(e){return S(this,t,e)},enumerable:!0})};x?(v=n(function(e,n,r,a){h(e,v,u,"_d");var o,s,l,c,d=0,p=0;if(C(n)){if(!(n instanceof J||(c=b(n))==X||c==Y))return _e in n?Be(v,n):Ne.call(v,n);o=n,p=De(r,t);var m=n.byteLength;if(a===i){if(m%t)throw W(Le);if((s=m-p)<0)throw W(Le)}else if((s=g(a)*t)+p>m)throw W(Le);l=s/t}else l=Oe(n,!0),s=l*t,o=new J(s);for(f(e,"_d",{b:o,o:p,l:s,e:l,v:new $(o)});d<l;)O(e,d++)}),_=v[K]=w(Ye),f(_,"constructor",v)):P(function(e){new v(null),new v(e)},!0)||(v=n(function(e,n,r,a){h(e,v,u);var o;return C(n)?n instanceof J||(o=b(n))==X||o==Y?a!==i?new y(n,De(r,t),a):r!==i?new y(n,De(r,t)):new y(n):_e in n?Be(v,n):Ne.call(v,n):new y(Oe(n,d))}),ee(E!==Function.prototype?T(y).concat(T(E)):T(y),function(e){e in v||f(v,e,y[e])}),v[K]=_,r||(_.constructor=v));var D=_[Ee],R=!!D&&("values"==D.name||D.name==i),A=We.values;f(v,be,!0),f(_,_e,u),f(_,we,!0),f(_,Ce,v),(c?new v(1)[xe]==u:xe in _)||V(_,xe,{get:function(){return u}}),M[u]=v,s(s.G+s.W+s.F*(v!=y),M),s(s.S,u,{BYTES_PER_ELEMENT:t,from:Ne,of:ke}),Z in _||f(_,Z,t),s(s.P,u,Ge),N(u),s(s.P+s.F*Se,u,{set:ze}),s(s.P+s.F*!R,u,We),s(s.P+s.F*(_.toString!=ve),u,{toString:ve}),s(s.P+s.F*o(function(){new v(1).slice()}),u,{slice:Ve}),s(s.P+s.F*(o(function(){return[1,2].toLocaleString()!=new v([1,2]).toLocaleString()})||!o(function(){_.toLocaleString.call([1,2])})),u,{toLocaleString:He}),B[u]=R?D:A,r||R||f(_,Ee,A)}}else e.exports=function(){}},function(e,t,i){i(236)("Uint8",1,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Uint8",1,function(e){return function(t,i,n){return e(this,t,i,n)}},!0)},function(e,t,i){i(236)("Int16",2,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Uint16",2,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Int32",4,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Uint32",4,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Float32",4,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,i){i(236)("Float64",8,function(e){return function(t,i,n){return e(this,t,i,n)}})},function(e,t,n){var r=n(6),a=n(34)(!0);r(r.P,"Array",{includes:function(e){return a(this,e,arguments.length>1?arguments[1]:i)}}),n(178)("includes")},function(e,t,i){var n=i(6),r=i(125)(!0);n(n.P,"String",{at:function(e){return r(this,e)}})},function(e,t,n){var r=n(6),a=n(248);r(r.P,"String",{padStart:function(e){return a(this,e,arguments.length>1?arguments[1]:i,!0)}})},function(e,t,n){var r=n(35),a=n(85),o=n(33);e.exports=function(e,t,n,s){var l=String(o(e)),c=l.length,u=n===i?" ":String(n),h=r(t);if(h<=c||""==u)return l;var d=h-c,f=a.call(u,Math.ceil(d/u.length));return f.length>d&&(f=f.slice(0,d)),s?f+l:l+f}},function(e,t,n){var r=n(6),a=n(248);r(r.P,"String",{padEnd:function(e){return a(this,e,arguments.length>1?arguments[1]:i,!1)}})},function(e,t,i){i(81)("trimLeft",function(e){return function(){return e(this,1)}},"trimStart")},function(e,t,i){i(81)("trimRight",function(e){return function(){return e(this,2)}},"trimEnd")},function(e,t,i){var n=i(6),r=i(33),a=i(35),o=i(128),s=i(188),l=RegExp.prototype,c=function(e,t){this._r=e,this._s=t};i(136)(c,"RegExp String",function(){var e=this._r.exec(this._s);return{value:e,done:null===e}}),n(n.P,"String",{matchAll:function(e){if(r(this),!o(e))throw TypeError(e+" is not a regexp!");var t=String(this),i="flags"in l?String(e.flags):s.call(e),n=new RegExp(e.source,~i.indexOf("g")?i:"g"+i);return n.lastIndex=a(e.lastIndex),new c(n,t)}})},function(e,t,i){i(25)("asyncIterator")},function(e,t,i){i(25)("observable")},function(e,t,i){var n=i(6),r=i(221),a=i(30),o=i(49),s=i(155);n(n.S,"Object",{getOwnPropertyDescriptors:function(e){for(var t,i=a(e),n=o.f,l=r(i),c={},u=0;l.length>u;)s(c,t=l[u++],n(i,t));return c}})},function(e,t,i){var n=i(6),r=i(257)(!1);n(n.S,"Object",{values:function(e){return r(e)}})},function(e,t,i){var n=i(28),r=i(30),a=i(42).f;e.exports=function(e){return function(t){for(var i,o=r(t),s=n(o),l=s.length,c=0,u=[];l>c;)a.call(o,i=s[c++])&&u.push(e?[i,o[i]]:o[i]);return u}}},function(e,t,i){var n=i(6),r=i(257)(!0);n(n.S,"Object",{entries:function(e){return r(e)}})},function(e,t,i){var n=i(6),r=i(56),a=i(19),o=i(9);i(4)&&n(n.P+i(260),"Object",{__defineGetter__:function(e,t){o.f(r(this),e,{get:a(t),enumerable:!0,configurable:!0})}})},function(e,t,i){e.exports=i(26)||!i(5)(function(){var e=Math.random();__defineSetter__.call(null,e,function(){}),delete i(2)[e]})},function(e,t,i){var n=i(6),r=i(56),a=i(19),o=i(9);i(4)&&n(n.P+i(260),"Object",{__defineSetter__:function(e,t){o.f(r(this),e,{set:a(t),enumerable:!0,configurable:!0})}})},function(e,t,i){var n=i(6),r=i(56),a=i(14),o=i(57),s=i(49).f;i(4)&&n(n.P+i(260),"Object",{__lookupGetter__:function(e){var t,i=r(this),n=a(e,!0);do{if(t=s(i,n))return t.get}while(i=o(i))}})},function(e,t,i){var n=i(6),r=i(56),a=i(14),o=i(57),s=i(49).f;i(4)&&n(n.P+i(260),"Object",{__lookupSetter__:function(e){var t,i=r(this),n=a(e,!0);do{if(t=s(i,n))return t.set}while(i=o(i))}})},function(e,t,i){var n=i(6);n(n.P+n.R,"Map",{toJSON:i(265)("Map")})},function(e,t,i){var n=i(73),r=i(266);e.exports=function(e){return function(){if(n(this)!=e)throw TypeError(e+"#toJSON isn't generic");return r(this)}}},function(e,t,i){var n=i(198);e.exports=function(e,t){var i=[];return n(e,!1,i.push,i,t),i}},function(e,t,i){var n=i(6);n(n.P+n.R,"Set",{toJSON:i(265)("Set")})},function(e,t,i){var n=i(6);n(n.S,"System",{global:i(2)})},function(e,t,i){var n=i(6),r=i(32);n(n.S,"Error",{isError:function(e){return"Error"===r(e)}})},function(e,t,i){var n=i(6);n(n.S,"Math",{iaddh:function(e,t,i,n){var r=e>>>0,a=t>>>0,o=i>>>0;return a+(n>>>0)+((r&o|(r|o)&~(r+o>>>0))>>>31)|0}})},function(e,t,i){var n=i(6);n(n.S,"Math",{isubh:function(e,t,i,n){var r=e>>>0,a=t>>>0,o=i>>>0;return a-(n>>>0)-((~r&o|~(r^o)&r-o>>>0)>>>31)|0}})},function(e,t,i){var n=i(6);n(n.S,"Math",{imulh:function(e,t){var i=65535,n=+e,r=+t,a=n&i,o=r&i,s=n>>16,l=r>>16,c=(s*o>>>0)+(a*o>>>16);return s*l+(c>>16)+((a*l>>>0)+(c&i)>>16)}})},function(e,t,i){var n=i(6);n(n.S,"Math",{umulh:function(e,t){var i=65535,n=+e,r=+t,a=n&i,o=r&i,s=n>>>16,l=r>>>16,c=(s*o>>>0)+(a*o>>>16);return s*l+(c>>>16)+((a*l>>>0)+(c&i)>>>16)}})},function(e,t,i){var n=i(275),r=i(10),a=n.key,o=n.set;n.exp({defineMetadata:function(e,t,i,n){o(e,t,r(i),a(n))}})},function(e,t,n){var r=n(203),a=n(6),o=n(21)("metadata"),s=o.store||(o.store=new(n(207))),l=function(e,t,n){var a=s.get(e);if(!a){if(!n)return i;s.set(e,a=new r)}var o=a.get(t);if(!o){if(!n)return i;a.set(t,o=new r)}return o},c=function(e,t,n){var r=l(t,n,!1);return r!==i&&r.has(e)},u=function(e,t,n){var r=l(t,n,!1);return r===i?i:r.get(e)},h=function(e,t,i,n){l(i,n,!0).set(e,t)},d=function(e,t){var i=l(e,t,!1),n=[];return i&&i.forEach(function(e,t){n.push(t)}),n},f=function(e){return e===i||"symbol"==(void 0===e?"undefined":_typeof(e))?e:String(e)},p=function(e){a(a.S,"Reflect",e)};e.exports={store:s,map:l,has:c,get:u,set:h,keys:d,key:f,exp:p}},function(e,t,n){var r=n(275),a=n(10),o=r.key,s=r.map,l=r.store;r.exp({deleteMetadata:function(e,t){var n=arguments.length<3?i:o(arguments[2]),r=s(a(t),n,!1);if(r===i||!r.delete(e))return!1;if(r.size)return!0;var c=l.get(t);return c.delete(n),!!c.size||l.delete(t)}})},function(e,t,n){var r=n(275),a=n(10),o=n(57),s=r.has,l=r.get,c=r.key,u=function e(t,n,r){if(s(t,n,r))return l(t,n,r);var a=o(n);return null!==a?e(t,a,r):i};r.exp({getMetadata:function(e,t){return u(e,a(t),arguments.length<3?i:c(arguments[2]))}})},function(e,t,n){var r=n(206),a=n(266),o=n(275),s=n(10),l=n(57),c=o.keys,u=o.key,h=function e(t,i){var n=c(t,i),o=l(t);if(null===o)return n;var s=e(o,i);return s.length?n.length?a(new r(n.concat(s))):s:n};o.exp({getMetadataKeys:function(e){return h(s(e),arguments.length<2?i:u(arguments[1]))}})},function(e,t,n){var r=n(275),a=n(10),o=r.get,s=r.key;r.exp({getOwnMetadata:function(e,t){return o(e,a(t),arguments.length<3?i:s(arguments[2]))}})},function(e,t,n){var r=n(275),a=n(10),o=r.keys,s=r.key;r.exp({getOwnMetadataKeys:function(e){return o(a(e),arguments.length<2?i:s(arguments[1]))}})},function(e,t,n){var r=n(275),a=n(10),o=n(57),s=r.has,l=r.key,c=function e(t,i,n){if(s(t,i,n))return!0;var r=o(i);return null!==r&&e(t,r,n)};r.exp({hasMetadata:function(e,t){return c(e,a(t),arguments.length<3?i:l(arguments[2]))}})},function(e,t,n){var r=n(275),a=n(10),o=r.has,s=r.key;r.exp({hasOwnMetadata:function(e,t){return o(e,a(t),arguments.length<3?i:s(arguments[2]))}})},function(e,t,n){var r=n(275),a=n(10),o=n(19),s=r.key,l=r.set;r.exp({metadata:function(e,t){return function(n,r){l(e,t,(r!==i?a:o)(n),s(r))}}})},function(e,t,i){var n=i(6),r=i(201)(),a=i(2).process,o="process"==i(32)(a);n(n.G,{asap:function(e){var t=o&&a.domain;r(t?t.bind(e):e)}})},function(e,t,n){var r=n(6),a=n(2),o=n(7),s=n(201)(),l=n(23)("observable"),c=n(19),u=n(10),h=n(197),d=n(202),f=n(8),p=n(198),m=p.RETURN,g=function(e){return null==e?i:c(e)},v=function(e){var t=e._c;t&&(e._c=i,t())},y=function(e){return e._o===i},E=function(e){y(e)||(e._o=i,v(e))},x=function(e,t){u(e),this._c=i,this._o=e,e=new b(this);try{var n=t(e),r=n;null!=n&&("function"==typeof n.unsubscribe?n=function(){r.unsubscribe()}:c(n),this._c=n)}catch(t){return void e.error(t)}y(this)&&v(this)};x.prototype=d({},{unsubscribe:function(){E(this)}});var b=function(e){this._s=e};b.prototype=d({},{next:function(e){var t=this._s;if(!y(t)){var i=t._o;try{var n=g(i.next);if(n)return n.call(i,e)}catch(e){try{E(t)}finally{throw e}}}},error:function(e){var t=this._s;if(y(t))throw e;var n=t._o;t._o=i;try{var r=g(n.error);if(!r)throw e;e=r.call(n,e)}catch(e){try{v(t)}finally{throw e}}return v(t),e},complete:function(e){var t=this._s;if(!y(t)){var n=t._o;t._o=i;try{var r=g(n.complete);e=r?r.call(n,e):i}catch(e){try{v(t)}finally{throw e}}return v(t),e}}});var C=function(e){h(this,C,"Observable","_f")._f=c(e)};d(C.prototype,{subscribe:function(e){return new x(e,this._f)},forEach:function(e){var t=this;return new(o.Promise||a.Promise)(function(i,n){c(e);var r=t.subscribe({next:function(t){try{return e(t)}catch(e){n(e),r.unsubscribe()}},error:n,complete:i})})}}),d(C,{from:function(e){var t="function"==typeof this?this:C,i=g(u(e)[l]);if(i){var n=u(i.call(e));return n.constructor===t?n:new t(function(e){return n.subscribe(e)})}return new t(function(t){var i=!1;return s(function(){if(!i){try{if(p(e,!1,function(e){if(t.next(e),i)return m})===m)return}catch(e){if(i)throw e;return void t.error(e)}t.complete()}}),function(){i=!0}})},of:function(){for(var e=0,t=arguments.length,i=Array(t);e<t;)i[e]=arguments[e++];return new("function"==typeof this?this:C)(function(e){var t=!1;return s(function(){if(!t){for(var n=0;n<i.length;++n)if(e.next(i[n]),t)return;e.complete()}}),function(){t=!0}})}}),f(C.prototype,l,function(){return this}),r(r.G,{Observable:C}),n(186)("Observable")},function(e,t,i){var n=i(6),r=i(200);n(n.G+n.B,{setImmediate:r.set,clearImmediate:r.clear})},function(e,t,i){for(var n=i(183),r=i(16),a=i(2),o=i(8),s=i(135),l=i(23),c=l("iterator"),u=l("toStringTag"),h=s.Array,d=["NodeList","DOMTokenList","MediaList","StyleSheetList","CSSRuleList"],f=0;f<5;f++){var p,m=d[f],g=a[m],v=g&&g.prototype;if(v){v[c]||o(v,c,h),v[u]||o(v,u,m),s[m]=h;for(p in n)v[p]||r(v,p,n[p],!0)}}},function(e,t,i){var n=i(2),r=i(6),a=i(76),o=i(289),s=n.navigator,l=!!s&&/MSIE .\./.test(s.userAgent),c=function(e){return l?function(t,i){return e(a(o,[].slice.call(arguments,2),"function"==typeof t?t:Function(t)),i)}:e};r(r.G+r.B+r.F*l,{setTimeout:c(n.setTimeout),setInterval:c(n.setInterval)})},function(e,t,i){var n=i(290),r=i(76),a=i(19);e.exports=function(){for(var e=a(this),t=arguments.length,i=Array(t),o=0,s=n._,l=!1;t>o;)(i[o]=arguments[o++])===s&&(l=!0);return function(){var n,a=this,o=arguments.length,c=0,u=0;if(!l&&!o)return r(e,i,a);if(n=i.slice(),l)for(;t>c;c++)n[c]===s&&(n[c]=arguments[u++]);for(;o>u;)n.push(arguments[u++]);return r(e,n,a)}}},function(e,t,i){e.exports=i(2)},function(e,t,n){function r(e){var t=p(null);return e!=i&&(b(e)?x(e,!0,function(e,i){t[e]=i}):f(t,e)),t}function a(e,t,i){E(t);var n,r,a=w(e),o=g(a),s=o.length,l=0;if(arguments.length<3){if(!s)throw TypeError("Reduce of empty object with no initial value");n=a[o[l++]]}else n=Object(i);for(;s>l;)T(a,r=o[l++])&&(n=t(n,a[r],r,e));return n}function o(e,t){return(t==t?y(e,t):S(e,function(e){return e!=e}))!==i}function s(e,t){if(T(e,t))return e[t]}function l(e,t,i){return L&&t in Object?v.f(e,t,d(0,i)):e[t]=i,e}function c(e){return _(e)&&m(e)===r.prototype}var u=n(18),h=n(6),d=n(15),f=n(67),p=n(44),m=n(57),g=n(28),v=n(9),y=n(27),E=n(19),x=n(198),b=n(292),C=n(136),M=n(184),_=n(11),w=n(30),L=n(4),T=n(3),I=function(e){var t=1==e,n=4==e;return function(a,o,s){var l,c,h,d=u(o,s,3),f=w(a),p=t||7==e||2==e?new("function"==typeof this?this:r):i;for(l in f)if(T(f,l)&&(c=f[l],h=d(c,l,a),e))if(t)p[l]=h;else if(h)switch(e){case 2:p[l]=c;break;case 3:return!0;case 5:return c;case 6:return l;case 7:p[h[0]]=h[1]}else if(n)return!1;return 3==e||n?n:p}},S=I(6),O=function(e){return function(t){return new D(t,e)}},D=function(e,t){this._t=w(e),this._a=g(e),this._i=0,this._k=t};C(D,"Dict",function(){var e,t=this,n=t._t,r=t._a,a=t._k;do{if(t._i>=r.length)return t._t=i,M(1)}while(!T(n,e=r[t._i++]));return"keys"==a?M(0,e):"values"==a?M(0,n[e]):M(0,[e,n[e]])}),r.prototype=null,h(h.G+h.F,{Dict:r}),h(h.S,"Dict",{keys:O("keys"),values:O("values"),entries:O("entries"),forEach:I(0),map:I(1),filter:I(2),some:I(3),every:I(4),find:I(5),findKey:S,mapPairs:I(7),reduce:a,keyOf:y,includes:o,has:T,get:s,set:l,isDict:c})},function(e,t,n){var r=n(73),a=n(23)("iterator"),o=n(135);e.exports=n(7).isIterable=function(e){var t=Object(e);return t[a]!==i||"@@iterator"in t||o.hasOwnProperty(r(t))}},function(e,t,i){var n=i(10),r=i(156);e.exports=i(7).getIterator=function(e){var t=r(e);if("function"!=typeof t)throw TypeError(e+" is not iterable!");return n(t.call(e))}},function(e,t,i){var n=i(2),r=i(7),a=i(6),o=i(289);a(a.G+a.F,{delay:function(e){return new(r.Promise||n.Promise)(function(t){setTimeout(o.call(t,!0),e)})}})},function(e,t,i){var n=i(290),r=i(6);i(7)._=n._=n._||{},r(r.P+r.F,"Function",{part:i(289)})},function(e,t,i){var n=i(6);n(n.S+n.F,"Object",{isObject:i(11)})},function(e,t,i){var n=i(6);n(n.S+n.F,"Object",{classof:i(73)})},function(e,t,i){var n=i(6),r=i(299);n(n.S+n.F,"Object",{define:r})},function(e,t,i){var n=i(9),r=i(49),a=i(221),o=i(30);e.exports=function(e,t){for(var i,s=a(o(t)),l=s.length,c=0;l>c;)n.f(e,i=s[c++],r.f(t,i));return e}},function(e,t,i){var n=i(6),r=i(299),a=i(44);n(n.S+n.F,"Object",{make:function(e,t){return r(a(e),t)}})},function(e,t,n){n(134)(Number,"Number",function(e){this._l=+e,this._i=0},function(){var e=this._i++,t=!(e<this._l);return{done:t,value:t?i:e}})},function(e,t,i){var n=i(6),r=i(303)(/[\\^$*+?.()|[\]{}]/g,"\\$&");n(n.S,"RegExp",{escape:function(e){return r(e)}})},function(e,t){e.exports=function(e,t){var i=t===Object(t)?function(e){return t[e]}:t;return function(t){return String(t).replace(e,i)}}},function(e,t,i){var n=i(6),r=i(303)(/[&<>"']/g,{"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&apos;"});n(n.P+n.F,"String",{escapeHTML:function(){return r(this)}})},function(e,t,i){var n=i(6),r=i(303)(/&(?:amp|lt|gt|quot|apos);/g,{"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&apos;":"'"});n(n.P+n.F,"String",{unescapeHTML:function(){return r(this)}})}]),"undefined"!=typeof module&&module.exports?module.exports=e:"function"==typeof define&&define.amd?define(function(){return e}):t.core=e}(1,1);var NEWER=Symbol("newer"),OLDER=Symbol("older");LRUMap.prototype._markEntryAsUsed=function(e){e!==this.newest&&(e[NEWER]&&(e===this.oldest&&(this.oldest=e[NEWER]),e[NEWER][OLDER]=e[OLDER]),e[OLDER]&&(e[OLDER][NEWER]=e[NEWER]),e[NEWER]=void 0,e[OLDER]=this.newest,this.newest&&(this.newest[NEWER]=e),this.newest=e)},LRUMap.prototype.assign=function(e){var t=void 0,i=this.limit||Number.MAX_VALUE;this._keymap.clear();for(var n=e[Symbol.iterator](),r=n.next();!r.done;r=n.next()){var a=new Entry(r.value[0],r.value[1]);if(this._keymap.set(a.key,a),t?(t[NEWER]=a,a[OLDER]=t):this.oldest=a,t=a,0==i--)throw new Error("overflow")}this.newest=t,this.size=this._keymap.size},LRUMap.prototype.get=function(e){var t=this._keymap.get(e);if(t)return this._markEntryAsUsed(t),t.value},LRUMap.prototype.set=function(e,t){var i=this._keymap.get(e);return i?(i.value=t,this._markEntryAsUsed(i),this):(this._keymap.set(e,i=new Entry(e,t)),this.newest?(this.newest[NEWER]=i,i[OLDER]=this.newest):this.oldest=i,this.newest=i,++this.size,this.size>this.limit&&this.shift(),this)},LRUMap.prototype.shift=function(){var e=this.oldest;if(e)return this.oldest[NEWER]?(this.oldest=this.oldest[NEWER],this.oldest[OLDER]=void 0):(this.oldest=void 0,this.newest=void 0),e[NEWER]=e[OLDER]=void 0,this._keymap.delete(e.key),--this.size,[e.key,e.value]},LRUMap.prototype.find=function(e){var t=this._keymap.get(e);return t?t.value:void 0},LRUMap.prototype.has=function(e){return this._keymap.has(e)},LRUMap.prototype.delete=function(e){var t=this._keymap.get(e);if(t)return this._keymap.delete(t.key),t[NEWER]&&t[OLDER]?(t[OLDER][NEWER]=t[NEWER],t[NEWER][OLDER]=t[OLDER]):t[NEWER]?(t[NEWER][OLDER]=void 0,this.oldest=t[NEWER]):t[OLDER]?(t[OLDER][NEWER]=void 0,this.newest=t[OLDER]):this.oldest=this.newest=void 0,this.size--,t.value},LRUMap.prototype.clear=function(){this.oldest=this.newest=void 0,this.size=0,this._keymap.clear()},EntryIterator.prototype[Symbol.iterator]=function(){return this},EntryIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:[e.key,e.value]}):{done:!0,value:void 0}},KeyIterator.prototype[Symbol.iterator]=function(){return this},KeyIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:e.key}):{done:!0,value:void 0}},ValueIterator.prototype[Symbol.iterator]=function(){return this},ValueIterator.prototype.next=function(){var e=this.entry;return e?(this.entry=e[NEWER],{done:!1,value:e.value}):{done:!0,value:void 0}},LRUMap.prototype.keys=function(){return new KeyIterator(this.oldest)},LRUMap.prototype.values=function(){return new ValueIterator(this.oldest)},LRUMap.prototype.entries=function(){return this},LRUMap.prototype[Symbol.iterator]=function(){return new EntryIterator(this.oldest)},LRUMap.prototype.forEach=function(e,t){"object"!==(void 0===t?"undefined":_typeof(t))&&(t=this);for(var i=this.oldest;i;)e.call(t,i.value,i.key,this),i=i[NEWER]},LRUMap.prototype.toJSON=function(){for(var e=new Array(this.size),t=0,i=this.oldest;i;)e[t++]={key:i.key,value:i.value},i=i[NEWER];return e},LRUMap.prototype.toString=function(){for(var e="",t=this.oldest;t;)e+=String(t.key)+":"+t.value,(t=t[NEWER])&&(e+=" < ");return e},function(e,t){"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module?t(exports):"function"==typeof define&&define.amd?define(["exports"],t):t(e.THREE=e.THREE||{})}(window,function(e){function t(){}function i(e,t){this.x=e||0,this.y=t||0}function n(e,t,r,a,o,s,l,c,u,h){Object.defineProperty(this,"id",{value:ds++}),this.uuid=hs.generateUUID(),this.name="",this.image=void 0!==e?e:n.DEFAULT_IMAGE,this.mipmaps=[],this.mapping=void 0!==t?t:n.DEFAULT_MAPPING,this.wrapS=void 0!==r?r:po,this.wrapT=void 0!==a?a:po,this.magFilter=void 0!==o?o:Eo,this.minFilter=void 0!==s?s:bo,this.anisotropy=void 0!==u?u:1,this.format=void 0!==l?l:Po,this.type=void 0!==c?c:Co,this.offset=new i(0,0),this.repeat=new i(1,1),this.rotateMatrix=new te,this.generateMipmaps=!0,this.premultiplyAlpha=!1,this.flipY=!0,this.unpackAlignment=4,this.encoding=void 0!==h?h:is,this.version=0,this.onUpdate=null}function r(e,t,i,n){this.x=e||0,this.y=t||0,this.z=i||0,this.w=void 0!==n?n:1}function a(e,t,i){this.uuid=hs.generateUUID(),this.width=e,this.height=t,this.scissor=new r(0,0,e,t),this.scissorTest=!1,this.viewport=new r(0,0,e,t),i=i||{},void 0===i.minFilter&&(i.minFilter=Eo),this.texture=new n(void 0,void 0,i.wrapS,i.wrapT,i.magFilter,i.minFilter,i.format,i.type,i.anisotropy,i.encoding),this.depthBuffer=void 0===i.depthBuffer||i.depthBuffer,this.stencilBuffer=void 0===i.stencilBuffer||i.stencilBuffer,this.depthTexture=void 0!==i.depthTexture?i.depthTexture:null}function o(e,t,i){a.call(this,e,t,i),this.activeCubeFace=0,this.activeMipMapLevel=0}function s(e,t,i,n){this._x=e||0,this._y=t||0,this._z=i||0,this._w=void 0!==n?n:1}function l(e,t,i){this.x=e||0,this.y=t||0,this.z=i||0}function c(){this.elements=new Float32Array([1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1]),arguments.length>0&&console.error("THREE.Matrix4: the constructor no longer reads arguments. use .set() instead.")}function u(e,t,i,r,a,o,s,l,c,u,h,d){n.call(this,null,o,s,l,c,u,r,a,h,d),this.image={data:e,width:t,height:i},this.magFilter=void 0!==c?c:go,this.minFilter=void 0!==u?u:go,this.generateMipmaps=!1,this.flipY=!1,this.unpackAlignment=1}function h(e,t,i,r,a,o,s,l,c,u){e=void 0!==e?e:[],t=void 0!==t?t:ao,n.call(this,e,t,i,r,a,o,s,l,c,u),this.flipY=!1}function d(){this.seq=[],this.map={}}function f(e,t,i){var n=e[0];if(n<=0||n>0)return e;var r=t*i,a=ms[r];if(void 0===a&&(a=new Float32Array(r),ms[r]=a),0!==t){n.toArray(a,0);for(var o=1,s=0;o!==t;++o)s+=i,e[o].toArray(a,s)}return a}function p(e,t){var i=gs[t];void 0===i&&(i=new Int32Array(t),gs[t]=i);for(var n=0;n!==t;++n)i[n]=e.allocTextureUnit();return i}function m(e,t){e.uniform1f(this.addr,t)}function g(e,t){e.uniform1i(this.addr,t)}function v(e,t){void 0===t.x?e.uniform2fv(this.addr,t):e.uniform2f(this.addr,t.x,t.y)}function y(e,t){void 0!==t.x?e.uniform3f(this.addr,t.x,t.y,t.z):void 0!==t.r?e.uniform3f(this.addr,t.r,t.g,t.b):e.uniform3fv(this.addr,t)}function E(e,t){void 0===t.x?e.uniform4fv(this.addr,t):e.uniform4f(this.addr,t.x,t.y,t.z,t.w)}function x(e,t){e.uniformMatrix2fv(this.addr,!1,t.elements||t)}function b(e,t){void 0===t.elements?e.uniformMatrix3fv(this.addr,!1,t):(ys.set(t.elements),e.uniformMatrix3fv(this.addr,!1,ys))}function C(e,t){void 0===t.elements?e.uniformMatrix4fv(this.addr,!1,t):(vs.set(t.elements),e.uniformMatrix4fv(this.addr,!1,vs))}function M(e,t,i){var n=i.allocTextureUnit();e.uniform1i(this.addr,n),i.setTexture2D(t||fs,n)}function _(e,t,i){var n=i.allocTextureUnit();e.uniform1i(this.addr,n),i.setTextureCube(t||ps,n)}function w(e,t){e.uniform2iv(this.addr,t)}function L(e,t){e.uniform3iv(this.addr,t)}function T(e,t){e.uniform4iv(this.addr,t)}function I(e){switch(e){case 5126:return m;case 35664:return v;case 35665:return y;case 35666:return E;case 35674:return x;case 35675:return b;case 35676:return C;case 35678:return M;case 35680:return _;case 5124:case 35670:return g;case 35667:case 35671:return w;case 35668:case 35672:return L;case 35669:case 35673:return T}}function S(e,t){e.uniform1fv(this.addr,t)}function O(e,t){e.uniform1iv(this.addr,t)}function D(e,t){e.uniform2fv(this.addr,f(t,this.size,2))}function R(e,t){e.uniform3fv(this.addr,f(t,this.size,3))}function A(e,t){e.uniform4fv(this.addr,f(t,this.size,4))}function U(e,t){e.uniformMatrix2fv(this.addr,!1,f(t,this.size,4))}function B(e,t){e.uniformMatrix3fv(this.addr,!1,f(t,this.size,9))}function P(e,t){e.uniformMatrix4fv(this.addr,!1,f(t,this.size,16))}function N(e,t,i){var n=t.length,r=p(i,n);e.uniform1iv(this.addr,r);for(var a=0;a!==n;++a)i.setTexture2D(t[a]||fs,r[a])}function k(e,t,i){var n=t.length,r=p(i,n);e.uniform1iv(this.addr,r);for(var a=0;a!==n;++a)i.setTextureCube(t[a]||ps,r[a])}function F(e){switch(e){case 5126:return S;case 35664:return D;case 35665:return R;case 35666:return A;case 35674:return U;case 35675:return B;case 35676:return P;case 35678:return N;case 35680:return k;case 5124:case 35670:return O;case 35667:case 35671:return w;case 35668:case 35672:return L;case 35669:case 35673:return T}}function H(e,t,i){this.id=e,this.addr=i,this.setValue=I(t.type)}function G(e,t,i){this.id=e,this.addr=i,this.size=t.size,this.setValue=F(t.type)}function V(e){this.id=e,d.call(this)}function z(e,t){e.seq.push(t),e.map[t.id]=t}function W(e,t,i){var n=e.name,r=n.length;for(Es.lastIndex=0;;){var a=Es.exec(n),o=Es.lastIndex,s=a[1],l="]"===a[2],c=a[3];if(l&&(s|=0),void 0===c||"["===c&&o+2===r){z(i,void 0===c?new H(s,e,t):new G(s,e,t));break}var u=i.map,h=u[s];void 0===h&&(h=new V(s),z(i,h)),i=h}}function q(e,t,i){d.call(this),this.renderer=i;for(var n=e.getProgramParameter(t,e.ACTIVE_UNIFORMS),r=0;r<n;++r){var a=e.getActiveUniform(t,r),o=a.name;W(a,e.getUniformLocation(t,o),this)}}function j(e,t,i){return void 0===t&&void 0===i?this.set(e):this.setRGB(e,t,i)}function X(e,t){this.min=void 0!==e?e:new i(1/0,1/0),this.max=void 0!==t?t:new i(-1/0,-1/0)}function Y(e,t){function n(){var e=new Float32Array([-1,-1,0,0,1,-1,1,0,1,1,1,1,-1,1,0,1]),t=new Uint16Array([0,1,2,0,2,3]);a=p.createBuffer(),o=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,a),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,o),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),d=p.createTexture(),f=p.createTexture(),m.bindTexture(p.TEXTURE_2D,d),p.texImage2D(p.TEXTURE_2D,0,p.RGB,16,16,0,p.RGB,p.UNSIGNED_BYTE,null),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),m.bindTexture(p.TEXTURE_2D,f),p.texImage2D(p.TEXTURE_2D,0,p.RGBA,16,16,0,p.RGBA,p.UNSIGNED_BYTE,null),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_S,p.CLAMP_TO_EDGE),
p.texParameteri(p.TEXTURE_2D,p.TEXTURE_WRAP_T,p.CLAMP_TO_EDGE),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MAG_FILTER,p.NEAREST),p.texParameteri(p.TEXTURE_2D,p.TEXTURE_MIN_FILTER,p.NEAREST),s={vertexShader:["uniform lowp int renderType;","uniform vec3 screenPosition;","uniform vec2 scale;","uniform float rotation;","uniform sampler2D occlusionMap;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","varying float vVisibility;","void main() {","vUV = uv;","vec2 pos = position;","if ( renderType == 2 ) {","vec4 visibility = texture2D( occlusionMap, vec2( 0.1, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.1 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.9, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.9 ) );","visibility += texture2D( occlusionMap, vec2( 0.1, 0.5 ) );","visibility += texture2D( occlusionMap, vec2( 0.5, 0.5 ) );","vVisibility =        visibility.r / 9.0;","vVisibility *= 1.0 - visibility.g / 9.0;","vVisibility *=       visibility.b / 9.0;","vVisibility *= 1.0 - visibility.a / 9.0;","pos.x = cos( rotation ) * position.x - sin( rotation ) * position.y;","pos.y = sin( rotation ) * position.x + cos( rotation ) * position.y;","}","gl_Position = vec4( ( pos * scale + screenPosition.xy ).xy, screenPosition.z, 1.0 );","}"].join("\n"),fragmentShader:["uniform lowp int renderType;","uniform sampler2D map;","uniform float opacity;","uniform vec3 color;","varying vec2 vUV;","varying float vVisibility;","void main() {","if ( renderType == 0 ) {","gl_FragColor = vec4( 1.0, 0.0, 1.0, 0.0 );","} else if ( renderType == 1 ) {","gl_FragColor = texture2D( map, vUV );","} else {","vec4 texture = texture2D( map, vUV );","texture.a *= opacity * vVisibility;","gl_FragColor = texture;","gl_FragColor.rgb *= color;","}","}"].join("\n")},c=r(s),u={vertex:p.getAttribLocation(c,"position"),uv:p.getAttribLocation(c,"uv")},h={renderType:p.getUniformLocation(c,"renderType"),map:p.getUniformLocation(c,"map"),occlusionMap:p.getUniformLocation(c,"occlusionMap"),opacity:p.getUniformLocation(c,"opacity"),color:p.getUniformLocation(c,"color"),scale:p.getUniformLocation(c,"scale"),rotation:p.getUniformLocation(c,"rotation"),screenPosition:p.getUniformLocation(c,"screenPosition")}}function r(t){var i=p.createProgram(),n=p.createShader(p.FRAGMENT_SHADER),r=p.createShader(p.VERTEX_SHADER),a="precision "+e.getPrecision()+" float;\n";return p.shaderSource(n,a+t.fragmentShader),p.shaderSource(r,a+t.vertexShader),p.compileShader(n),p.compileShader(r),p.attachShader(i,n),p.attachShader(i,r),p.linkProgram(i),i}var a,o,s,c,u,h,d,f,p=e.context,m=e.state;this.render=function(r,s,g){if(0!==t.length){var v=new l,y=g.w/g.z,E=.5*g.z,x=.5*g.w,b=16/g.w,C=new i(b*y,b),M=new l(1,1,0),_=new i(1,1),w=new X;w.min.set(g.x,g.y),w.max.set(g.x+(g.z-16),g.y+(g.w-16)),void 0===c&&n(),p.useProgram(c),m.initAttributes(),m.enableAttribute(u.vertex),m.enableAttribute(u.uv),m.disableUnusedAttributes(),p.uniform1i(h.occlusionMap,0),p.uniform1i(h.map,1),p.bindBuffer(p.ARRAY_BUFFER,a),p.vertexAttribPointer(u.vertex,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(u.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,o),m.disable(p.CULL_FACE),m.buffers.depth.setMask(!1);for(var L=0,T=t.length;L<T;L++){b=16/g.w,C.set(b*y,b);var I=t[L];if(v.set(I.matrixWorld.elements[12],I.matrixWorld.elements[13],I.matrixWorld.elements[14]),v.applyMatrix4(s.matrixWorldInverse),v.applyMatrix4(s.projectionMatrix),M.copy(v),_.x=g.x+M.x*E+E-8,_.y=g.y+M.y*x+x-8,!0===w.containsPoint(_)){m.activeTexture(p.TEXTURE0),m.bindTexture(p.TEXTURE_2D,null),m.activeTexture(p.TEXTURE1),m.bindTexture(p.TEXTURE_2D,d),p.copyTexImage2D(p.TEXTURE_2D,0,p.RGB,_.x,_.y,16,16,0),p.uniform1i(h.renderType,0),p.uniform2f(h.scale,C.x,C.y),p.uniform3f(h.screenPosition,M.x,M.y,M.z),m.disable(p.BLEND),m.enable(p.DEPTH_TEST),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0),m.activeTexture(p.TEXTURE0),m.bindTexture(p.TEXTURE_2D,f),p.copyTexImage2D(p.TEXTURE_2D,0,p.RGBA,_.x,_.y,16,16,0),p.uniform1i(h.renderType,1),m.disable(p.DEPTH_TEST),m.activeTexture(p.TEXTURE1),m.bindTexture(p.TEXTURE_2D,d),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0),I.positionScreen.copy(M),I.customUpdateCallback?I.customUpdateCallback(I):I.updateLensFlares(),p.uniform1i(h.renderType,2),m.enable(p.BLEND);for(var S=0,O=I.lensFlares.length;S<O;S++){var D=I.lensFlares[S];D.opacity>.001&&D.scale>.001&&(M.x=D.x,M.y=D.y,M.z=D.z,b=D.size*D.scale/g.w,C.x=b*y,C.y=b,p.uniform3f(h.screenPosition,M.x,M.y,M.z),p.uniform2f(h.scale,C.x,C.y),p.uniform1f(h.rotation,D.rotation),p.uniform1f(h.opacity,D.opacity),p.uniform3f(h.color,D.color.r,D.color.g,D.color.b),m.setBlending(D.blending,D.blendEquation,D.blendSrc,D.blendDst),e.setTexture2D(D.texture,1),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0))}}}m.enable(p.CULL_FACE),m.enable(p.DEPTH_TEST),m.buffers.depth.setMask(!0),e.resetGLState()}}}function Z(e,t){function i(){var e=new Float32Array([-.5,-.5,0,0,.5,-.5,1,0,.5,.5,1,1,-.5,.5,0,1]),t=new Uint16Array([0,1,2,0,2,3]);o=p.createBuffer(),c=p.createBuffer(),p.bindBuffer(p.ARRAY_BUFFER,o),p.bufferData(p.ARRAY_BUFFER,e,p.STATIC_DRAW),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,c),p.bufferData(p.ELEMENT_ARRAY_BUFFER,t,p.STATIC_DRAW),u=r(),h={position:p.getAttribLocation(u,"position"),uv:p.getAttribLocation(u,"uv")},d={uvOffset:p.getUniformLocation(u,"uvOffset"),uvScale:p.getUniformLocation(u,"uvScale"),rotation:p.getUniformLocation(u,"rotation"),scale:p.getUniformLocation(u,"scale"),color:p.getUniformLocation(u,"color"),map:p.getUniformLocation(u,"map"),opacity:p.getUniformLocation(u,"opacity"),modelViewMatrix:p.getUniformLocation(u,"modelViewMatrix"),projectionMatrix:p.getUniformLocation(u,"projectionMatrix"),fogType:p.getUniformLocation(u,"fogType"),fogDensity:p.getUniformLocation(u,"fogDensity"),fogNear:p.getUniformLocation(u,"fogNear"),fogFar:p.getUniformLocation(u,"fogFar"),fogColor:p.getUniformLocation(u,"fogColor"),alphaTest:p.getUniformLocation(u,"alphaTest")};var i=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");i.width=8,i.height=8;var a=i.getContext("2d");a.fillStyle="white",a.fillRect(0,0,8,8),f=new n(i),f.needsUpdate=!0}function r(){var t=p.createProgram(),i=p.createShader(p.VERTEX_SHADER),n=p.createShader(p.FRAGMENT_SHADER);return p.shaderSource(i,["precision "+e.getPrecision()+" float;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform float rotation;","uniform vec2 scale;","uniform vec2 uvOffset;","uniform vec2 uvScale;","attribute vec2 position;","attribute vec2 uv;","varying vec2 vUV;","void main() {","vUV = uvOffset + uv * uvScale;","vec2 alignedPosition = position * scale;","vec2 rotatedPosition;","rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;","rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;","vec4 finalPosition;","finalPosition = modelViewMatrix * vec4( 0.0, 0.0, 0.0, 1.0 );","finalPosition.xy += rotatedPosition;","finalPosition = projectionMatrix * finalPosition;","gl_Position = finalPosition;","}"].join("\n")),p.shaderSource(n,["precision "+e.getPrecision()+" float;","uniform vec3 color;","uniform sampler2D map;","uniform float opacity;","uniform int fogType;","uniform vec3 fogColor;","uniform float fogDensity;","uniform float fogNear;","uniform float fogFar;","uniform float alphaTest;","varying vec2 vUV;","void main() {","vec4 texture = texture2D( map, vUV );","if ( texture.a < alphaTest ) discard;","gl_FragColor = vec4( color * texture.xyz, texture.a * opacity );","if ( fogType > 0 ) {","float depth = gl_FragCoord.z / gl_FragCoord.w;","float fogFactor = 0.0;","if ( fogType == 1 ) {","fogFactor = smoothstep( fogNear, fogFar, depth );","} else {","const float LOG2 = 1.442695;","fogFactor = exp2( - fogDensity * fogDensity * depth * depth * LOG2 );","fogFactor = 1.0 - clamp( fogFactor, 0.0, 1.0 );","}","gl_FragColor = mix( gl_FragColor, vec4( fogColor, gl_FragColor.w ), fogFactor );","}","}"].join("\n")),p.compileShader(i),p.compileShader(n),p.attachShader(t,i),p.attachShader(t,n),p.linkProgram(t),t}function a(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:t.id-e.id}var o,c,u,h,d,f,p=e.context,m=e.state,g=new l,v=new s,y=new l;this.render=function(n,r){if(0!==t.length){void 0===u&&i(),p.useProgram(u),m.initAttributes(),m.enableAttribute(h.position),m.enableAttribute(h.uv),m.disableUnusedAttributes(),m.disable(p.CULL_FACE),m.enable(p.BLEND),p.bindBuffer(p.ARRAY_BUFFER,o),p.vertexAttribPointer(h.position,2,p.FLOAT,!1,16,0),p.vertexAttribPointer(h.uv,2,p.FLOAT,!1,16,8),p.bindBuffer(p.ELEMENT_ARRAY_BUFFER,c),p.uniformMatrix4fv(d.projectionMatrix,!1,r.projectionMatrix.elements),m.activeTexture(p.TEXTURE0),p.uniform1i(d.map,0);var s=0,l=0,E=n.fog;E?(p.uniform3f(d.fogColor,E.color.r,E.color.g,E.color.b),E.isFog?(p.uniform1f(d.fogNear,E.near),p.uniform1f(d.fogFar,E.far),p.uniform1i(d.fogType,1),s=1,l=1):E.isFogExp2&&(p.uniform1f(d.fogDensity,E.density),p.uniform1i(d.fogType,2),s=2,l=2)):(p.uniform1i(d.fogType,0),s=0,l=0);for(var x=0,b=t.length;x<b;x++){var C=t[x];C.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,C.matrixWorld),C.z=-C.modelViewMatrix.elements[14]}t.sort(a);for(var M=[],x=0,b=t.length;x<b;x++){var C=t[x],_=C.material;if(!1!==_.visible){p.uniform1f(d.alphaTest,_.alphaTest),p.uniformMatrix4fv(d.modelViewMatrix,!1,C.modelViewMatrix.elements),C.matrixWorld.decompose(g,v,y),M[0]=y.x,M[1]=y.y;var w=0;n.fog&&_.fog&&(w=l),s!==w&&(p.uniform1i(d.fogType,w),s=w),null!==_.map?(p.uniform2f(d.uvOffset,_.map.offset.x,_.map.offset.y),p.uniform2f(d.uvScale,_.map.repeat.x,_.map.repeat.y)):(p.uniform2f(d.uvOffset,0,0),p.uniform2f(d.uvScale,1,1)),p.uniform1f(d.opacity,_.opacity),p.uniform3f(d.color,_.color.r,_.color.g,_.color.b),p.uniform1f(d.rotation,_.rotation),p.uniform2fv(d.scale,M),m.setBlending(_.blending,_.blendEquation,_.blendSrc,_.blendDst),m.buffers.depth.setTest(_.depthTest),m.buffers.depth.setMask(_.depthWrite),_.map?e.setTexture2D(_.map,0):e.setTexture2D(f,0),p.drawElements(p.TRIANGLES,6,p.UNSIGNED_SHORT,0)}}m.enable(p.CULL_FACE),e.resetGLState()}}}function K(){Object.defineProperty(this,"id",{value:ws++}),this.uuid=hs.generateUUID(),this.name="",this.type="Material",this.fog=!0,this.lights=!0,this.blending=Ca,this.side=fa,this.shading=va,this.vertexColors=ya,this.opacity=1,this.transparent=!1,this.blendSrc=Pa,this.blendDst=Na,this.blendEquation=Ta,this.blendSrcAlpha=null,this.blendDstAlpha=null,this.blendEquationAlpha=null,this.depthFunc=ja,this.depthTest=!0,this.depthWrite=!0,this.clippingPlanes=null,this.clipIntersection=!1,this.clipShadows=!1,this.colorWrite=!0,this.precision=null,this.polygonOffset=!1,this.polygonOffsetFactor=0,this.polygonOffsetUnits=0,this.dithering=!1,this.alphaTest=0,this.premultipliedAlpha=!1,this.overdraw=0,this.visible=!0,this.needsUpdate=!0}function Q(e){K.call(this),this.type="ShaderMaterial",this.defines={},this.uniforms={},this.vertexShader="void main() {\n\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n}",this.fragmentShader="void main() {\n\tgl_FragColor = vec4( 1.0, 0.0, 0.0, 1.0 );\n}",this.linewidth=1,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.clipping=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.extensions={derivatives:!1,fragDepth:!1,drawBuffers:!1,shaderTextureLOD:!1},this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},this.index0AttributeName=void 0,void 0!==e&&(void 0!==e.attributes&&console.error("THREE.ShaderMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))}function J(e){K.call(this),this.type="MeshDepthMaterial",this.depthPacking=cs,this.skinning=!1,this.morphTargets=!1,this.map=null,this.alphaMap=null,this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.setValues(e)}function $(e,t){this.min=void 0!==e?e:new l(1/0,1/0,1/0),this.max=void 0!==t?t:new l(-1/0,-1/0,-1/0)}function ee(e,t){this.center=void 0!==e?e:new l,this.radius=void 0!==t?t:0}function te(){this.elements=[1,0,0,0,1,0,0,0,1],arguments.length>0&&console.error("THREE.Matrix3: the constructor no longer reads arguments. use .set() instead.")}function ie(e,t){this.normal=void 0!==e?e:new l(1,0,0),this.constant=void 0!==t?t:0}function ne(e,t,i,n,r,a){this.planes=[void 0!==e?e:new ie,void 0!==t?t:new ie,void 0!==i?i:new ie,void 0!==n?n:new ie,void 0!==r?r:new ie,void 0!==a?a:new ie]}function re(e,t,n,o){function s(t,i,n,r){var a=t.geometry,o=null,s=M,l=t.customDepthMaterial;if(n&&(s=_,l=t.customDistanceMaterial),l)o=l;else{var c=!1;i.morphTargets&&(a&&a.isBufferGeometry?c=a.morphAttributes&&a.morphAttributes.position&&a.morphAttributes.position.length>0:a&&a.isGeometry&&(c=a.morphTargets&&a.morphTargets.length>0)),t.isSkinnedMesh&&!1===i.skinning&&console.warn("THREE.WebGLShadowMap: THREE.SkinnedMesh with material.skinning set to false:",t);var u=t.isSkinnedMesh&&i.skinning,h=0;c&&(h|=x),u&&(h|=b),o=s[h]}if(e.localClippingEnabled&&!0===i.clipShadows&&0!==i.clippingPlanes.length){var d=o.uuid,f=i.uuid,p=w[d];void 0===p&&(p={},w[d]=p);var m=p[f];void 0===m&&(m=o.clone(),p[f]=m),o=m}o.visible=i.visible,o.wireframe=i.wireframe;var g=i.side;return N.renderSingleSided&&g==ma&&(g=fa),N.renderReverseSided&&(g===fa?g=pa:g===pa&&(g=fa)),o.side=g,o.clipShadows=i.clipShadows,o.clippingPlanes=i.clippingPlanes,o.wireframeLinewidth=i.wireframeLinewidth,o.linewidth=i.linewidth,n&&void 0!==o.uniforms.lightPos&&o.uniforms.lightPos.value.copy(r),o}function u(t,i,r,a){if(!1!==t.visible){if(t.layers.test(i.layers)&&(t.isMesh||t.isLine||t.isPoints)&&t.castShadow&&(!t.frustumCulled||f.intersectsObject(t))){t.modelViewMatrix.multiplyMatrices(r.matrixWorldInverse,t.matrixWorld);var o=n.update(t),l=t.material;if(Array.isArray(l))for(var c=o.groups,h=0,d=c.length;h<d;h++){var p=c[h],m=l[p.materialIndex];if(m&&m.visible){var g=s(t,m,a,E);e.renderBufferDirect(r,null,o,g,t,p)}}else if(l.visible){var g=s(t,l,a,E);e.renderBufferDirect(r,null,o,g,t,null)}}for(var v=t.children,y=0,x=v.length;y<x;y++)u(v[y],i,r,a)}}var h=e.context,d=e.state,f=new ne,p=new c,m=t.shadows,g=new i,v=new i(o.maxTextureSize,o.maxTextureSize),y=new l,E=new l,x=1,b=2,C=1+(x|b),M=new Array(C),_=new Array(C),w={},L=[new l(1,0,0),new l(-1,0,0),new l(0,0,1),new l(0,0,-1),new l(0,1,0),new l(0,-1,0)],T=[new l(0,1,0),new l(0,1,0),new l(0,1,0),new l(0,1,0),new l(0,0,1),new l(0,0,-1)],I=[new r,new r,new r,new r,new r,new r],S=new J;S.depthPacking=us,S.clipping=!0;for(var O=_s.distanceRGBA,D=Cs.clone(O.uniforms),R=0;R!==C;++R){var A=0!=(R&x),U=0!=(R&b),B=S.clone();B.morphTargets=A,B.skinning=U,M[R]=B;var P=new Q({defines:{USE_SHADOWMAP:""},uniforms:D,vertexShader:O.vertexShader,fragmentShader:O.fragmentShader,morphTargets:A,skinning:U,clipping:!0});_[R]=P}var N=this;this.enabled=!1,this.autoUpdate=!0,this.needsUpdate=!1,this.type=ha,this.renderReverseSided=!0,this.renderSingleSided=!0,this.render=function(t,i){if(!1!==N.enabled&&(!1!==N.autoUpdate||!1!==N.needsUpdate)&&0!==m.length){d.disable(h.BLEND),d.buffers.color.setClear(1,1,1,1),d.buffers.depth.setTest(!0),d.setScissorTest(!1);for(var n,r,o=0,s=m.length;o<s;o++){var l=m[o],c=l.shadow;if(void 0!==c){var x=c.camera,b=c.matrix;if(E.setFromMatrixPosition(l.matrixWorld),x.position.copy(E),g.copy(c.mapSize),g.min(v),l&&l.isPointLight){n=6,r=!0;var C=g.x,M=g.y;I[0].set(2*C,M,C,M),I[1].set(0,M,C,M),I[2].set(3*C,M,C,M),I[3].set(C,M,C,M),I[4].set(3*C,0,C,M),I[5].set(C,0,C,M),g.x*=4,g.y*=2,b.makeTranslation(-E.x,-E.y,-E.z)}else n=1,r=!1,y.setFromMatrixPosition(l.target.matrixWorld),x.lookAt(y),x.updateMatrixWorld(),x.matrixWorldInverse.getInverse(x.matrixWorld),b.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),b.multiply(x.projectionMatrix),b.multiply(x.matrixWorldInverse);if(null===c.map){var _={minFilter:go,magFilter:go,format:Po};c.map=new a(g.x,g.y,_),c.map.texture.name=l.name+".shadowMap",x.updateProjectionMatrix()}c.isSpotLightShadow&&c.update(l);var w=c.map;e.setRenderTarget(w),e.clear();for(var S=0;S<n;S++){if(r){y.copy(x.position),y.add(L[S]),x.up.copy(T[S]),x.lookAt(y),x.updateMatrixWorld(),x.matrixWorldInverse.getInverse(x.matrixWorld);var O=I[S];d.viewport(O)}p.multiplyMatrices(x.projectionMatrix,x.matrixWorldInverse),f.setFromMatrix(p),u(t,i,x,r)}}else console.warn("THREE.WebGLShadowMap:",l,"has no shadow.")}var D=e.getClearColor(),R=e.getClearAlpha();e.setClearColor(D,R),N.needsUpdate=!1}}}function ae(e,t){this.origin=void 0!==e?e:new l,this.direction=void 0!==t?t:new l}function oe(e,t,i,n){this._x=e||0,this._y=t||0,this._z=i||0,this._order=n||oe.DefaultOrder}function se(){this.mask=1}function le(){function e(){r.setFromEuler(n,!1)}function t(){n.setFromQuaternion(r,void 0,!1)}Object.defineProperty(this,"id",{value:Ls++}),this.uuid=hs.generateUUID(),this.name="",this.type="Object3D",this.parent=null,this.children=[],this.up=le.DefaultUp.clone();var i=new l,n=new oe,r=new s,a=new l(1,1,1);n.onChange(e),r.onChange(t),Object.defineProperties(this,{position:{enumerable:!0,value:i},rotation:{enumerable:!0,value:n},quaternion:{enumerable:!0,value:r},scale:{enumerable:!0,value:a},modelViewMatrix:{value:new c},normalMatrix:{value:new te}}),this.matrix=new c,this.matrixWorld=new c,this.matrixAutoUpdate=le.DefaultMatrixAutoUpdate,this.matrixWorldNeedsUpdate=!1,this.layers=new se,this.visible=!0,this.castShadow=!1,this.receiveShadow=!1,this.frustumCulled=!0,this.renderOrder=0,this.userData={},this.onBeforeRender=function(){},this.onAfterRender=function(){}}function ce(e,t){this.start=void 0!==e?e:new l,this.end=void 0!==t?t:new l}function ue(e,t,i){this.a=void 0!==e?e:new l,this.b=void 0!==t?t:new l,this.c=void 0!==i?i:new l}function he(e,t,i,n,r,a){this.a=e,this.b=t,this.c=i,this.normal=n&&n.isVector3?n:new l,this.vertexNormals=Array.isArray(n)?n:[],this.color=r&&r.isColor?r:new j,this.vertexColors=Array.isArray(r)?r:[],this.materialIndex=void 0!==a?a:0}function de(e){K.call(this),this.type="MeshBasicMaterial",this.color=new j(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.lights=!1,this.setValues(e)}function fe(e,t,i){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.uuid=hs.generateUUID(),this.array=e,this.itemSize=t,this.count=void 0!==e?e.length/t:0,this.normalized=!0===i,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function pe(e,t){fe.call(this,new Int8Array(e),t)}function me(e,t){fe.call(this,new Uint8Array(e),t)}function ge(e,t){fe.call(this,new Uint8ClampedArray(e),t)}function ve(e,t){fe.call(this,new Int16Array(e),t)}function ye(e,t){fe.call(this,new Uint16Array(e),t)}function Ee(e,t){fe.call(this,new Int32Array(e),t)}function xe(e,t){fe.call(this,new Uint32Array(e),t)}function be(e,t){fe.call(this,new Float32Array(e),t)}function Ce(e,t){fe.call(this,new Float64Array(e),t)}function Me(){this.indices=[],this.vertices=[],this.normals=[],this.colors=[],this.uvs=[],this.uvs2=[],this.groups=[],this.morphTargets={},this.skinWeights=[],this.skinIndices=[],this.boundingBox=null,this.boundingSphere=null,this.verticesNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.uvsNeedUpdate=!1,this.groupsNeedUpdate=!1}function _e(e){if(0===e.length)return-1/0;for(var t=e[0],i=1,n=e.length;i<n;++i)e[i]>t&&(t=e[i]);return t}function we(){return Ts++}function Le(){Object.defineProperty(this,"id",{value:we()}),this.uuid=hs.generateUUID(),this.name="",this.type="Geometry",this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.elementsNeedUpdate=!1,this.verticesNeedUpdate=!1,this.uvsNeedUpdate=!1,this.normalsNeedUpdate=!1,this.colorsNeedUpdate=!1,this.lineDistancesNeedUpdate=!1,this.groupsNeedUpdate=!1}function Te(){Object.defineProperty(this,"id",{value:we()}),this.uuid=hs.generateUUID(),this.name="",this.type="BufferGeometry",this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.drawRange={start:0,count:1/0}}function Ie(e,t){le.call(this),this.type="Mesh",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new de({color:16777215*Math.random()}),this.drawMode=$o,this.updateMorphTargets()}function Se(e,t,i,n,r,a){Le.call(this),this.type="BoxGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:r,depthSegments:a},this.fromBufferGeometry(new Oe(e,t,i,n,r,a)),this.mergeVertices()}function Oe(e,t,i,n,r,a){function o(e,t,i,n,r,a,o,m,g,v,y){var E,x,b=a/g,C=o/v,M=a/2,_=o/2,w=m/2,L=g+1,T=v+1,I=0,S=0,O=new l;for(x=0;x<T;x++){var D=x*C-_;for(E=0;E<L;E++){var R=E*b-M;O[e]=R*n,O[t]=D*r,O[i]=w,u.push(O.x,O.y,O.z),O[e]=0,O[t]=0,O[i]=m>0?1:-1,h.push(O.x,O.y,O.z),d.push(E/g),d.push(1-x/v),I+=1}}for(x=0;x<v;x++)for(E=0;E<g;E++){var A=f+E+L*x,U=f+E+L*(x+1),B=f+(E+1)+L*(x+1),P=f+(E+1)+L*x;c.push(A,U,P),c.push(U,B,P),S+=6}s.addGroup(p,S,y),p+=S,f+=I}Te.call(this),this.type="BoxBufferGeometry",this.parameters={width:e,height:t,depth:i,widthSegments:n,heightSegments:r,depthSegments:a};var s=this;n=Math.floor(n)||1,r=Math.floor(r)||1,a=Math.floor(a)||1;var c=[],u=[],h=[],d=[],f=0,p=0;o("z","y","x",-1,-1,i,t,e,a,r,0),o("z","y","x",1,-1,i,t,-e,a,r,1),o("x","z","y",1,1,e,i,t,n,a,2),o("x","z","y",1,-1,e,i,-t,n,a,3),o("x","y","z",1,-1,e,t,i,n,r,4),o("x","y","z",-1,-1,e,t,-i,n,r,5),this.setIndex(c),this.addAttribute("position",new be(u,3)),this.addAttribute("normal",new be(h,3)),this.addAttribute("uv",new be(d,2))}function De(e,t,i,n){Le.call(this),this.type="PlaneGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n},this.fromBufferGeometry(new Re(e,t,i,n)),this.mergeVertices()}function Re(e,t,i,n){Te.call(this),this.type="PlaneBufferGeometry",this.parameters={width:e,height:t,widthSegments:i,heightSegments:n};var r,a,o=e/2,s=t/2,l=Math.floor(i)||1,c=Math.floor(n)||1,u=l+1,h=c+1,d=e/l,f=t/c,p=[],m=[],g=[],v=[];for(a=0;a<h;a++){var y=a*f-s;for(r=0;r<u;r++){var E=r*d-o;m.push(E,-y,0),g.push(0,0,1),v.push(r/l),v.push(1-a/c)}}for(a=0;a<c;a++)for(r=0;r<l;r++){var x=r+u*a,b=r+u*(a+1),C=r+1+u*(a+1),M=r+1+u*a;p.push(x,b,M),p.push(b,C,M)}this.setIndex(p),this.addAttribute("position",new be(m,3)),this.addAttribute("normal",new be(g,3)),this.addAttribute("uv",new be(v,2))}function Ae(){le.call(this),this.type="Camera",this.matrixWorldInverse=new c,this.projectionMatrix=new c}function Ue(e,t,i,n){Ae.call(this),this.type="PerspectiveCamera",this.fov=void 0!==e?e:50,this.zoom=1,this.near=void 0!==i?i:.1,this.far=void 0!==n?n:2e3,this.focus=10,this.aspect=void 0!==t?t:1,this.view=null,this.filmGauge=35,this.filmOffset=0,this.updateProjectionMatrix()}function Be(e,t,i,n,r,a){Ae.call(this),this.type="OrthographicCamera",this.zoom=1,this.view=null,this.left=e,this.right=t,this.top=i,this.bottom=n,this.near=void 0!==r?r:.1,this.far=void 0!==a?a:2e3,this.updateProjectionMatrix()}function Pe(e){function t(t,i){var n=t.array,r=t.dynamic?e.DYNAMIC_DRAW:e.STATIC_DRAW,a=e.createBuffer();e.bindBuffer(i,a),e.bufferData(i,n,r),t.onUploadCallback();var o=e.FLOAT;return n instanceof Float32Array?o=e.FLOAT:n instanceof Float64Array?console.warn("Unsupported data buffer format: Float64Array"):n instanceof Uint16Array?o=e.UNSIGNED_SHORT:n instanceof Int16Array?o=e.SHORT:n instanceof Uint32Array?o=e.UNSIGNED_INT:n instanceof Int32Array?o=e.INT:n instanceof Int8Array?o=e.BYTE:n instanceof Uint8Array&&(o=e.UNSIGNED_BYTE),{buffer:a,type:o,bytesPerElement:n.BYTES_PER_ELEMENT,version:t.version}}function i(t,i,n){var r=i.array,a=i.updateRange;e.bindBuffer(n,t),!1===i.dynamic?e.bufferData(n,r,e.STATIC_DRAW):-1===a.count?e.bufferSubData(n,0,r):0===a.count?console.error("THREE.WebGLObjects.updateBuffer: dynamic THREE.BufferAttribute marked as needsUpdate but updateRange.count is 0, ensure you are using set methods or updating manually."):(e.bufferSubData(n,a.offset*r.BYTES_PER_ELEMENT,r.subarray(a.offset,a.offset+a.count)),a.count=0)}function n(e){return e.isInterleavedBufferAttribute&&(e=e.data),o[e.uuid]}function r(t){var i=o[t.uuid];i&&(e.deleteBuffer(i.buffer),delete o[t.uuid])}function a(e,n){e.isInterleavedBufferAttribute&&(e=e.data);var r=o[e.uuid];void 0===r?o[e.uuid]=t(e,n):r.version<e.version&&(i(r.buffer,e,n),r.version=e.version)}var o={};return{get:n,remove:r,update:a}}function Ne(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.program&&t.program&&e.program!==t.program?e.program.id-t.program.id:e.material.id!==t.material.id?e.material.id-t.material.id:e.z!==t.z?e.z-t.z:e.id-t.id}function ke(e,t){return e.renderOrder!==t.renderOrder?e.renderOrder-t.renderOrder:e.z!==t.z?t.z-e.z:e.id-t.id}function Fe(){function e(){a=-1,s=-1}function t(e,t,i,n,l){var c,u;i.transparent?(c=o,u=++s):(c=r,u=++a);var h=c[u];h?(h.id=e.id,h.object=e,h.geometry=t,h.material=i,h.program=i.program,h.renderOrder=e.renderOrder,h.z=n,h.group=l):(h={id:e.id,object:e,geometry:t,material:i,program:i.program,renderOrder:e.renderOrder,z:n,group:l},c.push(h))}function i(){r.length=a+1,o.length=s+1}function n(){r.sort(Ne),o.sort(ke)}var r=[],a=-1,o=[],s=-1;return{opaque:r,transparent:o,init:e,push:t,finish:i,sort:n}}function He(){function e(e,t){var n=e.id+","+t.id,r=i[n];return void 0===r&&(r=new Fe,i[n]=r),r}function t(){i={}}var i={};return{get:e,dispose:t}}function Ge(e,t,i){function n(e){s=e}function r(i){i.array instanceof Uint32Array&&t.get("OES_element_index_uint")?(l=e.UNSIGNED_INT,c=4):i.array instanceof Uint16Array?(l=e.UNSIGNED_SHORT,c=2):(l=e.UNSIGNED_BYTE,c=1)}function a(t,n){e.drawElements(s,n,l,t*c),i.calls++,i.vertices+=n,s===e.TRIANGLES&&(i.faces+=n/3)}function o(n,r,a){var o=t.get("ANGLE_instanced_arrays");if(null===o)return void console.error("THREE.WebGLIndexedBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");o.drawElementsInstancedANGLE(s,a,l,r*c,n.maxInstancedCount),i.calls++,i.vertices+=a*n.maxInstancedCount,s===e.TRIANGLES&&(i.faces+=n.maxInstancedCount*a/3)}var s,l,c;this.setMode=n,this.setIndex=r,this.render=a,this.renderInstances=o}function Ve(e,t,i){function n(e){o=e}function r(t,n){e.drawArrays(o,t,n),i.calls++,i.vertices+=n,o===e.TRIANGLES&&(i.faces+=n/3)}function a(n,r,a){var s=t.get("ANGLE_instanced_arrays");if(null===s)return void console.error("THREE.WebGLBufferRenderer: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");var l=n.attributes.position;l.isInterleavedBufferAttribute?(a=l.data.count,s.drawArraysInstancedANGLE(o,0,a,n.maxInstancedCount)):s.drawArraysInstancedANGLE(o,r,a,n.maxInstancedCount),i.calls++,i.vertices+=a*n.maxInstancedCount,o===e.TRIANGLES&&(i.faces+=n.maxInstancedCount*a/3)}var o;this.setMode=n,this.render=r,this.renderInstances=a}function ze(e,t,i){function n(e){var r=e.target,a=s[r.id];null!==a.index&&t.remove(a.index);for(var o in a.attributes)t.remove(a.attributes[o]);r.removeEventListener("dispose",n),delete s[r.id];var c=l[r.id];c&&(t.remove(c),delete l[r.id]),c=l[a.id],c&&(t.remove(c),delete l[a.id]),i.geometries--}function r(e,t){var r=s[t.id];return r||(t.addEventListener("dispose",n),t.isBufferGeometry?r=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Te).setFromObject(e)),r=t._bufferGeometry),s[t.id]=r,i.geometries++,r)}function a(i){var n=i.index,r=i.attributes;null!==n&&t.update(n,e.ELEMENT_ARRAY_BUFFER);for(var a in r)t.update(r[a],e.ARRAY_BUFFER);var o=i.morphAttributes;for(var a in o)for(var s=o[a],l=0,c=s.length;l<c;l++)t.update(s[l],e.ARRAY_BUFFER)}function o(i){var n=l[i.id];if(n)return n;var r=[],a=i.index,o=i.attributes;if(null!==a)for(var s=a.array,c=0,u=s.length;c<u;c+=3){var h=s[c+0],d=s[c+1],f=s[c+2];r.push(h,d,d,f,f,h)}else for(var s=o.position.array,c=0,u=s.length/3-1;c<u;c+=3){var h=c+0,d=c+1,f=c+2;r.push(h,d,d,f,f,h)}return n=new(_e(r)>65535?xe:ye)(r,1),t.update(n,e.ELEMENT_ARRAY_BUFFER),l[i.id]=n,n}var s={},l={};return{get:r,update:a,getWireframeAttribute:o}}function We(){var e={};return{get:function(t){if(void 0!==e[t.id])return e[t.id];var n;switch(t.type){case"DirectionalLight":n={direction:new l,color:new j,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i};break;case"SpotLight":n={position:new l,direction:new l,color:new j,distance:0,coneCos:0,penumbraCos:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i};break;case"PointLight":n={position:new l,color:new j,distance:0,decay:0,shadow:!1,shadowBias:0,shadowRadius:1,shadowMapSize:new i};break;case"HemisphereLight":n={direction:new l,skyColor:new j,groundColor:new j};break;case"RectAreaLight":n={color:new j,position:new l,halfWidth:new l,halfHeight:new l}}return e[t.id]=n,n}}}function qe(e,t,i){function n(e){var n=i.frame,r=e.geometry,o=t.get(e,r);return a[o.id]!==n&&(r.isGeometry&&o.updateFromObject(e),t.update(o),a[o.id]=n),o}function r(){a={}}var a={};return{update:n,clear:r}}function je(e){for(var t=e.split("\n"),i=0;i<t.length;i++)t[i]=i+1+": "+t[i];return t.join("\n")}function Xe(e,t,i){var n=e.createShader(t);return e.shaderSource(n,i),e.compileShader(n),!1===e.getShaderParameter(n,e.COMPILE_STATUS)&&console.error("THREE.WebGLShader: Shader couldn't compile."),""!==e.getShaderInfoLog(n)&&console.warn("THREE.WebGLShader: gl.getShaderInfoLog()",t===e.VERTEX_SHADER?"vertex":"fragment",e.getShaderInfoLog(n),je(i)),n}function Ye(e){switch(e){case is:return["Linear","( value )"];case ns:return["sRGB","( value )"];case as:return["RGBE","( value )"];case os:return["RGBM","( value, 7.0 )"];case ss:return["RGBM","( value, 16.0 )"];case ls:return["RGBD","( value, 256.0 )"];case rs:return["Gamma","( value, float( GAMMA_FACTOR ) )"];default:throw new Error("unsupported encoding: "+e)}}function Ze(e,t){var i=Ye(t);return"vec4 "+e+"( vec4 value ) { return "+i[0]+"ToLinear"+i[1]+"; }"}function Ke(e,t){var i=Ye(t);return"vec4 "+e+"( vec4 value ) { return LinearTo"+i[0]+i[1]+"; }"}function Qe(e,t){var i;switch(t){case to:i="Linear";break;case io:i="Reinhard";break;case no:i="Uncharted2";break;case ro:i="OptimizedCineon";break;default:throw new Error("unsupported toneMapping: "+t)}return"vec3 "+e+"( vec3 color ) { return "+i+"ToneMapping( color ); }"}function Je(e,t,i){return e=e||{},[e.derivatives||t.envMapCubeUV||t.bumpMap||t.normalMap||t.flatShading?"#extension GL_OES_standard_derivatives : enable":"",(e.fragDepth||t.logarithmicDepthBuffer)&&i.get("EXT_frag_depth")?"#extension GL_EXT_frag_depth : enable":"",e.drawBuffers&&i.get("WEBGL_draw_buffers")?"#extension GL_EXT_draw_buffers : require":"",(e.shaderTextureLOD||t.envMap)&&i.get("EXT_shader_texture_lod")?"#extension GL_EXT_shader_texture_lod : enable":""].filter(tt).join("\n")}function $e(e){var t=[];for(var i in e){var n=e[i];!1!==n&&t.push("#define "+i+" "+n)}return t.join("\n")}function et(e,t,i){for(var n={},r=e.getProgramParameter(t,e.ACTIVE_ATTRIBUTES),a=0;a<r;a++){var o=e.getActiveAttrib(t,a),s=o.name;n[s]=e.getAttribLocation(t,s)}return n}function tt(e){return""!==e}function it(e,t){return e.replace(/NUM_DIR_LIGHTS/g,t.numDirLights).replace(/NUM_SPOT_LIGHTS/g,t.numSpotLights).replace(/NUM_RECT_AREA_LIGHTS/g,t.numRectAreaLights).replace(/NUM_POINT_LIGHTS/g,t.numPointLights).replace(/NUM_HEMI_LIGHTS/g,t.numHemiLights)}function nt(e){function t(e,t){var i=Ms[t]
;if(void 0===i)throw new Error("Can not resolve #include <"+t+">");return nt(i)}var i=/^[ \t]*#include +<([\w\d.]+)>/gm;return e.replace(i,t)}function rt(e){function t(e,t,i,n){for(var r="",a=parseInt(t);a<parseInt(i);a++)r+=n.replace(/\[ i \]/g,"[ "+a+" ]");return r}var i=/for \( int i \= (\d+)\; i < (\d+)\; i \+\+ \) \{([\s\S]+?)(?=\})\}/g;return e.replace(i,t)}function at(e,t,i,n){var r=e.context,a=i.extensions,o=i.defines,s=i.__webglShader.vertexShader,l=i.__webglShader.fragmentShader,c="SHADOWMAP_TYPE_BASIC";n.shadowMapType===ha?c="SHADOWMAP_TYPE_PCF":n.shadowMapType===da&&(c="SHADOWMAP_TYPE_PCF_SOFT");var u="ENVMAP_TYPE_CUBE",h="ENVMAP_MODE_REFLECTION",d="ENVMAP_BLENDING_MULTIPLY";if(n.envMap){switch(i.envMap.mapping){case ao:case oo:u="ENVMAP_TYPE_CUBE";break;case uo:case ho:u="ENVMAP_TYPE_CUBE_UV";break;case so:case lo:u="ENVMAP_TYPE_EQUIREC";break;case co:u="ENVMAP_TYPE_SPHERE"}switch(i.envMap.mapping){case oo:case lo:h="ENVMAP_MODE_REFRACTION"}switch(i.combine){case Qa:d="ENVMAP_BLENDING_MULTIPLY";break;case Ja:d="ENVMAP_BLENDING_MIX";break;case $a:d="ENVMAP_BLENDING_ADD"}}var f,p,m=e.gammaFactor>0?e.gammaFactor:1,g=Je(a,n,e.extensions),v=$e(o),y=r.createProgram();i.isRawShaderMaterial?(f=[v,"\n"].filter(tt).join("\n"),p=[g,v,"\n"].filter(tt).join("\n")):(f=["precision "+n.precision+" float;","precision "+n.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,v,n.supportsVertexTextures?"#define VERTEX_TEXTURES":"","#define GAMMA_FACTOR "+m,"#define MAX_BONES "+n.maxBones,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+h:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.displacementMap&&n.supportsVertexTextures?"#define USE_DISPLACEMENTMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.vertexColors?"#define USE_COLOR":"",n.flatShading?"#define FLAT_SHADED":"",n.skinning?"#define USE_SKINNING":"",n.useVertexTexture?"#define BONE_TEXTURE":"",n.morphTargets?"#define USE_MORPHTARGETS":"",n.morphNormals&&!1===n.flatShading?"#define USE_MORPHNORMALS":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+n.numClippingPlanes,n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.sizeAttenuation?"#define USE_SIZEATTENUATION":"",n.positionOffset?"#define USE_POSITION_OFFSET":"",n.sizeAttribute?"#define USE_ATTRIBUTE_SIZE":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"","uniform mat4 modelMatrix;","uniform mat4 modelViewMatrix;","uniform mat4 projectionMatrix;","uniform mat4 viewMatrix;","uniform mat3 normalMatrix;","uniform vec3 cameraPosition;","attribute vec3 position;","attribute vec3 normal;","attribute vec2 uv;","#ifdef USE_COLOR","\tattribute vec3 color;","#endif","#ifdef USE_MORPHTARGETS","\tattribute vec3 morphTarget0;","\tattribute vec3 morphTarget1;","\tattribute vec3 morphTarget2;","\tattribute vec3 morphTarget3;","\t#ifdef USE_MORPHNORMALS","\t\tattribute vec3 morphNormal0;","\t\tattribute vec3 morphNormal1;","\t\tattribute vec3 morphNormal2;","\t\tattribute vec3 morphNormal3;","\t#else","\t\tattribute vec3 morphTarget4;","\t\tattribute vec3 morphTarget5;","\t\tattribute vec3 morphTarget6;","\t\tattribute vec3 morphTarget7;","\t#endif","#endif","#ifdef USE_SKINNING","\tattribute vec4 skinIndex;","\tattribute vec4 skinWeight;","#endif",n.idBuffer?"#define ENABLE_VERTEX_ID":"","\n"].filter(tt).join("\n"),p=[g,n.idBuffer?"#extension GL_EXT_draw_buffers : enable":"",n.idBuffer?"#define ID_BUFFER_MRT":"","precision "+n.precision+" float;","precision "+n.precision+" int;","#define SHADER_NAME "+i.__webglShader.name,v,n.alphaTest?"#define ALPHATEST "+n.alphaTest:"","#define GAMMA_FACTOR "+m,n.useFog&&n.fog?"#define USE_FOG":"",n.useFog&&n.fogExp?"#define FOG_EXP2":"",n.map?"#define USE_MAP":"",n.envMap?"#define USE_ENVMAP":"",n.envMap?"#define "+u:"",n.envMap?"#define "+h:"",n.envMap?"#define "+d:"",n.lightMap?"#define USE_LIGHTMAP":"",n.aoMap?"#define USE_AOMAP":"",n.emissiveMap?"#define USE_EMISSIVEMAP":"",n.bumpMap?"#define USE_BUMPMAP":"",n.normalMap?"#define USE_NORMALMAP":"",n.specularMap?"#define USE_SPECULARMAP":"",n.roughnessMap?"#define USE_ROUGHNESSMAP":"",n.metalnessMap?"#define USE_METALNESSMAP":"",n.alphaMap?"#define USE_ALPHAMAP":"",n.vertexColors?"#define USE_COLOR":"",n.gradientMap?"#define USE_GRADIENTMAP":"",n.flatShading?"#define FLAT_SHADED":"",n.doubleSided?"#define DOUBLE_SIDED":"",n.flipSided?"#define FLIP_SIDED":"","#define NUM_CLIPPING_PLANES "+n.numClippingPlanes,"#define UNION_CLIPPING_PLANES "+(n.numClippingPlanes-n.numClipIntersection),n.shadowMapEnabled?"#define USE_SHADOWMAP":"",n.shadowMapEnabled?"#define "+c:"",n.premultipliedAlpha?"#define PREMULTIPLIED_ALPHA":"",n.physicallyCorrectLights?"#define PHYSICALLY_CORRECT_LIGHTS":"",n.logarithmicDepthBuffer?"#define USE_LOGDEPTHBUF":"",n.logarithmicDepthBuffer&&e.extensions.get("EXT_frag_depth")?"#define USE_LOGDEPTHBUF_EXT":"",n.envMap&&e.extensions.get("EXT_shader_texture_lod")?"#define TEXTURE_LOD_EXT":"","uniform mat4 viewMatrix;","uniform vec3 cameraPosition;",n.toneMapping!==eo?"#define TONE_MAPPING":"",n.toneMapping!==eo?Ms.tonemapping_pars_fragment:"",n.toneMapping!==eo?Qe("toneMapping",n.toneMapping):"",n.dithering?"#define DITHERING":"",n.outputEncoding||n.mapEncoding||n.envMapEncoding||n.emissiveMapEncoding?Ms.encodings_pars_fragment:"",n.mapEncoding?Ze("mapTexelToLinear",n.mapEncoding):"",n.envMapEncoding?Ze("envMapTexelToLinear",n.envMapEncoding):"",n.emissiveMapEncoding?Ze("emissiveMapTexelToLinear",n.emissiveMapEncoding):"",n.outputEncoding?Ke("linearToOutputTexel",n.outputEncoding):"",n.depthPacking?"#define DEPTH_PACKING "+i.depthPacking:"","\n"].filter(tt).join("\n")),s=nt(s,n),s=it(s,n),l=nt(l,n),l=it(l,n),i.isShaderMaterial||(s=rt(s),l=rt(l));var E=f+s,x=p+l,b=Xe(r,r.VERTEX_SHADER,E),C=Xe(r,r.FRAGMENT_SHADER,x);r.attachShader(y,b),r.attachShader(y,C),void 0!==i.index0AttributeName?r.bindAttribLocation(y,0,i.index0AttributeName):!0===n.morphTargets&&r.bindAttribLocation(y,0,"position"),r.linkProgram(y);var M=r.getProgramInfoLog(y),_=r.getShaderInfoLog(b),w=r.getShaderInfoLog(C),L=!0,T=!0;!1===r.getProgramParameter(y,r.LINK_STATUS)?(L=!1,console.error("THREE.WebGLProgram: shader error: ",r.getError(),"gl.VALIDATE_STATUS",r.getProgramParameter(y,r.VALIDATE_STATUS),"gl.getProgramInfoLog",M,_,w)):""!==M?console.warn("THREE.WebGLProgram: gl.getProgramInfoLog()",M):""!==_&&""!==w||(T=!1),T&&(this.diagnostics={runnable:L,material:i,programLog:M,vertexShader:{log:_,prefix:f},fragmentShader:{log:w,prefix:p}}),r.deleteShader(b),r.deleteShader(C);var I;this.getUniforms=function(){return void 0===I&&(I=new q(r,y,e)),I};var S;return this.getAttributes=function(){return void 0===S&&(S=et(r,y)),S},this.destroy=function(){r.deleteProgram(y),this.program=void 0},Object.defineProperties(this,{uniforms:{get:function(){return console.warn("THREE.WebGLProgram: .uniforms is now .getUniforms()."),this.getUniforms()}},attributes:{get:function(){return console.warn("THREE.WebGLProgram: .attributes is now .getAttributes()."),this.getAttributes()}}}),this.id=Is++,this.code=t,this.usedTimes=1,this.program=y,this.vertexShader=b,this.fragmentShader=C,this}function ot(e,t){function i(e){var i=e.skeleton,n=i.bones;if(t.floatVertexTextures)return 1024;var r=t.maxVertexUniforms,a=Math.floor((r-20)/4),o=Math.min(a,n.length);return o<n.length?(console.warn("THREE.WebGLRenderer: Skeleton has "+n.length+" bones. This GPU supports "+o+"."),0):o}function n(e,t){var i;return e?e.isTexture?i=e.encoding:e.isWebGLRenderTarget&&(console.warn("THREE.WebGLPrograms.getTextureEncodingFromMap: don't use render targets as textures. Use their .texture property instead."),i=e.texture.encoding):i=is,i===is&&t&&(i=rs),i}var r=[],a={MeshDepthMaterial:"depth",MeshNormalMaterial:"normal",MeshBasicMaterial:"basic",MeshLambertMaterial:"lambert",MeshPhongMaterial:"phong",MeshToonMaterial:"phong",MeshStandardMaterial:"physical",MeshPhysicalMaterial:"physical",LineBasicMaterial:"basic",LineDashedMaterial:"dashed",PointsMaterial:"points"},o=["precision","supportsVertexTextures","map","mapEncoding","envMap","envMapMode","envMapEncoding","lightMap","aoMap","emissiveMap","emissiveMapEncoding","bumpMap","normalMap","displacementMap","specularMap","roughnessMap","metalnessMap","gradientMap","alphaMap","combine","vertexColors","fog","useFog","fogExp","flatShading","sizeAttenuation","positionOffset","sizeAttribute","logarithmicDepthBuffer","skinning","maxBones","useVertexTexture","morphTargets","morphNormals","maxMorphTargets","maxMorphNormals","premultipliedAlpha","numDirLights","numPointLights","numSpotLights","numHemiLights","numRectAreaLights","shadowMapEnabled","shadowMapType","toneMapping","physicallyCorrectLights","alphaTest","doubleSided","flipSided","numClippingPlanes","numClipIntersection","depthPacking","dithering"];this.getParameters=function(r,o,s,l,c,u){var h=a[r.type],d=u.isSkinnedMesh?i(u):0,f=e.getPrecision();null!==r.precision&&(f=t.getMaxPrecision(r.precision))!==r.precision&&console.warn("THREE.WebGLProgram.getParameters:",r.precision,"not supported, using",f,"instead.");var p=e.getRenderTarget();return{shaderID:h,precision:f,supportsVertexTextures:t.vertexTextures,outputEncoding:n(p?p.texture:null,e.gammaOutput),map:!!r.map,mapEncoding:n(r.map,e.gammaInput),envMap:!!r.envMap,envMapMode:r.envMap&&r.envMap.mapping,envMapEncoding:n(r.envMap,e.gammaInput),envMapCubeUV:!!r.envMap&&(r.envMap.mapping===uo||r.envMap.mapping===ho),lightMap:!!r.lightMap,aoMap:!!r.aoMap,emissiveMap:!!r.emissiveMap,emissiveMapEncoding:n(r.emissiveMap,e.gammaInput),bumpMap:!!r.bumpMap,normalMap:!!r.normalMap,displacementMap:!!r.displacementMap,roughnessMap:!!r.roughnessMap,metalnessMap:!!r.metalnessMap,specularMap:!!r.specularMap,alphaMap:!!r.alphaMap,gradientMap:!!r.gradientMap,combine:r.combine,vertexColors:r.vertexColors,fog:!!s,useFog:r.fog,fogExp:s&&s.isFogExp2,flatShading:r.shading===ga,sizeAttenuation:r.sizeAttenuation,positionOffset:r.positionOffset,sizeAttribute:r.sizeAttribute,logarithmicDepthBuffer:t.logarithmicDepthBuffer,skinning:r.skinning&&d>0,maxBones:d,useVertexTexture:t.floatVertexTextures,morphTargets:r.morphTargets,morphNormals:r.morphNormals,maxMorphTargets:e.maxMorphTargets,maxMorphNormals:e.maxMorphNormals,numDirLights:o.directional.length,numPointLights:o.point.length,numSpotLights:o.spot.length,numRectAreaLights:o.rectArea.length,numHemiLights:o.hemi.length,numClippingPlanes:l,numClipIntersection:c,dithering:r.dithering,shadowMapEnabled:e.shadowMap.enabled&&u.receiveShadow&&o.shadows.length>0,shadowMapType:e.shadowMap.type,toneMapping:e.toneMapping,physicallyCorrectLights:e.physicallyCorrectLights,premultipliedAlpha:r.premultipliedAlpha,alphaTest:r.alphaTest,doubleSided:r.side===ma,flipSided:r.side===pa,depthPacking:void 0!==r.depthPacking&&r.depthPacking,idBuffer:r.idBuffer}},this.getProgramCode=function(e,t){var i=[];if(t.shaderID?i.push(t.shaderID):(i.push(e.fragmentShader),i.push(e.vertexShader)),void 0!==e.defines)for(var n in e.defines)i.push(n),i.push(e.defines[n]);for(var r=0;r<o.length;r++)i.push(t[o[r]]);return i.join()},this.acquireProgram=function(t,i,n){for(var a,o=0,s=r.length;o<s;o++){var l=r[o];if(l.code===n){a=l,++a.usedTimes;break}}return void 0===a&&(a=new at(e,n,t,i),r.push(a)),a},this.releaseProgram=function(e){if(0==--e.usedTimes){var t=r.indexOf(e);r[t]=r[r.length-1],r.pop(),e.destroy()}},this.programs=r}function st(e,t,i,n,r,a,o){function s(e,t){if(e.width>t||e.height>t){var i=t/Math.max(e.width,e.height),n=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");n.width=Math.floor(e.width*i),n.height=Math.floor(e.height*i);return n.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,n.width,n.height),console.warn("THREE.WebGLRenderer: image is too big ("+e.width+"x"+e.height+"). Resized to "+n.width+"x"+n.height,e),n}return e}function l(e){return hs.isPowerOfTwo(e.width)&&hs.isPowerOfTwo(e.height)}function c(e){if(e instanceof HTMLImageElement||e instanceof HTMLCanvasElement){var t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas");t.width=hs.nearestPowerOfTwo(e.width),t.height=hs.nearestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,t.width,t.height),console.warn("THREE.WebGLRenderer: image is not power of two ("+e.width+"x"+e.height+"). Resized to "+t.width+"x"+t.height,e),t}return e}function u(e){return e.wrapS!==po||e.wrapT!==po||e.minFilter!==go&&e.minFilter!==Eo}function h(t){return t===go||t===vo||t===yo?e.NEAREST:e.LINEAR}function d(e){var t=e.target;t.removeEventListener("dispose",d),p(t),o.textures--}function f(e){var t=e.target;t.removeEventListener("dispose",f),m(t),o.textures--}function p(t){var i=n.get(t);if(t.image&&i.__image__webglTextureCube)e.deleteTexture(i.__image__webglTextureCube);else{if(void 0===i.__webglInit)return;e.deleteTexture(i.__webglTexture)}n.remove(t)}function m(t){var i=n.get(t),r=n.get(t.texture);if(t){if(void 0!==r.__webglTexture&&e.deleteTexture(r.__webglTexture),t.depthTexture&&t.depthTexture.dispose(),t.isWebGLRenderTargetCube)for(var a=0;a<6;a++)e.deleteFramebuffer(i.__webglFramebuffer[a]),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer[a]);else e.deleteFramebuffer(i.__webglFramebuffer),i.__webglDepthbuffer&&e.deleteRenderbuffer(i.__webglDepthbuffer);n.remove(t.texture),n.remove(t)}}function g(t,r){var a=n.get(t);if(t.version>0&&a.__version!==t.version){var o=t.image;if(void 0===o)console.warn("THREE.WebGLRenderer: Texture marked for update but image is undefined",t);else{if(!1!==o.complete)return void x(a,t,r);console.warn("THREE.WebGLRenderer: Texture marked for update but image is incomplete",t)}}i.activeTexture(e.TEXTURE0+r),i.bindTexture(e.TEXTURE_2D,a.__webglTexture)}function v(t,c){var u=n.get(t);if(6===t.image.length)if(t.version>0&&u.__version!==t.version){u.__image__webglTextureCube||(t.addEventListener("dispose",d),u.__image__webglTextureCube=e.createTexture(),o.textures++),i.activeTexture(e.TEXTURE0+c),i.bindTexture(e.TEXTURE_CUBE_MAP,u.__image__webglTextureCube),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,t.flipY);for(var h=t&&t.isCompressedTexture,f=t.image[0]&&t.image[0].isDataTexture,p=[],m=0;m<6;m++)p[m]=h||f?f?t.image[m].image:t.image[m]:s(t.image[m],r.maxCubemapSize);var g=p[0],v=l(g),y=a(t.format),x=a(t.type);E(e.TEXTURE_CUBE_MAP,t,v);for(var m=0;m<6;m++)if(h)for(var b,C=p[m].mipmaps,M=0,_=C.length;M<_;M++)b=C[M],t.format!==Po&&t.format!==Bo?i.getCompressedTextureFormats().indexOf(y)>-1?i.compressedTexImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,M,y,b.width,b.height,0,b.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .setTextureCube()"):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,M,y,b.width,b.height,0,y,x,b.data);else f?i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,p[m].width,p[m].height,0,y,x,p[m].data):i.texImage2D(e.TEXTURE_CUBE_MAP_POSITIVE_X+m,0,y,y,x,p[m]);t.generateMipmaps&&v&&e.generateMipmap(e.TEXTURE_CUBE_MAP),u.__version=t.version,t.onUpdate&&t.onUpdate(t)}else i.activeTexture(e.TEXTURE0+c),i.bindTexture(e.TEXTURE_CUBE_MAP,u.__image__webglTextureCube)}function y(t,r){i.activeTexture(e.TEXTURE0+r),i.bindTexture(e.TEXTURE_CUBE_MAP,n.get(t).__webglTexture)}function E(i,o,s){var l;if(s?(e.texParameteri(i,e.TEXTURE_WRAP_S,a(o.wrapS)),e.texParameteri(i,e.TEXTURE_WRAP_T,a(o.wrapT)),e.texParameteri(i,e.TEXTURE_MAG_FILTER,a(o.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,a(o.minFilter))):(e.texParameteri(i,e.TEXTURE_WRAP_S,e.CLAMP_TO_EDGE),e.texParameteri(i,e.TEXTURE_WRAP_T,e.CLAMP_TO_EDGE),o.wrapS===po&&o.wrapT===po||console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.wrapS and Texture.wrapT should be set to THREE.ClampToEdgeWrapping.",o),e.texParameteri(i,e.TEXTURE_MAG_FILTER,h(o.magFilter)),e.texParameteri(i,e.TEXTURE_MIN_FILTER,h(o.minFilter)),o.minFilter!==go&&o.minFilter!==Eo&&console.warn("THREE.WebGLRenderer: Texture is not power of two. Texture.minFilter should be set to THREE.NearestFilter or THREE.LinearFilter.",o)),l=t.get("EXT_texture_filter_anisotropic")){if(o.type===Io&&null===t.get("OES_texture_float_linear"))return;if(o.type===So&&null===t.get("OES_texture_half_float_linear"))return;(o.anisotropy>1||n.get(o).__currentAnisotropy)&&(e.texParameterf(i,l.TEXTURE_MAX_ANISOTROPY_EXT,Math.min(o.anisotropy,r.getMaxAnisotropy())),n.get(o).__currentAnisotropy=o.anisotropy)}}function x(t,n,h){void 0===t.__webglInit&&(t.__webglInit=!0,n.addEventListener("dispose",d),t.__webglTexture=e.createTexture(),o.textures++),i.activeTexture(e.TEXTURE0+h),i.bindTexture(e.TEXTURE_2D,t.__webglTexture),e.pixelStorei(e.UNPACK_FLIP_Y_WEBGL,n.flipY),e.pixelStorei(e.UNPACK_PREMULTIPLY_ALPHA_WEBGL,n.premultiplyAlpha),e.pixelStorei(e.UNPACK_ALIGNMENT,n.unpackAlignment);var f=s(n.image,r.maxTextureSize);u(n)&&!1===l(f)&&(f=c(f));var p=l(f),m=a(n.format),g=a(n.type);E(e.TEXTURE_2D,n,p);var v,y=n.mipmaps;if(n.isDepthTexture){var x=e.DEPTH_COMPONENT;if(n.type===Io){if(!I)throw new Error("Float Depth Texture only supported in WebGL2.0");x=e.DEPTH_COMPONENT32F}else I&&(x=e.DEPTH_COMPONENT16);n.format===Ho&&x===e.DEPTH_COMPONENT&&n.type!==wo&&n.type!==To&&(console.warn("THREE.WebGLRenderer: Use UnsignedShortType or UnsignedIntType for DepthFormat DepthTexture."),n.type=wo,g=a(n.type)),n.format===Go&&(x=e.DEPTH_STENCIL,n.type!==Ao&&(console.warn("THREE.WebGLRenderer: Use UnsignedInt248Type for DepthStencilFormat DepthTexture."),n.type=Ao,g=a(n.type))),i.texImage2D(e.TEXTURE_2D,0,x,f.width,f.height,0,m,g,null)}else if(n.isDataTexture)if(y.length>0&&p){for(var b=0,C=y.length;b<C;b++)v=y[b],i.texImage2D(e.TEXTURE_2D,b,m,v.width,v.height,0,m,g,v.data);n.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,m,f.width,f.height,0,m,g,f.data);else if(n.isCompressedTexture)for(var b=0,C=y.length;b<C;b++)v=y[b],n.format!==Po&&n.format!==Bo?i.getCompressedTextureFormats().indexOf(m)>-1?i.compressedTexImage2D(e.TEXTURE_2D,b,m,v.width,v.height,0,v.data):console.warn("THREE.WebGLRenderer: Attempt to load unsupported compressed texture format in .uploadTexture()"):i.texImage2D(e.TEXTURE_2D,b,m,v.width,v.height,0,m,g,v.data);else if(y.length>0&&p){for(var b=0,C=y.length;b<C;b++)v=y[b],i.texImage2D(e.TEXTURE_2D,b,m,m,g,v);n.generateMipmaps=!1}else i.texImage2D(e.TEXTURE_2D,0,m,m,g,f);n.generateMipmaps&&p&&e.generateMipmap(e.TEXTURE_2D),t.__version=n.version,n.onUpdate&&n.onUpdate(n)}function b(t,r,o,s){var l=a(r.texture.format),c=a(r.texture.type);i.texImage2D(s,0,l,r.width,r.height,0,l,c,null),e.bindFramebuffer(e.FRAMEBUFFER,t),e.framebufferTexture2D(e.FRAMEBUFFER,o,s,n.get(r.texture).__webglTexture,0),e.bindFramebuffer(e.FRAMEBUFFER,null)}function C(t,i){e.bindRenderbuffer(e.RENDERBUFFER,t),i.depthBuffer&&!i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_COMPONENT16,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.RENDERBUFFER,t)):i.depthBuffer&&i.stencilBuffer?(e.renderbufferStorage(e.RENDERBUFFER,e.DEPTH_STENCIL,i.width,i.height),e.framebufferRenderbuffer(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.RENDERBUFFER,t)):e.renderbufferStorage(e.RENDERBUFFER,e.RGBA4,i.width,i.height),e.bindRenderbuffer(e.RENDERBUFFER,null)}function M(t,i){if(i&&i.isWebGLRenderTargetCube)throw new Error("Depth Texture with cube render targets is not supported!");if(e.bindFramebuffer(e.FRAMEBUFFER,t),!i.depthTexture||!i.depthTexture.isDepthTexture)throw new Error("renderTarget.depthTexture must be an instance of THREE.DepthTexture");n.get(i.depthTexture).__webglTexture&&i.depthTexture.image.width===i.width&&i.depthTexture.image.height===i.height||(i.depthTexture.image.width=i.width,i.depthTexture.image.height=i.height,i.depthTexture.needsUpdate=!0),g(i.depthTexture,0);var r=n.get(i.depthTexture).__webglTexture;if(i.depthTexture.format===Ho)e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_ATTACHMENT,e.TEXTURE_2D,r,0);else{if(i.depthTexture.format!==Go)throw new Error("Unknown depthTexture format");e.framebufferTexture2D(e.FRAMEBUFFER,e.DEPTH_STENCIL_ATTACHMENT,e.TEXTURE_2D,r,0)}}function _(t){var i=n.get(t),r=!0===t.isWebGLRenderTargetCube;if(t.depthTexture){if(r)throw new Error("target.depthTexture not supported in Cube render targets");M(i.__webglFramebuffer,t)}else if(r){i.__webglDepthbuffer=[];for(var a=0;a<6;a++)e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer[a]),i.__webglDepthbuffer[a]=e.createRenderbuffer(),C(i.__webglDepthbuffer[a],t)}else e.bindFramebuffer(e.FRAMEBUFFER,i.__webglFramebuffer),i.__webglDepthbuffer=e.createRenderbuffer(),C(i.__webglDepthbuffer,t);e.bindFramebuffer(e.FRAMEBUFFER,null)}function w(t){var r=n.get(t),a=n.get(t.texture);t.addEventListener("dispose",f),a.__webglTexture=e.createTexture(),o.textures++;var s=!0===t.isWebGLRenderTargetCube,c=l(t);if(s){r.__webglFramebuffer=[];for(var u=0;u<6;u++)r.__webglFramebuffer[u]=e.createFramebuffer()}else r.__webglFramebuffer=e.createFramebuffer();if(s){i.bindTexture(e.TEXTURE_CUBE_MAP,a.__webglTexture),E(e.TEXTURE_CUBE_MAP,t.texture,c);for(var u=0;u<6;u++)b(r.__webglFramebuffer[u],t,e.COLOR_ATTACHMENT0,e.TEXTURE_CUBE_MAP_POSITIVE_X+u);t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_CUBE_MAP),i.bindTexture(e.TEXTURE_CUBE_MAP,null)}else i.bindTexture(e.TEXTURE_2D,a.__webglTexture),E(e.TEXTURE_2D,t.texture,c),b(r.__webglFramebuffer,t,e.COLOR_ATTACHMENT0,e.TEXTURE_2D),t.texture.generateMipmaps&&c&&e.generateMipmap(e.TEXTURE_2D),i.bindTexture(e.TEXTURE_2D,null);t.depthBuffer&&_(t)}function L(i){var r=t.get("WEBGL_draw_buffers"),s=i[0],l=!1;if(s&&!s.__webglFramebuffer){var c=n.get(s);n.get(s.texture);s.__webglFramebuffer=c.__webglFramebuffer=e.createFramebuffer(),void 0===s.depthBuffer&&(s.depthBuffer=!0),void 0===s.stencilBuffer&&(s.stencilBuffer=!0),_(s),l=!0}e.bindFramebuffer(e.FRAMEBUFFER,s.__webglFramebuffer);var u;for(u=0;u<i.length;u++){var h=i[u];if(!h.__webglTexture){var d=THREE.Math.isPowerOfTwo(h.width)&&THREE.Math.isPowerOfTwo(h.height),p=a(h.texture.format),m=a(h.texture.type);h.addEventListener("dispose",f);n.get(h.texture).__webglTexture=h.__webglTexture=e.createTexture(),o.textures++,e.bindTexture(e.TEXTURE_2D,h.__webglTexture),E(e.TEXTURE_2D,h.texture,d),e.texImage2D(e.TEXTURE_2D,0,p,h.width,h.height,0,p,m,null),d&&h.generateMipmaps&&e.generateMipmap(e.TEXTURE_2D)}e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL+u,e.TEXTURE_2D,h.__webglTexture,0)}for(var g=e.getParameter(r.MAX_COLOR_ATTACHMENTS_WEBGL);u<g;)e.framebufferTexture2D(e.FRAMEBUFFER,r.COLOR_ATTACHMENT0_WEBGL+u,e.TEXTURE_2D,null,0),u++;var v=[r.COLOR_ATTACHMENT0_WEBGL];for(u=1;u<i.length;u++)v.push(r.COLOR_ATTACHMENT0_WEBGL+u);r.drawBuffersWEBGL(v),l&&(e.bindTexture(e.TEXTURE_2D,null),e.bindRenderbuffer(e.RENDERBUFFER,null),e.bindFramebuffer(e.FRAMEBUFFER,null))}function T(t){function r(t){var r=t.texture;if(r.generateMipmaps&&l(t)&&r.minFilter!==go&&r.minFilter!==Eo){var a=t&&t.isWebGLRenderTargetCube?e.TEXTURE_CUBE_MAP:e.TEXTURE_2D,o=n.get(r).__webglTexture;i.bindTexture(a,o),e.generateMipmap(a),i.bindTexture(a,null)}}if(Array.isArray(t))for(var a=0;a<t.length;a++)r(t[a]);else r(t)}var I="undefined"!=typeof WebGL2RenderingContext&&e instanceof WebGL2RenderingContext;this.setTexture2D=g,this.setTextureCube=v,this.setTextureCubeDynamic=y,this.setupRenderTarget=w,this.setupMultiRenderTarget=L,this.updateRenderTargetMipmap=T}function lt(){function e(e){var t=e.uuid,i=n[t];return void 0===i&&(i={},n[t]=i),i}function t(e){delete n[e.uuid]}function i(){n={}}var n={};return{get:e,remove:t,clear:i}}function ct(e,t,i){function n(){var t=!1,i=new r,n=null,a=new r;return{setMask:function(i){n===i||t||(e.colorMask(i,i,i,i),n=i)},setLocked:function(e){t=e},setClear:function(t,n,r,o,s){!0===s&&(t*=o,n*=o,r*=o),i.set(t,n,r,o),!1===a.equals(i)&&(e.clearColor(t,n,r,o),a.copy(i))},reset:function(){t=!1,n=null,a.set(0,0,0,1)}}}function a(){var t=!1,i=null,n=null,r=null;return{setTest:function(t){t?f(e.DEPTH_TEST):p(e.DEPTH_TEST)},setMask:function(n){i===n||t||(e.depthMask(n),i=n)},setFunc:function(t){if(n!==t){if(t)switch(t){case za:e.depthFunc(e.NEVER);break;case Wa:e.depthFunc(e.ALWAYS);break;case qa:e.depthFunc(e.LESS);break;case ja:e.depthFunc(e.LEQUAL);break;case Xa:e.depthFunc(e.EQUAL);break;case Ya:e.depthFunc(e.GEQUAL);break;case Za:e.depthFunc(e.GREATER);break;case Ka:e.depthFunc(e.NOTEQUAL);break;default:e.depthFunc(e.LEQUAL)}else e.depthFunc(e.LEQUAL);n=t}},setLocked:function(e){t=e},setClear:function(t){r!==t&&(e.clearDepth(t),r=t)},reset:function(){t=!1,i=null,n=null,r=null}}}function o(){var t=!1,i=null,n=null,r=null,a=null,o=null,s=null,l=null,c=null;return{setTest:function(t){t?f(e.STENCIL_TEST):p(e.STENCIL_TEST)},setMask:function(n){i===n||t||(e.stencilMask(n),i=n)},setFunc:function(t,i,o){n===t&&r===i&&a===o||(e.stencilFunc(t,i,o),n=t,r=i,a=o)},setOp:function(t,i,n){o===t&&s===i&&l===n||(e.stencilOp(t,i,n),o=t,s=i,l=n)},setLocked:function(e){t=e},setClear:function(t){c!==t&&(e.clearStencil(t),c=t)},reset:function(){t=!1,i=null,n=null,r=null,a=null,o=null,s=null,l=null,c=null}}}function s(t,i,n){var r=new Uint8Array(4),a=e.createTexture();e.bindTexture(t,a),e.texParameteri(t,e.TEXTURE_MIN_FILTER,e.NEAREST),e.texParameteri(t,e.TEXTURE_MAG_FILTER,e.NEAREST);for(var o=0;o<n;o++)e.texImage2D(i+o,0,e.RGBA,1,1,0,e.RGBA,e.UNSIGNED_BYTE,r);return a}function l(){D.setClear(0,0,0,1),R.setClear(1),A.setClear(0),f(e.DEPTH_TEST),R.setFunc(ja),y(!1),E(la),f(e.CULL_FACE),f(e.BLEND),g(Ca)}function c(){for(var e=0,t=B.length;e<t;e++)B[e]=0}function u(i){if(B[i]=1,0===P[i]&&(e.enableVertexAttribArray(i),P[i]=1),0!==N[i]){t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(i,0),N[i]=0}}function h(i,n){if(B[i]=1,0===P[i]&&(e.enableVertexAttribArray(i),P[i]=1),N[i]!==n){t.get("ANGLE_instanced_arrays").vertexAttribDivisorANGLE(i,n),N[i]=n}}function d(){for(var t=0,i=P.length;t!==i;++t)P[t]!==B[t]&&(e.disableVertexAttribArray(t),P[t]=0)}function f(t){!0!==k[t]&&(e.enable(t),k[t]=!0)}function p(t){!1!==k[t]&&(e.disable(t),k[t]=!1)}function m(){if(null===F&&(F=[],t.get("WEBGL_compressed_texture_pvrtc")||t.get("WEBGL_compressed_texture_s3tc")||t.get("WEBGL_compressed_texture_etc1")))for(var i=e.getParameter(e.COMPRESSED_TEXTURE_FORMATS),n=0;n<i.length;n++)F.push(i[n]);return F}function g(t,n,r,a,o,s,l,c){t!==ba?f(e.BLEND):p(e.BLEND),t===H&&c===X||(t===Ma?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE,e.ONE,e.ONE)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.SRC_ALPHA,e.ONE)):t===_a?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.ZERO,e.ONE_MINUS_SRC_COLOR,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.ONE_MINUS_SRC_COLOR)):t===wa?c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ZERO,e.SRC_COLOR,e.ZERO,e.SRC_ALPHA)):(e.blendEquation(e.FUNC_ADD),e.blendFunc(e.ZERO,e.SRC_COLOR)):c?(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.ONE,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)):(e.blendEquationSeparate(e.FUNC_ADD,e.FUNC_ADD),e.blendFuncSeparate(e.SRC_ALPHA,e.ONE_MINUS_SRC_ALPHA,e.ONE,e.ONE_MINUS_SRC_ALPHA)),H=t,X=c),t===La?(o=o||n,s=s||r,l=l||a,n===G&&o===W||(e.blendEquationSeparate(i(n),i(o)),G=n,W=o),r===V&&a===z&&s===q&&l===j||(e.blendFuncSeparate(i(r),i(a),i(s),i(l)),V=r,z=a,q=s,j=l)):(G=null,V=null,z=null,W=null,q=null,j=null)}function v(t){t.side===ma?p(e.CULL_FACE):f(e.CULL_FACE),y(t.side===pa),!0===t.transparent?g(t.blending,t.blendEquation,t.blendSrc,t.blendDst,t.blendEquationAlpha,t.blendSrcAlpha,t.blendDstAlpha,t.premultipliedAlpha):g(ba),R.setFunc(t.depthFunc),R.setTest(t.depthTest),R.setMask(t.depthWrite),D.setMask(t.colorWrite),b(t.polygonOffset,t.polygonOffsetFactor,t.polygonOffsetUnits)}function y(t){Y!==t&&(t?e.frontFace(e.CW):e.frontFace(e.CCW),Y=t)}function E(t){t!==sa?(f(e.CULL_FACE),t!==Z&&(t===la?e.cullFace(e.BACK):t===ca?e.cullFace(e.FRONT):e.cullFace(e.FRONT_AND_BACK))):p(e.CULL_FACE),Z=t}function x(t){t!==K&&(ie&&e.lineWidth(t),K=t)}function b(t,i,n){t?(f(e.POLYGON_OFFSET_FILL),Q===i&&J===n||(e.polygonOffset(i,n),Q=i,J=n)):p(e.POLYGON_OFFSET_FILL)}function C(){return $}function M(t){$=t,t?f(e.SCISSOR_TEST):p(e.SCISSOR_TEST)}function _(t){void 0===t&&(t=e.TEXTURE0+ee-1),ne!==t&&(e.activeTexture(t),ne=t)}function w(t,i){null===ne&&_();var n=re[ne];void 0===n&&(n={type:void 0,texture:void 0},re[ne]=n),n.type===t&&n.texture===i||(e.bindTexture(t,i||se[t]),n.type=t,n.texture=i)}function L(){try{e.compressedTexImage2D.apply(e,arguments)}catch(e){console.error(e)}}function T(){try{e.texImage2D.apply(e,arguments)}catch(e){console.error(e)}}function I(t){!1===ae.equals(t)&&(e.scissor(t.x,t.y,t.z,t.w),ae.copy(t))}function S(t){!1===oe.equals(t)&&(e.viewport(t.x,t.y,t.z,t.w),oe.copy(t))}function O(){for(var t=0;t<P.length;t++)1===P[t]&&(e.disableVertexAttribArray(t),P[t]=0);k={},F=null,ne=null,re={},H=null,Y=null,Z=null,D.reset(),R.reset(),A.reset()}var D=new n,R=new a,A=new o,U=e.getParameter(e.MAX_VERTEX_ATTRIBS),B=new Uint8Array(U),P=new Uint8Array(U),N=new Uint8Array(U),k={},F=null,H=null,G=null,V=null,z=null,W=null,q=null,j=null,X=!1,Y=null,Z=null,K=null,Q=null,J=null,$=null,ee=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),te=parseFloat(/^WebGL\ ([0-9])/.exec(e.getParameter(e.VERSION))[1]),ie=parseFloat(te)>=1,ne=null,re={},ae=new r,oe=new r,se={};return se[e.TEXTURE_2D]=s(e.TEXTURE_2D,e.TEXTURE_2D,1),se[e.TEXTURE_CUBE_MAP]=s(e.TEXTURE_CUBE_MAP,e.TEXTURE_CUBE_MAP_POSITIVE_X,6),{buffers:{color:D,depth:R,stencil:A},init:l,initAttributes:c,enableAttribute:u,enableAttributeAndDivisor:h,disableUnusedAttributes:d,enable:f,disable:p,getCompressedTextureFormats:m,setBlending:g,setMaterial:v,setFlipSided:y,setCullFace:E,setLineWidth:x,setPolygonOffset:b,getScissorTest:C,setScissorTest:M,activeTexture:_,bindTexture:w,compressedTexImage2D:L,texImage2D:T,scissor:I,viewport:S,reset:O}}function ut(e,t,i){function n(){if(void 0!==a)return a;var i=t.get("EXT_texture_filter_anisotropic");return a=null!==i?e.getParameter(i.MAX_TEXTURE_MAX_ANISOTROPY_EXT):0}function r(t){if("highp"===t){if(e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.HIGH_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.HIGH_FLOAT).precision>0)return"highp";t="mediump"}return"mediump"===t&&e.getShaderPrecisionFormat(e.VERTEX_SHADER,e.MEDIUM_FLOAT).precision>0&&e.getShaderPrecisionFormat(e.FRAGMENT_SHADER,e.MEDIUM_FLOAT).precision>0?"mediump":"lowp"}var a,o=void 0!==i.precision?i.precision:"highp",s=r(o);s!==o&&(console.warn("THREE.WebGLRenderer:",o,"not supported, using",s,"instead."),o=s);var l=!0===i.logarithmicDepthBuffer&&!!t.get("EXT_frag_depth"),c=e.getParameter(e.MAX_TEXTURE_IMAGE_UNITS),u=e.getParameter(e.MAX_VERTEX_TEXTURE_IMAGE_UNITS),h=e.getParameter(e.MAX_TEXTURE_SIZE),d=e.getParameter(e.MAX_CUBE_MAP_TEXTURE_SIZE),f=e.getParameter(e.MAX_VERTEX_ATTRIBS),p=e.getParameter(e.MAX_VERTEX_UNIFORM_VECTORS),m=e.getParameter(e.MAX_VARYING_VECTORS),g=e.getParameter(e.MAX_FRAGMENT_UNIFORM_VECTORS),v=u>0,y=!!t.get("OES_texture_float");return{getMaxAnisotropy:n,getMaxPrecision:r,precision:o,logarithmicDepthBuffer:l,maxTextures:c,maxVertexTextures:u,maxTextureSize:h,maxCubemapSize:d,maxAttributes:f,maxVertexUniforms:p,maxVaryings:m,maxFragmentUniforms:g,vertexTextures:v,floatFragmentTextures:y,floatVertexTextures:v&&y}}function ht(e){var t={};return{get:function(i){if(void 0!==t[i])return t[i];var n;switch(i){case"WEBGL_depth_texture":n=e.getExtension("WEBGL_depth_texture")||e.getExtension("MOZ_WEBGL_depth_texture")||e.getExtension("WEBKIT_WEBGL_depth_texture");break;case"EXT_texture_filter_anisotropic":
n=e.getExtension("EXT_texture_filter_anisotropic")||e.getExtension("MOZ_EXT_texture_filter_anisotropic")||e.getExtension("WEBKIT_EXT_texture_filter_anisotropic");break;case"WEBGL_compressed_texture_s3tc":n=e.getExtension("WEBGL_compressed_texture_s3tc")||e.getExtension("MOZ_WEBGL_compressed_texture_s3tc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_s3tc");break;case"WEBGL_compressed_texture_pvrtc":n=e.getExtension("WEBGL_compressed_texture_pvrtc")||e.getExtension("WEBKIT_WEBGL_compressed_texture_pvrtc");break;case"WEBGL_compressed_texture_etc1":n=e.getExtension("WEBGL_compressed_texture_etc1");break;default:n=e.getExtension(i)}return null===n&&console.warn("THREE.WebGLRenderer: "+i+" extension not supported."),t[i]=n,n}}}function dt(){function e(){c.value!==n&&(c.value=n,c.needsUpdate=r>0),i.numPlanes=r,i.numIntersection=0}function t(e,t,n,r){var a=null!==e?e.length:0,o=null;if(0!==a){if(o=c.value,!0!==r||null===o){var u=n+4*a,h=t.matrixWorldInverse;l.getNormalMatrix(h),(null===o||o.length<u)&&(o=new Float32Array(u));for(var d=0,f=n;d!==a;++d,f+=4)s.copy(e[d]).applyMatrix4(h,l),s.normal.toArray(o,f),o[f+3]=s.constant}c.value=o,c.needsUpdate=!0}return i.numPlanes=a,o}var i=this,n=null,r=0,a=!1,o=!1,s=new ie,l=new te,c={value:null,needsUpdate:!1};this.uniform=c,this.numPlanes=0,this.numIntersection=0,this.init=function(e,i,o){var s=0!==e.length||i||0!==r||a;return a=i,n=t(e,o,0),r=e.length,s},this.beginShadows=function(){o=!0,t(null)},this.endShadows=function(){o=!1,e()},this.setState=function(i,s,l,u,h,d){if(!a||null===i||0===i.length||o&&!l)o?t(null):e();else{var f=o?0:r,p=4*f,m=h.clippingState||null;c.value=m,m=t(i,u,p,d);for(var g=0;g!==p;++g)m[g]=n[g];h.clippingState=m,this.numIntersection=s?this.numPlanes:0,this.numPlanes+=f}}}function ft(e){function t(){return null===ae?Ee:1}function i(){Qe.init(),Qe.scissor(ue.copy(xe).multiplyScalar(Ee)),Qe.viewport(fe.copy(Ce).multiplyScalar(Ee)),Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)}function n(){ie=null,ce=null,le="",se=-1,Qe.reset()}function a(e){e.preventDefault(),n(),i(),Je.clear(),it.clear()}function o(e){var t=e.target;t.removeEventListener("dispose",o),s(t)}function s(e){h(e),Je.remove(e)}function h(e){var t=Je.get(e).program;e.program=void 0,void 0!==t&&nt.releaseProgram(t)}function d(e,t,i){e.render(function(e){te.renderBufferImmediate(e,t,i)})}function f(e,t){return Math.abs(t[0])-Math.abs(e[0])}function p(e,t,i,n){if(i&&i.isInstancedBufferGeometry&&null===Ze.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===n&&(n=0),Qe.initAttributes();var r=i.attributes,a=t.getAttributes(),o=e.defaultAttributeValues;for(var s in a){var l=a[s];if(l>=0){var c=r[s];if(void 0!==c){var u=c.normalized,h=c.itemSize,d=et.get(c),f=d.buffer,p=d.type,m=d.bytesPerElement;if(c.isInterleavedBufferAttribute){var g=c.data,v=g.stride,y=c.offset;g&&g.isInstancedInterleavedBuffer?(Qe.enableAttributeAndDivisor(l,g.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=g.meshPerAttribute*g.count)):Qe.enableAttribute(l),Xe.bindBuffer(Xe.ARRAY_BUFFER,f),Xe.vertexAttribPointer(l,h,p,u,v*m,(n*v+y)*m)}else c.isInstancedBufferAttribute?(Qe.enableAttributeAndDivisor(l,c.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=c.meshPerAttribute*c.count)):Qe.enableAttribute(l),Xe.bindBuffer(Xe.ARRAY_BUFFER,f),Xe.vertexAttribPointer(l,h,p,u,0,n*h*m)}else if(void 0!==o){var E=o[s];if(void 0!==E)switch(E.length){case 2:Xe.vertexAttrib2fv(l,E);break;case 3:Xe.vertexAttrib3fv(l,E);break;case 4:Xe.vertexAttrib4fv(l,E);break;default:Xe.vertexAttrib1fv(l,E)}}}}Qe.disableUnusedAttributes()}function m(e,t,i){if(e.visible&&!1!==e.alive){if(e.layers.test(t.layers))if(e.isLight)W.push(e);else if(e.isSprite)e.frustumCulled&&!Me.intersectsSprite(e)||J.push(e);else if(e.isLensFlare)$.push(e);else if(e.isImmediateRenderObject)i&&De.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Se),X.push(e,null,e.material,De.z,null);else if((e.isMesh||e.isLine||e.isPoints)&&(e.isSkinnedMesh&&e.skeleton.update(),!e.frustumCulled||Me.intersectsObject(e))){i&&De.setFromMatrixPosition(e.matrixWorld).applyMatrix4(Se);var n=it.update(e),r=e.material;if(Array.isArray(r))for(var a=n.groups,o=0,s=a.length;o<s;o++){var l=a[o],c=l.materialIndex<0?r[0]:r[l.materialIndex];c&&c.visible&&X.push(e,n,c,De.z,l)}else r.visible&&X.push(e,n,r,De.z,null)}for(var u=e.children,o=0,s=u.length;o<s;o++)m(u[o],t,i)}}function g(e,t,i,n){for(var r=0,a=e.length;r<a;r++){var o=e[r],s=o.object,l=o.geometry,c=o.group;if(t.backFrontStencil){var u=o.material;if(n&&u.side==THREE.DoubleSide)continue;if("LineSegments"==s.type)continue;var h=n;if(u.defines&&u.defines.hasOwnProperty("USE_INSTANCE")){h=n.side==THREE.FrontSide?t.frontInstanceMaterial:t.backInstanceMaterial}else if(c&&c.materialIndex>=0)continue}else{var h=void 0===n?o.material:n;c&&c.materialIndex<0&&(c.materialIndex=0)}if(s.onBeforeRender(te,t,i,l,h,c),i.isArrayCamera&&i.enabled)for(var d=i.cameras,f=0,p=d.length;f<p;f++){var m=d[f],g=m.bounds;te.setViewport(g.x*ve*Ee,g.y*ye*Ee,g.z*ve*Ee,g.w*ye*Ee),te.setScissor(g.x*ve*Ee,g.y*ye*Ee,g.z*ve*Ee,g.w*ye*Ee),te.setScissorTest(!0),v(s,t,m,l,h,c)}else v(s,t,i,l,h,c);s.onAfterRender(te,t,i,l,h,c)}}function v(e,t,i,n,r,a){if(e.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,e.matrixWorld),e.normalMatrix.getNormalMatrix(e.modelViewMatrix),e.isImmediateRenderObject){Qe.setMaterial(r);var o=E(i,t.fog,r,e);le="",d(e,o,r)}else te.renderBufferDirect(i,t.fog,n,r,e,a)}function y(e,t,i){var n=Je.get(e),r=nt.getParameters(e,ke,t,_e.numPlanes,_e.numIntersection,i),a=nt.getProgramCode(e,r),s=n.program,l=!0;if(void 0===s)e.addEventListener("dispose",o);else if(s.code!==a)h(e);else{if(void 0!==r.shaderID)return;l=!1}if(l){if(r.shaderID){var c=_s[r.shaderID];n.__webglShader={name:e.type,uniforms:Cs.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else n.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=n.__webglShader,s=nt.acquireProgram(e,r,a),n.program=s,e.program=s}var u=s.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<te.maxMorphTargets;d++)u["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var d=0;d<te.maxMorphNormals;d++)u["morphNormal"+d]>=0&&e.numSupportedMorphNormals++}var f=n.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=_e.numPlanes,n.numIntersection=_e.numIntersection,f.clippingPlanes=_e.uniform),n.fog=t,n.lightsHash=ke.hash,e.lights&&(f.ambientLightColor.value=ke.ambient,f.directionalLights.value=ke.directional,f.spotLights.value=ke.spot,f.rectAreaLights.value=ke.rectArea,f.pointLights.value=ke.point,f.hemisphereLights.value=ke.hemi,f.directionalShadowMap.value=ke.directionalShadowMap,f.directionalShadowMatrix.value=ke.directionalShadowMatrix,f.spotShadowMap.value=ke.spotShadowMap,f.spotShadowMatrix.value=ke.spotShadowMatrix,f.pointShadowMap.value=ke.pointShadowMap,f.pointShadowMatrix.value=ke.pointShadowMatrix);var p=n.program.getUniforms(),m=q.seqWithValue(p.seq,f);n.uniformsList=m}function E(e,t,i,n){pe=0;var r=Je.get(i);if(we&&(Le||e!==ce)){var a=e===ce&&i.id===se;_e.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,e,r,a)}!1===i.needsUpdate&&(void 0===r.program?i.needsUpdate=!0:i.fog&&r.fog!==t?i.needsUpdate=!0:i.lights&&r.lightsHash!==ke.hash?i.needsUpdate=!0:void 0===r.numClippingPlanes||r.numClippingPlanes===_e.numPlanes&&r.numIntersection===_e.numIntersection||(i.needsUpdate=!0)),i.needsUpdate&&(y(i,t,n),i.needsUpdate=!1);var o=!1,s=!1,l=!1,c=r.program,h=c.getUniforms(),d=r.__webglShader.uniforms;if(c.id!==ie&&(Xe.useProgram(c.program),ie=c.id,o=!0,s=!0,l=!0),i.id!==se&&(se=i.id,s=!0),o||e!==ce){if(h.setValue(Xe,"projectionMatrix",e.projectionMatrix),Ke.logarithmicDepthBuffer&&h.setValue(Xe,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==ce&&(ce=e,s=!0,l=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap){var f=h.map.cameraPosition;void 0!==f&&f.setValue(Xe,De.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&h.setValue(Xe,"viewMatrix",e.matrixWorldInverse),h.setValue(Xe,"toneMappingExposure",te.toneMappingExposure),h.setValue(Xe,"toneMappingWhitePoint",te.toneMappingWhitePoint)}if(i.skinning){h.setOptional(Xe,n,"bindMatrix"),h.setOptional(Xe,n,"bindMatrixInverse");var p=n.skeleton;if(p){var m=p.bones;if(Ke.floatVertexTextures){if(void 0===p.boneTexture){var g=Math.sqrt(4*m.length);g=hs.nextPowerOfTwo(Math.ceil(g)),g=Math.max(g,4);var v=new Float32Array(g*g*4);v.set(p.boneMatrices);var E=new u(v,g,g,Po,Io);p.boneMatrices=v,p.boneTexture=E,p.boneTextureSize=g}h.setValue(Xe,"boneTexture",p.boneTexture),h.setValue(Xe,"boneTextureSize",p.boneTextureSize)}else h.setOptional(Xe,p,"boneMatrices")}}if(s&&(i.lights&&D(d,l),t&&i.fog&&_(d,t),(i.isMeshBasicMaterial||i.isMeshLambertMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.isMeshNormalMaterial||i.isMeshDepthMaterial)&&x(d,i),i.isLineBasicMaterial?b(d,i):i.isLineDashedMaterial?(b(d,i),C(d,i)):i.isPointsMaterial?M(d,i):i.isMeshLambertMaterial?w(d,i):i.isMeshToonMaterial?T(d,i):i.isMeshPhongMaterial?L(d,i):i.isMeshPhysicalMaterial?S(d,i):i.isMeshStandardMaterial?I(d,i):i.isMeshDepthMaterial?i.displacementMap&&(d.displacementMap.value=i.displacementMap,d.displacementScale.value=i.displacementScale,d.displacementBias.value=i.displacementBias):i.isMeshNormalMaterial&&O(d,i),void 0!==d.ltcMat&&(d.ltcMat.value=bs.LTC_MAT_TEXTURE),void 0!==d.ltcMag&&(d.ltcMag.value=bs.LTC_MAG_TEXTURE),q.upload(Xe,r.uniformsList,d,te)),h.map.objId){var R=n.originalId;ee.set((R>>16&255)/255,(R>>8&255)/255,(255&R)/255),h.setValue(Xe,"objId",ee)}return h.setValue(Xe,"modelViewMatrix",n.modelViewMatrix),h.setValue(Xe,"normalMatrix",n.normalMatrix),h.setValue(Xe,"modelMatrix",n.matrixWorld),c}function x(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var i;if(t.map?i=t.map:t.specularMap?i=t.specularMap:t.displacementMap?i=t.displacementMap:t.normalMap?i=t.normalMap:t.bumpMap?i=t.bumpMap:t.roughnessMap?i=t.roughnessMap:t.metalnessMap?i=t.metalnessMap:t.alphaMap?i=t.alphaMap:t.emissiveMap&&(i=t.emissiveMap),void 0!==i){i.isWebGLRenderTarget&&(i=i.texture);var n=i.offset,r=i.repeat;e.offsetRepeat.value.set(n.x,n.y,r.x,r.y),e.rotateMatrix.value.copy(i.rotateMatrix)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function b(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function C(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function M(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*Ee,e.scale.value=.5*ye,e.map.value=t.map,null!==t.map){var i=t.map.offset,n=t.map.repeat;e.offsetRepeat.value.set(i.x,i.y,n.x,n.y)}}function _(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function w(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function L(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function T(e,t){L(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function I(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function S(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,I(e,t)}function O(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function D(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function R(e){for(var t=0,i=0,n=e.length;i<n;i++){var r=e[i];r.castShadow&&(ke.shadows[t]=r,t++)}ke.shadows.length=t}function A(e,t){var i,n,r,a,o,s,l,c,u=0,h=0,d=0,f=t.matrixWorldInverse,p=0,m=0,g=0,v=0,y=0;for(i=0,n=e.length;i<n;i++)if(r=e[i],o=r.color,s=r.intensity,l=r.distance,c=r.shadow&&r.shadow.map?r.shadow.map.texture:null,r.isAmbientLight)u+=o.r*s,h+=o.g*s,d+=o.b*s;else if(r.isDirectionalLight){var E=rt.get(r);E.color.copy(r.color).multiplyScalar(r.intensity),E.direction.setFromMatrixPosition(r.matrixWorld),De.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(De),E.direction.transformDirection(f),E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),ke.directionalShadowMap[p]=c,ke.directionalShadowMatrix[p]=r.shadow.matrix,ke.directional[p]=E,p++}else if(r.isSpotLight){var E=rt.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(o).multiplyScalar(s),E.distance=l,E.direction.setFromMatrixPosition(r.matrixWorld),De.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(De),E.direction.transformDirection(f),E.coneCos=Math.cos(r.angle),E.penumbraCos=Math.cos(r.angle*(1-r.penumbra)),E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),ke.spotShadowMap[g]=c,ke.spotShadowMatrix[g]=r.shadow.matrix,ke.spot[g]=E,g++}else if(r.isRectAreaLight){var E=rt.get(r);E.color.copy(o).multiplyScalar(s/(r.width*r.height)),E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),Ne.identity(),Ae.copy(r.matrixWorld),Ae.premultiply(f),Ne.extractRotation(Ae),E.halfWidth.set(.5*r.width,0,0),E.halfHeight.set(0,.5*r.height,0),E.halfWidth.applyMatrix4(Ne),E.halfHeight.applyMatrix4(Ne),ke.rectArea[v]=E,v++}else if(r.isPointLight){var E=rt.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(r.color).multiplyScalar(r.intensity),E.distance=r.distance,E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),ke.pointShadowMap[m]=c,ke.pointShadowMatrix[m]=r.shadow.matrix,ke.point[m]=E,m++}else if(r.isHemisphereLight){var E=rt.get(r);E.direction.setFromMatrixPosition(r.matrixWorld),E.direction.transformDirection(f),E.direction.normalize(),E.skyColor.copy(r.color).multiplyScalar(s),E.groundColor.copy(r.groundColor).multiplyScalar(s),ke.hemi[y]=E,y++}ke.ambient[0]=u,ke.ambient[1]=h,ke.ambient[2]=d,ke.directional.length=p,ke.spot.length=g,ke.rectArea.length=v,ke.point.length=m,ke.hemi.length=y,ke.hash=p+","+m+","+g+","+v+","+y+","+ke.shadows.length}function U(){var e=pe;return e>=Ke.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Ke.maxTextures),pe+=1,e}function B(e){var t;if(e===fo)return Xe.REPEAT;if(e===po)return Xe.CLAMP_TO_EDGE;if(e===mo)return Xe.MIRRORED_REPEAT;if(e===go)return Xe.NEAREST;if(e===vo)return Xe.NEAREST_MIPMAP_NEAREST;if(e===yo)return Xe.NEAREST_MIPMAP_LINEAR;if(e===Eo)return Xe.LINEAR;if(e===xo)return Xe.LINEAR_MIPMAP_NEAREST;if(e===bo)return Xe.LINEAR_MIPMAP_LINEAR;if(e===Co)return Xe.UNSIGNED_BYTE;if(e===Oo)return Xe.UNSIGNED_SHORT_4_4_4_4;if(e===Do)return Xe.UNSIGNED_SHORT_5_5_5_1;if(e===Ro)return Xe.UNSIGNED_SHORT_5_6_5;if(e===Mo)return Xe.BYTE;if(e===_o)return Xe.SHORT;if(e===wo)return Xe.UNSIGNED_SHORT;if(e===Lo)return Xe.INT;if(e===To)return Xe.UNSIGNED_INT;if(e===Io)return Xe.FLOAT;if(e===So&&null!==(t=Ze.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===Uo)return Xe.ALPHA;if(e===Bo)return Xe.RGB;if(e===Po)return Xe.RGBA;if(e===No)return Xe.LUMINANCE;if(e===ko)return Xe.LUMINANCE_ALPHA;if(e===Ho)return Xe.DEPTH_COMPONENT;if(e===Go)return Xe.DEPTH_STENCIL;if(e===Ta)return Xe.FUNC_ADD;if(e===Ia)return Xe.FUNC_SUBTRACT;if(e===Sa)return Xe.FUNC_REVERSE_SUBTRACT;if(e===Ra)return Xe.ZERO;if(e===Aa)return Xe.ONE;if(e===Ua)return Xe.SRC_COLOR;if(e===Ba)return Xe.ONE_MINUS_SRC_COLOR;if(e===Pa)return Xe.SRC_ALPHA;if(e===Na)return Xe.ONE_MINUS_SRC_ALPHA;if(e===ka)return Xe.DST_ALPHA;if(e===Fa)return Xe.ONE_MINUS_DST_ALPHA;if(e===Ha)return Xe.DST_COLOR;if(e===Ga)return Xe.ONE_MINUS_DST_COLOR;if(e===Va)return Xe.SRC_ALPHA_SATURATE;if((e===Vo||e===zo||e===Wo||e===qo)&&null!==(t=Ze.get("WEBGL_compressed_texture_s3tc"))){if(e===Vo)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===zo)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Wo)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===qo)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===jo||e===Xo||e===Yo||e===Zo)&&null!==(t=Ze.get("WEBGL_compressed_texture_pvrtc"))){if(e===jo)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Xo)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===Yo)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Zo)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ko&&null!==(t=Ze.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===Oa||e===Da)&&null!==(t=Ze.get("EXT_blend_minmax"))){if(e===Oa)return t.MIN_EXT;if(e===Da)return t.MAX_EXT}return e===Ao&&null!==(t=Ze.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",aa),e=e||{};var P=void 0!==e.canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),N=void 0!==e.context?e.context:null,k=void 0!==e.alpha&&e.alpha,F=void 0===e.depth||e.depth,H=void 0===e.stencil||e.stencil,G=void 0!==e.antialias&&e.antialias,V=void 0===e.premultipliedAlpha||e.premultipliedAlpha,z=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,W=[],X=null,K=new Float32Array(8),J=[],$=[],ee=new l;this.domElement=P,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=to,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var te=this,ie=null,ae=null,oe=null,se=-1,le="",ce=null,ue=new r,he=null,fe=new r,pe=0,me=new j(0),ge=0,ve=P.width,ye=P.height,Ee=1,xe=new r(0,0,ve,ye),be=!1,Ce=new r(0,0,ve,ye),Me=new ne,_e=new dt,we=!1,Le=!1,Se=new c,De=new l,Ae=new c,Ne=new c,ke={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},Fe={geometries:0,textures:0},je={frame:0,calls:0,vertices:0,faces:0,points:0};this.info={render:je,memory:Fe,programs:null};var Xe;try{var Ye={alpha:k,depth:F,stencil:H,antialias:G,premultipliedAlpha:V,preserveDrawingBuffer:z};if(null===(Xe=N||P.getContext("webgl",Ye)||P.getContext("experimental-webgl",Ye)))throw null!==P.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===Xe.getShaderPrecisionFormat&&(Xe.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),P.addEventListener("webglcontextlost",a,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var Ze=new ht(Xe);Ze.get("WEBGL_depth_texture"),Ze.get("OES_texture_float"),Ze.get("OES_texture_float_linear"),Ze.get("OES_texture_half_float"),Ze.get("OES_texture_half_float_linear"),Ze.get("OES_standard_derivatives"),Ze.get("ANGLE_instanced_arrays"),Ze.get("WEBGL_draw_buffers"),Ze.get("OES_element_index_uint")&&(Te.MaxIndex=4294967296);var Ke=new ut(Xe,Ze,e),Qe=new ct(Xe,Ze,B),Je=new lt,$e=new st(Xe,Ze,Qe,Je,Ke,B,Fe),et=new Pe(Xe),tt=new ze(Xe,et,Fe),it=new qe(Xe,tt,je),nt=new ot(this,Ke),rt=new We,at=new He;this.info.programs=nt.programs;var ft,pt,mt,gt,vt=new Ve(Xe,Ze,je),yt=new Ge(Xe,Ze,je);i(),this.context=Xe,this.capabilities=Ke,this.extensions=Ze,this.properties=Je,this.state=Qe;var Et=new re(this,ke,it,Ke);this.shadowMap=Et;var xt=new Z(this,J),bt=new Y(this,$);this.getContext=function(){return Xe},this.getContextAttributes=function(){return Xe.getContextAttributes()},this.forceContextLoss=function(){var e=Ze.get("WEBGL_lose_context");e&&e.loseContext()},this.getMaxAnisotropy=function(){return Ke.getMaxAnisotropy()},this.getPrecision=function(){return Ke.precision},this.getPixelRatio=function(){return Ee},this.setPixelRatio=function(e){void 0!==e&&(Ee=e,this.setSize(Ce.z,Ce.w,!1))},this.getSize=function(){return{width:ve,height:ye}},this.setSize=function(e,t,i){ve=e,ye=t,P.width=e*Ee,P.height=t*Ee,!1!==i&&(P.style.width=e+"px",P.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){Qe.viewport(Ce.set(e,t,i,n))},this.setScissor=function(e,t,i,n){Qe.scissor(xe.set(e,t,i,n))},this.setScissorTest=function(e){Qe.setScissorTest(be=e)},this.getClearColor=function(){return me},this.setClearColor=function(e,t){me.set(e),ge=void 0!==t?t:1,Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)},this.getClearAlpha=function(){return ge},this.setClearAlpha=function(e){ge=e,Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V)},this.clear=function(e,t,i){var n=0;(void 0===e||e)&&(n|=Xe.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=Xe.DEPTH_BUFFER_BIT),(void 0===i||i)&&(n|=Xe.STENCIL_BUFFER_BIT),Xe.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,i,n){this.setRenderTarget(e),this.clear(t,i,n)},this.resetGLState=n,this.dispose=function(){P.removeEventListener("webglcontextlost",a,!1),at.dispose()},this.renderBufferImmediate=function(e,t,i){Qe.initAttributes();var n=Je.get(e);e.hasPositions&&!n.position&&(n.position=Xe.createBuffer()),e.hasNormals&&!n.normal&&(n.normal=Xe.createBuffer()),e.hasUvs&&!n.uv&&(n.uv=Xe.createBuffer()),e.hasColors&&!n.color&&(n.color=Xe.createBuffer());var r=t.getAttributes();if(e.hasPositions&&(Xe.bindBuffer(Xe.ARRAY_BUFFER,n.position),Xe.bufferData(Xe.ARRAY_BUFFER,e.positionArray,Xe.DYNAMIC_DRAW),Qe.enableAttribute(r.position),Xe.vertexAttribPointer(r.position,3,Xe.FLOAT,!1,0,0)),e.hasNormals){if(Xe.bindBuffer(Xe.ARRAY_BUFFER,n.normal),!i.isMeshPhongMaterial&&!i.isMeshStandardMaterial&&!i.isMeshNormalMaterial&&i.shading===ga)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,l=(s[a+0]+s[a+3]+s[a+6])/3,c=(s[a+1]+s[a+4]+s[a+7])/3,u=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=l,s[a+1]=c,s[a+2]=u,s[a+3]=l,s[a+4]=c,s[a+5]=u,s[a+6]=l,s[a+7]=c,s[a+8]=u}Xe.bufferData(Xe.ARRAY_BUFFER,e.normalArray,Xe.DYNAMIC_DRAW),Qe.enableAttribute(r.normal),Xe.vertexAttribPointer(r.normal,3,Xe.FLOAT,!1,0,0)}e.hasUvs&&i.map&&(Xe.bindBuffer(Xe.ARRAY_BUFFER,n.uv),Xe.bufferData(Xe.ARRAY_BUFFER,e.uvArray,Xe.DYNAMIC_DRAW),Qe.enableAttribute(r.uv),Xe.vertexAttribPointer(et.uv,2,Xe.FLOAT,!1,0,0)),e.hasColors&&i.vertexColors!==ya&&(Xe.bindBuffer(Xe.ARRAY_BUFFER,n.color),Xe.bufferData(Xe.ARRAY_BUFFER,e.colorArray,Xe.DYNAMIC_DRAW),Qe.enableAttribute(r.color),Xe.vertexAttribPointer(r.color,3,Xe.FLOAT,!1,0,0)),Qe.disableUnusedAttributes(),Xe.drawArrays(Xe.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,i,n,r,a,o){Qe.setMaterial(r);var s=E(e,i,r,a),l=n.id;l+="_",l+=s.id,l+="_",l+=!0===r.wireframe;var c=!1;l!==le&&(le=l,c=!0);var u=a.morphTargetInfluences;if(void 0!==u){for(var h=[],d=0,m=u.length;d<m;d++){var g=u[d];h.push([g,d])}h.sort(f),h.length>8&&(h.length=8);for(var v=n.morphAttributes,d=0,m=h.length;d<m;d++){var g=h[d];if(K[d]=g[0],0!==g[0]){var y=g[1];!0===r.morphTargets&&v.position&&n.addAttribute("morphTarget"+d,v.position[y]),!0===r.morphNormals&&v.normal&&n.addAttribute("morphNormal"+d,v.normal[y])}else!0===r.morphTargets&&n.removeAttribute("morphTarget"+d),!0===r.morphNormals&&n.removeAttribute("morphNormal"+d)}for(var d=h.length,x=K.length;d<x;d++)K[d]=0;s.getUniforms().setValue(Xe,"morphTargetInfluences",K),c=!0}var y=n.index,b=n.attributes.position,C=1;!0===r.wireframe&&(y=tt.getWireframeAttribute(n),C=2);var M=vt;null!==y&&(M=yt,M.setIndex(y)),c&&(p(r,s,n),null!==y&&Xe.bindBuffer(Xe.ELEMENT_ARRAY_BUFFER,et.get(y).buffer));var _=0;null!==y?_=y.count:void 0!==b&&(_=b.count);var w=n.drawRange.start*C,L=n.drawRange.count*C,T=null!==o?o.start*C:0,I=null!==o?o.count*C:1/0,S=Math.max(w,T),O=Math.min(_,w+L,T+I)-1,D=Math.max(0,O-S+1);if(0!==D){if(a.isMesh)if(!0===r.wireframe)Qe.setLineWidth(r.wireframeLinewidth*t()),M.setMode(Xe.LINES);else switch(a.drawMode){case $o:M.setMode(Xe.TRIANGLES);break;case es:M.setMode(Xe.TRIANGLE_STRIP);break;case ts:M.setMode(Xe.TRIANGLE_FAN)}else if(a.isLine){var R=r.linewidth;void 0===R&&(R=1),Qe.setLineWidth(R*t()),a.isLineSegments?M.setMode(Xe.LINES):a.isLineLoop?M.setMode(Xe.LINE_LOOP):M.setMode(Xe.LINE_STRIP)}else a.isPoints&&M.setMode(Xe.POINTS);n&&n.isInstancedBufferGeometry?n.maxInstancedCount>0&&M.renderInstances(n,S,D):M.render(S,D)}},this.compile=function(e,t){W=[],e.traverse(function(e){e.isLight&&W.push(e)}),A(W,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var i=0;i<t.material.length;i++)y(t.material[i],e.fog,t);else y(t.material,e.fog,t)})},this.render=function(e,t,i,n){if(void 0!==t&&!0!==t.isCamera)return void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera.");le="",se=-1,ce=null,!0===e.autoUpdate&&e.updateMatrixWorld(),t.onBeforeRender(te),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),Se.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),Me.setFromMatrix(Se),W.length=0,J.length=0,$.length=0,Le=this.localClippingEnabled,we=_e.init(this.clippingPlanes,Le,t),X=at.get(e,t),X.init(),m(e,t,te.sortObjects),X.finish(),!0===te.sortObjects&&X.sort(),we&&_e.beginShadows(),R(W),Et.render(e,t),A(W,t),we&&_e.endShadows(),je.frame++,je.calls=0,je.vertices=0,je.faces=0,je.points=0,void 0===i&&(i=null),this.setRenderTarget(i);var r=e.background;null===r?Qe.buffers.color.setClear(me.r,me.g,me.b,ge,V):r&&r.isColor&&(Qe.buffers.color.setClear(r.r,r.g,r.b,1,V),n=!0),(this.autoClear||n)&&this.clear(this.autoClearColor,this.autoClearDepth,this.autoClearStencil),r&&r.isCubeTexture?(void 0===mt&&(mt=new Ue,gt=new Ie(new Oe(5,5,5),new Q({uniforms:_s.cube.uniforms,vertexShader:_s.cube.vertexShader,fragmentShader:_s.cube.fragmentShader,side:pa,depthTest:!1,depthWrite:!1,fog:!1}))),mt.projectionMatrix.copy(t.projectionMatrix),mt.matrixWorld.extractRotation(t.matrixWorld),mt.matrixWorldInverse.getInverse(mt.matrixWorld),gt.material.uniforms.tCube.value=r,gt.modelViewMatrix.multiplyMatrices(mt.matrixWorldInverse,gt.matrixWorld),it.update(gt),te.renderBufferDirect(mt,null,gt.geometry,gt.material,gt,null)):r&&r.isTexture&&(void 0===ft&&(ft=new Be(-1,1,1,-1,0,1),pt=new Ie(new Re(2,2),new de({depthTest:!1,depthWrite:!1,fog:!1}))),pt.material.map=r,it.update(pt),te.renderBufferDirect(ft,null,pt.geometry,pt.material,pt,null));var a=X.opaque,o=X.transparent;if(e.overrideMaterial){var s=e.overrideMaterial;a.length&&g(a,e,t,s),o.length&&g(o,e,t,s)}else a.length&&g(a,e,t),o.length&&g(o,e,t);xt.render(e,t),bt.render(e,t,fe),i&&$e.updateRenderTargetMipmap(i),Qe.buffers.depth.setTest(!0),Qe.buffers.depth.setMask(!0),Qe.buffers.color.setMask(!0),t.isArrayCamera&&t.enabled&&te.setScissorTest(!1),t.onAfterRender(te)},this.setFaceCulling=function(e,t){Qe.setCullFace(e),Qe.setFlipSided(t===ua)},this.allocTextureUnit=U,this.setTexture2D=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),$e.setTexture2D(t,i)}}(),this.setTexture=function(){var e=!1;return function(t,i){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),$e.setTexture2D(t,i)}}(),this.setTextureCube=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?$e.setTextureCube(t,i):$e.setTextureCubeDynamic(t,i)}}(),this.getRenderTarget=function(){return ae},this.isMRTSupported=function(){return Ze.get("WEBGL_draw_buffers")},this.setRenderTarget=function(e){if(Array.isArray(e)){if(this.isMRTSupported()){ae=e[0],$e.setupMultiRenderTarget(e);var t,i=Je.get(e[0]);t=i.__webglFramebuffer;var n=ae;ue.copy(n.scissor),he=n.scissorTest,fe.copy(n.viewport),oe!==t&&(Xe.bindFramebuffer(Xe.FRAMEBUFFER,t),oe=t),Qe.scissor(ue),Qe.setScissorTest(he),Qe.viewport(fe)}}else{ae=e,e&&void 0===Je.get(e).__webglFramebuffer&&$e.setupRenderTarget(e);var t,r=e&&e.isWebGLRenderTargetCube;if(e){var i=Je.get(e);t=r?i.__webglFramebuffer[e.activeCubeFace]:i.__webglFramebuffer,ue.copy(e.scissor),he=e.scissorTest,fe.copy(e.viewport)}else t=null,ue.copy(xe).multiplyScalar(Ee),he=be,fe.copy(Ce).multiplyScalar(Ee);if(oe!==t&&(Xe.bindFramebuffer(Xe.FRAMEBUFFER,t),oe=t),Qe.scissor(ue),Qe.setScissorTest(he),Qe.viewport(fe),r){var a=Je.get(e.texture);Xe.framebufferTexture2D(Xe.FRAMEBUFFER,Xe.COLOR_ATTACHMENT0,Xe.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,a.__webglTexture,e.activeMipMapLevel)}}},this.readRenderTargetPixels=function(e,t,i,n,r,a){if(!1===(e&&e.isWebGLRenderTarget))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var o=Je.get(e).__webglFramebuffer;if(o){var s=!1;o!==oe&&(Xe.bindFramebuffer(Xe.FRAMEBUFFER,o),s=!0);try{var l=e.texture,c=l.format,u=l.type;if(c!==Po&&B(c)!==Xe.getParameter(Xe.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(u===Co||B(u)===Xe.getParameter(Xe.IMPLEMENTATION_COLOR_READ_TYPE)||u===Io&&(Ze.get("OES_texture_float")||Ze.get("WEBGL_color_buffer_float"))||u===So&&Ze.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Xe.checkFramebufferStatus(Xe.FRAMEBUFFER)===Xe.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r&&Xe.readPixels(t,i,n,r,B(c),B(u),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&Xe.bindFramebuffer(Xe.FRAMEBUFFER,oe)}}}}function pt(e,t){this.name="",this.color=new j(e),this.density=void 0!==t?t:25e-5}function mt(e,t,i){
this.name="",this.color=new j(e),this.near=void 0!==t?t:1,this.far=void 0!==i?i:1e3}function gt(){le.call(this),this.type="Scene",this.background=null,this.fog=null,this.overrideMaterial=null,this.autoUpdate=!0}function vt(e,t,i,n,r){le.call(this),this.lensFlares=[],this.positionScreen=new l,this.customUpdateCallback=void 0,void 0!==e&&this.add(e,t,i,n,r)}function yt(e){K.call(this),this.type="SpriteMaterial",this.color=new j(16777215),this.map=null,this.rotation=0,this.fog=!1,this.lights=!1,this.setValues(e)}function Et(e){le.call(this),this.type="Sprite",this.material=void 0!==e?e:new yt}function xt(){le.call(this),this.type="LOD",Object.defineProperties(this,{levels:{enumerable:!0,value:[]}})}function bt(e,t){if(e=e||[],this.bones=e.slice(0),this.boneMatrices=new Float32Array(16*this.bones.length),void 0===t)this.calculateInverses();else if(this.bones.length===t.length)this.boneInverses=t.slice(0);else{console.warn("THREE.Skeleton boneInverses is the wrong length."),this.boneInverses=[];for(var i=0,n=this.bones.length;i<n;i++)this.boneInverses.push(new c)}}function Ct(){le.call(this),this.type="Bone"}function Mt(e,t){Ie.call(this,e,t),this.type="SkinnedMesh",this.bindMode="attached",this.bindMatrix=new c,this.bindMatrixInverse=new c;var i=this.initBones(),n=new bt(i);this.bind(n,this.matrixWorld),this.normalizeSkinWeights()}function _t(e){K.call(this),this.type="LineBasicMaterial",this.color=new j(16777215),this.linewidth=1,this.linecap="round",this.linejoin="round",this.lights=!1,this.setValues(e)}function wt(e,t,i){if(1===i)return console.warn("THREE.Line: parameter THREE.LinePieces no longer supported. Created THREE.LineSegments instead."),new Lt(e,t);le.call(this),this.type="Line",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new _t({color:16777215*Math.random()})}function Lt(e,t){wt.call(this,e,t),this.type="LineSegments"}function Tt(e,t){wt.call(this,e,t),this.type="LineLoop"}function It(e){K.call(this),this.type="PointsMaterial",this.color=new j(16777215),this.map=null,this.size=1,this.sizeAttenuation=!0,this.positionOffset=!1,this.sizeAttribute=!1,this.lights=!1,this.setValues(e)}function St(e,t){le.call(this),this.type="Points",this.geometry=void 0!==e?e:new Te,this.material=void 0!==t?t:new It({color:16777215*Math.random()})}function Ot(){le.call(this),this.type="Group"}function Dt(e,t,i,r,a,o,s,l,c){function u(){requestAnimationFrame(u),e.readyState>=e.HAVE_CURRENT_DATA&&(h.needsUpdate=!0)}n.call(this,e,t,i,r,a,o,s,l,c),this.generateMipmaps=!1;var h=this;u()}function Rt(e,t,i,r,a,o,s,l,c,u,h,d){n.call(this,null,o,s,l,c,u,r,a,h,d),this.image={width:t,height:i},this.mipmaps=e,this.flipY=!1,this.generateMipmaps=!1}function At(e,t,i,r,a,o,s,l,c){n.call(this,e,t,i,r,a,o,s,l,c),this.needsUpdate=!0}function Ut(e,t,i,r,a,o,s,l,c,u){if((u=void 0!==u?u:Ho)!==Ho&&u!==Go)throw new Error("DepthTexture format must be either THREE.DepthFormat or THREE.DepthStencilFormat");void 0===i&&u===Ho&&(i=wo),void 0===i&&u===Go&&(i=Ao),n.call(this,null,r,a,o,s,l,u,i,c),this.image={width:e,height:t},this.magFilter=void 0!==s?s:go,this.minFilter=void 0!==l?l:go,this.flipY=!1,this.generateMipmaps=!1}function Bt(e){Te.call(this),this.type="WireframeGeometry";var t,i,n,r,a,o,s,c,u,h,d=[],f=[0,0],p={},m=["a","b","c"];if(e&&e.isGeometry){var g=e.faces;for(t=0,n=g.length;t<n;t++){var v=g[t];for(i=0;i<3;i++)s=v[m[i]],c=v[m[(i+1)%3]],f[0]=Math.min(s,c),f[1]=Math.max(s,c),u=f[0]+","+f[1],void 0===p[u]&&(p[u]={index1:f[0],index2:f[1]})}for(u in p)o=p[u],h=e.vertices[o.index1],d.push(h.x,h.y,h.z),h=e.vertices[o.index2],d.push(h.x,h.y,h.z)}else if(e&&e.isBufferGeometry){var y,E,x,b,C,M,_,w;if(h=new l,null!==e.index){for(y=e.attributes.position,E=e.index,x=e.groups,0===x.length&&(x=[{start:0,count:E.count,materialIndex:0}]),r=0,a=x.length;r<a;++r)for(b=x[r],C=b.start,M=b.count,t=C,n=C+M;t<n;t+=3)for(i=0;i<3;i++)s=E.getX(t+i),c=E.getX(t+(i+1)%3),f[0]=Math.min(s,c),f[1]=Math.max(s,c),u=f[0]+","+f[1],void 0===p[u]&&(p[u]={index1:f[0],index2:f[1]});for(u in p)o=p[u],h.fromBufferAttribute(y,o.index1),d.push(h.x,h.y,h.z),h.fromBufferAttribute(y,o.index2),d.push(h.x,h.y,h.z)}else for(y=e.attributes.position,t=0,n=y.count/3;t<n;t++)for(i=0;i<3;i++)_=3*t+i,h.fromBufferAttribute(y,_),d.push(h.x,h.y,h.z),w=3*t+(i+1)%3,h.fromBufferAttribute(y,w),d.push(h.x,h.y,h.z)}this.addAttribute("position",new be(d,3))}function Pt(e,t,i){Le.call(this),this.type="ParametricGeometry",this.parameters={func:e,slices:t,stacks:i},this.fromBufferGeometry(new Nt(e,t,i)),this.mergeVertices()}function Nt(e,t,i){Te.call(this),this.type="ParametricBufferGeometry",this.parameters={func:e,slices:t,stacks:i};var n,r,a=[],o=[],s=[],c=[],u=new l,h=new l,d=new l,f=new l,p=new l,m=t+1;for(n=0;n<=i;n++){var g=n/i;for(r=0;r<=t;r++){var v=r/t;h=e(v,g,h),o.push(h.x,h.y,h.z),v-1e-5>=0?(d=e(v-1e-5,g,d),f.subVectors(h,d)):(d=e(v+1e-5,g,d),f.subVectors(d,h)),g-1e-5>=0?(d=e(v,g-1e-5,d),p.subVectors(h,d)):(d=e(v,g+1e-5,d),p.subVectors(d,h)),u.crossVectors(f,p).normalize(),s.push(u.x,u.y,u.z),c.push(v,g)}}for(n=0;n<i;n++)for(r=0;r<t;r++){var y=n*m+r,E=n*m+r+1,x=(n+1)*m+r+1,b=(n+1)*m+r;a.push(y,E,b),a.push(E,x,b)}this.setIndex(a),this.addAttribute("position",new be(o,3)),this.addAttribute("normal",new be(s,3)),this.addAttribute("uv",new be(c,2))}function kt(e,t,i,n){Le.call(this),this.type="PolyhedronGeometry",this.parameters={vertices:e,indices:t,radius:i,detail:n},this.fromBufferGeometry(new Ft(e,t,i,n)),this.mergeVertices()}function Ft(e,t,n,r){function a(e,t,i,n){var r,a,o=Math.pow(2,n),l=[];for(r=0;r<=o;r++){l[r]=[];var c=e.clone().lerp(i,r/o),u=t.clone().lerp(i,r/o),h=o-r;for(a=0;a<=h;a++)l[r][a]=0===a&&r===o?c:c.clone().lerp(u,a/h)}for(r=0;r<o;r++)for(a=0;a<2*(o-r)-1;a++){var d=Math.floor(a/2);a%2==0?(s(l[r][d+1]),s(l[r+1][d]),s(l[r][d])):(s(l[r][d+1]),s(l[r+1][d+1]),s(l[r+1][d]))}}function o(){for(var e=0;e<m.length;e+=6){var t=m[e+0],i=m[e+2],n=m[e+4],r=Math.max(t,i,n),a=Math.min(t,i,n);r>.9&&a<.1&&(t<.2&&(m[e+0]+=1),i<.2&&(m[e+2]+=1),n<.2&&(m[e+4]+=1))}}function s(e){p.push(e.x,e.y,e.z)}function c(t,i){var n=3*t;i.x=e[n+0],i.y=e[n+1],i.z=e[n+2]}function u(){for(var e=new l,t=new l,n=new l,r=new l,a=new i,o=new i,s=new i,c=0,u=0;c<p.length;c+=9,u+=6){e.set(p[c+0],p[c+1],p[c+2]),t.set(p[c+3],p[c+4],p[c+5]),n.set(p[c+6],p[c+7],p[c+8]),a.set(m[u+0],m[u+1]),o.set(m[u+2],m[u+3]),s.set(m[u+4],m[u+5]),r.copy(e).add(t).add(n).divideScalar(3);var f=d(r);h(a,u+0,e,f),h(o,u+2,t,f),h(s,u+4,n,f)}}function h(e,t,i,n){n<0&&1===e.x&&(m[t]=e.x-1),0===i.x&&0===i.z&&(m[t]=n/2/Math.PI+.5)}function d(e){return Math.atan2(e.z,-e.x)}function f(e){return Math.atan2(-e.y,Math.sqrt(e.x*e.x+e.z*e.z))}Te.call(this),this.type="PolyhedronBufferGeometry",this.parameters={vertices:e,indices:t,radius:n,detail:r},n=n||1,r=r||0;var p=[],m=[];!function(e){for(var i=new l,n=new l,r=new l,o=0;o<t.length;o+=3)c(t[o+0],i),c(t[o+1],n),c(t[o+2],r),a(i,n,r,e)}(r),function(e){for(var t=new l,i=0;i<p.length;i+=3)t.x=p[i+0],t.y=p[i+1],t.z=p[i+2],t.normalize().multiplyScalar(e),p[i+0]=t.x,p[i+1]=t.y,p[i+2]=t.z}(n),function(){for(var e=new l,t=0;t<p.length;t+=3){e.x=p[t+0],e.y=p[t+1],e.z=p[t+2];var i=d(e)/2/Math.PI+.5,n=f(e)/Math.PI+.5;m.push(i,1-n)}u(),o()}(),this.addAttribute("position",new be(p,3)),this.addAttribute("normal",new be(p.slice(),3)),this.addAttribute("uv",new be(m,2)),this.normalizeNormals()}function Ht(e,t){Le.call(this),this.type="TetrahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Gt(e,t)),this.mergeVertices()}function Gt(e,t){var i=[1,1,1,-1,-1,1,-1,1,-1,1,-1,-1],n=[2,1,0,0,3,2,1,3,0,2,3,1];Ft.call(this,i,n,e,t),this.type="TetrahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Vt(e,t){Le.call(this),this.type="OctahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new zt(e,t)),this.mergeVertices()}function zt(e,t){var i=[1,0,0,-1,0,0,0,1,0,0,-1,0,0,0,1,0,0,-1],n=[0,2,4,0,4,3,0,3,5,0,5,2,1,2,5,1,5,3,1,3,4,1,4,2];Ft.call(this,i,n,e,t),this.type="OctahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Wt(e,t){Le.call(this),this.type="IcosahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new qt(e,t)),this.mergeVertices()}function qt(e,t){var i=(1+Math.sqrt(5))/2,n=[-1,i,0,1,i,0,-1,-i,0,1,-i,0,0,-1,i,0,1,i,0,-1,-i,0,1,-i,i,0,-1,i,0,1,-i,0,-1,-i,0,1],r=[0,11,5,0,5,1,0,1,7,0,7,10,0,10,11,1,5,9,5,11,4,11,10,2,10,7,6,7,1,8,3,9,4,3,4,2,3,2,6,3,6,8,3,8,9,4,9,5,2,4,11,6,2,10,8,6,7,9,8,1];Ft.call(this,n,r,e,t),this.type="IcosahedronBufferGeometry",this.parameters={radius:e,detail:t}}function jt(e,t){Le.call(this),this.type="DodecahedronGeometry",this.parameters={radius:e,detail:t},this.fromBufferGeometry(new Xt(e,t)),this.mergeVertices()}function Xt(e,t){var i=(1+Math.sqrt(5))/2,n=1/i,r=[-1,-1,-1,-1,-1,1,-1,1,-1,-1,1,1,1,-1,-1,1,-1,1,1,1,-1,1,1,1,0,-n,-i,0,-n,i,0,n,-i,0,n,i,-n,-i,0,-n,i,0,n,-i,0,n,i,0,-i,0,-n,i,0,-n,-i,0,n,i,0,n],a=[3,11,7,3,7,15,3,15,13,7,19,17,7,17,6,7,6,15,17,4,8,17,8,10,17,10,6,8,0,16,8,16,2,8,2,10,0,12,1,0,1,18,0,18,16,6,10,2,6,2,13,6,13,15,2,16,18,2,18,3,2,3,13,18,1,9,18,9,11,18,11,3,4,14,12,4,12,0,4,0,8,11,9,5,11,5,19,11,19,7,19,5,14,19,14,4,19,4,17,1,12,14,1,14,5,1,5,9];Ft.call(this,r,a,e,t),this.type="DodecahedronBufferGeometry",this.parameters={radius:e,detail:t}}function Yt(e,t,i,n,r,a){Le.call(this),this.type="TubeGeometry",this.parameters={path:e,tubularSegments:t,radius:i,radialSegments:n,closed:r},void 0!==a&&console.warn("THREE.TubeGeometry: taper has been removed.");var o=new Zt(e,t,i,n,r);this.tangents=o.tangents,this.normals=o.normals,this.binormals=o.binormals,this.fromBufferGeometry(o),this.mergeVertices()}function Zt(e,t,n,r,a){function o(i){var a=e.getPointAt(i/t),o=u.normals[i],s=u.binormals[i];for(d=0;d<=r;d++){var l=d/r*Math.PI*2,c=Math.sin(l),h=-Math.cos(l);p.x=h*o.x+c*s.x,p.y=h*o.y+c*s.y,p.z=h*o.z+c*s.z,p.normalize(),v.push(p.x,p.y,p.z),f.x=a.x+n*p.x,f.y=a.y+n*p.y,f.z=a.z+n*p.z,g.push(f.x,f.y,f.z)}}function s(){for(d=1;d<=t;d++)for(h=1;h<=r;h++){var e=(r+1)*(d-1)+(h-1),i=(r+1)*d+(h-1),n=(r+1)*d+h,a=(r+1)*(d-1)+h;E.push(e,i,a),E.push(i,n,a)}}function c(){for(h=0;h<=t;h++)for(d=0;d<=r;d++)m.x=h/t,m.y=d/r,y.push(m.x,m.y)}Te.call(this),this.type="TubeBufferGeometry",this.parameters={path:e,tubularSegments:t,radius:n,radialSegments:r,closed:a},t=t||64,n=n||1,r=r||8,a=a||!1;var u=e.computeFrenetFrames(t,a);this.tangents=u.tangents,this.normals=u.normals,this.binormals=u.binormals;var h,d,f=new l,p=new l,m=new i,g=[],v=[],y=[],E=[];!function(){for(h=0;h<t;h++)o(h);o(!1===a?t:0),c(),s()}(),this.setIndex(E),this.addAttribute("position",new be(g,3)),this.addAttribute("normal",new be(v,3)),this.addAttribute("uv",new be(y,2))}function Kt(e,t,i,n,r,a,o){Le.call(this),this.type="TorusKnotGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:n,p:r,q:a},void 0!==o&&console.warn("THREE.TorusKnotGeometry: heightScale has been deprecated. Use .scale( x, y, z ) instead."),this.fromBufferGeometry(new Qt(e,t,i,n,r,a)),this.mergeVertices()}function Qt(e,t,i,n,r,a){function o(e,t,i,n,r){var a=Math.cos(e),o=Math.sin(e),s=i/t*e,l=Math.cos(s);r.x=n*(2+l)*.5*a,r.y=n*(2+l)*o*.5,r.z=n*Math.sin(s)*.5}Te.call(this),this.type="TorusKnotBufferGeometry",this.parameters={radius:e,tube:t,tubularSegments:i,radialSegments:n,p:r,q:a},e=e||100,t=t||40,i=Math.floor(i)||64,n=Math.floor(n)||8,r=r||2,a=a||3;var s,c,u=[],h=[],d=[],f=[],p=new l,m=new l,g=new l,v=new l,y=new l,E=new l,x=new l;for(s=0;s<=i;++s){var b=s/i*r*Math.PI*2;for(o(b,r,a,e,g),o(b+.01,r,a,e,v),E.subVectors(v,g),x.addVectors(v,g),y.crossVectors(E,x),x.crossVectors(y,E),y.normalize(),x.normalize(),c=0;c<=n;++c){var C=c/n*Math.PI*2,M=-t*Math.cos(C),_=t*Math.sin(C);p.x=g.x+(M*x.x+_*y.x),p.y=g.y+(M*x.y+_*y.y),p.z=g.z+(M*x.z+_*y.z),h.push(p.x,p.y,p.z),m.subVectors(p,g).normalize(),d.push(m.x,m.y,m.z),f.push(s/i),f.push(c/n)}}for(c=1;c<=i;c++)for(s=1;s<=n;s++){var w=(n+1)*(c-1)+(s-1),L=(n+1)*c+(s-1),T=(n+1)*c+s,I=(n+1)*(c-1)+s;u.push(w,L,I),u.push(L,T,I)}this.setIndex(u),this.addAttribute("position",new be(h,3)),this.addAttribute("normal",new be(d,3)),this.addAttribute("uv",new be(f,2))}function Jt(e,t,i,n,r){Le.call(this),this.type="TorusGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:r},this.fromBufferGeometry(new $t(e,t,i,n,r)),this.mergeVertices()}function $t(e,t,i,n,r){Te.call(this),this.type="TorusBufferGeometry",this.parameters={radius:e,tube:t,radialSegments:i,tubularSegments:n,arc:r},e=e||100,t=t||40,i=Math.floor(i)||8,n=Math.floor(n)||6,r=r||2*Math.PI;var a,o,s=[],c=[],u=[],h=[],d=new l,f=new l,p=new l;for(a=0;a<=i;a++)for(o=0;o<=n;o++){var m=o/n*r,g=a/i*Math.PI*2;f.x=(e+t*Math.cos(g))*Math.cos(m),f.y=(e+t*Math.cos(g))*Math.sin(m),f.z=t*Math.sin(g),c.push(f.x,f.y,f.z),d.x=e*Math.cos(m),d.y=e*Math.sin(m),p.subVectors(f,d).normalize(),u.push(p.x,p.y,p.z),h.push(o/n),h.push(a/i)}for(a=1;a<=i;a++)for(o=1;o<=n;o++){var v=(n+1)*a+o-1,y=(n+1)*(a-1)+o-1,E=(n+1)*(a-1)+o,x=(n+1)*a+o;s.push(v,y,x),s.push(y,E,x)}this.setIndex(s),this.addAttribute("position",new be(c,3)),this.addAttribute("normal",new be(u,3)),this.addAttribute("uv",new be(h,2))}function ei(e,t){Le.call(this),this.type="ExtrudeGeometry",this.parameters={shapes:e,options:t},this.fromBufferGeometry(new ti(e,t)),this.mergeVertices()}function ti(e,t){if(void 0===e)return void(e=[]);Te.call(this),this.type="ExtrudeBufferGeometry",e=Array.isArray(e)?e:[e],this.addShapeList(e,t),this.computeVertexNormals()}function ii(e,t){Le.call(this),this.type="TextGeometry",this.parameters={text:e,parameters:t},this.fromBufferGeometry(new ni(e,t)),this.mergeVertices()}function ni(e,t){t=t||{};var i=t.font;if(!1===(i&&i.isFont))return console.error("THREE.TextGeometry: font parameter is not an instance of THREE.Font."),new Le;var n=i.generateShapes(e,t.size,t.curveSegments);t.amount=void 0!==t.height?t.height:50,void 0===t.bevelThickness&&(t.bevelThickness=10),void 0===t.bevelSize&&(t.bevelSize=8),void 0===t.bevelEnabled&&(t.bevelEnabled=!1),ti.call(this,n,t),this.type="TextBufferGeometry"}function ri(e,t,i,n,r,a,o){Le.call(this),this.type="SphereGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:n,phiLength:r,thetaStart:a,thetaLength:o},this.fromBufferGeometry(new ai(e,t,i,n,r,a,o)),this.mergeVertices()}function ai(e,t,i,n,r,a,o){Te.call(this),this.type="SphereBufferGeometry",this.parameters={radius:e,widthSegments:t,heightSegments:i,phiStart:n,phiLength:r,thetaStart:a,thetaLength:o},e=e||50,t=Math.max(3,Math.floor(t)||8),i=Math.max(2,Math.floor(i)||6),n=void 0!==n?n:0,r=void 0!==r?r:2*Math.PI,a=void 0!==a?a:0,o=void 0!==o?o:Math.PI;var s,c,u=a+o,h=0,d=[],f=new l,p=new l,m=[],g=[],v=[],y=[];for(c=0;c<=i;c++){var E=[],x=c/i;for(s=0;s<=t;s++){var b=s/t;f.x=-e*Math.cos(n+b*r)*Math.sin(a+x*o),f.y=e*Math.cos(a+x*o),f.z=e*Math.sin(n+b*r)*Math.sin(a+x*o),g.push(f.x,f.y,f.z),p.set(f.x,f.y,f.z).normalize(),v.push(p.x,p.y,p.z),y.push(b,1-x),E.push(h++)}d.push(E)}for(c=0;c<i;c++)for(s=0;s<t;s++){var C=d[c][s+1],M=d[c][s],_=d[c+1][s],w=d[c+1][s+1];(0!==c||a>0)&&m.push(C,M,w),(c!==i-1||u<Math.PI)&&m.push(M,_,w)}this.setIndex(m),this.addAttribute("position",new be(g,3)),this.addAttribute("normal",new be(v,3)),this.addAttribute("uv",new be(y,2))}function oi(e,t,i,n,r,a){Le.call(this),this.type="RingGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:i,phiSegments:n,thetaStart:r,thetaLength:a},this.fromBufferGeometry(new si(e,t,i,n,r,a)),this.mergeVertices()}function si(e,t,n,r,a,o){Te.call(this),this.type="RingBufferGeometry",this.parameters={innerRadius:e,outerRadius:t,thetaSegments:n,phiSegments:r,thetaStart:a,thetaLength:o},e=e||20,t=t||50,a=void 0!==a?a:0,o=void 0!==o?o:2*Math.PI,n=void 0!==n?Math.max(3,n):8,r=void 0!==r?Math.max(1,r):1;var s,c,u,h=[],d=[],f=[],p=[],m=e,g=(t-e)/r,v=new l,y=new i;for(c=0;c<=r;c++){for(u=0;u<=n;u++)s=a+u/n*o,v.x=m*Math.cos(s),v.y=m*Math.sin(s),d.push(v.x,v.y,v.z),f.push(0,0,1),y.x=(v.x/t+1)/2,y.y=(v.y/t+1)/2,p.push(y.x,y.y);m+=g}for(c=0;c<r;c++){var E=c*(n+1);for(u=0;u<n;u++){s=u+E;var x=s,b=s+n+1,C=s+n+2,M=s+1;h.push(x,b,M),h.push(b,C,M)}}this.setIndex(h),this.addAttribute("position",new be(d,3)),this.addAttribute("normal",new be(f,3)),this.addAttribute("uv",new be(p,2))}function li(e,t,i,n){Le.call(this),this.type="LatheGeometry",this.parameters={points:e,segments:t,phiStart:i,phiLength:n},this.fromBufferGeometry(new ci(e,t,i,n)),this.mergeVertices()}function ci(e,t,n,r){Te.call(this),this.type="LatheBufferGeometry",this.parameters={points:e,segments:t,phiStart:n,phiLength:r},t=Math.floor(t)||12,n=n||0,r=r||2*Math.PI,r=hs.clamp(r,0,2*Math.PI);var a,o,s,c=[],u=[],h=[],d=1/t,f=new l,p=new i;for(o=0;o<=t;o++){var m=n+o*d*r,g=Math.sin(m),v=Math.cos(m);for(s=0;s<=e.length-1;s++)f.x=e[s].x*g,f.y=e[s].y,f.z=e[s].x*v,u.push(f.x,f.y,f.z),p.x=o/t,p.y=s/(e.length-1),h.push(p.x,p.y)}for(o=0;o<t;o++)for(s=0;s<e.length-1;s++){a=s+o*e.length;var y=a,E=a+e.length,x=a+e.length+1,b=a+1;c.push(y,E,b),c.push(E,x,b)}if(this.setIndex(c),this.addAttribute("position",new be(u,3)),this.addAttribute("uv",new be(h,2)),this.computeVertexNormals(),r===2*Math.PI){var C=this.attributes.normal.array,M=new l,_=new l,w=new l;for(a=t*e.length*3,o=0,s=0;o<e.length;o++,s+=3)M.x=C[s+0],M.y=C[s+1],M.z=C[s+2],_.x=C[a+s+0],_.y=C[a+s+1],_.z=C[a+s+2],w.addVectors(M,_).normalize(),C[s+0]=C[a+s+0]=w.x,C[s+1]=C[a+s+1]=w.y,C[s+2]=C[a+s+2]=w.z}}function ui(e,t){Le.call(this),this.type="ShapeGeometry","object"===(void 0===t?"undefined":_typeof(t))&&(console.warn("THREE.ShapeGeometry: Options parameter has been removed."),t=t.curveSegments),this.parameters={shapes:e,curveSegments:t},this.fromBufferGeometry(new hi(e,t)),this.mergeVertices()}function hi(e,t){function i(e){var i,s,c,u=r.length/3,h=e.extractPoints(t),d=h.shape,f=h.holes;if(!1===Ss.isClockWise(d))for(d=d.reverse(),i=0,s=f.length;i<s;i++)c=f[i],!0===Ss.isClockWise(c)&&(f[i]=c.reverse());var p=Ss.triangulateShape(d,f);for(i=0,s=f.length;i<s;i++)c=f[i],d=d.concat(c);for(i=0,s=d.length;i<s;i++){var m=d[i];r.push(m.x,m.y,0),a.push(0,0,1),o.push(m.x,m.y)}for(i=0,s=p.length;i<s;i++){var g=p[i],v=g[0]+u,y=g[1]+u,E=g[2]+u;n.push(v,y,E),l+=3}}Te.call(this),this.type="ShapeBufferGeometry",this.parameters={shapes:e,curveSegments:t},t=t||12;var n=[],r=[],a=[],o=[],s=0,l=0;if(!1===Array.isArray(e))i(e);else for(var c=0;c<e.length;c++)i(e[c]),this.addGroup(s,l,c),s+=l,l=0;this.setIndex(n),this.addAttribute("position",new be(r,3)),this.addAttribute("normal",new be(a,3)),this.addAttribute("uv",new be(o,2))}function di(e,t){Te.call(this),this.type="EdgesGeometry",this.parameters={thresholdAngle:t},t=void 0!==t?t:1;var i,n,r,a,o=[],s=Math.cos(hs.DEG2RAD*t),l=[0,0],c={},u=["a","b","c"];e.isBufferGeometry?(a=new Le,a.fromBufferGeometry(e)):a=e.clone(),a.mergeVertices(),a.computeFaceNormals();for(var h=a.vertices,d=a.faces,f=0,p=d.length;f<p;f++)for(var m=d[f],g=0;g<3;g++)i=m[u[g]],n=m[u[(g+1)%3]],l[0]=Math.min(i,n),l[1]=Math.max(i,n),r=l[0]+","+l[1],void 0===c[r]?c[r]={index1:l[0],index2:l[1],face1:f,face2:void 0}:c[r].face2=f;for(r in c){var v=c[r];if(void 0===v.face2||d[v.face1].normal.dot(d[v.face2].normal)<=s){var y=h[v.index1];o.push(y.x,y.y,y.z),y=h[v.index2],o.push(y.x,y.y,y.z)}}this.addAttribute("position",new be(o,3))}function fi(e,t,i,n,r,a,o,s){Le.call(this),this.type="CylinderGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:i,radialSegments:n,heightSegments:r,openEnded:a,thetaStart:o,thetaLength:s},this.fromBufferGeometry(new pi(e,t,i,n,r,a,o,s)),this.mergeVertices()}function pi(e,t,n,r,a,o,s,c){function u(n){var a,o,u,v=new i,x=new l,b=0,C=!0===n?e:t,M=!0===n?1:-1;for(o=g,a=1;a<=r;a++)f.push(0,y*M,0),p.push(0,M,0),m.push(.5,.5),g++;for(u=g,a=0;a<=r;a++){var _=a/r,w=_*c+s,L=Math.cos(w),T=Math.sin(w);x.x=C*T,x.y=y*M,x.z=C*L,f.push(x.x,x.y,x.z),p.push(0,M,0),v.x=.5*L+.5,v.y=.5*T*M+.5,m.push(v.x,v.y),g++}for(a=0;a<r;a++){var I=o+a,S=u+a;!0===n?d.push(S,S+1,I):d.push(S+1,S,I),b+=3}h.addGroup(E,b,!0===n?1:2),E+=b}Te.call(this),this.type="CylinderBufferGeometry",this.parameters={radiusTop:e,radiusBottom:t,height:n,radialSegments:r,heightSegments:a,openEnded:o,thetaStart:s,thetaLength:c};var h=this;e=void 0!==e?e:20,t=void 0!==t?t:20,n=void 0!==n?n:100,r=Math.floor(r)||8,a=Math.floor(a)||1,o=void 0!==o&&o,s=void 0!==s?s:0,c=void 0!==c?c:2*Math.PI;var d=[],f=[],p=[],m=[],g=0,v=[],y=n/2,E=0;!function(){var i,o,u=new l,x=new l,b=0,C=(t-e)/n;for(o=0;o<=a;o++){var M=[],_=o/a,w=_*(t-e)+e;for(i=0;i<=r;i++){var L=i/r,T=L*c+s,I=Math.sin(T),S=Math.cos(T);x.x=w*I,x.y=-_*n+y,x.z=w*S,f.push(x.x,x.y,x.z),u.set(I,C,S).normalize(),p.push(u.x,u.y,u.z),m.push(L,1-_),M.push(g++)}v.push(M)}for(i=0;i<r;i++)for(o=0;o<a;o++){var O=v[o][i],D=v[o+1][i],R=v[o+1][i+1],A=v[o][i+1];d.push(O,D,A),d.push(D,R,A),b+=6}h.addGroup(E,b,0),E+=b}(),!1===o&&(e>0&&u(!0),t>0&&u(!1)),this.setIndex(d),this.addAttribute("position",new be(f,3)),this.addAttribute("normal",new be(p,3)),this.addAttribute("uv",new be(m,2))}function mi(e,t,i,n,r,a,o){fi.call(this,0,e,t,i,n,r,a,o),this.type="ConeGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:a,thetaLength:o}}function gi(e,t,i,n,r,a,o){pi.call(this,0,e,t,i,n,r,a,o),this.type="ConeBufferGeometry",this.parameters={radius:e,height:t,radialSegments:i,heightSegments:n,openEnded:r,thetaStart:a,thetaLength:o}}function vi(e,t,i,n){Le.call(this),this.type="CircleGeometry",this.parameters={radius:e,segments:t,thetaStart:i,thetaLength:n},this.fromBufferGeometry(new yi(e,t,i,n)),this.mergeVertices()}function yi(e,t,n,r){Te.call(this),this.type="CircleBufferGeometry",this.parameters={radius:e,segments:t,thetaStart:n,thetaLength:r},e=e||50,t=void 0!==t?Math.max(3,t):8,n=void 0!==n?n:0,r=void 0!==r?r:2*Math.PI;var a,o,s=[],c=[],u=[],h=[],d=new l,f=new i;for(c.push(0,0,0),u.push(0,0,1),h.push(.5,.5),o=0,a=3;o<=t;o++,a+=3){var p=n+o/t*r;d.x=e*Math.cos(p),d.y=e*Math.sin(p),c.push(d.x,d.y,d.z),u.push(0,0,1),f.x=(c[a]/e+1)/2,f.y=(c[a+1]/e+1)/2,h.push(f.x,f.y)}for(a=1;a<=t;a++)s.push(a,a+1,0);this.setIndex(s),this.addAttribute("position",new be(c,3)),this.addAttribute("normal",new be(u,3)),this.addAttribute("uv",new be(h,2))}function Ei(e){Q.call(this,{uniforms:Cs.merge([bs.lights,{opacity:{value:1}}]),vertexShader:Ms.shadow_vert,fragmentShader:Ms.shadow_frag}),this.lights=!0,this.transparent=!0,Object.defineProperties(this,{opacity:{enumerable:!0,get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity.value=e}}}),this.setValues(e)}function xi(e){Q.call(this,e),this.type="RawShaderMaterial"}function bi(e){K.call(this),this.defines={STANDARD:""},this.type="MeshStandardMaterial",this.color=new j(16777215),this.roughness=.5,this.metalness=.5,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new j(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.roughnessMap=null,this.metalnessMap=null,this.alphaMap=null,this.envMap=null,this.envMapIntensity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Ci(e){bi.call(this),this.defines={PHYSICAL:""},this.type="MeshPhysicalMaterial",this.reflectivity=.5,this.clearCoat=0,this.clearCoatRoughness=0,this.setValues(e)}function Mi(e){K.call(this),this.type="MeshPhongMaterial",this.color=new j(16777215),this.specular=new j(1118481),this.shininess=30,this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new j(0),this.emissiveIntensity=1,this.emissiveMap=null,this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function _i(e){Mi.call(this),this.defines={TOON:""},this.type="MeshToonMaterial",this.gradientMap=null,this.setValues(e)}function wi(e){K.call(this,e),this.type="MeshNormalMaterial",this.bumpMap=null,this.bumpScale=1,this.normalMap=null,this.normalScale=new i(1,1),this.displacementMap=null,this.displacementScale=1,this.displacementBias=0,this.wireframe=!1,this.wireframeLinewidth=1,this.fog=!1,this.lights=!1,this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Li(e){K.call(this),this.type="MeshLambertMaterial",this.color=new j(16777215),this.map=null,this.lightMap=null,this.lightMapIntensity=1,this.aoMap=null,this.aoMapIntensity=1,this.emissive=new j(0),this.emissiveIntensity=1,this.emissiveMap=null,this.specularMap=null,this.alphaMap=null,this.envMap=null,this.combine=Qa,this.reflectivity=1,this.refractionRatio=.98,this.wireframe=!1,this.wireframeLinewidth=1,this.wireframeLinecap="round",this.wireframeLinejoin="round",this.skinning=!1,this.morphTargets=!1,this.morphNormals=!1,this.setValues(e)}function Ti(e){K.call(this),this.type="LineDashedMaterial",this.color=new j(16777215),this.linewidth=1,this.scale=1,this.dashSize=3,this.gapSize=1,this.lights=!1,this.setValues(e)}function Ii(e,t,i){var n=this,r=!1,a=0,o=0;this.onStart=void 0,this.onLoad=e,this.onProgress=t,this.onError=i,this.itemStart=function(e){o++,!1===r&&void 0!==n.onStart&&n.onStart(e,a,o),r=!0},this.itemEnd=function(e){a++,void 0!==n.onProgress&&n.onProgress(e,a,o),a===o&&(r=!1,void 0!==n.onLoad&&n.onLoad())},this.itemError=function(e){void 0!==n.onError&&n.onError(e)}}function Si(e){this.manager=void 0!==e?e:As}function Oi(e){this.manager=void 0!==e?e:As,this._parser=null}function Di(e){this.manager=void 0!==e?e:As,this._parser=null}function Ri(e){this.manager=void 0!==e?e:As}function Ai(e){this.manager=void 0!==e?e:As}function Ui(e){this.manager=void 0!==e?e:As}function Bi(e,t){le.call(this),this.type="Light",this.color=new j(e),this.intensity=void 0!==t?t:1,this.receiveShadow=void 0}function Pi(e,t,i){Bi.call(this,e,i),this.type="HemisphereLight",this.castShadow=void 0,this.position.copy(le.DefaultUp),this.updateMatrix(),this.groundColor=new j(t)}function Ni(e){this.camera=e,this.bias=0,this.radius=1,this.mapSize=new i(512,512),this.map=null,this.matrix=new c}function ki(){Ni.call(this,new Ue(50,1,.5,500))}function Fi(e,t,i,n,r,a){Bi.call(this,e,t),this.type="SpotLight",this.position.copy(le.DefaultUp),this.updateMatrix(),this.target=new le,Object.defineProperty(this,"power",{get:function(){return this.intensity*Math.PI},set:function(e){this.intensity=e/Math.PI}}),this.distance=void 0!==i?i:0,this.angle=void 0!==n?n:Math.PI/3,this.penumbra=void 0!==r?r:0,this.decay=void 0!==a?a:1,this.shadow=new ki}function Hi(e,t,i,n){Bi.call(this,e,t),this.type="PointLight",Object.defineProperty(this,"power",{get:function(){return 4*this.intensity*Math.PI},set:function(e){this.intensity=e/(4*Math.PI)}}),this.distance=void 0!==i?i:0,this.decay=void 0!==n?n:1,this.shadow=new Ni(new Ue(90,1,.5,500))}function Gi(){Ni.call(this,new Be(-5,5,5,-5,.5,500))}function Vi(e,t){Bi.call(this,e,t),this.type="DirectionalLight",this.position.copy(le.DefaultUp),this.updateMatrix(),this.target=new le,this.shadow=new Gi}function zi(e,t){Bi.call(this,e,t),this.type="AmbientLight",this.castShadow=void 0}function Wi(e,t,i,n){Bi.call(this,e,t),this.type="RectAreaLight",this.position.set(0,1,0),this.updateMatrix(),this.width=void 0!==i?i:10,this.height=void 0!==n?n:10}function qi(e,t,i,n){this.parameterPositions=e,this._cachedIndex=0,this.resultBuffer=void 0!==n?n:new t.constructor(i),this.sampleValues=t,this.valueSize=i}function ji(e,t,i,n){qi.call(this,e,t,i,n),this._weightPrev=-0,this._offsetPrev=-0,this._weightNext=-0,this._offsetNext=-0}function Xi(e,t,i,n){qi.call(this,e,t,i,n)}function Yi(e,t,i,n){qi.call(this,e,t,i,n)}function Zi(e,t,i,n){if(void 0===e)throw new Error("track name is undefined");if(void 0===t||0===t.length)throw new Error("no keyframes in track named "+e);this.name=e,this.times=Us.convertArray(t,this.TimeBufferType),this.values=Us.convertArray(i,this.ValueBufferType),this.setInterpolation(n||this.DefaultInterpolation),this.validate(),this.optimize()}function Ki(e,t,i,n){Zi.call(this,e,t,i,n)}function Qi(e,t,i,n){qi.call(this,e,t,i,n)}function Ji(e,t,i,n){Zi.call(this,e,t,i,n)}function $i(e,t,i,n){Zi.call(this,e,t,i,n)}function en(e,t,i,n){Zi.call(this,e,t,i,n)}function tn(e,t,i){Zi.call(this,e,t,i)}function nn(e,t,i,n){Zi.call(this,e,t,i,n)}function rn(e,t,i,n){Zi.apply(this,arguments)}function an(e,t,i){this.name=e,this.tracks=i,this.duration=void 0!==t?t:-1,this.uuid=hs.generateUUID(),this.duration<0&&this.resetDuration(),this.optimize()}function on(e){this.manager=void 0!==e?e:As,this.textures={}}function sn(e){this.manager=void 0!==e?e:As}function ln(){this.onLoadStart=function(){},this.onLoadProgress=function(){},this.onLoadComplete=function(){}}function cn(e){"boolean"==typeof e&&(console.warn("THREE.JSONLoader: showStatus parameter has been removed from constructor."),e=void 0),this.manager=void 0!==e?e:As,this.withCredentials=!1}function un(e){this.manager=void 0!==e?e:As,this.texturePath=""}function hn(e,t,i,n,r){var a=.5*(n-t),o=.5*(r-i),s=e*e;return(2*i-2*n+a+o)*(e*s)+(-3*i+3*n-2*a-o)*s+a*e+i}function dn(e,t){var i=1-e;return i*i*t}function fn(e,t){return 2*(1-e)*e*t}function pn(e,t){return e*e*t}function mn(e,t,i,n){return dn(e,t)+fn(e,i)+pn(e,n)}function gn(e,t){var i=1-e;return i*i*i*t}function vn(e,t){var i=1-e;return 3*i*i*e*t}function yn(e,t){return 3*(1-e)*e*e*t}function En(e,t){return e*e*e*t}function xn(e,t,i,n,r){return gn(e,t)+vn(e,i)+yn(e,n)+En(e,r)}function bn(){this.arcLengthDivisions=200}function Cn(e,t){bn.call(this),this.v1=e,this.v2=t}function Mn(){bn.call(this),this.curves=[],this.autoClose=!1}function _n(e,t,i,n,r,a,o,s){bn.call(this),this.aX=e,this.aY=t,this.xRadius=i,this.yRadius=n,this.aStartAngle=r,this.aEndAngle=a,this.aClockwise=o,this.aRotation=s||0}function wn(e){bn.call(this),this.points=void 0===e?[]:e}function Ln(e,t,i,n){bn.call(this),this.v0=e,this.v1=t,this.v2=i,this.v3=n}function Tn(e,t,i){bn.call(this),this.v0=e,this.v1=t,this.v2=i}function In(e){Mn.call(this),this.currentPoint=new i,e&&this.fromPoints(e)}function Sn(){In.apply(this,arguments),this.holes=[]}function On(){this.subPaths=[],this.currentPath=null}function Dn(e){this.data=e}function Rn(e){this.manager=void 0!==e?e:As}function An(e){this.manager=void 0!==e?e:As}function Un(){this.type="StereoCamera",this.aspect=1,this.eyeSep=.064,this.cameraL=new Ue,this.cameraL.layers.enable(1),this.cameraL.matrixAutoUpdate=!1,this.cameraR=new Ue,this.cameraR.layers.enable(2),this.cameraR.matrixAutoUpdate=!1}function Bn(e,t,i){le.call(this),this.type="CubeCamera";var n=new Ue(90,1,e,t);n.up.set(0,-1,0),n.lookAt(new l(1,0,0)),this.add(n);var r=new Ue(90,1,e,t);r.up.set(0,-1,0),r.lookAt(new l(-1,0,0)),this.add(r);var a=new Ue(90,1,e,t);a.up.set(0,0,1),a.lookAt(new l(0,1,0)),this.add(a);var s=new Ue(90,1,e,t);s.up.set(0,0,-1),s.lookAt(new l(0,-1,0)),this.add(s);var c=new Ue(90,1,e,t);c.up.set(0,-1,0),c.lookAt(new l(0,0,1)),this.add(c);var u=new Ue(90,1,e,t);u.up.set(0,-1,0),u.lookAt(new l(0,0,-1)),this.add(u);var h={format:Bo,magFilter:Eo,minFilter:Eo};this.renderTarget=new o(i,i,h),this.renderTarget.texture.name="CubeCamera",this.updateCubeMap=function(e,t){null===this.parent&&this.updateMatrixWorld();var i=this.renderTarget,o=i.texture.generateMipmaps;i.texture.generateMipmaps=!1,i.activeCubeFace=0,e.render(t,n,i),i.activeCubeFace=1,e.render(t,r,i),i.activeCubeFace=2,e.render(t,a,i),i.activeCubeFace=3,e.render(t,s,i),i.activeCubeFace=4,e.render(t,c,i),i.texture.generateMipmaps=o,i.activeCubeFace=5,e.render(t,u,i),
e.setRenderTarget(null)}}function Pn(e){Ue.call(this),this.enabled=!1,this.cameras=e||[]}function Nn(){le.call(this),this.type="AudioListener",this.context=Vs.getContext(),this.gain=this.context.createGain(),this.gain.connect(this.context.destination),this.filter=null}function kn(e){le.call(this),this.type="Audio",this.context=e.context,this.gain=this.context.createGain(),this.gain.connect(e.getInput()),this.autoplay=!1,this.buffer=null,this.loop=!1,this.startTime=0,this.playbackRate=1,this.isPlaying=!1,this.hasPlaybackControl=!0,this.sourceType="empty",this.filters=[]}function Fn(e){kn.call(this,e),this.panner=this.context.createPanner(),this.panner.connect(this.gain)}function Hn(e,t){this.analyser=e.context.createAnalyser(),this.analyser.fftSize=void 0!==t?t:2048,this.data=new Uint8Array(this.analyser.frequencyBinCount),e.getOutput().connect(this.analyser)}function Gn(e,t,i){this.binding=e,this.valueSize=i;var n,r=Float64Array;switch(t){case"quaternion":n=this._slerp;break;case"string":case"bool":r=Array,n=this._select;break;default:n=this._lerp}this.buffer=new r(4*i),this._mixBufferRegion=n,this.cumulativeWeight=0,this.useCount=0,this.referenceCount=0}function Vn(e,t,i){var n=i||zn.parseTrackName(t);this._targetGroup=e,this._bindings=e.subscribe_(t,n)}function zn(e,t,i){this.path=t,this.parsedPath=i||zn.parseTrackName(t),this.node=zn.findNode(e,this.parsedPath.nodeName)||e,this.rootNode=e}function Wn(e){this.uuid=hs.generateUUID(),this._objects=Array.prototype.slice.call(arguments),this.nCachedObjects_=0;var t={};this._indicesByUUID=t;for(var i=0,n=arguments.length;i!==n;++i)t[arguments[i].uuid]=i;this._paths=[],this._parsedPaths=[],this._bindings=[],this._bindingsIndicesByPath={};var r=this;this.stats={objects:{get total(){return r._objects.length},get inUse(){return this.total-r.nCachedObjects_}},get bindingsPerObject(){return r._bindings.length}}}function qn(e,t,i){this._mixer=e,this._clip=t,this._localRoot=i||null;for(var n=t.tracks,r=n.length,a=new Array(r),o={endingStart:Jo,endingEnd:Jo},s=0;s!==r;++s){var l=n[s].createInterpolant(null);a[s]=l,l.settings=o}this._interpolantSettings=o,this._interpolants=a,this._propertyBindings=new Array(r),this._cacheIndex=null,this._byClipCacheIndex=null,this._timeScaleInterpolant=null,this._weightInterpolant=null,this.loop=Qo,this._loopCount=-1,this._startTime=null,this.time=0,this.timeScale=1,this._effectiveTimeScale=1,this.weight=1,this._effectiveWeight=1,this.repetitions=1/0,this.paused=!1,this.enabled=!0,this.clampWhenFinished=!1,this.zeroSlopeAtStart=!0,this.zeroSlopeAtEnd=!0}function jn(e){this._root=e,this._initMemoryManager(),this._accuIndex=0,this.time=0,this.timeScale=1}function Xn(e){"string"==typeof e&&(console.warn("THREE.Uniform: Type parameter is no longer needed."),e=arguments[1]),this.value=e}function Yn(){Te.call(this),this.type="InstancedBufferGeometry",this.maxInstancedCount=void 0}function Zn(e,t,i,n){this.uuid=hs.generateUUID(),this.data=e,this.itemSize=t,this.offset=i,this.normalized=!0===n}function Kn(e,t){this.uuid=hs.generateUUID(),this.array=e,this.stride=t,this.count=void 0!==e?e.length/t:0,this.dynamic=!1,this.updateRange={offset:0,count:-1},this.onUploadCallback=function(){},this.version=0}function Qn(e,t,i){Kn.call(this,e,t),this.meshPerAttribute=i||1}function Jn(e,t,i){fe.call(this,e,t),this.meshPerAttribute=i||1}function $n(e,t,i,n){this.ray=new ae(e,t),this.near=i||0,this.far=n||1/0,this.params={Mesh:{},Line:{},LOD:{},Points:{threshold:1},Sprite:{}},Object.defineProperties(this.params,{PointCloud:{get:function(){return console.warn("THREE.Raycaster: params.PointCloud has been renamed to params.Points."),this.Points}}})}function er(e,t){return e.distance-t.distance}function tr(e,t,i,n){if(!1!==e.visible&&(e.raycast(t,i),!0===n))for(var r=e.children,a=0,o=r.length;a<o;a++)tr(r[a],t,i,!0)}function ir(e){this.autoStart=void 0===e||e,this.startTime=0,this.oldTime=0,this.elapsedTime=0,this.running=!1}function nr(e,t,i){return this.radius=void 0!==e?e:1,this.phi=void 0!==t?t:0,this.theta=void 0!==i?i:0,this}function rr(e,t,i){return this.radius=void 0!==e?e:1,this.theta=void 0!==t?t:0,this.y=void 0!==i?i:0,this}function ar(e,t){Ie.call(this,e,t),this.animationsMap={},this.animationsList=[];var i=this.geometry.morphTargets.length,n=i-1,r=i/1;this.createAnimation("__default",0,n,r),this.setAnimationWeight("__default",1)}function or(e){le.call(this),this.material=e,this.render=function(e){}}function sr(e,t,i,n){this.object=e,this.size=void 0!==t?t:1;var r=void 0!==i?i:16711680,a=void 0!==n?n:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=3*s.faces.length:s&&s.isBufferGeometry&&(o=s.attributes.normal.count);var l=new Te,c=new be(2*o*3,3);l.addAttribute("position",c),Lt.call(this,l,new _t({color:r,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function lr(e){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;for(var t=new Te,i=[0,0,0,0,0,1,0,0,0,1,0,1,0,0,0,-1,0,1,0,0,0,0,1,1,0,0,0,0,-1,1],n=0,r=1;n<32;n++,r++){var a=n/32*Math.PI*2,o=r/32*Math.PI*2;i.push(Math.cos(a),Math.sin(a),1,Math.cos(o),Math.sin(o),1)}t.addAttribute("position",new be(i,3));var s=new _t({fog:!1});this.cone=new Lt(t,s),this.add(this.cone),this.update()}function cr(e){this.bones=this.getBoneList(e);for(var t=new Te,i=[],n=[],r=new j(0,0,1),a=new j(0,1,0),o=0;o<this.bones.length;o++){var s=this.bones[o];s.parent&&s.parent.isBone&&(i.push(0,0,0),i.push(0,0,0),n.push(r.r,r.g,r.b),n.push(a.r,a.g,a.b))}t.addAttribute("position",new be(i,3)),t.addAttribute("color",new be(n,3));var l=new _t({vertexColors:xa,depthTest:!1,depthWrite:!1,transparent:!0});Lt.call(this,t,l),this.root=e,this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.update()}function ur(e,t){this.light=e,this.light.updateMatrixWorld();var i=new ai(t,4,2),n=new de({wireframe:!0,fog:!1});n.color.copy(this.light.color),Ie.call(this,i,n),this.matrix=this.light.matrixWorld,this.matrixAutoUpdate=!1}function hr(e){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var t=new _t({color:e.color}),i=new Te;i.addAttribute("position",new fe(new Float32Array(15),3)),this.add(new wt(i,t)),this.update()}function dr(e,t){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1;var i=new zt(t);i.rotateY(.5*Math.PI);var n=new de({vertexColors:xa,wireframe:!0}),r=i.getAttribute("position"),a=new Float32Array(3*r.count);i.addAttribute("color",new fe(a,3)),this.add(new Ie(i,n)),this.update()}function fr(e,t,i,n){e=e||10,t=t||10,i=new j(void 0!==i?i:4473924),n=new j(void 0!==n?n:8947848);for(var r=t/2,a=e/t,o=e/2,s=[],l=[],c=0,u=0,h=-o;c<=t;c++,h+=a){s.push(-o,0,h,o,0,h),s.push(h,0,-o,h,0,o);var d=c===r?i:n;d.toArray(l,u),u+=3,d.toArray(l,u),u+=3,d.toArray(l,u),u+=3,d.toArray(l,u),u+=3}var f=new Te;f.addAttribute("position",new be(s,3)),f.addAttribute("color",new be(l,3));var p=new _t({vertexColors:xa});Lt.call(this,f,p)}function pr(e,t,i,n,r,a){e=e||10,t=t||16,i=i||8,n=n||64,r=new j(void 0!==r?r:4473924),a=new j(void 0!==a?a:8947848);var o,s,l,c,u,h,d,f=[],p=[];for(c=0;c<=t;c++)l=c/t*(2*Math.PI),o=Math.sin(l)*e,s=Math.cos(l)*e,f.push(0,0,0),f.push(o,0,s),d=1&c?r:a,p.push(d.r,d.g,d.b),p.push(d.r,d.g,d.b);for(c=0;c<=i;c++)for(d=1&c?r:a,h=e-e/i*c,u=0;u<n;u++)l=u/n*(2*Math.PI),o=Math.sin(l)*h,s=Math.cos(l)*h,f.push(o,0,s),p.push(d.r,d.g,d.b),l=(u+1)/n*(2*Math.PI),o=Math.sin(l)*h,s=Math.cos(l)*h,f.push(o,0,s),p.push(d.r,d.g,d.b);var m=new Te;m.addAttribute("position",new be(f,3)),m.addAttribute("color",new be(p,3));var g=new _t({vertexColors:xa});Lt.call(this,m,g)}function mr(e,t,i,n){this.object=e,this.size=void 0!==t?t:1;var r=void 0!==i?i:16776960,a=void 0!==n?n:1,o=0,s=this.object.geometry;s&&s.isGeometry?o=s.faces.length:console.warn("THREE.FaceNormalsHelper: only THREE.Geometry is supported. Use THREE.VertexNormalsHelper, instead.");var l=new Te,c=new be(2*o*3,3);l.addAttribute("position",c),Lt.call(this,l,new _t({color:r,linewidth:a})),this.matrixAutoUpdate=!1,this.update()}function gr(e,t){le.call(this),this.light=e,this.light.updateMatrixWorld(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,void 0===t&&(t=1);var i=new Te;i.addAttribute("position",new be([-t,t,0,t,t,0,t,-t,0,-t,-t,0,-t,t,0],3));var n=new _t({fog:!1});this.add(new wt(i,n)),i=new Te,i.addAttribute("position",new be([0,0,0,0,0,1],3)),this.add(new wt(i,n)),this.update()}function vr(e){function t(e,t,n){i(e,n),i(t,n)}function i(e,t){a.push(0,0,0),o.push(t.r,t.g,t.b),void 0===s[e]&&(s[e]=[]),s[e].push(a.length/3-1)}var n=new Te,r=new _t({color:16777215,vertexColors:Ea}),a=[],o=[],s={},l=new j(16755200),c=new j(16711680),u=new j(43775),h=new j(16777215),d=new j(3355443);t("n1","n2",l),t("n2","n4",l),t("n4","n3",l),t("n3","n1",l),t("f1","f2",l),t("f2","f4",l),t("f4","f3",l),t("f3","f1",l),t("n1","f1",l),t("n2","f2",l),t("n3","f3",l),t("n4","f4",l),t("p","n1",c),t("p","n2",c),t("p","n3",c),t("p","n4",c),t("u1","u2",u),t("u2","u3",u),t("u3","u1",u),t("c","t",h),t("p","c",d),t("cn1","cn2",d),t("cn3","cn4",d),t("cf1","cf2",d),t("cf3","cf4",d),n.addAttribute("position",new be(a,3)),n.addAttribute("color",new be(o,3)),Lt.call(this,n,r),this.camera=e,this.camera.updateProjectionMatrix&&this.camera.updateProjectionMatrix(),this.matrix=e.matrixWorld,this.matrixAutoUpdate=!1,this.pointMap=s,this.update()}function yr(e,t){this.object=e,void 0===t&&(t=16776960);var i=new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),n=new Float32Array(24),r=new Te;r.setIndex(new fe(i,1)),r.addAttribute("position",new fe(n,3)),Lt.call(this,r,new _t({color:t})),this.matrixAutoUpdate=!1,this.update()}function Er(e,t,i,n,r,a){le.call(this),void 0===n&&(n=16776960),void 0===i&&(i=1),void 0===r&&(r=.2*i),void 0===a&&(a=.2*r),void 0===zs&&(zs=new Te,zs.addAttribute("position",new be([0,0,0,0,1,0],3)),Ws=new pi(0,.5,1,5,1),Ws.translate(0,-.5,0)),this.position.copy(t),this.line=new wt(zs,new _t({color:n})),this.line.matrixAutoUpdate=!1,this.add(this.line),this.cone=new Ie(Ws,new de({color:n})),this.cone.matrixAutoUpdate=!1,this.add(this.cone),this.setDirection(e),this.setLength(i,r,a)}function xr(e){e=e||1;var t=[0,0,0,e,0,0,0,0,0,0,e,0,0,0,0,0,0,e],i=[1,0,0,1,.6,0,0,1,0,.6,1,0,0,0,1,0,.6,1],n=new Te;n.addAttribute("position",new be(t,3)),n.addAttribute("color",new be(i,3));var r=new _t({vertexColors:xa});Lt.call(this,n,r)}function br(){function e(e,a,o,s){t=e,i=o,n=-3*e+3*a-2*o-s,r=2*e-2*a+o+s}var t=0,i=0,n=0,r=0;return{initCatmullRom:function(t,i,n,r,a){e(i,n,a*(n-t),a*(r-i))},initNonuniformCatmullRom:function(t,i,n,r,a,o,s){var l=(i-t)/a-(n-t)/(a+o)+(n-i)/o,c=(n-i)/o-(r-i)/(o+s)+(r-n)/s;l*=o,c*=o,e(i,n,l,c)},calc:function(e){var a=e*e;return t+i*e+n*a+r*(a*e)}}}function Cr(e){bn.call(this),this.points=e||[],this.closed=!1}function Mr(e,t,i,n){bn.call(this),this.v0=e,this.v1=t,this.v2=i,this.v3=n}function _r(e,t,i){bn.call(this),this.v0=e,this.v1=t,this.v2=i}function wr(e,t){bn.call(this),this.v1=e,this.v2=t}function Lr(e,t,i,n,r,a){_n.call(this,e,t,i,i,n,r,a)}function Tr(e,t,i,n,r,a,o){return console.warn("THREE.Face4 has been removed. A THREE.Face3 will be created instead."),new he(e,t,i,r,a,o)}function Ir(e){return console.warn("THREE.MeshFaceMaterial has been removed. Use an Array instead."),e}function Sr(e){return void 0===e&&(e=[]),console.warn("THREE.MultiMaterial has been removed. Use an Array instead."),e.isMultiMaterial=!0,e.materials=e,e.clone=function(){return e.slice()},e}function Or(e,t){return console.warn("THREE.PointCloud has been renamed to THREE.Points."),new St(e,t)}function Dr(e){return console.warn("THREE.Particle has been renamed to THREE.Sprite."),new Et(e)}function Rr(e,t){return console.warn("THREE.ParticleSystem has been renamed to THREE.Points."),new St(e,t)}function Ar(e){return console.warn("THREE.PointCloudMaterial has been renamed to THREE.PointsMaterial."),new It(e)}function Ur(e){return console.warn("THREE.ParticleBasicMaterial has been renamed to THREE.PointsMaterial."),new It(e)}function Br(e){return console.warn("THREE.ParticleSystemMaterial has been renamed to THREE.PointsMaterial."),new It(e)}function Pr(e,t,i){return console.warn("THREE.Vertex has been removed. Use THREE.Vector3 instead."),new l(e,t,i)}function Nr(e,t){return console.warn("THREE.DynamicBufferAttribute has been removed. Use new THREE.BufferAttribute().setDynamic( true ) instead."),new fe(e,t).setDynamic(!0)}function kr(e,t){return console.warn("THREE.Int8Attribute has been removed. Use new THREE.Int8BufferAttribute() instead."),new pe(e,t)}function Fr(e,t){return console.warn("THREE.Uint8Attribute has been removed. Use new THREE.Uint8BufferAttribute() instead."),new me(e,t)}function Hr(e,t){return console.warn("THREE.Uint8ClampedAttribute has been removed. Use new THREE.Uint8ClampedBufferAttribute() instead."),new ge(e,t)}function Gr(e,t){return console.warn("THREE.Int16Attribute has been removed. Use new THREE.Int16BufferAttribute() instead."),new ve(e,t)}function Vr(e,t){return console.warn("THREE.Uint16Attribute has been removed. Use new THREE.Uint16BufferAttribute() instead."),new ye(e,t)}function zr(e,t){return console.warn("THREE.Int32Attribute has been removed. Use new THREE.Int32BufferAttribute() instead."),new Ee(e,t)}function Wr(e,t){return console.warn("THREE.Uint32Attribute has been removed. Use new THREE.Uint32BufferAttribute() instead."),new xe(e,t)}function qr(e,t){return console.warn("THREE.Float32Attribute has been removed. Use new THREE.Float32BufferAttribute() instead."),new be(e,t)}function jr(e,t){return console.warn("THREE.Float64Attribute has been removed. Use new THREE.Float64BufferAttribute() instead."),new Ce(e,t)}function Xr(e){console.warn("THREE.ClosedSplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Cr.call(this,e),this.type="catmullrom",this.closed=!0}function Yr(e){console.warn("THREE.SplineCurve3 has been deprecated. Use THREE.CatmullRomCurve3 instead."),Cr.call(this,e),this.type="catmullrom"}function Zr(e){console.warn("THREE.Spline has been removed. Use THREE.CatmullRomCurve3 instead."),Cr.call(this,e),this.type="catmullrom"}function Kr(e,t){return console.warn("THREE.BoundingBoxHelper has been deprecated. Creating a THREE.BoxHelper instead."),new yr(e,t)}function Qr(e,t){return console.warn("THREE.EdgesHelper has been removed. Use THREE.EdgesGeometry instead."),new Lt(new di(e.geometry),new _t({color:void 0!==t?t:16777215}))}function Jr(e,t){return console.warn("THREE.WireframeHelper has been removed. Use THREE.WireframeGeometry instead."),new Lt(new Bt(e.geometry),new _t({color:void 0!==t?t:16777215}))}function $r(e){return console.warn("THREE.XHRLoader has been renamed to THREE.FileLoader."),new Si(e)}function ea(e){return console.warn("THREE.BinaryTextureLoader has been renamed to THREE.DataTextureLoader."),new Di(e)}function ta(){console.error("THREE.Projector has been moved to /examples/js/renderers/Projector.js."),this.projectVector=function(e,t){console.warn("THREE.Projector: .projectVector() is now vector.project()."),e.project(t)},this.unprojectVector=function(e,t){console.warn("THREE.Projector: .unprojectVector() is now vector.unproject()."),e.unproject(t)},this.pickingRay=function(){console.error("THREE.Projector: .pickingRay() is now raycaster.setFromCamera().")}}function ia(){console.error("THREE.CanvasRenderer has been moved to /examples/js/renderers/CanvasRenderer.js"),this.domElement=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),this.clear=function(){},this.render=function(){},this.setClearColor=function(){},this.setSize=function(){}}function na(e,t,i,n){function r(e,n){null!==n.index&&t.remove(n.index);for(var r in n.attributes)t.remove(n.attributes[r]);var a=c[e];a&&(t.remove(a),delete c[e]),a=c[n.id],a&&(t.remove(a),delete c[n.id]),i.geometries--}function a(e,t){var n=t.id;if(l.has(n))return l.get(n);var r;return t.isBufferGeometry?r=t:t.isGeometry&&(void 0===t._bufferGeometry&&(t._bufferGeometry=(new Te).setFromObject(e)),r=t._bufferGeometry),l.set(n,r),i.geometries++,r}function o(i){var n=i.index,r=i.attributes;null!==n&&t.update(n,e.ELEMENT_ARRAY_BUFFER);for(var a in r)t.update(r[a],e.ARRAY_BUFFER);var o=i.morphAttributes;for(var a in o)for(var s=o[a],l=0,c=s.length;l<c;l++)t.update(s[l],e.ARRAY_BUFFER)}function s(i){var n=c[i.id];if(n)return n;var r=[],a=i.index,o=i.attributes;if(null!==a)for(var s=a.array,l=0,u=s.length;l<u;l+=3){var h=s[l+0],d=s[l+1],f=s[l+2];r.push(h,d,d,f,f,h)}else for(var s=o.position.array,l=0,u=s.length/3-1;l<u;l+=3){var h=l+0,d=l+1,f=l+2;r.push(h,d,d,f,f,h)}return n=new(_e(r)>65535?xe:ye)(r,1),t.update(n,e.ELEMENT_ARRAY_BUFFER),c[i.id]=n,n}var l=new LRUMap(n),c={};return l.shift=function(){var e=LRUMap.prototype.shift.call(this);r(e[0],e[1])},{get:a,update:o,getWireframeAttribute:s}}function ra(e){function t(){return null===Q?de:1}function i(){Ae.init(),Ae.scissor(ie.copy(fe).multiplyScalar(de)),Ae.viewport(oe.copy(me).multiplyScalar(de)),Ae.buffers.color.setClear(le.r,le.g,le.b,ce,N)}function n(){K=null,te=null,ee="",$=-1,Ae.reset()}function a(e){e.preventDefault(),n(),i(),Ue.clear(),ke.clear()}function o(e){var t=e.target;t.removeEventListener("dispose",o),s(t)}function s(e){h(e),Ue.remove(e)}function h(e){var t=Ue.get(e).program;e.program=void 0,void 0!==t&&Fe.releaseProgram(t)}function d(e,t){return Math.abs(t[0])-Math.abs(e[0])}function f(e,t,i,n){if(i&&i.isInstancedBufferGeometry&&null===Oe.get("ANGLE_instanced_arrays"))return void console.error("THREE.WebGLRenderer.setupVertexAttributes: using THREE.InstancedBufferGeometry but hardware does not support extension ANGLE_instanced_arrays.");void 0===n&&(n=0),Ae.initAttributes();var r=i.attributes,a=t.getAttributes(),o=e.defaultAttributeValues;for(var s in a){var l=a[s];if(l>=0){var c=r[s];if(void 0!==c){var u=c.normalized,h=c.itemSize,d=Ne.get(c),f=d.buffer,p=d.type,m=d.bytesPerElement;if(c.isInterleavedBufferAttribute){var g=c.data,v=g.stride,y=c.offset;g&&g.isInstancedInterleavedBuffer?(Ae.enableAttributeAndDivisor(l,g.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=g.meshPerAttribute*g.count)):Ae.enableAttribute(l),Ie.bindBuffer(Ie.ARRAY_BUFFER,f),Ie.vertexAttribPointer(l,h,p,u,v*m,(n*v+y)*m)}else c.isInstancedBufferAttribute?(Ae.enableAttributeAndDivisor(l,c.meshPerAttribute),void 0===i.maxInstancedCount&&(i.maxInstancedCount=c.meshPerAttribute*c.count)):Ae.enableAttribute(l),Ie.bindBuffer(Ie.ARRAY_BUFFER,f),Ie.vertexAttribPointer(l,h,p,u,0,n*h*m)}else if(void 0!==o){var E=o[s];if(void 0!==E)switch(E.length){case 2:Ie.vertexAttrib2fv(l,E);break;case 3:Ie.vertexAttrib3fv(l,E);break;case 4:Ie.vertexAttrib4fv(l,E);break;default:Ie.vertexAttrib1fv(l,E)}}}}Ae.disableUnusedAttributes()}function p(e,t,i){var n=Ue.get(e),r=Fe.getParameters(e,_e,t,ve.numPlanes,ve.numIntersection,i),a=Fe.getProgramCode(e,r),s=n.program,l=!0;if(void 0===s)e.addEventListener("dispose",o);else if(s.code!==a)h(e);else{if(void 0!==r.shaderID)return;l=!1}if(l){if(r.shaderID){var c=_s[r.shaderID];n.__webglShader={name:e.type,uniforms:Cs.clone(c.uniforms),vertexShader:c.vertexShader,fragmentShader:c.fragmentShader}}else n.__webglShader={name:e.type,uniforms:e.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader};e.__webglShader=n.__webglShader,s=Fe.acquireProgram(e,r,a),n.program=s,e.program=s}var u=s.getAttributes();if(e.morphTargets){e.numSupportedMorphTargets=0;for(var d=0;d<X.maxMorphTargets;d++)u["morphTarget"+d]>=0&&e.numSupportedMorphTargets++}if(e.morphNormals){e.numSupportedMorphNormals=0;for(var d=0;d<X.maxMorphNormals;d++)u["morphNormal"+d]>=0&&e.numSupportedMorphNormals++}var f=n.__webglShader.uniforms;(e.isShaderMaterial||e.isRawShaderMaterial)&&!0!==e.clipping||(n.numClippingPlanes=ve.numPlanes,n.numIntersection=ve.numIntersection,f.clippingPlanes=ve.uniform),n.fog=t,n.lightsHash=_e.hash,e.lights&&(f.ambientLightColor.value=_e.ambient,f.directionalLights.value=_e.directional,f.spotLights.value=_e.spot,f.rectAreaLights.value=_e.rectArea,f.pointLights.value=_e.point,f.hemisphereLights.value=_e.hemi,f.directionalShadowMap.value=_e.directionalShadowMap,f.directionalShadowMatrix.value=_e.directionalShadowMatrix,f.spotShadowMap.value=_e.spotShadowMap,f.spotShadowMatrix.value=_e.spotShadowMatrix,f.pointShadowMap.value=_e.pointShadowMap,f.pointShadowMatrix.value=_e.pointShadowMatrix);var p=n.program.getUniforms(),m=q.seqWithValue(p.seq,f);n.uniformsList=m}function m(e,t,i,n){se=0;var r=Ue.get(i);if(ye&&(Ee||e!==te)){var a=e===te&&i.id===$;ve.setState(i.clippingPlanes,i.clipIntersection,i.clipShadows,e,r,a)}!1===i.needsUpdate&&(void 0===r.program?i.needsUpdate=!0:i.fog&&r.fog!==t?i.needsUpdate=!0:i.lights&&r.lightsHash!==_e.hash?i.needsUpdate=!0:void 0===r.numClippingPlanes||r.numClippingPlanes===ve.numPlanes&&r.numIntersection===ve.numIntersection||(i.needsUpdate=!0)),i.needsUpdate&&(p(i,t,n),i.needsUpdate=!1);var o=!1,s=!1,l=!1,c=r.program,h=c.getUniforms(),d=r.__webglShader.uniforms;if(c.id!==K&&(Ie.useProgram(c.program),K=c.id,o=!0,s=!0,l=!0),i.id!==$&&($=i.id,s=!0),o||e!==te){if(h.setValue(Ie,"projectionMatrix",e.projectionMatrix),Re.logarithmicDepthBuffer&&h.setValue(Ie,"logDepthBufFC",2/(Math.log(e.far+1)/Math.LN2)),e!==te&&(te=e,s=!0,l=!0),i.isShaderMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.envMap){var f=h.map.cameraPosition;void 0!==f&&f.setValue(Ie,be.setFromMatrixPosition(e.matrixWorld))}(i.isMeshPhongMaterial||i.isMeshLambertMaterial||i.isMeshBasicMaterial||i.isMeshStandardMaterial||i.isShaderMaterial||i.skinning)&&h.setValue(Ie,"viewMatrix",e.matrixWorldInverse),h.setValue(Ie,"toneMappingExposure",X.toneMappingExposure),h.setValue(Ie,"toneMappingWhitePoint",X.toneMappingWhitePoint)}if(i.skinning){h.setOptional(Ie,n,"bindMatrix"),h.setOptional(Ie,n,"bindMatrixInverse");var m=n.skeleton;if(m){var I=m.bones;if(Re.floatVertexTextures){if(void 0===m.boneTexture){var S=Math.sqrt(4*I.length);S=hs.nextPowerOfTwo(Math.ceil(S)),S=Math.max(S,4);var O=new Float32Array(S*S*4);O.set(m.boneMatrices);var D=new u(O,S,S,Po,Io);m.boneMatrices=O,m.boneTexture=D,m.boneTextureSize=S}h.setValue(Ie,"boneTexture",m.boneTexture),h.setValue(Ie,"boneTextureSize",m.boneTextureSize)}else h.setOptional(Ie,m,"boneMatrices")}}if(s&&(i.lights&&T(d,l),t&&i.fog&&x(d,t),(i.isMeshBasicMaterial||i.isMeshLambertMaterial||i.isMeshPhongMaterial||i.isMeshStandardMaterial||i.isMeshNormalMaterial||i.isMeshDepthMaterial)&&g(d,i),i.isLineBasicMaterial?v(d,i):i.isLineDashedMaterial?(v(d,i),y(d,i)):i.isPointsMaterial?E(d,i):i.isMeshLambertMaterial?b(d,i):i.isMeshToonMaterial?M(d,i):i.isMeshPhongMaterial?C(d,i):i.isMeshPhysicalMaterial?w(d,i):i.isMeshStandardMaterial?_(d,i):i.isMeshDepthMaterial?i.displacementMap&&(d.displacementMap.value=i.displacementMap,d.displacementScale.value=i.displacementScale,d.displacementBias.value=i.displacementBias):i.isMeshNormalMaterial&&L(d,i),void 0!==d.ltcMat&&(d.ltcMat.value=bs.LTC_MAT_TEXTURE),void 0!==d.ltcMag&&(d.ltcMag.value=bs.LTC_MAG_TEXTURE),q.upload(Ie,r.uniformsList,d,X)),h.map.objId){var R=n.originalId;W.set((R>>16&255)/255,(R>>8&255)/255,(255&R)/255),h.setValue(Ie,"objId",W)}return h.setValue(Ie,"modelViewMatrix",n.modelViewMatrix),h.setValue(Ie,"normalMatrix",n.normalMatrix),h.setValue(Ie,"modelMatrix",n.matrixWorld),c}function g(e,t){e.opacity.value=t.opacity,e.diffuse.value=t.color,t.emissive&&e.emissive.value.copy(t.emissive).multiplyScalar(t.emissiveIntensity),e.map.value=t.map,e.specularMap.value=t.specularMap,e.alphaMap.value=t.alphaMap,t.lightMap&&(e.lightMap.value=t.lightMap,e.lightMapIntensity.value=t.lightMapIntensity),t.aoMap&&(e.aoMap.value=t.aoMap,e.aoMapIntensity.value=t.aoMapIntensity);var i;if(t.map?i=t.map:t.specularMap?i=t.specularMap:t.displacementMap?i=t.displacementMap:t.normalMap?i=t.normalMap:t.bumpMap?i=t.bumpMap:t.roughnessMap?i=t.roughnessMap:t.metalnessMap?i=t.metalnessMap:t.alphaMap?i=t.alphaMap:t.emissiveMap&&(i=t.emissiveMap),void 0!==i){i.isWebGLRenderTarget&&(i=i.texture);var n=i.offset,r=i.repeat;e.offsetRepeat.value.set(n.x,n.y,r.x,r.y),e.rotateMatrix.value.copy(i.rotateMatrix)}e.envMap.value=t.envMap,e.flipEnvMap.value=t.envMap&&t.envMap.isCubeTexture?-1:1,e.reflectivity.value=t.reflectivity,e.refractionRatio.value=t.refractionRatio}function v(e,t){e.diffuse.value=t.color,e.opacity.value=t.opacity}function y(e,t){e.dashSize.value=t.dashSize,e.totalSize.value=t.dashSize+t.gapSize,e.scale.value=t.scale}function E(e,t){if(e.diffuse.value=t.color,e.opacity.value=t.opacity,e.size.value=t.size*de,e.scale.value=.5*he,e.map.value=t.map,null!==t.map){var i=t.map.offset,n=t.map.repeat;e.offsetRepeat.value.set(i.x,i.y,n.x,n.y)}}function x(e,t){e.fogColor.value=t.color,t.isFog?(e.fogNear.value=t.near,e.fogFar.value=t.far):t.isFogExp2&&(e.fogDensity.value=t.density)}function b(e,t){t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap)}function C(e,t){e.specular.value=t.specular,e.shininess.value=Math.max(t.shininess,1e-4),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function M(e,t){C(e,t),t.gradientMap&&(e.gradientMap.value=t.gradientMap)}function _(e,t){e.roughness.value=t.roughness,e.metalness.value=t.metalness,t.roughnessMap&&(e.roughnessMap.value=t.roughnessMap),t.metalnessMap&&(e.metalnessMap.value=t.metalnessMap),t.emissiveMap&&(e.emissiveMap.value=t.emissiveMap),t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias),t.envMap&&(e.envMapIntensity.value=t.envMapIntensity)}function w(e,t){e.clearCoat.value=t.clearCoat,e.clearCoatRoughness.value=t.clearCoatRoughness,_(e,t)}function L(e,t){t.bumpMap&&(e.bumpMap.value=t.bumpMap,e.bumpScale.value=t.bumpScale),t.normalMap&&(e.normalMap.value=t.normalMap,e.normalScale.value.copy(t.normalScale)),t.displacementMap&&(e.displacementMap.value=t.displacementMap,e.displacementScale.value=t.displacementScale,e.displacementBias.value=t.displacementBias)}function T(e,t){e.ambientLightColor.needsUpdate=t,e.directionalLights.needsUpdate=t,e.pointLights.needsUpdate=t,e.spotLights.needsUpdate=t,e.rectAreaLights.needsUpdate=t,e.hemisphereLights.needsUpdate=t}function I(e,t){var i,n,r,a,o,s,l,c,u=0,h=0,d=0,f=t.matrixWorldInverse,p=0,m=0,g=0,v=0,y=0;for(i=0,n=e.length;i<n;i++)if(r=e[i],o=r.color,s=r.intensity,l=r.distance,c=r.shadow&&r.shadow.map?r.shadow.map.texture:null,r.isAmbientLight)u+=o.r*s,h+=o.g*s,d+=o.b*s;else if(r.isDirectionalLight){var E=je.get(r);E.color.copy(r.color).multiplyScalar(r.intensity),E.direction.setFromMatrixPosition(r.matrixWorld),be.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(be),E.direction.transformDirection(f),E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),_e.directionalShadowMap[p]=c,_e.directionalShadowMatrix[p]=r.shadow.matrix,_e.directional[p]=E,p++}else if(r.isSpotLight){var E=je.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(o).multiplyScalar(s),E.distance=l,E.direction.setFromMatrixPosition(r.matrixWorld),be.setFromMatrixPosition(r.target.matrixWorld),E.direction.sub(be),E.direction.transformDirection(f),E.coneCos=Math.cos(r.angle),E.penumbraCos=Math.cos(r.angle*(1-r.penumbra)),E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),_e.spotShadowMap[g]=c,_e.spotShadowMatrix[g]=r.shadow.matrix,_e.spot[g]=E,g++}else if(r.isRectAreaLight){var E=je.get(r);E.color.copy(o).multiplyScalar(s/(r.width*r.height)),E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),Me.identity(),Ce.copy(r.matrixWorld),Ce.premultiply(f),Me.extractRotation(Ce),E.halfWidth.set(.5*r.width,0,0),E.halfHeight.set(0,.5*r.height,0),E.halfWidth.applyMatrix4(Me),E.halfHeight.applyMatrix4(Me),_e.rectArea[v]=E,v++}else if(r.isPointLight){var E=je.get(r);E.position.setFromMatrixPosition(r.matrixWorld),E.position.applyMatrix4(f),E.color.copy(r.color).multiplyScalar(r.intensity),E.distance=r.distance,E.decay=0===r.distance?0:r.decay,E.shadow=r.castShadow,r.castShadow&&(a=r.shadow,E.shadowBias=a.bias,E.shadowRadius=a.radius,E.shadowMapSize=a.mapSize),_e.pointShadowMap[m]=c,_e.pointShadowMatrix[m]=r.shadow.matrix,_e.point[m]=E,m++}else if(r.isHemisphereLight){var E=je.get(r);E.direction.setFromMatrixPosition(r.matrixWorld),E.direction.transformDirection(f),E.direction.normalize(),E.skyColor.copy(r.color).multiplyScalar(s),E.groundColor.copy(r.groundColor).multiplyScalar(s),_e.hemi[y]=E,y++}_e.ambient[0]=u,_e.ambient[1]=h,_e.ambient[2]=d,_e.directional.length=p,_e.spot.length=g,_e.rectArea.length=v,_e.point.length=m,_e.hemi.length=y,_e.hash=p+","+m+","+g+","+v+","+y+","+_e.shadows.length}function S(){var e=se;return e>=Re.maxTextures&&console.warn("WebGLRenderer: trying to use "+e+" texture units while this GPU supports only "+Re.maxTextures),se+=1,e}function O(e){var t;if(e===fo)return Ie.REPEAT;if(e===po)return Ie.CLAMP_TO_EDGE;if(e===mo)return Ie.MIRRORED_REPEAT;if(e===go)return Ie.NEAREST;if(e===vo)return Ie.NEAREST_MIPMAP_NEAREST;if(e===yo)return Ie.NEAREST_MIPMAP_LINEAR;if(e===Eo)return Ie.LINEAR;if(e===xo)return Ie.LINEAR_MIPMAP_NEAREST;if(e===bo)return Ie.LINEAR_MIPMAP_LINEAR;if(e===Co)return Ie.UNSIGNED_BYTE;if(e===Oo)return Ie.UNSIGNED_SHORT_4_4_4_4;if(e===Do)return Ie.UNSIGNED_SHORT_5_5_5_1;if(e===Ro)return Ie.UNSIGNED_SHORT_5_6_5;if(e===Mo)return Ie.BYTE;if(e===_o)return Ie.SHORT;if(e===wo)return Ie.UNSIGNED_SHORT;if(e===Lo)return Ie.INT;if(e===To)return Ie.UNSIGNED_INT;if(e===Io)return Ie.FLOAT;if(e===So&&null!==(t=Oe.get("OES_texture_half_float")))return t.HALF_FLOAT_OES;if(e===Uo)return Ie.ALPHA;if(e===Bo)return Ie.RGB;if(e===Po)return Ie.RGBA;if(e===No)return Ie.LUMINANCE;if(e===ko)return Ie.LUMINANCE_ALPHA;if(e===Ho)return Ie.DEPTH_COMPONENT;if(e===Go)return Ie.DEPTH_STENCIL;if(e===Ta)return Ie.FUNC_ADD;if(e===Ia)return Ie.FUNC_SUBTRACT;if(e===Sa)return Ie.FUNC_REVERSE_SUBTRACT;if(e===Ra)return Ie.ZERO;if(e===Aa)return Ie.ONE;if(e===Ua)return Ie.SRC_COLOR;if(e===Ba)return Ie.ONE_MINUS_SRC_COLOR;if(e===Pa)return Ie.SRC_ALPHA;if(e===Na)return Ie.ONE_MINUS_SRC_ALPHA;if(e===ka)return Ie.DST_ALPHA;if(e===Fa)return Ie.ONE_MINUS_DST_ALPHA;if(e===Ha)return Ie.DST_COLOR;if(e===Ga)return Ie.ONE_MINUS_DST_COLOR;if(e===Va)return Ie.SRC_ALPHA_SATURATE;if((e===Vo||e===zo||e===Wo||e===qo)&&null!==(t=Oe.get("WEBGL_compressed_texture_s3tc"))){if(e===Vo)return t.COMPRESSED_RGB_S3TC_DXT1_EXT;if(e===zo)return t.COMPRESSED_RGBA_S3TC_DXT1_EXT;if(e===Wo)return t.COMPRESSED_RGBA_S3TC_DXT3_EXT;if(e===qo)return t.COMPRESSED_RGBA_S3TC_DXT5_EXT}if((e===jo||e===Xo||e===Yo||e===Zo)&&null!==(t=Oe.get("WEBGL_compressed_texture_pvrtc"))){if(e===jo)return t.COMPRESSED_RGB_PVRTC_4BPPV1_IMG;if(e===Xo)return t.COMPRESSED_RGB_PVRTC_2BPPV1_IMG;if(e===Yo)return t.COMPRESSED_RGBA_PVRTC_4BPPV1_IMG;if(e===Zo)return t.COMPRESSED_RGBA_PVRTC_2BPPV1_IMG}if(e===Ko&&null!==(t=Oe.get("WEBGL_compressed_texture_etc1")))return t.COMPRESSED_RGB_ETC1_WEBGL;if((e===Oa||e===Da)&&null!==(t=Oe.get("EXT_blend_minmax"))){if(e===Oa)return t.MIN_EXT;if(e===Da)return t.MAX_EXT}return e===Ao&&null!==(t=Oe.get("WEBGL_depth_texture"))?t.UNSIGNED_INT_24_8_WEBGL:0}console.log("THREE.WebGLRenderer",aa),e=e||{}
;var D=void 0!==e.canvas?e.canvas:document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),R=void 0!==e.context?e.context:null,A=void 0!==e.alpha&&e.alpha,U=void 0===e.depth||e.depth,B=void 0===e.stencil||e.stencil,P=void 0!==e.antialias&&e.antialias,N=void 0===e.premultipliedAlpha||e.premultipliedAlpha,k=void 0!==e.preserveDrawingBuffer&&e.preserveDrawingBuffer,F=e.maxDrawCacheNum,H=[],G=new Float32Array(8),V=[],z=[],W=new THREE.Vector3;this.domElement=D,this.context=null,this.autoClear=!0,this.autoClearColor=!0,this.autoClearDepth=!0,this.autoClearStencil=!0,this.sortObjects=!0,this.clippingPlanes=[],this.localClippingEnabled=!1,this.gammaFactor=2,this.gammaInput=!1,this.gammaOutput=!1,this.physicallyCorrectLights=!1,this.toneMapping=to,this.toneMappingExposure=1,this.toneMappingWhitePoint=1,this.maxMorphTargets=8,this.maxMorphNormals=4;var X=this,K=null,Q=null,J=null,$=-1,ee="",te=null,ie=new r,ae=null,oe=new r,se=0,le=new j(0),ce=0,ue=D.width,he=D.height,de=1,fe=new r(0,0,ue,he),pe=!1,me=new r(0,0,ue,he),ge=new ne,ve=new dt,ye=!1,Ee=!1,xe=new c,be=new l,Ce=new c,Me=new c,_e={hash:"",ambient:[0,0,0],directional:[],directionalShadowMap:[],directionalShadowMatrix:[],spot:[],spotShadowMap:[],spotShadowMatrix:[],rectArea:[],point:[],pointShadowMap:[],pointShadowMatrix:[],hemi:[],shadows:[]},we={geometries:0,textures:0},Le={frame:0,calls:0,vertices:0,faces:0,points:0};this.info={render:Le,memory:we,programs:null};var Ie;try{var Se={alpha:A,depth:U,stencil:B,antialias:P,premultipliedAlpha:N,preserveDrawingBuffer:k};if(null===(Ie=R||D.getContext("webgl",Se)||D.getContext("experimental-webgl",Se)))throw null!==D.getContext("webgl")?"Error creating WebGL context with your selected attributes.":"Error creating WebGL context.";void 0===Ie.getShaderPrecisionFormat&&(Ie.getShaderPrecisionFormat=function(){return{rangeMin:1,rangeMax:1,precision:1}}),D.addEventListener("webglcontextlost",a,!1)}catch(e){console.error("THREE.WebGLRenderer: "+e)}var Oe=new ht(Ie);Oe.get("WEBGL_depth_texture"),Oe.get("OES_texture_float"),Oe.get("OES_texture_float_linear"),Oe.get("OES_texture_half_float"),Oe.get("OES_texture_half_float_linear"),Oe.get("OES_standard_derivatives"),Oe.get("ANGLE_instanced_arrays"),Oe.get("OES_element_index_uint")&&(Te.MaxIndex=4294967296);var De,Re=new ut(Ie,Oe,e),Ae=new ct(Ie,Oe,O),Ue=new lt,Be=new st(Ie,Oe,Ae,Ue,Re,O,we),Ne=new Pe(Ie);De=void 0!==F?new na(Ie,Ne,we,F):new ze(Ie,Ne,we);var ke=new qe(Ie,De,Le),Fe=new ot(this,Re),je=new We,Xe=new He;this.info.programs=Fe.programs;var Ye=new Ve(Ie,Oe,Le),Ze=new Ge(Ie,Oe,Le);i(),this.context=Ie,this.capabilities=Re,this.extensions=Oe,this.properties=Ue,this.state=Ae;var Ke=new re(this,_e,ke,Re);this.shadowMap=Ke;new Z(this,V),new Y(this,z);this.getContext=function(){return Ie},this.getContextAttributes=function(){return Ie.getContextAttributes()},this.forceContextLoss=function(){var e=Oe.get("WEBGL_lose_context");e&&e.loseContext()},this.getMaxAnisotropy=function(){return Re.getMaxAnisotropy()},this.getPrecision=function(){return Re.precision},this.getPixelRatio=function(){return de},this.setPixelRatio=function(e){void 0!==e&&(de=e,this.setSize(me.z,me.w,!1))},this.getSize=function(){return{width:ue,height:he}},this.setSize=function(e,t,i){ue=e,he=t,D.width=e*de,D.height=t*de,!1!==i&&(D.style.width=e+"px",D.style.height=t+"px"),this.setViewport(0,0,e,t)},this.setViewport=function(e,t,i,n){Ae.viewport(me.set(e,t,i,n))},this.setScissor=function(e,t,i,n){Ae.scissor(fe.set(e,t,i,n))},this.setScissorTest=function(e){Ae.setScissorTest(pe=e)},this.getClearColor=function(){return le},this.setClearColor=function(e,t){le.set(e),ce=void 0!==t?t:1,Ae.buffers.color.setClear(le.r,le.g,le.b,ce,N)},this.getClearAlpha=function(){return ce},this.setClearAlpha=function(e){ce=e,Ae.buffers.color.setClear(le.r,le.g,le.b,ce,N)},this.clear=function(e,t,i){var n=0;(void 0===e||e)&&(n|=Ie.COLOR_BUFFER_BIT),(void 0===t||t)&&(n|=Ie.DEPTH_BUFFER_BIT),(void 0===i||i)&&(n|=Ie.STENCIL_BUFFER_BIT),Ie.clear(n)},this.clearColor=function(){this.clear(!0,!1,!1)},this.clearDepth=function(){this.clear(!1,!0,!1)},this.clearStencil=function(){this.clear(!1,!1,!0)},this.clearTarget=function(e,t,i,n){this.setRenderTarget(e),this.clear(t,i,n)},this.resetGLState=n,this.dispose=function(){D.removeEventListener("webglcontextlost",a,!1),Xe.dispose()},this.renderBufferImmediate=function(e,t,i){Ae.initAttributes();var n=Ue.get(e);e.hasPositions&&!n.position&&(n.position=Ie.createBuffer()),e.hasNormals&&!n.normal&&(n.normal=Ie.createBuffer()),e.hasUvs&&!n.uv&&(n.uv=Ie.createBuffer()),e.hasColors&&!n.color&&(n.color=Ie.createBuffer());var r=t.getAttributes();if(e.hasPositions&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.position),Ie.bufferData(Ie.ARRAY_BUFFER,e.positionArray,Ie.DYNAMIC_DRAW),Ae.enableAttribute(r.position),Ie.vertexAttribPointer(r.position,3,Ie.FLOAT,!1,0,0)),e.hasNormals){if(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.normal),!i.isMeshPhongMaterial&&!i.isMeshStandardMaterial&&!i.isMeshNormalMaterial&&i.shading===ga)for(var a=0,o=3*e.count;a<o;a+=9){var s=e.normalArray,l=(s[a+0]+s[a+3]+s[a+6])/3,c=(s[a+1]+s[a+4]+s[a+7])/3,u=(s[a+2]+s[a+5]+s[a+8])/3;s[a+0]=l,s[a+1]=c,s[a+2]=u,s[a+3]=l,s[a+4]=c,s[a+5]=u,s[a+6]=l,s[a+7]=c,s[a+8]=u}Ie.bufferData(Ie.ARRAY_BUFFER,e.normalArray,Ie.DYNAMIC_DRAW),Ae.enableAttribute(r.normal),Ie.vertexAttribPointer(r.normal,3,Ie.FLOAT,!1,0,0)}e.hasUvs&&i.map&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.uv),Ie.bufferData(Ie.ARRAY_BUFFER,e.uvArray,Ie.DYNAMIC_DRAW),Ae.enableAttribute(r.uv),Ie.vertexAttribPointer(Ne.uv,2,Ie.FLOAT,!1,0,0)),e.hasColors&&i.vertexColors!==ya&&(Ie.bindBuffer(Ie.ARRAY_BUFFER,n.color),Ie.bufferData(Ie.ARRAY_BUFFER,e.colorArray,Ie.DYNAMIC_DRAW),Ae.enableAttribute(r.color),Ie.vertexAttribPointer(r.color,3,Ie.FLOAT,!1,0,0)),Ae.disableUnusedAttributes(),Ie.drawArrays(Ie.TRIANGLES,0,e.count),e.count=0},this.renderBufferDirect=function(e,i,n,r,a,o){Ae.setMaterial(r);var s=m(e,i,r,a),l=n.id;l+="_",l+=s.id,l+="_",l+=!0===r.wireframe;var c=!1;l!==ee&&(ee=l,c=!0);var u=a.morphTargetInfluences;if(void 0!==u){for(var h=[],p=0,g=u.length;p<g;p++){var v=u[p];h.push([v,p])}h.sort(d),h.length>8&&(h.length=8);for(var y=n.morphAttributes,p=0,g=h.length;p<g;p++){var v=h[p];if(G[p]=v[0],0!==v[0]){var E=v[1];!0===r.morphTargets&&y.position&&n.addAttribute("morphTarget"+p,y.position[E]),!0===r.morphNormals&&y.normal&&n.addAttribute("morphNormal"+p,y.normal[E])}else!0===r.morphTargets&&n.removeAttribute("morphTarget"+p),!0===r.morphNormals&&n.removeAttribute("morphNormal"+p)}for(var p=h.length,x=G.length;p<x;p++)G[p]=0;s.getUniforms().setValue(Ie,"morphTargetInfluences",G),c=!0}var E=n.index,b=n.attributes.position,C=1;!0===r.wireframe&&(E=De.getWireframeAttribute(n),C=2);var M=Ye;null!==E&&(M=Ze,M.setIndex(E)),c&&(f(r,s,n),null!==E&&Ie.bindBuffer(Ie.ELEMENT_ARRAY_BUFFER,Ne.get(E).buffer));var _=0;null!==E?_=E.count:void 0!==b&&(_=b.count);var w=n.drawRange.start*C,L=n.drawRange.count*C,T=null!==o?o.start*C:0,I=null!==o?o.count*C:1/0,S=Math.max(w,T),O=Math.min(_,w+L,T+I)-1,D=Math.max(0,O-S+1);if(0!==D){if(a.isMesh)if(!0===r.wireframe)Ae.setLineWidth(r.wireframeLinewidth*t()),M.setMode(Ie.LINES);else switch(a.drawMode){case $o:M.setMode(Ie.TRIANGLES);break;case es:M.setMode(Ie.TRIANGLE_STRIP);break;case ts:M.setMode(Ie.TRIANGLE_FAN)}else if(a.isLine){var R=r.linewidth;void 0===R&&(R=1),Ae.setLineWidth(R*t()),a.isLineSegments?M.setMode(Ie.LINES):a.isLineLoop?M.setMode(Ie.LINE_LOOP):M.setMode(Ie.LINE_STRIP)}else a.isPoints&&M.setMode(Ie.POINTS);n&&n.isInstancedBufferGeometry?n.maxInstancedCount>0&&M.renderInstances(n,S,D):M.render(S,D)}},this.compile=function(e,t){H=[],e.traverse(function(e){e.isLight&&H.push(e)}),I(H,t),e.traverse(function(t){if(t.material)if(Array.isArray(t.material))for(var i=0;i<t.material.length;i++)p(t.material[i],e.fog,t);else p(t.material,e.fog,t)})},this.render=function(e,t,i,n){return null===Qe?void console.error("THREE.WebGLRenderer.render: OrderedRenderer is not set."):void 0!==t&&!0!==t.isCamera?void console.error("THREE.WebGLRenderer.render: camera is not an instance of THREE.Camera."):(ee="",$=-1,te=null,!0===e.autoUpdate&&e.updateMatrixWorld(),t.onBeforeRender(X),null===t.parent&&t.updateMatrixWorld(),t.matrixWorldInverse.getInverse(t.matrixWorld),Ee=this.localClippingEnabled,ye=ve.init(this.clippingPlanes,Ee,t),xe.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse),ge.setFromMatrix(xe),Le.frame++,Le.calls=0,Le.vertices=0,Le.faces=0,Le.points=0,Qe.update(ge,xe),Qe.render(this,e,t,H,i,n,Ae))},this.setFaceCulling=function(e,t){Ae.setCullFace(e),Ae.setFlipSided(t===ua)},this.allocTextureUnit=S,this.setTexture2D=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTarget&&(e||(console.warn("THREE.WebGLRenderer.setTexture2D: don't use render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),Be.setTexture2D(t,i)}}(),this.setTexture=function(){var e=!1;return function(t,i){e||(console.warn("THREE.WebGLRenderer: .setTexture is deprecated, use setTexture2D instead."),e=!0),Be.setTexture2D(t,i)}}(),this.setTextureCube=function(){var e=!1;return function(t,i){t&&t.isWebGLRenderTargetCube&&(e||(console.warn("THREE.WebGLRenderer.setTextureCube: don't use cube render targets as textures. Use their .texture property instead."),e=!0),t=t.texture),t&&t.isCubeTexture||Array.isArray(t.image)&&6===t.image.length?Be.setTextureCube(t,i):Be.setTextureCubeDynamic(t,i)}}(),this.getRenderTarget=function(){return Q},this.isMRTSupported=function(){return Oe.get("WEBGL_draw_buffers")},this.setRenderTarget=function(e){if(Array.isArray(e)){if(this.isMRTSupported()){Q=e[0],Be.setupMultiRenderTarget(e);var t,i=Ue.get(e[0]);t=i.__webglFramebuffer;var n=Q;ie.copy(n.scissor),ae=n.scissorTest,oe.copy(n.viewport),J!==t&&(Ie.bindFramebuffer(Ie.FRAMEBUFFER,t),J=t),Ae.scissor(ie),Ae.setScissorTest(ae),Ae.viewport(oe)}}else{Q=e,e&&void 0===Ue.get(e).__webglFramebuffer&&Be.setupRenderTarget(e);var t,r=e&&e.isWebGLRenderTargetCube;if(e){var i=Ue.get(e);t=r?i.__webglFramebuffer[e.activeCubeFace]:i.__webglFramebuffer,ie.copy(e.scissor),ae=e.scissorTest,oe.copy(e.viewport)}else t=null,ie.copy(fe).multiplyScalar(de),ae=pe,oe.copy(me).multiplyScalar(de);if(J!==t&&(Ie.bindFramebuffer(Ie.FRAMEBUFFER,t),J=t),Ae.scissor(ie),Ae.setScissorTest(ae),Ae.viewport(oe),r){var a=Ue.get(e.texture);Ie.framebufferTexture2D(Ie.FRAMEBUFFER,Ie.COLOR_ATTACHMENT0,Ie.TEXTURE_CUBE_MAP_POSITIVE_X+e.activeCubeFace,a.__webglTexture,e.activeMipMapLevel)}}},this.readRenderTargetPixels=function(e,t,i,n,r,a){if(!1===(e&&e.isWebGLRenderTarget))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not THREE.WebGLRenderTarget.");var o=Ue.get(e).__webglFramebuffer;if(o){var s=!1;o!==J&&(Ie.bindFramebuffer(Ie.FRAMEBUFFER,o),s=!0);try{var l=e.texture,c=l.format,u=l.type;if(c!==Po&&O(c)!==Ie.getParameter(Ie.IMPLEMENTATION_COLOR_READ_FORMAT))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in RGBA or implementation defined format.");if(!(u===Co||O(u)===Ie.getParameter(Ie.IMPLEMENTATION_COLOR_READ_TYPE)||u===Io&&(Oe.get("OES_texture_float")||Oe.get("WEBGL_color_buffer_float"))||u===So&&Oe.get("EXT_color_buffer_half_float")))return void console.error("THREE.WebGLRenderer.readRenderTargetPixels: renderTarget is not in UnsignedByteType or implementation defined type.");Ie.checkFramebufferStatus(Ie.FRAMEBUFFER)===Ie.FRAMEBUFFER_COMPLETE?t>=0&&t<=e.width-n&&i>=0&&i<=e.height-r&&Ie.readPixels(t,i,n,r,O(c),O(u),a):console.error("THREE.WebGLRenderer.readRenderTargetPixels: readPixels from renderTarget failed. Framebuffer not complete.")}finally{s&&Ie.bindFramebuffer(Ie.FRAMEBUFFER,J)}}},this.updateObject=function(e){return ke.update(e)};var Qe=null;this.setRenderer=function(e){Qe=e},this.getRenderer=function(){return Qe},this.destroy=function(){Qe.destroy(),Ue.clear()},this.resetIncrementRender=function(){Qe.restart()},this.setFilterObject=function(e){Qe.setFilter(e)},this.setObjectListUpdateState=function(e){Qe.updateObjectList(e)},this.computeSelectionBBox=function(){return Qe.computeSelectionBBox()},this.computeRenderObjectsBox=function(){return Qe.computeRenderObjectsBox()},this.setRenderTicket=function(e){ke._renderTicket=e},this.setupLights=function(e,t){I(e,t)}}void 0===Number.EPSILON&&(Number.EPSILON=Math.pow(2,-52)),void 0===Number.isInteger&&(Number.isInteger=function(e){return"number"==typeof e&&isFinite(e)&&Math.floor(e)===e}),void 0===Math.sign&&(Math.sign=function(e){return e<0?-1:e>0?1:+e}),void 0===Function.prototype.name&&Object.defineProperty(Function.prototype,"name",{get:function(){return this.toString().match(/^\s*function\s*([^\(\s]*)/)[1]}}),void 0===Object.assign&&function(){Object.assign=function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert undefined or null to object");for(var t=Object(e),i=1;i<arguments.length;i++){var n=arguments[i];if(void 0!==n&&null!==n)for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(t[r]=n[r])}return t}}(),Object.assign(t.prototype,{addEventListener:function(e,t){void 0===this._listeners&&(this._listeners={});var i=this._listeners;void 0===i[e]&&(i[e]=[]),-1===i[e].indexOf(t)&&i[e].push(t)},hasEventListener:function(e,t){if(void 0===this._listeners)return!1;var i=this._listeners;return void 0!==i[e]&&-1!==i[e].indexOf(t)},removeEventListener:function(e,t){if(void 0!==this._listeners){var i=this._listeners,n=i[e];if(void 0!==n){var r=n.indexOf(t);-1!==r&&n.splice(r,1)}}},dispatchEvent:function(e){if(void 0!==this._listeners){var t=this._listeners,i=t[e.type];if(void 0!==i){e.target=this;var n=[],r=0,a=i.length;for(r=0;r<a;r++)n[r]=i[r];for(r=0;r<a;r++)n[r].call(this,e)}}}});var aa="85",oa={LEFT:0,MIDDLE:1,RIGHT:2},sa=0,la=1,ca=2,ua=0,ha=1,da=2,fa=0,pa=1,ma=2,ga=1,va=2,ya=0,Ea=1,xa=2,ba=0,Ca=1,Ma=2,_a=3,wa=4,La=5,Ta=100,Ia=101,Sa=102,Oa=103,Da=104,Ra=200,Aa=201,Ua=202,Ba=203,Pa=204,Na=205,ka=206,Fa=207,Ha=208,Ga=209,Va=210,za=0,Wa=1,qa=2,ja=3,Xa=4,Ya=5,Za=6,Ka=7,Qa=0,Ja=1,$a=2,eo=0,to=1,io=2,no=3,ro=4,ao=301,oo=302,so=303,lo=304,co=305,uo=306,ho=307,fo=1e3,po=1001,mo=1002,go=1003,vo=1004,yo=1005,Eo=1006,xo=1007,bo=1008,Co=1009,Mo=1010,_o=1011,wo=1012,Lo=1013,To=1014,Io=1015,So=1016,Oo=1017,Do=1018,Ro=1019,Ao=1020,Uo=1021,Bo=1022,Po=1023,No=1024,ko=1025,Fo=Po,Ho=1026,Go=1027,Vo=2001,zo=2002,Wo=2003,qo=2004,jo=2100,Xo=2101,Yo=2102,Zo=2103,Ko=2151,Qo=2201,Jo=2400,$o=0,es=1,ts=2,is=3e3,ns=3001,rs=3007,as=3002,os=3004,ss=3005,ls=3006,cs=3200,us=3201,hs={DEG2RAD:Math.PI/180,RAD2DEG:180/Math.PI,generateUUID:function(){var e,t="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz".split(""),i=new Array(36),n=0;return function(){for(var r=0;r<36;r++)8===r||13===r||18===r||23===r?i[r]="-":14===r?i[r]="4":(n<=2&&(n=33554432+16777216*Math.random()|0),e=15&n,n>>=4,i[r]=t[19===r?3&e|8:e]);return i.join("")}}(),clamp:function(e,t,i){return Math.max(t,Math.min(i,e))},euclideanModulo:function(e,t){return(e%t+t)%t},mapLinear:function(e,t,i,n,r){return n+(e-t)*(r-n)/(i-t)},lerp:function(e,t,i){return(1-i)*e+i*t},smoothstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*(3-2*e)},smootherstep:function(e,t,i){return e<=t?0:e>=i?1:(e=(e-t)/(i-t))*e*e*(e*(6*e-15)+10)},randInt:function(e,t){return e+Math.floor(Math.random()*(t-e+1))},randFloat:function(e,t){return e+Math.random()*(t-e)},randFloatSpread:function(e){return e*(.5-Math.random())},degToRad:function(e){return e*hs.DEG2RAD},radToDeg:function(e){return e*hs.RAD2DEG},isPowerOfTwo:function(e){return 0==(e&e-1)&&0!==e},nearestPowerOfTwo:function(e){return Math.pow(2,Math.round(Math.log(e)/Math.LN2))},nextPowerOfTwo:function(e){return e--,e|=e>>1,e|=e>>2,e|=e>>4,e|=e>>8,e|=e>>16,++e}};Object.defineProperties(i.prototype,{width:{get:function(){return this.x},set:function(e){this.x=e}},height:{get:function(){return this.y},set:function(e){this.y=e}}}),Object.assign(i.prototype,{isVector2:!0,set:function(e,t){return this.x=e,this.y=t,this},setScalar:function(e){return this.x=e,this.y=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y)},copy:function(e){return this.x=e.x,this.y=e.y,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this)},addScalar:function(e){return this.x+=e,this.y+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector2: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this)},subScalar:function(e){return this.x-=e,this.y-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this},multiply:function(e){return this.x*=e.x,this.y*=e.y,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this},divide:function(e){return this.x/=e.x,this.y/=e.y,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this},clampScalar:function(){var e=new i,t=new i;return function(i,n){return e.set(i,i),t.set(n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,i))/i)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this},negate:function(){return this.x=-this.x,this.y=-this.y,this},dot:function(e){return this.x*e.x+this.y*e.y},lengthSq:function(){return this.x*this.x+this.y*this.y},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)},normalize:function(){return this.divideScalar(this.length())},angle:function(){var e=Math.atan2(this.y,this.x);return e<0&&(e+=2*Math.PI),e},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y;return t*t+i*i},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector2: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this},rotateAround:function(e,t){var i=Math.cos(t),n=Math.sin(t),r=this.x-e.x,a=this.y-e.y;return this.x=r*i-a*n+e.x,this.y=r*n+a*i+e.y,this}});var ds=0;n.DEFAULT_IMAGE=void 0,n.DEFAULT_MAPPING=300,Object.defineProperty(n.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(n.prototype,t.prototype,{constructor:n,isTexture:!0,clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.name=e.name,this.image=e.image,this.mipmaps=e.mipmaps.slice(0),this.mapping=e.mapping,this.wrapS=e.wrapS,this.wrapT=e.wrapT,this.magFilter=e.magFilter,this.minFilter=e.minFilter,this.anisotropy=e.anisotropy,this.format=e.format,this.type=e.type,this.offset.copy(e.offset),this.repeat.copy(e.repeat),this.rotateMatrix.copy(e.rotateMatrix),this.generateMipmaps=e.generateMipmaps,this.premultiplyAlpha=e.premultiplyAlpha,this.flipY=e.flipY,this.unpackAlignment=e.unpackAlignment,this.encoding=e.encoding,this},toJSON:function(e){if(void 0!==e.textures[this.uuid])return e.textures[this.uuid];var t={metadata:{version:4.5,type:"Texture",generator:"Texture.toJSON"},uuid:this.uuid,name:this.name,mapping:this.mapping,repeat:[this.repeat.x,this.repeat.y],offset:[this.offset.x,this.offset.y],wrap:[this.wrapS,this.wrapT],minFilter:this.minFilter,magFilter:this.magFilter,anisotropy:this.anisotropy,flipY:this.flipY};if(void 0!==this.image){var i=this.image;void 0===i.uuid&&(i.uuid=hs.generateUUID()),void 0===e.images[i.uuid]&&(e.images[i.uuid]={uuid:i.uuid,url:function(e){var t;return void 0!==e.toDataURL?t=e:(t=document.createElementNS("http://www.w3.org/1999/xhtml","canvas"),t.width=e.width,t.height=e.height,t.getContext("2d").drawImage(e,0,0,e.width,e.height)),t.width>2048||t.height>2048?t.toDataURL("image/jpeg",.6):t.toDataURL("image/png")}(i)}),t.image=i.uuid}return e.textures[this.uuid]=t,t},dispose:function(){this.dispatchEvent({type:"dispose"})},transformUv:function(e){if(300===this.mapping){if(e.multiply(this.repeat),e.add(this.offset),e.x<0||e.x>1)switch(this.wrapS){case fo:e.x=e.x-Math.floor(e.x);break;case po:e.x=e.x<0?0:1;break;case mo:1===Math.abs(Math.floor(e.x)%2)?e.x=Math.ceil(e.x)-e.x:e.x=e.x-Math.floor(e.x)}if(e.y<0||e.y>1)switch(this.wrapT){case fo:e.y=e.y-Math.floor(e.y);break;case po:e.y=e.y<0?0:1;break;case mo:1===Math.abs(Math.floor(e.y)%2)?e.y=Math.ceil(e.y)-e.y:e.y=e.y-Math.floor(e.y)}this.flipY&&(e.y=1-e.y)}},setRotateAngle:function(e){var t=THREE.Math.degToRad(e),i=Math.sin(t),n=Math.cos(t);this.rotateMatrix.elements[0]=n,this.rotateMatrix.elements[1]=i,this.rotateMatrix.elements[3]=-i,this.rotateMatrix.elements[4]=n}}),Object.assign(r.prototype,{isVector4:!0,set:function(e,t,i,n){return this.x=e,this.y=t,this.z=i,this.w=n,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this.w=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setW:function(e){return this.w=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;case 3:this.w=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;case 3:return this.w;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z,this.w)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this.w=void 0!==e.w?e.w:1,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this.w+=e.w,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this.w+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this.w=e.w+t.w,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this.w+=e.w*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector4: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this.w-=e.w,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this.w-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this.w=e.w-t.w,this},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this.w*=e,this},applyMatrix4:function(e){var t=this.x,i=this.y,n=this.z,r=this.w,a=e.elements;return this.x=a[0]*t+a[4]*i+a[8]*n+a[12]*r,this.y=a[1]*t+a[5]*i+a[9]*n+a[13]*r,this.z=a[2]*t+a[6]*i+a[10]*n+a[14]*r,this.w=a[3]*t+a[7]*i+a[11]*n+a[15]*r,this},divideScalar:function(e){return this.multiplyScalar(1/e)},setAxisAngleFromQuaternion:function(e){this.w=2*Math.acos(e.w);var t=Math.sqrt(1-e.w*e.w);return t<1e-4?(this.x=1,this.y=0,this.z=0):(this.x=e.x/t,this.y=e.y/t,this.z=e.z/t),this},setAxisAngleFromRotationMatrix:function(e){var t,i,n,r,a=e.elements,o=a[0],s=a[4],l=a[8],c=a[1],u=a[5],h=a[9],d=a[2],f=a[6],p=a[10];if(Math.abs(s-c)<.01&&Math.abs(l-d)<.01&&Math.abs(h-f)<.01){if(Math.abs(s+c)<.1&&Math.abs(l+d)<.1&&Math.abs(h+f)<.1&&Math.abs(o+u+p-3)<.1)return this.set(1,0,0,0),this;t=Math.PI;var m=(o+1)/2,g=(u+1)/2,v=(p+1)/2,y=(s+c)/4,E=(l+d)/4,x=(h+f)/4;return m>g&&m>v?m<.01?(i=0,n=.707106781,r=.707106781):(i=Math.sqrt(m),n=y/i,r=E/i):g>v?g<.01?(i=.707106781,n=0,r=.707106781):(n=Math.sqrt(g),i=y/n,r=x/n):v<.01?(i=.707106781,n=.707106781,r=0):(r=Math.sqrt(v),i=E/r,n=x/r),this.set(i,n,r,t),this}var b=Math.sqrt((f-h)*(f-h)+(l-d)*(l-d)+(c-s)*(c-s));return Math.abs(b)<.001&&(b=1),this.x=(f-h)/b,this.y=(l-d)/b,this.z=(c-s)/b,this.w=Math.acos((o+u+p-1)/2),this},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this.w=Math.min(this.w,e.w),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this.w=Math.max(this.w,e.w),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this.w=Math.max(e.w,Math.min(t.w,this.w)),this},clampScalar:function(){var e=new r,t=new r;return function(i,n){return e.set(i,i,i,i),t.set(n,n,n,n),this.clamp(e,t)}}(),floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this.w=Math.floor(this.w),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this.w=Math.ceil(this.w),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this.w=Math.round(this.w),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this.w=this.w<0?Math.ceil(this.w):Math.floor(this.w),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this.w=-this.w,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z+this.w*e.w},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)+Math.abs(this.w)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this.w+=(e.w-this.w)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z&&e.w===this.w},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this.w=e[t+3],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e[t+3]=this.w,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector4: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this.w=e.getW(t),this}}),Object.assign(a.prototype,t.prototype,{isWebGLRenderTarget:!0,setSize:function(e,t){this.width===e&&this.height===t||(this.width=e,this.height=t,this.dispose()),this.viewport.set(0,0,e,t),this.scissor.set(0,0,e,t)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.width=e.width,this.height=e.height,this.viewport.copy(e.viewport),this.texture=e.texture.clone(),this.depthBuffer=e.depthBuffer,this.stencilBuffer=e.stencilBuffer,this.depthTexture=e.depthTexture,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),o.prototype=Object.create(a.prototype),o.prototype.constructor=o,o.prototype.isWebGLRenderTargetCube=!0,Object.assign(s,{slerp:function(e,t,i,n){return i.copy(e).slerp(t,n)},slerpFlat:function(e,t,i,n,r,a,o){var s=i[n+0],l=i[n+1],c=i[n+2],u=i[n+3],h=r[a+0],d=r[a+1],f=r[a+2],p=r[a+3];if(u!==p||s!==h||l!==d||c!==f){var m=1-o,g=s*h+l*d+c*f+u*p,v=g>=0?1:-1,y=1-g*g;if(y>Number.EPSILON){var E=Math.sqrt(y),x=Math.atan2(E,g*v);m=Math.sin(m*x)/E,o=Math.sin(o*x)/E}var b=o*v;if(s=s*m+h*b,l=l*m+d*b,c=c*m+f*b,u=u*m+p*b,m===1-o){var C=1/Math.sqrt(s*s+l*l+c*c+u*u);s*=C,l*=C,c*=C,u*=C}}e[t]=s,e[t+1]=l,e[t+2]=c,e[t+3]=u}}),Object.defineProperties(s.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},w:{get:function(){return this._w},set:function(e){this._w=e,this.onChangeCallback()}}}),Object.assign(s.prototype,{set:function(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._w=n,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._w)},copy:function(e){return this._x=e.x,this._y=e.y,this._z=e.z,this._w=e.w,this.onChangeCallback(),this},setFromEuler:function(e,t){if(!1===(e&&e.isEuler))throw new Error("THREE.Quaternion: .setFromEuler() now expects an Euler rotation rather than a Vector3 and order.");var i=e._x,n=e._y,r=e._z,a=e.order,o=Math.cos,s=Math.sin,l=o(i/2),c=o(n/2),u=o(r/2),h=s(i/2),d=s(n/2),f=s(r/2);return"XYZ"===a?(this._x=h*c*u+l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u-h*d*f):"YXZ"===a?(this._x=h*c*u+l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u+h*d*f):"ZXY"===a?(this._x=h*c*u-l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u-h*d*f):"ZYX"===a?(this._x=h*c*u-l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u+h*d*f):"YZX"===a?(this._x=h*c*u+l*d*f,this._y=l*d*u+h*c*f,this._z=l*c*f-h*d*u,this._w=l*c*u-h*d*f):"XZY"===a&&(this._x=h*c*u-l*d*f,this._y=l*d*u-h*c*f,this._z=l*c*f+h*d*u,this._w=l*c*u+h*d*f),!1!==t&&this.onChangeCallback(),this},setFromAxisAngle:function(e,t){var i=t/2,n=Math.sin(i);return this._x=e.x*n,this._y=e.y*n,this._z=e.z*n,this._w=Math.cos(i),this.onChangeCallback(),this},setFromRotationMatrix:function(e){var t,i=e.elements,n=i[0],r=i[4],a=i[8],o=i[1],s=i[5],l=i[9],c=i[2],u=i[6],h=i[10],d=n+s+h;return d>0?(t=.5/Math.sqrt(d+1),this._w=.25/t,this._x=(u-l)*t,this._y=(a-c)*t,this._z=(o-r)*t):n>s&&n>h?(t=2*Math.sqrt(1+n-s-h),this._w=(u-l)/t,this._x=.25*t,this._y=(r+o)/t,this._z=(a+c)/t):s>h?(t=2*Math.sqrt(1+s-n-h),this._w=(a-c)/t,this._x=(r+o)/t,this._y=.25*t,this._z=(l+u)/t):(t=2*Math.sqrt(1+h-n-s),this._w=(o-r)/t,this._x=(a+c)/t,this._y=(l+u)/t,this._z=.25*t),this.onChangeCallback(),this},setFromUnitVectors:function(){var e,t=new l;return function(i,n){return void 0===t&&(t=new l),e=i.dot(n)+1,e<1e-6?(e=0,Math.abs(i.x)>Math.abs(i.z)?t.set(-i.y,i.x,0):t.set(0,-i.z,i.y)):t.crossVectors(i,n),this._x=t.x,this._y=t.y,this._z=t.z,this._w=e,this.normalize()}}(),inverse:function(){return this.conjugate().normalize()},conjugate:function(){return this._x*=-1,this._y*=-1,this._z*=-1,this.onChangeCallback(),this},dot:function(e){return this._x*e._x+this._y*e._y+this._z*e._z+this._w*e._w},lengthSq:function(){return this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w},length:function(){return Math.sqrt(this._x*this._x+this._y*this._y+this._z*this._z+this._w*this._w)},normalize:function(){var e=this.length();return 0===e?(this._x=0,this._y=0,
this._z=0,this._w=1):(e=1/e,this._x=this._x*e,this._y=this._y*e,this._z=this._z*e,this._w=this._w*e),this.onChangeCallback(),this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Quaternion: .multiply() now only accepts one argument. Use .multiplyQuaternions( a, b ) instead."),this.multiplyQuaternions(e,t)):this.multiplyQuaternions(this,e)},premultiply:function(e){return this.multiplyQuaternions(e,this)},multiplyQuaternions:function(e,t){var i=e._x,n=e._y,r=e._z,a=e._w,o=t._x,s=t._y,l=t._z,c=t._w;return this._x=i*c+a*o+n*l-r*s,this._y=n*c+a*s+r*o-i*l,this._z=r*c+a*l+i*s-n*o,this._w=a*c-i*o-n*s-r*l,this.onChangeCallback(),this},slerp:function(e,t){if(0===t)return this;if(1===t)return this.copy(e);var i=this._x,n=this._y,r=this._z,a=this._w,o=a*e._w+i*e._x+n*e._y+r*e._z;if(o<0?(this._w=-e._w,this._x=-e._x,this._y=-e._y,this._z=-e._z,o=-o):this.copy(e),o>=1)return this._w=a,this._x=i,this._y=n,this._z=r,this;var s=Math.sqrt(1-o*o);if(Math.abs(s)<.001)return this._w=.5*(a+this._w),this._x=.5*(i+this._x),this._y=.5*(n+this._y),this._z=.5*(r+this._z),this;var l=Math.atan2(s,o),c=Math.sin((1-t)*l)/s,u=Math.sin(t*l)/s;return this._w=a*c+this._w*u,this._x=i*c+this._x*u,this._y=n*c+this._y*u,this._z=r*c+this._z*u,this.onChangeCallback(),this},equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._w===this._w},fromArray:function(e,t){return void 0===t&&(t=0),this._x=e[t],this._y=e[t+1],this._z=e[t+2],this._w=e[t+3],this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._w,e},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(l.prototype,{isVector3:!0,set:function(e,t,i){return this.x=e,this.y=t,this.z=i,this},setScalar:function(e){return this.x=e,this.y=e,this.z=e,this},setX:function(e){return this.x=e,this},setY:function(e){return this.y=e,this},setZ:function(e){return this.z=e,this},setComponent:function(e,t){switch(e){case 0:this.x=t;break;case 1:this.y=t;break;case 2:this.z=t;break;default:throw new Error("index is out of range: "+e)}return this},getComponent:function(e){switch(e){case 0:return this.x;case 1:return this.y;case 2:return this.z;default:throw new Error("index is out of range: "+e)}},clone:function(){return new this.constructor(this.x,this.y,this.z)},copy:function(e){return this.x=e.x,this.y=e.y,this.z=e.z,this},add:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .add() now only accepts one argument. Use .addVectors( a, b ) instead."),this.addVectors(e,t)):(this.x+=e.x,this.y+=e.y,this.z+=e.z,this)},addScalar:function(e){return this.x+=e,this.y+=e,this.z+=e,this},addVectors:function(e,t){return this.x=e.x+t.x,this.y=e.y+t.y,this.z=e.z+t.z,this},addScaledVector:function(e,t){return this.x+=e.x*t,this.y+=e.y*t,this.z+=e.z*t,this},sub:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .sub() now only accepts one argument. Use .subVectors( a, b ) instead."),this.subVectors(e,t)):(this.x-=e.x,this.y-=e.y,this.z-=e.z,this)},subScalar:function(e){return this.x-=e,this.y-=e,this.z-=e,this},subVectors:function(e,t){return this.x=e.x-t.x,this.y=e.y-t.y,this.z=e.z-t.z,this},multiply:function(e,t){return void 0!==t?(console.warn("THREE.Vector3: .multiply() now only accepts one argument. Use .multiplyVectors( a, b ) instead."),this.multiplyVectors(e,t)):(this.x*=e.x,this.y*=e.y,this.z*=e.z,this)},multiplyScalar:function(e){return this.x*=e,this.y*=e,this.z*=e,this},multiplyVectors:function(e,t){return this.x=e.x*t.x,this.y=e.y*t.y,this.z=e.z*t.z,this},applyEuler:function(){var e=new s;return function(t){return!1===(t&&t.isEuler)&&console.error("THREE.Vector3: .applyEuler() now expects an Euler rotation rather than a Vector3 and order."),this.applyQuaternion(e.setFromEuler(t))}}(),applyAxisAngle:function(){var e=new s;return function(t,i){return this.applyQuaternion(e.setFromAxisAngle(t,i))}}(),applyMatrix3:function(e){var t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[3]*i+r[6]*n,this.y=r[1]*t+r[4]*i+r[7]*n,this.z=r[2]*t+r[5]*i+r[8]*n,this},applyMatrix4:function(e){var t=this.x,i=this.y,n=this.z,r=e.elements;this.x=r[0]*t+r[4]*i+r[8]*n+r[12],this.y=r[1]*t+r[5]*i+r[9]*n+r[13],this.z=r[2]*t+r[6]*i+r[10]*n+r[14];var a=r[3]*t+r[7]*i+r[11]*n+r[15];return this.divideScalar(a)},applyQuaternion:function(e){var t=this.x,i=this.y,n=this.z,r=e.x,a=e.y,o=e.z,s=e.w,l=s*t+a*n-o*i,c=s*i+o*t-r*n,u=s*n+r*i-a*t,h=-r*t-a*i-o*n;return this.x=l*s+h*-r+c*-o-u*-a,this.y=c*s+h*-a+u*-r-l*-o,this.z=u*s+h*-o+l*-a-c*-r,this},project:function(){var e=new c;return function(t){return e.multiplyMatrices(t.projectionMatrix,e.getInverse(t.matrixWorld)),this.applyMatrix4(e)}}(),unproject:function(){var e=new c;return function(t){return e.multiplyMatrices(t.matrixWorld,e.getInverse(t.projectionMatrix)),this.applyMatrix4(e)}}(),transformDirection:function(e){var t=this.x,i=this.y,n=this.z,r=e.elements;return this.x=r[0]*t+r[4]*i+r[8]*n,this.y=r[1]*t+r[5]*i+r[9]*n,this.z=r[2]*t+r[6]*i+r[10]*n,this.normalize()},divide:function(e){return this.x/=e.x,this.y/=e.y,this.z/=e.z,this},divideScalar:function(e){return this.multiplyScalar(1/e)},min:function(e){return this.x=Math.min(this.x,e.x),this.y=Math.min(this.y,e.y),this.z=Math.min(this.z,e.z),this},max:function(e){return this.x=Math.max(this.x,e.x),this.y=Math.max(this.y,e.y),this.z=Math.max(this.z,e.z),this},clamp:function(e,t){return this.x=Math.max(e.x,Math.min(t.x,this.x)),this.y=Math.max(e.y,Math.min(t.y,this.y)),this.z=Math.max(e.z,Math.min(t.z,this.z)),this},clampScalar:function(){var e=new l,t=new l;return function(i,n){return e.set(i,i,i),t.set(n,n,n),this.clamp(e,t)}}(),clampLength:function(e,t){var i=this.length();return this.multiplyScalar(Math.max(e,Math.min(t,i))/i)},floor:function(){return this.x=Math.floor(this.x),this.y=Math.floor(this.y),this.z=Math.floor(this.z),this},ceil:function(){return this.x=Math.ceil(this.x),this.y=Math.ceil(this.y),this.z=Math.ceil(this.z),this},round:function(){return this.x=Math.round(this.x),this.y=Math.round(this.y),this.z=Math.round(this.z),this},roundToZero:function(){return this.x=this.x<0?Math.ceil(this.x):Math.floor(this.x),this.y=this.y<0?Math.ceil(this.y):Math.floor(this.y),this.z=this.z<0?Math.ceil(this.z):Math.floor(this.z),this},negate:function(){return this.x=-this.x,this.y=-this.y,this.z=-this.z,this},dot:function(e){return this.x*e.x+this.y*e.y+this.z*e.z},lengthSq:function(){return this.x*this.x+this.y*this.y+this.z*this.z},length:function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z)},lengthManhattan:function(){return Math.abs(this.x)+Math.abs(this.y)+Math.abs(this.z)},normalize:function(){return this.divideScalar(this.length())},setLength:function(e){return this.multiplyScalar(e/this.length())},lerp:function(e,t){return this.x+=(e.x-this.x)*t,this.y+=(e.y-this.y)*t,this.z+=(e.z-this.z)*t,this},lerpVectors:function(e,t,i){return this.subVectors(t,e).multiplyScalar(i).add(e)},cross:function(e,t){if(void 0!==t)return console.warn("THREE.Vector3: .cross() now only accepts one argument. Use .crossVectors( a, b ) instead."),this.crossVectors(e,t);var i=this.x,n=this.y,r=this.z;return this.x=n*e.z-r*e.y,this.y=r*e.x-i*e.z,this.z=i*e.y-n*e.x,this},crossVectors:function(e,t){var i=e.x,n=e.y,r=e.z,a=t.x,o=t.y,s=t.z;return this.x=n*s-r*o,this.y=r*a-i*s,this.z=i*o-n*a,this},projectOnVector:function(e){var t=e.dot(this)/e.lengthSq();return this.copy(e).multiplyScalar(t)},projectOnPlane:function(){var e=new l;return function(t){return e.copy(this).projectOnVector(t),this.sub(e)}}(),reflect:function(){var e=new l;return function(t){return this.sub(e.copy(t).multiplyScalar(2*this.dot(t)))}}(),angleTo:function(e){var t=this.dot(e)/Math.sqrt(this.lengthSq()*e.lengthSq());return Math.acos(hs.clamp(t,-1,1))},distanceTo:function(e){return Math.sqrt(this.distanceToSquared(e))},distanceToSquared:function(e){var t=this.x-e.x,i=this.y-e.y,n=this.z-e.z;return t*t+i*i+n*n},distanceToManhattan:function(e){return Math.abs(this.x-e.x)+Math.abs(this.y-e.y)+Math.abs(this.z-e.z)},setFromSpherical:function(e){var t=Math.sin(e.phi)*e.radius;return this.x=t*Math.sin(e.theta),this.y=Math.cos(e.phi)*e.radius,this.z=t*Math.cos(e.theta),this},setFromCylindrical:function(e){return this.x=e.radius*Math.sin(e.theta),this.y=e.y,this.z=e.radius*Math.cos(e.theta),this},setFromMatrixPosition:function(e){return this.setFromMatrixColumn(e,3)},setFromMatrixScale:function(e){var t=this.setFromMatrixColumn(e,0).length(),i=this.setFromMatrixColumn(e,1).length(),n=this.setFromMatrixColumn(e,2).length();return this.x=t,this.y=i,this.z=n,this},setFromMatrixColumn:function(e,t){return this.fromArray(e.elements,4*t)},equals:function(e){return e.x===this.x&&e.y===this.y&&e.z===this.z},fromArray:function(e,t){return void 0===t&&(t=0),this.x=e[t],this.y=e[t+1],this.z=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.x,e[t+1]=this.y,e[t+2]=this.z,e},fromBufferAttribute:function(e,t,i){return void 0!==i&&console.warn("THREE.Vector3: offset has been removed from .fromBufferAttribute()."),this.x=e.getX(t),this.y=e.getY(t),this.z=e.getZ(t),this}}),Object.assign(c.prototype,{isMatrix4:!0,set:function(e,t,i,n,r,a,o,s,l,c,u,h,d,f,p,m){var g=this.elements;return g[0]=e,g[4]=t,g[8]=i,g[12]=n,g[1]=r,g[5]=a,g[9]=o,g[13]=s,g[2]=l,g[6]=c,g[10]=u,g[14]=h,g[3]=d,g[7]=f,g[11]=p,g[15]=m,this},identity:function(){return this.set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1),this},clone:function(){return(new c).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],t[9]=i[9],t[10]=i[10],t[11]=i[11],t[12]=i[12],t[13]=i[13],t[14]=i[14],t[15]=i[15],this},copyPosition:function(e){var t=this.elements,i=e.elements;return t[12]=i[12],t[13]=i[13],t[14]=i[14],this},extractBasis:function(e,t,i){return e.setFromMatrixColumn(this,0),t.setFromMatrixColumn(this,1),i.setFromMatrixColumn(this,2),this},makeBasis:function(e,t,i){return this.set(e.x,t.x,i.x,0,e.y,t.y,i.y,0,e.z,t.z,i.z,0,0,0,0,1),this},extractRotation:function(){var e=new l;return function(t){var i=this.elements,n=t.elements,r=1/e.setFromMatrixColumn(t,0).length(),a=1/e.setFromMatrixColumn(t,1).length(),o=1/e.setFromMatrixColumn(t,2).length();return i[0]=n[0]*r,i[1]=n[1]*r,i[2]=n[2]*r,i[4]=n[4]*a,i[5]=n[5]*a,i[6]=n[6]*a,i[8]=n[8]*o,i[9]=n[9]*o,i[10]=n[10]*o,this}}(),makeRotationFromEuler:function(e){!1===(e&&e.isEuler)&&console.error("THREE.Matrix: .makeRotationFromEuler() now expects a Euler rotation rather than a Vector3 and order.");var t=this.elements,i=e.x,n=e.y,r=e.z,a=Math.cos(i),o=Math.sin(i),s=Math.cos(n),l=Math.sin(n),c=Math.cos(r),u=Math.sin(r);if("XYZ"===e.order){var h=a*c,d=a*u,f=o*c,p=o*u;t[0]=s*c,t[4]=-s*u,t[8]=l,t[1]=d+f*l,t[5]=h-p*l,t[9]=-o*s,t[2]=p-h*l,t[6]=f+d*l,t[10]=a*s}else if("YXZ"===e.order){var m=s*c,g=s*u,v=l*c,y=l*u;t[0]=m+y*o,t[4]=v*o-g,t[8]=a*l,t[1]=a*u,t[5]=a*c,t[9]=-o,t[2]=g*o-v,t[6]=y+m*o,t[10]=a*s}else if("ZXY"===e.order){var m=s*c,g=s*u,v=l*c,y=l*u;t[0]=m-y*o,t[4]=-a*u,t[8]=v+g*o,t[1]=g+v*o,t[5]=a*c,t[9]=y-m*o,t[2]=-a*l,t[6]=o,t[10]=a*s}else if("ZYX"===e.order){var h=a*c,d=a*u,f=o*c,p=o*u;t[0]=s*c,t[4]=f*l-d,t[8]=h*l+p,t[1]=s*u,t[5]=p*l+h,t[9]=d*l-f,t[2]=-l,t[6]=o*s,t[10]=a*s}else if("YZX"===e.order){var E=a*s,x=a*l,b=o*s,C=o*l;t[0]=s*c,t[4]=C-E*u,t[8]=b*u+x,t[1]=u,t[5]=a*c,t[9]=-o*c,t[2]=-l*c,t[6]=x*u+b,t[10]=E-C*u}else if("XZY"===e.order){var E=a*s,x=a*l,b=o*s,C=o*l;t[0]=s*c,t[4]=-u,t[8]=l*c,t[1]=E*u+C,t[5]=a*c,t[9]=x*u-b,t[2]=b*u-x,t[6]=o*c,t[10]=C*u+E}return t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},makeRotationFromQuaternion:function(e){var t=this.elements,i=e._x,n=e._y,r=e._z,a=e._w,o=i+i,s=n+n,l=r+r,c=i*o,u=i*s,h=i*l,d=n*s,f=n*l,p=r*l,m=a*o,g=a*s,v=a*l;return t[0]=1-(d+p),t[4]=u-v,t[8]=h+g,t[1]=u+v,t[5]=1-(c+p),t[9]=f-m,t[2]=h-g,t[6]=f+m,t[10]=1-(c+d),t[3]=0,t[7]=0,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,this},lookAt:function(){var e=new l,t=new l,i=new l;return function(n,r,a){var o=this.elements;return i.subVectors(n,r),0===i.lengthSq()&&(i.z=1),i.normalize(),e.crossVectors(a,i),0===e.lengthSq()&&(i.z+=1e-4,e.crossVectors(a,i)),e.normalize(),t.crossVectors(i,e),o[0]=e.x,o[4]=t.x,o[8]=i.x,o[1]=e.y,o[5]=t.y,o[9]=i.y,o[2]=e.z,o[6]=t.z,o[10]=i.z,this}}(),multiply:function(e,t){return void 0!==t?(console.warn("THREE.Matrix4: .multiply() now only accepts one argument. Use .multiplyMatrices( a, b ) instead."),this.multiplyMatrices(e,t)):this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,n=t.elements,r=this.elements,a=i[0],o=i[4],s=i[8],l=i[12],c=i[1],u=i[5],h=i[9],d=i[13],f=i[2],p=i[6],m=i[10],g=i[14],v=i[3],y=i[7],E=i[11],x=i[15],b=n[0],C=n[4],M=n[8],_=n[12],w=n[1],L=n[5],T=n[9],I=n[13],S=n[2],O=n[6],D=n[10],R=n[14],A=n[3],U=n[7],B=n[11],P=n[15];return r[0]=a*b+o*w+s*S+l*A,r[4]=a*C+o*L+s*O+l*U,r[8]=a*M+o*T+s*D+l*B,r[12]=a*_+o*I+s*R+l*P,r[1]=c*b+u*w+h*S+d*A,r[5]=c*C+u*L+h*O+d*U,r[9]=c*M+u*T+h*D+d*B,r[13]=c*_+u*I+h*R+d*P,r[2]=f*b+p*w+m*S+g*A,r[6]=f*C+p*L+m*O+g*U,r[10]=f*M+p*T+m*D+g*B,r[14]=f*_+p*I+m*R+g*P,r[3]=v*b+y*w+E*S+x*A,r[7]=v*C+y*L+E*O+x*U,r[11]=v*M+y*T+E*D+x*B,r[15]=v*_+y*I+E*R+x*P,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[4]*=e,t[8]*=e,t[12]*=e,t[1]*=e,t[5]*=e,t[9]*=e,t[13]*=e,t[2]*=e,t[6]*=e,t[10]*=e,t[14]*=e,t[3]*=e,t[7]*=e,t[11]*=e,t[15]*=e,this},applyToBufferAttribute:function(){var e=new l;return function(t){for(var i=0,n=t.count;i<n;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix4(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),determinant:function(){var e=this.elements,t=e[0],i=e[4],n=e[8],r=e[12],a=e[1],o=e[5],s=e[9],l=e[13],c=e[2],u=e[6],h=e[10],d=e[14];return e[3]*(+r*s*u-n*l*u-r*o*h+i*l*h+n*o*d-i*s*d)+e[7]*(+t*s*d-t*l*h+r*a*h-n*a*d+n*l*c-r*s*c)+e[11]*(+t*l*u-t*o*d-r*a*u+i*a*d+r*o*c-i*l*c)+e[15]*(-n*o*c-t*s*u+t*o*h+n*a*u-i*a*h+i*s*c)},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[4],t[4]=e,e=t[2],t[2]=t[8],t[8]=e,e=t[6],t[6]=t[9],t[9]=e,e=t[3],t[3]=t[12],t[12]=e,e=t[7],t[7]=t[13],t[13]=e,e=t[11],t[11]=t[14],t[14]=e,this},setPosition:function(e){var t=this.elements;return t[12]=e.x,t[13]=e.y,t[14]=e.z,this},getInverse:function(e,t){var i=this.elements,n=e.elements,r=n[0],a=n[1],o=n[2],s=n[3],l=n[4],c=n[5],u=n[6],h=n[7],d=n[8],f=n[9],p=n[10],m=n[11],g=n[12],v=n[13],y=n[14],E=n[15],x=f*y*h-v*p*h+v*u*m-c*y*m-f*u*E+c*p*E,b=g*p*h-d*y*h-g*u*m+l*y*m+d*u*E-l*p*E,C=d*v*h-g*f*h+g*c*m-l*v*m-d*c*E+l*f*E,M=g*f*u-d*v*u-g*c*p+l*v*p+d*c*y-l*f*y,_=r*x+a*b+o*C+s*M;if(0===_){var w="THREE.Matrix4.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(w);return console.warn(w),this.identity()}var L=1/_;return i[0]=x*L,i[1]=(v*p*s-f*y*s-v*o*m+a*y*m+f*o*E-a*p*E)*L,i[2]=(c*y*s-v*u*s+v*o*h-a*y*h-c*o*E+a*u*E)*L,i[3]=(f*u*s-c*p*s-f*o*h+a*p*h+c*o*m-a*u*m)*L,i[4]=b*L,i[5]=(d*y*s-g*p*s+g*o*m-r*y*m-d*o*E+r*p*E)*L,i[6]=(g*u*s-l*y*s-g*o*h+r*y*h+l*o*E-r*u*E)*L,i[7]=(l*p*s-d*u*s+d*o*h-r*p*h-l*o*m+r*u*m)*L,i[8]=C*L,i[9]=(g*f*s-d*v*s-g*a*m+r*v*m+d*a*E-r*f*E)*L,i[10]=(l*v*s-g*c*s+g*a*h-r*v*h-l*a*E+r*c*E)*L,i[11]=(d*c*s-l*f*s-d*a*h+r*f*h+l*a*m-r*c*m)*L,i[12]=M*L,i[13]=(d*v*o-g*f*o+g*a*p-r*v*p-d*a*y+r*f*y)*L,i[14]=(g*c*o-l*v*o-g*a*u+r*v*u+l*a*y-r*c*y)*L,i[15]=(l*f*o-d*c*o+d*a*u-r*f*u-l*a*p+r*c*p)*L,this},scale:function(e){var t=this.elements,i=e.x,n=e.y,r=e.z;return t[0]*=i,t[4]*=n,t[8]*=r,t[1]*=i,t[5]*=n,t[9]*=r,t[2]*=i,t[6]*=n,t[10]*=r,t[3]*=i,t[7]*=n,t[11]*=r,this},getMaxScaleOnAxis:function(){var e=this.elements,t=e[0]*e[0]+e[1]*e[1]+e[2]*e[2],i=e[4]*e[4]+e[5]*e[5]+e[6]*e[6],n=e[8]*e[8]+e[9]*e[9]+e[10]*e[10];return Math.sqrt(Math.max(t,i,n))},makeTranslation:function(e,t,i){return this.set(1,0,0,e,0,1,0,t,0,0,1,i,0,0,0,1),this},makeRotationX:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(1,0,0,0,0,t,-i,0,0,i,t,0,0,0,0,1),this},makeRotationY:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,0,i,0,0,1,0,0,-i,0,t,0,0,0,0,1),this},makeRotationZ:function(e){var t=Math.cos(e),i=Math.sin(e);return this.set(t,-i,0,0,i,t,0,0,0,0,1,0,0,0,0,1),this},makeRotationAxis:function(e,t){var i=Math.cos(t),n=Math.sin(t),r=1-i,a=e.x,o=e.y,s=e.z,l=r*a,c=r*o;return this.set(l*a+i,l*o-n*s,l*s+n*o,0,l*o+n*s,c*o+i,c*s-n*a,0,l*s-n*o,c*s+n*a,r*s*s+i,0,0,0,0,1),this},makeScale:function(e,t,i){return this.set(e,0,0,0,0,t,0,0,0,0,i,0,0,0,0,1),this},makeShear:function(e,t,i){return this.set(1,t,i,0,e,1,i,0,e,t,1,0,0,0,0,1),this},compose:function(e,t,i){return this.makeRotationFromQuaternion(t),this.scale(i),this.setPosition(e),this},decompose:function(){var e=new l,t=new c;return function(i,n,r){var a=this.elements,o=e.set(a[0],a[1],a[2]).length(),s=e.set(a[4],a[5],a[6]).length(),l=e.set(a[8],a[9],a[10]).length();this.determinant()<0&&(o=-o),i.x=a[12],i.y=a[13],i.z=a[14],t.copy(this);var c=1/o,u=1/s,h=1/l;return t.elements[0]*=c,t.elements[1]*=c,t.elements[2]*=c,t.elements[4]*=u,t.elements[5]*=u,t.elements[6]*=u,t.elements[8]*=h,t.elements[9]*=h,t.elements[10]*=h,n.setFromRotationMatrix(t),r.x=o,r.y=s,r.z=l,this}}(),makePerspective:function(e,t,i,n,r,a){void 0===a&&console.warn("THREE.Matrix4: .makePerspective() has been redefined and has a new signature. Please check the docs.");var o=this.elements,s=2*r/(t-e),l=2*r/(i-n),c=(t+e)/(t-e),u=(i+n)/(i-n),h=-(a+r)/(a-r),d=-2*a*r/(a-r);return o[0]=s,o[4]=0,o[8]=c,o[12]=0,o[1]=0,o[5]=l,o[9]=u,o[13]=0,o[2]=0,o[6]=0,o[10]=h,o[14]=d,o[3]=0,o[7]=0,o[11]=-1,o[15]=0,this},makeOrthographic:function(e,t,i,n,r,a){var o=this.elements,s=1/(t-e),l=1/(i-n),c=1/(a-r),u=(t+e)*s,h=(i+n)*l,d=(a+r)*c;return o[0]=2*s,o[4]=0,o[8]=0,o[12]=-u,o[1]=0,o[5]=2*l,o[9]=0,o[13]=-h,o[2]=0,o[6]=0,o[10]=-2*c,o[14]=-d,o[3]=0,o[7]=0,o[11]=0,o[15]=1,this},equals:function(e){for(var t=this.elements,i=e.elements,n=0;n<16;n++)if(t[n]!==i[n])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<16;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e[t+9]=i[9],e[t+10]=i[10],e[t+11]=i[11],e[t+12]=i[12],e[t+13]=i[13],e[t+14]=i[14],e[t+15]=i[15],e}}),u.prototype=Object.create(n.prototype),u.prototype.constructor=u,u.prototype.isDataTexture=!0,h.prototype=Object.create(n.prototype),h.prototype.constructor=h,h.prototype.isCubeTexture=!0,Object.defineProperty(h.prototype,"images",{get:function(){return this.image},set:function(e){this.image=e}});var fs=new n,ps=new h,ms=[],gs=[],vs=new Float32Array(16),ys=new Float32Array(9);V.prototype.setValue=function(e,t){for(var i=this.seq,n=0,r=i.length;n!==r;++n){var a=i[n];a.setValue(e,t[a.id])}};var Es=/([\w\d_]+)(\])?(\[|\.)?/g;q.prototype.setValue=function(e,t,i){var n=this.map[t];void 0!==n&&n.setValue(e,i,this.renderer)},q.prototype.setOptional=function(e,t,i){var n=t[i];void 0!==n&&this.setValue(e,i,n)},q.upload=function(e,t,i,n){for(var r=0,a=t.length;r!==a;++r){var o=t[r],s=i[o.id];!1!==s.needsUpdate&&o.setValue(e,s.value,n)}},q.seqWithValue=function(e,t){for(var i=[],n=0,r=e.length;n!==r;++n){var a=e[n];a.id in t&&i.push(a)}return i};var xs={aliceblue:15792383,antiquewhite:16444375,aqua:65535,aquamarine:8388564,azure:15794175,beige:16119260,bisque:16770244,black:0,blanchedalmond:16772045,blue:255,blueviolet:9055202,brown:10824234,burlywood:14596231,cadetblue:6266528,chartreuse:8388352,chocolate:13789470,coral:16744272,cornflowerblue:6591981,cornsilk:16775388,crimson:14423100,cyan:65535,darkblue:139,darkcyan:35723,darkgoldenrod:12092939,darkgray:11119017,darkgreen:25600,darkgrey:11119017,darkkhaki:12433259,darkmagenta:9109643,darkolivegreen:5597999,darkorange:16747520,darkorchid:10040012,darkred:9109504,darksalmon:15308410,darkseagreen:9419919,darkslateblue:4734347,darkslategray:3100495,darkslategrey:3100495,darkturquoise:52945,darkviolet:9699539,deeppink:16716947,deepskyblue:49151,dimgray:6908265,dimgrey:6908265,dodgerblue:2003199,firebrick:11674146,floralwhite:16775920,forestgreen:2263842,fuchsia:16711935,gainsboro:14474460,ghostwhite:16316671,gold:16766720,goldenrod:14329120,gray:8421504,green:32768,greenyellow:11403055,grey:8421504,honeydew:15794160,hotpink:16738740,indianred:13458524,indigo:4915330,ivory:16777200,khaki:15787660,lavender:15132410,lavenderblush:16773365,lawngreen:8190976,lemonchiffon:16775885,lightblue:11393254,lightcoral:15761536,lightcyan:14745599,lightgoldenrodyellow:16448210,lightgray:13882323,lightgreen:9498256,lightgrey:13882323,lightpink:16758465,lightsalmon:16752762,lightseagreen:2142890,lightskyblue:8900346,lightslategray:7833753,lightslategrey:7833753,lightsteelblue:11584734,lightyellow:16777184,lime:65280,limegreen:3329330,linen:16445670,magenta:16711935,maroon:8388608,mediumaquamarine:6737322,mediumblue:205,mediumorchid:12211667,mediumpurple:9662683,mediumseagreen:3978097,mediumslateblue:8087790,mediumspringgreen:64154,mediumturquoise:4772300,mediumvioletred:13047173,midnightblue:1644912,mintcream:16121850,mistyrose:16770273,moccasin:16770229,navajowhite:16768685,navy:128,oldlace:16643558,olive:8421376,olivedrab:7048739,orange:16753920,orangered:16729344,orchid:14315734,palegoldenrod:15657130,palegreen:10025880,paleturquoise:11529966,palevioletred:14381203,papayawhip:16773077,peachpuff:16767673,peru:13468991,pink:16761035,plum:14524637,powderblue:11591910,purple:8388736,red:16711680,rosybrown:12357519,royalblue:4286945,saddlebrown:9127187,salmon:16416882,sandybrown:16032864,seagreen:3050327,seashell:16774638,sienna:10506797,silver:12632256,skyblue:8900331,slateblue:6970061,slategray:7372944,slategrey:7372944,snow:16775930,springgreen:65407,steelblue:4620980,tan:13808780,teal:32896,thistle:14204888,tomato:16737095,turquoise:4251856,violet:15631086,wheat:16113331,white:16777215,whitesmoke:16119285,yellow:16776960,yellowgreen:10145074};Object.assign(j.prototype,{isColor:!0,r:1,g:1,b:1,set:function(e){return e&&e.isColor?this.copy(e):"number"==typeof e?this.setHex(e):"string"==typeof e&&this.setStyle(e),this},setScalar:function(e){return this.r=e,this.g=e,this.b=e,this},setHex:function(e){return e=Math.floor(e),this.r=(e>>16&255)/255,this.g=(e>>8&255)/255,this.b=(255&e)/255,this},setRGB:function(e,t,i){return this.r=e,this.g=t,this.b=i,this},setHSL:function(){function e(e,t,i){return i<0&&(i+=1),i>1&&(i-=1),i<1/6?e+6*(t-e)*i:i<.5?t:i<2/3?e+6*(t-e)*(2/3-i):e}return function(t,i,n){if(t=hs.euclideanModulo(t,1),i=hs.clamp(i,0,1),n=hs.clamp(n,0,1),0===i)this.r=this.g=this.b=n;else{var r=n<=.5?n*(1+i):n+i-n*i,a=2*n-r;this.r=e(a,r,t+1/3),this.g=e(a,r,t),this.b=e(a,r,t-1/3)}return this}}(),setStyle:function(e){function t(t){void 0!==t&&parseFloat(t)<1&&console.warn("THREE.Color: Alpha component of "+e+" will be ignored.")}var i;if(i=/^((?:rgb|hsl)a?)\(\s*([^\)]*)\)/.exec(e)){var n,r=i[1],a=i[2];switch(r){case"rgb":case"rgba":if(n=/^(\d+)\s*,\s*(\d+)\s*,\s*(\d+)\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(255,parseInt(n[1],10))/255,this.g=Math.min(255,parseInt(n[2],10))/255,this.b=Math.min(255,parseInt(n[3],10))/255,t(n[5]),this;if(n=/^(\d+)\%\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a))return this.r=Math.min(100,parseInt(n[1],10))/100,this.g=Math.min(100,parseInt(n[2],10))/100,this.b=Math.min(100,parseInt(n[3],10))/100,t(n[5]),this;break;case"hsl":case"hsla":if(n=/^([0-9]*\.?[0-9]+)\s*,\s*(\d+)\%\s*,\s*(\d+)\%\s*(,\s*([0-9]*\.?[0-9]+)\s*)?$/.exec(a)){var o=parseFloat(n[1])/360,s=parseInt(n[2],10)/100,l=parseInt(n[3],10)/100;return t(n[5]),this.setHSL(o,s,l)}}}else if(i=/^\#([A-Fa-f0-9]+)$/.exec(e)){var c=i[1],u=c.length;if(3===u)return this.r=parseInt(c.charAt(0)+c.charAt(0),16)/255,this.g=parseInt(c.charAt(1)+c.charAt(1),16)/255,this.b=parseInt(c.charAt(2)+c.charAt(2),16)/255,this;if(6===u)return this.r=parseInt(c.charAt(0)+c.charAt(1),16)/255,this.g=parseInt(c.charAt(2)+c.charAt(3),16)/255,this.b=parseInt(c.charAt(4)+c.charAt(5),16)/255,this}if(e&&e.length>0){var c=xs[e];void 0!==c?this.setHex(c):console.warn("THREE.Color: Unknown color "+e)}return this},clone:function(){return new this.constructor(this.r,this.g,this.b)},copy:function(e){return this.r=e.r,this.g=e.g,this.b=e.b,this},copyGammaToLinear:function(e,t){return void 0===t&&(t=2),this.r=Math.pow(e.r,t),this.g=Math.pow(e.g,t),this.b=Math.pow(e.b,t),this},copyLinearToGamma:function(e,t){void 0===t&&(t=2);var i=t>0?1/t:1;return this.r=Math.pow(e.r,i),this.g=Math.pow(e.g,i),this.b=Math.pow(e.b,i),this},convertGammaToLinear:function(){var e=this.r,t=this.g,i=this.b;return this.r=e*e,this.g=t*t,this.b=i*i,this},convertLinearToGamma:function(){return this.r=Math.sqrt(this.r),this.g=Math.sqrt(this.g),this.b=Math.sqrt(this.b),this},getHex:function(){return 255*this.r<<16^255*this.g<<8^255*this.b<<0},getHexString:function(){return("000000"+this.getHex().toString(16)).slice(-6)},getHSL:function(e){var t,i,n=e||{h:0,s:0,l:0},r=this.r,a=this.g,o=this.b,s=Math.max(r,a,o),l=Math.min(r,a,o),c=(l+s)/2;if(l===s)t=0,i=0;else{var u=s-l;switch(i=c<=.5?u/(s+l):u/(2-s-l),s){case r:t=(a-o)/u+(a<o?6:0);break;case a:t=(o-r)/u+2;break;case o:t=(r-a)/u+4}t/=6}return n.h=t,n.s=i,n.l=c,n},getStyle:function(){return"rgb("+(255*this.r|0)+","+(255*this.g|0)+","+(255*this.b|0)+")"},offsetHSL:function(e,t,i){var n=this.getHSL();return n.h+=e,n.s+=t,n.l+=i,this.setHSL(n.h,n.s,n.l),this},add:function(e){return this.r+=e.r,this.g+=e.g,this.b+=e.b,this},addColors:function(e,t){return this.r=e.r+t.r,this.g=e.g+t.g,this.b=e.b+t.b,this},addScalar:function(e){return this.r+=e,this.g+=e,this.b+=e,this},sub:function(e){return this.r=Math.max(0,this.r-e.r),this.g=Math.max(0,this.g-e.g),this.b=Math.max(0,this.b-e.b),this},multiply:function(e){return this.r*=e.r,this.g*=e.g,this.b*=e.b,this},multiplyScalar:function(e){return this.r*=e,this.g*=e,this.b*=e,this},lerp:function(e,t){return this.r+=(e.r-this.r)*t,this.g+=(e.g-this.g)*t,this.b+=(e.b-this.b)*t,this},equals:function(e){return e.r===this.r&&e.g===this.g&&e.b===this.b},fromArray:function(e,t){return void 0===t&&(t=0),this.r=e[t],this.g=e[t+1],this.b=e[t+2],this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this.r,e[t+1]=this.g,e[t+2]=this.b,e},toJSON:function(){return this.getHex()}});var bs={common:{diffuse:{value:new j(15658734)},opacity:{value:1},map:{value:null},offsetRepeat:{value:new r(0,0,1,1)},rotateMatrix:{value:new te},specularMap:{value:null},alphaMap:{value:null},envMap:{value:null},flipEnvMap:{value:-1},reflectivity:{value:1},refractionRatio:{value:.98}},aomap:{aoMap:{value:null},aoMapIntensity:{value:1}},lightmap:{lightMap:{value:null},lightMapIntensity:{value:1}},emissivemap:{emissiveMap:{value:null}},bumpmap:{bumpMap:{value:null},bumpScale:{value:1}},normalmap:{normalMap:{value:null},normalScale:{value:new i(1,1)}},displacementmap:{displacementMap:{value:null},displacementScale:{value:1},displacementBias:{value:0}},roughnessmap:{roughnessMap:{value:null}},metalnessmap:{metalnessMap:{value:null}},gradientmap:{gradientMap:{value:null}},fog:{fogDensity:{value:25e-5},fogNear:{value:1},fogFar:{value:2e3},fogColor:{value:new j(16777215)}},lights:{ambientLightColor:{value:[]},directionalLights:{value:[],properties:{direction:{},color:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},directionalShadowMap:{value:[]},directionalShadowMatrix:{value:[]},spotLights:{value:[],properties:{color:{},position:{},direction:{},distance:{},coneCos:{},penumbraCos:{},decay:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},spotShadowMap:{value:[]},spotShadowMatrix:{value:[]},pointLights:{value:[],properties:{color:{},position:{},decay:{},distance:{},shadow:{},shadowBias:{},shadowRadius:{},shadowMapSize:{}}},pointShadowMap:{value:[]},pointShadowMatrix:{value:[]},hemisphereLights:{value:[],properties:{direction:{},skyColor:{},groundColor:{}}},rectAreaLights:{value:[],properties:{color:{},position:{},width:{},height:{}}}},points:{diffuse:{value:new j(15658734)},opacity:{value:1},size:{value:1},scale:{value:1},map:{value:null},offsetRepeat:{value:new r(0,0,1,1)}}},Cs={merge:function(e){for(var t={},i=0;i<e.length;i++){var n=this.clone(e[i]);for(var r in n)t[r]=n[r]}return t},clone:function(e){var t={};for(var i in e){t[i]={};for(var n in e[i]){var r=e[i][n];r&&(r.isColor||r.isMatrix3||r.isMatrix4||r.isVector2||r.isVector3||r.isVector4||r.isTexture)?t[i][n]=r.clone():Array.isArray(r)?t[i][n]=r.slice():t[i][n]=r}}return t}},Ms={alphamap_fragment:"#ifdef USE_ALPHAMAP\n\tdiffuseColor.a *= texture2D( alphaMap, vUv ).a;\n#endif\n",alphamap_pars_fragment:"#ifdef USE_ALPHAMAP\n\tuniform sampler2D alphaMap;\n#endif\n",alphatest_fragment:"#ifdef ALPHATEST\n\tif ( diffuseColor.a < ALPHATEST ) discard;\n#endif\n",aomap_fragment:"#ifdef USE_AOMAP\n\tfloat ambientOcclusion = ( texture2D( aoMap, vUv2 ).r - 1.0 ) * aoMapIntensity + 1.0;\n\treflectedLight.indirectDiffuse *= ambientOcclusion;\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\treflectedLight.indirectSpecular *= computeSpecularOcclusion( dotNV, ambientOcclusion, material.specularRoughness );\n\t#endif\n#endif\n",aomap_pars_fragment:"#ifdef USE_AOMAP\n\tuniform sampler2D aoMap;\n\tuniform float aoMapIntensity;\n#endif",begin_vertex:"\nvec3 transformed = vec3( position );\n",beginnormal_vertex:"\nvec3 objectNormal = vec3( normal );\n",
bsdfs:"float punctualLightIntensityToIrradianceFactor( const in float lightDistance, const in float cutoffDistance, const in float decayExponent ) {\n\tif( decayExponent > 0.0 ) {\n#if defined ( PHYSICALLY_CORRECT_LIGHTS )\n\t\tfloat distanceFalloff = 1.0 / max( pow( lightDistance, decayExponent ), 0.01 );\n\t\tfloat maxDistanceCutoffFactor = pow2( saturate( 1.0 - pow4( lightDistance / cutoffDistance ) ) );\n\t\treturn distanceFalloff * maxDistanceCutoffFactor;\n#else\n\t\treturn pow( saturate( -lightDistance / cutoffDistance + 1.0 ), decayExponent );\n#endif\n\t}\n\treturn 1.0;\n}\nvec3 BRDF_Diffuse_Lambert( const in vec3 diffuseColor ) {\n\treturn RECIPROCAL_PI * diffuseColor;\n}\nvec3 F_Schlick( const in vec3 specularColor, const in float dotLH ) {\n\tfloat fresnel = exp2( ( -5.55473 * dotLH - 6.98316 ) * dotLH );\n\treturn ( 1.0 - specularColor ) * fresnel + specularColor;\n}\nfloat G_GGX_Smith( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gl = dotNL + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\tfloat gv = dotNV + sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\treturn 1.0 / ( gl * gv );\n}\nfloat G_GGX_SmithCorrelated( const in float alpha, const in float dotNL, const in float dotNV ) {\n\tfloat a2 = pow2( alpha );\n\tfloat gv = dotNL * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNV ) );\n\tfloat gl = dotNV * sqrt( a2 + ( 1.0 - a2 ) * pow2( dotNL ) );\n\treturn 0.5 / max( gv + gl, EPSILON );\n}\nfloat D_GGX( const in float alpha, const in float dotNH ) {\n\tfloat a2 = pow2( alpha );\n\tfloat denom = pow2( dotNH ) * ( a2 - 1.0 ) + 1.0;\n\treturn RECIPROCAL_PI * a2 / pow2( denom );\n}\nvec3 BRDF_Specular_GGX( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat alpha = pow2( roughness );\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNL = saturate( dot( geometry.normal, incidentLight.direction ) );\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_GGX_SmithCorrelated( alpha, dotNL, dotNV );\n\tfloat D = D_GGX( alpha, dotNH );\n\treturn F * ( G * D );\n}\nvec2 LTC_Uv( const in vec3 N, const in vec3 V, const in float roughness ) {\n\tconst float LUT_SIZE  = 64.0;\n\tconst float LUT_SCALE = ( LUT_SIZE - 1.0 ) / LUT_SIZE;\n\tconst float LUT_BIAS  = 0.5 / LUT_SIZE;\n\tfloat theta = acos( dot( N, V ) );\n\tvec2 uv = vec2(\n\t\tsqrt( saturate( roughness ) ),\n\t\tsaturate( theta / ( 0.5 * PI ) ) );\n\tuv = uv * LUT_SCALE + LUT_BIAS;\n\treturn uv;\n}\nfloat LTC_ClippedSphereFormFactor( const in vec3 f ) {\n\tfloat l = length( f );\n\treturn max( ( l * l + f.z ) / ( l + 1.0 ), 0.0 );\n}\nvec3 LTC_EdgeVectorFormFactor( const in vec3 v1, const in vec3 v2 ) {\n\tfloat x = dot( v1, v2 );\n\tfloat y = abs( x );\n\tfloat a = 0.86267 + (0.49788 + 0.01436 * y ) * y;\n\tfloat b = 3.45068 + (4.18814 + y) * y;\n\tfloat v = a / b;\n\tfloat theta_sintheta = (x > 0.0) ? v : 0.5 * inversesqrt( 1.0 - x * x ) - v;\n\treturn cross( v1, v2 ) * theta_sintheta;\n}\nvec3 LTC_Evaluate( const in vec3 N, const in vec3 V, const in vec3 P, const in mat3 mInv, const in vec3 rectCoords[ 4 ] ) {\n\tvec3 v1 = rectCoords[ 1 ] - rectCoords[ 0 ];\n\tvec3 v2 = rectCoords[ 3 ] - rectCoords[ 0 ];\n\tvec3 lightNormal = cross( v1, v2 );\n\tif( dot( lightNormal, P - rectCoords[ 0 ] ) < 0.0 ) return vec3( 0.0 );\n\tvec3 T1, T2;\n\tT1 = normalize( V - N * dot( V, N ) );\n\tT2 = - cross( N, T1 );\n\tmat3 mat = mInv * transpose( mat3( T1, T2, N ) );\n\tvec3 coords[ 4 ];\n\tcoords[ 0 ] = mat * ( rectCoords[ 0 ] - P );\n\tcoords[ 1 ] = mat * ( rectCoords[ 1 ] - P );\n\tcoords[ 2 ] = mat * ( rectCoords[ 2 ] - P );\n\tcoords[ 3 ] = mat * ( rectCoords[ 3 ] - P );\n\tcoords[ 0 ] = normalize( coords[ 0 ] );\n\tcoords[ 1 ] = normalize( coords[ 1 ] );\n\tcoords[ 2 ] = normalize( coords[ 2 ] );\n\tcoords[ 3 ] = normalize( coords[ 3 ] );\n\tvec3 vectorFormFactor = vec3( 0.0 );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 0 ], coords[ 1 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 1 ], coords[ 2 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 2 ], coords[ 3 ] );\n\tvectorFormFactor += LTC_EdgeVectorFormFactor( coords[ 3 ], coords[ 0 ] );\n\tvec3 result = vec3( LTC_ClippedSphereFormFactor( vectorFormFactor ) );\n\treturn result;\n}\nvec3 BRDF_Specular_GGX_Environment( const in GeometricContext geometry, const in vec3 specularColor, const in float roughness ) {\n\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\tconst vec4 c0 = vec4( - 1, - 0.0275, - 0.572, 0.022 );\n\tconst vec4 c1 = vec4( 1, 0.0425, 1.04, - 0.04 );\n\tvec4 r = roughness * c0 + c1;\n\tfloat a004 = min( r.x * r.x, exp2( - 9.28 * dotNV ) ) * r.x + r.y;\n\tvec2 AB = vec2( -1.04, 1.04 ) * a004 + r.zw;\n\treturn specularColor * AB.x + AB.y;\n}\nfloat G_BlinnPhong_Implicit( ) {\n\treturn 0.25;\n}\nfloat D_BlinnPhong( const in float shininess, const in float dotNH ) {\n\treturn RECIPROCAL_PI * ( shininess * 0.5 + 1.0 ) * pow( dotNH, shininess );\n}\nvec3 BRDF_Specular_BlinnPhong( const in IncidentLight incidentLight, const in GeometricContext geometry, const in vec3 specularColor, const in float shininess ) {\n\tvec3 halfDir = normalize( incidentLight.direction + geometry.viewDir );\n\tfloat dotNH = saturate( dot( geometry.normal, halfDir ) );\n\tfloat dotLH = saturate( dot( incidentLight.direction, halfDir ) );\n\tvec3 F = F_Schlick( specularColor, dotLH );\n\tfloat G = G_BlinnPhong_Implicit( );\n\tfloat D = D_BlinnPhong( shininess, dotNH );\n\treturn F * ( G * D );\n}\nfloat GGXRoughnessToBlinnExponent( const in float ggxRoughness ) {\n\treturn ( 2.0 / pow2( ggxRoughness + 0.0001 ) - 2.0 );\n}\nfloat BlinnExponentToGGXRoughness( const in float blinnExponent ) {\n\treturn sqrt( 2.0 / ( blinnExponent + 2.0 ) );\n}\n",bumpmap_pars_fragment:"#ifdef USE_BUMPMAP\n\tuniform sampler2D bumpMap;\n\tuniform float bumpScale;\n\tvec2 dHdxy_fwd() {\n\t\tvec2 dSTdx = dFdx( vUv );\n\t\tvec2 dSTdy = dFdy( vUv );\n\t\tfloat Hll = bumpScale * texture2D( bumpMap, vUv ).x;\n\t\tfloat dBx = bumpScale * texture2D( bumpMap, vUv + dSTdx ).x - Hll;\n\t\tfloat dBy = bumpScale * texture2D( bumpMap, vUv + dSTdy ).x - Hll;\n\t\treturn vec2( dBx, dBy );\n\t}\n\tvec3 perturbNormalArb( vec3 surf_pos, vec3 surf_norm, vec2 dHdxy ) {\n\t\tvec3 vSigmaX = dFdx( surf_pos );\n\t\tvec3 vSigmaY = dFdy( surf_pos );\n\t\tvec3 vN = surf_norm;\n\t\tvec3 R1 = cross( vSigmaY, vN );\n\t\tvec3 R2 = cross( vN, vSigmaX );\n\t\tfloat fDet = dot( vSigmaX, R1 );\n\t\tvec3 vGrad = sign( fDet ) * ( dHdxy.x * R1 + dHdxy.y * R2 );\n\t\treturn normalize( abs( fDet ) * surf_norm - vGrad );\n\t}\n#endif\n",clipping_planes_fragment:"#if NUM_CLIPPING_PLANES > 0\n\tfor ( int i = 0; i < UNION_CLIPPING_PLANES; ++ i ) {\n\t\tvec4 plane = clippingPlanes[ i ];\n\t\tif ( dot( vViewPosition, plane.xyz ) > plane.w ) discard;\n\t}\n\t\t\n\t#if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES\n\t\tbool clipped = true;\n\t\tfor ( int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i ) {\n\t\t\tvec4 plane = clippingPlanes[ i ];\n\t\t\tclipped = ( dot( vViewPosition, plane.xyz ) > plane.w ) && clipped;\n\t\t}\n\t\tif ( clipped ) discard;\n\t\n\t#endif\n#endif\n",clipping_planes_pars_fragment:"#if NUM_CLIPPING_PLANES > 0\n\t#if ! defined( PHYSICAL ) && ! defined( PHONG )\n\t\tvarying vec3 vViewPosition;\n\t#endif\n\tuniform vec4 clippingPlanes[ NUM_CLIPPING_PLANES ];\n#endif\n",clipping_planes_pars_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvarying vec3 vViewPosition;\n#endif\n",clipping_planes_vertex:"#if NUM_CLIPPING_PLANES > 0 && ! defined( PHYSICAL ) && ! defined( PHONG )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n",color_fragment:"#ifdef USE_COLOR\n\tdiffuseColor.rgb *= vColor;\n#endif",color_pars_fragment:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif\n",color_pars_vertex:"#ifdef USE_COLOR\n\tvarying vec3 vColor;\n#endif",color_vertex:"#ifdef USE_COLOR\n\tvColor.xyz = color.xyz;\n#endif",common:"#define PI 3.14159265359\n#define PI2 6.28318530718\n#define PI_HALF 1.5707963267949\n#define RECIPROCAL_PI 0.31830988618\n#define RECIPROCAL_PI2 0.15915494\n#define LOG2 1.442695\n#define EPSILON 1e-6\n#define saturate(a) clamp( a, 0.0, 1.0 )\n#define whiteCompliment(a) ( 1.0 - saturate( a ) )\nfloat pow2( const in float x ) { return x*x; }\nfloat pow3( const in float x ) { return x*x*x; }\nfloat pow4( const in float x ) { float x2 = x*x; return x2*x2; }\nfloat average( const in vec3 color ) { return dot( color, vec3( 0.3333 ) ); }\nhighp float rand( const in vec2 uv ) {\n\tconst highp float a = 12.9898, b = 78.233, c = 43758.5453;\n\thighp float dt = dot( uv.xy, vec2( a,b ) ), sn = mod( dt, PI );\n\treturn fract(sin(sn) * c);\n}\nstruct IncidentLight {\n\tvec3 color;\n\tvec3 direction;\n\tbool visible;\n};\nstruct ReflectedLight {\n\tvec3 directDiffuse;\n\tvec3 directSpecular;\n\tvec3 indirectDiffuse;\n\tvec3 indirectSpecular;\n};\nstruct GeometricContext {\n\tvec3 position;\n\tvec3 normal;\n\tvec3 viewDir;\n};\nvec3 transformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( matrix * vec4( dir, 0.0 ) ).xyz );\n}\nvec3 inverseTransformDirection( in vec3 dir, in mat4 matrix ) {\n\treturn normalize( ( vec4( dir, 0.0 ) * matrix ).xyz );\n}\nvec3 projectOnPlane(in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\tfloat distance = dot( planeNormal, point - pointOnPlane );\n\treturn - distance * planeNormal + point;\n}\nfloat sideOfPlane( in vec3 point, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn sign( dot( point - pointOnPlane, planeNormal ) );\n}\nvec3 linePlaneIntersect( in vec3 pointOnLine, in vec3 lineDirection, in vec3 pointOnPlane, in vec3 planeNormal ) {\n\treturn lineDirection * ( dot( planeNormal, pointOnPlane - pointOnLine ) / dot( planeNormal, lineDirection ) ) + pointOnLine;\n}\nmat3 transpose( const in mat3 v ) {\n\tmat3 tmp;\n\ttmp[0] = vec3(v[0].x, v[1].x, v[2].x);\n\ttmp[1] = vec3(v[0].y, v[1].y, v[2].y);\n\ttmp[2] = vec3(v[0].z, v[1].z, v[2].z);\n\treturn tmp;\n}\n",cube_uv_reflection_fragment:"#ifdef ENVMAP_TYPE_CUBE_UV\n#define cubeUV_textureSize (1024.0)\nint getFaceFromDirection(vec3 direction) {\n\tvec3 absDirection = abs(direction);\n\tint face = -1;\n\tif( absDirection.x > absDirection.z ) {\n\t\tif(absDirection.x > absDirection.y )\n\t\t\tface = direction.x > 0.0 ? 0 : 3;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\telse {\n\t\tif(absDirection.z > absDirection.y )\n\t\t\tface = direction.z > 0.0 ? 2 : 5;\n\t\telse\n\t\t\tface = direction.y > 0.0 ? 1 : 4;\n\t}\n\treturn face;\n}\n#define cubeUV_maxLods1  (log2(cubeUV_textureSize*0.25) - 1.0)\n#define cubeUV_rangeClamp (exp2((6.0 - 1.0) * 2.0))\nvec2 MipLevelInfo( vec3 vec, float roughnessLevel, float roughness ) {\n\tfloat scale = exp2(cubeUV_maxLods1 - roughnessLevel);\n\tfloat dxRoughness = dFdx(roughness);\n\tfloat dyRoughness = dFdy(roughness);\n\tvec3 dx = dFdx( vec * scale * dxRoughness );\n\tvec3 dy = dFdy( vec * scale * dyRoughness );\n\tfloat d = max( dot( dx, dx ), dot( dy, dy ) );\n\td = clamp(d, 1.0, cubeUV_rangeClamp);\n\tfloat mipLevel = 0.5 * log2(d);\n\treturn vec2(floor(mipLevel), fract(mipLevel));\n}\n#define cubeUV_maxLods2 (log2(cubeUV_textureSize*0.25) - 2.0)\n#define cubeUV_rcpTextureSize (1.0 / cubeUV_textureSize)\nvec2 getCubeUV(vec3 direction, float roughnessLevel, float mipLevel) {\n\tmipLevel = roughnessLevel > cubeUV_maxLods2 - 3.0 ? 0.0 : mipLevel;\n\tfloat a = 16.0 * cubeUV_rcpTextureSize;\n\tvec2 exp2_packed = exp2( vec2( roughnessLevel, mipLevel ) );\n\tvec2 rcp_exp2_packed = vec2( 1.0 ) / exp2_packed;\n\tfloat powScale = exp2_packed.x * exp2_packed.y;\n\tfloat scale = rcp_exp2_packed.x * rcp_exp2_packed.y * 0.25;\n\tfloat mipOffset = 0.75*(1.0 - rcp_exp2_packed.y) * rcp_exp2_packed.x;\n\tbool bRes = mipLevel == 0.0;\n\tscale =  bRes && (scale < a) ? a : scale;\n\tvec3 r;\n\tvec2 offset;\n\tint face = getFaceFromDirection(direction);\n\tfloat rcpPowScale = 1.0 / powScale;\n\tif( face == 0) {\n\t\tr = vec3(direction.x, -direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 1) {\n\t\tr = vec3(direction.y, direction.x, direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 2) {\n\t\tr = vec3(direction.z, direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.75 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? a : offset.y;\n\t}\n\telse if( face == 3) {\n\t\tr = vec3(direction.x, direction.z, direction.y);\n\t\toffset = vec2(0.0+mipOffset,0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse if( face == 4) {\n\t\tr = vec3(direction.y, direction.x, -direction.z);\n\t\toffset = vec2(scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\telse {\n\t\tr = vec3(direction.z, -direction.x, direction.y);\n\t\toffset = vec2(2.0*scale+mipOffset, 0.5 * rcpPowScale);\n\t\toffset.y = bRes && (offset.y < 2.0*a) ? 0.0 : offset.y;\n\t}\n\tr = normalize(r);\n\tfloat texelOffset = 0.5 * cubeUV_rcpTextureSize;\n\tvec2 s = ( r.yz / abs( r.x ) + vec2( 1.0 ) ) * 0.5;\n\tvec2 base = offset + vec2( texelOffset );\n\treturn base + s * ( scale - 2.0 * texelOffset );\n}\n#define cubeUV_maxLods3 (log2(cubeUV_textureSize*0.25) - 3.0)\nvec4 textureCubeUV(vec3 reflectedDirection, float roughness ) {\n\tfloat roughnessVal = roughness* cubeUV_maxLods3;\n\tfloat r1 = floor(roughnessVal);\n\tfloat r2 = r1 + 1.0;\n\tfloat t = fract(roughnessVal);\n\tvec2 mipInfo = MipLevelInfo(reflectedDirection, r1, roughness);\n\tfloat s = mipInfo.y;\n\tfloat level0 = mipInfo.x;\n\tfloat level1 = level0 + 1.0;\n\tlevel1 = level1 > 5.0 ? 5.0 : level1;\n\tlevel0 += min( floor( s + 0.5 ), 5.0 );\n\tvec2 uv_10 = getCubeUV(reflectedDirection, r1, level0);\n\tvec4 color10 = envMapTexelToLinear(texture2D(envMap, uv_10));\n\tvec2 uv_20 = getCubeUV(reflectedDirection, r2, level0);\n\tvec4 color20 = envMapTexelToLinear(texture2D(envMap, uv_20));\n\tvec4 result = mix(color10, color20, t);\n\treturn vec4(result.rgb, 1.0);\n}\n#endif\n",defaultnormal_vertex:"#ifdef FLIP_SIDED\n\tobjectNormal = -objectNormal;\n#endif\nvec3 transformedNormal = normalMatrix * objectNormal;\n",displacementmap_pars_vertex:"#ifdef USE_DISPLACEMENTMAP\n\tuniform sampler2D displacementMap;\n\tuniform float displacementScale;\n\tuniform float displacementBias;\n#endif\n",displacementmap_vertex:"#ifdef USE_DISPLACEMENTMAP\n\ttransformed += normal * ( texture2D( displacementMap, uv ).x * displacementScale + displacementBias );\n#endif\n",emissivemap_fragment:"#ifdef USE_EMISSIVEMAP\n\tvec4 emissiveColor = texture2D( emissiveMap, vUv );\n\temissiveColor.rgb = emissiveMapTexelToLinear( emissiveColor ).rgb;\n\ttotalEmissiveRadiance *= emissiveColor.rgb;\n#endif\n",emissivemap_pars_fragment:"#ifdef USE_EMISSIVEMAP\n\tuniform sampler2D emissiveMap;\n#endif\n",encodings_fragment:"  gl_FragColor = linearToOutputTexel( gl_FragColor );\n",encodings_pars_fragment:"\nvec4 LinearToLinear( in vec4 value ) {\n\treturn value;\n}\nvec4 GammaToLinear( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( gammaFactor ) ), value.w );\n}\nvec4 LinearToGamma( in vec4 value, in float gammaFactor ) {\n\treturn vec4( pow( value.xyz, vec3( 1.0 / gammaFactor ) ), value.w );\n}\nvec4 sRGBToLinear( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb * 0.9478672986 + vec3( 0.0521327014 ), vec3( 2.4 ) ), value.rgb * 0.0773993808, vec3( lessThanEqual( value.rgb, vec3( 0.04045 ) ) ) ), value.w );\n}\nvec4 LinearTosRGB( in vec4 value ) {\n\treturn vec4( mix( pow( value.rgb, vec3( 0.41666 ) ) * 1.055 - vec3( 0.055 ), value.rgb * 12.92, vec3( lessThanEqual( value.rgb, vec3( 0.0031308 ) ) ) ), value.w );\n}\nvec4 RGBEToLinear( in vec4 value ) {\n\treturn vec4( value.rgb * exp2( value.a * 255.0 - 128.0 ), 1.0 );\n}\nvec4 LinearToRGBE( in vec4 value ) {\n\tfloat maxComponent = max( max( value.r, value.g ), value.b );\n\tfloat fExp = clamp( ceil( log2( maxComponent ) ), -128.0, 127.0 );\n\treturn vec4( value.rgb / exp2( fExp ), ( fExp + 128.0 ) / 255.0 );\n}\nvec4 RGBMToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.xyz * value.w * maxRange, 1.0 );\n}\nvec4 LinearToRGBM( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat M      = clamp( maxRGB / maxRange, 0.0, 1.0 );\n\tM            = ceil( M * 255.0 ) / 255.0;\n\treturn vec4( value.rgb / ( M * maxRange ), M );\n}\nvec4 RGBDToLinear( in vec4 value, in float maxRange ) {\n\treturn vec4( value.rgb * ( ( maxRange / 255.0 ) / value.a ), 1.0 );\n}\nvec4 LinearToRGBD( in vec4 value, in float maxRange ) {\n\tfloat maxRGB = max( value.x, max( value.g, value.b ) );\n\tfloat D      = max( maxRange / maxRGB, 1.0 );\n\tD            = min( floor( D ) / 255.0, 1.0 );\n\treturn vec4( value.rgb * ( D * ( 255.0 / maxRange ) ), D );\n}\nconst mat3 cLogLuvM = mat3( 0.2209, 0.3390, 0.4184, 0.1138, 0.6780, 0.7319, 0.0102, 0.1130, 0.2969 );\nvec4 LinearToLogLuv( in vec4 value )  {\n\tvec3 Xp_Y_XYZp = value.rgb * cLogLuvM;\n\tXp_Y_XYZp = max(Xp_Y_XYZp, vec3(1e-6, 1e-6, 1e-6));\n\tvec4 vResult;\n\tvResult.xy = Xp_Y_XYZp.xy / Xp_Y_XYZp.z;\n\tfloat Le = 2.0 * log2(Xp_Y_XYZp.y) + 127.0;\n\tvResult.w = fract(Le);\n\tvResult.z = (Le - (floor(vResult.w*255.0))/255.0)/255.0;\n\treturn vResult;\n}\nconst mat3 cLogLuvInverseM = mat3( 6.0014, -2.7008, -1.7996, -1.3320, 3.1029, -5.7721, 0.3008, -1.0882, 5.6268 );\nvec4 LogLuvToLinear( in vec4 value ) {\n\tfloat Le = value.z * 255.0 + value.w;\n\tvec3 Xp_Y_XYZp;\n\tXp_Y_XYZp.y = exp2((Le - 127.0) / 2.0);\n\tXp_Y_XYZp.z = Xp_Y_XYZp.y / value.y;\n\tXp_Y_XYZp.x = value.x * Xp_Y_XYZp.z;\n\tvec3 vRGB = Xp_Y_XYZp.rgb * cLogLuvInverseM;\n\treturn vec4( max(vRGB, 0.0), 1.0 );\n}\n",envmap_fragment:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvec3 cameraToVertex = normalize( vWorldPosition - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( normal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#else\n\t\tvec3 reflectVec = vReflect;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tvec4 envColor = textureCube( envMap, flipNormal * vec3( flipEnvMap * reflectVec.x, reflectVec.yz ) );\n\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\tvec2 sampleUV;\n\t\tsampleUV.y = saturate( flipNormal * reflectVec.y * 0.5 + 0.5 );\n\t\tsampleUV.x = atan( flipNormal * reflectVec.z, flipNormal * reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\tvec4 envColor = texture2D( envMap, sampleUV );\n\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\tvec3 reflectView = flipNormal * normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0, 0.0, 1.0 ) );\n\t\tvec4 envColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5 );\n\t#else\n\t\tvec4 envColor = vec4( 0.0 );\n\t#endif\n\tenvColor = envMapTexelToLinear( envColor );\n\t#ifdef ENVMAP_BLENDING_MULTIPLY\n\t\toutgoingLight = mix( outgoingLight, outgoingLight * envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_MIX )\n\t\toutgoingLight = mix( outgoingLight, envColor.xyz, specularStrength * reflectivity );\n\t#elif defined( ENVMAP_BLENDING_ADD )\n\t\toutgoingLight += envColor.xyz * specularStrength * reflectivity;\n\t#endif\n#endif\n",envmap_pars_fragment:"#if defined( USE_ENVMAP ) || defined( PHYSICAL )\n\tuniform float reflectivity;\n\tuniform float envMapIntensity;\n#endif\n#ifdef USE_ENVMAP\n\t#if ! defined( PHYSICAL ) && ( defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) )\n\t\tvarying vec3 vWorldPosition;\n\t#endif\n\t#ifdef ENVMAP_TYPE_CUBE\n\t\tuniform samplerCube envMap;\n\t#else\n\t\tuniform sampler2D envMap;\n\t#endif\n\tuniform float flipEnvMap;\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG ) || defined( PHYSICAL )\n\t\tuniform float refractionRatio;\n\t#else\n\t\tvarying vec3 vReflect;\n\t#endif\n#endif\n",envmap_pars_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvarying vec3 vWorldPosition;\n\t#else\n\t\tvarying vec3 vReflect;\n\t\tuniform float refractionRatio;\n\t#endif\n#endif\n",envmap_vertex:"#ifdef USE_ENVMAP\n\t#if defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( PHONG )\n\t\tvWorldPosition = worldPosition.xyz;\n\t#else\n\t\tvec3 cameraToVertex = normalize( worldPosition.xyz - cameraPosition );\n\t\tvec3 worldNormal = inverseTransformDirection( transformedNormal, viewMatrix );\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvReflect = reflect( cameraToVertex, worldNormal );\n\t\t#else\n\t\t\tvReflect = refract( cameraToVertex, worldNormal, refractionRatio );\n\t\t#endif\n\t#endif\n#endif\n",fog_vertex:"\n#ifdef USE_FOG\nfogDepth = -mvPosition.z;\n#endif",fog_pars_vertex:"#ifdef USE_FOG\n  varying float fogDepth;\n#endif\n",fog_fragment:"#ifdef USE_FOG\n\t#ifdef FOG_EXP2\n\t\tfloat fogFactor = whiteCompliment( exp2( - fogDensity * fogDensity * fogDepth * fogDepth * LOG2 ) );\n\t#else\n\t\tfloat fogFactor = smoothstep( fogNear, fogFar, fogDepth );\n\t#endif\n\tgl_FragColor.rgb = mix( gl_FragColor.rgb, fogColor, fogFactor );\n#endif\n",fog_pars_fragment:"#ifdef USE_FOG\n\tuniform vec3 fogColor;\n\tvarying float fogDepth;\n\t#ifdef FOG_EXP2\n\t\tuniform float fogDensity;\n\t#else\n\t\tuniform float fogNear;\n\t\tuniform float fogFar;\n\t#endif\n#endif\n",gradientmap_pars_fragment:"#ifdef TOON\n\tuniform sampler2D gradientMap;\n\tvec3 getGradientIrradiance( vec3 normal, vec3 lightDirection ) {\n\t\tfloat dotNL = dot( normal, lightDirection );\n\t\tvec2 coord = vec2( dotNL * 0.5 + 0.5, 0.0 );\n\t\t#ifdef USE_GRADIENTMAP\n\t\t\treturn texture2D( gradientMap, coord ).rgb;\n\t\t#else\n\t\t\treturn ( coord.x < 0.7 ) ? vec3( 0.7 ) : vec3( 1.0 );\n\t\t#endif\n\t}\n#endif\n",lightmap_fragment:"#ifdef USE_LIGHTMAP\n\treflectedLight.indirectDiffuse += PI * texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n#endif\n",lightmap_pars_fragment:"#ifdef USE_LIGHTMAP\n\tuniform sampler2D lightMap;\n\tuniform float lightMapIntensity;\n#endif",lights_lambert_vertex:"vec3 diffuse = vec3( 1.0 );\nGeometricContext geometry;\ngeometry.position = mvPosition.xyz;\ngeometry.normal = normalize( transformedNormal );\ngeometry.viewDir = normalize( -mvPosition.xyz );\nGeometricContext backGeometry;\nbackGeometry.position = geometry.position;\nbackGeometry.normal = -geometry.normal;\nbackGeometry.viewDir = geometry.viewDir;\nvLightFront = vec3( 0.0 );\n#ifdef DOUBLE_SIDED\n\tvLightBack = vec3( 0.0 );\n#endif\nIncidentLight directLight;\nfloat dotNL;\nvec3 directLightColor_Diffuse;\n#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tgetPointDirectLightIrradiance( pointLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tgetSpotDirectLightIrradiance( spotLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tgetDirectionalDirectLightIrradiance( directionalLights[ i ], geometry, directLight );\n\t\tdotNL = dot( geometry.normal, directLight.direction );\n\t\tdirectLightColor_Diffuse = PI * directLight.color;\n\t\tvLightFront += saturate( dotNL ) * directLightColor_Diffuse;\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += saturate( -dotNL ) * directLightColor_Diffuse;\n\t\t#endif\n\t}\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\tvLightFront += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t#ifdef DOUBLE_SIDED\n\t\t\tvLightBack += getHemisphereLightIrradiance( hemisphereLights[ i ], backGeometry );\n\t\t#endif\n\t}\n#endif\n",
lights_pars:"uniform vec3 ambientLightColor;\nvec3 getAmbientLightIrradiance( const in vec3 ambientLightColor ) {\n\tvec3 irradiance = ambientLightColor;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treturn irradiance;\n}\n#if NUM_DIR_LIGHTS > 0\n\tstruct DirectionalLight {\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform DirectionalLight directionalLights[ NUM_DIR_LIGHTS ];\n\tvoid getDirectionalDirectLightIrradiance( const in DirectionalLight directionalLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tdirectLight.color = directionalLight.color;\n\t\tdirectLight.direction = directionalLight.direction;\n\t\tdirectLight.visible = true;\n\t}\n#endif\n#if NUM_POINT_LIGHTS > 0\n\tstruct PointLight {\n\t\tvec3 position;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform PointLight pointLights[ NUM_POINT_LIGHTS ];\n\tvoid getPointDirectLightIrradiance( const in PointLight pointLight, const in GeometricContext geometry, out IncidentLight directLight ) {\n\t\tvec3 lVector = pointLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tdirectLight.color = pointLight.color;\n\t\tdirectLight.color *= punctualLightIntensityToIrradianceFactor( lightDistance, pointLight.distance, pointLight.decay );\n\t\tdirectLight.visible = ( directLight.color != vec3( 0.0 ) );\n\t}\n#endif\n#if NUM_SPOT_LIGHTS > 0\n\tstruct SpotLight {\n\t\tvec3 position;\n\t\tvec3 direction;\n\t\tvec3 color;\n\t\tfloat distance;\n\t\tfloat decay;\n\t\tfloat coneCos;\n\t\tfloat penumbraCos;\n\t\tint shadow;\n\t\tfloat shadowBias;\n\t\tfloat shadowRadius;\n\t\tvec2 shadowMapSize;\n\t};\n\tuniform SpotLight spotLights[ NUM_SPOT_LIGHTS ];\n\tvoid getSpotDirectLightIrradiance( const in SpotLight spotLight, const in GeometricContext geometry, out IncidentLight directLight  ) {\n\t\tvec3 lVector = spotLight.position - geometry.position;\n\t\tdirectLight.direction = normalize( lVector );\n\t\tfloat lightDistance = length( lVector );\n\t\tfloat angleCos = dot( directLight.direction, spotLight.direction );\n\t\tif ( angleCos > spotLight.coneCos ) {\n\t\t\tfloat spotEffect = smoothstep( spotLight.coneCos, spotLight.penumbraCos, angleCos );\n\t\t\tdirectLight.color = spotLight.color;\n\t\t\tdirectLight.color *= spotEffect * punctualLightIntensityToIrradianceFactor( lightDistance, spotLight.distance, spotLight.decay );\n\t\t\tdirectLight.visible = true;\n\t\t} else {\n\t\t\tdirectLight.color = vec3( 0.0 );\n\t\t\tdirectLight.visible = false;\n\t\t}\n\t}\n#endif\n#if NUM_RECT_AREA_LIGHTS > 0\n\tstruct RectAreaLight {\n\t\tvec3 color;\n\t\tvec3 position;\n\t\tvec3 halfWidth;\n\t\tvec3 halfHeight;\n\t};\n\tuniform sampler2D ltcMat;\tuniform sampler2D ltcMag;\n\tuniform RectAreaLight rectAreaLights[ NUM_RECT_AREA_LIGHTS ];\n#endif\n#if NUM_HEMI_LIGHTS > 0\n\tstruct HemisphereLight {\n\t\tvec3 direction;\n\t\tvec3 skyColor;\n\t\tvec3 groundColor;\n\t};\n\tuniform HemisphereLight hemisphereLights[ NUM_HEMI_LIGHTS ];\n\tvec3 getHemisphereLightIrradiance( const in HemisphereLight hemiLight, const in GeometricContext geometry ) {\n\t\tfloat dotNL = dot( geometry.normal, hemiLight.direction );\n\t\tfloat hemiDiffuseWeight = 0.5 * dotNL + 0.5;\n\t\tvec3 irradiance = mix( hemiLight.groundColor, hemiLight.skyColor, hemiDiffuseWeight );\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tirradiance *= PI;\n\t\t#endif\n\t\treturn irradiance;\n\t}\n#endif\n#if defined( USE_ENVMAP ) && defined( PHYSICAL )\n\tvec3 getLightProbeIndirectIrradiance( const in GeometricContext geometry, const in int maxMIPLevel ) {\n\t\tvec3 worldNormal = inverseTransformDirection( geometry.normal, viewMatrix );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryVec, float( maxMIPLevel ) );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryVec = vec3( flipEnvMap * worldNormal.x, worldNormal.yz );\n\t\t\tvec4 envMapColor = textureCubeUV( queryVec, 1.0 );\n\t\t#else\n\t\t\tvec4 envMapColor = vec4( 0.0 );\n\t\t#endif\n\t\treturn PI * envMapColor.rgb * envMapIntensity;\n\t}\n\tfloat getSpecularMIPLevel( const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\tfloat maxMIPLevelScalar = float( maxMIPLevel );\n\t\tfloat desiredMIPLevel = maxMIPLevelScalar - 0.79248 - 0.5 * log2( pow2( blinnShininessExponent ) + 1.0 );\n\t\treturn clamp( desiredMIPLevel, 0.0, maxMIPLevelScalar );\n\t}\n\tvec3 getLightProbeIndirectRadiance( const in GeometricContext geometry, const in float blinnShininessExponent, const in int maxMIPLevel ) {\n\t\t#ifdef ENVMAP_MODE_REFLECTION\n\t\t\tvec3 reflectVec = reflect( -geometry.viewDir, geometry.normal );\n\t\t#else\n\t\t\tvec3 reflectVec = refract( -geometry.viewDir, geometry.normal, refractionRatio );\n\t\t#endif\n\t\treflectVec = inverseTransformDirection( reflectVec, viewMatrix );\n\t\tfloat specularMIPLevel = getSpecularMIPLevel( blinnShininessExponent, maxMIPLevel );\n\t\t#ifdef ENVMAP_TYPE_CUBE\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = textureCubeLodEXT( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = textureCube( envMap, queryReflectVec, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_CUBE_UV )\n\t\t\tvec3 queryReflectVec = vec3( flipEnvMap * reflectVec.x, reflectVec.yz );\n\t\t\tvec4 envMapColor = textureCubeUV(queryReflectVec, BlinnExponentToGGXRoughness(blinnShininessExponent));\n\t\t#elif defined( ENVMAP_TYPE_EQUIREC )\n\t\t\tvec2 sampleUV;\n\t\t\tsampleUV.y = saturate( reflectVec.y * 0.5 + 0.5 );\n\t\t\tsampleUV.x = atan( reflectVec.z, reflectVec.x ) * RECIPROCAL_PI2 + 0.5;\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, sampleUV, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, sampleUV, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#elif defined( ENVMAP_TYPE_SPHERE )\n\t\t\tvec3 reflectView = normalize( ( viewMatrix * vec4( reflectVec, 0.0 ) ).xyz + vec3( 0.0,0.0,1.0 ) );\n\t\t\t#ifdef TEXTURE_LOD_EXT\n\t\t\t\tvec4 envMapColor = texture2DLodEXT( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#else\n\t\t\t\tvec4 envMapColor = texture2D( envMap, reflectView.xy * 0.5 + 0.5, specularMIPLevel );\n\t\t\t#endif\n\t\t\tenvMapColor.rgb = envMapTexelToLinear( envMapColor ).rgb;\n\t\t#endif\n\t\treturn envMapColor.rgb * envMapIntensity;\n\t}\n#endif\n",lights_phong_fragment:"BlinnPhongMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb;\nmaterial.specularColor = specular;\nmaterial.specularShininess = shininess;\nmaterial.specularStrength = specularStrength;\n",lights_phong_pars_fragment:"varying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\nstruct BlinnPhongMaterial {\n\tvec3\tdiffuseColor;\n\tvec3\tspecularColor;\n\tfloat\tspecularShininess;\n\tfloat\tspecularStrength;\n};\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_BlinnPhong( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = BlinnExponentToGGXRoughness( material.specularShininess );\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_BlinnPhong( const in IncidentLight directLight, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifdef TOON\n\t\tvec3 irradiance = getGradientIrradiance( geometry.normal, directLight.direction ) * directLight.color;\n\t#else\n\t\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\t\tvec3 irradiance = dotNL * directLight.color;\n\t#endif\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\treflectedLight.directDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\treflectedLight.directSpecular += irradiance * BRDF_Specular_BlinnPhong( directLight, geometry, material.specularColor, material.specularShininess ) * material.specularStrength;\n}\nvoid RE_IndirectDiffuse_BlinnPhong( const in vec3 irradiance, const in GeometricContext geometry, const in BlinnPhongMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\n#define RE_Direct\t\t\t\tRE_Direct_BlinnPhong\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_BlinnPhong\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_BlinnPhong\n#define Material_LightProbeLOD( material )\t(0)\n",lights_physical_fragment:"PhysicalMaterial material;\nmaterial.diffuseColor = diffuseColor.rgb * ( 1.0 - metalnessFactor );\nmaterial.specularRoughness = clamp( roughnessFactor, 0.04, 1.0 );\n#ifdef STANDARD\n\tmaterial.specularColor = mix( vec3( DEFAULT_SPECULAR_COEFFICIENT ), diffuseColor.rgb, metalnessFactor );\n#else\n\tmaterial.specularColor = mix( vec3( MAXIMUM_SPECULAR_COEFFICIENT * pow2( reflectivity ) ), diffuseColor.rgb, metalnessFactor );\n\tmaterial.clearCoat = saturate( clearCoat );\tmaterial.clearCoatRoughness = clamp( clearCoatRoughness, 0.04, 1.0 );\n#endif\n",lights_physical_pars_fragment:"struct PhysicalMaterial {\n\tvec3\tdiffuseColor;\n\tfloat\tspecularRoughness;\n\tvec3\tspecularColor;\n\t#ifndef STANDARD\n\t\tfloat clearCoat;\n\t\tfloat clearCoatRoughness;\n\t#endif\n};\n#define MAXIMUM_SPECULAR_COEFFICIENT 0.16\n#define DEFAULT_SPECULAR_COEFFICIENT 0.04\nfloat clearCoatDHRApprox( const in float roughness, const in float dotNL ) {\n\treturn DEFAULT_SPECULAR_COEFFICIENT + ( 1.0 - DEFAULT_SPECULAR_COEFFICIENT ) * ( pow( 1.0 - dotNL, 5.0 ) * pow( 1.0 - roughness, 2.0 ) );\n}\n#if NUM_RECT_AREA_LIGHTS > 0\n\tvoid RE_Direct_RectArea_Physical( const in RectAreaLight rectAreaLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t\tvec3 normal = geometry.normal;\n\t\tvec3 viewDir = geometry.viewDir;\n\t\tvec3 position = geometry.position;\n\t\tvec3 lightPos = rectAreaLight.position;\n\t\tvec3 halfWidth = rectAreaLight.halfWidth;\n\t\tvec3 halfHeight = rectAreaLight.halfHeight;\n\t\tvec3 lightColor = rectAreaLight.color;\n\t\tfloat roughness = material.specularRoughness;\n\t\tvec3 rectCoords[ 4 ];\n\t\trectCoords[ 0 ] = lightPos - halfWidth - halfHeight;\t\trectCoords[ 1 ] = lightPos + halfWidth - halfHeight;\n\t\trectCoords[ 2 ] = lightPos + halfWidth + halfHeight;\n\t\trectCoords[ 3 ] = lightPos - halfWidth + halfHeight;\n\t\tvec2 uv = LTC_Uv( normal, viewDir, roughness );\n\t\tfloat norm = texture2D( ltcMag, uv ).a;\n\t\tvec4 t = texture2D( ltcMat, uv );\n\t\tmat3 mInv = mat3(\n\t\t\tvec3(   1,   0, t.y ),\n\t\t\tvec3(   0, t.z,   0 ),\n\t\t\tvec3( t.w,   0, t.x )\n\t\t);\n\t\treflectedLight.directSpecular += lightColor * material.specularColor * norm * LTC_Evaluate( normal, viewDir, position, mInv, rectCoords );\n\t\treflectedLight.directDiffuse += lightColor * material.diffuseColor * LTC_Evaluate( normal, viewDir, position, mat3( 1 ), rectCoords );\n\t}\n#endif\nvoid RE_Direct_Physical( const in IncidentLight directLight, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\tfloat dotNL = saturate( dot( geometry.normal, directLight.direction ) );\n\tvec3 irradiance = dotNL * directLight.color;\n\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\tirradiance *= PI;\n\t#endif\n\t#ifndef STANDARD\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.directSpecular += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Specular_GGX( directLight, geometry, material.specularColor, material.specularRoughness );\n\treflectedLight.directDiffuse += ( 1.0 - clearCoatDHR ) * irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n\t#ifndef STANDARD\n\t\treflectedLight.directSpecular += irradiance * material.clearCoat * BRDF_Specular_GGX( directLight, geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\nvoid RE_IndirectDiffuse_Physical( const in vec3 irradiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\treflectedLight.indirectDiffuse += irradiance * BRDF_Diffuse_Lambert( material.diffuseColor );\n}\nvoid RE_IndirectSpecular_Physical( const in vec3 radiance, const in vec3 clearCoatRadiance, const in GeometricContext geometry, const in PhysicalMaterial material, inout ReflectedLight reflectedLight ) {\n\t#ifndef STANDARD\n\t\tfloat dotNV = saturate( dot( geometry.normal, geometry.viewDir ) );\n\t\tfloat dotNL = dotNV;\n\t\tfloat clearCoatDHR = material.clearCoat * clearCoatDHRApprox( material.clearCoatRoughness, dotNL );\n\t#else\n\t\tfloat clearCoatDHR = 0.0;\n\t#endif\n\treflectedLight.indirectSpecular += ( 1.0 - clearCoatDHR ) * radiance * BRDF_Specular_GGX_Environment( geometry, material.specularColor, material.specularRoughness );\n\t#ifndef STANDARD\n\t\treflectedLight.indirectSpecular += clearCoatRadiance * material.clearCoat * BRDF_Specular_GGX_Environment( geometry, vec3( DEFAULT_SPECULAR_COEFFICIENT ), material.clearCoatRoughness );\n\t#endif\n}\n#define RE_Direct\t\t\t\tRE_Direct_Physical\n#define RE_Direct_RectArea\t\tRE_Direct_RectArea_Physical\n#define RE_IndirectDiffuse\t\tRE_IndirectDiffuse_Physical\n#define RE_IndirectSpecular\t\tRE_IndirectSpecular_Physical\n#define Material_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.specularRoughness )\n#define Material_ClearCoat_BlinnShininessExponent( material )   GGXRoughnessToBlinnExponent( material.clearCoatRoughness )\nfloat computeSpecularOcclusion( const in float dotNV, const in float ambientOcclusion, const in float roughness ) {\n\treturn saturate( pow( dotNV + ambientOcclusion, exp2( - 16.0 * roughness - 1.0 ) ) - 1.0 + ambientOcclusion );\n}\n",lights_template:"\nGeometricContext geometry;\ngeometry.position = - vViewPosition;\ngeometry.normal = normal;\ngeometry.viewDir = normalize( vViewPosition );\nIncidentLight directLight;\n#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );\n\t\t#ifdef USE_SHADOWMAP\n\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t\t#endif\n\t\tRE_Direct( directLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )\n\tRectAreaLight rectAreaLight;\n\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {\n\t\trectAreaLight = rectAreaLights[ i ];\n\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );\n\t}\n#endif\n#if defined( RE_IndirectDiffuse )\n\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );\n\t#ifdef USE_LIGHTMAP\n\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS\n\t\t\tlightMapIrradiance *= PI;\n\t\t#endif\n\t\tirradiance += lightMapIrradiance;\n\t#endif\n\t#if ( NUM_HEMI_LIGHTS > 0 )\n\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {\n\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );\n\t\t}\n\t#endif\n\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )\n\t\tirradiance += getLightProbeIndirectIrradiance( geometry, 8 );\n\t#endif\n\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );\n#endif\n#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )\n\tvec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );\n\t#ifndef STANDARD\n\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );\n\t#else\n\t\tvec3 clearCoatRadiance = vec3( 0.0 );\n\t#endif\n\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );\n#endif\n",logdepthbuf_fragment:"#if defined(USE_LOGDEPTHBUF) && defined(USE_LOGDEPTHBUF_EXT)\n\tgl_FragDepthEXT = log2(vFragDepth) * logDepthBufFC * 0.5;\n#endif",logdepthbuf_pars_fragment:"#ifdef USE_LOGDEPTHBUF\n\tuniform float logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n#endif\n",logdepthbuf_pars_vertex:"#ifdef USE_LOGDEPTHBUF\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvarying float vFragDepth;\n\t#endif\n\tuniform float logDepthBufFC;\n#endif",logdepthbuf_vertex:"#ifdef USE_LOGDEPTHBUF\n\tgl_Position.z = log2(max( EPSILON, gl_Position.w + 1.0 )) * logDepthBufFC;\n\t#ifdef USE_LOGDEPTHBUF_EXT\n\t\tvFragDepth = 1.0 + gl_Position.w;\n\t#else\n\t\tgl_Position.z = (gl_Position.z - 1.0) * gl_Position.w;\n\t#endif\n#endif\n",map_fragment:"#ifdef USE_MAP\n\tvec4 texelColor = texture2D( map, vUv );\n\ttexelColor = mapTexelToLinear( texelColor );\n\tdiffuseColor *= texelColor;\n#endif\n",map_pars_fragment:"#ifdef USE_MAP\n\tuniform sampler2D map;\n#endif\n",map_particle_fragment:"#ifdef USE_MAP\n\tvec4 mapTexel = texture2D( map, vec2( gl_PointCoord.x, 1.0 - gl_PointCoord.y ) * offsetRepeat.zw + offsetRepeat.xy );\n\tdiffuseColor *= mapTexelToLinear( mapTexel );\n#endif\n",map_particle_pars_fragment:"#ifdef USE_MAP\n\tuniform vec4 offsetRepeat;\n\tuniform sampler2D map;\n#endif\n",metalnessmap_fragment:"float metalnessFactor = metalness;\n#ifdef USE_METALNESSMAP\n\tvec4 texelMetalness = texture2D( metalnessMap, vUv );\n\tmetalnessFactor *= texelMetalness.b;\n#endif\n",metalnessmap_pars_fragment:"#ifdef USE_METALNESSMAP\n\tuniform sampler2D metalnessMap;\n#endif",morphnormal_vertex:"#ifdef USE_MORPHNORMALS\n\tobjectNormal += ( morphNormal0 - normal ) * morphTargetInfluences[ 0 ];\n\tobjectNormal += ( morphNormal1 - normal ) * morphTargetInfluences[ 1 ];\n\tobjectNormal += ( morphNormal2 - normal ) * morphTargetInfluences[ 2 ];\n\tobjectNormal += ( morphNormal3 - normal ) * morphTargetInfluences[ 3 ];\n#endif\n",morphtarget_pars_vertex:"#ifdef USE_MORPHTARGETS\n\t#ifndef USE_MORPHNORMALS\n\tuniform float morphTargetInfluences[ 8 ];\n\t#else\n\tuniform float morphTargetInfluences[ 4 ];\n\t#endif\n#endif",morphtarget_vertex:"#ifdef USE_MORPHTARGETS\n\ttransformed += ( morphTarget0 - position ) * morphTargetInfluences[ 0 ];\n\ttransformed += ( morphTarget1 - position ) * morphTargetInfluences[ 1 ];\n\ttransformed += ( morphTarget2 - position ) * morphTargetInfluences[ 2 ];\n\ttransformed += ( morphTarget3 - position ) * morphTargetInfluences[ 3 ];\n\t#ifndef USE_MORPHNORMALS\n\ttransformed += ( morphTarget4 - position ) * morphTargetInfluences[ 4 ];\n\ttransformed += ( morphTarget5 - position ) * morphTargetInfluences[ 5 ];\n\ttransformed += ( morphTarget6 - position ) * morphTargetInfluences[ 6 ];\n\ttransformed += ( morphTarget7 - position ) * morphTargetInfluences[ 7 ];\n\t#endif\n#endif\n",normal_flip:"#ifdef DOUBLE_SIDED\n\tfloat flipNormal = ( float( gl_FrontFacing ) * 2.0 - 1.0 );\n#else\n\tfloat flipNormal = 1.0;\n#endif\n",normal_fragment:"#ifdef FLAT_SHADED\n\tvec3 fdx = vec3( dFdx( vViewPosition.x ), dFdx( vViewPosition.y ), dFdx( vViewPosition.z ) );\n\tvec3 fdy = vec3( dFdy( vViewPosition.x ), dFdy( vViewPosition.y ), dFdy( vViewPosition.z ) );\n\tvec3 normal = normalize( cross( fdx, fdy ) );\n#else\n\tvec3 normal = normalize( vNormal ) * flipNormal;\n#endif\n#ifdef USE_NORMALMAP\n\tnormal = perturbNormal2Arb( -vViewPosition, normal );\n#elif defined( USE_BUMPMAP )\n\tnormal = perturbNormalArb( -vViewPosition, normal, dHdxy_fwd() );\n#endif\n",normalmap_pars_fragment:"#ifdef USE_NORMALMAP\n\tuniform sampler2D normalMap;\n\tuniform vec2 normalScale;\n\tvec3 perturbNormal2Arb( vec3 eye_pos, vec3 surf_norm ) {\n\t\tvec3 q0 = dFdx( eye_pos.xyz );\n\t\tvec3 q1 = dFdy( eye_pos.xyz );\n\t\tvec2 st0 = dFdx( vUv.st );\n\t\tvec2 st1 = dFdy( vUv.st );\n\t\tvec3 S = normalize( q0 * st1.t - q1 * st0.t );\n\t\tvec3 T = normalize( -q0 * st1.s + q1 * st0.s );\n\t\tvec3 N = normalize( surf_norm );\n\t\tvec3 mapN = texture2D( normalMap, vUv ).xyz * 2.0 - 1.0;\n\t\tmapN.xy = normalScale * mapN.xy;\n\t\tmat3 tsn = mat3( S, T, N );\n\t\treturn normalize( tsn * mapN );\n\t}\n#endif\n",packing:"vec3 packNormalToRGB( const in vec3 normal ) {\n\treturn normalize( normal ) * 0.5 + 0.5;\n}\nvec3 unpackRGBToNormal( const in vec3 rgb ) {\n\treturn 1.0 - 2.0 * rgb.xyz;\n}\nconst float PackUpscale = 256. / 255.;const float UnpackDownscale = 255. / 256.;\nconst vec3 PackFactors = vec3( 256. * 256. * 256., 256. * 256.,  256. );\nconst vec4 UnpackFactors = UnpackDownscale / vec4( PackFactors, 1. );\nconst float ShiftRight8 = 1. / 256.;\nvec4 packDepthToRGBA( const in float v ) {\n\tvec4 r = vec4( fract( v * PackFactors ), v );\n\tr.yzw -= r.xyz * ShiftRight8;\treturn r * PackUpscale;\n}\nfloat unpackRGBAToDepth( const in vec4 v ) {\n\treturn dot( v, UnpackFactors );\n}\nfloat viewZToOrthographicDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn ( viewZ + near ) / ( near - far );\n}\nfloat orthographicDepthToViewZ( const in float linearClipZ, const in float near, const in float far ) {\n\treturn linearClipZ * ( near - far ) - near;\n}\nfloat viewZToPerspectiveDepth( const in float viewZ, const in float near, const in float far ) {\n\treturn (( near + viewZ ) * far ) / (( far - near ) * viewZ );\n}\nfloat perspectiveDepthToViewZ( const in float invClipZ, const in float near, const in float far ) {\n\treturn ( near * far ) / ( ( far - near ) * invClipZ - far );\n}\n",premultiplied_alpha_fragment:"#ifdef PREMULTIPLIED_ALPHA\n\tgl_FragColor.rgb *= gl_FragColor.a;\n#endif\n",project_vertex:"#ifdef USE_SKINNING\n\tvec4 mvPosition = modelViewMatrix * skinned;\n#else\n\tvec4 mvPosition = modelViewMatrix * vec4( transformed, 1.0 );\n#endif\ngl_Position = projectionMatrix * mvPosition;\n",dithering_fragment:"#if defined( DITHERING )\n  gl_FragColor.rgb = dithering( gl_FragColor.rgb );\n#endif\n",dithering_pars_fragment:"#if defined( DITHERING )\n\tvec3 dithering( vec3 color ) {\n\t\tfloat grid_position = rand( gl_FragCoord.xy );\n\t\tvec3 dither_shift_RGB = vec3( 0.25 / 255.0, -0.25 / 255.0, 0.25 / 255.0 );\n\t\tdither_shift_RGB = mix( 2.0 * dither_shift_RGB, -2.0 * dither_shift_RGB, grid_position );\n\t\treturn color + dither_shift_RGB;\n\t}\n#endif\n",roughnessmap_fragment:"float roughnessFactor = roughness;\n#ifdef USE_ROUGHNESSMAP\n\tvec4 texelRoughness = texture2D( roughnessMap, vUv );\n\troughnessFactor *= texelRoughness.g;\n#endif\n",roughnessmap_pars_fragment:"#ifdef USE_ROUGHNESSMAP\n\tuniform sampler2D roughnessMap;\n#endif",
shadowmap_pars_fragment:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform sampler2D directionalShadowMap[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform sampler2D spotShadowMap[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform sampler2D pointShadowMap[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n\tfloat texture2DCompare( sampler2D depths, vec2 uv, float compare ) {\n\t\treturn step( compare, unpackRGBAToDepth( texture2D( depths, uv ) ) );\n\t}\n\tfloat texture2DShadowLerp( sampler2D depths, vec2 size, vec2 uv, float compare ) {\n\t\tconst vec2 offset = vec2( 0.0, 1.0 );\n\t\tvec2 texelSize = vec2( 1.0 ) / size;\n\t\tvec2 centroidUV = floor( uv * size + 0.5 ) / size;\n\t\tfloat lb = texture2DCompare( depths, centroidUV + texelSize * offset.xx, compare );\n\t\tfloat lt = texture2DCompare( depths, centroidUV + texelSize * offset.xy, compare );\n\t\tfloat rb = texture2DCompare( depths, centroidUV + texelSize * offset.yx, compare );\n\t\tfloat rt = texture2DCompare( depths, centroidUV + texelSize * offset.yy, compare );\n\t\tvec2 f = fract( uv * size + 0.5 );\n\t\tfloat a = mix( lb, lt, f.y );\n\t\tfloat b = mix( rb, rt, f.y );\n\t\tfloat c = mix( a, b, f.x );\n\t\treturn c;\n\t}\n\tfloat getShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tshadowCoord.xyz /= shadowCoord.w;\n\t\tshadowCoord.z += shadowBias;\n\t\tbvec4 inFrustumVec = bvec4 ( shadowCoord.x >= 0.0, shadowCoord.x <= 1.0, shadowCoord.y >= 0.0, shadowCoord.y <= 1.0 );\n\t\tbool inFrustum = all( inFrustumVec );\n\t\tbvec2 frustumTestVec = bvec2( inFrustum, shadowCoord.z <= 1.0 );\n\t\tbool frustumTest = all( frustumTestVec );\n\t\tif ( frustumTest ) {\n\t\t#if defined( SHADOWMAP_TYPE_PCF )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DCompare( shadowMap, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#elif defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 texelSize = vec2( 1.0 ) / shadowMapSize;\n\t\t\tfloat dx0 = - texelSize.x * shadowRadius;\n\t\t\tfloat dy0 = - texelSize.y * shadowRadius;\n\t\t\tfloat dx1 = + texelSize.x * shadowRadius;\n\t\t\tfloat dy1 = + texelSize.y * shadowRadius;\n\t\t\treturn (\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy, shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, 0.0 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( 0.0, dy1 ), shadowCoord.z ) +\n\t\t\t\ttexture2DShadowLerp( shadowMap, shadowMapSize, shadowCoord.xy + vec2( dx1, dy1 ), shadowCoord.z )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, shadowCoord.xy, shadowCoord.z );\n\t\t#endif\n\t\t}\n\t\treturn 1.0;\n\t}\n\tvec2 cubeToUV( vec3 v, float texelSizeY ) {\n\t\tvec3 absV = abs( v );\n\t\tfloat scaleToCube = 1.0 / max( absV.x, max( absV.y, absV.z ) );\n\t\tabsV *= scaleToCube;\n\t\tv *= scaleToCube * ( 1.0 - 2.0 * texelSizeY );\n\t\tvec2 planar = v.xy;\n\t\tfloat almostATexel = 1.5 * texelSizeY;\n\t\tfloat almostOne = 1.0 - almostATexel;\n\t\tif ( absV.z >= almostOne ) {\n\t\t\tif ( v.z > 0.0 )\n\t\t\t\tplanar.x = 4.0 - v.x;\n\t\t} else if ( absV.x >= almostOne ) {\n\t\t\tfloat signX = sign( v.x );\n\t\t\tplanar.x = v.z * signX + 2.0 * signX;\n\t\t} else if ( absV.y >= almostOne ) {\n\t\t\tfloat signY = sign( v.y );\n\t\t\tplanar.x = v.x + 2.0 * signY + 2.0;\n\t\t\tplanar.y = v.z * signY - 2.0;\n\t\t}\n\t\treturn vec2( 0.125, 0.25 ) * planar + vec2( 0.375, 0.75 );\n\t}\n\tfloat getPointShadow( sampler2D shadowMap, vec2 shadowMapSize, float shadowBias, float shadowRadius, vec4 shadowCoord ) {\n\t\tvec2 texelSize = vec2( 1.0 ) / ( shadowMapSize * vec2( 4.0, 2.0 ) );\n\t\tvec3 lightToPosition = shadowCoord.xyz;\n\t\tvec3 bd3D = normalize( lightToPosition );\n\t\tfloat dp = ( length( lightToPosition ) - shadowBias ) / 1000.0;\n\t\t#if defined( SHADOWMAP_TYPE_PCF ) || defined( SHADOWMAP_TYPE_PCF_SOFT )\n\t\t\tvec2 offset = vec2( - 1, 1 ) * shadowRadius * texelSize.y;\n\t\t\treturn (\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yyx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxy, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.xxx, texelSize.y ), dp ) +\n\t\t\t\ttexture2DCompare( shadowMap, cubeToUV( bd3D + offset.yxx, texelSize.y ), dp )\n\t\t\t) * ( 1.0 / 9.0 );\n\t\t#else\n\t\t\treturn texture2DCompare( shadowMap, cubeToUV( bd3D, texelSize.y ), dp );\n\t\t#endif\n\t}\n#endif\n",shadowmap_pars_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\t\tuniform mat4 directionalShadowMatrix[ NUM_DIR_LIGHTS ];\n\t\tvarying vec4 vDirectionalShadowCoord[ NUM_DIR_LIGHTS ];\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\t\tuniform mat4 spotShadowMatrix[ NUM_SPOT_LIGHTS ];\n\t\tvarying vec4 vSpotShadowCoord[ NUM_SPOT_LIGHTS ];\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\t\tuniform mat4 pointShadowMatrix[ NUM_POINT_LIGHTS ];\n\t\tvarying vec4 vPointShadowCoord[ NUM_POINT_LIGHTS ];\n\t#endif\n#endif\n",shadowmap_vertex:"#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tvDirectionalShadowCoord[ i ] = directionalShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tvSpotShadowCoord[ i ] = spotShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tvPointShadowCoord[ i ] = pointShadowMatrix[ i ] * worldPosition;\n\t}\n\t#endif\n#endif\n",shadowmask_pars_fragment:"float getShadowMask() {\n\tfloat shadow = 1.0;\n\t#ifdef USE_SHADOWMAP\n\t#if NUM_DIR_LIGHTS > 0\n\tDirectionalLight directionalLight;\n\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {\n\t\tdirectionalLight = directionalLights[ i ];\n\t\tshadow *= bool( directionalLight.shadow ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_SPOT_LIGHTS > 0\n\tSpotLight spotLight;\n\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {\n\t\tspotLight = spotLights[ i ];\n\t\tshadow *= bool( spotLight.shadow ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#if NUM_POINT_LIGHTS > 0\n\tPointLight pointLight;\n\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {\n\t\tpointLight = pointLights[ i ];\n\t\tshadow *= bool( pointLight.shadow ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;\n\t}\n\t#endif\n\t#endif\n\treturn shadow;\n}\n",skinbase_vertex:"#ifdef USE_SKINNING\n\tmat4 boneMatX = getBoneMatrix( skinIndex.x );\n\tmat4 boneMatY = getBoneMatrix( skinIndex.y );\n\tmat4 boneMatZ = getBoneMatrix( skinIndex.z );\n\tmat4 boneMatW = getBoneMatrix( skinIndex.w );\n#endif",skinning_pars_vertex:"#ifdef USE_SKINNING\n\tuniform mat4 bindMatrix;\n\tuniform mat4 bindMatrixInverse;\n\t#ifdef BONE_TEXTURE\n\t\tuniform sampler2D boneTexture;\n\t\tuniform int boneTextureSize;\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tfloat j = i * 4.0;\n\t\t\tfloat x = mod( j, float( boneTextureSize ) );\n\t\t\tfloat y = floor( j / float( boneTextureSize ) );\n\t\t\tfloat dx = 1.0 / float( boneTextureSize );\n\t\t\tfloat dy = 1.0 / float( boneTextureSize );\n\t\t\ty = dy * ( y + 0.5 );\n\t\t\tvec4 v1 = texture2D( boneTexture, vec2( dx * ( x + 0.5 ), y ) );\n\t\t\tvec4 v2 = texture2D( boneTexture, vec2( dx * ( x + 1.5 ), y ) );\n\t\t\tvec4 v3 = texture2D( boneTexture, vec2( dx * ( x + 2.5 ), y ) );\n\t\t\tvec4 v4 = texture2D( boneTexture, vec2( dx * ( x + 3.5 ), y ) );\n\t\t\tmat4 bone = mat4( v1, v2, v3, v4 );\n\t\t\treturn bone;\n\t\t}\n\t#else\n\t\tuniform mat4 boneMatrices[ MAX_BONES ];\n\t\tmat4 getBoneMatrix( const in float i ) {\n\t\t\tmat4 bone = boneMatrices[ int(i) ];\n\t\t\treturn bone;\n\t\t}\n\t#endif\n#endif\n",skinning_vertex:"#ifdef USE_SKINNING\n\tvec4 skinVertex = bindMatrix * vec4( transformed, 1.0 );\n\tvec4 skinned = vec4( 0.0 );\n\tskinned += boneMatX * skinVertex * skinWeight.x;\n\tskinned += boneMatY * skinVertex * skinWeight.y;\n\tskinned += boneMatZ * skinVertex * skinWeight.z;\n\tskinned += boneMatW * skinVertex * skinWeight.w;\n\tskinned  = bindMatrixInverse * skinned;\n#endif\n",skinnormal_vertex:"#ifdef USE_SKINNING\n\tmat4 skinMatrix = mat4( 0.0 );\n\tskinMatrix += skinWeight.x * boneMatX;\n\tskinMatrix += skinWeight.y * boneMatY;\n\tskinMatrix += skinWeight.z * boneMatZ;\n\tskinMatrix += skinWeight.w * boneMatW;\n\tskinMatrix  = bindMatrixInverse * skinMatrix * bindMatrix;\n\tobjectNormal = vec4( skinMatrix * vec4( objectNormal, 0.0 ) ).xyz;\n#endif\n",specularmap_fragment:"float specularStrength;\n#ifdef USE_SPECULARMAP\n\tvec4 texelSpecular = texture2D( specularMap, vUv );\n\tspecularStrength = texelSpecular.r;\n#else\n\tspecularStrength = 1.0;\n#endif",specularmap_pars_fragment:"#ifdef USE_SPECULARMAP\n\tuniform sampler2D specularMap;\n#endif",tonemapping_fragment:"#if defined( TONE_MAPPING )\n  gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );\n#endif\n",tonemapping_pars_fragment:"#define saturate(a) clamp( a, 0.0, 1.0 )\nuniform float toneMappingExposure;\nuniform float toneMappingWhitePoint;\nvec3 LinearToneMapping( vec3 color ) {\n\treturn toneMappingExposure * color;\n}\nvec3 ReinhardToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( color / ( vec3( 1.0 ) + color ) );\n}\n#define Uncharted2Helper( x ) max( ( ( x * ( 0.15 * x + 0.10 * 0.50 ) + 0.20 * 0.02 ) / ( x * ( 0.15 * x + 0.50 ) + 0.20 * 0.30 ) ) - 0.02 / 0.30, vec3( 0.0 ) )\nvec3 Uncharted2ToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\treturn saturate( Uncharted2Helper( color ) / Uncharted2Helper( vec3( toneMappingWhitePoint ) ) );\n}\nvec3 OptimizedCineonToneMapping( vec3 color ) {\n\tcolor *= toneMappingExposure;\n\tcolor = max( vec3( 0.0 ), color - 0.004 );\n\treturn pow( ( color * ( 6.2 * color + 0.5 ) ) / ( color * ( 6.2 * color + 1.7 ) + 0.06 ), vec3( 2.2 ) );\n}\n",uv_pars_fragment:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n#endif",uv_pars_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvarying vec2 vUv;\n\tuniform vec4 offsetRepeat;\n\tuniform mat3 rotateMatrix;\n#endif\n",uv_vertex:"#if defined( USE_MAP ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP ) || defined( USE_SPECULARMAP ) || defined( USE_ALPHAMAP ) || defined( USE_EMISSIVEMAP ) || defined( USE_ROUGHNESSMAP ) || defined( USE_METALNESSMAP )\n\tvUv = mat2(rotateMatrix) * vec2(uv.x - 0.5, uv.y - 0.5) + vec2(0.5, 0.5);\n\tvUv = (vUv -  offsetRepeat.xy)* offsetRepeat.zw;\n#endif",uv2_pars_fragment:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvarying vec2 vUv2;\n#endif",uv2_pars_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tattribute vec2 uv2;\n\tvarying vec2 vUv2;\n#endif",uv2_vertex:"#if defined( USE_LIGHTMAP ) || defined( USE_AOMAP )\n\tvUv2 = uv2;\n#endif",worldpos_vertex:"#if defined( USE_ENVMAP ) || defined( PHONG ) || defined( PHYSICAL ) || defined( LAMBERT ) || defined ( USE_SHADOWMAP )\n\t#ifdef USE_SKINNING\n\t\tvec4 worldPosition = modelMatrix * skinned;\n\t#else\n\t\tvec4 worldPosition = modelMatrix * vec4( transformed, 1.0 );\n\t#endif\n#endif\n",cube_frag:"uniform samplerCube tCube;\nuniform float tFlip;\nuniform float opacity;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tgl_FragColor = textureCube( tCube, vec3( tFlip * vWorldPosition.x, vWorldPosition.yz ) );\n\tgl_FragColor.a *= opacity;\n}\n",cube_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",depth_frag:"#if DEPTH_PACKING == 3200\n\tuniform float opacity;\n#endif\n#include <common>\n#include <packing>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( 1.0 );\n\t#if DEPTH_PACKING == 3200\n\t\tdiffuseColor.a = opacity;\n\t#endif\n\t#include <map_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <logdepthbuf_fragment>\n\t#if DEPTH_PACKING == 3200\n\t\tgl_FragColor = vec4( vec3( gl_FragCoord.z ), opacity );\n\t#elif DEPTH_PACKING == 3201\n\t\tgl_FragColor = packDepthToRGBA( gl_FragCoord.z );\n\t#endif\n}\n",depth_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n",distanceRGBA_frag:"uniform vec3 lightPos;\nvarying vec4 vWorldPosition;\n#include <common>\n#include <packing>\n#include <clipping_planes_pars_fragment>\nvoid main () {\n\t#include <clipping_planes_fragment>\n\tgl_FragColor = packDepthToRGBA( length( vWorldPosition.xyz - lightPos.xyz ) / 1000.0 );\n}\n",distanceRGBA_vert:"varying vec4 vWorldPosition;\n#include <common>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <skinbase_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\tvWorldPosition = worldPosition;\n}\n",equirect_frag:"uniform sampler2D tEquirect;\nuniform float tFlip;\nvarying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvec3 direction = normalize( vWorldPosition );\n\tvec2 sampleUV;\n\tsampleUV.y = saturate( tFlip * direction.y * -0.5 + 0.5 );\n\tsampleUV.x = atan( direction.z, direction.x ) * RECIPROCAL_PI2 + 0.5;\n\tgl_FragColor = texture2D( tEquirect, sampleUV );\n}\n",equirect_vert:"varying vec3 vWorldPosition;\n#include <common>\nvoid main() {\n\tvWorldPosition = transformDirection( position, modelMatrix );\n\t#include <begin_vertex>\n\t#include <project_vertex>\n}\n",linedashed_frag:"uniform vec3 diffuse;\nuniform float opacity;\nuniform float dashSize;\nuniform float totalSize;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tif ( mod( vLineDistance, totalSize ) > dashSize ) {\n\t\tdiscard;\n\t}\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <color_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",linedashed_vert:"uniform float scale;\nattribute float lineDistance;\nvarying float vLineDistance;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\tvLineDistance = scale * lineDistance;\n\tvec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <fog_vertex>\n}\n",meshbasic_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\t#ifdef USE_LIGHTMAP\n\t\treflectedLight.indirectDiffuse += texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;\n\t#else\n\t\treflectedLight.indirectDiffuse += vec3( 1.0 );\n\t#endif\n\t#include <aomap_fragment>\n\treflectedLight.indirectDiffuse *= diffuseColor.rgb;\n\tvec3 outgoingLight = reflectedLight.indirectDiffuse;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",meshbasic_vert:"#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <skinbase_vertex>\n\t#ifdef USE_ENVMAP\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#endif\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <worldpos_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <envmap_vertex>\n\t#include <fog_vertex>\n}\n",meshlambert_frag:"uniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float opacity;\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <emissivemap_fragment>\n\treflectedLight.indirectDiffuse = getAmbientLightIrradiance( ambientLightColor );\n\t#include <lightmap_fragment>\n\treflectedLight.indirectDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb );\n\t#ifdef DOUBLE_SIDED\n\t\treflectedLight.directDiffuse = ( gl_FrontFacing ) ? vLightFront : vLightBack;\n\t#else\n\t\treflectedLight.directDiffuse = vLightFront;\n\t#endif\n\treflectedLight.directDiffuse *= BRDF_Diffuse_Lambert( diffuseColor.rgb ) * getShadowMask();\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + totalEmissiveRadiance;\n\t#include <normal_flip>\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshlambert_vert:"#define LAMBERT\nvarying vec3 vLightFront;\n#ifdef DOUBLE_SIDED\n\tvarying vec3 vLightBack;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <envmap_pars_vertex>\n#include <bsdfs>\n#include <lights_pars>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <lights_lambert_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphong_frag:"#define PHONG\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform vec3 specular;\nuniform float shininess;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <gradientmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <lights_pars>\n#include <lights_phong_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_phong_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\t#include <envmap_fragment>\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphong_vert:"#define PHONG\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <envmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <envmap_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",meshphysical_frag:"#define PHYSICAL\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifndef STANDARD\n\tuniform float clearCoat;\n\tuniform float clearCoatRoughness;\n#endif\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <uv2_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <envmap_pars_fragment>\n#include <fog_pars_fragment>\n#include <bsdfs>\n#include <cube_uv_reflection_fragment>\n#include <lights_pars>\n#include <lights_physical_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n\tvec3 totalEmissiveRadiance = emissive;\n\t#include <logdepthbuf_fragment>\n\t#include <map_fragment>\n\t#include <color_fragment>\n\t#include <alphamap_fragment>\n\t#include <alphatest_fragment>\n\t#include <specularmap_fragment>\n\t#include <roughnessmap_fragment>\n\t#include <metalnessmap_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\t#include <emissivemap_fragment>\n\t#include <lights_physical_fragment>\n\t#include <lights_template>\n\t#include <aomap_fragment>\n\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n\t#include <premultiplied_alpha_fragment>\n\t#include <dithering_fragment>\n}\n",meshphysical_vert:"#define PHYSICAL\nvarying vec3 vViewPosition;\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n#include <uv2_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <specularmap_pars_fragment>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <uv2_vertex>\n\t#include <color_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\tvViewPosition = - mvPosition.xyz;\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",normal_frag:"#define NORMAL\nuniform float opacity;\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <packing>\n#include <uv_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\nvoid main() {\n\t#include <logdepthbuf_fragment>\n\t#include <normal_flip>\n\t#include <normal_fragment>\n\tgl_FragColor = vec4( packNormalToRGB( normal ), opacity );\n}\n",
normal_vert:"#define NORMAL\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvarying vec3 vViewPosition;\n#endif\n#ifndef FLAT_SHADED\n\tvarying vec3 vNormal;\n#endif\n#include <uv_pars_vertex>\n#include <displacementmap_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <logdepthbuf_pars_vertex>\nvoid main() {\n\t#include <uv_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\t#include <defaultnormal_vertex>\n#ifndef FLAT_SHADED\n\tvNormal = normalize( transformedNormal );\n#endif\n\t#include <begin_vertex>\n\t#include <displacementmap_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <project_vertex>\n\t#include <logdepthbuf_vertex>\n#if defined( FLAT_SHADED ) || defined( USE_BUMPMAP ) || defined( USE_NORMALMAP )\n\tvViewPosition = - mvPosition.xyz;\n#endif\n}\n",points_frag:"uniform vec3 diffuse;\nuniform float opacity;\n#include <common>\n#include <packing>\n#include <color_pars_fragment>\n#include <map_particle_pars_fragment>\n#include <fog_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\nvoid main() {\n\t#include <clipping_planes_fragment>\n\tvec3 outgoingLight = vec3( 0.0 );\n\tvec4 diffuseColor = vec4( diffuse, opacity );\n\t#include <logdepthbuf_fragment>\n\t#include <map_particle_fragment>\n\t#include <color_fragment>\n\t#include <alphatest_fragment>\n\toutgoingLight = diffuseColor.rgb;\n\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );\n\t#include <premultiplied_alpha_fragment>\n\t#include <tonemapping_fragment>\n\t#include <encodings_fragment>\n\t#include <fog_fragment>\n}\n",points_vert:"#ifdef USE_ATTRIBUTE_SIZE\n\tattribute float attrSize;\n\t#endif\n\tuniform float size;\nuniform float scale;\n#include <common>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\nvoid main() {\n\t#include <color_vertex>\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#ifdef USE_ATTRIBUTE_SIZE\n\tgl_PointSize = attrSize;\n\t#else\n\t#ifdef USE_SIZEATTENUATION\n\t\tgl_PointSize = size * ( scale / - mvPosition.z );\n\t#else\n\t\tgl_PointSize = size;\n\t#endif\n\t#endif\n\t#ifdef USE_POSITION_OFFSET\n\t\tfloat yPos = gl_Position.y;\n\tfloat w = gl_Position.w;\n\tyPos /= w;\n\tyPos += 0.5 * gl_PointSize / scale;\n\tyPos *= w;\n\tgl_Position.y = yPos;\n\t #endif\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n}\n",shadow_frag:"uniform float opacity;\n#include <common>\n#include <packing>\n#include <bsdfs>\n#include <lights_pars>\n#include <shadowmap_pars_fragment>\n#include <shadowmask_pars_fragment>\nvoid main() {\n\tgl_FragColor = vec4( 0.0, 0.0, 0.0, opacity * ( 1.0 - getShadowMask() ) );\n}\n",shadow_vert:"#include <shadowmap_pars_vertex>\nvoid main() {\n\t#include <begin_vertex>\n\t#include <project_vertex>\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n}\n"},_s={basic:{uniforms:Cs.merge([bs.common,bs.aomap,bs.lightmap,bs.fog]),vertexShader:Ms.meshbasic_vert,fragmentShader:Ms.meshbasic_frag},lambert:{uniforms:Cs.merge([bs.common,bs.aomap,bs.lightmap,bs.emissivemap,bs.fog,bs.lights,{emissive:{value:new j(0)}}]),vertexShader:Ms.meshlambert_vert,fragmentShader:Ms.meshlambert_frag},phong:{uniforms:Cs.merge([bs.common,bs.aomap,bs.lightmap,bs.emissivemap,bs.bumpmap,bs.normalmap,bs.displacementmap,bs.gradientmap,bs.fog,bs.lights,{emissive:{value:new j(0)},specular:{value:new j(1118481)},shininess:{value:30}}]),vertexShader:Ms.meshphong_vert,fragmentShader:Ms.meshphong_frag},standard:{uniforms:Cs.merge([bs.common,bs.aomap,bs.lightmap,bs.emissivemap,bs.bumpmap,bs.normalmap,bs.displacementmap,bs.roughnessmap,bs.metalnessmap,bs.fog,bs.lights,{emissive:{value:new j(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}}]),vertexShader:Ms.meshphysical_vert,fragmentShader:Ms.meshphysical_frag},points:{uniforms:Cs.merge([bs.points,bs.fog]),vertexShader:Ms.points_vert,fragmentShader:Ms.points_frag},dashed:{uniforms:Cs.merge([bs.common,bs.fog,{scale:{value:1},dashSize:{value:1},totalSize:{value:2}}]),vertexShader:Ms.linedashed_vert,fragmentShader:Ms.linedashed_frag},depth:{uniforms:Cs.merge([bs.common,bs.displacementmap]),vertexShader:Ms.depth_vert,fragmentShader:Ms.depth_frag},normal:{uniforms:Cs.merge([bs.common,bs.bumpmap,bs.normalmap,bs.displacementmap,{opacity:{value:1}}]),vertexShader:Ms.normal_vert,fragmentShader:Ms.normal_frag},cube:{uniforms:{tCube:{value:null},tFlip:{value:-1},opacity:{value:1}},vertexShader:Ms.cube_vert,fragmentShader:Ms.cube_frag},equirect:{uniforms:{tEquirect:{value:null},tFlip:{value:-1}},vertexShader:Ms.equirect_vert,fragmentShader:Ms.equirect_frag},distanceRGBA:{uniforms:{lightPos:{value:new l}},vertexShader:Ms.distanceRGBA_vert,fragmentShader:Ms.distanceRGBA_frag}};_s.physical={uniforms:Cs.merge([_s.standard.uniforms,{clearCoat:{value:0},clearCoatRoughness:{value:0}}]),vertexShader:Ms.meshphysical_vert,fragmentShader:Ms.meshphysical_frag},Object.assign(X.prototype,{set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new i;return function(t,i){var n=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=1/0,this.max.x=this.max.y=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y},getCenter:function(e){var t=e||new i;return this.isEmpty()?t.set(0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new i;return this.isEmpty()?t.set(0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y},getParameter:function(e,t){return(t||new i).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y)},clampPoint:function(e,t){return(t||new i).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new i;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}});var ws=0;Object.assign(K.prototype,t.prototype,{isMaterial:!0,setValues:function(e){if(void 0!==e)for(var t in e){var i=e[t];if(void 0!==i){var n=this[t];void 0!==n?n&&n.isColor?n.set(i):n&&n.isVector3&&i&&i.isVector3?n.copy(i):this[t]="overdraw"===t?Number(i):i:console.warn("THREE."+this.type+": '"+t+"' is not a property of this material.")}else console.warn("THREE.Material: '"+t+"' parameter is undefined.")}},toJSON:function(e){function t(e){var t=[];for(var i in e){var n=e[i];delete n.metadata,t.push(n)}return t}var i=void 0===e;i&&(e={textures:{},images:{}});var n={metadata:{version:4.5,type:"Material",generator:"Material.toJSON"}};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),this.color&&this.color.isColor&&(n.color=this.color.getHex()),void 0!==this.roughness&&(n.roughness=this.roughness),void 0!==this.metalness&&(n.metalness=this.metalness),this.emissive&&this.emissive.isColor&&(n.emissive=this.emissive.getHex()),this.specular&&this.specular.isColor&&(n.specular=this.specular.getHex()),void 0!==this.shininess&&(n.shininess=this.shininess),void 0!==this.clearCoat&&(n.clearCoat=this.clearCoat),void 0!==this.clearCoatRoughness&&(n.clearCoatRoughness=this.clearCoatRoughness),this.map&&this.map.isTexture&&(n.map=this.map.toJSON(e).uuid),this.alphaMap&&this.alphaMap.isTexture&&(n.alphaMap=this.alphaMap.toJSON(e).uuid),this.lightMap&&this.lightMap.isTexture&&(n.lightMap=this.lightMap.toJSON(e).uuid),this.bumpMap&&this.bumpMap.isTexture&&(n.bumpMap=this.bumpMap.toJSON(e).uuid,n.bumpScale=this.bumpScale),this.normalMap&&this.normalMap.isTexture&&(n.normalMap=this.normalMap.toJSON(e).uuid,n.normalScale=this.normalScale.toArray()),this.displacementMap&&this.displacementMap.isTexture&&(n.displacementMap=this.displacementMap.toJSON(e).uuid,n.displacementScale=this.displacementScale,n.displacementBias=this.displacementBias),this.roughnessMap&&this.roughnessMap.isTexture&&(n.roughnessMap=this.roughnessMap.toJSON(e).uuid),this.metalnessMap&&this.metalnessMap.isTexture&&(n.metalnessMap=this.metalnessMap.toJSON(e).uuid),this.emissiveMap&&this.emissiveMap.isTexture&&(n.emissiveMap=this.emissiveMap.toJSON(e).uuid),this.specularMap&&this.specularMap.isTexture&&(n.specularMap=this.specularMap.toJSON(e).uuid),this.envMap&&this.envMap.isTexture&&(n.envMap=this.envMap.toJSON(e).uuid,n.reflectivity=this.reflectivity),this.gradientMap&&this.gradientMap.isTexture&&(n.gradientMap=this.gradientMap.toJSON(e).uuid),void 0!==this.size&&(n.size=this.size),void 0!==this.sizeAttenuation&&(n.sizeAttenuation=this.sizeAttenuation),void 0!==this.positionOffset&&(n.positionOffset=this.positionOffset),void 0!==this.sizeAttribute&&(n.sizeAttribute=this.sizeAttribute),this.blending!==Ca&&(n.blending=this.blending),this.shading!==va&&(n.shading=this.shading),this.side!==fa&&(n.side=this.side),this.vertexColors!==ya&&(n.vertexColors=this.vertexColors),this.opacity<1&&(n.opacity=this.opacity),!0===this.transparent&&(n.transparent=this.transparent),n.depthFunc=this.depthFunc,n.depthTest=this.depthTest,n.depthWrite=this.depthWrite,this.alphaTest>0&&(n.alphaTest=this.alphaTest),!0===this.premultipliedAlpha&&(n.premultipliedAlpha=this.premultipliedAlpha),!0===this.wireframe&&(n.wireframe=this.wireframe),this.wireframeLinewidth>1&&(n.wireframeLinewidth=this.wireframeLinewidth),"round"!==this.wireframeLinecap&&(n.wireframeLinecap=this.wireframeLinecap),"round"!==this.wireframeLinejoin&&(n.wireframeLinejoin=this.wireframeLinejoin),n.skinning=this.skinning,n.morphTargets=this.morphTargets,n.dithering=this.dithering,i){var r=t(e.textures),a=t(e.images);r.length>0&&(n.textures=r),a.length>0&&(n.images=a)}return n},clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.name=e.name,this.fog=e.fog,this.lights=e.lights,this.blending=e.blending,this.side=e.side,this.shading=e.shading,this.vertexColors=e.vertexColors,this.opacity=e.opacity,this.transparent=e.transparent,this.blendSrc=e.blendSrc,this.blendDst=e.blendDst,this.blendEquation=e.blendEquation,this.blendSrcAlpha=e.blendSrcAlpha,this.blendDstAlpha=e.blendDstAlpha,this.blendEquationAlpha=e.blendEquationAlpha,this.depthFunc=e.depthFunc,this.depthTest=e.depthTest,this.depthWrite=e.depthWrite,this.colorWrite=e.colorWrite,this.precision=e.precision,this.polygonOffset=e.polygonOffset,this.polygonOffsetFactor=e.polygonOffsetFactor,this.polygonOffsetUnits=e.polygonOffsetUnits,this.dithering=e.dithering,this.alphaTest=e.alphaTest,this.premultipliedAlpha=e.premultipliedAlpha,this.overdraw=e.overdraw,this.visible=e.visible,this.clipShadows=e.clipShadows,this.clipIntersection=e.clipIntersection;var t=e.clippingPlanes,i=null;if(null!==t){var n=t.length;i=new Array(n);for(var r=0;r!==n;++r)i[r]=t[r].clone()}return this.clippingPlanes=i,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Q.prototype=Object.create(K.prototype),Q.prototype.constructor=Q,Q.prototype.isShaderMaterial=!0,Q.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.fragmentShader=e.fragmentShader,this.vertexShader=e.vertexShader,this.uniforms=Cs.clone(e.uniforms),this.defines=e.defines,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.lights=e.lights,this.clipping=e.clipping,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this.extensions=e.extensions,this},Q.prototype.toJSON=function(e){var t=K.prototype.toJSON.call(this,e);return t.uniforms=this.uniforms,t.vertexShader=this.vertexShader,t.fragmentShader=this.fragmentShader,t},J.prototype=Object.create(K.prototype),J.prototype.constructor=J,J.prototype.isMeshDepthMaterial=!0,J.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.depthPacking=e.depthPacking,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.map=e.map,this.alphaMap=e.alphaMap,this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this},Object.assign($.prototype,{isBox3:!0,set:function(e,t){return this.min.copy(e),this.max.copy(t),this},setFromArray:function(e){for(var t=1/0,i=1/0,n=1/0,r=-1/0,a=-1/0,o=-1/0,s=0,l=e.length;s<l;s+=3){var c=e[s],u=e[s+1],h=e[s+2];c<t&&(t=c),u<i&&(i=u),h<n&&(n=h),c>r&&(r=c),u>a&&(a=u),h>o&&(o=h)}return this.min.set(t,i,n),this.max.set(r,a,o),this},setFromBufferAttribute:function(e){for(var t=1/0,i=1/0,n=1/0,r=-1/0,a=-1/0,o=-1/0,s=0,l=e.count;s<l;s++){var c=e.getX(s),u=e.getY(s),h=e.getZ(s);c<t&&(t=c),u<i&&(i=u),h<n&&(n=h),c>r&&(r=c),u>a&&(a=u),h>o&&(o=h)}return this.min.set(t,i,n),this.max.set(r,a,o),this},setFromPoints:function(e){this.makeEmpty();for(var t=0,i=e.length;t<i;t++)this.expandByPoint(e[t]);return this},setFromCenterAndSize:function(){var e=new l;return function(t,i){var n=e.copy(i).multiplyScalar(.5);return this.min.copy(t).sub(n),this.max.copy(t).add(n),this}}(),setFromObject:function(e){return this.makeEmpty(),this.expandByObject(e)},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.min.copy(e.min),this.max.copy(e.max),this},makeEmpty:function(){return this.min.x=this.min.y=this.min.z=1/0,this.max.x=this.max.y=this.max.z=-1/0,this},isEmpty:function(){return this.max.x<this.min.x||this.max.y<this.min.y||this.max.z<this.min.z},getCenter:function(e){var t=e||new l;return this.isEmpty()?t.set(0,0,0):t.addVectors(this.min,this.max).multiplyScalar(.5)},getSize:function(e){var t=e||new l;return this.isEmpty()?t.set(0,0,0):t.subVectors(this.max,this.min)},expandByPoint:function(e){return this.min.min(e),this.max.max(e),this},expandByVector:function(e){return this.min.sub(e),this.max.add(e),this},expandByScalar:function(e){return this.min.addScalar(-e),this.max.addScalar(e),this},expandByObject:function(){var e=new l;return function(t){var i=this;return t.updateMatrixWorld(!0),t.traverse(function(t){var n,r,a=t.geometry;if(void 0!==a)if(a.isGeometry){var o=a.vertices;for(n=0,r=o.length;n<r;n++)e.copy(o[n]),e.applyMatrix4(t.matrixWorld),i.expandByPoint(e)}else if(a.isBufferGeometry){var s=a.attributes.position;if(void 0!==s)for(n=0,r=s.count;n<r;n++)e.fromBufferAttribute(s,n).applyMatrix4(t.matrixWorld),i.expandByPoint(e)}}),this}}(),containsPoint:function(e){return!(e.x<this.min.x||e.x>this.max.x||e.y<this.min.y||e.y>this.max.y||e.z<this.min.z||e.z>this.max.z)},containsBox:function(e){return this.min.x<=e.min.x&&e.max.x<=this.max.x&&this.min.y<=e.min.y&&e.max.y<=this.max.y&&this.min.z<=e.min.z&&e.max.z<=this.max.z},getParameter:function(e,t){return(t||new l).set((e.x-this.min.x)/(this.max.x-this.min.x),(e.y-this.min.y)/(this.max.y-this.min.y),(e.z-this.min.z)/(this.max.z-this.min.z))},intersectsBox:function(e){return!(e.max.x<this.min.x||e.min.x>this.max.x||e.max.y<this.min.y||e.min.y>this.max.y||e.max.z<this.min.z||e.min.z>this.max.z)},intersectsSphere:function(){var e=new l;return function(t){return this.clampPoint(t.center,e),e.distanceToSquared(t.center)<=t.radius*t.radius}}(),intersectsPlane:function(e){var t,i;return e.normal.x>0?(t=e.normal.x*this.min.x,i=e.normal.x*this.max.x):(t=e.normal.x*this.max.x,i=e.normal.x*this.min.x),e.normal.y>0?(t+=e.normal.y*this.min.y,i+=e.normal.y*this.max.y):(t+=e.normal.y*this.max.y,i+=e.normal.y*this.min.y),e.normal.z>0?(t+=e.normal.z*this.min.z,i+=e.normal.z*this.max.z):(t+=e.normal.z*this.max.z,i+=e.normal.z*this.min.z),t<=e.constant&&i>=e.constant},clampPoint:function(e,t){return(t||new l).copy(e).clamp(this.min,this.max)},distanceToPoint:function(){var e=new l;return function(t){return e.copy(t).clamp(this.min,this.max).sub(t).length()}}(),getBoundingSphere:function(){var e=new l;return function(t){var i=t||new ee;return this.getCenter(i.center),i.radius=.5*this.getSize(e).length(),i}}(),intersect:function(e){return this.min.max(e.min),this.max.min(e.max),this.isEmpty()&&this.makeEmpty(),this},union:function(e){return this.min.min(e.min),this.max.max(e.max),this},applyMatrix4:function(){var e=[new l,new l,new l,new l,new l,new l,new l,new l];return function(t){return this.isEmpty()?this:(e[0].set(this.min.x,this.min.y,this.min.z).applyMatrix4(t),e[1].set(this.min.x,this.min.y,this.max.z).applyMatrix4(t),e[2].set(this.min.x,this.max.y,this.min.z).applyMatrix4(t),e[3].set(this.min.x,this.max.y,this.max.z).applyMatrix4(t),e[4].set(this.max.x,this.min.y,this.min.z).applyMatrix4(t),e[5].set(this.max.x,this.min.y,this.max.z).applyMatrix4(t),e[6].set(this.max.x,this.max.y,this.min.z).applyMatrix4(t),e[7].set(this.max.x,this.max.y,this.max.z).applyMatrix4(t),this.setFromPoints(e),this)}}(),translate:function(e){return this.min.add(e),this.max.add(e),this},equals:function(e){return e.min.equals(this.min)&&e.max.equals(this.max)}}),Object.assign(ee.prototype,{set:function(e,t){return this.center.copy(e),this.radius=t,this},setFromPoints:function(){var e=new $;return function(t,i){var n=this.center;void 0!==i?n.copy(i):e.setFromPoints(t).getCenter(n);for(var r=0,a=0,o=t.length;a<o;a++)r=Math.max(r,n.distanceToSquared(t[a]));return this.radius=Math.sqrt(r),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.center.copy(e.center),this.radius=e.radius,this},empty:function(){return this.radius<=0},containsPoint:function(e){return e.distanceToSquared(this.center)<=this.radius*this.radius},distanceToPoint:function(e){return e.distanceTo(this.center)-this.radius},intersectsSphere:function(e){var t=this.radius+e.radius;return e.center.distanceToSquared(this.center)<=t*t},intersectsBox:function(e){return e.intersectsSphere(this)},intersectsPlane:function(e){return Math.abs(this.center.dot(e.normal)-e.constant)<=this.radius},clampPoint:function(e,t){var i=this.center.distanceToSquared(e),n=t||new l;return n.copy(e),i>this.radius*this.radius&&(n.sub(this.center).normalize(),n.multiplyScalar(this.radius).add(this.center)),n},getBoundingBox:function(e){var t=e||new $;return t.set(this.center,this.center),t.expandByScalar(this.radius),t},applyMatrix4:function(e){return this.center.applyMatrix4(e),this.radius=this.radius*e.getMaxScaleOnAxis(),this},translate:function(e){return this.center.add(e),this},equals:function(e){return e.center.equals(this.center)&&e.radius===this.radius}}),Object.assign(te.prototype,{isMatrix3:!0,set:function(e,t,i,n,r,a,o,s,l){var c=this.elements;return c[0]=e,c[1]=n,c[2]=o,c[3]=t,c[4]=r,c[5]=s,c[6]=i,c[7]=a,c[8]=l,this},identity:function(){return this.set(1,0,0,0,1,0,0,0,1),this},clone:function(){return(new this.constructor).fromArray(this.elements)},copy:function(e){var t=this.elements,i=e.elements;return t[0]=i[0],t[1]=i[1],t[2]=i[2],t[3]=i[3],t[4]=i[4],t[5]=i[5],t[6]=i[6],t[7]=i[7],t[8]=i[8],this},setFromMatrix4:function(e){var t=e.elements;return this.set(t[0],t[4],t[8],t[1],t[5],t[9],t[2],t[6],t[10]),this},applyToBufferAttribute:function(){var e=new l;return function(t){for(var i=0,n=t.count;i<n;i++)e.x=t.getX(i),e.y=t.getY(i),e.z=t.getZ(i),e.applyMatrix3(this),t.setXYZ(i,e.x,e.y,e.z);return t}}(),multiply:function(e){return this.multiplyMatrices(this,e)},premultiply:function(e){return this.multiplyMatrices(e,this)},multiplyMatrices:function(e,t){var i=e.elements,n=t.elements,r=this.elements,a=i[0],o=i[3],s=i[6],l=i[1],c=i[4],u=i[7],h=i[2],d=i[5],f=i[8],p=n[0],m=n[3],g=n[6],v=n[1],y=n[4],E=n[7],x=n[2],b=n[5],C=n[8];return r[0]=a*p+o*v+s*x,r[3]=a*m+o*y+s*b,r[6]=a*g+o*E+s*C,r[1]=l*p+c*v+u*x,r[4]=l*m+c*y+u*b,r[7]=l*g+c*E+u*C,r[2]=h*p+d*v+f*x,r[5]=h*m+d*y+f*b,r[8]=h*g+d*E+f*C,this},multiplyScalar:function(e){var t=this.elements;return t[0]*=e,t[3]*=e,t[6]*=e,t[1]*=e,t[4]*=e,t[7]*=e,t[2]*=e,t[5]*=e,t[8]*=e,this},determinant:function(){var e=this.elements,t=e[0],i=e[1],n=e[2],r=e[3],a=e[4],o=e[5],s=e[6],l=e[7],c=e[8];return t*a*c-t*o*l-i*r*c+i*o*s+n*r*l-n*a*s},getInverse:function(e,t){e&&e.isMatrix4&&console.error("THREE.Matrix3.getInverse no longer takes a Matrix4 argument.");var i=e.elements,n=this.elements,r=i[0],a=i[1],o=i[2],s=i[3],l=i[4],c=i[5],u=i[6],h=i[7],d=i[8],f=d*l-c*h,p=c*u-d*s,m=h*s-l*u,g=r*f+a*p+o*m;if(0===g){var v="THREE.Matrix3.getInverse(): can't invert matrix, determinant is 0";if(!0===t)throw new Error(v);return console.warn(v),this.identity()}var y=1/g;return n[0]=f*y,n[1]=(o*h-d*a)*y,n[2]=(c*a-o*l)*y,n[3]=p*y,n[4]=(d*r-o*u)*y,n[5]=(o*s-c*r)*y,n[6]=m*y,n[7]=(a*u-h*r)*y,n[8]=(l*r-a*s)*y,this},transpose:function(){var e,t=this.elements;return e=t[1],t[1]=t[3],t[3]=e,e=t[2],t[2]=t[6],t[6]=e,e=t[5],t[5]=t[7],t[7]=e,this},getNormalMatrix:function(e){return this.setFromMatrix4(e).getInverse(this).transpose()},transposeIntoArray:function(e){var t=this.elements;return e[0]=t[0],e[1]=t[3],e[2]=t[6],e[3]=t[1],e[4]=t[4],e[5]=t[7],e[6]=t[2],e[7]=t[5],e[8]=t[8],this},equals:function(e){for(var t=this.elements,i=e.elements,n=0;n<9;n++)if(t[n]!==i[n])return!1;return!0},fromArray:function(e,t){void 0===t&&(t=0);for(var i=0;i<9;i++)this.elements[i]=e[i+t];return this},toArray:function(e,t){void 0===e&&(e=[]),void 0===t&&(t=0);var i=this.elements;return e[t]=i[0],e[t+1]=i[1],e[t+2]=i[2],e[t+3]=i[3],e[t+4]=i[4],e[t+5]=i[5],e[t+6]=i[6],e[t+7]=i[7],e[t+8]=i[8],e}}),Object.assign(ie.prototype,{set:function(e,t){return this.normal.copy(e),this.constant=t,this},setComponents:function(e,t,i,n){return this.normal.set(e,t,i),this.constant=n,this},setFromNormalAndCoplanarPoint:function(e,t){return this.normal.copy(e),this.constant=-t.dot(this.normal),this},setFromCoplanarPoints:function(){var e=new l,t=new l;return function(i,n,r){var a=e.subVectors(r,n).cross(t.subVectors(i,n)).normalize();return this.setFromNormalAndCoplanarPoint(a,i),this}}(),clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.normal.copy(e.normal),this.constant=e.constant,this},normalize:function(){var e=1/this.normal.length();return this.normal.multiplyScalar(e),this.constant*=e,this},negate:function(){return this.constant*=-1,this.normal.negate(),this},distanceToPoint:function(e){return this.normal.dot(e)+this.constant},distanceToSphere:function(e){return this.distanceToPoint(e.center)-e.radius},projectPoint:function(e,t){return this.orthoPoint(e,t).sub(e).negate()},orthoPoint:function(e,t){var i=this.distanceToPoint(e);return(t||new l).copy(this.normal).multiplyScalar(i)},intersectLine:function(){var e=new l;return function(t,i){var n=i||new l,r=t.delta(e),a=this.normal.dot(r);if(0!==a){var o=-(t.start.dot(this.normal)+this.constant)/a;if(!(o<0||o>1))return n.copy(r).multiplyScalar(o).add(t.start)}else if(0===this.distanceToPoint(t.start))return n.copy(t.start)}}(),intersectsLine:function(e){var t=this.distanceToPoint(e.start),i=this.distanceToPoint(e.end);return t<0&&i>0||i<0&&t>0},intersectsBox:function(e){return e.intersectsPlane(this)},intersectsSphere:function(e){return e.intersectsPlane(this)},coplanarPoint:function(e){return(e||new l).copy(this.normal).multiplyScalar(-this.constant)},applyMatrix4:function(){var e=new l,t=new te;return function(i,n){var r=this.coplanarPoint(e).applyMatrix4(i),a=n||t.getNormalMatrix(i),o=this.normal.applyMatrix3(a).normalize();return this.constant=-r.dot(o),this}}(),translate:function(e){return this.constant=this.constant-e.dot(this.normal),this},equals:function(e){return e.normal.equals(this.normal)&&e.constant===this.constant}}),Object.assign(ne.prototype,{set:function(e,t,i,n,r,a){var o=this.planes;return o[0].copy(e),o[1].copy(t),o[2].copy(i),o[3].copy(n),o[4].copy(r),o[5].copy(a),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){for(var t=this.planes,i=0;i<6;i++)t[i].copy(e.planes[i]);return this},setFromMatrix:function(e){var t=this.planes,i=e.elements,n=i[0],r=i[1],a=i[2],o=i[3],s=i[4],l=i[5],c=i[6],u=i[7],h=i[8],d=i[9],f=i[10],p=i[11],m=i[12],g=i[13],v=i[14],y=i[15];return t[0].setComponents(o-n,u-s,p-h,y-m).normalize(),t[1].setComponents(o+n,u+s,p+h,y+m).normalize(),t[2].setComponents(o+r,u+l,p+d,y+g).normalize(),t[3].setComponents(o-r,u-l,p-d,y-g).normalize(),t[4].setComponents(o-a,u-c,p-f,y-v).normalize(),t[5].setComponents(o+a,u+c,p+f,y+v).normalize(),this},intersectsObject:function(){var e=new ee;return function(t){var i=t.geometry;return null===i.boundingSphere&&i.computeBoundingSphere(),e.copy(i.boundingSphere).applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSprite:function(){var e=new ee;return function(t){return e.center.set(0,0,0),e.radius=.7071067811865476,e.applyMatrix4(t.matrixWorld),this.intersectsSphere(e)}}(),intersectsSphere:function(e){for(var t=this.planes,i=e.center,n=-e.radius,r=0;r<6;r++){if(t[r].distanceToPoint(i)<n)return!1}return!0},intersectsBox:function(){var e=new l,t=new l;return function(i){for(var n=this.planes,r=0;r<6;r++){var a=n[r];e.x=a.normal.x>0?i.min.x:i.max.x,t.x=a.normal.x>0?i.max.x:i.min.x,e.y=a.normal.y>0?i.min.y:i.max.y,t.y=a.normal.y>0?i.max.y:i.min.y,e.z=a.normal.z>0?i.min.z:i.max.z,t.z=a.normal.z>0?i.max.z:i.min.z;var o=a.distanceToPoint(e),s=a.distanceToPoint(t);if(o<0&&s<0)return!1}return!0}}(),containsPoint:function(e){for(var t=this.planes,i=0;i<6;i++)if(t[i].distanceToPoint(e)<0)return!1;return!0}}),Object.assign(ae.prototype,{set:function(e,t){return this.origin.copy(e),this.direction.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.origin.copy(e.origin),this.direction.copy(e.direction),this},at:function(e,t){return(t||new l).copy(this.direction).multiplyScalar(e).add(this.origin)},lookAt:function(e){return this.direction.copy(e).sub(this.origin).normalize(),this},recast:function(){var e=new l;return function(t){return this.origin.copy(this.at(t,e)),this}}(),closestPointToPoint:function(e,t){var i=t||new l;i.subVectors(e,this.origin);var n=i.dot(this.direction);return n<0?i.copy(this.origin):i.copy(this.direction).multiplyScalar(n).add(this.origin)},distanceToPoint:function(e){return Math.sqrt(this.distanceSqToPoint(e))},distanceSqToPoint:function(){var e=new l;return function(t){var i=e.subVectors(t,this.origin).dot(this.direction);return i<0?this.origin.distanceToSquared(t):(e.copy(this.direction).multiplyScalar(i).add(this.origin),e.distanceToSquared(t))}}(),distanceSqToSegment:function(){var e=new l,t=new l,i=new l;return function(n,r,a,o){e.copy(n).add(r).multiplyScalar(.5),t.copy(r).sub(n).normalize(),i.copy(this.origin).sub(e);var s,l,c,u,h=.5*n.distanceTo(r),d=-this.direction.dot(t),f=i.dot(this.direction),p=-i.dot(t),m=i.lengthSq(),g=Math.abs(1-d*d);if(g>0)if(s=d*p-f,l=d*f-p,u=h*g,s>=0)if(l>=-u)if(l<=u){var v=1/g;s*=v,l*=v,c=s*(s+d*l+2*f)+l*(d*s+l+2*p)+m}else l=h,s=Math.max(0,-(d*l+f)),c=-s*s+l*(l+2*p)+m;else l=-h,s=Math.max(0,-(d*l+f)),c=-s*s+l*(l+2*p)+m;else l<=-u?(s=Math.max(0,-(-d*h+f)),l=s>0?-h:Math.min(Math.max(-h,-p),h),c=-s*s+l*(l+2*p)+m):l<=u?(s=0,l=Math.min(Math.max(-h,-p),h),c=l*(l+2*p)+m):(s=Math.max(0,-(d*h+f)),l=s>0?h:Math.min(Math.max(-h,-p),h),c=-s*s+l*(l+2*p)+m);else l=d>0?-h:h,s=Math.max(0,-(d*l+f)),c=-s*s+l*(l+2*p)+m;return a&&a.copy(this.direction).multiplyScalar(s).add(this.origin),o&&o.copy(t).multiplyScalar(l).add(e),c}}(),intersectSphere:function(){var e=new l;return function(t,i){e.subVectors(t.center,this.origin);var n=e.dot(this.direction),r=e.dot(e)-n*n,a=t.radius*t.radius;if(r>a)return null;var o=Math.sqrt(a-r),s=n-o,l=n+o;return s<0&&l<0?null:s<0?this.at(l,i):this.at(s,i)}}(),intersectsSphere:function(e){return this.distanceToPoint(e.center)<=e.radius},distanceToPlane:function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var i=-(this.origin.dot(e.normal)+e.constant)/t;return i>=0?i:null},intersectPlane:function(e,t){var i=this.distanceToPlane(e);return null===i?null:this.at(i,t)},intersectsPlane:function(e){var t=e.distanceToPoint(this.origin);return 0===t||e.normal.dot(this.direction)*t<0},intersectBox:function(e,t){var i,n,r,a,o,s,l=1/this.direction.x,c=1/this.direction.y,u=1/this.direction.z,h=this.origin;return l>=0?(i=(e.min.x-h.x)*l,n=(e.max.x-h.x)*l):(i=(e.max.x-h.x)*l,n=(e.min.x-h.x)*l),c>=0?(r=(e.min.y-h.y)*c,a=(e.max.y-h.y)*c):(r=(e.max.y-h.y)*c,a=(e.min.y-h.y)*c),i>a||r>n?null:((r>i||i!==i)&&(i=r),(a<n||n!==n)&&(n=a),u>=0?(o=(e.min.z-h.z)*u,s=(e.max.z-h.z)*u):(o=(e.max.z-h.z)*u,s=(e.min.z-h.z)*u),i>s||o>n?null:((o>i||i!==i)&&(i=o),(s<n||n!==n)&&(n=s),n<0?null:this.at(i>=0?i:n,t)))},intersectsBox:function(){var e=new l;return function(t){return null!==this.intersectBox(t,e)}}(),intersectTriangle:function(){var e=new l,t=new l,i=new l,n=new l;return function(r,a,o,s,l){t.subVectors(a,r),i.subVectors(o,r),n.crossVectors(t,i);var c,u=this.direction.dot(n);if(u>0){if(s)return null;c=1}else{if(!(u<0))return null;c=-1,u=-u}e.subVectors(this.origin,r);var h=c*this.direction.dot(i.crossVectors(e,i));if(h<0)return null;var d=c*this.direction.dot(t.cross(e));if(d<0)return null;if(h+d>u)return null;var f=-c*e.dot(n);return f<0?null:this.at(f/u,l)}}(),applyMatrix4:function(e){return this.direction.add(this.origin).applyMatrix4(e),this.origin.applyMatrix4(e),this.direction.sub(this.origin),this.direction.normalize(),this},equals:function(e){return e.origin.equals(this.origin)&&e.direction.equals(this.direction)}}),oe.RotationOrders=["XYZ","YZX","ZXY","XZY","YXZ","ZYX"],oe.DefaultOrder="XYZ",Object.defineProperties(oe.prototype,{x:{get:function(){return this._x},set:function(e){this._x=e,this.onChangeCallback()}},y:{get:function(){return this._y},set:function(e){this._y=e,this.onChangeCallback()}},z:{get:function(){return this._z},set:function(e){this._z=e,this.onChangeCallback()}},order:{get:function(){return this._order},set:function(e){this._order=e,this.onChangeCallback()}}}),Object.assign(oe.prototype,{isEuler:!0,set:function(e,t,i,n){return this._x=e,this._y=t,this._z=i,this._order=n||this._order,this.onChangeCallback(),this},clone:function(){return new this.constructor(this._x,this._y,this._z,this._order)},copy:function(e){return this._x=e._x,this._y=e._y,this._z=e._z,this._order=e._order,this.onChangeCallback(),this},setFromRotationMatrix:function(e,t,i){var n=hs.clamp,r=e.elements,a=r[0],o=r[4],s=r[8],l=r[1],c=r[5],u=r[9],h=r[2],d=r[6],f=r[10];return t=t||this._order,"XYZ"===t?(this._y=Math.asin(n(s,-1,1)),Math.abs(s)<.99999?(this._x=Math.atan2(-u,f),this._z=Math.atan2(-o,a)):(this._x=Math.atan2(d,c),this._z=0)):"YXZ"===t?(this._x=Math.asin(-n(u,-1,1)),Math.abs(u)<.99999?(this._y=Math.atan2(s,f),this._z=Math.atan2(l,c)):(this._y=Math.atan2(-h,a),this._z=0)):"ZXY"===t?(this._x=Math.asin(n(d,-1,1)),Math.abs(d)<.99999?(this._y=Math.atan2(-h,f),this._z=Math.atan2(-o,c)):(this._y=0,this._z=Math.atan2(l,a))):"ZYX"===t?(this._y=Math.asin(-n(h,-1,1)),Math.abs(h)<.99999?(this._x=Math.atan2(d,f),this._z=Math.atan2(l,a)):(this._x=0,
this._z=Math.atan2(-o,c))):"YZX"===t?(this._z=Math.asin(n(l,-1,1)),Math.abs(l)<.99999?(this._x=Math.atan2(-u,c),this._y=Math.atan2(-h,a)):(this._x=0,this._y=Math.atan2(s,f))):"XZY"===t?(this._z=Math.asin(-n(o,-1,1)),Math.abs(o)<.99999?(this._x=Math.atan2(d,c),this._y=Math.atan2(s,a)):(this._x=Math.atan2(-u,f),this._y=0)):console.warn("THREE.Euler: .setFromRotationMatrix() given unsupported order: "+t),this._order=t,!1!==i&&this.onChangeCallback(),this},setFromQuaternion:function(){var e=new c;return function(t,i,n){return e.makeRotationFromQuaternion(t),this.setFromRotationMatrix(e,i,n)}}(),setFromVector3:function(e,t){return this.set(e.x,e.y,e.z,t||this._order)},reorder:function(){var e=new s;return function(t){return e.setFromEuler(this),this.setFromQuaternion(e,t)}}(),equals:function(e){return e._x===this._x&&e._y===this._y&&e._z===this._z&&e._order===this._order},fromArray:function(e){return this._x=e[0],this._y=e[1],this._z=e[2],void 0!==e[3]&&(this._order=e[3]),this.onChangeCallback(),this},toArray:function(e,t){return void 0===e&&(e=[]),void 0===t&&(t=0),e[t]=this._x,e[t+1]=this._y,e[t+2]=this._z,e[t+3]=this._order,e},toVector3:function(e){return e?e.set(this._x,this._y,this._z):new l(this._x,this._y,this._z)},onChange:function(e){return this.onChangeCallback=e,this},onChangeCallback:function(){}}),Object.assign(se.prototype,{set:function(e){this.mask=1<<e|0},enable:function(e){this.mask|=1<<e|0},toggle:function(e){this.mask^=1<<e|0},disable:function(e){this.mask&=~(1<<e|0)},test:function(e){return 0!=(this.mask&e.mask)}});var Ls=0;le.DefaultUp=new l(0,1,0),le.DefaultMatrixAutoUpdate=!0,Object.assign(le.prototype,t.prototype,{isObject3D:!0,applyMatrix:function(e){this.matrix.multiplyMatrices(e,this.matrix),this.matrix.decompose(this.position,this.quaternion,this.scale)},setRotationFromAxisAngle:function(e,t){this.quaternion.setFromAxisAngle(e,t)},setRotationFromEuler:function(e){this.quaternion.setFromEuler(e,!0)},setRotationFromMatrix:function(e){this.quaternion.setFromRotationMatrix(e)},setRotationFromQuaternion:function(e){this.quaternion.copy(e)},rotateOnAxis:function(){var e=new s;return function(t,i){return e.setFromAxisAngle(t,i),this.quaternion.multiply(e),this}}(),rotateX:function(){var e=new l(1,0,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateY:function(){var e=new l(0,1,0);return function(t){return this.rotateOnAxis(e,t)}}(),rotateZ:function(){var e=new l(0,0,1);return function(t){return this.rotateOnAxis(e,t)}}(),translateOnAxis:function(){var e=new l;return function(t,i){return e.copy(t).applyQuaternion(this.quaternion),this.position.add(e.multiplyScalar(i)),this}}(),translateX:function(){var e=new l(1,0,0);return function(t){return this.translateOnAxis(e,t)}}(),translateY:function(){var e=new l(0,1,0);return function(t){return this.translateOnAxis(e,t)}}(),translateZ:function(){var e=new l(0,0,1);return function(t){return this.translateOnAxis(e,t)}}(),localToWorld:function(e){return e.applyMatrix4(this.matrixWorld)},worldToLocal:function(){var e=new c;return function(t){return t.applyMatrix4(e.getInverse(this.matrixWorld))}}(),lookAt:function(){var e=new c;return function(t){this.isCamera?e.lookAt(this.position,t,this.up):e.lookAt(t,this.position,this.up),this.quaternion.setFromRotationMatrix(e)}}(),add:function(e){if(arguments.length>1){for(var t=0;t<arguments.length;t++)this.add(arguments[t]);return this}return e===this?(console.error("THREE.Object3D.add: object can't be added as a child of itself.",e),this):(e&&e.isObject3D?(null!==e.parent&&e.parent.remove(e),e.parent=this,e.dispatchEvent({type:"added"}),this.children.push(e)):console.error("THREE.Object3D.add: object not an instance of THREE.Object3D.",e),this)},remove:function(e){if(arguments.length>1)for(var t=0;t<arguments.length;t++)this.remove(arguments[t]);var i=this.children.indexOf(e);-1!==i&&(e.parent=null,e.dispatchEvent({type:"removed"}),this.children.splice(i,1))},getObjectById:function(e){return this.getObjectByProperty("id",e)},getObjectByName:function(e){return this.getObjectByProperty("name",e)},getObjectByProperty:function(e,t){if(this[e]===t)return this;for(var i=0,n=this.children.length;i<n;i++){var r=this.children[i],a=r.getObjectByProperty(e,t);if(void 0!==a)return a}},getWorldPosition:function(e){var t=e||new l;return this.updateMatrixWorld(!0),t.setFromMatrixPosition(this.matrixWorld)},getWorldQuaternion:function(){var e=new l,t=new l;return function(i){var n=i||new s;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,n,t),n}}(),getWorldRotation:function(){var e=new s;return function(t){var i=t||new oe;return this.getWorldQuaternion(e),i.setFromQuaternion(e,this.rotation.order,!1)}}(),getWorldScale:function(){var e=new l,t=new s;return function(i){var n=i||new l;return this.updateMatrixWorld(!0),this.matrixWorld.decompose(e,t,n),n}}(),getWorldDirection:function(){var e=new s;return function(t){var i=t||new l;return this.getWorldQuaternion(e),i.set(0,0,1).applyQuaternion(e)}}(),raycast:function(){},traverse:function(e){e(this);for(var t=this.children,i=0,n=t.length;i<n;i++)t[i].traverse(e)},traverseVisible:function(e){if(!1!==this.visible){e(this);for(var t=this.children,i=0,n=t.length;i<n;i++)t[i].traverseVisible(e)}},traverseAncestors:function(e){var t=this.parent;null!==t&&(e(t),t.traverseAncestors(e))},updateMatrix:function(){this.matrix.compose(this.position,this.quaternion,this.scale),this.matrixWorldNeedsUpdate=!0},updateMatrixWorld:function(e){this.matrixAutoUpdate&&this.updateMatrix(),(this.matrixWorldNeedsUpdate||e)&&(null===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0);for(var t=this.children,i=0,n=t.length;i<n;i++)t[i].updateMatrixWorld(e)},toJSON:function(e){function t(t,i){return void 0===t[i.uuid]&&(t[i.uuid]=i.toJSON(e)),i.uuid}function i(e){var t=[];for(var i in e){var n=e[i];delete n.metadata,t.push(n)}return t}var n=void 0===e||""===e,r={};n&&(e={geometries:{},materials:{},textures:{},images:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var a={};if(a.uuid=this.uuid,a.type=this.type,""!==this.name&&(a.name=this.name),"{}"!==JSON.stringify(this.userData)&&(a.userData=this.userData),!0===this.castShadow&&(a.castShadow=!0),!0===this.receiveShadow&&(a.receiveShadow=!0),!1===this.visible&&(a.visible=!1),a.matrix=this.matrix.toArray(),void 0!==this.geometry&&(a.geometry=t(e.geometries,this.geometry)),void 0!==this.material)if(Array.isArray(this.material)){for(var o=[],s=0,l=this.material.length;s<l;s++)o.push(t(e.materials,this.material[s]));a.material=o}else a.material=t(e.materials,this.material);if(this.children.length>0){a.children=[];for(var s=0;s<this.children.length;s++)a.children.push(this.children[s].toJSON(e).object)}if(n){var c=i(e.geometries),u=i(e.materials),h=i(e.textures),d=i(e.images);c.length>0&&(r.geometries=c),u.length>0&&(r.materials=u),h.length>0&&(r.textures=h),d.length>0&&(r.images=d)}return r.object=a,r},clone:function(e){return(new this.constructor).copy(this,e)},copy:function(e,t){if(void 0===t&&(t=!0),this.name=e.name,this.up.copy(e.up),this.position.copy(e.position),this.quaternion.copy(e.quaternion),this.scale.copy(e.scale),this.matrix.copy(e.matrix),this.matrixWorld.copy(e.matrixWorld),this.matrixAutoUpdate=e.matrixAutoUpdate,this.matrixWorldNeedsUpdate=e.matrixWorldNeedsUpdate,this.layers.mask=e.layers.mask,this.visible=e.visible,this.castShadow=e.castShadow,this.receiveShadow=e.receiveShadow,this.frustumCulled=e.frustumCulled,this.renderOrder=e.renderOrder,this.userData=JSON.parse(JSON.stringify(e.userData)),!0===t)for(var i=0;i<e.children.length;i++){var n=e.children[i];this.add(n.clone())}return this}}),Object.assign(ce.prototype,{set:function(e,t){return this.start.copy(e),this.end.copy(t),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.start.copy(e.start),this.end.copy(e.end),this},getCenter:function(e){return(e||new l).addVectors(this.start,this.end).multiplyScalar(.5)},delta:function(e){return(e||new l).subVectors(this.end,this.start)},distanceSq:function(){return this.start.distanceToSquared(this.end)},distance:function(){return this.start.distanceTo(this.end)},at:function(e,t){var i=t||new l;return this.delta(i).multiplyScalar(e).add(this.start)},closestPointToPointParameter:function(){var e=new l,t=new l;return function(i,n){e.subVectors(i,this.start),t.subVectors(this.end,this.start);var r=t.dot(t),a=t.dot(e),o=a/r;return n&&(o=hs.clamp(o,0,1)),o}}(),closestPointToPoint:function(e,t,i){var n=this.closestPointToPointParameter(e,t),r=i||new l;return this.delta(r).multiplyScalar(n).add(this.start)},applyMatrix4:function(e){return this.start.applyMatrix4(e),this.end.applyMatrix4(e),this},equals:function(e){return e.start.equals(this.start)&&e.end.equals(this.end)}}),Object.assign(ue,{normal:function(){var e=new l;return function(t,i,n,r){var a=r||new l;a.subVectors(n,i),e.subVectors(t,i),a.cross(e);var o=a.lengthSq();return o>0?a.multiplyScalar(1/Math.sqrt(o)):a.set(0,0,0)}}(),barycoordFromPoint:function(){var e=new l,t=new l,i=new l;return function(n,r,a,o,s){e.subVectors(o,r),t.subVectors(a,r),i.subVectors(n,r);var c=e.dot(e),u=e.dot(t),h=e.dot(i),d=t.dot(t),f=t.dot(i),p=c*d-u*u,m=s||new l;if(0===p)return m.set(-2,-1,-1);var g=1/p,v=(d*h-u*f)*g,y=(c*f-u*h)*g;return m.set(1-v-y,y,v)}}(),containsPoint:function(){var e=new l;return function(t,i,n,r){var a=ue.barycoordFromPoint(t,i,n,r,e);return a.x>=0&&a.y>=0&&a.x+a.y<=1}}()}),Object.assign(ue.prototype,{set:function(e,t,i){return this.a.copy(e),this.b.copy(t),this.c.copy(i),this},setFromPointsAndIndices:function(e,t,i,n){return this.a.copy(e[t]),this.b.copy(e[i]),this.c.copy(e[n]),this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.a.copy(e.a),this.b.copy(e.b),this.c.copy(e.c),this},area:function(){var e=new l,t=new l;return function(){return e.subVectors(this.c,this.b),t.subVectors(this.a,this.b),.5*e.cross(t).length()}}(),midpoint:function(e){return(e||new l).addVectors(this.a,this.b).add(this.c).multiplyScalar(1/3)},normal:function(e){return ue.normal(this.a,this.b,this.c,e)},plane:function(e){return(e||new ie).setFromCoplanarPoints(this.a,this.b,this.c)},barycoordFromPoint:function(e,t){return ue.barycoordFromPoint(e,this.a,this.b,this.c,t)},containsPoint:function(e){return ue.containsPoint(e,this.a,this.b,this.c)},closestPointToPoint:function(){var e=new ie,t=[new ce,new ce,new ce],i=new l,n=new l;return function(r,a){var o=a||new l,s=1/0;if(e.setFromCoplanarPoints(this.a,this.b,this.c),e.projectPoint(r,i),!0===this.containsPoint(i))o.copy(i);else{t[0].set(this.a,this.b),t[1].set(this.b,this.c),t[2].set(this.c,this.a);for(var c=0;c<t.length;c++){t[c].closestPointToPoint(i,!0,n);var u=i.distanceToSquared(n);u<s&&(s=u,o.copy(n))}}return o}}(),equals:function(e){return e.a.equals(this.a)&&e.b.equals(this.b)&&e.c.equals(this.c)}}),Object.assign(he.prototype,{clone:function(){return(new this.constructor).copy(this)},copy:function(e){this.a=e.a,this.b=e.b,this.c=e.c,this.normal.copy(e.normal),this.color.copy(e.color),this.materialIndex=e.materialIndex;for(var t=0,i=e.vertexNormals.length;t<i;t++)this.vertexNormals[t]=e.vertexNormals[t].clone();for(var t=0,i=e.vertexColors.length;t<i;t++)this.vertexColors[t]=e.vertexColors[t].clone();return this}}),de.prototype=Object.create(K.prototype),de.prototype.constructor=de,de.prototype.isMeshBasicMaterial=!0,de.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this},Object.defineProperty(fe.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(fe.prototype,{isBufferAttribute:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.itemSize:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.itemSize=e.itemSize,this.count=e.count,this.normalized=e.normalized,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.itemSize,i*=t.itemSize;for(var n=0,r=this.itemSize;n<r;n++)this.array[e+n]=t.array[i+n];return this},copyArray:function(e){return this.array.set(e),this},copyColorsArray:function(e){for(var t=this.array,i=0,n=0,r=e.length;n<r;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyColorsArray(): color is undefined",n),a=new j),t[i++]=a.r,t[i++]=a.g,t[i++]=a.b}return this},copyIndicesArray:function(e){for(var t=this.array,i=0,n=0,r=e.length;n<r;n++){var a=e[n];t[i++]=a.a,t[i++]=a.b,t[i++]=a.c}return this},copyVector2sArray:function(e){for(var t=this.array,n=0,r=0,a=e.length;r<a;r++){var o=e[r];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector2sArray(): vector is undefined",r),o=new i),t[n++]=o.x,t[n++]=o.y}return this},copyVector3sArray:function(e){for(var t=this.array,i=0,n=0,r=e.length;n<r;n++){var a=e[n];void 0===a&&(console.warn("THREE.BufferAttribute.copyVector3sArray(): vector is undefined",n),a=new l),t[i++]=a.x,t[i++]=a.y,t[i++]=a.z}return this},copyVector4sArray:function(e){for(var t=this.array,i=0,n=0,a=e.length;n<a;n++){var o=e[n];void 0===o&&(console.warn("THREE.BufferAttribute.copyVector4sArray(): vector is undefined",n),o=new r),t[i++]=o.x,t[i++]=o.y,t[i++]=o.z,t[i++]=o.w}return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},getX:function(e){return this.array[e*this.itemSize]},setX:function(e,t){return this.array[e*this.itemSize]=t,this},getY:function(e){return this.array[e*this.itemSize+1]},setY:function(e,t){return this.array[e*this.itemSize+1]=t,this},getZ:function(e){return this.array[e*this.itemSize+2]},setZ:function(e,t){return this.array[e*this.itemSize+2]=t,this},getW:function(e){return this.array[e*this.itemSize+3]},setW:function(e,t){return this.array[e*this.itemSize+3]=t,this},setXY:function(e,t,i){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this},setXYZ:function(e,t,i,n){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this},setXYZW:function(e,t,i,n,r){return e*=this.itemSize,this.array[e+0]=t,this.array[e+1]=i,this.array[e+2]=n,this.array[e+3]=r,this},onUpload:function(e){return this.onUploadCallback=e,this},clone:function(){return new this.constructor(this.array,this.itemSize).copy(this)}}),pe.prototype=Object.create(fe.prototype),pe.prototype.constructor=pe,me.prototype=Object.create(fe.prototype),me.prototype.constructor=me,ge.prototype=Object.create(fe.prototype),ge.prototype.constructor=ge,ve.prototype=Object.create(fe.prototype),ve.prototype.constructor=ve,ye.prototype=Object.create(fe.prototype),ye.prototype.constructor=ye,Ee.prototype=Object.create(fe.prototype),Ee.prototype.constructor=Ee,xe.prototype=Object.create(fe.prototype),xe.prototype.constructor=xe,be.prototype=Object.create(fe.prototype),be.prototype.constructor=be,Ce.prototype=Object.create(fe.prototype),Ce.prototype.constructor=Ce,Object.assign(Me.prototype,{computeGroups:function(e){for(var t,i=[],n=void 0,r=e.faces,a=0;a<r.length;a++){var o=r[a];o.materialIndex!==n&&(n=o.materialIndex,void 0!==t&&(t.count=3*a-t.start,i.push(t)),t={start:3*a,materialIndex:n})}void 0!==t&&(t.count=3*a-t.start,i.push(t)),this.groups=i},fromGeometry:function(e){var t,n=e.faces,r=e.vertices,a=e.faceVertexUvs,o=a[0]&&a[0].length>0,s=a[1]&&a[1].length>0,l=e.morphTargets,c=l.length;if(c>0){t=[];for(var u=0;u<c;u++)t[u]=[];this.morphTargets.position=t}var h,d=e.morphNormals,f=d.length;if(f>0){h=[];for(var u=0;u<f;u++)h[u]=[];this.morphTargets.normal=h}for(var p=e.skinIndices,m=e.skinWeights,g=p.length===r.length,v=m.length===r.length,u=0;u<n.length;u++){var y=n[u];this.vertices.push(r[y.a],r[y.b],r[y.c]);var E=y.vertexNormals;if(3===E.length)this.normals.push(E[0],E[1],E[2]);else{var x=y.normal;this.normals.push(x,x,x)}var b=y.vertexColors;if(3===b.length)this.colors.push(b[0],b[1],b[2]);else{var C=y.color;this.colors.push(C,C,C)}if(!0===o){var M=a[0][u];void 0!==M?this.uvs.push(M[0],M[1],M[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv ",u),this.uvs.push(new i,new i,new i))}if(!0===s){var M=a[1][u];void 0!==M?this.uvs2.push(M[0],M[1],M[2]):(console.warn("THREE.DirectGeometry.fromGeometry(): Undefined vertexUv2 ",u),this.uvs2.push(new i,new i,new i))}for(var _=0;_<c;_++){var w=l[_].vertices;t[_].push(w[y.a],w[y.b],w[y.c])}for(var _=0;_<f;_++){var L=d[_].vertexNormals[u];h[_].push(L.a,L.b,L.c)}g&&this.skinIndices.push(p[y.a],p[y.b],p[y.c]),v&&this.skinWeights.push(m[y.a],m[y.b],m[y.c])}return this.computeGroups(e),this.verticesNeedUpdate=e.verticesNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this}});var Ts=0;Object.assign(Le.prototype,t.prototype,{isGeometry:!0,applyMatrix:function(e){for(var t=(new te).getNormalMatrix(e),i=0,n=this.vertices.length;i<n;i++){this.vertices[i].applyMatrix4(e)}for(var i=0,n=this.faces.length;i<n;i++){var r=this.faces[i];r.normal.applyMatrix3(t).normalize();for(var a=0,o=r.vertexNormals.length;a<o;a++)r.vertexNormals[a].applyMatrix3(t).normalize()}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this.verticesNeedUpdate=!0,this.normalsNeedUpdate=!0,this},rotateX:function(){var e=new c;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new c;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new c;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new c;return function(t,i,n){return e.makeTranslation(t,i,n),this.applyMatrix(e),this}}(),scale:function(){var e=new c;return function(t,i,n){return e.makeScale(t,i,n),this.applyMatrix(e),this}}(),lookAt:function(){var e=new le;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),fromBufferGeometry:function(e){function t(e,t,i,r){var a=void 0!==s?[d[e].clone(),d[t].clone(),d[i].clone()]:[],o=void 0!==c?[n.colors[e].clone(),n.colors[t].clone(),n.colors[i].clone()]:[],l=new he(e,t,i,a,o,r);n.faces.push(l),void 0!==u&&n.faceVertexUvs[0].push([f[e].clone(),f[t].clone(),f[i].clone()]),void 0!==h&&n.faceVertexUvs[1].push([p[e].clone(),p[t].clone(),p[i].clone()])}var n=this,r=null!==e.index?e.index.array:void 0,a=e.attributes,o=a.position.array,s=void 0!==a.normal?a.normal.array:void 0,c=void 0!==a.color?a.color.array:void 0,u=void 0!==a.uv?a.uv.array:void 0,h=void 0!==a.uv2?a.uv2.array:void 0;void 0!==h&&(this.faceVertexUvs[1]=[]);for(var d=[],f=[],p=[],m=0,g=0;m<o.length;m+=3,g+=2)n.vertices.push(new l(o[m],o[m+1],o[m+2])),void 0!==s&&d.push(new l(s[m],s[m+1],s[m+2])),void 0!==c&&n.colors.push(new j(c[m],c[m+1],c[m+2])),void 0!==u&&f.push(new i(u[g],u[g+1])),void 0!==h&&p.push(new i(h[g],h[g+1]));var v=e.groups;if(v.length>0)for(var m=0;m<v.length;m++)for(var y=v[m],E=y.start,x=y.count,g=E,b=E+x;g<b;g+=3)void 0!==r?t(r[g],r[g+1],r[g+2],y.materialIndex):t(g,g+1,g+2,y.materialIndex);else if(void 0!==r)for(var m=0;m<r.length;m+=3)t(r[m],r[m+1],r[m+2]);else for(var m=0;m<o.length/3;m+=3)t(m,m+1,m+2);return this.computeFaceNormals(),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),this},center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},normalize:function(){this.computeBoundingSphere();var e=this.boundingSphere.center,t=this.boundingSphere.radius,i=0===t?1:1/t,n=new c;return n.set(i,0,0,-i*e.x,0,i,0,-i*e.y,0,0,i,-i*e.z,0,0,0,1),this.applyMatrix(n),this},computeFaceNormals:function(){for(var e=new l,t=new l,i=0,n=this.faces.length;i<n;i++){var r=this.faces[i],a=this.vertices[r.a],o=this.vertices[r.b],s=this.vertices[r.c];e.subVectors(s,o),t.subVectors(a,o),e.cross(t),e.normalize(),r.normal.copy(e)}},computeVertexNormals:function(e){void 0===e&&(e=!0);var t,i,n,r,a,o;for(o=new Array(this.vertices.length),t=0,i=this.vertices.length;t<i;t++)o[t]=new l;if(e){var s,c,u,h=new l,d=new l;for(n=0,r=this.faces.length;n<r;n++)a=this.faces[n],s=this.vertices[a.a],c=this.vertices[a.b],u=this.vertices[a.c],h.subVectors(u,c),d.subVectors(s,c),h.cross(d),o[a.a].add(h),o[a.b].add(h),o[a.c].add(h)}else for(this.computeFaceNormals(),n=0,r=this.faces.length;n<r;n++)a=this.faces[n],o[a.a].add(a.normal),o[a.b].add(a.normal),o[a.c].add(a.normal);for(t=0,i=this.vertices.length;t<i;t++)o[t].normalize();for(n=0,r=this.faces.length;n<r;n++){a=this.faces[n];var f=a.vertexNormals;3===f.length?(f[0].copy(o[a.a]),f[1].copy(o[a.b]),f[2].copy(o[a.c])):(f[0]=o[a.a].clone(),f[1]=o[a.b].clone(),f[2]=o[a.c].clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeFlatVertexNormals:function(){var e,t,i;for(this.computeFaceNormals(),e=0,t=this.faces.length;e<t;e++){i=this.faces[e];var n=i.vertexNormals;3===n.length?(n[0].copy(i.normal),n[1].copy(i.normal),n[2].copy(i.normal)):(n[0]=i.normal.clone(),n[1]=i.normal.clone(),n[2]=i.normal.clone())}this.faces.length>0&&(this.normalsNeedUpdate=!0)},computeMorphNormals:function(){var e,t,i,n,r;for(i=0,n=this.faces.length;i<n;i++)for(r=this.faces[i],r.__originalFaceNormal?r.__originalFaceNormal.copy(r.normal):r.__originalFaceNormal=r.normal.clone(),r.__originalVertexNormals||(r.__originalVertexNormals=[]),e=0,t=r.vertexNormals.length;e<t;e++)r.__originalVertexNormals[e]?r.__originalVertexNormals[e].copy(r.vertexNormals[e]):r.__originalVertexNormals[e]=r.vertexNormals[e].clone();var a=new Le;for(a.faces=this.faces,e=0,t=this.morphTargets.length;e<t;e++){if(!this.morphNormals[e]){this.morphNormals[e]={},this.morphNormals[e].faceNormals=[],this.morphNormals[e].vertexNormals=[];var o,s,c=this.morphNormals[e].faceNormals,u=this.morphNormals[e].vertexNormals;for(i=0,n=this.faces.length;i<n;i++)o=new l,s={a:new l,b:new l,c:new l},c.push(o),u.push(s)}var h=this.morphNormals[e];a.vertices=this.morphTargets[e].vertices,a.computeFaceNormals(),a.computeVertexNormals();var o,s;for(i=0,n=this.faces.length;i<n;i++)r=this.faces[i],o=h.faceNormals[i],s=h.vertexNormals[i],o.copy(r.normal),s.a.copy(r.vertexNormals[0]),s.b.copy(r.vertexNormals[1]),s.c.copy(r.vertexNormals[2])}for(i=0,n=this.faces.length;i<n;i++)r=this.faces[i],r.normal=r.__originalFaceNormal,r.vertexNormals=r.__originalVertexNormals},computeLineDistances:function(){for(var e=0,t=this.vertices,i=0,n=t.length;i<n;i++)i>0&&(e+=t[i].distanceTo(t[i-1])),this.lineDistances[i]=e},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new $),this.boundingBox.setFromPoints(this.vertices)},computeBoundingSphere:function(){null===this.boundingSphere&&(this.boundingSphere=new ee),this.boundingSphere.setFromPoints(this.vertices)},merge:function(e,t,i){if(!1===(e&&e.isGeometry))return void console.error("THREE.Geometry.merge(): geometry not an instance of THREE.Geometry.",e);var n,r=this.vertices.length,a=this.vertices,o=e.vertices,s=this.faces,l=e.faces,c=this.faceVertexUvs[0],u=e.faceVertexUvs[0],h=this.colors,d=e.colors;void 0===i&&(i=0),void 0!==t&&(n=(new te).getNormalMatrix(t));for(var f=0,p=o.length;f<p;f++){var m=o[f],g=m.clone();void 0!==t&&g.applyMatrix4(t),a.push(g)}for(var f=0,p=d.length;f<p;f++)h.push(d[f].clone());for(f=0,p=l.length;f<p;f++){var v,y,E,x=l[f],b=x.vertexNormals,C=x.vertexColors;v=new he(x.a+r,x.b+r,x.c+r),v.normal.copy(x.normal),void 0!==n&&v.normal.applyMatrix3(n).normalize();for(var M=0,_=b.length;M<_;M++)y=b[M].clone(),void 0!==n&&y.applyMatrix3(n).normalize(),v.vertexNormals.push(y);v.color.copy(x.color);for(var M=0,_=C.length;M<_;M++)E=C[M],v.vertexColors.push(E.clone());v.materialIndex=x.materialIndex+i,s.push(v)}for(f=0,p=u.length;f<p;f++){var w=u[f],L=[];if(void 0!==w){for(var M=0,_=w.length;M<_;M++)L.push(w[M].clone());c.push(L)}}},mergeMesh:function(e){if(!1===(e&&e.isMesh))return void console.error("THREE.Geometry.mergeMesh(): mesh not an instance of THREE.Mesh.",e);e.matrixAutoUpdate&&e.updateMatrix(),this.merge(e.geometry,e.matrix)},mergeVertices:function(){var e,t,i,n,r,a,o,s,l={},c=[],u=[],h=Math.pow(10,4);for(i=0,n=this.vertices.length;i<n;i++)e=this.vertices[i],t=Math.round(e.x*h)+"_"+Math.round(e.y*h)+"_"+Math.round(e.z*h),void 0===l[t]?(l[t]=i,c.push(this.vertices[i]),u[i]=c.length-1):u[i]=u[l[t]];var d=[];for(i=0,n=this.faces.length;i<n;i++){r=this.faces[i],r.a=u[r.a],r.b=u[r.b],r.c=u[r.c],a=[r.a,r.b,r.c];for(var f=0;f<3;f++)if(a[f]===a[(f+1)%3]){d.push(i);break}}for(i=d.length-1;i>=0;i--){var p=d[i];for(this.faces.splice(p,1),o=0,s=this.faceVertexUvs.length;o<s;o++)this.faceVertexUvs[o].splice(p,1)}var m=this.vertices.length-c.length;return this.vertices=c,m},sortFacesByMaterialIndex:function(){function e(e,t){return e.materialIndex-t.materialIndex}for(var t=this.faces,i=t.length,n=0;n<i;n++)t[n]._id=n;t.sort(e);var r,a,o=this.faceVertexUvs[0],s=this.faceVertexUvs[1];o&&o.length===i&&(r=[]),s&&s.length===i&&(a=[]);for(var n=0;n<i;n++){var l=t[n]._id;r&&r.push(o[l]),a&&a.push(s[l])}r&&(this.faceVertexUvs[0]=r),a&&(this.faceVertexUvs[1]=a)},toJSON:function(){function e(e,t,i){return i?e|1<<t:e&~(1<<t)}function t(e){var t=e.x.toString()+e.y.toString()+e.z.toString();return void 0!==d[t]?d[t]:(d[t]=h.length/3,h.push(e.x,e.y,e.z),d[t])}function i(e){var t=e.r.toString()+e.g.toString()+e.b.toString();return void 0!==p[t]?p[t]:(p[t]=f.length,f.push(e.getHex()),p[t])}function n(e){var t=e.x.toString()+e.y.toString();return void 0!==g[t]?g[t]:(g[t]=m.length/2,m.push(e.x,e.y),g[t])}var r={metadata:{version:4.5,type:"Geometry",generator:"Geometry.toJSON"}};if(r.uuid=this.uuid,r.type=this.type,""!==this.name&&(r.name=this.name),void 0!==this.parameters){var a=this.parameters;for(var o in a)void 0!==a[o]&&(r[o]=a[o]);return r}for(var s=[],l=0;l<this.vertices.length;l++){var c=this.vertices[l];s.push(c.x,c.y,c.z)}for(var u=[],h=[],d={},f=[],p={},m=[],g={},l=0;l<this.faces.length;l++){var v=this.faces[l],y=void 0!==this.faceVertexUvs[0][l],E=v.normal.length()>0,x=v.vertexNormals.length>0,b=1!==v.color.r||1!==v.color.g||1!==v.color.b,C=v.vertexColors.length>0,M=0;if(M=e(M,0,0),M=e(M,1,!0),M=e(M,2,!1),M=e(M,3,y),M=e(M,4,E),M=e(M,5,x),M=e(M,6,b),M=e(M,7,C),u.push(M),u.push(v.a,v.b,v.c),u.push(v.materialIndex),y){var _=this.faceVertexUvs[0][l];u.push(n(_[0]),n(_[1]),n(_[2]))}if(E&&u.push(t(v.normal)),x){var w=v.vertexNormals;u.push(t(w[0]),t(w[1]),t(w[2]))}if(b&&u.push(i(v.color)),C){var L=v.vertexColors;u.push(i(L[0]),i(L[1]),i(L[2]))}}return r.data={},r.data.vertices=s,r.data.normals=h,f.length>0&&(r.data.colors=f),m.length>0&&(r.data.uvs=[m]),r.data.faces=u,r},clone:function(){return(new Le).copy(this)},copy:function(e){var t,i,n,r,a,o;this.vertices=[],this.colors=[],this.faces=[],this.faceVertexUvs=[[]],this.morphTargets=[],this.morphNormals=[],this.skinWeights=[],this.skinIndices=[],this.lineDistances=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var s=e.vertices;for(t=0,i=s.length;t<i;t++)this.vertices.push(s[t].clone());var l=e.colors;for(t=0,i=l.length;t<i;t++)this.colors.push(l[t].clone());var c=e.faces;for(t=0,i=c.length;t<i;t++)this.faces.push(c[t].clone());for(t=0,i=e.faceVertexUvs.length;t<i;t++){var u=e.faceVertexUvs[t];for(void 0===this.faceVertexUvs[t]&&(this.faceVertexUvs[t]=[]),n=0,r=u.length;n<r;n++){var h=u[n],d=[];for(a=0,o=h.length;a<o;a++){var f=h[a];d.push(f.clone())}this.faceVertexUvs[t].push(d)}}var p=e.morphTargets;for(t=0,i=p.length;t<i;t++){var m={};if(m.name=p[t].name,void 0!==p[t].vertices)for(m.vertices=[],n=0,r=p[t].vertices.length;n<r;n++)m.vertices.push(p[t].vertices[n].clone());if(void 0!==p[t].normals)for(m.normals=[],n=0,r=p[t].normals.length;n<r;n++)m.normals.push(p[t].normals[n].clone());this.morphTargets.push(m)}var g=e.morphNormals;for(t=0,i=g.length;t<i;t++){var v={};if(void 0!==g[t].vertexNormals)for(v.vertexNormals=[],n=0,r=g[t].vertexNormals.length;n<r;n++){var y=g[t].vertexNormals[n],E={};E.a=y.a.clone(),E.b=y.b.clone(),E.c=y.c.clone(),v.vertexNormals.push(E)}if(void 0!==g[t].faceNormals)for(v.faceNormals=[],n=0,r=g[t].faceNormals.length;n<r;n++)v.faceNormals.push(g[t].faceNormals[n].clone());this.morphNormals.push(v)}var x=e.skinWeights;for(t=0,i=x.length;t<i;t++)this.skinWeights.push(x[t].clone());var b=e.skinIndices;for(t=0,i=b.length;t<i;t++)this.skinIndices.push(b[t].clone());var C=e.lineDistances;for(t=0,i=C.length;t<i;t++)this.lineDistances.push(C[t]);var M=e.boundingBox;null!==M&&(this.boundingBox=M.clone());var _=e.boundingSphere;return null!==_&&(this.boundingSphere=_.clone()),this.elementsNeedUpdate=e.elementsNeedUpdate,this.verticesNeedUpdate=e.verticesNeedUpdate,this.uvsNeedUpdate=e.uvsNeedUpdate,this.normalsNeedUpdate=e.normalsNeedUpdate,this.colorsNeedUpdate=e.colorsNeedUpdate,this.lineDistancesNeedUpdate=e.lineDistancesNeedUpdate,this.groupsNeedUpdate=e.groupsNeedUpdate,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Te.MaxIndex=65535,Object.assign(Te.prototype,t.prototype,{isBufferGeometry:!0,getIndex:function(){return this.index},setIndex:function(e){Array.isArray(e)?this.index=new(_e(e)>65535?xe:ye)(e,1):this.index=e},addAttribute:function(e,t){return!1===(t&&t.isBufferAttribute)&&!1===(t&&t.isInterleavedBufferAttribute)?(console.warn("THREE.BufferGeometry: .addAttribute() now expects ( name, attribute )."),void this.addAttribute(e,new fe(arguments[1],arguments[2]))):"index"===e?(console.warn("THREE.BufferGeometry.addAttribute: Use .setIndex() for index attribute."),void this.setIndex(t)):(this.attributes[e]=t,this)},getAttribute:function(e){return this.attributes[e]},removeAttribute:function(e){return delete this.attributes[e],this},addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:void 0!==i?i:0})},clearGroups:function(){this.groups=[]},setDrawRange:function(e,t){this.drawRange.start=e,this.drawRange.count=t},applyMatrix:function(e){var t=this.attributes.position;void 0!==t&&(e.applyToBufferAttribute(t),t.needsUpdate=!0);var i=this.attributes.normal;if(void 0!==i){(new te).getNormalMatrix(e).applyToBufferAttribute(i),i.needsUpdate=!0}return null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},rotateX:function(){var e=new c;return function(t){return e.makeRotationX(t),this.applyMatrix(e),this}}(),rotateY:function(){var e=new c;return function(t){return e.makeRotationY(t),this.applyMatrix(e),this}}(),rotateZ:function(){var e=new c;return function(t){return e.makeRotationZ(t),this.applyMatrix(e),this}}(),translate:function(){var e=new c;return function(t,i,n){return e.makeTranslation(t,i,n),this.applyMatrix(e),this}}(),scale:function(){var e=new c;return function(t,i,n){return e.makeScale(t,i,n),this.applyMatrix(e),this}}(),lookAt:function(){var e=new le;return function(t){e.lookAt(t),e.updateMatrix(),this.applyMatrix(e.matrix)}}(),center:function(){this.computeBoundingBox();var e=this.boundingBox.getCenter().negate();return this.translate(e.x,e.y,e.z),e},setFromObject:function(e){var t=e.geometry;if(e.isPoints||e.isLine){var i=new be(3*t.vertices.length,3),n=new be(3*t.colors.length,3);if(this.addAttribute("position",i.copyVector3sArray(t.vertices)),this.addAttribute("color",n.copyColorsArray(t.colors)),t.lineDistances&&t.lineDistances.length===t.vertices.length){
var r=new be(t.lineDistances.length,1);this.addAttribute("lineDistance",r.copyArray(t.lineDistances))}null!==t.boundingSphere&&(this.boundingSphere=t.boundingSphere.clone()),null!==t.boundingBox&&(this.boundingBox=t.boundingBox.clone())}else e.isMesh&&t&&t.isGeometry&&this.fromGeometry(t);return this},updateFromObject:function(e){var t=e.geometry;if(e.isMesh){var i=t.__directGeometry;if(!0===t.elementsNeedUpdate&&(i=void 0,t.elementsNeedUpdate=!1),void 0===i)return this.fromGeometry(t);i.verticesNeedUpdate=t.verticesNeedUpdate,i.normalsNeedUpdate=t.normalsNeedUpdate,i.colorsNeedUpdate=t.colorsNeedUpdate,i.uvsNeedUpdate=t.uvsNeedUpdate,i.groupsNeedUpdate=t.groupsNeedUpdate,t.verticesNeedUpdate=!1,t.normalsNeedUpdate=!1,t.colorsNeedUpdate=!1,t.uvsNeedUpdate=!1,t.groupsNeedUpdate=!1,t=i}var n;return!0===t.verticesNeedUpdate&&(n=this.attributes.position,void 0!==n&&(n.copyVector3sArray(t.vertices),n.needsUpdate=!0),t.verticesNeedUpdate=!1),!0===t.normalsNeedUpdate&&(n=this.attributes.normal,void 0!==n&&(n.copyVector3sArray(t.normals),n.needsUpdate=!0),t.normalsNeedUpdate=!1),!0===t.colorsNeedUpdate&&(n=this.attributes.color,void 0!==n&&(n.copyColorsArray(t.colors),n.needsUpdate=!0),t.colorsNeedUpdate=!1),t.uvsNeedUpdate&&(n=this.attributes.uv,void 0!==n&&(n.copyVector2sArray(t.uvs),n.needsUpdate=!0),t.uvsNeedUpdate=!1),t.lineDistancesNeedUpdate&&(n=this.attributes.lineDistance,void 0!==n&&(n.copyArray(t.lineDistances),n.needsUpdate=!0),t.lineDistancesNeedUpdate=!1),t.groupsNeedUpdate&&(t.computeGroups(e.geometry),this.groups=t.groups,t.groupsNeedUpdate=!1),this},fromGeometry:function(e){return e.__directGeometry=(new Me).fromGeometry(e),this.fromDirectGeometry(e.__directGeometry)},fromDirectGeometry:function(e){var t=new Float32Array(3*e.vertices.length);if(this.addAttribute("position",new fe(t,3).copyVector3sArray(e.vertices)),e.normals.length>0){var i=new Float32Array(3*e.normals.length);this.addAttribute("normal",new fe(i,3).copyVector3sArray(e.normals))}if(e.colors.length>0){var n=new Float32Array(3*e.colors.length);this.addAttribute("color",new fe(n,3).copyColorsArray(e.colors))}if(e.uvs.length>0){var r=new Float32Array(2*e.uvs.length);this.addAttribute("uv",new fe(r,2).copyVector2sArray(e.uvs))}if(e.uvs2.length>0){var a=new Float32Array(2*e.uvs2.length);this.addAttribute("uv2",new fe(a,2).copyVector2sArray(e.uvs2))}if(e.indices.length>0){var o=_e(e.indices)>65535?Uint32Array:Uint16Array,s=new o(3*e.indices.length);this.setIndex(new fe(s,1).copyIndicesArray(e.indices))}this.groups=e.groups;for(var l in e.morphTargets){for(var c=[],u=e.morphTargets[l],h=0,d=u.length;h<d;h++){var f=u[h],p=new be(3*f.length,3);c.push(p.copyVector3sArray(f))}this.morphAttributes[l]=c}if(e.skinIndices.length>0){var m=new be(4*e.skinIndices.length,4);this.addAttribute("skinIndex",m.copyVector4sArray(e.skinIndices))}if(e.skinWeights.length>0){var g=new be(4*e.skinWeights.length,4);this.addAttribute("skinWeight",g.copyVector4sArray(e.skinWeights))}return null!==e.boundingSphere&&(this.boundingSphere=e.boundingSphere.clone()),null!==e.boundingBox&&(this.boundingBox=e.boundingBox.clone()),this},computeBoundingBox:function(){null===this.boundingBox&&(this.boundingBox=new $);var e=this.attributes.position;void 0!==e?this.boundingBox.setFromBufferAttribute(e):this.boundingBox.makeEmpty(),(isNaN(this.boundingBox.min.x)||isNaN(this.boundingBox.min.y)||isNaN(this.boundingBox.min.z))&&console.error('THREE.BufferGeometry.computeBoundingBox: Computed min/max have NaN values. The "position" attribute is likely to have NaN values.',this)},computeBoundingSphere:function(){var e=new $,t=new l;return function(){null===this.boundingSphere&&(this.boundingSphere=new ee);var i=this.attributes.position;if(i){var n=this.boundingSphere.center;e.setFromBufferAttribute(i),e.getCenter(n);for(var r=0,a=0,o=i.count;a<o;a++)t.x=i.getX(a),t.y=i.getY(a),t.z=i.getZ(a),r=Math.max(r,n.distanceToSquared(t));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error('THREE.BufferGeometry.computeBoundingSphere(): Computed radius is NaN. The "position" attribute is likely to have NaN values.',this)}}}(),computeFaceNormals:function(){},computeVertexNormals:function(){var e=this.index,t=this.attributes,i=this.groups;if(t.position){var n=t.position.array;if(void 0===t.normal)this.addAttribute("normal",new fe(new Float32Array(n.length),3));else for(var r=t.normal.array,a=0,o=r.length;a<o;a++)r[a]=0;var s,c,u,h=t.normal.array,d=new l,f=new l,p=new l,m=new l,g=new l;if(e){var v=e.array;0===i.length&&this.addGroup(0,v.length);for(var y=0,E=i.length;y<E;++y)for(var x=i[y],b=x.start,C=x.count,a=b,o=b+C;a<o;a+=3)s=3*v[a+0],c=3*v[a+1],u=3*v[a+2],d.fromArray(n,s),f.fromArray(n,c),p.fromArray(n,u),m.subVectors(p,f),g.subVectors(d,f),m.cross(g),h[s]+=m.x,h[s+1]+=m.y,h[s+2]+=m.z,h[c]+=m.x,h[c+1]+=m.y,h[c+2]+=m.z,h[u]+=m.x,h[u+1]+=m.y,h[u+2]+=m.z}else for(var a=0,o=n.length;a<o;a+=9)d.fromArray(n,a),f.fromArray(n,a+3),p.fromArray(n,a+6),m.subVectors(p,f),g.subVectors(d,f),m.cross(g),h[a]=m.x,h[a+1]=m.y,h[a+2]=m.z,h[a+3]=m.x,h[a+4]=m.y,h[a+5]=m.z,h[a+6]=m.x,h[a+7]=m.y,h[a+8]=m.z;this.normalizeNormals(),t.normal.needsUpdate=!0}},merge:function(e,t){if(!1===(e&&e.isBufferGeometry))return void console.error("THREE.BufferGeometry.merge(): geometry not an instance of THREE.BufferGeometry.",e);void 0===t&&(t=0);var i=this.attributes;for(var n in i)if(void 0!==e.attributes[n])for(var r=i[n],a=r.array,o=e.attributes[n],s=o.array,l=o.itemSize,c=0,u=l*t;c<s.length;c++,u++)a[u]=s[c];return this},normalizeNormals:function(){for(var e,t,i,n,r=this.attributes.normal,a=0,o=r.count;a<o;a++)e=r.getX(a),t=r.getY(a),i=r.getZ(a),n=1/Math.sqrt(e*e+t*t+i*i),r.setXYZ(a,e*n,t*n,i*n)},toNonIndexed:function(){if(null===this.index)return console.warn("THREE.BufferGeometry.toNonIndexed(): Geometry is already non-indexed."),this;var e=new Te,t=this.index.array,i=this.attributes;for(var n in i){for(var r=i[n],a=r.array,o=r.itemSize,s=new a.constructor(t.length*o),l=0,c=0,u=0,h=t.length;u<h;u++){l=t[u]*o;for(var d=0;d<o;d++)s[c++]=a[l++]}e.addAttribute(n,new fe(s,o))}return e},toJSON:function(){var e={metadata:{version:4.5,type:"BufferGeometry",generator:"BufferGeometry.toJSON"}};if(e.uuid=this.uuid,e.type=this.type,""!==this.name&&(e.name=this.name),void 0!==this.parameters){var t=this.parameters;for(var i in t)void 0!==t[i]&&(e[i]=t[i]);return e}e.data={attributes:{}};var n=this.index;if(null!==n){var r=Array.prototype.slice.call(n.array);e.data.index={type:n.array.constructor.name,array:r}}var a=this.attributes;for(var i in a){var o=a[i],r=Array.prototype.slice.call(o.array);e.data.attributes[i]={itemSize:o.itemSize,type:o.array.constructor.name,array:r,normalized:o.normalized}}var s=this.groups;s.length>0&&(e.data.groups=JSON.parse(JSON.stringify(s)));var l=this.boundingSphere;return null!==l&&(e.data.boundingSphere={center:l.center.toArray(),radius:l.radius}),e},clone:function(){return(new Te).copy(this)},copy:function(e){var t,i,n;this.index=null,this.attributes={},this.morphAttributes={},this.groups=[],this.boundingBox=null,this.boundingSphere=null,this.name=e.name;var r=e.index;null!==r&&this.setIndex(r.clone());var a=e.attributes;for(t in a){var o=a[t];this.addAttribute(t,o.clone())}var s=e.morphAttributes;for(t in s){var l=[],c=s[t];for(i=0,n=c.length;i<n;i++)l.push(c[i].clone());this.morphAttributes[t]=l}var u=e.groups;for(i=0,n=u.length;i<n;i++){var h=u[i];this.addGroup(h.start,h.count,h.materialIndex)}var d=e.boundingBox;null!==d&&(this.boundingBox=d.clone());var f=e.boundingSphere;return null!==f&&(this.boundingSphere=f.clone()),this.drawRange.start=e.drawRange.start,this.drawRange.count=e.drawRange.count,this},dispose:function(){this.dispatchEvent({type:"dispose"})}}),Ie.prototype=Object.assign(Object.create(le.prototype),{constructor:Ie,isMesh:!0,setDrawMode:function(e){this.drawMode=e},copy:function(e){return le.prototype.copy.call(this,e),this.drawMode=e.drawMode,this},updateMorphTargets:function(){var e=this.geometry.morphTargets;if(void 0!==e&&e.length>0){this.morphTargetInfluences=[],this.morphTargetDictionary={};for(var t=0,i=e.length;t<i;t++)this.morphTargetInfluences.push(0),this.morphTargetDictionary[e[t].name]=t}},raycast:function(){function e(e,t,i,n,r,a,o){return ue.barycoordFromPoint(e,t,i,n,y),r.multiplyScalar(y.x),a.multiplyScalar(y.y),o.multiplyScalar(y.z),r.add(a).add(o),r.clone()}function t(e,t,i,n,r,a,o){var s=e.material;if(null===(s.side===pa?i.intersectTriangle(a,r,n,!0,o):i.intersectTriangle(n,r,a,s.side!==ma,o)))return null;x.copy(o),x.applyMatrix4(e.matrixWorld);var l=t.ray.origin.distanceTo(x);return l<t.near||l>t.far?null:{distance:l,point:x.clone(),object:e}}function n(i,n,r,a,o,l,c,d){s.fromBufferAttribute(a,l),u.fromBufferAttribute(a,c),h.fromBufferAttribute(a,d);var f=t(i,n,r,s,u,h,E);return f&&(o&&(m.fromBufferAttribute(o,l),g.fromBufferAttribute(o,c),v.fromBufferAttribute(o,d),f.uv=e(E,s,u,h,m,g,v)),f.face=new he(l,c,d,ue.normal(s,u,h)),f.faceIndex=l),f}var r=new c,a=new ae,o=new ee,s=new l,u=new l,h=new l,d=new l,f=new l,p=new l,m=new i,g=new i,v=new i,y=new l,E=new l,x=new l;return function(i,l){var c=this.geometry,y=this.material,x=this.matrixWorld;if(void 0!==y&&(null===c.boundingSphere&&c.computeBoundingSphere(),o.copy(c.boundingSphere),o.applyMatrix4(x),!1!==i.ray.intersectsSphere(o)&&(r.getInverse(x),a.copy(i.ray).applyMatrix4(r),null===c.boundingBox||!1!==a.intersectsBox(c.boundingBox)))){var b;if(c.isBufferGeometry){var C,M,_,w,L,T=c.index,I=c.attributes.position,S=c.attributes.uv;if(null!==T)for(w=0,L=T.count;w<L;w+=3)C=T.getX(w),M=T.getX(w+1),_=T.getX(w+2),(b=n(this,i,a,I,S,C,M,_))&&(b.faceIndex=Math.floor(w/3),l.push(b));else for(w=0,L=I.count;w<L;w+=3)C=w,M=w+1,_=w+2,(b=n(this,i,a,I,S,C,M,_))&&(b.index=C,l.push(b))}else if(c.isGeometry){var O,D,R,A,U=Array.isArray(y),B=c.vertices,P=c.faces,N=c.faceVertexUvs[0];N.length>0&&(A=N);for(var k=0,F=P.length;k<F;k++){var H=P[k],G=U?y[H.materialIndex]:y;if(void 0!==G){if(O=B[H.a],D=B[H.b],R=B[H.c],!0===G.morphTargets){var V=c.morphTargets,z=this.morphTargetInfluences;s.set(0,0,0),u.set(0,0,0),h.set(0,0,0);for(var W=0,q=V.length;W<q;W++){var j=z[W];if(0!==j){var X=V[W].vertices;s.addScaledVector(d.subVectors(X[H.a],O),j),u.addScaledVector(f.subVectors(X[H.b],D),j),h.addScaledVector(p.subVectors(X[H.c],R),j)}}s.add(O),u.add(D),h.add(R),O=s,D=u,R=h}if(b=t(this,i,a,O,D,R,E)){if(A&&A[k]){var Y=A[k];m.copy(Y[0]),g.copy(Y[1]),v.copy(Y[2]),b.uv=e(E,O,D,R,m,g,v)}b.face=H,b.faceIndex=k,l.push(b)}}}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Se.prototype=Object.create(Le.prototype),Se.prototype.constructor=Se,Oe.prototype=Object.create(Te.prototype),Oe.prototype.constructor=Oe,De.prototype=Object.create(Le.prototype),De.prototype.constructor=De,Re.prototype=Object.create(Te.prototype),Re.prototype.constructor=Re,Ae.prototype=Object.assign(Object.create(le.prototype),{constructor:Ae,isCamera:!0,copy:function(e){return le.prototype.copy.call(this,e),this.matrixWorldInverse.copy(e.matrixWorldInverse),this.projectionMatrix.copy(e.projectionMatrix),this},getWorldDirection:function(){var e=new s;return function(t){var i=t||new l;return this.getWorldQuaternion(e),i.set(0,0,-1).applyQuaternion(e)}}(),clone:function(){return(new this.constructor).copy(this)}}),Ue.prototype=Object.assign(Object.create(Ae.prototype),{constructor:Ue,isPerspectiveCamera:!0,copy:function(e){return Ae.prototype.copy.call(this,e),this.fov=e.fov,this.zoom=e.zoom,this.near=e.near,this.far=e.far,this.focus=e.focus,this.aspect=e.aspect,this.view=null===e.view?null:Object.assign({},e.view),this.filmGauge=e.filmGauge,this.filmOffset=e.filmOffset,this},setFocalLength:function(e){var t=.5*this.getFilmHeight()/e;this.fov=2*hs.RAD2DEG*Math.atan(t),this.updateProjectionMatrix()},getFocalLength:function(){var e=Math.tan(.5*hs.DEG2RAD*this.fov);return.5*this.getFilmHeight()/e},getEffectiveFOV:function(){return 2*hs.RAD2DEG*Math.atan(Math.tan(.5*hs.DEG2RAD*this.fov)/this.zoom)},getFilmWidth:function(){return this.filmGauge*Math.min(this.aspect,1)},getFilmHeight:function(){return this.filmGauge/Math.max(this.aspect,1)},setViewOffset:function(e,t,i,n,r,a){this.aspect=e/t,this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:n,width:r,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=this.near,t=e*Math.tan(.5*hs.DEG2RAD*this.fov)/this.zoom,i=2*t,n=this.aspect*i,r=-.5*n,a=this.view;if(null!==a){var o=a.fullWidth,s=a.fullHeight;r+=a.offsetX*n/o,t-=a.offsetY*i/s,n*=a.width/o,i*=a.height/s}var l=this.filmOffset;0!==l&&(r+=e*l/this.getFilmWidth()),this.projectionMatrix.makePerspective(r,r+n,t,t-i,e,this.far)},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.fov=this.fov,t.object.zoom=this.zoom,t.object.near=this.near,t.object.far=this.far,t.object.focus=this.focus,t.object.aspect=this.aspect,null!==this.view&&(t.object.view=Object.assign({},this.view)),t.object.filmGauge=this.filmGauge,t.object.filmOffset=this.filmOffset,t}}),Be.prototype=Object.assign(Object.create(Ae.prototype),{constructor:Be,isOrthographicCamera:!0,copy:function(e){return Ae.prototype.copy.call(this,e),this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.near=e.near,this.far=e.far,this.zoom=e.zoom,this.view=null===e.view?null:Object.assign({},e.view),this},setViewOffset:function(e,t,i,n,r,a){this.view={fullWidth:e,fullHeight:t,offsetX:i,offsetY:n,width:r,height:a},this.updateProjectionMatrix()},clearViewOffset:function(){this.view=null,this.updateProjectionMatrix()},updateProjectionMatrix:function(){var e=(this.right-this.left)/(2*this.zoom),t=(this.top-this.bottom)/(2*this.zoom),i=(this.right+this.left)/2,n=(this.top+this.bottom)/2,r=i-e,a=i+e,o=n+t,s=n-t;if(null!==this.view){var l=this.zoom/(this.view.width/this.view.fullWidth),c=this.zoom/(this.view.height/this.view.fullHeight),u=(this.right-this.left)/this.view.width,h=(this.top-this.bottom)/this.view.height;r+=u*(this.view.offsetX/l),a=r+u*(this.view.width/l),o-=h*(this.view.offsetY/c),s=o-h*(this.view.height/c)}this.projectionMatrix.makeOrthographic(r,a,o,s,this.near,this.far)},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.zoom=this.zoom,t.object.left=this.left,t.object.right=this.right,t.object.top=this.top,t.object.bottom=this.bottom,t.object.near=this.near,t.object.far=this.far,null!==this.view&&(t.object.view=Object.assign({},this.view)),t}});var Is=0;pt.prototype.isFogExp2=!0,pt.prototype.clone=function(){return new pt(this.color.getHex(),this.density)},pt.prototype.toJSON=function(e){return{type:"FogExp2",color:this.color.getHex(),density:this.density}},mt.prototype.isFog=!0,mt.prototype.clone=function(){return new mt(this.color.getHex(),this.near,this.far)},mt.prototype.toJSON=function(e){return{type:"Fog",color:this.color.getHex(),near:this.near,far:this.far}},gt.prototype=Object.assign(Object.create(le.prototype),{constructor:gt,copy:function(e,t){return le.prototype.copy.call(this,e,t),null!==e.background&&(this.background=e.background.clone()),null!==e.fog&&(this.fog=e.fog.clone()),null!==e.overrideMaterial&&(this.overrideMaterial=e.overrideMaterial.clone()),this.autoUpdate=e.autoUpdate,this.matrixAutoUpdate=e.matrixAutoUpdate,this},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return null!==this.background&&(t.object.background=this.background.toJSON(e)),null!==this.fog&&(t.object.fog=this.fog.toJSON()),t}}),vt.prototype=Object.assign(Object.create(le.prototype),{constructor:vt,isLensFlare:!0,copy:function(e){le.prototype.copy.call(this,e),this.positionScreen.copy(e.positionScreen),this.customUpdateCallback=e.customUpdateCallback;for(var t=0,i=e.lensFlares.length;t<i;t++)this.lensFlares.push(e.lensFlares[t]);return this},add:function(e,t,i,n,r,a){void 0===t&&(t=-1),void 0===i&&(i=0),void 0===a&&(a=1),void 0===r&&(r=new j(16777215)),void 0===n&&(n=Ca),i=Math.min(i,Math.max(0,i)),this.lensFlares.push({texture:e,size:t,distance:i,x:0,y:0,z:0,scale:1,rotation:0,opacity:a,color:r,blending:n})},updateLensFlares:function(){var e,t,i=this.lensFlares.length,n=2*-this.positionScreen.x,r=2*-this.positionScreen.y;for(e=0;e<i;e++)t=this.lensFlares[e],t.x=this.positionScreen.x+n*t.distance,t.y=this.positionScreen.y+r*t.distance,t.wantedRotation=t.x*Math.PI*.25,t.rotation+=.25*(t.wantedRotation-t.rotation)}}),yt.prototype=Object.create(K.prototype),yt.prototype.constructor=yt,yt.prototype.isSpriteMaterial=!0,yt.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.rotation=e.rotation,this},Et.prototype=Object.assign(Object.create(le.prototype),{constructor:Et,isSprite:!0,raycast:function(){var e=new l,t=new l,i=new l;return function(n,r){t.setFromMatrixPosition(this.matrixWorld),n.ray.closestPointToPoint(t,e),i.setFromMatrixScale(this.matrixWorld);var a=i.x*i.y/4;if(!(t.distanceToSquared(e)>a)){var o=n.ray.origin.distanceTo(e);o<n.near||o>n.far||r.push({distance:o,point:e.clone(),face:null,object:this})}}}(),clone:function(){return new this.constructor(this.material).copy(this)}}),xt.prototype=Object.assign(Object.create(le.prototype),{constructor:xt,copy:function(e){le.prototype.copy.call(this,e,!1);for(var t=e.levels,i=0,n=t.length;i<n;i++){var r=t[i];this.addLevel(r.object.clone(),r.distance)}return this},addLevel:function(e,t){void 0===t&&(t=0),t=Math.abs(t);for(var i=this.levels,n=0;n<i.length&&!(t<i[n].distance);n++);i.splice(n,0,{distance:t,object:e}),this.add(e)},getObjectForDistance:function(e){for(var t=this.levels,i=1,n=t.length;i<n&&!(e<t[i].distance);i++);return t[i-1].object},raycast:function(){var e=new l;return function(t,i){e.setFromMatrixPosition(this.matrixWorld);var n=t.ray.origin.distanceTo(e);this.getObjectForDistance(n).raycast(t,i)}}(),update:function(){var e=new l,t=new l;return function(i){var n=this.levels;if(n.length>1){e.setFromMatrixPosition(i.matrixWorld),t.setFromMatrixPosition(this.matrixWorld);var r=e.distanceTo(t);n[0].object.visible=!0;for(var a=1,o=n.length;a<o&&r>=n[a].distance;a++)n[a-1].object.visible=!1,n[a].object.visible=!0;for(;a<o;a++)n[a].object.visible=!1}}}(),toJSON:function(e){var t=le.prototype.toJSON.call(this,e);t.object.levels=[];for(var i=this.levels,n=0,r=i.length;n<r;n++){var a=i[n];t.object.levels.push({object:a.object.uuid,distance:a.distance})}return t}}),Object.assign(bt.prototype,{calculateInverses:function(){this.boneInverses=[];for(var e=0,t=this.bones.length;e<t;e++){var i=new c;this.bones[e]&&i.getInverse(this.bones[e].matrixWorld),this.boneInverses.push(i)}},pose:function(){var e,t,i;for(t=0,i=this.bones.length;t<i;t++)(e=this.bones[t])&&e.matrixWorld.getInverse(this.boneInverses[t]);for(t=0,i=this.bones.length;t<i;t++)(e=this.bones[t])&&(e.parent&&e.parent.isBone?(e.matrix.getInverse(e.parent.matrixWorld),e.matrix.multiply(e.matrixWorld)):e.matrix.copy(e.matrixWorld),e.matrix.decompose(e.position,e.quaternion,e.scale))},update:function(){var e=new c,t=new c;return function(){for(var i=this.bones,n=this.boneInverses,r=this.boneMatrices,a=this.boneTexture,o=0,s=i.length;o<s;o++){var l=i[o]?i[o].matrixWorld:t;e.multiplyMatrices(l,n[o]),e.toArray(r,16*o)}void 0!==a&&(a.needsUpdate=!0)}}(),clone:function(){return new bt(this.bones,this.boneInverses)}}),Ct.prototype=Object.assign(Object.create(le.prototype),{constructor:Ct,isBone:!0}),Mt.prototype=Object.assign(Object.create(Ie.prototype),{constructor:Mt,isSkinnedMesh:!0,initBones:function(){var e,t,i,n,r=[];if(this.geometry&&void 0!==this.geometry.bones){for(i=0,n=this.geometry.bones.length;i<n;i++)t=this.geometry.bones[i],e=new Ct,r.push(e),e.name=t.name,e.position.fromArray(t.pos),e.quaternion.fromArray(t.rotq),void 0!==t.scl&&e.scale.fromArray(t.scl);for(i=0,n=this.geometry.bones.length;i<n;i++)t=this.geometry.bones[i],-1!==t.parent&&null!==t.parent&&void 0!==r[t.parent]?r[t.parent].add(r[i]):this.add(r[i])}return this.updateMatrixWorld(!0),r},bind:function(e,t){this.skeleton=e,void 0===t&&(this.updateMatrixWorld(!0),this.skeleton.calculateInverses(),t=this.matrixWorld),this.bindMatrix.copy(t),this.bindMatrixInverse.getInverse(t)},pose:function(){this.skeleton.pose()},normalizeSkinWeights:function(){var e,t;if(this.geometry&&this.geometry.isGeometry)for(t=0;t<this.geometry.skinWeights.length;t++){var i=this.geometry.skinWeights[t];e=1/i.lengthManhattan(),e!==1/0?i.multiplyScalar(e):i.set(1,0,0,0)}else if(this.geometry&&this.geometry.isBufferGeometry){var n=new r,a=this.geometry.attributes.skinWeight;for(t=0;t<a.count;t++)n.x=a.getX(t),n.y=a.getY(t),n.z=a.getZ(t),n.w=a.getW(t),e=1/n.lengthManhattan(),e!==1/0?n.multiplyScalar(e):n.set(1,0,0,0),a.setXYZW(t,n.x,n.y,n.z,n.w)}},updateMatrixWorld:function(e){Ie.prototype.updateMatrixWorld.call(this,e),"attached"===this.bindMode?this.bindMatrixInverse.getInverse(this.matrixWorld):"detached"===this.bindMode?this.bindMatrixInverse.getInverse(this.bindMatrix):console.warn("THREE.SkinnedMesh: Unrecognized bindMode: "+this.bindMode)},clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),_t.prototype=Object.create(K.prototype),_t.prototype.constructor=_t,_t.prototype.isLineBasicMaterial=!0,_t.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.linecap=e.linecap,this.linejoin=e.linejoin,this},wt.prototype=Object.assign(Object.create(le.prototype),{constructor:wt,isLine:!0,raycast:function(){var e=new c,t=new ae,i=new ee;return function(n,r){var a=n.linePrecision,o=a*a,s=this.geometry,c=this.matrixWorld;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(c),!1!==n.ray.intersectsSphere(i)){e.getInverse(c),t.copy(n.ray).applyMatrix4(e);var u=new l,h=new l,d=new l,f=new l,p=this&&this.isLineSegments?2:1;if(s.isBufferGeometry){var m=s.index,g=s.attributes,v=g.position.array;if(null!==m)for(var y=m.array,E=0,x=y.length-1;E<x;E+=p){var b=y[E],C=y[E+1];u.fromArray(v,3*b),h.fromArray(v,3*C);var M=t.distanceSqToSegment(u,h,f,d);if(!(M>o)){f.applyMatrix4(this.matrixWorld);var _=n.ray.origin.distanceTo(f);_<n.near||_>n.far||r.push({distance:_,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}else for(var E=0,x=v.length/3-1;E<x;E+=p){u.fromArray(v,3*E),h.fromArray(v,3*E+3);var M=t.distanceSqToSegment(u,h,f,d);if(!(M>o)){f.applyMatrix4(this.matrixWorld);var _=n.ray.origin.distanceTo(f);_<n.near||_>n.far||r.push({distance:_,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}}else if(s.isGeometry)for(var w=s.vertices,L=w.length,E=0;E<L-1;E+=p){var M=t.distanceSqToSegment(w[E],w[E+1],f,d);if(!(M>o)){f.applyMatrix4(this.matrixWorld);var _=n.ray.origin.distanceTo(f);_<n.near||_>n.far||r.push({distance:_,point:d.clone().applyMatrix4(this.matrixWorld),index:E,face:null,faceIndex:null,object:this})}}}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Lt.prototype=Object.assign(Object.create(wt.prototype),{constructor:Lt,isLineSegments:!0}),Tt.prototype=Object.assign(Object.create(wt.prototype),{constructor:Tt,isLineLoop:!0}),It.prototype=Object.create(K.prototype),It.prototype.constructor=It,It.prototype.isPointsMaterial=!0,It.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.size=e.size,this.sizeAttenuation=e.sizeAttenuation,this.positionOffset=e.positionOffset,this.sizeAttribute=e.sizeAttribute,this},St.prototype=Object.assign(Object.create(le.prototype),{constructor:St,isPoints:!0,raycast:function(){var e=new c,t=new ae,i=new ee;return function(n,r){function a(e,i){var a=t.distanceSqToPoint(e);if(a<d){var s=t.closestPointToPoint(e);s.applyMatrix4(c);var l=n.ray.origin.distanceTo(s);if(l<n.near||l>n.far)return;r.push({distance:l,distanceToRay:Math.sqrt(a),point:s.clone(),index:i,face:null,object:o})}}var o=this,s=this.geometry,c=this.matrixWorld,u=n.params.Points.threshold;if(null===s.boundingSphere&&s.computeBoundingSphere(),i.copy(s.boundingSphere),i.applyMatrix4(c),i.radius+=u,!1!==n.ray.intersectsSphere(i)){e.getInverse(c),t.copy(n.ray).applyMatrix4(e);var h=u/((this.scale.x+this.scale.y+this.scale.z)/3),d=h*h,f=new l;if(s.isBufferGeometry){var p=s.index,m=s.attributes,g=m.position.array;if(null!==p)for(var v=p.array,y=0,E=v.length;y<E;y++){var x=v[y];f.fromArray(g,3*x),a(f,x)}else for(var y=0,b=g.length/3;y<b;y++)f.fromArray(g,3*y),a(f,y)}else for(var C=s.vertices,y=0,b=C.length;y<b;y++)a(C[y],y)}}}(),clone:function(){return new this.constructor(this.geometry,this.material).copy(this)}}),Ot.prototype=Object.assign(Object.create(le.prototype),{constructor:Ot}),Dt.prototype=Object.create(n.prototype),Dt.prototype.constructor=Dt,Rt.prototype=Object.create(n.prototype),Rt.prototype.constructor=Rt,Rt.prototype.isCompressedTexture=!0,At.prototype=Object.create(n.prototype),At.prototype.constructor=At,Ut.prototype=Object.create(n.prototype),Ut.prototype.constructor=Ut,Ut.prototype.isDepthTexture=!0,Bt.prototype=Object.create(Te.prototype),Bt.prototype.constructor=Bt,Pt.prototype=Object.create(Le.prototype),Pt.prototype.constructor=Pt,Nt.prototype=Object.create(Te.prototype),Nt.prototype.constructor=Nt,kt.prototype=Object.create(Le.prototype),kt.prototype.constructor=kt,Ft.prototype=Object.create(Te.prototype),Ft.prototype.constructor=Ft,Ht.prototype=Object.create(Le.prototype),Ht.prototype.constructor=Ht,Gt.prototype=Object.create(Ft.prototype),Gt.prototype.constructor=Gt,Vt.prototype=Object.create(Le.prototype),Vt.prototype.constructor=Vt,zt.prototype=Object.create(Ft.prototype),zt.prototype.constructor=zt,Wt.prototype=Object.create(Le.prototype),Wt.prototype.constructor=Wt,qt.prototype=Object.create(Ft.prototype),qt.prototype.constructor=qt,jt.prototype=Object.create(Le.prototype),jt.prototype.constructor=jt,Xt.prototype=Object.create(Ft.prototype),Xt.prototype.constructor=Xt,Yt.prototype=Object.create(Le.prototype),Yt.prototype.constructor=Yt,Zt.prototype=Object.create(Te.prototype),Zt.prototype.constructor=Zt,Kt.prototype=Object.create(Le.prototype),Kt.prototype.constructor=Kt,Qt.prototype=Object.create(Te.prototype),Qt.prototype.constructor=Qt,Jt.prototype=Object.create(Le.prototype),Jt.prototype.constructor=Jt,$t.prototype=Object.create(Te.prototype),$t.prototype.constructor=$t;var Ss={area:function(e){for(var t=e.length,i=0,n=t-1,r=0;r<t;n=r++)i+=e[n].x*e[r].y-e[r].x*e[n].y;return.5*i},triangulate:function(){function e(e,t,i,n,r,a){var o,s,l,c,u,h,d,f,p;if(s=e[a[t]].x,l=e[a[t]].y,c=e[a[i]].x,u=e[a[i]].y,h=e[a[n]].x,d=e[a[n]].y,(c-s)*(d-l)-(u-l)*(h-s)<=0)return!1;var m,g,v,y,E,x,b,C,M,_,w,L,T,I,S;for(m=h-c,g=d-u,v=s-h,y=l-d,E=c-s,x=u-l,o=0;o<r;o++)if(f=e[a[o]].x,p=e[a[o]].y,!(f===s&&p===l||f===c&&p===u||f===h&&p===d)&&(b=f-s,C=p-l,M=f-c,_=p-u,w=f-h,L=p-d,S=m*_-g*M,T=E*C-x*b,I=v*L-y*w,S>=-Number.EPSILON&&I>=-Number.EPSILON&&T>=-Number.EPSILON))return!1;return!0}return function(t,i){var n=t.length;if(n<3)return null;var r,a,o,s=[],l=[],c=[];if(Ss.area(t)>0)for(a=0;a<n;a++)l[a]=a;else for(a=0;a<n;a++)l[a]=n-1-a;var u=n,h=2*u;for(a=u-1;u>2;){if(h--<=0)return console.warn("THREE.ShapeUtils: Unable to triangulate polygon! in triangulate()"),i?c:s;if(r=a,u<=r&&(r=0),a=r+1,u<=a&&(a=0),o=a+1,u<=o&&(o=0),e(t,r,a,o,u,l)){var d,f,p,m,g;for(d=l[r],f=l[a],p=l[o],s.push([t[d],t[f],t[p]]),c.push([l[r],l[a],l[o]]),m=a,g=a+1;g<u;m++,g++)l[m]=l[g];u--,h=2*u}}return i?c:s}}(),triangulateShape:function(e,t){function i(e){var t=e.length;t>2&&e[t-1].equals(e[0])&&e.pop()}function n(e,t,i){return e.x!==t.x?e.x<t.x?e.x<=i.x&&i.x<=t.x:t.x<=i.x&&i.x<=e.x:e.y<t.y?e.y<=i.y&&i.y<=t.y:t.y<=i.y&&i.y<=e.y}function r(e,t,i,r,a){var o=t.x-e.x,s=t.y-e.y,l=r.x-i.x,c=r.y-i.y,u=e.x-i.x,h=e.y-i.y,d=s*l-o*c,f=s*u-o*h;if(Math.abs(d)>Number.EPSILON){var p;if(d>0){if(f<0||f>d)return[];if((p=c*u-l*h)<0||p>d)return[]}else{if(f>0||f<d)return[];if((p=c*u-l*h)>0||p<d)return[]}if(0===p)return!a||0!==f&&f!==d?[e]:[];if(p===d)return!a||0!==f&&f!==d?[t]:[];if(0===f)return[i];if(f===d)return[r];var m=p/d;return[{x:e.x+m*o,y:e.y+m*s}]}if(0!==f||c*u!=l*h)return[];var g=0===o&&0===s,v=0===l&&0===c;if(g&&v)return e.x!==i.x||e.y!==i.y?[]:[e];if(g)return n(i,r,e)?[e]:[];if(v)return n(e,t,i)?[i]:[];var y,E,x,b,C,M,_,w;return 0!==o?(e.x<t.x?(y=e,x=e.x,E=t,b=t.x):(y=t,x=t.x,E=e,b=e.x),i.x<r.x?(C=i,_=i.x,M=r,w=r.x):(C=r,_=r.x,M=i,w=i.x)):(e.y<t.y?(y=e,x=e.y,E=t,b=t.y):(y=t,x=t.y,E=e,b=e.y),i.y<r.y?(C=i,_=i.y,M=r,w=r.y):(C=r,_=r.y,M=i,w=i.y)),x<=_?b<_?[]:b===_?a?[]:[C]:b<=w?[C,E]:[C,M]:x>w?[]:x===w?a?[]:[y]:b<=w?[y,E]:[y,M]}function a(e,t,i,n){var r=t.x-e.x,a=t.y-e.y,o=i.x-e.x,s=i.y-e.y,l=n.x-e.x,c=n.y-e.y,u=r*s-a*o,h=r*c-a*l;if(Math.abs(u)>Number.EPSILON){var d=l*s-c*o;return u>0?h>=0&&d>=0:h>=0||d>=0}return h>0}i(e),t.forEach(i);for(var o,s,l,c,u,h,d={},f=e.concat(),p=0,m=t.length;p<m;p++)Array.prototype.push.apply(f,t[p]);for(o=0,s=f.length;o<s;o++)u=f[o].x+":"+f[o].y,void 0!==d[u]&&console.warn("THREE.ShapeUtils: Duplicate point",u,o),d[u]=o;var g=function(e,t){for(var i,n,o,s,l,c,u,h,d,f,p,m=e.concat(),g=[],v=[],y=0,E=t.length;y<E;y++)g.push(y);for(var x=0,b=2*g.length;g.length>0;){if(--b<0){console.log("Infinite Loop! Holes left:"+g.length+", Probably Hole outside Shape!");break}for(o=x;o<m.length;o++){s=m[o],n=-1;for(var y=0;y<g.length;y++)if(c=g[y],u=s.x+":"+s.y+":"+c,void 0===v[u]){i=t[c];for(var C=0;C<i.length;C++)if(l=i[C],function(e,t){var n=m.length-1,r=e-1;r<0&&(r=n);var o=e+1;o>n&&(o=0);var s=a(m[e],m[r],m[o],i[t]);if(!s)return!1;var l=i.length-1,c=t-1;c<0&&(c=l);var u=t+1;return u>l&&(u=0),!!(s=a(i[t],i[c],i[u],m[e]))}(o,C)&&!function(e,t){var i,n,a;for(i=0;i<m.length;i++)if(n=i+1,n%=m.length,a=r(e,t,m[i],m[n],!0),a.length>0)return!0;return!1}(s,l)&&!function(e,i){var n,a,o,s,l;for(n=0;n<g.length;n++)for(a=t[g[n]],o=0;o<a.length;o++)if(s=o+1,s%=a.length,l=r(e,i,a[o],a[s],!0),l.length>0)return!0;return!1}(s,l)){n=C,g.splice(y,1),h=m.slice(0,o+1),d=m.slice(o),f=i.slice(n),p=i.slice(0,n+1),m=h.concat(f).concat(p).concat(d),x=o;break}if(n>=0)break;v[u]=!0}if(n>=0)break}}return m}(e,t),v=Ss.triangulate(g,!1);for(o=0,s=v.length;o<s;o++)for(c=v[o],l=0;l<3;l++)u=c[l].x+":"+c[l].y,void 0!==(h=d[u])&&(c[l]=h);return v.concat()},isClockWise:function(e){return Ss.area(e)<0}};ei.prototype=Object.create(Le.prototype),ei.prototype.constructor=ei,ti.prototype=Object.create(Te.prototype),ti.prototype.constructor=ti,ti.prototype.getArrays=function(){var e=this.getAttribute("position"),t=e?Array.prototype.slice.call(e.array):[],i=this.getAttribute("uv"),n=i?Array.prototype.slice.call(i.array):[],r=this.index;return{position:t,uv:n,index:r?Array.prototype.slice.call(r.array):[]}},ti.prototype.addShapeList=function(e,t){var i=e.length;t.arrays=this.getArrays();for(var n=0;n<i;n++){var r=e[n];this.addShape(r,t)}this.setIndex(t.arrays.index),this.addAttribute("position",new be(t.arrays.position,3)),this.addAttribute("uv",new be(t.arrays.uv,2))},ti.prototype.addShape=function(e,t){function n(e,t,i){return t||console.error("THREE.ExtrudeGeometry: vec does not exist"),t.clone().multiplyScalar(i).add(e)}function r(e,t,n){var r,a,o=1,s=e.x-t.x,l=e.y-t.y,c=n.x-e.x,u=n.y-e.y,h=s*s+l*l,d=s*u-l*c;if(Math.abs(d)>Number.EPSILON){var f=Math.sqrt(h),p=Math.sqrt(c*c+u*u),m=t.x-l/f,g=t.y+s/f,v=n.x-u/p,y=n.y+c/p,E=((v-m)*u-(y-g)*c)/(s*u-l*c);r=m+s*E-e.x,a=g+l*E-e.y;var x=r*r+a*a;if(x<=2)return new i(r,a);o=Math.sqrt(x/2)}else{var b=!1;s>Number.EPSILON?c>Number.EPSILON&&(b=!0):s<-Number.EPSILON?c<-Number.EPSILON&&(b=!0):Math.sign(l)===Math.sign(u)&&(b=!0),b?(r=-l,a=s,o=Math.sqrt(h)):(r=s,a=l,o=Math.sqrt(h/2))}return new i(r/o,a/o)}function a(e,t){var i,n;for(Q=e.length;--Q>=0;){i=Q,n=Q-1,n<0&&(n=e.length-1);var r=0,a=I+2*w;for(r=0;r<a;r++){var o=Y*r,s=Y*(r+1);c(t+i+o,t+n+o,t+n+s,t+i+s,e,r,a,i,n)}}}function o(e,t,i){b.push(e),b.push(t),b.push(i)}function s(e,t,i){u(e),u(t),u(i);var n=y.length/3,r=D.generateTopUV(B,y,n-3,n-2,n-1)
;h(r[0]),h(r[1]),h(r[2])}function c(e,t,i,n,r,a,o,s,l){u(e),u(t),u(n),u(t),u(i),u(n);var c=y.length/3,d=D.generateSideWallUV(B,y,c-6,c-3,c-2,c-1);h(d[0]),h(d[1]),h(d[3]),h(d[1]),h(d[2]),h(d[3])}function u(e){E.push(y.length/3),y.push(b[3*e+0]),y.push(b[3*e+1]),y.push(b[3*e+2])}function h(e){x.push(e.x),x.push(e.y)}var d,f,p,m,g,v=t.arrays?t.arrays:this.getArrays(),y=v.position,E=v.index,x=v.uv,b=[],C=void 0!==t.amount?t.amount:100,M=void 0!==t.bevelThickness?t.bevelThickness:6,_=void 0!==t.bevelSize?t.bevelSize:M-2,w=void 0!==t.bevelSegments?t.bevelSegments:3,L=void 0===t.bevelEnabled||t.bevelEnabled,T=void 0!==t.curveSegments?t.curveSegments:12,I=void 0!==t.steps?t.steps:1,S=t.extrudePath,O=!1,D=void 0!==t.UVGenerator?t.UVGenerator:ei.WorldUVGenerator;S&&(d=S.getSpacedPoints(I),O=!0,L=!1,f=void 0!==t.frames?t.frames:S.computeFrenetFrames(I,!1),p=new l,m=new l,g=new l),L||(w=0,M=0,_=0);var R,A,U,B=this,P=e.extractPoints(T),N=P.shape,k=P.holes,F=!Ss.isClockWise(N);if(F){for(N=N.reverse(),A=0,U=k.length;A<U;A++)R=k[A],Ss.isClockWise(R)&&(k[A]=R.reverse());F=!1}var H=Ss.triangulateShape(N,k),G=N;for(A=0,U=k.length;A<U;A++)R=k[A],N=N.concat(R);for(var V,z,W,q,j,X,Y=N.length,Z=H.length,K=[],Q=0,J=G.length,$=J-1,ee=Q+1;Q<J;Q++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),K[Q]=r(G[Q],G[$],G[ee]);var te,ie=[],ne=K.concat();for(A=0,U=k.length;A<U;A++){for(R=k[A],te=[],Q=0,J=R.length,$=J-1,ee=Q+1;Q<J;Q++,$++,ee++)$===J&&($=0),ee===J&&(ee=0),te[Q]=r(R[Q],R[$],R[ee]);ie.push(te),ne=ne.concat(te)}for(V=0;V<w;V++){for(W=V/w,q=M*Math.cos(W*Math.PI/2),z=_*Math.sin(W*Math.PI/2),Q=0,J=G.length;Q<J;Q++)j=n(G[Q],K[Q],z),o(j.x,j.y,-q);for(A=0,U=k.length;A<U;A++)for(R=k[A],te=ie[A],Q=0,J=R.length;Q<J;Q++)j=n(R[Q],te[Q],z),o(j.x,j.y,-q)}for(z=_,Q=0;Q<Y;Q++)j=L?n(N[Q],ne[Q],z):N[Q],O?(m.copy(f.normals[0]).multiplyScalar(j.x),p.copy(f.binormals[0]).multiplyScalar(j.y),g.copy(d[0]).add(m).add(p),o(g.x,g.y,g.z)):o(j.x,j.y,0);var re;for(re=1;re<=I;re++)for(Q=0;Q<Y;Q++)j=L?n(N[Q],ne[Q],z):N[Q],O?(m.copy(f.normals[re]).multiplyScalar(j.x),p.copy(f.binormals[re]).multiplyScalar(j.y),g.copy(d[re]).add(m).add(p),o(g.x,g.y,g.z)):o(j.x,j.y,C/I*re);for(V=w-1;V>=0;V--){for(W=V/w,q=M*Math.cos(W*Math.PI/2),z=_*Math.sin(W*Math.PI/2),Q=0,J=G.length;Q<J;Q++)j=n(G[Q],K[Q],z),o(j.x,j.y,C+q);for(A=0,U=k.length;A<U;A++)for(R=k[A],te=ie[A],Q=0,J=R.length;Q<J;Q++)j=n(R[Q],te[Q],z),O?o(j.x,j.y+d[I-1].y,d[I-1].x+q):o(j.x,j.y,C+q)}!function(){var e=y.length/3;if(L){var i=0,n=Y*i;for(Q=0;Q<Z;Q++)X=H[Q],s(X[2]+n,X[1]+n,X[0]+n);for(i=I+2*w,n=Y*i,Q=0;Q<Z;Q++)X=H[Q],s(X[0]+n,X[1]+n,X[2]+n)}else{for(Q=0;Q<Z;Q++)X=H[Q],s(X[2],X[1],X[0]);for(Q=0;Q<Z;Q++)X=H[Q],s(X[0]+Y*I,X[1]+Y*I,X[2]+Y*I)}B.addGroup(e,y.length/3-e,void 0!==t.material?t.material:0)}(),function(){var e=y.length/3,i=0;for(a(G,i),i+=G.length,A=0,U=k.length;A<U;A++)R=k[A],a(R,i),i+=R.length;B.addGroup(e,y.length/3-e,void 0!==t.extrudeMaterial?t.extrudeMaterial:1)}(),t.arrays||(this.setIndex(E),this.addAttribute("position",new be(y,3)),this.addAttribute("uv",new be(t.arrays.uv,2)))},ei.WorldUVGenerator={generateTopUV:function(e,t,n,r,a){var o=t[3*n],s=t[3*n+1],l=t[3*r],c=t[3*r+1],u=t[3*a],h=t[3*a+1];return[new i(o,s),new i(l,c),new i(u,h)]},generateSideWallUV:function(e,t,n,r,a,o){var s=t[3*n],l=t[3*n+1],c=t[3*n+2],u=t[3*r],h=t[3*r+1],d=t[3*r+2],f=t[3*a],p=t[3*a+1],m=t[3*a+2],g=t[3*o],v=t[3*o+1],y=t[3*o+2];return Math.abs(l-h)<.01?[new i(s,1-c),new i(u,1-d),new i(f,1-m),new i(g,1-y)]:[new i(l,1-c),new i(h,1-d),new i(p,1-m),new i(v,1-y)]}},ii.prototype=Object.create(Le.prototype),ii.prototype.constructor=ii,ni.prototype=Object.create(ti.prototype),ni.prototype.constructor=ni,ri.prototype=Object.create(Le.prototype),ri.prototype.constructor=ri,ai.prototype=Object.create(Te.prototype),ai.prototype.constructor=ai,oi.prototype=Object.create(Le.prototype),oi.prototype.constructor=oi,si.prototype=Object.create(Te.prototype),si.prototype.constructor=si,li.prototype=Object.create(Le.prototype),li.prototype.constructor=li,ci.prototype=Object.create(Te.prototype),ci.prototype.constructor=ci,ui.prototype=Object.create(Le.prototype),ui.prototype.constructor=ui,hi.prototype=Object.create(Te.prototype),hi.prototype.constructor=hi,di.prototype=Object.create(Te.prototype),di.prototype.constructor=di,fi.prototype=Object.create(Le.prototype),fi.prototype.constructor=fi,pi.prototype=Object.create(Te.prototype),pi.prototype.constructor=pi,mi.prototype=Object.create(fi.prototype),mi.prototype.constructor=mi,gi.prototype=Object.create(pi.prototype),gi.prototype.constructor=gi,vi.prototype=Object.create(Le.prototype),vi.prototype.constructor=vi,yi.prototype=Object.create(Te.prototype),yi.prototype.constructor=yi;var Os=Object.freeze({WireframeGeometry:Bt,ParametricGeometry:Pt,ParametricBufferGeometry:Nt,TetrahedronGeometry:Ht,TetrahedronBufferGeometry:Gt,OctahedronGeometry:Vt,OctahedronBufferGeometry:zt,IcosahedronGeometry:Wt,IcosahedronBufferGeometry:qt,DodecahedronGeometry:jt,DodecahedronBufferGeometry:Xt,PolyhedronGeometry:kt,PolyhedronBufferGeometry:Ft,TubeGeometry:Yt,TubeBufferGeometry:Zt,TorusKnotGeometry:Kt,TorusKnotBufferGeometry:Qt,TorusGeometry:Jt,TorusBufferGeometry:$t,TextGeometry:ii,TextBufferGeometry:ni,SphereGeometry:ri,SphereBufferGeometry:ai,RingGeometry:oi,RingBufferGeometry:si,PlaneGeometry:De,PlaneBufferGeometry:Re,LatheGeometry:li,LatheBufferGeometry:ci,ShapeGeometry:ui,ShapeBufferGeometry:hi,ExtrudeGeometry:ei,ExtrudeBufferGeometry:ti,EdgesGeometry:di,ConeGeometry:mi,ConeBufferGeometry:gi,CylinderGeometry:fi,CylinderBufferGeometry:pi,CircleGeometry:vi,CircleBufferGeometry:yi,BoxGeometry:Se,BoxBufferGeometry:Oe});Ei.prototype=Object.create(Q.prototype),Ei.prototype.constructor=Ei,Ei.prototype.isShadowMaterial=!0,xi.prototype=Object.create(Q.prototype),xi.prototype.constructor=xi,xi.prototype.isRawShaderMaterial=!0,bi.prototype=Object.create(K.prototype),bi.prototype.constructor=bi,bi.prototype.isMeshStandardMaterial=!0,bi.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.defines={STANDARD:""},this.color.copy(e.color),this.roughness=e.roughness,this.metalness=e.metalness,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.roughnessMap=e.roughnessMap,this.metalnessMap=e.metalnessMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.envMapIntensity=e.envMapIntensity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Ci.prototype=Object.create(bi.prototype),Ci.prototype.constructor=Ci,Ci.prototype.isMeshPhysicalMaterial=!0,Ci.prototype.copy=function(e){return bi.prototype.copy.call(this,e),this.defines={PHYSICAL:""},this.reflectivity=e.reflectivity,this.clearCoat=e.clearCoat,this.clearCoatRoughness=e.clearCoatRoughness,this},Mi.prototype=Object.create(K.prototype),Mi.prototype.constructor=Mi,Mi.prototype.isMeshPhongMaterial=!0,Mi.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},_i.prototype=Object.create(Mi.prototype),_i.prototype.constructor=_i,_i.prototype.isMeshToonMaterial=!0,_i.prototype.copy=function(e){return Mi.prototype.copy.call(this,e),this.gradientMap=e.gradientMap,this},wi.prototype=Object.create(K.prototype),wi.prototype.constructor=wi,wi.prototype.isMeshNormalMaterial=!0,wi.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.bumpMap=e.bumpMap,this.bumpScale=e.bumpScale,this.normalMap=e.normalMap,this.normalScale.copy(e.normalScale),this.displacementMap=e.displacementMap,this.displacementScale=e.displacementScale,this.displacementBias=e.displacementBias,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Li.prototype=Object.create(K.prototype),Li.prototype.constructor=Li,Li.prototype.isMeshLambertMaterial=!0,Li.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.map=e.map,this.lightMap=e.lightMap,this.lightMapIntensity=e.lightMapIntensity,this.aoMap=e.aoMap,this.aoMapIntensity=e.aoMapIntensity,this.emissive.copy(e.emissive),this.emissiveMap=e.emissiveMap,this.emissiveIntensity=e.emissiveIntensity,this.specularMap=e.specularMap,this.alphaMap=e.alphaMap,this.envMap=e.envMap,this.combine=e.combine,this.reflectivity=e.reflectivity,this.refractionRatio=e.refractionRatio,this.wireframe=e.wireframe,this.wireframeLinewidth=e.wireframeLinewidth,this.wireframeLinecap=e.wireframeLinecap,this.wireframeLinejoin=e.wireframeLinejoin,this.skinning=e.skinning,this.morphTargets=e.morphTargets,this.morphNormals=e.morphNormals,this},Ti.prototype=Object.create(K.prototype),Ti.prototype.constructor=Ti,Ti.prototype.isLineDashedMaterial=!0,Ti.prototype.copy=function(e){return K.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.scale=e.scale,this.dashSize=e.dashSize,this.gapSize=e.gapSize,this};var Ds=Object.freeze({ShadowMaterial:Ei,SpriteMaterial:yt,RawShaderMaterial:xi,ShaderMaterial:Q,PointsMaterial:It,MeshPhysicalMaterial:Ci,MeshStandardMaterial:bi,MeshPhongMaterial:Mi,MeshToonMaterial:_i,MeshNormalMaterial:wi,MeshLambertMaterial:Li,MeshDepthMaterial:J,MeshBasicMaterial:de,LineDashedMaterial:Ti,LineBasicMaterial:_t,Material:K}),Rs={enabled:!1,files:{},add:function(e,t){!1!==this.enabled&&(this.files[e]=t)},get:function(e){if(!1!==this.enabled)return this.files[e]},remove:function(e){delete this.files[e]},clear:function(){this.files={}}},As=new Ii;Object.assign(Si.prototype,{load:function(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var r=this,a=Rs.get(e);if(void 0!==a)return r.manager.itemStart(e),setTimeout(function(){t&&t(a),r.manager.itemEnd(e)},0),a;var o=/^data:(.*?)(;base64)?,(.*)$/,s=e.match(o);if(s){var l=s[1],c=!!s[2],u=s[3];u=window.decodeURIComponent(u),c&&(u=window.atob(u));try{var h,d=(this.responseType||"").toLowerCase();switch(d){case"arraybuffer":case"blob":h=new ArrayBuffer(u.length);for(var f=new Uint8Array(h),p=0;p<u.length;p++)f[p]=u.charCodeAt(p);"blob"===d&&(h=new Blob([h],{type:l}));break;case"document":var m=new DOMParser;h=m.parseFromString(u,l);break;case"json":h=JSON.parse(u);break;default:h=u}window.setTimeout(function(){t&&t(h),r.manager.itemEnd(e)},0)}catch(t){window.setTimeout(function(){n&&n(t),r.manager.itemEnd(e),r.manager.itemError(e)},0)}}else{var g=new XMLHttpRequest;g.open("GET",e,!0),g.addEventListener("load",function(i){var a=i.target.response;Rs.add(e,a),200===this.status?(t&&t(a),r.manager.itemEnd(e)):0===this.status?(console.warn("THREE.FileLoader: HTTP Status 0 received."),t&&t(a),r.manager.itemEnd(e)):(n&&n(i),r.manager.itemEnd(e),r.manager.itemError(e))},!1),void 0!==i&&g.addEventListener("progress",function(e){i(e)},!1),g.addEventListener("error",function(t){n&&n(t),r.manager.itemEnd(e),r.manager.itemError(e)},!1),void 0!==this.responseType&&(g.responseType=this.responseType),void 0!==this.withCredentials&&(g.withCredentials=this.withCredentials),g.overrideMimeType&&g.overrideMimeType(void 0!==this.mimeType?this.mimeType:"text/plain");for(var v in this.requestHeader)g.setRequestHeader(v,this.requestHeader[v]);g.send(null)}return r.manager.itemStart(e),g},setPath:function(e){return this.path=e,this},setResponseType:function(e){return this.responseType=e,this},setWithCredentials:function(e){return this.withCredentials=e,this},setMimeType:function(e){return this.mimeType=e,this},setRequestHeader:function(e){return this.requestHeader=e,this}}),Object.assign(Oi.prototype,{load:function(e,t,i,n){var r=this,a=[],o=new Rt;o.image=a;var s=new Si(this.manager);if(s.setPath(this.path),s.setResponseType("arraybuffer"),Array.isArray(e))for(var l=0,c=0,u=e.length;c<u;++c)!function(c){s.load(e[c],function(e){var i=r._parser(e,!0);a[c]={width:i.width,height:i.height,format:i.format,mipmaps:i.mipmaps},6===(l+=1)&&(1===i.mipmapCount&&(o.minFilter=Eo),o.format=i.format,o.needsUpdate=!0,t&&t(o))},i,n)}(c);else s.load(e,function(e){var i=r._parser(e,!0);if(i.isCubemap)for(var n=i.mipmaps.length/i.mipmapCount,s=0;s<n;s++){a[s]={mipmaps:[]};for(var l=0;l<i.mipmapCount;l++)a[s].mipmaps.push(i.mipmaps[s*i.mipmapCount+l]),a[s].format=i.format,a[s].width=i.width,a[s].height=i.height}else o.image.width=i.width,o.image.height=i.height,o.mipmaps=i.mipmaps;1===i.mipmapCount&&(o.minFilter=Eo),o.format=i.format,o.needsUpdate=!0,t&&t(o)},i,n);return o},setPath:function(e){return this.path=e,this}}),Object.assign(Di.prototype,{load:function(e,t,i,n){var r=this,a=new u,o=new Si(this.manager);return o.setResponseType("arraybuffer"),o.load(e,function(e){var i=r._parser(e);i&&(void 0!==i.image?a.image=i.image:void 0!==i.data&&(a.image.width=i.width,a.image.height=i.height,a.image.data=i.data),a.wrapS=void 0!==i.wrapS?i.wrapS:po,a.wrapT=void 0!==i.wrapT?i.wrapT:po,a.magFilter=void 0!==i.magFilter?i.magFilter:Eo,a.minFilter=void 0!==i.minFilter?i.minFilter:bo,a.anisotropy=void 0!==i.anisotropy?i.anisotropy:1,void 0!==i.format&&(a.format=i.format),void 0!==i.type&&(a.type=i.type),void 0!==i.mipmaps&&(a.mipmaps=i.mipmaps),1===i.mipmapCount&&(a.minFilter=Eo),a.needsUpdate=!0,t&&t(a,i))},i,n),a}}),Object.assign(Ri.prototype,{load:function(e,t,i,n){void 0===e&&(e=""),void 0!==this.path&&(e=this.path+e);var r=this,a=Rs.get(e);if(void 0!==a)return r.manager.itemStart(e),setTimeout(function(){t&&t(a),r.manager.itemEnd(e)},0),a;var o=document.createElementNS("http://www.w3.org/1999/xhtml","img");return o.addEventListener("load",function(){Rs.add(e,this),t&&t(this),r.manager.itemEnd(e)},!1),o.addEventListener("error",function(t){n&&n(t),r.manager.itemEnd(e),r.manager.itemError(e)},!1),"data:"!==e.substr(0,5)&&void 0!==this.crossOrigin&&(o.crossOrigin=this.crossOrigin),r.manager.itemStart(e),o.src=e,o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Ai.prototype,{load:function(e,t,i,n){var r=new h,a=new Ri(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);for(var o=0,s=0;s<e.length;++s)!function(i){a.load(e[i],function(e){r.images[i]=e,6==++o&&(r.needsUpdate=!0,t&&t(r))},void 0,n)}(s);return r},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Object.assign(Ui.prototype,{load:function(e,t,i,r){var a=new Ri(this.manager);a.setCrossOrigin(this.crossOrigin),a.setPath(this.path);var o=new n;return o.image=a.load(e,function(){var i=e.search(/\.(jpg|jpeg)$/)>0||0===e.search(/^data\:image\/jpeg/);o.format=i?Bo:Po,o.needsUpdate=!0,void 0!==t&&t(o)},i,r),o},setCrossOrigin:function(e){return this.crossOrigin=e,this},setPath:function(e){return this.path=e,this}}),Bi.prototype=Object.assign(Object.create(le.prototype),{constructor:Bi,isLight:!0,copy:function(e){return le.prototype.copy.call(this,e),this.color.copy(e.color),this.intensity=e.intensity,this},toJSON:function(e){var t=le.prototype.toJSON.call(this,e);return t.object.color=this.color.getHex(),t.object.intensity=this.intensity,void 0!==this.groundColor&&(t.object.groundColor=this.groundColor.getHex()),void 0!==this.distance&&(t.object.distance=this.distance),void 0!==this.angle&&(t.object.angle=this.angle),void 0!==this.decay&&(t.object.decay=this.decay),void 0!==this.penumbra&&(t.object.penumbra=this.penumbra),void 0!==this.shadow&&(t.object.shadow=this.shadow.toJSON()),t}}),Pi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Pi,isHemisphereLight:!0,copy:function(e){return Bi.prototype.copy.call(this,e),this.groundColor.copy(e.groundColor),this}}),Object.assign(Ni.prototype,{copy:function(e){return this.camera=e.camera.clone(),this.bias=e.bias,this.radius=e.radius,this.mapSize.copy(e.mapSize),this},clone:function(){return(new this.constructor).copy(this)},toJSON:function(){var e={};return 0!==this.bias&&(e.bias=this.bias),1!==this.radius&&(e.radius=this.radius),512===this.mapSize.x&&512===this.mapSize.y||(e.mapSize=this.mapSize.toArray()),e.camera=this.camera.toJSON(!1).object,delete e.camera.matrix,e}}),ki.prototype=Object.assign(Object.create(Ni.prototype),{constructor:ki,isSpotLightShadow:!0,update:function(e){var t=this.camera,i=2*hs.RAD2DEG*e.angle,n=this.mapSize.width/this.mapSize.height,r=e.distance||t.far;i===t.fov&&n===t.aspect&&r===t.far||(t.fov=i,t.aspect=n,t.far=r,t.updateProjectionMatrix())}}),Fi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Fi,isSpotLight:!0,copy:function(e){return Bi.prototype.copy.call(this,e),this.distance=e.distance,this.angle=e.angle,this.penumbra=e.penumbra,this.decay=e.decay,this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),Hi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Hi,isPointLight:!0,copy:function(e){return Bi.prototype.copy.call(this,e),this.distance=e.distance,this.decay=e.decay,this.shadow=e.shadow.clone(),this}}),Gi.prototype=Object.assign(Object.create(Ni.prototype),{constructor:Gi}),Vi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Vi,isDirectionalLight:!0,copy:function(e){return Bi.prototype.copy.call(this,e),this.target=e.target.clone(),this.shadow=e.shadow.clone(),this}}),zi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:zi,isAmbientLight:!0}),Wi.prototype=Object.assign(Object.create(Bi.prototype),{constructor:Wi,isRectAreaLight:!0,copy:function(e){return Bi.prototype.copy.call(this,e),this.width=e.width,this.height=e.height,this},toJSON:function(e){var t=Bi.prototype.toJSON.call(this,e);return t.object.width=this.width,t.object.height=this.height,t}});var Us={arraySlice:function(e,t,i){return Us.isTypedArray(e)?new e.constructor(e.subarray(t,void 0!==i?i:e.length)):e.slice(t,i)},convertArray:function(e,t,i){return!e||!i&&e.constructor===t?e:"number"==typeof t.BYTES_PER_ELEMENT?new t(e):Array.prototype.slice.call(e)},isTypedArray:function(e){return ArrayBuffer.isView(e)&&!(e instanceof DataView)},getKeyframeOrder:function(e){function t(t,i){return e[t]-e[i]}for(var i=e.length,n=new Array(i),r=0;r!==i;++r)n[r]=r;return n.sort(t),n},sortedArray:function(e,t,i){for(var n=e.length,r=new e.constructor(n),a=0,o=0;o!==n;++a)for(var s=i[a]*t,l=0;l!==t;++l)r[o++]=e[s+l];return r},flattenJSON:function(e,t,i,n){for(var r=1,a=e[0];void 0!==a&&void 0===a[n];)a=e[r++];if(void 0!==a){var o=a[n];if(void 0!==o)if(Array.isArray(o))do{o=a[n],void 0!==o&&(t.push(a.time),i.push.apply(i,o)),a=e[r++]}while(void 0!==a);else if(void 0!==o.toArray)do{o=a[n],void 0!==o&&(t.push(a.time),o.toArray(i,i.length)),a=e[r++]}while(void 0!==a);else do{o=a[n],void 0!==o&&(t.push(a.time),i.push(o)),a=e[r++]}while(void 0!==a)}}};Object.assign(qi.prototype,{evaluate:function(e){var t=this.parameterPositions,i=this._cachedIndex,n=t[i],r=t[i-1];e:{t:{var a;i:{n:if(!(e<n)){for(var o=i+2;;){if(void 0===n){if(e<r)break n;return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,e,r)}if(i===o)break;if(r=n,n=t[++i],e<n)break t}a=t.length;break i}{if(e>=r)break e;var s=t[1];e<s&&(i=2,r=s);for(var o=i-2;;){if(void 0===r)return this._cachedIndex=0,this.beforeStart_(0,e,n);if(i===o)break;if(n=r,r=t[--i-1],e>=r)break t}a=i,i=0}}for(;i<a;){var l=i+a>>>1;e<t[l]?a=l:i=l+1}if(n=t[i],void 0===(r=t[i-1]))return this._cachedIndex=0,this.beforeStart_(0,e,n);if(void 0===n)return i=t.length,this._cachedIndex=i,this.afterEnd_(i-1,r,e)}this._cachedIndex=i,this.intervalChanged_(i,r,n)}return this.interpolate_(i,r,e,n)},settings:null,DefaultSettings_:{},getSettings_:function(){return this.settings||this.DefaultSettings_},copySampleValue_:function(e){for(var t=this.resultBuffer,i=this.sampleValues,n=this.valueSize,r=e*n,a=0;a!==n;++a)t[a]=i[r+a];return t},interpolate_:function(e,t,i,n){throw new Error("call to abstract method")},intervalChanged_:function(e,t,i){}}),Object.assign(qi.prototype,{beforeStart_:qi.prototype.copySampleValue_,afterEnd_:qi.prototype.copySampleValue_}),ji.prototype=Object.assign(Object.create(qi.prototype),{constructor:ji,DefaultSettings_:{endingStart:Jo,endingEnd:Jo},intervalChanged_:function(e,t,i){var n=this.parameterPositions,r=e-2,a=e+1,o=n[r],s=n[a];if(void 0===o)switch(this.getSettings_().endingStart){case 2401:r=e,o=2*t-i;break;case 2402:r=n.length-2,o=t+n[r]-n[r+1];break;default:r=e,o=i}if(void 0===s)switch(this.getSettings_().endingEnd){case 2401:a=e,s=2*i-t;break;case 2402:a=1,s=i+n[1]-n[0];break;default:a=e-1,s=t}var l=.5*(i-t),c=this.valueSize;this._weightPrev=l/(t-o),this._weightNext=l/(s-i),this._offsetPrev=r*c,this._offsetNext=a*c},interpolate_:function(e,t,i,n){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,c=this._offsetPrev,u=this._offsetNext,h=this._weightPrev,d=this._weightNext,f=(i-t)/(n-t),p=f*f,m=p*f,g=-h*m+2*h*p-h*f,v=(1+h)*m+(-1.5-2*h)*p+(-.5+h)*f+1,y=(-1-d)*m+(1.5+d)*p+.5*f,E=d*m-d*p,x=0;x!==o;++x)r[x]=g*a[c+x]+v*a[l+x]+y*a[s+x]+E*a[u+x];return r}}),Xi.prototype=Object.assign(Object.create(qi.prototype),{constructor:Xi,interpolate_:function(e,t,i,n){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,s=e*o,l=s-o,c=(i-t)/(n-t),u=1-c,h=0;h!==o;++h)r[h]=a[l+h]*u+a[s+h]*c;return r}}),Yi.prototype=Object.assign(Object.create(qi.prototype),{constructor:Yi,interpolate_:function(e,t,i,n){return this.copySampleValue_(e-1)}});var Bs;Bs={TimeBufferType:Float32Array,ValueBufferType:Float32Array,DefaultInterpolation:2301,InterpolantFactoryMethodDiscrete:function(e){return new Yi(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodLinear:function(e){return new Xi(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:function(e){return new ji(this.times,this.values,this.getValueSize(),e)},setInterpolation:function(e){var t;switch(e){case 2300:t=this.InterpolantFactoryMethodDiscrete;break;case 2301:t=this.InterpolantFactoryMethodLinear;break;case 2302:t=this.InterpolantFactoryMethodSmooth}if(void 0===t){var i="unsupported interpolation for "+this.ValueTypeName+" keyframe track named "+this.name;if(void 0===this.createInterpolant){if(e===this.DefaultInterpolation)throw new Error(i);this.setInterpolation(this.DefaultInterpolation)}return void console.warn(i)}this.createInterpolant=t},getInterpolation:function(){switch(this.createInterpolant){case this.InterpolantFactoryMethodDiscrete:return 2300;case this.InterpolantFactoryMethodLinear:return 2301;case this.InterpolantFactoryMethodSmooth:return 2302}},getValueSize:function(){return this.values.length/this.times.length},shift:function(e){if(0!==e)for(var t=this.times,i=0,n=t.length;i!==n;++i)t[i]+=e;return this},scale:function(e){if(1!==e)for(var t=this.times,i=0,n=t.length;i!==n;++i)t[i]*=e;return this},trim:function(e,t){for(var i=this.times,n=i.length,r=0,a=n-1;r!==n&&i[r]<e;)++r;for(;-1!==a&&i[a]>t;)--a;if(++a,0!==r||a!==n){r>=a&&(a=Math.max(a,1),r=a-1);var o=this.getValueSize();this.times=Us.arraySlice(i,r,a),this.values=Us.arraySlice(this.values,r*o,a*o)}return this},validate:function(){var e=!0,t=this.getValueSize();t-Math.floor(t)!=0&&(console.error("invalid value size in track",this),e=!1);var i=this.times,n=this.values,r=i.length;0===r&&(console.error("track is empty",this),e=!1);for(var a=null,o=0;o!==r;o++){var s=i[o];if("number"==typeof s&&isNaN(s)){console.error("time is not a valid number",this,o,s),e=!1;break}if(null!==a&&a>s){console.error("out of order keys",this,o,s,a),e=!1;break}a=s}if(void 0!==n&&Us.isTypedArray(n))for(var o=0,l=n.length;o!==l;++o){var c=n[o];if(isNaN(c)){console.error("value is not a valid number",this,o,c),e=!1;break}}return e},optimize:function(){for(var e=this.times,t=this.values,i=this.getValueSize(),n=2302===this.getInterpolation(),r=1,a=e.length-1,o=1;o<a;++o){var s=!1,l=e[o];if(l!==e[o+1]&&(1!==o||l!==l[0]))if(n)s=!0;else for(var c=o*i,u=c-i,h=c+i,d=0;d!==i;++d){var f=t[c+d];if(f!==t[u+d]||f!==t[h+d]){s=!0;break}}if(s){if(o!==r){e[r]=e[o];for(var p=o*i,m=r*i,d=0;d!==i;++d)t[m+d]=t[p+d]}++r}}if(a>0){e[r]=e[a];for(var p=a*i,m=r*i,d=0;d!==i;++d)t[m+d]=t[p+d];++r}return r!==e.length&&(this.times=Us.arraySlice(e,0,r),this.values=Us.arraySlice(t,0,r*i)),this}},Ki.prototype=Object.assign(Object.create(Bs),{constructor:Ki,ValueTypeName:"vector"}),Qi.prototype=Object.assign(Object.create(qi.prototype),{constructor:Qi,interpolate_:function(e,t,i,n){for(var r=this.resultBuffer,a=this.sampleValues,o=this.valueSize,l=e*o,c=(i-t)/(n-t),u=l+o;l!==u;l+=4)s.slerpFlat(r,0,a,l-o,a,l,c);return r}}),Ji.prototype=Object.assign(Object.create(Bs),{constructor:Ji,ValueTypeName:"quaternion",DefaultInterpolation:2301,InterpolantFactoryMethodLinear:function(e){return new Qi(this.times,this.values,this.getValueSize(),e)},InterpolantFactoryMethodSmooth:void 0}),$i.prototype=Object.assign(Object.create(Bs),{constructor:$i,ValueTypeName:"number"}),en.prototype=Object.assign(Object.create(Bs),{constructor:en,ValueTypeName:"string",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),tn.prototype=Object.assign(Object.create(Bs),{constructor:tn,ValueTypeName:"bool",ValueBufferType:Array,DefaultInterpolation:2300,InterpolantFactoryMethodLinear:void 0,InterpolantFactoryMethodSmooth:void 0}),nn.prototype=Object.assign(Object.create(Bs),{constructor:nn,ValueTypeName:"color"}),rn.prototype=Bs,Bs.constructor=rn,Object.assign(rn,{parse:function(e){if(void 0===e.type)throw new Error("track type undefined, can not parse");var t=rn._getTrackTypeForValueTypeName(e.type);if(void 0===e.times){var i=[],n=[];Us.flattenJSON(e.keys,i,n,"value"),e.times=i,e.values=n}return void 0!==t.parse?t.parse(e):new t(e.name,e.times,e.values,e.interpolation)},toJSON:function(e){var t,i=e.constructor;if(void 0!==i.toJSON)t=i.toJSON(e);else{t={name:e.name,times:Us.convertArray(e.times,Array),values:Us.convertArray(e.values,Array)};var n=e.getInterpolation();n!==e.DefaultInterpolation&&(t.interpolation=n)}return t.type=e.ValueTypeName,t},_getTrackTypeForValueTypeName:function(e){switch(e.toLowerCase()){case"scalar":case"double":case"float":case"number":case"integer":return $i;case"vector":case"vector2":case"vector3":case"vector4":return Ki;case"color":return nn;case"quaternion":return Ji;case"bool":case"boolean":return tn;case"string":return en}throw new Error("Unsupported typeName: "+e)}}),Object.assign(an,{parse:function(e){for(var t=[],i=e.tracks,n=1/(e.fps||1),r=0,a=i.length;r!==a;++r)t.push(rn.parse(i[r]).scale(n));return new an(e.name,e.duration,t)},toJSON:function(e){for(var t=[],i=e.tracks,n={name:e.name,duration:e.duration,tracks:t},r=0,a=i.length;r!==a;++r)t.push(rn.toJSON(i[r]));return n},CreateFromMorphTargetSequence:function(e,t,i,n){for(var r=t.length,a=[],o=0;o<r;o++){var s=[],l=[];s.push((o+r-1)%r,o,(o+1)%r),l.push(0,1,0);var c=Us.getKeyframeOrder(s);s=Us.sortedArray(s,1,c),l=Us.sortedArray(l,1,c),n||0!==s[0]||(s.push(r),l.push(l[0])),a.push(new $i(".morphTargetInfluences["+t[o].name+"]",s,l).scale(1/i))}return new an(e,-1,a)},findByName:function(e,t){var i=e;if(!Array.isArray(e)){var n=e;i=n.geometry&&n.geometry.animations||n.animations}for(var r=0;r<i.length;r++)if(i[r].name===t)return i[r];return null},CreateClipsFromMorphTargetSequences:function(e,t,i){for(var n={},r=/^([\w-]*?)([\d]+)$/,a=0,o=e.length;a<o;a++){var s=e[a],l=s.name.match(r);if(l&&l.length>1){var c=l[1],u=n[c];u||(n[c]=u=[]),u.push(s)}}var h=[];for(var c in n)h.push(an.CreateFromMorphTargetSequence(c,n[c],t,i));return h},parseAnimation:function(e,t){if(!e)return console.error("  no animation in JSONLoader data"),null;for(var i=function(e,t,i,n,r){if(0!==i.length){var a=[],o=[];Us.flattenJSON(i,a,o,n),0!==a.length&&r.push(new e(t,a,o))}},n=[],r=e.name||"default",a=e.length||-1,o=e.fps||30,s=e.hierarchy||[],l=0;l<s.length;l++){var c=s[l].keys;if(c&&0!==c.length)if(c[0].morphTargets){for(var u={},h=0;h<c.length;h++)if(c[h].morphTargets)for(var d=0;d<c[h].morphTargets.length;d++)u[c[h].morphTargets[d]]=-1;for(var f in u){for(var p=[],m=[],d=0;d!==c[h].morphTargets.length;++d){var g=c[h];p.push(g.time),m.push(g.morphTarget===f?1:0)}n.push(new $i(".morphTargetInfluence["+f+"]",p,m))}a=u.length*(o||1)}else{var v=".bones["+t[l].name+"]";i(Ki,v+".position",c,"pos",n),i(Ji,v+".quaternion",c,"rot",n),i(Ki,v+".scale",c,"scl",n)}}return 0===n.length?null:new an(r,a,n)}}),Object.assign(an.prototype,{resetDuration:function(){for(var e=this.tracks,t=0,i=0,n=e.length;i!==n;++i){var r=this.tracks[i];t=Math.max(t,r.times[r.times.length-1])}this.duration=t},trim:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].trim(0,this.duration);return this},optimize:function(){for(var e=0;e<this.tracks.length;e++)this.tracks[e].optimize();return this}}),Object.assign(on.prototype,{load:function(e,t,i,n){var r=this,a=new Si(r.manager);a.setResponseType("json"),a.load(e,function(e){t(r.parse(e))},i,n)},setTextures:function(e){this.textures=e},parse:function(e){function t(e){return void 0===n[e]&&console.warn("THREE.MaterialLoader: Undefined texture",e),n[e]}var n=this.textures,r=new Ds[e.type];if(void 0!==e.uuid&&(r.uuid=e.uuid),void 0!==e.name&&(r.name=e.name),void 0!==e.color&&r.color.setHex(e.color),void 0!==e.roughness&&(r.roughness=e.roughness),void 0!==e.metalness&&(r.metalness=e.metalness),void 0!==e.emissive&&r.emissive.setHex(e.emissive),void 0!==e.specular&&r.specular.setHex(e.specular),void 0!==e.shininess&&(r.shininess=e.shininess),void 0!==e.clearCoat&&(r.clearCoat=e.clearCoat),void 0!==e.clearCoatRoughness&&(r.clearCoatRoughness=e.clearCoatRoughness),void 0!==e.uniforms&&(r.uniforms=e.uniforms),void 0!==e.vertexShader&&(r.vertexShader=e.vertexShader),void 0!==e.fragmentShader&&(r.fragmentShader=e.fragmentShader),void 0!==e.vertexColors&&(r.vertexColors=e.vertexColors),void 0!==e.fog&&(r.fog=e.fog),void 0!==e.shading&&(r.shading=e.shading),void 0!==e.blending&&(r.blending=e.blending),void 0!==e.side&&(r.side=e.side),void 0!==e.opacity&&(r.opacity=e.opacity),void 0!==e.transparent&&(r.transparent=e.transparent),void 0!==e.alphaTest&&(r.alphaTest=e.alphaTest),void 0!==e.depthTest&&(r.depthTest=e.depthTest),void 0!==e.depthWrite&&(r.depthWrite=e.depthWrite),void 0!==e.colorWrite&&(r.colorWrite=e.colorWrite),void 0!==e.wireframe&&(r.wireframe=e.wireframe),void 0!==e.wireframeLinewidth&&(r.wireframeLinewidth=e.wireframeLinewidth),void 0!==e.wireframeLinecap&&(r.wireframeLinecap=e.wireframeLinecap),void 0!==e.wireframeLinejoin&&(r.wireframeLinejoin=e.wireframeLinejoin),void 0!==e.skinning&&(r.skinning=e.skinning),void 0!==e.morphTargets&&(r.morphTargets=e.morphTargets),void 0!==e.size&&(r.size=e.size),
void 0!==e.sizeAttenuation&&(r.sizeAttenuation=e.sizeAttenuation),void 0!==e.positionOffset&&(r.positionOffset=e.positionOffset),void 0!==e.sizeAttribute&&(r.sizeAttribute=e.sizeAttribute),void 0!==e.map&&(r.map=t(e.map)),void 0!==e.alphaMap&&(r.alphaMap=t(e.alphaMap),r.transparent=!0),void 0!==e.bumpMap&&(r.bumpMap=t(e.bumpMap)),void 0!==e.bumpScale&&(r.bumpScale=e.bumpScale),void 0!==e.normalMap&&(r.normalMap=t(e.normalMap)),void 0!==e.normalScale){var a=e.normalScale;!1===Array.isArray(a)&&(a=[a,a]),r.normalScale=(new i).fromArray(a)}return void 0!==e.displacementMap&&(r.displacementMap=t(e.displacementMap)),void 0!==e.displacementScale&&(r.displacementScale=e.displacementScale),void 0!==e.displacementBias&&(r.displacementBias=e.displacementBias),void 0!==e.roughnessMap&&(r.roughnessMap=t(e.roughnessMap)),void 0!==e.metalnessMap&&(r.metalnessMap=t(e.metalnessMap)),void 0!==e.emissiveMap&&(r.emissiveMap=t(e.emissiveMap)),void 0!==e.emissiveIntensity&&(r.emissiveIntensity=e.emissiveIntensity),void 0!==e.specularMap&&(r.specularMap=t(e.specularMap)),void 0!==e.envMap&&(r.envMap=t(e.envMap)),void 0!==e.reflectivity&&(r.reflectivity=e.reflectivity),void 0!==e.lightMap&&(r.lightMap=t(e.lightMap)),void 0!==e.lightMapIntensity&&(r.lightMapIntensity=e.lightMapIntensity),void 0!==e.aoMap&&(r.aoMap=t(e.aoMap)),void 0!==e.aoMapIntensity&&(r.aoMapIntensity=e.aoMapIntensity),void 0!==e.gradientMap&&(r.gradientMap=t(e.gradientMap)),r}}),Object.assign(sn.prototype,{load:function(e,t,i,n){var r=this,a=new Si(r.manager);a.setResponseType("json"),a.load(e,function(e){t(r.parse(e))},i,n)},parse:function(e){var t=new Te,i=e.data.index;if(void 0!==i){var n=new Ps[i.type](i.array);t.setIndex(new fe(n,1))}var r=e.data.attributes;for(var a in r){var o=r[a],n=new Ps[o.type](o.array);t.addAttribute(a,new fe(n,o.itemSize,o.normalized))}var s=e.data.groups||e.data.drawcalls||e.data.offsets;if(void 0!==s)for(var c=0,u=s.length;c!==u;++c){var h=s[c];t.addGroup(h.start,h.count,h.materialIndex)}var d=e.data.boundingSphere;if(void 0!==d){var f=new l;void 0!==d.center&&f.fromArray(d.center),t.boundingSphere=new ee(f,d.radius)}return t}});var Ps={Int8Array:Int8Array,Uint8Array:Uint8Array,Uint8ClampedArray:Uint8ClampedArray,Int16Array:Int16Array,Uint16Array:Uint16Array,Int32Array:Int32Array,Uint32Array:Uint32Array,Float32Array:Float32Array,Float64Array:Float64Array};ln.Handlers={handlers:[],add:function(e,t){this.handlers.push(e,t)},get:function(e){for(var t=this.handlers,i=0,n=t.length;i<n;i+=2){var r=t[i],a=t[i+1];if(r.test(e))return a}return null}},Object.assign(ln.prototype,{crossOrigin:void 0,extractUrlBase:function(e){var t=e.split("/");return 1===t.length?"./":(t.pop(),t.join("/")+"/")},initMaterials:function(e,t,i){for(var n=[],r=0;r<e.length;++r)n[r]=this.createMaterial(e[r],t,i);return n},createMaterial:function(){var e={NoBlending:ba,NormalBlending:Ca,AdditiveBlending:Ma,SubtractiveBlending:_a,MultiplyBlending:wa,CustomBlending:La},t=new j,i=new Ui,n=new on;return function(r,a,o){function s(e,t,n,r,s){var c,u=a+e,h=ln.Handlers.get(u);null!==h?c=h.load(u):(i.setCrossOrigin(o),c=i.load(u)),void 0!==t&&(c.repeat.fromArray(t),1!==t[0]&&(c.wrapS=fo),1!==t[1]&&(c.wrapT=fo)),void 0!==n&&c.offset.fromArray(n),void 0!==r&&("repeat"===r[0]&&(c.wrapS=fo),"mirror"===r[0]&&(c.wrapS=mo),"repeat"===r[1]&&(c.wrapT=fo),"mirror"===r[1]&&(c.wrapT=mo)),void 0!==s&&(c.anisotropy=s);var d=hs.generateUUID();return l[d]=c,d}var l={},c={uuid:hs.generateUUID(),type:"MeshLambertMaterial"};for(var u in r){var h=r[u];switch(u){case"DbgColor":case"DbgIndex":case"opticalDensity":case"illumination":break;case"DbgName":c.name=h;break;case"blending":c.blending=e[h];break;case"colorAmbient":case"mapAmbient":console.warn("THREE.Loader.createMaterial:",u,"is no longer supported.");break;case"colorDiffuse":c.color=t.fromArray(h).getHex();break;case"colorSpecular":c.specular=t.fromArray(h).getHex();break;case"colorEmissive":c.emissive=t.fromArray(h).getHex();break;case"specularCoef":c.shininess=h;break;case"shading":"basic"===h.toLowerCase()&&(c.type="MeshBasicMaterial"),"phong"===h.toLowerCase()&&(c.type="MeshPhongMaterial"),"standard"===h.toLowerCase()&&(c.type="MeshStandardMaterial");break;case"mapDiffuse":c.map=s(h,r.mapDiffuseRepeat,r.mapDiffuseOffset,r.mapDiffuseWrap,r.mapDiffuseAnisotropy);break;case"mapDiffuseRepeat":case"mapDiffuseOffset":case"mapDiffuseWrap":case"mapDiffuseAnisotropy":break;case"mapEmissive":c.emissiveMap=s(h,r.mapEmissiveRepeat,r.mapEmissiveOffset,r.mapEmissiveWrap,r.mapEmissiveAnisotropy);break;case"mapEmissiveRepeat":case"mapEmissiveOffset":case"mapEmissiveWrap":case"mapEmissiveAnisotropy":break;case"mapLight":c.lightMap=s(h,r.mapLightRepeat,r.mapLightOffset,r.mapLightWrap,r.mapLightAnisotropy);break;case"mapLightRepeat":case"mapLightOffset":case"mapLightWrap":case"mapLightAnisotropy":break;case"mapAO":c.aoMap=s(h,r.mapAORepeat,r.mapAOOffset,r.mapAOWrap,r.mapAOAnisotropy);break;case"mapAORepeat":case"mapAOOffset":case"mapAOWrap":case"mapAOAnisotropy":break;case"mapBump":c.bumpMap=s(h,r.mapBumpRepeat,r.mapBumpOffset,r.mapBumpWrap,r.mapBumpAnisotropy);break;case"mapBumpScale":c.bumpScale=h;break;case"mapBumpRepeat":case"mapBumpOffset":case"mapBumpWrap":case"mapBumpAnisotropy":break;case"mapNormal":c.normalMap=s(h,r.mapNormalRepeat,r.mapNormalOffset,r.mapNormalWrap,r.mapNormalAnisotropy);break;case"mapNormalFactor":c.normalScale=[h,h];break;case"mapNormalRepeat":case"mapNormalOffset":case"mapNormalWrap":case"mapNormalAnisotropy":break;case"mapSpecular":c.specularMap=s(h,r.mapSpecularRepeat,r.mapSpecularOffset,r.mapSpecularWrap,r.mapSpecularAnisotropy);break;case"mapSpecularRepeat":case"mapSpecularOffset":case"mapSpecularWrap":case"mapSpecularAnisotropy":break;case"mapMetalness":c.metalnessMap=s(h,r.mapMetalnessRepeat,r.mapMetalnessOffset,r.mapMetalnessWrap,r.mapMetalnessAnisotropy);break;case"mapMetalnessRepeat":case"mapMetalnessOffset":case"mapMetalnessWrap":case"mapMetalnessAnisotropy":break;case"mapRoughness":c.roughnessMap=s(h,r.mapRoughnessRepeat,r.mapRoughnessOffset,r.mapRoughnessWrap,r.mapRoughnessAnisotropy);break;case"mapRoughnessRepeat":case"mapRoughnessOffset":case"mapRoughnessWrap":case"mapRoughnessAnisotropy":break;case"mapAlpha":c.alphaMap=s(h,r.mapAlphaRepeat,r.mapAlphaOffset,r.mapAlphaWrap,r.mapAlphaAnisotropy);break;case"mapAlphaRepeat":case"mapAlphaOffset":case"mapAlphaWrap":case"mapAlphaAnisotropy":break;case"flipSided":c.side=pa;break;case"doubleSided":c.side=ma;break;case"transparency":console.warn("THREE.Loader.createMaterial: transparency has been renamed to opacity"),c.opacity=h;break;case"depthTest":case"depthWrite":case"colorWrite":case"opacity":case"reflectivity":case"transparent":case"visible":case"wireframe":c[u]=h;break;case"vertexColors":!0===h&&(c.vertexColors=xa),"face"===h&&(c.vertexColors=Ea);break;default:console.error("THREE.Loader.createMaterial: Unsupported",u,h)}}return"MeshBasicMaterial"===c.type&&delete c.emissive,"MeshPhongMaterial"!==c.type&&delete c.specular,c.opacity<1&&(c.transparent=!0),n.setTextures(l),n.parse(c)}}()}),Object.assign(cn.prototype,{load:function(e,t,i,n){var r=this,a=this.texturePath&&"string"==typeof this.texturePath?this.texturePath:ln.prototype.extractUrlBase(e),o=new Si(this.manager);o.setResponseType("json"),o.setWithCredentials(this.withCredentials),o.load(e,function(i){var n=i.metadata;if(void 0!==n){var o=n.type;if(void 0!==o){if("object"===o.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.ObjectLoader instead.");if("scene"===o.toLowerCase())return void console.error("THREE.JSONLoader: "+e+" should be loaded with THREE.SceneLoader instead.")}}var s=r.parse(i,a);t(s.geometry,s.materials)},i,n)},setTexturePath:function(e){this.texturePath=e},parse:function(){function e(e,t){function n(e,t){return e&1<<t}var r,a,o,s,c,u,h,d,f,p,m,g,v,y,E,x,b,C,M,_,w,L,T,I,S,O,D,R=e.faces,A=e.vertices,U=e.normals,B=e.colors,P=e.scale,N=0;if(void 0!==e.uvs){for(r=0;r<e.uvs.length;r++)e.uvs[r].length&&N++;for(r=0;r<N;r++)t.faceVertexUvs[r]=[]}for(s=0,c=A.length;s<c;)C=new l,C.x=A[s++]*P,C.y=A[s++]*P,C.z=A[s++]*P,t.vertices.push(C);for(s=0,c=R.length;s<c;)if(p=R[s++],m=n(p,0),g=n(p,1),v=n(p,3),y=n(p,4),E=n(p,5),x=n(p,6),b=n(p,7),m){if(_=new he,_.a=R[s],_.b=R[s+1],_.c=R[s+3],w=new he,w.a=R[s+1],w.b=R[s+2],w.c=R[s+3],s+=4,g&&(f=R[s++],_.materialIndex=f,w.materialIndex=f),o=t.faces.length,v)for(r=0;r<N;r++)for(I=e.uvs[r],t.faceVertexUvs[r][o]=[],t.faceVertexUvs[r][o+1]=[],a=0;a<4;a++)d=R[s++],O=I[2*d],D=I[2*d+1],S=new i(O,D),2!==a&&t.faceVertexUvs[r][o].push(S),0!==a&&t.faceVertexUvs[r][o+1].push(S);if(y&&(h=3*R[s++],_.normal.set(U[h++],U[h++],U[h]),w.normal.copy(_.normal)),E)for(r=0;r<4;r++)h=3*R[s++],T=new l(U[h++],U[h++],U[h]),2!==r&&_.vertexNormals.push(T),0!==r&&w.vertexNormals.push(T);if(x&&(u=R[s++],L=B[u],_.color.setHex(L),w.color.setHex(L)),b)for(r=0;r<4;r++)u=R[s++],L=B[u],2!==r&&_.vertexColors.push(new j(L)),0!==r&&w.vertexColors.push(new j(L));t.faces.push(_),t.faces.push(w)}else{if(M=new he,M.a=R[s++],M.b=R[s++],M.c=R[s++],g&&(f=R[s++],M.materialIndex=f),o=t.faces.length,v)for(r=0;r<N;r++)for(I=e.uvs[r],t.faceVertexUvs[r][o]=[],a=0;a<3;a++)d=R[s++],O=I[2*d],D=I[2*d+1],S=new i(O,D),t.faceVertexUvs[r][o].push(S);if(y&&(h=3*R[s++],M.normal.set(U[h++],U[h++],U[h])),E)for(r=0;r<3;r++)h=3*R[s++],T=new l(U[h++],U[h++],U[h]),M.vertexNormals.push(T);if(x&&(u=R[s++],M.color.setHex(B[u])),b)for(r=0;r<3;r++)u=R[s++],M.vertexColors.push(new j(B[u]));t.faces.push(M)}}function t(e,t){var i=void 0!==e.influencesPerVertex?e.influencesPerVertex:2;if(e.skinWeights)for(var n=0,a=e.skinWeights.length;n<a;n+=i){var o=e.skinWeights[n],s=i>1?e.skinWeights[n+1]:0,l=i>2?e.skinWeights[n+2]:0,c=i>3?e.skinWeights[n+3]:0;t.skinWeights.push(new r(o,s,l,c))}if(e.skinIndices)for(var n=0,a=e.skinIndices.length;n<a;n+=i){var u=e.skinIndices[n],h=i>1?e.skinIndices[n+1]:0,d=i>2?e.skinIndices[n+2]:0,f=i>3?e.skinIndices[n+3]:0;t.skinIndices.push(new r(u,h,d,f))}t.bones=e.bones,t.bones&&t.bones.length>0&&(t.skinWeights.length!==t.skinIndices.length||t.skinIndices.length!==t.vertices.length)&&console.warn("When skinning, number of vertices ("+t.vertices.length+"), skinIndices ("+t.skinIndices.length+"), and skinWeights ("+t.skinWeights.length+") should match.")}function n(e,t){var i=e.scale;if(void 0!==e.morphTargets)for(var n=0,r=e.morphTargets.length;n<r;n++){t.morphTargets[n]={},t.morphTargets[n].name=e.morphTargets[n].name,t.morphTargets[n].vertices=[];for(var a=t.morphTargets[n].vertices,o=e.morphTargets[n].vertices,s=0,c=o.length;s<c;s+=3){var u=new l;u.x=o[s]*i,u.y=o[s+1]*i,u.z=o[s+2]*i,a.push(u)}}if(void 0!==e.morphColors&&e.morphColors.length>0){console.warn('THREE.JSONLoader: "morphColors" no longer supported. Using them as face colors.');for(var h=t.faces,d=e.morphColors[0].colors,n=0,r=h.length;n<r;n++)h[n].color.fromArray(d,3*n)}}function a(e,t){var i=[],n=[];void 0!==e.animation&&n.push(e.animation),void 0!==e.animations&&(e.animations.length?n=n.concat(e.animations):n.push(e.animations));for(var r=0;r<n.length;r++){var a=an.parseAnimation(n[r],t.bones);a&&i.push(a)}if(t.morphTargets){var o=an.CreateClipsFromMorphTargetSequences(t.morphTargets,10);i=i.concat(o)}i.length>0&&(t.animations=i)}return function(i,r){void 0!==i.data&&(i=i.data),void 0!==i.scale?i.scale=1/i.scale:i.scale=1;var o=new Le;return e(i,o),t(i,o),n(i,o),a(i,o),o.computeFaceNormals(),o.computeBoundingSphere(),void 0===i.materials||0===i.materials.length?{geometry:o}:{geometry:o,materials:ln.prototype.initMaterials(i.materials,r,this.crossOrigin)}}}()}),Object.assign(un.prototype,{load:function(e,t,i,n){""===this.texturePath&&(this.texturePath=e.substring(0,e.lastIndexOf("/")+1));var r=this;new Si(r.manager).load(e,function(i){var a=null;try{a=JSON.parse(i)}catch(t){return void 0!==n&&n(t),void console.error("THREE:ObjectLoader: Can't parse "+e+".",t.message)}var o=a.metadata;if(void 0===o||void 0===o.type||"geometry"===o.type.toLowerCase())return void console.error("THREE.ObjectLoader: Can't load "+e+". Use THREE.JSONLoader instead.");r.parse(a,t)},i,n)},setTexturePath:function(e){this.texturePath=e},setCrossOrigin:function(e){this.crossOrigin=e},parse:function(e,t){var i=this.parseGeometries(e.geometries),n=this.parseImages(e.images,function(){void 0!==t&&t(o)}),r=this.parseTextures(e.textures,n),a=this.parseMaterials(e.materials,r),o=this.parseObject(e.object,i,a);return e.animations&&(o.animations=this.parseAnimations(e.animations)),void 0!==e.images&&0!==e.images.length||void 0!==t&&t(o),o},parseGeometries:function(e){var t={};if(void 0!==e)for(var i=new cn,n=new sn,r=0,a=e.length;r<a;r++){var o,s=e[r];switch(s.type){case"PlaneGeometry":case"PlaneBufferGeometry":o=new Os[s.type](s.width,s.height,s.widthSegments,s.heightSegments);break;case"BoxGeometry":case"BoxBufferGeometry":case"CubeGeometry":o=new Os[s.type](s.width,s.height,s.depth,s.widthSegments,s.heightSegments,s.depthSegments);break;case"CircleGeometry":case"CircleBufferGeometry":o=new Os[s.type](s.radius,s.segments,s.thetaStart,s.thetaLength);break;case"CylinderGeometry":case"CylinderBufferGeometry":o=new Os[s.type](s.radiusTop,s.radiusBottom,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"ConeGeometry":case"ConeBufferGeometry":o=new Os[s.type](s.radius,s.height,s.radialSegments,s.heightSegments,s.openEnded,s.thetaStart,s.thetaLength);break;case"SphereGeometry":case"SphereBufferGeometry":o=new Os[s.type](s.radius,s.widthSegments,s.heightSegments,s.phiStart,s.phiLength,s.thetaStart,s.thetaLength);break;case"DodecahedronGeometry":case"IcosahedronGeometry":case"OctahedronGeometry":case"TetrahedronGeometry":o=new Os[s.type](s.radius,s.detail);break;case"RingGeometry":case"RingBufferGeometry":o=new Os[s.type](s.innerRadius,s.outerRadius,s.thetaSegments,s.phiSegments,s.thetaStart,s.thetaLength);break;case"TorusGeometry":case"TorusBufferGeometry":o=new Os[s.type](s.radius,s.tube,s.radialSegments,s.tubularSegments,s.arc);break;case"TorusKnotGeometry":case"TorusKnotBufferGeometry":o=new Os[s.type](s.radius,s.tube,s.tubularSegments,s.radialSegments,s.p,s.q);break;case"LatheGeometry":case"LatheBufferGeometry":o=new Os[s.type](s.points,s.segments,s.phiStart,s.phiLength);break;case"BufferGeometry":o=n.parse(s);break;case"Geometry":o=i.parse(s,this.texturePath).geometry;break;default:console.warn('THREE.ObjectLoader: Unsupported geometry type "'+s.type+'"');continue}o.uuid=s.uuid,void 0!==s.name&&(o.name=s.name),t[s.uuid]=o}return t},parseMaterials:function(e,t){var i={};if(void 0!==e){var n=new on;n.setTextures(t);for(var r=0,a=e.length;r<a;r++){var o=e[r];if("MultiMaterial"===o.type){for(var s=[],l=0;l<o.materials.length;l++)s.push(n.parse(o.materials[l]));i[o.uuid]=s}else i[o.uuid]=n.parse(o)}}return i},parseAnimations:function(e){for(var t=[],i=0;i<e.length;i++){var n=an.parse(e[i]);t.push(n)}return t},parseImages:function(e,t){var i=this,n={};if(void 0!==e&&e.length>0){var r=new Ii(t),a=new Ri(r);a.setCrossOrigin(this.crossOrigin);for(var o=0,s=e.length;o<s;o++){var l=e[o],c=/^(\/\/)|([a-z]+:(\/\/)?)/i.test(l.url)?l.url:i.texturePath+l.url;n[l.uuid]=function(e){return i.manager.itemStart(e),a.load(e,function(){i.manager.itemEnd(e)},void 0,function(){i.manager.itemEnd(e),i.manager.itemError(e)})}(c)}}return n},parseTextures:function(e,t){function i(e,t){return"number"==typeof e?e:(console.warn("THREE.ObjectLoader.parseTexture: Constant should be in numeric form.",e),t[e])}var r={};if(void 0!==e)for(var a=0,o=e.length;a<o;a++){var s=e[a];void 0===s.image&&console.warn('THREE.ObjectLoader: No "image" specified for',s.uuid),void 0===t[s.image]&&console.warn("THREE.ObjectLoader: Undefined image",s.image);var l=new n(t[s.image]);l.needsUpdate=!0,l.uuid=s.uuid,void 0!==s.name&&(l.name=s.name),void 0!==s.mapping&&(l.mapping=i(s.mapping,Ns)),void 0!==s.offset&&l.offset.fromArray(s.offset),void 0!==s.repeat&&l.repeat.fromArray(s.repeat),void 0!==s.wrap&&(l.wrapS=i(s.wrap[0],ks),l.wrapT=i(s.wrap[1],ks)),void 0!==s.minFilter&&(l.minFilter=i(s.minFilter,Fs)),void 0!==s.magFilter&&(l.magFilter=i(s.magFilter,Fs)),void 0!==s.anisotropy&&(l.anisotropy=s.anisotropy),void 0!==s.flipY&&(l.flipY=s.flipY),r[s.uuid]=l}return r},parseObject:function(){var e=new c;return function(t,i,n){function r(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function a(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,r=e.length;i<r;i++){var a=e[i];void 0===n[a]&&console.warn("THREE.ObjectLoader: Undefined material",a),t.push(n[a])}return t}return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),n[e]}}var o;switch(t.type){case"Scene":o=new gt,void 0!==t.background&&Number.isInteger(t.background)&&(o.background=new j(t.background)),void 0!==t.fog&&("Fog"===t.fog.type?o.fog=new mt(t.fog.color,t.fog.near,t.fog.far):"FogExp2"===t.fog.type&&(o.fog=new pt(t.fog.color,t.fog.density)));break;case"PerspectiveCamera":o=new Ue(t.fov,t.aspect,t.near,t.far),void 0!==t.focus&&(o.focus=t.focus),void 0!==t.zoom&&(o.zoom=t.zoom),void 0!==t.filmGauge&&(o.filmGauge=t.filmGauge),void 0!==t.filmOffset&&(o.filmOffset=t.filmOffset),void 0!==t.view&&(o.view=Object.assign({},t.view));break;case"OrthographicCamera":o=new Be(t.left,t.right,t.top,t.bottom,t.near,t.far);break;case"AmbientLight":o=new zi(t.color,t.intensity);break;case"DirectionalLight":o=new Vi(t.color,t.intensity);break;case"PointLight":o=new Hi(t.color,t.intensity,t.distance,t.decay);break;case"RectAreaLight":o=new Wi(t.color,t.intensity,t.width,t.height);break;case"SpotLight":o=new Fi(t.color,t.intensity,t.distance,t.angle,t.penumbra,t.decay);break;case"HemisphereLight":o=new Pi(t.color,t.groundColor,t.intensity);break;case"SkinnedMesh":console.warn("THREE.ObjectLoader.parseObject() does not support SkinnedMesh yet.");case"Mesh":var s=r(t.geometry),l=a(t.material);o=s.bones&&s.bones.length>0?new Mt(s,l):new Ie(s,l);break;case"LOD":o=new xt;break;case"Line":o=new wt(r(t.geometry),a(t.material),t.mode);break;case"LineLoop":o=new Tt(r(t.geometry),a(t.material));break;case"LineSegments":o=new Lt(r(t.geometry),a(t.material));break;case"PointCloud":case"Points":o=new St(r(t.geometry),a(t.material));break;case"Sprite":o=new Et(a(t.material));break;case"Group":o=new Ot;break;default:o=new le}if(o.uuid=t.uuid,void 0!==t.name&&(o.name=t.name),void 0!==t.matrix?(e.fromArray(t.matrix),e.decompose(o.position,o.quaternion,o.scale)):(void 0!==t.position&&o.position.fromArray(t.position),void 0!==t.rotation&&o.rotation.fromArray(t.rotation),void 0!==t.quaternion&&o.quaternion.fromArray(t.quaternion),void 0!==t.scale&&o.scale.fromArray(t.scale)),void 0!==t.castShadow&&(o.castShadow=t.castShadow),void 0!==t.receiveShadow&&(o.receiveShadow=t.receiveShadow),t.shadow&&(void 0!==t.shadow.bias&&(o.shadow.bias=t.shadow.bias),void 0!==t.shadow.radius&&(o.shadow.radius=t.shadow.radius),void 0!==t.shadow.mapSize&&o.shadow.mapSize.fromArray(t.shadow.mapSize),void 0!==t.shadow.camera&&(o.shadow.camera=this.parseObject(t.shadow.camera))),void 0!==t.visible&&(o.visible=t.visible),void 0!==t.userData&&(o.userData=t.userData),void 0!==t.children)for(var c in t.children)o.add(this.parseObject(t.children[c],i,n));if("LOD"===t.type)for(var u=t.levels,h=0;h<u.length;h++){var d=u[h],c=o.getObjectByProperty("uuid",d.object);void 0!==c&&o.addLevel(c,d.distance)}return o}}()});var Ns={UVMapping:300,CubeReflectionMapping:ao,CubeRefractionMapping:oo,EquirectangularReflectionMapping:so,EquirectangularRefractionMapping:lo,SphericalReflectionMapping:co,CubeUVReflectionMapping:uo,CubeUVRefractionMapping:ho},ks={RepeatWrapping:fo,ClampToEdgeWrapping:po,MirroredRepeatWrapping:mo},Fs={NearestFilter:go,NearestMipMapNearestFilter:vo,NearestMipMapLinearFilter:yo,LinearFilter:Eo,LinearMipMapNearestFilter:xo,LinearMipMapLinearFilter:bo};Object.assign(bn.prototype,{getPoint:function(){return console.warn("THREE.Curve: .getPoint() not implemented."),null},getPointAt:function(e){var t=this.getUtoTmapping(e);return this.getPoint(t)},getPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return t},getSpacedPoints:function(e){void 0===e&&(e=5);for(var t=[],i=0;i<=e;i++)t.push(this.getPointAt(i/e));return t},getLength:function(){var e=this.getLengths();return e[e.length-1]},getLengths:function(e){if(void 0===e&&(e=this.arcLengthDivisions),this.cacheArcLengths&&this.cacheArcLengths.length===e+1&&!this.needsUpdate)return this.cacheArcLengths;this.needsUpdate=!1;var t,i,n=[],r=this.getPoint(0),a=0;for(n.push(0),i=1;i<=e;i++)t=this.getPoint(i/e),a+=t.distanceTo(r),n.push(a),r=t;return this.cacheArcLengths=n,n},updateArcLengths:function(){this.needsUpdate=!0,this.getLengths()},getUtoTmapping:function(e,t){var i,n=this.getLengths(),r=0,a=n.length;i=t||e*n[a-1];for(var o,s=0,l=a-1;s<=l;)if(r=Math.floor(s+(l-s)/2),(o=n[r]-i)<0)s=r+1;else{if(!(o>0)){l=r;break}l=r-1}if(r=l,n[r]===i)return r/(a-1);var c=n[r];return(r+(i-c)/(n[r+1]-c))/(a-1)},getTangent:function(e){var t=e-1e-4,i=e+1e-4;t<0&&(t=0),i>1&&(i=1);var n=this.getPoint(t);return this.getPoint(i).clone().sub(n).normalize()},getTangentAt:function(e){var t=this.getUtoTmapping(e);return this.getTangent(t)},computeFrenetFrames:function(e,t){var i,n,r,a=new l,o=[],s=[],u=[],h=new l,d=new c;for(i=0;i<=e;i++)n=i/e,o[i]=this.getTangentAt(n),o[i].normalize();s[0]=new l,u[0]=new l;var f=Number.MAX_VALUE,p=Math.abs(o[0].x),m=Math.abs(o[0].y),g=Math.abs(o[0].z);for(p<=f&&(f=p,a.set(1,0,0)),m<=f&&(f=m,a.set(0,1,0)),g<=f&&a.set(0,0,1),h.crossVectors(o[0],a).normalize(),s[0].crossVectors(o[0],h),u[0].crossVectors(o[0],s[0]),i=1;i<=e;i++)s[i]=s[i-1].clone(),u[i]=u[i-1].clone(),h.crossVectors(o[i-1],o[i]),h.length()>Number.EPSILON&&(h.normalize(),r=Math.acos(hs.clamp(o[i-1].dot(o[i]),-1,1)),s[i].applyMatrix4(d.makeRotationAxis(h,r))),u[i].crossVectors(o[i],s[i]);if(!0===t)for(r=Math.acos(hs.clamp(s[0].dot(s[e]),-1,1)),r/=e,o[0].dot(h.crossVectors(s[0],s[e]))>0&&(r=-r),i=1;i<=e;i++)s[i].applyMatrix4(d.makeRotationAxis(o[i],r*i)),u[i].crossVectors(o[i],s[i]);return{tangents:o,normals:s,binormals:u}}}),Cn.prototype=Object.create(bn.prototype),Cn.prototype.constructor=Cn,Cn.prototype.isLineCurve=!0,Cn.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=this.v2.clone().sub(this.v1);return t.multiplyScalar(e).add(this.v1),t},Cn.prototype.getPointAt=function(e){return this.getPoint(e)},Cn.prototype.getTangent=function(e){return this.v2.clone().sub(this.v1).normalize()},Mn.prototype=Object.assign(Object.create(bn.prototype),{constructor:Mn,add:function(e){this.curves.push(e)},closePath:function(){var e=this.curves[0].getPoint(0),t=this.curves[this.curves.length-1].getPoint(1);e.equals(t)||this.curves.push(new Cn(t,e))},getPoint:function(e){for(var t=e*this.getLength(),i=this.getCurveLengths(),n=0;n<i.length;){if(i[n]>=t){var r=i[n]-t,a=this.curves[n],o=a.getLength(),s=0===o?0:1-r/o;return a.getPointAt(s)}n++}return null},getLength:function(){var e=this.getCurveLengths();return e[e.length-1]},updateArcLengths:function(){this.needsUpdate=!0,this.cacheLengths=null,this.getCurveLengths()},getCurveLengths:function(){if(this.cacheLengths&&this.cacheLengths.length===this.curves.length)return this.cacheLengths;for(var e=[],t=0,i=0,n=this.curves.length;i<n;i++)t+=this.curves[i].getLength(),e.push(t);return this.cacheLengths=e,e},getSpacedPoints:function(e){void 0===e&&(e=40);for(var t=[],i=0;i<=e;i++)t.push(this.getPoint(i/e));return this.autoClose&&t.push(t[0]),t},getPoints:function(e){e=e||12;for(var t,i=[],n=0,r=this.curves;n<r.length;n++)for(var a=r[n],o=a&&a.isEllipseCurve?2*e:a&&a.isLineCurve?1:a&&a.isSplineCurve?e*a.points.length:e,s=a.getPoints(o),l=0;l<s.length;l++){var c=s[l];t&&t.equals(c)||(i.push(c),t=c)}return this.autoClose&&i.length>1&&!i[i.length-1].equals(i[0])&&i.push(i[0]),i},createPointsGeometry:function(e){var t=this.getPoints(e);return this.createGeometry(t)},createSpacedPointsGeometry:function(e){var t=this.getSpacedPoints(e);return this.createGeometry(t)},createGeometry:function(e){for(var t=new Le,i=0,n=e.length;i<n;i++){var r=e[i];t.vertices.push(new l(r.x,r.y,r.z||0))}return t}}),_n.prototype=Object.create(bn.prototype),_n.prototype.constructor=_n,_n.prototype.isEllipseCurve=!0,_n.prototype.getPoint=function(e){for(var t=2*Math.PI,n=this.aEndAngle-this.aStartAngle,r=Math.abs(n)<Number.EPSILON;n<0;)n+=t;for(;n>t;)n-=t;n<Number.EPSILON&&(n=r?0:t),!0!==this.aClockwise||r||(n===t?n=-t:n-=t);var a=this.aStartAngle+e*n,o=this.aX+this.xRadius*Math.cos(a),s=this.aY+this.yRadius*Math.sin(a);if(0!==this.aRotation){var l=Math.cos(this.aRotation),c=Math.sin(this.aRotation),u=o-this.aX,h=s-this.aY;o=u*l-h*c+this.aX,s=u*c+h*l+this.aY}return new i(o,s)},wn.prototype=Object.create(bn.prototype),wn.prototype.constructor=wn,wn.prototype.isSplineCurve=!0,wn.prototype.getPoint=function(e){var t=this.points,n=(t.length-1)*e,r=Math.floor(n),a=n-r,o=t[0===r?r:r-1],s=t[r],l=t[r>t.length-2?t.length-1:r+1],c=t[r>t.length-3?t.length-1:r+2];return new i(hn(a,o.x,s.x,l.x,c.x),hn(a,o.y,s.y,l.y,c.y))},Ln.prototype=Object.create(bn.prototype),Ln.prototype.constructor=Ln,Ln.prototype.getPoint=function(e){var t=this.v0,n=this.v1,r=this.v2,a=this.v3;return new i(xn(e,t.x,n.x,r.x,a.x),xn(e,t.y,n.y,r.y,a.y))},Tn.prototype=Object.create(bn.prototype),Tn.prototype.constructor=Tn,Tn.prototype.getPoint=function(e){var t=this.v0,n=this.v1,r=this.v2;return new i(mn(e,t.x,n.x,r.x),mn(e,t.y,n.y,r.y))};var Hs=Object.assign(Object.create(Mn.prototype),{fromPoints:function(e){this.moveTo(e[0].x,e[0].y);for(var t=1,i=e.length;t<i;t++)this.lineTo(e[t].x,e[t].y)},moveTo:function(e,t){this.currentPoint.set(e,t)},lineTo:function(e,t){var n=new Cn(this.currentPoint.clone(),new i(e,t));this.curves.push(n),this.currentPoint.set(e,t)},quadraticCurveTo:function(e,t,n,r){var a=new Tn(this.currentPoint.clone(),new i(e,t),new i(n,r));this.curves.push(a),this.currentPoint.set(n,r)},bezierCurveTo:function(e,t,n,r,a,o){var s=new Ln(this.currentPoint.clone(),new i(e,t),new i(n,r),new i(a,o));this.curves.push(s),this.currentPoint.set(a,o)},splineThru:function(e){var t=[this.currentPoint.clone()].concat(e),i=new wn(t);this.curves.push(i),this.currentPoint.copy(e[e.length-1])},arc:function(e,t,i,n,r,a){var o=this.currentPoint.x,s=this.currentPoint.y;this.absarc(e+o,t+s,i,n,r,a)},absarc:function(e,t,i,n,r,a){this.absellipse(e,t,i,i,n,r,a)},ellipse:function(e,t,i,n,r,a,o,s){var l=this.currentPoint.x,c=this.currentPoint.y;this.absellipse(e+l,t+c,i,n,r,a,o,s)},absellipse:function(e,t,i,n,r,a,o,s){var l=new _n(e,t,i,n,r,a,o,s);if(this.curves.length>0){var c=l.getPoint(0);c.equals(this.currentPoint)||this.lineTo(c.x,c.y)}this.curves.push(l);var u=l.getPoint(1);this.currentPoint.copy(u)}});In.prototype=Hs,Hs.constructor=In,Sn.prototype=Object.assign(Object.create(Hs),{constructor:Sn,getPointsHoles:function(e){for(var t=[],i=0,n=this.holes.length;i<n;i++)t[i]=this.holes[i].getPoints(e);return t},extractAllPoints:function(e){return{shape:this.getPoints(e),holes:this.getPointsHoles(e)}},extractPoints:function(e){return this.extractAllPoints(e)}}),Object.assign(On.prototype,{moveTo:function(e,t){this.currentPath=new In,this.subPaths.push(this.currentPath),this.currentPath.moveTo(e,t)},lineTo:function(e,t){this.currentPath.lineTo(e,t)},quadraticCurveTo:function(e,t,i,n){this.currentPath.quadraticCurveTo(e,t,i,n)},bezierCurveTo:function(e,t,i,n,r,a){this.currentPath.bezierCurveTo(e,t,i,n,r,a)},splineThru:function(e){this.currentPath.splineThru(e)},toShapes:function(e,t){function i(e){for(var t=[],i=0,n=e.length;i<n;i++){var r=e[i],a=new Sn;a.curves=r.curves,t.push(a)}return t}var n=Ss.isClockWise,r=this.subPaths;if(0===r.length)return[];if(!0===t)return i(r);var a,o,s,l=[];if(1===r.length)return o=r[0],s=new Sn,s.curves=o.curves,l.push(s),l;var c=!n(r[0].getPoints());c=e?!c:c;var u,h=[],d=[],f=[],p=0;d[p]=void 0,f[p]=[];for(var m=0,g=r.length;m<g;m++)o=r[m],u=o.getPoints(),a=n(u),a=e?!a:a,a?(!c&&d[p]&&p++,d[p]={s:new Sn,p:u},d[p].s.curves=o.curves,c&&p++,f[p]=[]):f[p].push({h:o,p:u[0]});if(!d[0])return i(r);if(d.length>1){for(var v=!1,y=[],E=0,x=d.length;E<x;E++)h[E]=[];for(var E=0,x=d.length;E<x;E++)for(var b=f[E],C=0;C<b.length;C++){for(var M=b[C],_=!0,w=0;w<d.length;w++)(function(e,t){for(var i=t.length,n=!1,r=i-1,a=0;a<i;r=a++){var o=t[r],s=t[a],l=s.x-o.x,c=s.y-o.y;if(Math.abs(c)>Number.EPSILON){if(c<0&&(o=t[a],l=-l,s=t[r],c=-c),e.y<o.y||e.y>s.y)continue;if(e.y===o.y){if(e.x===o.x)return!0}else{var u=c*(e.x-o.x)-l*(e.y-o.y);if(0===u)return!0;if(u<0)continue;n=!n}}else{if(e.y!==o.y)continue;if(s.x<=e.x&&e.x<=o.x||o.x<=e.x&&e.x<=s.x)return!0}}return n})(M.p,d[w].p)&&(E!==w&&y.push({froms:E,tos:w,hole:C}),_?(_=!1,h[w].push(M)):v=!0);_&&h[E].push(M)}y.length>0&&(v||(f=h))}for(var L,m=0,T=d.length;m<T;m++){s=d[m].s,l.push(s),L=f[m];for(var I=0,S=L.length;I<S;I++)s.holes.push(L[I].h)}return l}}),Object.assign(Dn.prototype,{isFont:!0,generateShapes:function(e,t,i){function n(e,t,i,n){var a=r.glyphs[e]||r.glyphs["?"];if(a){var o,s,l,c,u,h,d,f,p,m=new On,g=[];if(a.o)for(var v=a._cachedOutline||(a._cachedOutline=a.o.split(" ")),y=0,E=v.length;y<E;){var x=v[y++];switch(x){case"m":o=v[y++]*t+i,s=v[y++]*t+n,m.moveTo(o,s);break;case"l":o=v[y++]*t+i,s=v[y++]*t+n,m.lineTo(o,s);break;case"q":l=v[y++]*t+i,c=v[y++]*t+n,u=v[y++]*t+i,h=v[y++]*t+n,m.quadraticCurveTo(u,h,l,c),p=g[g.length-1],p&&(p.x,p.y);break;case"b":l=v[y++]*t+i,c=v[y++]*t+n,u=v[y++]*t+i,h=v[y++]*t+n,d=v[y++]*t+i,f=v[y++]*t+n,m.bezierCurveTo(u,h,d,f,l,c),p=g[g.length-1],p&&(p.x,p.y)}}return{offsetX:a.ha*t,path:m}}}void 0===t&&(t=100),void 0===i&&(i=4);for(var r=this.data,a=function(e){for(var i=String(e).split(""),a=t/r.resolution,o=(r.boundingBox.yMax-r.boundingBox.yMin+r.underlineThickness)*a,s=0,l=0,c=[],u=0;u<i.length;u++){var h=i[u];if("\n"===h)s=0,l-=o;else{var d=n(h,a,s,l);s+=d.offsetX,c.push(d.path)}}return c}(e),o=[],s=0,l=a.length;s<l;s++)Array.prototype.push.apply(o,a[s].toShapes());return o}}),Object.assign(Rn.prototype,{load:function(e,t,i,n){var r=this;new Si(this.manager).load(e,function(e){var i;try{i=JSON.parse(e)}catch(t){console.warn("THREE.FontLoader: typeface.js support is being deprecated. Use typeface.json instead."),i=JSON.parse(e.substring(65,e.length-2))}var n=r.parse(i);t&&t(n)},i,n)},parse:function(e){return new Dn(e)}});var Gs,Vs={getContext:function(){return void 0===Gs&&(Gs=new(window.AudioContext||window.webkitAudioContext)),Gs},setContext:function(e){Gs=e}};Object.assign(An.prototype,{load:function(e,t,i,n){var r=new Si(this.manager);r.setResponseType("arraybuffer"),r.load(e,function(e){Vs.getContext().decodeAudioData(e,function(e){t(e)})},i,n)}}),Object.assign(Un.prototype,{update:function(){var e,t,i,n,r,a,o,s,l=new c,u=new c;return function(c){if(e!==this||t!==c.focus||i!==c.fov||n!==c.aspect*this.aspect||r!==c.near||a!==c.far||o!==c.zoom||s!==this.eyeSep){e=this,t=c.focus,i=c.fov,n=c.aspect*this.aspect,r=c.near,a=c.far,o=c.zoom;var h=c.projectionMatrix.clone();s=this.eyeSep/2;var d,f,p=s*r/t,m=r*Math.tan(hs.DEG2RAD*i*.5)/o;u.elements[12]=-s,l.elements[12]=s,d=-m*n+p,f=m*n+p,h.elements[0]=2*r/(f-d),h.elements[8]=(f+d)/(f-d),this.cameraL.projectionMatrix.copy(h),d=-m*n-p,f=m*n-p,h.elements[0]=2*r/(f-d),h.elements[8]=(f+d)/(f-d),this.cameraR.projectionMatrix.copy(h)}this.cameraL.matrixWorld.copy(c.matrixWorld).multiply(u),this.cameraR.matrixWorld.copy(c.matrixWorld).multiply(l)}}()}),Bn.prototype=Object.create(le.prototype),Bn.prototype.constructor=Bn,Pn.prototype=Object.assign(Object.create(Ue.prototype),{constructor:Pn,isArrayCamera:!0}),Nn.prototype=Object.assign(Object.create(le.prototype),{constructor:Nn,getInput:function(){return this.gain},removeFilter:function(){null!==this.filter&&(this.gain.disconnect(this.filter),this.filter.disconnect(this.context.destination),this.gain.connect(this.context.destination),this.filter=null)},getFilter:function(){return this.filter},setFilter:function(e){null!==this.filter?(this.gain.disconnect(this.filter),
this.filter.disconnect(this.context.destination)):this.gain.disconnect(this.context.destination),this.filter=e,this.gain.connect(this.filter),this.filter.connect(this.context.destination)},getMasterVolume:function(){return this.gain.gain.value},setMasterVolume:function(e){this.gain.gain.value=e},updateMatrixWorld:function(){var e=new l,t=new s,i=new l,n=new l;return function(r){le.prototype.updateMatrixWorld.call(this,r);var a=this.context.listener,o=this.up;this.matrixWorld.decompose(e,t,i),n.set(0,0,-1).applyQuaternion(t),a.positionX?(a.positionX.setValueAtTime(e.x,this.context.currentTime),a.positionY.setValueAtTime(e.y,this.context.currentTime),a.positionZ.setValueAtTime(e.z,this.context.currentTime),a.forwardX.setValueAtTime(n.x,this.context.currentTime),a.forwardY.setValueAtTime(n.y,this.context.currentTime),a.forwardZ.setValueAtTime(n.z,this.context.currentTime),a.upX.setValueAtTime(o.x,this.context.currentTime),a.upY.setValueAtTime(o.y,this.context.currentTime),a.upZ.setValueAtTime(o.z,this.context.currentTime)):(a.setPosition(e.x,e.y,e.z),a.setOrientation(n.x,n.y,n.z,o.x,o.y,o.z))}}()}),kn.prototype=Object.assign(Object.create(le.prototype),{constructor:kn,getOutput:function(){return this.gain},setNodeSource:function(e){return this.hasPlaybackControl=!1,this.sourceType="audioNode",this.source=e,this.connect(),this},setBuffer:function(e){return this.buffer=e,this.sourceType="buffer",this.autoplay&&this.play(),this},play:function(){if(!0===this.isPlaying)return void console.warn("THREE.Audio: Audio is already playing.");if(!1===this.hasPlaybackControl)return void console.warn("THREE.Audio: this Audio has no playback control.");var e=this.context.createBufferSource();return e.buffer=this.buffer,e.loop=this.loop,e.onended=this.onEnded.bind(this),e.playbackRate.setValueAtTime(this.playbackRate,this.startTime),e.start(0,this.startTime),this.isPlaying=!0,this.source=e,this.connect()},pause:function(){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=this.context.currentTime,this.isPlaying=!1,this)},stop:function(){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.source.stop(),this.startTime=0,this.isPlaying=!1,this)},connect:function(){if(this.filters.length>0){this.source.connect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].connect(this.filters[e]);this.filters[this.filters.length-1].connect(this.getOutput())}else this.source.connect(this.getOutput());return this},disconnect:function(){if(this.filters.length>0){this.source.disconnect(this.filters[0]);for(var e=1,t=this.filters.length;e<t;e++)this.filters[e-1].disconnect(this.filters[e]);this.filters[this.filters.length-1].disconnect(this.getOutput())}else this.source.disconnect(this.getOutput());return this},getFilters:function(){return this.filters},setFilters:function(e){return e||(e=[]),!0===this.isPlaying?(this.disconnect(),this.filters=e,this.connect()):this.filters=e,this},getFilter:function(){return this.getFilters()[0]},setFilter:function(e){return this.setFilters(e?[e]:[])},setPlaybackRate:function(e){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.playbackRate=e,!0===this.isPlaying&&this.source.playbackRate.setValueAtTime(this.playbackRate,this.context.currentTime),this)},getPlaybackRate:function(){return this.playbackRate},onEnded:function(){this.isPlaying=!1},getLoop:function(){return!1===this.hasPlaybackControl?(console.warn("THREE.Audio: this Audio has no playback control."),!1):this.loop},setLoop:function(e){return!1===this.hasPlaybackControl?void console.warn("THREE.Audio: this Audio has no playback control."):(this.loop=e,!0===this.isPlaying&&(this.source.loop=this.loop),this)},getVolume:function(){return this.gain.gain.value},setVolume:function(e){return this.gain.gain.value=e,this}}),Fn.prototype=Object.assign(Object.create(kn.prototype),{constructor:Fn,getOutput:function(){return this.panner},getRefDistance:function(){return this.panner.refDistance},setRefDistance:function(e){this.panner.refDistance=e},getRolloffFactor:function(){return this.panner.rolloffFactor},setRolloffFactor:function(e){this.panner.rolloffFactor=e},getDistanceModel:function(){return this.panner.distanceModel},setDistanceModel:function(e){this.panner.distanceModel=e},getMaxDistance:function(){return this.panner.maxDistance},setMaxDistance:function(e){this.panner.maxDistance=e},updateMatrixWorld:function(){var e=new l;return function(t){le.prototype.updateMatrixWorld.call(this,t),e.setFromMatrixPosition(this.matrixWorld),this.panner.setPosition(e.x,e.y,e.z)}}()}),Object.assign(Hn.prototype,{getFrequencyData:function(){return this.analyser.getByteFrequencyData(this.data),this.data},getAverageFrequency:function(){for(var e=0,t=this.getFrequencyData(),i=0;i<t.length;i++)e+=t[i];return e/t.length}}),Object.assign(Gn.prototype,{accumulate:function(e,t){var i=this.buffer,n=this.valueSize,r=e*n+n,a=this.cumulativeWeight;if(0===a){for(var o=0;o!==n;++o)i[r+o]=i[o];a=t}else{a+=t;var s=t/a;this._mixBufferRegion(i,r,0,s,n)}this.cumulativeWeight=a},apply:function(e){var t=this.valueSize,i=this.buffer,n=e*t+t,r=this.cumulativeWeight,a=this.binding;if(this.cumulativeWeight=0,r<1){var o=3*t;this._mixBufferRegion(i,n,o,1-r,t)}for(var s=t,l=t+t;s!==l;++s)if(i[s]!==i[s+t]){a.setValue(i,n);break}},saveOriginalState:function(){var e=this.binding,t=this.buffer,i=this.valueSize,n=3*i;e.getValue(t,n);for(var r=i,a=n;r!==a;++r)t[r]=t[n+r%i];this.cumulativeWeight=0},restoreOriginalState:function(){var e=3*this.valueSize;this.binding.setValue(this.buffer,e)},_select:function(e,t,i,n,r){if(n>=.5)for(var a=0;a!==r;++a)e[t+a]=e[i+a]},_slerp:function(e,t,i,n){s.slerpFlat(e,t,e,t,e,i,n)},_lerp:function(e,t,i,n,r){for(var a=1-n,o=0;o!==r;++o){var s=t+o;e[s]=e[s]*a+e[i+o]*n}}}),Object.assign(Vn.prototype,{getValue:function(e,t){this.bind();var i=this._targetGroup.nCachedObjects_,n=this._bindings[i];void 0!==n&&n.getValue(e,t)},setValue:function(e,t){for(var i=this._bindings,n=this._targetGroup.nCachedObjects_,r=i.length;n!==r;++n)i[n].setValue(e,t)},bind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].bind()},unbind:function(){for(var e=this._bindings,t=this._targetGroup.nCachedObjects_,i=e.length;t!==i;++t)e[t].unbind()}}),Object.assign(zn,{Composite:Vn,create:function(e,t,i){return e&&e.isAnimationObjectGroup?new zn.Composite(e,t,i):new zn(e,t,i)},parseTrackName:function(){var e=/((?:[\w-]+[\/:])*)/,t=/([\w-\.]+)?/,i=/(?:\.([\w-]+)(?:\[(.+)\])?)?/,n=/\.([\w-]+)(?:\[(.+)\])?/,r=new RegExp("^"+e.source+t.source+i.source+n.source+"$"),a=["material","materials","bones"];return function(e){var t=r.exec(e);if(!t)throw new Error("PropertyBinding: Cannot parse trackName: "+e);var i={nodeName:t[2],objectName:t[3],objectIndex:t[4],propertyName:t[5],propertyIndex:t[6]},n=i.nodeName&&i.nodeName.lastIndexOf(".");if(void 0!==n&&-1!==n){var o=i.nodeName.substring(n+1);-1!==a.indexOf(o)&&(i.nodeName=i.nodeName.substring(0,n),i.objectName=o)}if(null===i.propertyName||0===i.propertyName.length)throw new Error("PropertyBinding: can not parse propertyName from trackName: "+e);return i}}(),findNode:function(e,t){if(!t||""===t||"root"===t||"."===t||-1===t||t===e.name||t===e.uuid)return e;if(e.skeleton){var i=function(e){for(var i=0;i<e.bones.length;i++){var n=e.bones[i];if(n.name===t)return n}return null}(e.skeleton);if(i)return i}if(e.children){var n=function e(i){for(var n=0;n<i.length;n++){var r=i[n];if(r.name===t||r.uuid===t)return r;var a=e(r.children);if(a)return a}return null}(e.children);if(n)return n}return null}}),Object.assign(zn.prototype,{_getValue_unavailable:function(){},_setValue_unavailable:function(){},BindingType:{Direct:0,EntireArray:1,ArrayElement:2,HasFromToArray:3},Versioning:{None:0,NeedsUpdate:1,MatrixWorldNeedsUpdate:2},GetterByBindingType:[function(e,t){e[t]=this.node[this.propertyName]},function(e,t){for(var i=this.resolvedProperty,n=0,r=i.length;n!==r;++n)e[t++]=i[n]},function(e,t){e[t]=this.resolvedProperty[this.propertyIndex]},function(e,t){this.resolvedProperty.toArray(e,t)}],SetterByBindingTypeAndVersioning:[[function(e,t){this.node[this.propertyName]=e[t]},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.node[this.propertyName]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){for(var i=this.resolvedProperty,n=0,r=i.length;n!==r;++n)i[n]=e[t++]},function(e,t){for(var i=this.resolvedProperty,n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.needsUpdate=!0},function(e,t){for(var i=this.resolvedProperty,n=0,r=i.length;n!==r;++n)i[n]=e[t++];this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty[this.propertyIndex]=e[t]},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty[this.propertyIndex]=e[t],this.targetObject.matrixWorldNeedsUpdate=!0}],[function(e,t){this.resolvedProperty.fromArray(e,t)},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.needsUpdate=!0},function(e,t){this.resolvedProperty.fromArray(e,t),this.targetObject.matrixWorldNeedsUpdate=!0}]],getValue:function(e,t){this.bind(),this.getValue(e,t)},setValue:function(e,t){this.bind(),this.setValue(e,t)},bind:function(){var e=this.node,t=this.parsedPath,i=t.objectName,n=t.propertyName,r=t.propertyIndex;if(e||(e=zn.findNode(this.rootNode,t.nodeName)||this.rootNode,this.node=e),this.getValue=this._getValue_unavailable,this.setValue=this._setValue_unavailable,!e)return void console.error("  trying to update node for track: "+this.path+" but it wasn't found.");if(i){var a=t.objectIndex;switch(i){case"materials":if(!e.material)return void console.error("  can not bind to material as node does not have a material",this);if(!e.material.materials)return void console.error("  can not bind to material.materials as node.material does not have a materials array",this);e=e.material.materials;break;case"bones":if(!e.skeleton)return void console.error("  can not bind to bones as node does not have a skeleton",this);e=e.skeleton.bones;for(var o=0;o<e.length;o++)if(e[o].name===a){a=o;break}break;default:if(void 0===e[i])return void console.error("  can not bind to objectName of node, undefined",this);e=e[i]}if(void 0!==a){if(void 0===e[a])return void console.error("  trying to bind to objectIndex of objectName, but is undefined:",this,e);e=e[a]}}var s=e[n];if(void 0===s){var l=t.nodeName;return void console.error("  trying to update property for track: "+l+"."+n+" but it wasn't found.",e)}var c=this.Versioning.None;void 0!==e.needsUpdate?(c=this.Versioning.NeedsUpdate,this.targetObject=e):void 0!==e.matrixWorldNeedsUpdate&&(c=this.Versioning.MatrixWorldNeedsUpdate,this.targetObject=e);var u=this.BindingType.Direct;if(void 0!==r){if("morphTargetInfluences"===n){if(!e.geometry)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry",this);if(!e.geometry.morphTargets)return void console.error("  can not bind to morphTargetInfluences becasuse node does not have a geometry.morphTargets",this);for(var o=0;o<this.node.geometry.morphTargets.length;o++)if(e.geometry.morphTargets[o].name===r){r=o;break}}u=this.BindingType.ArrayElement,this.resolvedProperty=s,this.propertyIndex=r}else void 0!==s.fromArray&&void 0!==s.toArray?(u=this.BindingType.HasFromToArray,this.resolvedProperty=s):Array.isArray(s)?(u=this.BindingType.EntireArray,this.resolvedProperty=s):this.propertyName=n;this.getValue=this.GetterByBindingType[u],this.setValue=this.SetterByBindingTypeAndVersioning[u][c]},unbind:function(){this.node=null,this.getValue=this._getValue_unbound,this.setValue=this._setValue_unbound}}),Object.assign(zn.prototype,{_getValue_unbound:zn.prototype.getValue,_setValue_unbound:zn.prototype.setValue}),Object.assign(Wn.prototype,{isAnimationObjectGroup:!0,add:function(e){for(var t=this._objects,i=t.length,n=this.nCachedObjects_,r=this._indicesByUUID,a=this._paths,o=this._parsedPaths,s=this._bindings,l=s.length,c=0,u=arguments.length;c!==u;++c){var h=arguments[c],d=h.uuid,f=r[d],p=void 0;if(void 0===f){f=i++,r[d]=f,t.push(h);for(var m=0,g=l;m!==g;++m)s[m].push(new zn(h,a[m],o[m]))}else if(f<n){p=t[f];var v=--n,y=t[v];r[y.uuid]=f,t[f]=y,r[d]=v,t[v]=h;for(var m=0,g=l;m!==g;++m){var E=s[m],x=E[v],b=E[f];E[f]=x,void 0===b&&(b=new zn(h,a[m],o[m])),E[v]=b}}else t[f]!==p&&console.error("Different objects with the same UUID detected. Clean the caches or recreate your infrastructure when reloading scenes...")}this.nCachedObjects_=n},remove:function(e){for(var t=this._objects,i=this.nCachedObjects_,n=this._indicesByUUID,r=this._bindings,a=r.length,o=0,s=arguments.length;o!==s;++o){var l=arguments[o],c=l.uuid,u=n[c];if(void 0!==u&&u>=i){var h=i++,d=t[h];n[d.uuid]=u,t[u]=d,n[c]=h,t[h]=l;for(var f=0,p=a;f!==p;++f){var m=r[f],g=m[h],v=m[u];m[u]=g,m[h]=v}}}this.nCachedObjects_=i},uncache:function(e){for(var t=this._objects,i=t.length,n=this.nCachedObjects_,r=this._indicesByUUID,a=this._bindings,o=a.length,s=0,l=arguments.length;s!==l;++s){var c=arguments[s],u=c.uuid,h=r[u];if(void 0!==h)if(delete r[u],h<n){var d=--n,f=t[d],p=--i,m=t[p];r[f.uuid]=h,t[h]=f,r[m.uuid]=d,t[d]=m,t.pop();for(var g=0,v=o;g!==v;++g){var y=a[g],E=y[d],x=y[p];y[h]=E,y[d]=x,y.pop()}}else{var p=--i,m=t[p];r[m.uuid]=h,t[h]=m,t.pop();for(var g=0,v=o;g!==v;++g){var y=a[g];y[h]=y[p],y.pop()}}}this.nCachedObjects_=n},subscribe_:function(e,t){var i=this._bindingsIndicesByPath,n=i[e],r=this._bindings;if(void 0!==n)return r[n];var a=this._paths,o=this._parsedPaths,s=this._objects,l=s.length,c=this.nCachedObjects_,u=new Array(l);n=r.length,i[e]=n,a.push(e),o.push(t),r.push(u);for(var h=c,d=s.length;h!==d;++h){var f=s[h];u[h]=new zn(f,e,t)}return u},unsubscribe_:function(e){var t=this._bindingsIndicesByPath,i=t[e];if(void 0!==i){var n=this._paths,r=this._parsedPaths,a=this._bindings,o=a.length-1,s=a[o];t[e[o]]=i,a[i]=s,a.pop(),r[i]=r[o],r.pop(),n[i]=n[o],n.pop()}}}),Object.assign(qn.prototype,{play:function(){return this._mixer._activateAction(this),this},stop:function(){return this._mixer._deactivateAction(this),this.reset()},reset:function(){return this.paused=!1,this.enabled=!0,this.time=0,this._loopCount=-1,this._startTime=null,this.stopFading().stopWarping()},isRunning:function(){return this.enabled&&!this.paused&&0!==this.timeScale&&null===this._startTime&&this._mixer._isActiveAction(this)},isScheduled:function(){return this._mixer._isActiveAction(this)},startAt:function(e){return this._startTime=e,this},setLoop:function(e,t){return this.loop=e,this.repetitions=t,this},setEffectiveWeight:function(e){return this.weight=e,this._effectiveWeight=this.enabled?e:0,this.stopFading()},getEffectiveWeight:function(){return this._effectiveWeight},fadeIn:function(e){return this._scheduleFading(e,0,1)},fadeOut:function(e){return this._scheduleFading(e,1,0)},crossFadeFrom:function(e,t,i){if(e.fadeOut(t),this.fadeIn(t),i){var n=this._clip.duration,r=e._clip.duration,a=r/n,o=n/r;e.warp(1,a,t),this.warp(o,1,t)}return this},crossFadeTo:function(e,t,i){return e.crossFadeFrom(this,t,i)},stopFading:function(){var e=this._weightInterpolant;return null!==e&&(this._weightInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},setEffectiveTimeScale:function(e){return this.timeScale=e,this._effectiveTimeScale=this.paused?0:e,this.stopWarping()},getEffectiveTimeScale:function(){return this._effectiveTimeScale},setDuration:function(e){return this.timeScale=this._clip.duration/e,this.stopWarping()},syncWith:function(e){return this.time=e.time,this.timeScale=e.timeScale,this.stopWarping()},halt:function(e){return this.warp(this._effectiveTimeScale,0,e)},warp:function(e,t,i){var n=this._mixer,r=n.time,a=this._timeScaleInterpolant,o=this.timeScale;null===a&&(a=n._lendControlInterpolant(),this._timeScaleInterpolant=a);var s=a.parameterPositions,l=a.sampleValues;return s[0]=r,s[1]=r+i,l[0]=e/o,l[1]=t/o,this},stopWarping:function(){var e=this._timeScaleInterpolant;return null!==e&&(this._timeScaleInterpolant=null,this._mixer._takeBackControlInterpolant(e)),this},getMixer:function(){return this._mixer},getClip:function(){return this._clip},getRoot:function(){return this._localRoot||this._mixer._root},_update:function(e,t,i,n){if(!this.enabled)return void this._updateWeight(e);var r=this._startTime;if(null!==r){var a=(e-r)*i;if(a<0||0===i)return;this._startTime=null,t=i*a}t*=this._updateTimeScale(e);var o=this._updateTime(t),s=this._updateWeight(e);if(s>0)for(var l=this._interpolants,c=this._propertyBindings,u=0,h=l.length;u!==h;++u)l[u].evaluate(o),c[u].accumulate(n,s)},_updateWeight:function(e){var t=0;if(this.enabled){t=this.weight;var i=this._weightInterpolant;if(null!==i){var n=i.evaluate(e)[0];t*=n,e>i.parameterPositions[1]&&(this.stopFading(),0===n&&(this.enabled=!1))}}return this._effectiveWeight=t,t},_updateTimeScale:function(e){var t=0;if(!this.paused){t=this.timeScale;var i=this._timeScaleInterpolant;if(null!==i){t*=i.evaluate(e)[0],e>i.parameterPositions[1]&&(this.stopWarping(),0===t?this.paused=!0:this.timeScale=t)}}return this._effectiveTimeScale=t,t},_updateTime:function(e){var t=this.time+e;if(0===e)return t;var i=this._clip.duration,n=this.loop,r=this._loopCount;if(2200===n){-1===r&&(this._loopCount=0,this._setEndings(!0,!0,!1));e:{if(t>=i)t=i;else{if(!(t<0))break e;t=0}this.clampWhenFinished?this.paused=!0:this.enabled=!1,this._mixer.dispatchEvent({type:"finished",action:this,direction:e<0?-1:1})}}else{var a=2202===n;if(-1===r&&(e>=0?(r=0,this._setEndings(!0,0===this.repetitions,a)):this._setEndings(0===this.repetitions,!0,a)),t>=i||t<0){var o=Math.floor(t/i);t-=i*o,r+=Math.abs(o);var s=this.repetitions-r;if(s<0)this.clampWhenFinished?this.paused=!0:this.enabled=!1,t=e>0?i:0,this._mixer.dispatchEvent({type:"finished",action:this,direction:e>0?1:-1});else{if(0===s){var l=e<0;this._setEndings(l,!l,a)}else this._setEndings(!1,!1,a);this._loopCount=r,this._mixer.dispatchEvent({type:"loop",action:this,loopDelta:o})}}if(a&&1==(1&r))return this.time=t,i-t}return this.time=t,t},_setEndings:function(e,t,i){var n=this._interpolantSettings;i?(n.endingStart=2401,n.endingEnd=2401):(n.endingStart=e?this.zeroSlopeAtStart?2401:Jo:2402,n.endingEnd=t?this.zeroSlopeAtEnd?2401:Jo:2402)},_scheduleFading:function(e,t,i){var n=this._mixer,r=n.time,a=this._weightInterpolant;null===a&&(a=n._lendControlInterpolant(),this._weightInterpolant=a);var o=a.parameterPositions,s=a.sampleValues;return o[0]=r,s[0]=t,o[1]=r+e,s[1]=i,this}}),Object.assign(jn.prototype,t.prototype,{_bindAction:function(e,t){var i=e._localRoot||this._root,n=e._clip.tracks,r=n.length,a=e._propertyBindings,o=e._interpolants,s=i.uuid,l=this._bindingsByRootAndName,c=l[s];void 0===c&&(c={},l[s]=c);for(var u=0;u!==r;++u){var h=n[u],d=h.name,f=c[d];if(void 0!==f)a[u]=f;else{if(void 0!==(f=a[u])){null===f._cacheIndex&&(++f.referenceCount,this._addInactiveBinding(f,s,d));continue}var p=t&&t._propertyBindings[u].binding.parsedPath;f=new Gn(zn.create(i,d,p),h.ValueTypeName,h.getValueSize()),++f.referenceCount,this._addInactiveBinding(f,s,d),a[u]=f}o[u].resultBuffer=f.buffer}},_activateAction:function(e){if(!this._isActiveAction(e)){if(null===e._cacheIndex){var t=(e._localRoot||this._root).uuid,i=e._clip.uuid,n=this._actionsByClip[i];this._bindAction(e,n&&n.knownActions[0]),this._addInactiveAction(e,i,t)}for(var r=e._propertyBindings,a=0,o=r.length;a!==o;++a){var s=r[a];0==s.useCount++&&(this._lendBinding(s),s.saveOriginalState())}this._lendAction(e)}},_deactivateAction:function(e){if(this._isActiveAction(e)){for(var t=e._propertyBindings,i=0,n=t.length;i!==n;++i){var r=t[i];0==--r.useCount&&(r.restoreOriginalState(),this._takeBackBinding(r))}this._takeBackAction(e)}},_initMemoryManager:function(){this._actions=[],this._nActiveActions=0,this._actionsByClip={},this._bindings=[],this._nActiveBindings=0,this._bindingsByRootAndName={},this._controlInterpolants=[],this._nActiveControlInterpolants=0;var e=this;this.stats={actions:{get total(){return e._actions.length},get inUse(){return e._nActiveActions}},bindings:{get total(){return e._bindings.length},get inUse(){return e._nActiveBindings}},controlInterpolants:{get total(){return e._controlInterpolants.length},get inUse(){return e._nActiveControlInterpolants}}}},_isActiveAction:function(e){var t=e._cacheIndex;return null!==t&&t<this._nActiveActions},_addInactiveAction:function(e,t,i){var n=this._actions,r=this._actionsByClip,a=r[t];if(void 0===a)a={knownActions:[e],actionByRoot:{}},e._byClipCacheIndex=0,r[t]=a;else{var o=a.knownActions;e._byClipCacheIndex=o.length,o.push(e)}e._cacheIndex=n.length,n.push(e),a.actionByRoot[i]=e},_removeInactiveAction:function(e){var t=this._actions,i=t[t.length-1],n=e._cacheIndex;i._cacheIndex=n,t[n]=i,t.pop(),e._cacheIndex=null;var r=e._clip.uuid,a=this._actionsByClip,o=a[r],s=o.knownActions,l=s[s.length-1],c=e._byClipCacheIndex;l._byClipCacheIndex=c,s[c]=l,s.pop(),e._byClipCacheIndex=null,delete o.actionByRoot[(e._localRoot||this._root).uuid],0===s.length&&delete a[r],this._removeInactiveBindingsForAction(e)},_removeInactiveBindingsForAction:function(e){for(var t=e._propertyBindings,i=0,n=t.length;i!==n;++i){var r=t[i];0==--r.referenceCount&&this._removeInactiveBinding(r)}},_lendAction:function(e){var t=this._actions,i=e._cacheIndex,n=this._nActiveActions++,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r},_takeBackAction:function(e){var t=this._actions,i=e._cacheIndex,n=--this._nActiveActions,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r},_addInactiveBinding:function(e,t,i){var n=this._bindingsByRootAndName,r=n[t],a=this._bindings;void 0===r&&(r={},n[t]=r),r[i]=e,e._cacheIndex=a.length,a.push(e)},_removeInactiveBinding:function(e){var t=this._bindings,i=e.binding,n=i.rootNode.uuid,r=i.path,a=this._bindingsByRootAndName,o=a[n],s=t[t.length-1],l=e._cacheIndex;s._cacheIndex=l,t[l]=s,t.pop(),delete o[r];e:{for(var c in o)break e;delete a[n]}},_lendBinding:function(e){var t=this._bindings,i=e._cacheIndex,n=this._nActiveBindings++,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r},_takeBackBinding:function(e){var t=this._bindings,i=e._cacheIndex,n=--this._nActiveBindings,r=t[n];e._cacheIndex=n,t[n]=e,r._cacheIndex=i,t[i]=r},_lendControlInterpolant:function(){var e=this._controlInterpolants,t=this._nActiveControlInterpolants++,i=e[t];return void 0===i&&(i=new Xi(new Float32Array(2),new Float32Array(2),1,this._controlInterpolantsResultBuffer),i.__cacheIndex=t,e[t]=i),i},_takeBackControlInterpolant:function(e){var t=this._controlInterpolants,i=e.__cacheIndex,n=--this._nActiveControlInterpolants,r=t[n];e.__cacheIndex=n,t[n]=e,r.__cacheIndex=i,t[i]=r},_controlInterpolantsResultBuffer:new Float32Array(1),clipAction:function(e,t){var i=t||this._root,n=i.uuid,r="string"==typeof e?an.findByName(i,e):e,a=null!==r?r.uuid:e,o=this._actionsByClip[a],s=null;if(void 0!==o){var l=o.actionByRoot[n];if(void 0!==l)return l;s=o.knownActions[0],null===r&&(r=s._clip)}if(null===r)return null;var c=new qn(this,r,t);return this._bindAction(c,s),this._addInactiveAction(c,a,n),c},existingAction:function(e,t){var i=t||this._root,n=i.uuid,r="string"==typeof e?an.findByName(i,e):e,a=r?r.uuid:e,o=this._actionsByClip[a];return void 0!==o?o.actionByRoot[n]||null:null},stopAllAction:function(){var e=this._actions,t=this._nActiveActions,i=this._bindings,n=this._nActiveBindings;this._nActiveActions=0,this._nActiveBindings=0;for(var r=0;r!==t;++r)e[r].reset();for(var r=0;r!==n;++r)i[r].useCount=0;return this},update:function(e){e*=this.timeScale;for(var t=this._actions,i=this._nActiveActions,n=this.time+=e,r=Math.sign(e),a=this._accuIndex^=1,o=0;o!==i;++o){t[o]._update(n,e,r,a)}for(var s=this._bindings,l=this._nActiveBindings,o=0;o!==l;++o)s[o].apply(a);return this},getRoot:function(){return this._root},uncacheClip:function(e){var t=this._actions,i=e.uuid,n=this._actionsByClip,r=n[i];if(void 0!==r){for(var a=r.knownActions,o=0,s=a.length;o!==s;++o){var l=a[o];this._deactivateAction(l);var c=l._cacheIndex,u=t[t.length-1];l._cacheIndex=null,l._byClipCacheIndex=null,u._cacheIndex=c,t[c]=u,t.pop(),this._removeInactiveBindingsForAction(l)}delete n[i]}},uncacheRoot:function(e){var t=e.uuid,i=this._actionsByClip;for(var n in i){var r=i[n].actionByRoot,a=r[t];void 0!==a&&(this._deactivateAction(a),this._removeInactiveAction(a))}var o=this._bindingsByRootAndName,s=o[t];if(void 0!==s)for(var l in s){var c=s[l];c.restoreOriginalState(),this._removeInactiveBinding(c)}},uncacheAction:function(e,t){var i=this.existingAction(e,t);null!==i&&(this._deactivateAction(i),this._removeInactiveAction(i))}}),Xn.prototype.clone=function(){return new Xn(void 0===this.value.clone?this.value:this.value.clone())},Yn.prototype=Object.assign(Object.create(Te.prototype),{constructor:Yn,isInstancedBufferGeometry:!0,addGroup:function(e,t,i){this.groups.push({start:e,count:t,materialIndex:i})},copy:function(e){var t=e.index;null!==t&&this.setIndex(t.clone());var i=e.attributes;for(var n in i){var r=i[n];this.addAttribute(n,r.clone())}for(var a=e.groups,o=0,s=a.length;o<s;o++){var l=a[o];this.addGroup(l.start,l.count,l.materialIndex)}return this}}),Object.defineProperties(Zn.prototype,{count:{get:function(){return this.data.count}},array:{get:function(){return this.data.array}}}),Object.assign(Zn.prototype,{isInterleavedBufferAttribute:!0,setX:function(e,t){return this.data.array[e*this.data.stride+this.offset]=t,this},setY:function(e,t){return this.data.array[e*this.data.stride+this.offset+1]=t,this},setZ:function(e,t){return this.data.array[e*this.data.stride+this.offset+2]=t,this},setW:function(e,t){return this.data.array[e*this.data.stride+this.offset+3]=t,this},getX:function(e){return this.data.array[e*this.data.stride+this.offset]},getY:function(e){return this.data.array[e*this.data.stride+this.offset+1]},getZ:function(e){return this.data.array[e*this.data.stride+this.offset+2]},getW:function(e){return this.data.array[e*this.data.stride+this.offset+3]},setXY:function(e,t,i){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this},setXYZ:function(e,t,i,n){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this},setXYZW:function(e,t,i,n,r){return e=e*this.data.stride+this.offset,this.data.array[e+0]=t,this.data.array[e+1]=i,this.data.array[e+2]=n,this.data.array[e+3]=r,this}}),Object.defineProperty(Kn.prototype,"needsUpdate",{set:function(e){!0===e&&this.version++}}),Object.assign(Kn.prototype,{isInterleavedBuffer:!0,setArray:function(e){if(Array.isArray(e))throw new TypeError("THREE.BufferAttribute: array should be a Typed Array.");this.count=void 0!==e?e.length/this.stride:0,this.array=e},setDynamic:function(e){return this.dynamic=e,this},copy:function(e){return this.array=new e.array.constructor(e.array),this.count=e.count,this.stride=e.stride,this.dynamic=e.dynamic,this},copyAt:function(e,t,i){e*=this.stride,i*=t.stride;for(var n=0,r=this.stride;n<r;n++)this.array[e+n]=t.array[i+n];return this},set:function(e,t){return void 0===t&&(t=0),this.array.set(e,t),this},clone:function(){return(new this.constructor).copy(this)},onUpload:function(e){return this.onUploadCallback=e,this}}),Qn.prototype=Object.assign(Object.create(Kn.prototype),{constructor:Qn,isInstancedInterleavedBuffer:!0,copy:function(e){return Kn.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Jn.prototype=Object.assign(Object.create(fe.prototype),{constructor:Jn,isInstancedBufferAttribute:!0,copy:function(e){return fe.prototype.copy.call(this,e),this.meshPerAttribute=e.meshPerAttribute,this}}),Object.assign($n.prototype,{linePrecision:1,set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t&&t.isPerspectiveCamera?(this.ray.origin.setFromMatrixPosition(t.matrixWorld),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(this.ray.origin).normalize()):t&&t.isOrthographicCamera?(this.ray.origin.set(e.x,e.y,-1).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("THREE.Raycaster: Unsupported camera type.")},intersectObject:function(e,t){var i=[];return tr(e,this,i,t),i.sort(er),i},intersectObjects:function(e,t){var i=[];if(!1===Array.isArray(e))return console.warn("THREE.Raycaster.intersectObjects: objects is not an Array."),i;for(var n=0,r=e.length;n<r;n++)tr(e[n],this,i,t);return i.sort(er),i}}),Object.assign(ir.prototype,{start:function(){this.startTime=("undefined"==typeof performance?Date:performance).now(),this.oldTime=this.startTime,this.elapsedTime=0,this.running=!0},stop:function(){this.getElapsedTime(),this.running=!1},getElapsedTime:function(){return this.getDelta(),this.elapsedTime},getDelta:function(){var e=0;if(this.autoStart&&!this.running)return this.start(),0;if(this.running){var t=("undefined"==typeof performance?Date:performance).now();e=(t-this.oldTime)/1e3,this.oldTime=t,this.elapsedTime+=e}return e}}),Object.assign(nr.prototype,{set:function(e,t,i){return this.radius=e,this.phi=t,this.theta=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.phi=e.phi,this.theta=e.theta,this},makeSafe:function(){return this.phi=Math.max(1e-6,Math.min(Math.PI-1e-6,this.phi)),this},setFromVector3:function(e){return this.radius=e.length(),0===this.radius?(this.theta=0,this.phi=0):(this.theta=Math.atan2(e.x,e.z),this.phi=Math.acos(hs.clamp(e.y/this.radius,-1,1))),this}}),Object.assign(rr.prototype,{set:function(e,t,i){return this.radius=e,this.theta=t,this.y=i,this},clone:function(){return(new this.constructor).copy(this)},copy:function(e){return this.radius=e.radius,this.theta=e.theta,this.y=e.y,this},setFromVector3:function(e){return this.radius=Math.sqrt(e.x*e.x+e.z*e.z),this.theta=Math.atan2(e.x,e.z),this.y=e.y,this}}),ar.prototype=Object.create(Ie.prototype),ar.prototype.constructor=ar,ar.prototype.createAnimation=function(e,t,i,n){var r={start:t,end:i,length:i-t+1,fps:n,duration:(i-t)/n,lastFrame:0,currentFrame:0,active:!1,time:0,direction:1,weight:1,directionBackwards:!1,mirroredLoop:!1};this.animationsMap[e]=r,this.animationsList.push(r)},ar.prototype.autoCreateAnimations=function(e){for(var t,i=/([a-z]+)_?(\d+)/i,n={},r=this.geometry,a=0,o=r.morphTargets.length;a<o;a++){var s=r.morphTargets[a],l=s.name.match(i);if(l&&l.length>1){var c=l[1];n[c]||(n[c]={start:1/0,end:-1/0});var u=n[c];a<u.start&&(u.start=a),a>u.end&&(u.end=a),t||(t=c)}}for(var c in n){var u=n[c];this.createAnimation(c,u.start,u.end,e)}this.firstAnimation=t},ar.prototype.setAnimationDirectionForward=function(e){var t=this.animationsMap[e];t&&(t.direction=1,t.directionBackwards=!1)},ar.prototype.setAnimationDirectionBackward=function(e){var t=this.animationsMap[e];t&&(t.direction=-1,t.directionBackwards=!0)},ar.prototype.setAnimationFPS=function(e,t){var i=this.animationsMap[e];i&&(i.fps=t,i.duration=(i.end-i.start)/i.fps)},ar.prototype.setAnimationDuration=function(e,t){var i=this.animationsMap[e];i&&(i.duration=t,i.fps=(i.end-i.start)/i.duration)},ar.prototype.setAnimationWeight=function(e,t){var i=this.animationsMap[e];i&&(i.weight=t)},ar.prototype.setAnimationTime=function(e,t){var i=this.animationsMap[e];i&&(i.time=t)},ar.prototype.getAnimationTime=function(e){var t=0,i=this.animationsMap[e];return i&&(t=i.time),t},ar.prototype.getAnimationDuration=function(e){var t=-1,i=this.animationsMap[e];return i&&(t=i.duration),t},ar.prototype.playAnimation=function(e){var t=this.animationsMap[e];t?(t.time=0,t.active=!0):console.warn("THREE.MorphBlendMesh: animation["+e+"] undefined in .playAnimation()")},ar.prototype.stopAnimation=function(e){var t=this.animationsMap[e];t&&(t.active=!1)},ar.prototype.update=function(e){for(var t=0,i=this.animationsList.length;t<i;t++){var n=this.animationsList[t];if(n.active){var r=n.duration/n.length
;n.time+=n.direction*e,n.mirroredLoop?(n.time>n.duration||n.time<0)&&(n.direction*=-1,n.time>n.duration&&(n.time=n.duration,n.directionBackwards=!0),n.time<0&&(n.time=0,n.directionBackwards=!1)):(n.time=n.time%n.duration,n.time<0&&(n.time+=n.duration));var a=n.start+hs.clamp(Math.floor(n.time/r),0,n.length-1),o=n.weight;a!==n.currentFrame&&(this.morphTargetInfluences[n.lastFrame]=0,this.morphTargetInfluences[n.currentFrame]=1*o,this.morphTargetInfluences[a]=0,n.lastFrame=n.currentFrame,n.currentFrame=a);var s=n.time%r/r;n.directionBackwards&&(s=1-s),n.currentFrame!==n.lastFrame?(this.morphTargetInfluences[n.currentFrame]=s*o,this.morphTargetInfluences[n.lastFrame]=(1-s)*o):this.morphTargetInfluences[n.currentFrame]=o}}},or.prototype=Object.create(le.prototype),or.prototype.constructor=or,or.prototype.isImmediateRenderObject=!0,sr.prototype=Object.create(Lt.prototype),sr.prototype.constructor=sr,sr.prototype.update=function(){var e=new l,t=new l,i=new te;return function(){var n=["a","b","c"];this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);var r=this.object.matrixWorld,a=this.geometry.attributes.position,o=this.object.geometry;if(o&&o.isGeometry)for(var s=o.vertices,l=o.faces,c=0,u=0,h=l.length;u<h;u++)for(var d=l[u],f=0,p=d.vertexNormals.length;f<p;f++){var m=s[d[n[f]]],g=d.vertexNormals[f];e.copy(m).applyMatrix4(r),t.copy(g).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),a.setXYZ(c,e.x,e.y,e.z),c+=1,a.setXYZ(c,t.x,t.y,t.z),c+=1}else if(o&&o.isBufferGeometry)for(var v=o.attributes.position,y=o.attributes.normal,c=0,f=0,p=v.count;f<p;f++)e.set(v.getX(f),v.getY(f),v.getZ(f)).applyMatrix4(r),t.set(y.getX(f),y.getY(f),y.getZ(f)),t.applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),a.setXYZ(c,e.x,e.y,e.z),c+=1,a.setXYZ(c,t.x,t.y,t.z),c+=1;a.needsUpdate=!0}}(),lr.prototype=Object.create(le.prototype),lr.prototype.constructor=lr,lr.prototype.dispose=function(){this.cone.geometry.dispose(),this.cone.material.dispose()},lr.prototype.update=function(){var e=new l,t=new l;return function(){var i=this.light.distance?this.light.distance:1e3,n=i*Math.tan(this.light.angle);this.cone.scale.set(n,n,i),e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),this.cone.lookAt(t.sub(e)),this.cone.material.color.copy(this.light.color)}}(),cr.prototype=Object.create(Lt.prototype),cr.prototype.constructor=cr,cr.prototype.getBoneList=function(e){var t=[];e&&e.isBone&&t.push(e);for(var i=0;i<e.children.length;i++)t.push.apply(t,this.getBoneList(e.children[i]));return t},cr.prototype.update=function(){var e=new l,t=new c,i=new c;return function(){var n=this.geometry,r=n.getAttribute("position");i.getInverse(this.root.matrixWorld);for(var a=0,o=0;a<this.bones.length;a++){var s=this.bones[a];s.parent&&s.parent.isBone&&(t.multiplyMatrices(i,s.matrixWorld),e.setFromMatrixPosition(t),r.setXYZ(o,e.x,e.y,e.z),t.multiplyMatrices(i,s.parent.matrixWorld),e.setFromMatrixPosition(t),r.setXYZ(o+1,e.x,e.y,e.z),o+=2)}n.getAttribute("position").needsUpdate=!0}}(),ur.prototype=Object.create(Ie.prototype),ur.prototype.constructor=ur,ur.prototype.dispose=function(){this.geometry.dispose(),this.material.dispose()},ur.prototype.update=function(){this.material.color.copy(this.light.color)},hr.prototype=Object.create(le.prototype),hr.prototype.constructor=hr,hr.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},hr.prototype.update=function(){var e=this.children[0];e.material.color.copy(this.light.color);var t=.5*this.light.width,i=.5*this.light.height,n=e.geometry.attributes.position,r=n.array;r[0]=t,r[1]=-i,r[2]=0,r[3]=t,r[4]=i,r[5]=0,r[6]=-t,r[7]=i,r[8]=0,r[9]=-t,r[10]=-i,r[11]=0,r[12]=t,r[13]=-i,r[14]=0,n.needsUpdate=!0},dr.prototype=Object.create(le.prototype),dr.prototype.constructor=dr,dr.prototype.dispose=function(){this.children[0].geometry.dispose(),this.children[0].material.dispose()},dr.prototype.update=function(){var e=new l,t=new j,i=new j;return function(){var n=this.children[0],r=n.geometry.getAttribute("color");t.copy(this.light.color),i.copy(this.light.groundColor);for(var a=0,o=r.count;a<o;a++){var s=a<o/2?t:i;r.setXYZ(a,s.r,s.g,s.b)}n.lookAt(e.setFromMatrixPosition(this.light.matrixWorld).negate()),r.needsUpdate=!0}}(),fr.prototype=Object.create(Lt.prototype),fr.prototype.constructor=fr,pr.prototype=Object.create(Lt.prototype),pr.prototype.constructor=pr,mr.prototype=Object.create(Lt.prototype),mr.prototype.constructor=mr,mr.prototype.update=function(){var e=new l,t=new l,i=new te;return function(){this.object.updateMatrixWorld(!0),i.getNormalMatrix(this.object.matrixWorld);for(var n=this.object.matrixWorld,r=this.geometry.attributes.position,a=this.object.geometry,o=a.vertices,s=a.faces,l=0,c=0,u=s.length;c<u;c++){var h=s[c],d=h.normal;e.copy(o[h.a]).add(o[h.b]).add(o[h.c]).divideScalar(3).applyMatrix4(n),t.copy(d).applyMatrix3(i).normalize().multiplyScalar(this.size).add(e),r.setXYZ(l,e.x,e.y,e.z),l+=1,r.setXYZ(l,t.x,t.y,t.z),l+=1}r.needsUpdate=!0}}(),gr.prototype=Object.create(le.prototype),gr.prototype.constructor=gr,gr.prototype.dispose=function(){var e=this.children[0],t=this.children[1];e.geometry.dispose(),e.material.dispose(),t.geometry.dispose(),t.material.dispose()},gr.prototype.update=function(){var e=new l,t=new l,i=new l;return function(){e.setFromMatrixPosition(this.light.matrixWorld),t.setFromMatrixPosition(this.light.target.matrixWorld),i.subVectors(t,e);var n=this.children[0],r=this.children[1];n.lookAt(i),n.material.color.copy(this.light.color),r.lookAt(i),r.scale.z=i.length()}}(),vr.prototype=Object.create(Lt.prototype),vr.prototype.constructor=vr,vr.prototype.update=function(){function e(e,a,o,s){n.set(a,o,s).unproject(r);var l=i[e];if(void 0!==l)for(var c=t.getAttribute("position"),u=0,h=l.length;u<h;u++)c.setXYZ(l[u],n.x,n.y,n.z)}var t,i,n=new l,r=new Ae;return function(){t=this.geometry,i=this.pointMap;r.projectionMatrix.copy(this.camera.projectionMatrix),e("c",0,0,-1),e("t",0,0,1),e("n1",-1,-1,-1),e("n2",1,-1,-1),e("n3",-1,1,-1),e("n4",1,1,-1),e("f1",-1,-1,1),e("f2",1,-1,1),e("f3",-1,1,1),e("f4",1,1,1),e("u1",.7,1.1,-1),e("u2",-.7,1.1,-1),e("u3",0,2,-1),e("cf1",-1,0,1),e("cf2",1,0,1),e("cf3",0,-1,1),e("cf4",0,1,1),e("cn1",-1,0,-1),e("cn2",1,0,-1),e("cn3",0,-1,-1),e("cn4",0,1,-1),t.getAttribute("position").needsUpdate=!0}}(),yr.prototype=Object.create(Lt.prototype),yr.prototype.constructor=yr,yr.prototype.update=function(){var e=new $;return function(t){if(void 0!==t&&console.warn("THREE.BoxHelper: .update() has no longer arguments."),void 0!==this.object&&e.setFromObject(this.object),!e.isEmpty()){var i=e.min,n=e.max,r=this.geometry.attributes.position,a=r.array;a[0]=n.x,a[1]=n.y,a[2]=n.z,a[3]=i.x,a[4]=n.y,a[5]=n.z,a[6]=i.x,a[7]=i.y,a[8]=n.z,a[9]=n.x,a[10]=i.y,a[11]=n.z,a[12]=n.x,a[13]=n.y,a[14]=i.z,a[15]=i.x,a[16]=n.y,a[17]=i.z,a[18]=i.x,a[19]=i.y,a[20]=i.z,a[21]=n.x,a[22]=i.y,a[23]=i.z,r.needsUpdate=!0,this.geometry.computeBoundingSphere()}}}(),yr.prototype.setFromObject=function(e){return this.object=e,this.update(),this};var zs,Ws;Er.prototype=Object.create(le.prototype),Er.prototype.constructor=Er,Er.prototype.setDirection=function(){var e,t=new l;return function(i){i.y>.99999?this.quaternion.set(0,0,0,1):i.y<-.99999?this.quaternion.set(1,0,0,0):(t.set(i.z,0,-i.x).normalize(),e=Math.acos(i.y),this.quaternion.setFromAxisAngle(t,e))}}(),Er.prototype.setLength=function(e,t,i){void 0===t&&(t=.2*e),void 0===i&&(i=.2*t),this.line.scale.set(1,Math.max(0,e-t),1),this.line.updateMatrix(),this.cone.scale.set(i,t,i),this.cone.position.y=e,this.cone.updateMatrix()},Er.prototype.setColor=function(e){this.line.material.color.copy(e),this.cone.material.color.copy(e)},xr.prototype=Object.create(Lt.prototype),xr.prototype.constructor=xr;var qs=new l,js=new br,Xs=new br,Ys=new br;Cr.prototype=Object.create(bn.prototype),Cr.prototype.constructor=Cr,Cr.prototype.getPoint=function(e){var t=this.points,i=t.length;i<2&&console.log("duh, you need at least 2 points");var n=(i-(this.closed?0:1))*e,r=Math.floor(n),a=n-r;this.closed?r+=r>0?0:(Math.floor(Math.abs(r)/t.length)+1)*t.length:0===a&&r===i-1&&(r=i-2,a=1);var o,s,c,u;if(this.closed||r>0?o=t[(r-1)%i]:(qs.subVectors(t[0],t[1]).add(t[0]),o=qs),s=t[r%i],c=t[(r+1)%i],this.closed||r+2<i?u=t[(r+2)%i]:(qs.subVectors(t[i-1],t[i-2]).add(t[i-1]),u=qs),void 0===this.type||"centripetal"===this.type||"chordal"===this.type){var h="chordal"===this.type?.5:.25,d=Math.pow(o.distanceToSquared(s),h),f=Math.pow(s.distanceToSquared(c),h),p=Math.pow(c.distanceToSquared(u),h);f<1e-4&&(f=1),d<1e-4&&(d=f),p<1e-4&&(p=f),js.initNonuniformCatmullRom(o.x,s.x,c.x,u.x,d,f,p),Xs.initNonuniformCatmullRom(o.y,s.y,c.y,u.y,d,f,p),Ys.initNonuniformCatmullRom(o.z,s.z,c.z,u.z,d,f,p)}else if("catmullrom"===this.type){var m=void 0!==this.tension?this.tension:.5;js.initCatmullRom(o.x,s.x,c.x,u.x,m),Xs.initCatmullRom(o.y,s.y,c.y,u.y,m),Ys.initCatmullRom(o.z,s.z,c.z,u.z,m)}return new l(js.calc(a),Xs.calc(a),Ys.calc(a))},Mr.prototype=Object.create(bn.prototype),Mr.prototype.constructor=Mr,Mr.prototype.getPoint=function(e){var t=this.v0,i=this.v1,n=this.v2,r=this.v3;return new l(xn(e,t.x,i.x,n.x,r.x),xn(e,t.y,i.y,n.y,r.y),xn(e,t.z,i.z,n.z,r.z))},_r.prototype=Object.create(bn.prototype),_r.prototype.constructor=_r,_r.prototype.getPoint=function(e){var t=this.v0,i=this.v1,n=this.v2;return new l(mn(e,t.x,i.x,n.x),mn(e,t.y,i.y,n.y),mn(e,t.z,i.z,n.z))},wr.prototype=Object.create(bn.prototype),wr.prototype.constructor=wr,wr.prototype.getPoint=function(e){if(1===e)return this.v2.clone();var t=new l;return t.subVectors(this.v2,this.v1),t.multiplyScalar(e),t.add(this.v1),t},Lr.prototype=Object.create(_n.prototype),Lr.prototype.constructor=Lr;var Zs={createMultiMaterialObject:function(e,t){for(var i=new Ot,n=0,r=t.length;n<r;n++)i.add(new Ie(e,t[n]));return i},detach:function(e,t,i){e.applyMatrix(t.matrixWorld),t.remove(e),i.add(e)},attach:function(e,t,i){var n=new c;n.getInverse(i.matrixWorld),e.applyMatrix(n),t.remove(e),i.add(e)}};bn.create=function(e,t){return console.log("THREE.Curve.create() has been deprecated"),e.prototype=Object.create(bn.prototype),e.prototype.constructor=e,e.prototype.getPoint=t,e},Xr.prototype=Object.create(Cr.prototype),Yr.prototype=Object.create(Cr.prototype),Zr.prototype=Object.create(Cr.prototype),Object.assign(Zr.prototype,{initFromArray:function(e){console.error("THREE.Spline: .initFromArray() has been removed.")},getControlPointsArray:function(e){console.error("THREE.Spline: .getControlPointsArray() has been removed.")},reparametrizeByArcLength:function(e){console.error("THREE.Spline: .reparametrizeByArcLength() has been removed.")}}),fr.prototype.setColors=function(){console.error("THREE.GridHelper: setColors() has been deprecated, pass them in the constructor instead.")},Object.assign(X.prototype,{center:function(e){return console.warn("THREE.Box2: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box2: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box2: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},size:function(e){return console.warn("THREE.Box2: .size() has been renamed to .getSize()."),this.getSize(e)}}),Object.assign($.prototype,{center:function(e){return console.warn("THREE.Box3: .center() has been renamed to .getCenter()."),this.getCenter(e)},empty:function(){return console.warn("THREE.Box3: .empty() has been renamed to .isEmpty()."),this.isEmpty()},isIntersectionBox:function(e){return console.warn("THREE.Box3: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionSphere:function(e){return console.warn("THREE.Box3: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)},size:function(e){return console.warn("THREE.Box3: .size() has been renamed to .getSize()."),this.getSize(e)}}),ce.prototype.center=function(e){return console.warn("THREE.Line3: .center() has been renamed to .getCenter()."),this.getCenter(e)},hs.random16=function(){return console.warn("THREE.Math.random16() has been deprecated. Use Math.random() instead."),Math.random()},Object.assign(te.prototype,{flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix3: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},multiplyVector3:function(e){return console.warn("THREE.Matrix3: .multiplyVector3() has been removed. Use vector.applyMatrix3( matrix ) instead."),e.applyMatrix3(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix3: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix3: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix3: .applyToVector3Array() has been removed.")}}),Object.assign(c.prototype,{extractPosition:function(e){return console.warn("THREE.Matrix4: .extractPosition() has been renamed to .copyPosition()."),this.copyPosition(e)},flattenToArrayOffset:function(e,t){return console.warn("THREE.Matrix4: .flattenToArrayOffset() has been deprecated. Use .toArray() instead."),this.toArray(e,t)},getPosition:function(){var e;return function(){return void 0===e&&(e=new l),console.warn("THREE.Matrix4: .getPosition() has been removed. Use Vector3.setFromMatrixPosition( matrix ) instead."),e.setFromMatrixColumn(this,3)}}(),setRotationFromQuaternion:function(e){return console.warn("THREE.Matrix4: .setRotationFromQuaternion() has been renamed to .makeRotationFromQuaternion()."),this.makeRotationFromQuaternion(e)},multiplyToArray:function(){console.warn("THREE.Matrix4: .multiplyToArray() has been removed.")},multiplyVector3:function(e){return console.warn("THREE.Matrix4: .multiplyVector3() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector4:function(e){return console.warn("THREE.Matrix4: .multiplyVector4() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},multiplyVector3Array:function(e){return console.warn("THREE.Matrix4: .multiplyVector3Array() has been renamed. Use matrix.applyToVector3Array( array ) instead."),this.applyToVector3Array(e)},rotateAxis:function(e){console.warn("THREE.Matrix4: .rotateAxis() has been removed. Use Vector3.transformDirection( matrix ) instead."),e.transformDirection(this)},crossVector:function(e){return console.warn("THREE.Matrix4: .crossVector() has been removed. Use vector.applyMatrix4( matrix ) instead."),e.applyMatrix4(this)},translate:function(){console.error("THREE.Matrix4: .translate() has been removed.")},rotateX:function(){console.error("THREE.Matrix4: .rotateX() has been removed.")},rotateY:function(){console.error("THREE.Matrix4: .rotateY() has been removed.")},rotateZ:function(){console.error("THREE.Matrix4: .rotateZ() has been removed.")},rotateByAxis:function(){console.error("THREE.Matrix4: .rotateByAxis() has been removed.")},applyToBuffer:function(e,t,i){return console.warn("THREE.Matrix4: .applyToBuffer() has been removed. Use matrix.applyToBufferAttribute( attribute ) instead."),this.applyToBufferAttribute(e)},applyToVector3Array:function(e,t,i){console.error("THREE.Matrix4: .applyToVector3Array() has been removed.")},makeFrustum:function(e,t,i,n,r,a){return console.warn("THREE.Matrix4: .makeFrustum() has been removed. Use .makePerspective( left, right, top, bottom, near, far ) instead."),this.makePerspective(e,t,n,i,r,a)}}),ie.prototype.isIntersectionLine=function(e){return console.warn("THREE.Plane: .isIntersectionLine() has been renamed to .intersectsLine()."),this.intersectsLine(e)},s.prototype.multiplyVector3=function(e){return console.warn("THREE.Quaternion: .multiplyVector3() has been removed. Use is now vector.applyQuaternion( quaternion ) instead."),e.applyQuaternion(this)},Object.assign(ae.prototype,{isIntersectionBox:function(e){return console.warn("THREE.Ray: .isIntersectionBox() has been renamed to .intersectsBox()."),this.intersectsBox(e)},isIntersectionPlane:function(e){return console.warn("THREE.Ray: .isIntersectionPlane() has been renamed to .intersectsPlane()."),this.intersectsPlane(e)},isIntersectionSphere:function(e){return console.warn("THREE.Ray: .isIntersectionSphere() has been renamed to .intersectsSphere()."),this.intersectsSphere(e)}}),Object.assign(Sn.prototype,{extrude:function(e){return console.warn("THREE.Shape: .extrude() has been removed. Use ExtrudeGeometry() instead."),new ei(this,e)},makeGeometry:function(e){return console.warn("THREE.Shape: .makeGeometry() has been removed. Use ShapeGeometry() instead."),new ui(this,e)}}),Object.assign(i.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector2: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(l.prototype,{setEulerFromRotationMatrix:function(){console.error("THREE.Vector3: .setEulerFromRotationMatrix() has been removed. Use Euler.setFromRotationMatrix() instead.")},setEulerFromQuaternion:function(){console.error("THREE.Vector3: .setEulerFromQuaternion() has been removed. Use Euler.setFromQuaternion() instead.")},getPositionFromMatrix:function(e){return console.warn("THREE.Vector3: .getPositionFromMatrix() has been renamed to .setFromMatrixPosition()."),this.setFromMatrixPosition(e)},getScaleFromMatrix:function(e){return console.warn("THREE.Vector3: .getScaleFromMatrix() has been renamed to .setFromMatrixScale()."),this.setFromMatrixScale(e)},getColumnFromMatrix:function(e,t){return console.warn("THREE.Vector3: .getColumnFromMatrix() has been renamed to .setFromMatrixColumn()."),this.setFromMatrixColumn(t,e)},applyProjection:function(e){return console.warn("THREE.Vector3: .applyProjection() has been removed. Use .applyMatrix4( m ) instead."),this.applyMatrix4(e)},fromAttribute:function(e,t,i){return console.error("THREE.Vector3: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Object.assign(r.prototype,{fromAttribute:function(e,t,i){return console.error("THREE.Vector4: .fromAttribute() has been renamed to .fromBufferAttribute()."),this.fromBufferAttribute(e,t,i)}}),Le.prototype.computeTangents=function(){console.warn("THREE.Geometry: .computeTangents() has been removed.")},Object.assign(le.prototype,{getChildByName:function(e){return console.warn("THREE.Object3D: .getChildByName() has been renamed to .getObjectByName()."),this.getObjectByName(e)},renderDepth:function(){console.warn("THREE.Object3D: .renderDepth has been removed. Use .renderOrder, instead.")},translate:function(e,t){return console.warn("THREE.Object3D: .translate() has been removed. Use .translateOnAxis( axis, distance ) instead."),this.translateOnAxis(t,e)}}),Object.defineProperties(le.prototype,{eulerOrder:{get:function(){return console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order},set:function(e){console.warn("THREE.Object3D: .eulerOrder is now .rotation.order."),this.rotation.order=e}},useQuaternion:{get:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")},set:function(){console.warn("THREE.Object3D: .useQuaternion has been removed. The library now uses quaternions by default.")}}}),Object.defineProperties(xt.prototype,{objects:{get:function(){return console.warn("THREE.LOD: .objects has been renamed to .levels."),this.levels}}}),Object.defineProperty(bt.prototype,"useVertexTexture",{get:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")},set:function(){console.warn("THREE.Skeleton: useVertexTexture has been removed.")}}),Object.defineProperty(bn.prototype,"__arcLengthDivisions",{get:function(){return console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions},set:function(e){console.warn("THREE.Curve: .__arcLengthDivisions is now .arcLengthDivisions."),this.arcLengthDivisions=e}}),Ue.prototype.setLens=function(e,t){console.warn("THREE.PerspectiveCamera.setLens is deprecated. Use .setFocalLength and .filmGauge for a photographic setup."),void 0!==t&&(this.filmGauge=t),this.setFocalLength(e)},Object.defineProperties(Bi.prototype,{onlyShadow:{set:function(){console.warn("THREE.Light: .onlyShadow has been removed.")}},shadowCameraFov:{set:function(e){console.warn("THREE.Light: .shadowCameraFov is now .shadow.camera.fov."),this.shadow.camera.fov=e}},shadowCameraLeft:{set:function(e){console.warn("THREE.Light: .shadowCameraLeft is now .shadow.camera.left."),this.shadow.camera.left=e}},shadowCameraRight:{set:function(e){console.warn("THREE.Light: .shadowCameraRight is now .shadow.camera.right."),this.shadow.camera.right=e}},shadowCameraTop:{set:function(e){console.warn("THREE.Light: .shadowCameraTop is now .shadow.camera.top."),this.shadow.camera.top=e}},shadowCameraBottom:{set:function(e){console.warn("THREE.Light: .shadowCameraBottom is now .shadow.camera.bottom."),this.shadow.camera.bottom=e}},shadowCameraNear:{set:function(e){console.warn("THREE.Light: .shadowCameraNear is now .shadow.camera.near."),this.shadow.camera.near=e}},shadowCameraFar:{set:function(e){console.warn("THREE.Light: .shadowCameraFar is now .shadow.camera.far."),this.shadow.camera.far=e}},shadowCameraVisible:{set:function(){console.warn("THREE.Light: .shadowCameraVisible has been removed. Use new THREE.CameraHelper( light.shadow.camera ) instead.")}},shadowBias:{set:function(e){console.warn("THREE.Light: .shadowBias is now .shadow.bias."),this.shadow.bias=e}},shadowDarkness:{set:function(){console.warn("THREE.Light: .shadowDarkness has been removed.")}},shadowMapWidth:{set:function(e){console.warn("THREE.Light: .shadowMapWidth is now .shadow.mapSize.width."),this.shadow.mapSize.width=e}},shadowMapHeight:{set:function(e){console.warn("THREE.Light: .shadowMapHeight is now .shadow.mapSize.height."),this.shadow.mapSize.height=e}}}),Object.defineProperties(fe.prototype,{length:{get:function(){return console.warn("THREE.BufferAttribute: .length has been deprecated. Use .count instead."),this.array.length}}}),Object.assign(Te.prototype,{addIndex:function(e){console.warn("THREE.BufferGeometry: .addIndex() has been renamed to .setIndex()."),this.setIndex(e)},addDrawCall:function(e,t,i){void 0!==i&&console.warn("THREE.BufferGeometry: .addDrawCall() no longer supports indexOffset."),console.warn("THREE.BufferGeometry: .addDrawCall() is now .addGroup()."),this.addGroup(e,t)},clearDrawCalls:function(){console.warn("THREE.BufferGeometry: .clearDrawCalls() is now .clearGroups()."),this.clearGroups()},computeTangents:function(){console.warn("THREE.BufferGeometry: .computeTangents() has been removed.")},computeOffsets:function(){console.warn("THREE.BufferGeometry: .computeOffsets() has been removed.")}}),Object.defineProperties(Te.prototype,{drawcalls:{get:function(){return console.error("THREE.BufferGeometry: .drawcalls has been renamed to .groups."),this.groups}},offsets:{get:function(){return console.warn("THREE.BufferGeometry: .offsets has been renamed to .groups."),this.groups}}}),Object.defineProperties(Xn.prototype,{dynamic:{set:function(){console.warn("THREE.Uniform: .dynamic has been removed. Use object.onBeforeRender() instead.")}},onUpdate:{value:function(){return console.warn("THREE.Uniform: .onUpdate() has been removed. Use object.onBeforeRender() instead."),this}}}),Object.defineProperties(K.prototype,{wrapAround:{get:function(){console.warn("THREE.Material: .wrapAround has been removed.")},set:function(){console.warn("THREE.Material: .wrapAround has been removed.")}},wrapRGB:{get:function(){return console.warn("THREE.Material: .wrapRGB has been removed."),new j}}}),Object.defineProperties(Mi.prototype,{metal:{get:function(){return console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead."),!1},set:function(){console.warn("THREE.MeshPhongMaterial: .metal has been removed. Use THREE.MeshStandardMaterial instead")}}}),Object.defineProperties(Q.prototype,{derivatives:{get:function(){return console.warn("THREE.ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives},set:function(e){console.warn("THREE. ShaderMaterial: .derivatives has been moved to .extensions.derivatives."),this.extensions.derivatives=e}}}),Object.assign(ft.prototype,{getCurrentRenderTarget:function(){return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(ft.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),Object.defineProperties(re.prototype,{cullFace:{get:function(){return this.renderReverseSided?ca:la},set:function(e){var t=e!==la;console.warn("WebGLRenderer: .shadowMap.cullFace is deprecated. Set .shadowMap.renderReverseSided to "+t+"."),this.renderReverseSided=t}}}),Object.defineProperties(a.prototype,{wrapS:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapS is now .texture.wrapS."),this.texture.wrapS=e}},wrapT:{get:function(){return console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT},set:function(e){console.warn("THREE.WebGLRenderTarget: .wrapT is now .texture.wrapT."),this.texture.wrapT=e}},magFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .magFilter is now .texture.magFilter."),this.texture.magFilter=e}},minFilter:{get:function(){return console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter},set:function(e){console.warn("THREE.WebGLRenderTarget: .minFilter is now .texture.minFilter."),this.texture.minFilter=e}},anisotropy:{get:function(){return console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy},set:function(e){console.warn("THREE.WebGLRenderTarget: .anisotropy is now .texture.anisotropy."),this.texture.anisotropy=e}},offset:{get:function(){return console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset},set:function(e){console.warn("THREE.WebGLRenderTarget: .offset is now .texture.offset."),this.texture.offset=e}},repeat:{get:function(){return console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat},set:function(e){console.warn("THREE.WebGLRenderTarget: .repeat is now .texture.repeat."),this.texture.repeat=e}},format:{get:function(){return console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format},set:function(e){console.warn("THREE.WebGLRenderTarget: .format is now .texture.format."),this.texture.format=e}},type:{get:function(){return console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type},set:function(e){console.warn("THREE.WebGLRenderTarget: .type is now .texture.type."),this.texture.type=e}},generateMipmaps:{get:function(){return console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps},set:function(e){console.warn("THREE.WebGLRenderTarget: .generateMipmaps is now .texture.generateMipmaps."),this.texture.generateMipmaps=e}}}),kn.prototype.load=function(e){console.warn("THREE.Audio: .load has been deprecated. Use THREE.AudioLoader instead.");var t=this;return(new An).load(e,function(e){t.setBuffer(e)}),this},Hn.prototype.getData=function(){return console.warn("THREE.AudioAnalyser: .getData() is now .getFrequencyData()."),this.getFrequencyData()};var Ks={merge:function(e,t,i){console.warn("THREE.GeometryUtils: .merge() has been moved to Geometry. Use geometry.merge( geometry2, matrix, materialIndexOffset ) instead.");var n;t.isMesh&&(t.matrixAutoUpdate&&t.updateMatrix(),n=t.matrix,t=t.geometry),e.merge(t,n,i)},center:function(e){return console.warn("THREE.GeometryUtils: .center() has been moved to Geometry. Use geometry.center() instead."),e.center()}},Qs={crossOrigin:void 0,loadTexture:function(e,t,i,n){console.warn("THREE.ImageUtils.loadTexture has been deprecated. Use THREE.TextureLoader() instead.");var r=new Ui;r.setCrossOrigin(this.crossOrigin);var a=r.load(e,i,void 0,n);return t&&(a.mapping=t),a},loadTextureCube:function(e,t,i,n){console.warn("THREE.ImageUtils.loadTextureCube has been deprecated. Use THREE.CubeTextureLoader() instead.");var r=new Ai;r.setCrossOrigin(this.crossOrigin);var a=r.load(e,i,void 0,n);return t&&(a.mapping=t),a},loadCompressedTexture:function(){console.error("THREE.ImageUtils.loadCompressedTexture has been removed. Use THREE.DDSLoader instead.")},loadCompressedTextureCube:function(){console.error("THREE.ImageUtils.loadCompressedTextureCube has been removed. Use THREE.DDSLoader instead.")}};Object.assign(ra.prototype,{getCurrentRenderTarget:function(){
return console.warn("THREE.WebGLRenderer: .getCurrentRenderTarget() is now .getRenderTarget()."),this.getRenderTarget()},supportsFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsFloatTextures() is now .extensions.get( 'OES_texture_float' )."),this.extensions.get("OES_texture_float")},supportsHalfFloatTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsHalfFloatTextures() is now .extensions.get( 'OES_texture_half_float' )."),this.extensions.get("OES_texture_half_float")},supportsStandardDerivatives:function(){return console.warn("THREE.WebGLRenderer: .supportsStandardDerivatives() is now .extensions.get( 'OES_standard_derivatives' )."),this.extensions.get("OES_standard_derivatives")},supportsCompressedTextureS3TC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTextureS3TC() is now .extensions.get( 'WEBGL_compressed_texture_s3tc' )."),this.extensions.get("WEBGL_compressed_texture_s3tc")},supportsCompressedTexturePVRTC:function(){return console.warn("THREE.WebGLRenderer: .supportsCompressedTexturePVRTC() is now .extensions.get( 'WEBGL_compressed_texture_pvrtc' )."),this.extensions.get("WEBGL_compressed_texture_pvrtc")},supportsBlendMinMax:function(){return console.warn("THREE.WebGLRenderer: .supportsBlendMinMax() is now .extensions.get( 'EXT_blend_minmax' )."),this.extensions.get("EXT_blend_minmax")},supportsVertexTextures:function(){return console.warn("THREE.WebGLRenderer: .supportsVertexTextures() is now .capabilities.vertexTextures."),this.capabilities.vertexTextures},supportsInstancedArrays:function(){return console.warn("THREE.WebGLRenderer: .supportsInstancedArrays() is now .extensions.get( 'ANGLE_instanced_arrays' )."),this.extensions.get("ANGLE_instanced_arrays")},enableScissorTest:function(e){console.warn("THREE.WebGLRenderer: .enableScissorTest() is now .setScissorTest()."),this.setScissorTest(e)},initMaterial:function(){console.warn("THREE.WebGLRenderer: .initMaterial() has been removed.")},addPrePlugin:function(){console.warn("THREE.WebGLRenderer: .addPrePlugin() has been removed.")},addPostPlugin:function(){console.warn("THREE.WebGLRenderer: .addPostPlugin() has been removed.")},updateShadowMap:function(){console.warn("THREE.WebGLRenderer: .updateShadowMap() has been removed.")}}),Object.defineProperties(ra.prototype,{shadowMapEnabled:{get:function(){return this.shadowMap.enabled},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapEnabled is now .shadowMap.enabled."),this.shadowMap.enabled=e}},shadowMapType:{get:function(){return this.shadowMap.type},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapType is now .shadowMap.type."),this.shadowMap.type=e}},shadowMapCullFace:{get:function(){return this.shadowMap.cullFace},set:function(e){console.warn("THREE.WebGLRenderer: .shadowMapCullFace is now .shadowMap.cullFace."),this.shadowMap.cullFace=e}}}),e.LRUMap=LRUMap,e.WebGLRendererByIncrement=ra,e.WebGLRenderTargetCube=o,e.WebGLRenderTarget=a,e.WebGLRenderer=ft,e.ShaderLib=_s,e.UniformsLib=bs,e.UniformsUtils=Cs,e.ShaderChunk=Ms,e.FogExp2=pt,e.Fog=mt,e.Scene=gt,e.LensFlare=vt,e.Sprite=Et,e.LOD=xt,e.SkinnedMesh=Mt,e.Skeleton=bt,e.Bone=Ct,e.Mesh=Ie,e.LineSegments=Lt,e.LineLoop=Tt,e.Line=wt,e.Points=St,e.Group=Ot,e.VideoTexture=Dt,e.DataTexture=u,e.CompressedTexture=Rt,e.CubeTexture=h,e.CanvasTexture=At,e.DepthTexture=Ut,e.Texture=n,e.CompressedTextureLoader=Oi,e.DataTextureLoader=Di,e.CubeTextureLoader=Ai,e.TextureLoader=Ui,e.ObjectLoader=un,e.MaterialLoader=on,e.BufferGeometryLoader=sn,e.DefaultLoadingManager=As,e.LoadingManager=Ii,e.JSONLoader=cn,e.ImageLoader=Ri,e.FontLoader=Rn,e.FileLoader=Si,e.Loader=ln,e.Cache=Rs,e.AudioLoader=An,e.SpotLightShadow=ki,e.SpotLight=Fi,e.PointLight=Hi,e.RectAreaLight=Wi,e.HemisphereLight=Pi,e.DirectionalLightShadow=Gi,e.DirectionalLight=Vi,e.AmbientLight=zi,e.LightShadow=Ni,e.Light=Bi,e.StereoCamera=Un,e.PerspectiveCamera=Ue,e.OrthographicCamera=Be,e.CubeCamera=Bn,e.ArrayCamera=Pn,e.Camera=Ae,e.AudioListener=Nn,e.PositionalAudio=Fn,e.AudioContext=Vs,e.AudioAnalyser=Hn,e.Audio=kn,e.VectorKeyframeTrack=Ki,e.StringKeyframeTrack=en,e.QuaternionKeyframeTrack=Ji,e.NumberKeyframeTrack=$i,e.ColorKeyframeTrack=nn,e.BooleanKeyframeTrack=tn,e.PropertyMixer=Gn,e.PropertyBinding=zn,e.KeyframeTrack=rn,e.AnimationUtils=Us,e.AnimationObjectGroup=Wn,e.AnimationMixer=jn,e.AnimationClip=an,e.Uniform=Xn,e.InstancedBufferGeometry=Yn,e.BufferGeometry=Te,e.GeometryIdCount=we,e.Geometry=Le,e.InterleavedBufferAttribute=Zn,e.InstancedInterleavedBuffer=Qn,e.InterleavedBuffer=Kn,e.InstancedBufferAttribute=Jn,e.Face3=he,e.Object3D=le,e.Raycaster=$n,e.Layers=se,e.EventDispatcher=t,e.Clock=ir,e.QuaternionLinearInterpolant=Qi,e.LinearInterpolant=Xi,e.DiscreteInterpolant=Yi,e.CubicInterpolant=ji,e.Interpolant=qi,e.Triangle=ue,e.Math=hs,e.Spherical=nr,e.Cylindrical=rr,e.Plane=ie,e.Frustum=ne,e.Sphere=ee,e.Ray=ae,e.Matrix4=c,e.Matrix3=te,e.Box3=$,e.Box2=X,e.Line3=ce,e.Euler=oe,e.Vector4=r,e.Vector3=l,e.Vector2=i,e.Quaternion=s,e.Color=j,e.MorphBlendMesh=ar,e.ImmediateRenderObject=or,e.VertexNormalsHelper=sr,e.SpotLightHelper=lr,e.SkeletonHelper=cr,e.PointLightHelper=ur,e.RectAreaLightHelper=hr,e.HemisphereLightHelper=dr,e.GridHelper=fr,e.PolarGridHelper=pr,e.FaceNormalsHelper=mr,e.DirectionalLightHelper=gr,e.CameraHelper=vr,e.BoxHelper=yr,e.ArrowHelper=Er,e.AxisHelper=xr,e.CatmullRomCurve3=Cr,e.CubicBezierCurve3=Mr,e.QuadraticBezierCurve3=_r,e.LineCurve3=wr,e.ArcCurve=Lr,e.EllipseCurve=_n,e.SplineCurve=wn,e.CubicBezierCurve=Ln,e.QuadraticBezierCurve=Tn,e.LineCurve=Cn,e.Shape=Sn,e.Path=In,e.ShapePath=On,e.Font=Dn,e.CurvePath=Mn,e.Curve=bn,e.ShapeUtils=Ss,e.SceneUtils=Zs,e.WebGLExtensions=ht,e.WireframeGeometry=Bt,e.ParametricGeometry=Pt,e.ParametricBufferGeometry=Nt,e.TetrahedronGeometry=Ht,e.TetrahedronBufferGeometry=Gt,e.OctahedronGeometry=Vt,e.OctahedronBufferGeometry=zt,e.IcosahedronGeometry=Wt,e.IcosahedronBufferGeometry=qt,e.DodecahedronGeometry=jt,e.DodecahedronBufferGeometry=Xt,e.PolyhedronGeometry=kt,e.PolyhedronBufferGeometry=Ft,e.TubeGeometry=Yt,e.TubeBufferGeometry=Zt,e.TorusKnotGeometry=Kt,e.TorusKnotBufferGeometry=Qt,e.TorusGeometry=Jt,e.TorusBufferGeometry=$t,e.TextGeometry=ii,e.TextBufferGeometry=ni,e.SphereGeometry=ri,e.SphereBufferGeometry=ai,e.RingGeometry=oi,e.RingBufferGeometry=si,e.PlaneGeometry=De,e.PlaneBufferGeometry=Re,e.LatheGeometry=li,e.LatheBufferGeometry=ci,e.ShapeGeometry=ui,e.ShapeBufferGeometry=hi,e.ExtrudeGeometry=ei,e.ExtrudeBufferGeometry=ti,e.EdgesGeometry=di,e.ConeGeometry=mi,e.ConeBufferGeometry=gi,e.CylinderGeometry=fi,e.CylinderBufferGeometry=pi,e.CircleGeometry=vi,e.CircleBufferGeometry=yi,e.BoxGeometry=Se,e.BoxBufferGeometry=Oe,e.ShadowMaterial=Ei;e.SpriteMaterial=yt,e.RawShaderMaterial=xi,e.ShaderMaterial=Q,e.PointsMaterial=It,e.MeshPhysicalMaterial=Ci,e.MeshStandardMaterial=bi,e.MeshPhongMaterial=Mi,e.MeshToonMaterial=_i,e.MeshNormalMaterial=wi,e.MeshLambertMaterial=Li,e.MeshDepthMaterial=J,e.MeshBasicMaterial=de,e.LineDashedMaterial=Ti,e.LineBasicMaterial=_t,e.Material=K,e.Float64BufferAttribute=Ce,e.Float32BufferAttribute=be,e.Uint32BufferAttribute=xe,e.Int32BufferAttribute=Ee,e.Uint16BufferAttribute=ye,e.Int16BufferAttribute=ve,e.Uint8ClampedBufferAttribute=ge,e.Uint8BufferAttribute=me,e.Int8BufferAttribute=pe,e.BufferAttribute=fe,e.REVISION=aa,e.MOUSE=oa,e.CullFaceNone=sa,e.CullFaceBack=la,e.CullFaceFront=ca,e.CullFaceFrontBack=3,e.FrontFaceDirectionCW=ua,e.FrontFaceDirectionCCW=1,e.BasicShadowMap=0,e.PCFShadowMap=ha,e.PCFSoftShadowMap=da,e.FrontSide=fa,e.BackSide=pa,e.DoubleSide=ma,e.FlatShading=ga,e.SmoothShading=va,e.NoColors=ya,e.FaceColors=Ea,e.VertexColors=xa,e.NoBlending=ba,e.NormalBlending=Ca,e.AdditiveBlending=Ma,e.SubtractiveBlending=_a,e.MultiplyBlending=wa,e.CustomBlending=La,e.AddEquation=Ta,e.SubtractEquation=Ia,e.ReverseSubtractEquation=Sa,e.MinEquation=Oa,e.MaxEquation=Da,e.ZeroFactor=Ra,e.OneFactor=Aa,e.SrcColorFactor=Ua,e.OneMinusSrcColorFactor=Ba,e.SrcAlphaFactor=Pa,e.OneMinusSrcAlphaFactor=Na,e.DstAlphaFactor=ka,e.OneMinusDstAlphaFactor=Fa,e.DstColorFactor=Ha,e.OneMinusDstColorFactor=Ga,e.SrcAlphaSaturateFactor=Va,e.NeverDepth=za,e.AlwaysDepth=Wa,e.LessDepth=qa,e.LessEqualDepth=ja,e.EqualDepth=Xa,e.GreaterEqualDepth=Ya,e.GreaterDepth=Za,e.NotEqualDepth=Ka,e.MultiplyOperation=Qa,e.MixOperation=Ja,e.AddOperation=$a,e.NoToneMapping=eo,e.LinearToneMapping=to,e.ReinhardToneMapping=io,e.Uncharted2ToneMapping=no,e.CineonToneMapping=ro,e.UVMapping=300,e.CubeReflectionMapping=ao,e.CubeRefractionMapping=oo,e.EquirectangularReflectionMapping=so,e.EquirectangularRefractionMapping=lo,e.SphericalReflectionMapping=co,e.CubeUVReflectionMapping=uo,e.CubeUVRefractionMapping=ho,e.RepeatWrapping=fo,e.ClampToEdgeWrapping=po,e.MirroredRepeatWrapping=mo,e.NearestFilter=go,e.NearestMipMapNearestFilter=vo,e.NearestMipMapLinearFilter=yo,e.LinearFilter=Eo,e.LinearMipMapNearestFilter=xo,e.LinearMipMapLinearFilter=bo,e.UnsignedByteType=Co,e.ByteType=Mo,e.ShortType=_o,e.UnsignedShortType=wo,e.IntType=Lo,e.UnsignedIntType=To,e.FloatType=Io,e.HalfFloatType=So,e.UnsignedShort4444Type=Oo,e.UnsignedShort5551Type=Do,e.UnsignedShort565Type=Ro,e.UnsignedInt248Type=Ao,e.AlphaFormat=Uo,e.RGBFormat=Bo,e.RGBAFormat=Po,e.LuminanceFormat=No,e.LuminanceAlphaFormat=ko,e.RGBEFormat=Fo,e.DepthFormat=Ho,e.DepthStencilFormat=Go,e.RGB_S3TC_DXT1_Format=Vo,e.RGBA_S3TC_DXT1_Format=zo,e.RGBA_S3TC_DXT3_Format=Wo,e.RGBA_S3TC_DXT5_Format=qo,e.RGB_PVRTC_4BPPV1_Format=jo,e.RGB_PVRTC_2BPPV1_Format=Xo,e.RGBA_PVRTC_4BPPV1_Format=Yo,e.RGBA_PVRTC_2BPPV1_Format=Zo,e.RGB_ETC1_Format=Ko,e.LoopOnce=2200,e.LoopRepeat=Qo,e.LoopPingPong=2202,e.InterpolateDiscrete=2300,e.InterpolateLinear=2301,e.InterpolateSmooth=2302,e.ZeroCurvatureEnding=Jo,e.ZeroSlopeEnding=2401,e.WrapAroundEnding=2402,e.TrianglesDrawMode=$o,e.TriangleStripDrawMode=es,e.TriangleFanDrawMode=ts,e.LinearEncoding=is,e.sRGBEncoding=ns,e.GammaEncoding=rs,e.RGBEEncoding=as,e.LogLuvEncoding=3003,e.RGBM7Encoding=os,e.RGBM16Encoding=ss,e.RGBDEncoding=ls,e.BasicDepthPacking=cs,e.RGBADepthPacking=us,e.CubeGeometry=Se,e.Face4=Tr,e.LineStrip=0,e.LinePieces=1,e.MeshFaceMaterial=Ir,e.MultiMaterial=Sr,e.PointCloud=Or,e.Particle=Dr,e.ParticleSystem=Rr,e.PointCloudMaterial=Ar,e.ParticleBasicMaterial=Ur,e.ParticleSystemMaterial=Br,e.Vertex=Pr,e.DynamicBufferAttribute=Nr,e.Int8Attribute=kr,e.Uint8Attribute=Fr,e.Uint8ClampedAttribute=Hr,e.Int16Attribute=Gr,e.Uint16Attribute=Vr,e.Int32Attribute=zr,e.Uint32Attribute=Wr,e.Float32Attribute=qr,e.Float64Attribute=jr,e.ClosedSplineCurve3=Xr,e.SplineCurve3=Yr,e.Spline=Zr,e.BoundingBoxHelper=Kr,e.EdgesHelper=Qr,e.WireframeHelper=Jr,e.XHRLoader=$r,e.BinaryTextureLoader=ea,e.GeometryUtils=Ks,e.ImageUtils=Qs,e.Projector=ta,e.CanvasRenderer=ia,Object.defineProperty(e,"__esModule",{value:!0})}),CLOUD.CameraControl=function(e,t,i,n,r){function a(){return null!=f.pivot?f.pivot:f.scene.getBoundingBox().getCenter()}function o(){var e=f.camera,t=e.position,i=f.camera.target.clone().sub(t);i.normalize();var n=new THREE.Plane;n.setFromNormalAndCoplanarPoint(i.clone().negate(),a()),n.normalize();var r=n.distanceToPoint(t),o=r*Math.tan(.5*e.fov),s=f.getContainerDimensions();return 2*o/(s.height-s.top)}function s(){f.pivotBallGroup=f.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.PIVOTBALL,{priority:10,globalSpace:!1});var e=new THREE.SphereBufferGeometry(15,64,64),t=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:16777215,depthTest:!1,opacity:.5,transparent:!0}));e=new THREE.SphereBufferGeometry(1,64,64);var i=new THREE.Mesh(e,new THREE.MeshPhongMaterial({color:16711680,depthTest:!1,opacity:.5,transparent:!0}));f.pivotBallGroup.add(t),f.pivotBallGroup.add(i)}function l(e,t,i,n){var r=new THREE.Matrix4;r.getInverse(t);var a=new THREE.Vector3(e.position.x,e.position.y,e.position.z),o=a.clone();o.applyMatrix4(r);var s=new THREE.Vector3(i.x,i.y,i.z);return s.add(a),s.applyMatrix4(r),s.sub(o).normalize().multiplyScalar(n),s.add(o),s.applyMatrix4(t),s.sub(a),s}this.viewer=e,this.camera=i,this.domElement=n,this.scene=t,this.intersector=new CLOUD.IntersectHelper(e);var c,u=new THREE.Vector3(0,1,0),h=new THREE.Vector3,d=new THREE.Quaternion,f=this,p=!1;this.collisionManager=new CLOUD.CollisionManager,this.pivotBallGroup=null,this.minDollyDistance=.7,this.gravity=0,this.destroy=function(){this.viewer=null,this.camera=null,this.domElement=null,this.scene=null,this.intersector.destroy(),this.intersector=null,this.collisionManager=null,this.pivotBallGroup=null,this.minDollyDistance=.7},this.isCameraChanging=function(){return p},this.setCameraChanging=function(e){p=e},this.setCamera=function(e){this.camera=e},this.getCamera=function(){return this.camera.updateMVP(),this.camera},this.dirtyCamera=function(e){this.camera.dirty=e},this.getFrustum=function(){return this.camera.getFrustum()},this.lockAxisZ=function(e){CLOUD.EditorConfig.LockAxisZ=e},this.isLockedAxisZ=function(){return CLOUD.EditorConfig.LockAxisZ},this.getClientSize=function(){var e=f.domElement===document?f.domElement.body:f.domElement;return new THREE.Vector2(e.clientWidth,e.clientHeight)},this.delayHandle=function(){function e(){f.update(!0,!0)}this.timeoutId&&clearTimeout(this.timeoutId),this.timeoutId=setTimeout(e,200),this.needUpdateRenderList(!1)},this.processRotate=function(e,t){var i=this.getClientSize(),n=-2*Math.PI*e.x/i.x,r=-2*Math.PI*e.y/i.y;f.handleRotation(n,r,t)},this.handleRotation=function(e,t,i){var n=this.camera,r=n.position,a=n.target,o=n.getWorldDirection(),s=a.clone().sub(r),l=s.length(),c=null,h=function(e){var t,n,c,u=new THREE.Vector3;i?(t=r.clone().sub(i),n=t.length(),t.normalize(),c=t.clone().applyQuaternion(e).normalize(),r.copy(i).add(c.multiplyScalar(n)),o.applyQuaternion(e).normalize(),u.copy(r).add(o.multiplyScalar(l)),a.copy(u)):(t=s.clone(),n=l,t.normalize(),c=t.clone().applyQuaternion(e).normalize(),u.copy(r).add(c.multiplyScalar(n)),a.copy(u))},d=n.realUp||n.up,f=o.clone().cross(d).normalize(),p=f.clone().cross(o).normalize();n.realUp.copy(p);var m;CLOUD.EditorConfig.LockAxisZ?Math.abs(e)>Math.abs(t)&&(m=u,c=(new THREE.Quaternion).setFromAxisAngle(m,e),h(c),n.realUp.applyQuaternion(c).normalize()):Math.abs(e)>Math.abs(t)?(m=n.up.clone().normalize(),c=(new THREE.Quaternion).setFromAxisAngle(m,e),h(c),n.realUp.applyQuaternion(c).normalize()):Math.abs(t)>1e-4&&(m=o.clone().cross(d).normalize(),c=(new THREE.Quaternion).setFromAxisAngle(m,t),h(c),n.realUp.applyQuaternion(c).normalize(),this.adjustCameraUp()),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.adjustCameraForPan=function(e){var t=this.camera;t.target.add(e),t.position.add(e),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.updateCamera=function(){var e=this.camera;e.dirty&&(e.lookAt(e.target),e.updateMVP())},this.update=function(e,t){this.updateCamera();var i=this.camera;e?(void 0!==t&&this.needUpdateRenderList(t),r(),h.copy(i.position),d.copy(i.quaternion)):(h.distanceToSquared(i.position)>1e-6||8*(1-d.dot(i.quaternion))>1e-6)&&(r(),h.copy(i.position),d.copy(i.quaternion))},this.updateView=function(e){void 0!==e&&this.needUpdateRenderList(e),r()},this.updateHighlight=function(){r(!0)},this.needUpdateRenderList=function(e){this.viewer.editorManager.isUpdateRenderList=e},this.pan=function(e,t){function i(e){var t=f.camera.matrix.elements;a.set(t[0],t[1],t[2]),a.multiplyScalar(-e),f.camera.target.add(a),f.camera.position.add(a)}function n(e){var t=f.camera.matrix.elements;a.set(t[4],t[5],t[6]),a.multiplyScalar(e),f.camera.target.add(a),f.camera.position.add(a)}var r=f.domElement===document?f.domElement.body:f.domElement,a=new THREE.Vector3;if(f.camera.isPerspective){var o=f.camera.position,s=o.clone().sub(f.camera.target).length();s*=Math.tan(f.camera.fov/2*Math.PI/180),i(2*e*s/r.clientHeight),n(2*t*s/r.clientHeight)}else void 0!==f.camera.top?(i(e*(f.camera.right-f.camera.left)/r.clientWidth),n(t*(f.camera.top-f.camera.bottom)/r.clientHeight)):CLOUD.Logger.warn("WARNING: CloudPickEditor.js encountered an unknown camera type - pan disabled.");this.dirtyCamera(!0),this.setCameraChanging(!0)},this.panOnWorld=function(){var e=new THREE.Vector3,t=new THREE.Vector3,i=new THREE.Vector3;return function(n,r,a,o){var s=f.getContainerDimensions(),l=n.x-s.left,c=n.y-s.top;e.x=l/s.width,e.y=c/s.height,l=r.x-s.left,c=r.y-s.top,t.x=l/s.width,t.y=c/s.height,i.subVectors(t,e);var u=-i.x*o.x,h=i.y*o.y,d=f.getWorldRight().multiplyScalar(u),p=f.getWorldUp().multiplyScalar(h);a.addVectors(d,p),f.dirtyCamera(!0),f.setCameraChanging(!0)}}(),this.adjustCameraForDolly=function(e,t){var i=e-1;if(Math.abs(i)<1e-6)return!1;var n=this.camera,r=n.position,a=this.getWorldEye(),o=new THREE.Vector3;t?o.subVectors(t,r):o.copy(a),o.multiplyScalar(i);var s=o.length();n.isPerspective?s<this.minDollyDistance&&o.normalize().multiplyScalar(this.minDollyDistance):(n.orthoScale*=e,n.setZoom(n.orthoScale));var l=new THREE.Vector3;l.addVectors(r,o),this._goingToDolly(n,l,i)&&(n.position.copy(l),n.target.copy(a.add(l)),this.dirtyCamera(!0),this.setCameraChanging(!0))},this._goingToDolly=function(e,t,i){if(!e.isPerspective||!CLOUD.GlobalData.ConstraintZoom)return!0;var n=this.scene.getBoundingBox();if(i>0){var r=(new THREE.Matrix4).compose(t,e.quaternion,e.scale),a=(new THREE.Matrix4).getInverse(r),o=(new THREE.Matrix4).multiplyMatrices(e.projectionMatrix,a);return!!(new THREE.Frustum).setFromMatrix(o).intersectsBox(n)}var s=n.getSize().length(),l=n.getCenter(),c=.5*s/Math.tan(THREE.Math.degToRad(.5*e.fov)),u=2*c;return t.distanceTo(l)<u},this.dolly=function(e,t,i){var n=new THREE.Vector2(e,t),r=this.getIntersectContext(n),a=this.intersector.hitTest(r);null!=a?this.adjustCameraForDolly(i,a):this.adjustCameraForDolly(i,null)},this.dollyByPoint=function(e,t,i){var n=this.getTrackingPoint(e,t);this.adjustCameraForDolly(i,n)},this.endOperation=function(){this.intersector.lastIntersect=null},this.zoom=function(e,t,i){var n;n=e>0?1/(1-e):1+e,void 0===t||void 0===i?this.adjustCameraForDolly(n,null):this.dollyByPoint(t,i,n),this.update()},this.getContainerDimensions=function(){return CLOUD.DomUtil.getContainerOffsetToClient(this.domElement)},this.computeFrustum=function(){var e=new THREE.Matrix4,t=new THREE.Matrix4;return function(i,n,r,a,o,s){var l=this.camera,c=l.near*Math.tan(THREE.Math.degToRad(.5*l.fov)),u=c*l.aspect,h=(i-s.left)/s.width*2-1,d=(n-s.left)/s.width*2-1,f=-(r-s.top)/s.height*2+1,p=-(a-s.top)/s.height*2+1;e.makePerspective(h*u,d*u,f*c,p*c,l.near,l.far),l.updateMatrixWorld(),l.matrixWorldInverse.getInverse(l.matrixWorld),t.multiplyMatrices(e,l.matrixWorldInverse),o.setFromMatrix(t)}}(),this.screenToCanvas=function(e,t){var i=this.getContainerDimensions();return{x:e-i.left,y:t-i.top}},this.mapScreenToLocal=function(e,t,i){var n=this.getContainerDimensions();i.set(e-n.left,n.height-(t-n.top))},this.mapWindowToViewport=function(e,t,i){var n=this.getContainerDimensions(),r=i||new THREE.Vector2;return r.x=(e-n.left)/n.width*2-1,r.y=-(t-n.top)/n.height*2+1,r},this.getCameraName=function(){return this.camera===e.defaultCamera?this.camera.isPerspective?"persp":"orth":this.camera.name},this.getCameraInfo=function(){var e=new CLOUD.CameraInfo(this.getCameraName(),this.camera.position,this.camera.target,this.camera.up);return JSON.stringify(e)},this.isKeepZoom=function(e,t,i){this.dirtyCamera(!0),this.setCameraChanging(!0),void 0===t&&(t=this.minDistance),void 0===i&&(i=this.maxDistance);var n=this.camera.position,r=this.camera.target,a=new THREE.Vector3;a.copy(n).sub(r);var o=a.length()*(2-e);return!(o<t||o>i)},this.computeRotation=function(){var e=new THREE.Matrix4;e.lookAt(this.camera.position,this.camera.target,this.camera.up);var t=new THREE.Quaternion;t.setFromRotationMatrix(e);var i=new THREE.Euler;return i.setFromQuaternion(t,void 0,!1),i},this.adjustCameraUp=function(){this.camera.realUp.y>0?this.camera.up=new THREE.Vector3(0,1,0):this.camera.realUp.y<0?this.camera.up=new THREE.Vector3(0,-1,0):this.camera.realUp.x>0?this.camera.up=new THREE.Vector3(1,0,0):this.camera.realUp.x<0?this.camera.up=new THREE.Vector3(-1,0,0):this.camera.realUp.z>0?this.camera.up=new THREE.Vector3(0,0,1):this.camera.realUp.z<0&&(this.camera.up=new THREE.Vector3(0,0,-1))},this.getWorldEye=function(){return this.camera.target.clone().sub(this.camera.position)},this.getWorldRight=function(){var e=new THREE.Vector3,t=this.camera.up,i=this.getWorldEye();return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()},this.getWorldRightByRealUp=function(){var e=new THREE.Vector3,t=this.camera.realUp,i=this.getWorldEye();return e.crossVectors(i,t),0===e.lengthSq()&&(t.z>t.y?i.y-=1e-4:i.z+=1e-4,e.crossVectors(i,t)),e.normalize()},this.getWorldUp=function(){var e=this.getWorldRight(),t=this.getWorldEye();return e.cross(t).normalize()},this.getWorldDimension=function(e,t){var i=this.camera.position,n=this.getWorldEye().normalize(),r=this.getTrackingPoint(e,t),a=r.clone().sub(i),o=Math.abs(n.dot(a)),s=this.getContainerDimensions(),l=s.width/s.height,c=2*o*Math.tan(THREE.Math.degToRad(.5*this.camera.fov)),u=c*l;return new THREE.Vector2(u,c)},this.getWorldPointFromNearPlane=function(e,t){var n=new THREE.Vector3(e,t,0);return n.unproject(i),n},this.getTrackingPoint=function(e,t){var i=new THREE.Vector2(e,t),n=this.getIntersectContext(i),r=this.intersector.hitTest(n);if(!r){var a=n.mouse,o=this.camera.position,s=this.getWorldEye(),l=s.clone().normalize(),u=this.getWorldPointFromNearPlane(a.x,a.y),h=new THREE.Ray;if(this.camera.isPerspective)h.origin.copy(o),h.direction.copy(u.clone().sub(o).normalize());else{var d=u.clone();d.sub(s),h.origin.copy(d),h.direction.copy(l)}if(c){var f=new THREE.Plane;if(f.setFromNormalAndCoplanarPoint(l,c),r=h.intersectPlane(f)){r.distanceTo(o)<1e-6&&(r=this.getTrackingPointFromBoundingBox(l,h))}else r=this.getTrackingPointFromBoundingBox(l,h)}else r=this.getTrackingPointFromBoundingBox(l,h);r||(CLOUD.Logger.log("tracking point is default!"),r=u)}return c=r.clone(),r},this.getTrackingPointFromBoundingBox=function(e,t){return this.scene.getTrackingPointFromBoundingBox(e,t)},this.setCameraPosition=function(e){var t=this.camera,i=this.getWorldEye(),n=i.length(),r=i.clone();r.normalize(),r.setLength(n),t.position.copy(e),t.target.addVectors(t.position,r),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.moveStraight=function(e,t){var i=this.camera.position,n=this.camera.target;if(t){var r=new THREE.Vector3(n.x-i.x,0,n.z-i.z),a=r.length(),o=e/a,s=new THREE.Vector3(r.x*o,0,r.z*o);i.add(s),n.add(s)}else{var l=n.clone().sub(i);this.camera.translateZ(-e),n.addVectors(i,l)}this.dirtyCamera(!0),this.setCameraChanging(!0)},this.getIntersectContext=function(e){var t=new CLOUD.IntersectContext,i=this,n=i.viewer.modelManager;return t.scene=i.scene,t.camera=this.camera,t.isExploded=0!=n.explosionExtent||0!=n.floorExplosionExtent,null!=e&&i.mapWindowToViewport(e.x,e.y,t.mouse),t.viewportSize=i.viewer.renderer.getSize(),t.octreeRoots=n.getOctreeRoots(),t.octantMap=n.getOctantMap(),t},this.getLastIntersect=function(){return this.intersector.lastIntersect},this.calculatePivot=function(e,t){function i(e){var t=n.getIntersectContext(e),i=n.intersector.hitTest(t);if(i)return i;var o=r.getFilter(),s=o.getVisibleComponentsBbox().clone();if(s.applyMatrix4(a.getMatrixGlobal()),s.isEmpty()&&(s=a.getBoundingBox()),a.hasClipPlanes()&&a.getClipPlanes().isEnabled()){var l=a.getClipPlanes().getClipBoundingBox();s.intersect(l)}else if(a.hasFillClipPlanes()&&a.getFillClipPlane().isEnabled()){var c=a.getFillClipPlane().getFillClipBoundingBox();s.intersect(c)}return s.getCenter()}var n=this,r=this.viewer,a=this.scene,o=null;switch(e){case CLOUD.RotatePivotMode.SELECTION:if(a.hasClipPlanes()&&a.getClipPlanes().isEnabled()){var s=a.getClipPlanes().getClipBoundingBox();if(s&&!s.isEmpty()&&a.getClipPlanes().isVisible()){o=s.getCenter();break}}if(a.hasFillClipPlanes()&&a.getFillClipPlane().isEnabled())var l=a.getFillClipPlane().getFillClipBoundingBox();var c=r.modelManager.sceneState,u=function(e){for(var t={},i=r.getFilter(),n=Object.keys(e),a=0;a<n.length;a++)i._isVisible({name:n[a]})&&(t[n[a]]=!0);return t}(c.getSelectionSet()),h=r.getBoundingBoxByIds(u);CLOUD.GlobalData.IsMobile?o=i(t):!h||h.isEmpty()?o=i(t):(s?h.intersect(s):l&&h.intersect(l),o=h.getCenter());break;case CLOUD.RotatePivotMode.CENTER:o=a.getBoundingBox().getCenter();break;case CLOUD.RotatePivotMode.CAMERA:o=null;break;default:o=i(t)}return this.dirtyCamera(!0),this.setCameraChanging(!0),this.pivot=o,o},this.touchUpdateRotationInPersonView=function(e,t){this.dirtyCamera(!0),this.setCameraChanging(!0);var i=this,n=this.camera.position,r=this.camera.target.clone().sub(n),a=r.length(),o=this.camera.getWorldDirection(),s=this.camera.realUp||this.camera.up,l=o.clone().cross(s).normalize(),c=l.clone().cross(o).normalize();this.camera.realUp.copy(c);var h,d;if(Math.abs(e)>Math.abs(t))h=u,d=e;else if(!CLOUD.EditorConfig.LockAxisZ){h=l;var f=new THREE.Vector3(0,1,0).clone().cross(s),p=f.dot(l),m=Math.asin(f.length());p<0&&(m=-m),m+t>Math.PI/4-1e-6?t=Math.PI/4-1e-6-m:m+t<-Math.PI/4+1e-6&&(t=-Math.PI/4+1e-6-m),d=t}var g=(new THREE.Quaternion).setFromAxisAngle(h,d);!function(e){var t=new THREE.Vector3;o.applyQuaternion(e).normalize(),t.copy(n).add(o.multiplyScalar(a)),i.camera.target.copy(t)}(g),this.camera.realUp.applyQuaternion(g).normalize()},this.touchUpdateRotationInModelView=function(e,t,i){this.dirtyCamera(!0),this.setCameraChanging(!0);var n=i||this.scene.getBoundingBox().getCenter(),r=this.camera.position,l=this.camera.target.clone().sub(r),c=l.length(),h=r.clone().sub(n),d=h.length(),p=null,m=this.camera.getWorldDirection();h.normalize();var g=function(e){var t=new THREE.Vector3,i=h.clone().applyQuaternion(e).normalize();r.copy(n).add(i.multiplyScalar(d)),m.applyQuaternion(e).normalize(),t.copy(r).add(m.multiplyScalar(c)),f.camera.target.copy(t)},v=this.camera.realUp||this.camera.up,y=m.clone().cross(v).normalize(),E=y.clone().cross(m).normalize();this.camera.realUp.copy(E);var x;if(CLOUD.EditorConfig.LockAxisZ)Math.abs(e)>Math.abs(t)&&(x=u,p=(new THREE.Quaternion).setFromAxisAngle(x,e),g(p),this.camera.realUp.applyQuaternion(p).normalize());else if(Math.abs(e)>Math.abs(t))x=this.camera.up.clone().normalize(),p=(new THREE.Quaternion).setFromAxisAngle(x,e),g(p),this.camera.realUp.applyQuaternion(p).normalize();else if(Math.abs(t)>.01){x=m.clone().cross(v).normalize();var b=new THREE.Vector3(0,1,0).clone().cross(v),C=b.dot(y),M=Math.asin(b.length());C<0&&(M=-M),M+t>Math.PI/2-1e-6?t=Math.PI/2-1e-6-M:M+t<-Math.PI/2+1e-6&&(t=-Math.PI/2+1e-6-M),p=(new THREE.Quaternion).setFromAxisAngle(x,t),g(p),this.camera.realUp.applyQuaternion(p).normalize(),this.adjustCameraUp()}this.pivotBallGroup||s(),this.pivotBallGroup.visible=!0;for(var _=o(),w=a(),L=0;L<this.pivotBallGroup.children.length;L++){var T=this.pivotBallGroup.children[L];T.position.copy(w),T.scale.set(_,_,_),T.updateMatrixWorld()}},this.touchUpdateRotation=function(e,t){var i=this.camera.position;this.scene.getBoundingBox().containsPoint(i)?this.touchUpdateRotationInPersonView(e,t):this.touchUpdateRotationInModelView(e,t,a())},this.clearTouchRotateState=function(){this.pivotBallGroup&&(this.pivotBallGroup.visible=!1)},this.touchEndHandler=function(){this.viewer.editorManager.cameraChange=!1,this.clearTouchRotateState(),this.touchUpdate()},this._adjustCameraForDolly=function(e,t){var i=.5*(t-1);if(Math.abs(i)<1e-6)return!1;var n=this.camera,r=n.position,a=this.getWorldEye(),o=new THREE.Vector3;e?o.subVectors(e,r):o.copy(a),o.multiplyScalar(i);var s=o.length();n.isPerspective&&s<this.minDollyDistance&&o.normalize().multiplyScalar(this.minDollyDistance);var l=new THREE.Vector3;return l.addVectors(r,o),n.isPerspective||(n.orthoScale*=t,n.setZoom(n.orthoScale)),n.position.copy(l),n.target.copy(a.add(l)),this.dirtyCamera(!0),this.setCameraChanging(!0),!0},this.touchDolly=function(e,t,i){var n=new THREE.Vector2(e,t),r=this.getIntersectContext(n),a=this.intersector.hitTest(r);null!=a?this._adjustCameraForDolly(a,i):this._adjustCameraForDolly(null,i)},this.touchUpdate=function(){var e=new THREE.Vector3,t=new THREE.Quaternion;return function(){var i=new THREE.Vector3;i.copy(this.camera.up),this.camera.up.copy(this.camera.realUp),this.camera.lookAt(this.camera.target),this.camera.up.copy(i),this.camera.updateMVP(),(e.distanceToSquared(this.camera.position)>1e-6||8*(1-t.dot(this.camera.quaternion))>1e-6)&&(r(),this.dirtyCamera(!1),e.copy(this.camera.position),t.copy(this.camera.quaternion))}}(),this.goTurnForWalk=function(e){var t=this.getCamera(),i=t.position,n=t.target,r=new THREE.Vector3(n.x-i.x,0,n.z-i.z),a=Math.cos(e),o=Math.sin(e),s=new THREE.Vector3(r.x*a-r.z*o,0,r.x*o+r.z*a);n.x=i.x+s.x,n.z=i.z+s.z,this.dirtyCamera(!0),this.setCameraChanging(!0)},this.goPitchForWalk=function(e){var t=this.getCamera(),i=t.position,n=t.target,r=n.x-i.x,a=n.z-i.z,o=Math.sqrt(r*r+a*a),s=new THREE.Vector3(o,n.y-i.y,0),l=Math.cos(e),c=Math.sin(e),u=new THREE.Vector3(s.x*l-s.y*c,s.x*c+s.y*l,0);n.y=i.y+u.y,this.dirtyCamera(!0),this.setCameraChanging(!0)},this.goUpDownForWalk=function(e){var t=this.getCamera(),i=t.position,n=t.target,r=new THREE.Vector3(0,1,0),a=this.scene.getMatrixGlobal(),o=l(t,a,r,e);i.y+=o.y,n.y+=o.y,this.dirtyCamera(!0),this.setCameraChanging(!0)},this.stepCameraForWalk=function(e,t){var i,n=this.getCamera(),r=n.position,a=n.target,o=new THREE.Vector3(a.x-r.x,0,a.z-r.z).normalize(),s=new THREE.Vector3(0,1,0),c=o.clone().cross(s),u=this.scene.getMatrixGlobal();switch(e){case CLOUD.MoveDirection.FORWARD:i=l(n,u,o,t),i.y=0;break;case CLOUD.MoveDirection.BACK:o.multiplyScalar(-1),i=l(n,u,o,t),i.y=0;break;case CLOUD.MoveDirection.LEFT:c.multiplyScalar(-1),i=l(n,u,c,t),i.y=0;break;case CLOUD.MoveDirection.RIGHT:i=l(n,u,c,t),i.y=0}r.add(i),a.add(i),this.dirtyCamera(!0),this.setCameraChanging(!0)},this.hitTestWithGround=function(){var e=this.getCamera(),t=e.up.clone().multiplyScalar(-1),i=new THREE.Ray(e.position.clone(),t),n=this.getIntersectContext(null),r=this.intersector.byGravity;this.intersector.byGravity=!0;var a=this.intersector.intersect(n,i,!1);return this.intersector.byGravity=r,a},this.hitTestForward=function(e){var t=this.getCamera(),i=this.getWorldEye();i.normalize(),i=i.multiplyScalar(e);var n=new THREE.Ray(t.position.clone(),i),r=this.getIntersectContext(null);return this.intersector.intersect(r,n,!1)},this.hitTestRight=function(e){var t=this.getCamera(),i=this.getWorldEye();i.normalize();var n=t.up,r=i.cross(n).normalize();r=r.multiplyScalar(e);var a=new THREE.Ray(t.position.clone(),r),o=this.getIntersectContext(null);return this.intersector.intersect(o,a,!1)},this.computeGravity=function(){this.gravity=0;var e=this.hitTestWithGround();if(null==e){var t=this.scene.getMatrixGlobal(),i=new THREE.Matrix4;i.getInverse(t);var n=this.camera.position.clone();n.applyMatrix4(i),n.z=0,n.applyMatrix4(t),this.distanceToGround=Math.abs(this.camera.position.y-n.y),void 0!=this.hitNullCount&&0!=this.hitNullCount||(this.hitNullCount=1)}else this.hitNullCount=0;if(1==this.hitNullCount)return void(this.gravity=0);if(void 0===this.manHeight)this.computeManHeight();else{var r=e?e.distance-this.manHeight:this.distanceToGround-this.manHeight;if(r/=this.scene.getGlobalScaleFactor(),Math.abs(r)<.1)return;this.gravity=r}},this.computeManHeight=function(){if(!this.manHeight){var e=this.hitTestWithGround(),t=this.scene.getMatrixGlobal(),i=new THREE.Matrix4;if(i.getInverse(t),null!=e){var n=e.point.clone();n.applyMatrix4(i),n.z+=1650,n.applyMatrix4(t),this.manHeight=Math.abs(e.point.y-n.y)}else{var r=this.camera.position.clone();r.applyMatrix4(i),r.z=0;var a=r.clone();a.z+=1650,r.applyMatrix4(t),a.applyMatrix4(t),this.manHeight=Math.abs(a.y-r.y)}}},this.walkWithParallelEye=function(){var e=this.camera,t=this.getWorldEye(),i=t.length(),n=this.scene,r=n.getBoundingBox().getCenter(),a=new THREE.Vector3;a.subVectors(r,e.position);var o=a.length();a.y=0,a.normalize(),a.multiplyScalar(o),e.position.subVectors(r,a),e.target.addVectors(e.position,a.normalize().multiplyScalar(i));var s=new THREE.Vector3(0,1,0)
;e.up.copy(s),e.realUp.copy(s),this.dirtyCamera(!0),this.setCameraChanging(!0),this.update(!0)},this.updateFlyMove=function(e,t){var i=this.camera;this.dirtyCamera(!0),this.setCameraChanging(!0);var n=CLOUD.MoveDirection;e&n.FORWARD&&i.translateZ(-t),e&n.BACK&&i.translateZ(t),e&n.LEFT&&i.translateX(-t),e&n.RIGHT&&i.translateX(t),e&n.UP&&i.translateY(t),e&n.DOWN&&i.translateY(-t),this.flyOnWorld()},this.flyOnWorld=function(e){var t=this.camera,i=t.up.clone();e=!1!==e,e&&t.realUp&&(t.up.copy(t.realUp),t.lookAt(t.target),t.up.copy(i)),r(),this.dirtyCamera(!1),h.copy(t.position),d.copy(t.quaternion)},this.rotateForFly=function(e,t,i,n){var r=this.camera,a=r.position,o=r.target,s=o.clone().sub(a),l=new THREE.Vector3(0,1,0),c=r.realUp||r.up,u=s.clone().cross(c).normalize();if(this.dirtyCamera(!0),this.setCameraChanging(!0),CLOUD.EditorConfig.LockAxisZ&&(t=0),0!=t){var h=(new THREE.Quaternion).setFromAxisAngle(u,-t),d=s.clone();d.applyQuaternion(h);var f=d.angleTo(l);f-=.5*Math.PI,f>=i&&f<=n&&s.applyQuaternion(h)}if(0!=e){var p=(new THREE.Quaternion).setFromAxisAngle(l,-e);s.applyQuaternion(p)}o.addVectors(a,s),this.flyOnWorld()},this.fitAndRotateBySelection=function(){this.viewer.zoomToSelection()},this.flyToPointWithParallelEye=function(e){var t=this.getWorldEye(),i=t.length(),n=t.clone();n.y=0,n.normalize(),n.setLength(i);var r=new THREE.Vector3(0,1,0);this.camera.up=r,this.camera.realUp=r.clone(),this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,n),this.update(!0)},this.flyToPoint=function(e){var t=this.getWorldEye();this.camera.position.copy(e),this.camera.target.addVectors(this.camera.position,t),this.update(!0)},this.setCameraHeight=function(e,t){this.cameraAbsoluteHeightEnabled=!1,this.cameraRelativeHeight=t,void 0===this.cameraConstraintHeights?this.cameraConstraintHeights=[]:this.cameraConstraintHeights.length=0;for(var i=0,n=e.length;i<n;++i)this.cameraConstraintHeights[i]=e[i]},this.setCameraAbsoluteHeight=function(e){this.cameraAbsoluteHeightEnabled=!0,this.cameraAbsoluteHeight=e},this.updateCameraHeight=function(){var e,t,i=this.scene,n=this.getCamera(),r=i.drawingToWorld(n.position),a=r.z;if(this.cameraAbsoluteHeightEnabled)void 0===this.cameraAbsoluteHeight&&(this.cameraAbsoluteHeight=a),e=this.cameraAbsoluteHeight;else if(void 0===this.cameraConstraintHeights)e=a;else{var o=CLOUD.Utils.findRange(this.cameraConstraintHeights,a);if(e=this.cameraConstraintHeights[o],e+=this.cameraRelativeHeight,o<this.cameraConstraintHeights.length-1){var s=this.cameraConstraintHeights[o+1];e>s&&(e=s)}}e!==a&&(t=i.worldToDrawing({x:r.x,y:r.y,z:e}),this.setCameraPosition(t))},this.getRaycaster=function(e,t){var i=new CLOUD.Raycaster,n=new THREE.Vector2;return this.mapWindowToViewport(e,t,n),i.setFromCamera(n,this.camera),i},this.translateCameraForWalk=function(e,t){var i=this.collisionManager;if(0!==e.x){if(!1===CLOUD.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t);var n=1;e.x<0&&(n=-1);var r=this.hitTestRight(n);if(r){var a=this.viewer.modelManager.getNodeInfosByUserId(r.userId),o=a?a[0].userData:null,s=i.hasCollision(o,r.distance);0==s&&this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t)}else this.stepCameraForWalk(CLOUD.MoveDirection.RIGHT,e.x*t)}if(0!==e.y)this.goUpDownForWalk(e.y*t*.5);else{var l=t;if(0!=this.gravity){var c=Math.abs(this.gravity);l=l>=c?c:.2*c}this.gravity>0?this.goUpDownForWalk(-l):this.gravity<0&&this.goUpDownForWalk(l)}if(0!==e.z){if(!1===CLOUD.GlobalData.EnableHitDetection)return void this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t);var n=1;e.z>0&&(n=-1);var u=this.hitTestForward(n);if(u){var a=this.viewer.modelManager.getNodeInfosByUserId(u.userId),o=a?a[0].userData:null,s=i.hasCollision(o,u.distance);0==s&&this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t)}else this.stepCameraForWalk(CLOUD.MoveDirection.BACK,e.z*t)}},this.rotateCameraForWalk=function(e,t){0!==e.y&&(this.goTurnForWalk(-e.y*Math.PI*t),e.y=0),0!==e.x&&(this.goPitchForWalk(e.x*Math.PI),e.x=0)},this.zoomCameraForWalk=function(e){this.adjustCameraForDolly(e,null)},this.movePlane=function(e,t,i,n,r){if(void 0==r){var a=new THREE.Plane;a.setComponents(e.x,e.y,e.z,e.w),r=new THREE.Vector3,a.coplanarPoint(r)}var o=new THREE.Vector3(e.x,e.y,e.z),s=this.camera,l=s.getWorldDirection(),c=new THREE.Plane;c.setFromNormalAndCoplanarPoint(l,r);var u=this.getRaycaster(t.clientX,t.clientY),h=new THREE.Vector3,d=this.getRaycaster(i.x,i.y),f=new THREE.Vector3;if(u.ray.intersectPlane(c,h)&&d.ray.intersectPlane(c,f)){h.subVectors(h,f),h.projectOnVector(o);var p=h.length();if(h.dot(o)<0&&(p=-p),0!=p)return n&&(o.multiplyScalar(p),p=o.x+o.y+o.z),p}return null}},CLOUD.IntersectContext=function(){this.scene=null,this.camera=null,this.octreeRoots=null,this.octantMap=null,this.mouse=new THREE.Vector2},CLOUD.IntersectHelper=function(e){this.viewer=e,this.filter=e.filter,this.raycaster=new CLOUD.Raycaster,this.lastIntersect=null},CLOUD.IntersectHelper.prototype.destroy=function(){this.viewer=null,this.filter=null,this.raycaster=null,this.lastIntersect=null},CLOUD.IntersectHelper.prototype.defaultIntersect=function(e,t,i,n){if(e.visible){var r=[];e.raycast(this.raycaster,r);var a=[];if(r.length>0)for(var o=0;o<r.length;o++)r[o].distance<=i.far&&r[o].distance>=i.near&&!this.viewer.clipPoint(r[o].point)&&a.push(r[o]);return n?a:(a.sort(function(e,t){return e.distance-t.distance}),a.length>0?a[0]:null)}},CLOUD.IntersectHelper.prototype.intersectMeshesWithDistance=function(e,t,i,n,r,a){if(!t||!t.mesh)return null;var o,s=this.raycaster,l=[],c=this.filter,u=c._hasVisibleFilter(),h=c._hasSelectableFilter(),d=this.viewer.modelManager;1==this.byGravity?n.near=0:n.near+=-1e-6;var f,p,m=t.info,g=t.mesh,v=[],y=this.viewer.modelManager.getMatrixWorldGlobal();if(r){for(f=0,p=e.length;f<p;f++)!function e(t,i){if(i.push(t),t.childOctants)for(var n=0,r=t.childOctants.length;n<r;n++)e(t.childOctants[n],i)}(e[f],v)}else for(f=0,p=e.length;f<p;f++)s.intersectOctantForNode(e[f],v);for(f=0,p=v.length;f<p;f++){var E=m[v[f].octantId];if(E)for(var x=0,b=E.length;x<b;x++){var C=E[x];if(!function(e,t){var i=d.isHiddenUserId(e.userId);if(t){if(u&&!c._isVisible(e)||h&&!c._isSelectable(e)||i)return!0}else if(u&&!c._isVisible(e)||i)return!0;return!1}(C,i)){var M=C.boundingBox.clone();if(M.applyMatrix4(y),(o=s.ray.intersectBoxWithDistance(M))>=n.near&&o<=n.far){var _;if(CLOUD.GlobalData.BatchMergeEnabled)if(C.instanceOrNot){_=CLOUD.Utils.getCombinedKeyString([C.materialId,C.geometryId]);var w=g[_];if(!w)continue;for(var L=0,T=w.length;L<T;L++){var I=w[L];o=I.intersectBoxWithDistance(s,C.matrix),o>=n.near&&o<=n.far&&l.push({object:I,distance:o,matrix:C.matrix,userId:C.userId}),I=null}}else if(C.single){_=C.nodeId;var w=g[_];if(!w)continue;for(var L=0,T=w.length;L<T;L++)l.push({object:w[L],distance:o,userId:C.userId})}else{_=CLOUD.Utils.getCombinedKeyString([C.materialId,C.uv?"1":"0",C.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE?"lines":"meshes"]);var w=g[_];if(!w)continue;for(var S=null,O=!1,D=-1,L=0,T=w.length;L<T;L++){var R=w[L],A=R._indicesGroup;if(A){var U=A[C.userId];if(U){for(var B=0,P=U.length;B<P;B++)if(U[B].nodeId===C.nodeId){S=U[B],O=!0;break}if(O){D=L;break}}}}-1!==D&&l.push({object:w[D],distance:o,userId:C.userId,indexInfo:S})}else if(C.instanceOrNot){_=CLOUD.Utils.getCombinedKeyString([C.materialId,C.geometryId,C.cellId]),g[_]||(_=CLOUD.Utils.getCombinedKeyString([C.materialId,C.geometryId]));var w=g[_];if(!w)continue;for(var L=0,T=w.length;L<T;L++)l.push({object:w[L],distance:o,matrix:C.matrix,userId:C.userId})}else{_=C.nodeId;var w=g[_];if(!w)continue;for(var L=0,T=w.length;L<T;L++)l.push({object:w[L],distance:o,userId:C.userId})}}}}}if(a)return l;l.sort(function(e,t){return e.distance-t.distance});var N=[],k=[],F=n.far;for(f=0;f<l.length;f++)if(!(l[f].distance>F||l[f].distance<n.near)){var I=l[f].object;N=[];var H=l[f].indexInfo,G=l[f].matrix;if(H?I.raycastByIndices(s,N,H):G?I.raycastByIndices(s,N,null,G):I.raycast(s,N),N.length>0)for(N.sort(function(e,t){return e.distance-t.distance}),x=0,b=N.length;x<b;x++)if(N[x].distance<F&&N[x].distance>n.near&&!this.viewer.clipPoint(N[x].point)){F=N[x].distance- -1e-6,H?(N[x].userId=H.userId,N[x].indexInfo=H):G&&(N[x].userId=l[f].userId,N[x].matrix=l[f].matrix),k.push(N[x]);break}}return k.sort(function(e,t){return e.distance-t.distance}),k.length>0?k[0]:null},CLOUD.IntersectHelper.prototype.intersect=function(e,t,i){var n=this,r=n.raycaster;if(null===t)r.setFromCamera(e.mouse,e.camera);else{var a=t.origin,o=t.direction;r.set(a,o)}r.camera=e.camera,r.viewportSize=e.viewportSize;var s={near:e.camera.near,far:e.camera.far};e.scene.shrinkScopeByClipPlane(r,s);for(var l=[],c=e.scene.getObjectGroups(),u=0;u<c.length;u++)if(c[u].isPickable()&&0!==c[u].children.length){var h=null,d=e.scene.getObjectGroupType(c[u].name);switch(d.groupType){case CLOUD.ObjectGroupType.MODEL:var f=d.databagId;e.octreeRoots[f]&&e.octantMap[f]&&(h=this.intersectMeshesWithDistance(e.octreeRoots[f],e.octantMap[f],i,s,e.isExploded))&&(h.objectType=c[u].pickableType,h.hoverEnabled=c[u].hoverEnabled,l.push(h));break;case CLOUD.ObjectGroupType.GEOMETRY:for(var f in e.octreeRoots)(h=this.intersectMeshesWithDistance(e.octreeRoots[f],e.octantMap[f],i,s,e.isExploded))&&(h.objectType=c[u].pickableType,h.hoverEnabled=c[u].hoverEnabled,l.push(h));break;default:h=this.defaultIntersect(c[u],i,s),h&&(h.objectType=c[u].pickableType,h.hoverEnabled=c[u].hoverEnabled,l.push(h))}}l.sort(function(e,t){return e.distance-t.distance});var p=l.length;if(p>0)for(var m=0;m<p;++m){h=l[m];var g=h.object;if(g.geometry)return h.objectType===CLOUD.PICKABLETYPE.Marker3d?h.userId=h.id:void 0===h.userId&&(h.userId=g.userId||g.name),h.databagId=g.databagId,this.lastIntersect={intersect:h,pickable:i},h}return this.lastIntersect=null,null},CLOUD.IntersectHelper.prototype.getObjectsByClientCoordinates=function(e){var t=this.viewer.cameraControl.getIntersectContext(e),i=this.raycaster;i.setFromCamera(t.mouse,t.camera),i.camera=t.camera,i.viewportSize=t.viewportSize;var n={near:t.camera.near,far:t.camera.far};t.scene.shrinkScopeByClipPlane(i,n);for(var r=[],a=t.scene.getObjectGroups(),o=0;o<a.length;o++)if(a[o].isPickable()&&0!==a[o].children.length){var s=[],l=t.scene.getObjectGroupType(a[o].name);switch(l.groupType){case CLOUD.ObjectGroupType.MODEL:var c=l.databagId;t.octreeRoots[c]&&t.octantMap[c]&&(s=this.intersectMeshesWithDistance(t.octreeRoots[c],t.octantMap[c],!1,n,t.isExploded,!0),r=r.concat(s));break;case CLOUD.ObjectGroupType.GEOMETRY:for(var c in t.octreeRoots)s=this.intersectMeshesWithDistance(t.octreeRoots[c],t.octantMap[c],!1,n,t.isExploded,!0),r=r.concat(s);break;default:s=this.defaultIntersect(a[o],!1,n,!0),r=r.concat(s)}}return r.sort(function(e,t){return e.distance-t.distance}),r},CLOUD.IntersectHelper.prototype.hitTest=function(e){var t=this.intersect(e,null,!1);return null!==t?t.point:null},CLOUD.IntersectHelper.prototype.pick=function(e,t){var i=this.intersect(e,null,!0);return t&&t(i),i},CLOUD.IntersectHelper.prototype.getIntersectByRay=function(e,t){return this.intersect(e,t,!0)},CLOUD.PickUtil={pickByRect:function(e,t,i,n,r){function a(e,i){if(h.set(e.min,e.max),t.intersectsBox(h)){i.push(e);for(var n=0,r=e.childOctants.length;n<r;++n){a(e.childOctants[n],i)}}}var o={},s=n.getOctreeRoots(),l=n.getOctantMap(),c=n.getSceneState(),u=e.getMatrixGlobal(),h=new THREE.Box3,d=new THREE.Vector3,f=new THREE.Vector3,p=n.filter,m=p._hasVisibleFilter(),g=p._hasSelectableFilter();if(i===CLOUD.OPSELECTIONTYPE.Clear)return void c.clearSelection();var v,y,E;for(var x in s){v=[],E=l[x],y=s[x];var b,C;for(b=0,C=y.length;b<C;b++)a(y[b],v);for(b=0,C=v.length;b<C;b++){var M=E.info[v[b].octantId];if(M)for(var _=0,w=M.length;_<w;_++){var L=M[_];(function(e){var t=n.isHiddenUserId(e.userId);return m&&!p._isVisible(e)||g&&!p._isSelectable(e)||t})(L)||(h.copy(L.boundingBox),h.applyMatrix4(u),function(e,t){for(var i=0,n=e.planes,r=0;r<6;r++){var a=n[r];d.x=a.normal.x>0?t.min.x:t.max.x,f.x=a.normal.x>0?t.max.x:t.min.x,d.y=a.normal.y>0?t.min.y:t.max.y,f.y=a.normal.y>0?t.max.y:t.min.y,d.z=a.normal.z>0?t.min.z:t.max.z,f.z=a.normal.z>0?t.max.z:t.min.z;var o=a.distanceToPoint(d),s=a.distanceToPoint(f);if(o<0&&s<0)return!1;o*s>=0&&++i}return 6===i}(t,h)&&!function(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!r.clipPoint(t))return!1;return!0}(h)&&(o[L.userId]=!0))}}}var T=Object.keys(o);T.length>0&&(CLOUD.OPSELECTIONTYPE.Remove===i&&c.removeSelection(T),CLOUD.OPSELECTIONTYPE.Add===i&&c.addSelection(T))},getObjectsInBox:function(e,t,i,n){function r(e){return!(e.max.x<t.min.x||e.min.x>t.max.x||e.max.y<t.min.y||e.min.y>t.max.y||e.max.z<t.min.z||e.min.z>t.max.z)}function a(e,t){if(u.set(e.min,e.max),r(u)){t.push(e);for(var i=0,n=e.childOctants.length;i<n;++i){a(e.childOctants[i],t)}}}var o={},s=i.getOctreeRoots(),l=i.getOctantMap(),c=e.getMatrixGlobal(),u=new THREE.Box3,h=i.filter,d=h._hasVisibleFilter(),f=h._hasSelectableFilter();for(var p in s){var m,g,v=[],y=l[p],E=s[p];for(m=0,g=E.length;m<g;m++)a(E[m],v);for(m=0,g=v.length;m<g;m++){var x=y.info[v[m].octantId];if(x)for(var b=0,C=x.length;b<C;b++){var M=x[b];(function(e){var t=i.isHiddenUserId(e.userId);return d&&!h._isVisible(e)||f&&!h._isSelectable(e)||t})(M)||(u.copy(M.boundingBox),u.applyMatrix4(c),!r(u)||function(e){return e.max.x>=t.max.x&&e.min.x<=t.min.x&&e.max.y>=t.max.y&&e.min.y<=t.min.y&&e.max.z>=t.max.z&&e.min.z<=t.min.z}(u)||function(e){for(var t=new THREE.Vector3,i=0;i<8;++i)if(t.x=i<4?e.min.x:e.max.x,t.y=i/2<2?e.min.y:e.max.y,t.z=i%2==0?e.min.z:e.max.z,!n.clipPoint(t))return!1;return!0}(u)||(o[M.userId]=!0))}}}return Object.keys(o)}},CLOUD.Keys={ALT:18,BACKSPACE:8,LEFT:37,UP:38,RIGHT:39,DOWN:40,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189,ZERO:48,ESC:27,TAB:9},CLOUD.EditorConfig={ReverseWheelDirection:!1,MovementSpeedRate:1,WalkSpeedRate:1,RotatePivotMode:0,NoPan:!1,NoRotate:!1,NoZoom:!1,NoKey:!1,LockAxisZ:!1},CLOUD.BaseEditor=function(e,t){this.name=e,this.cameraControl=t,this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT},this.StateType={NONE:-1,ROTATE:0,DOLLY:1,PAN:2},this.state=this.StateType.NONE,this.zoomSpeed=Math.pow(.95,.2),this.defaultMovementSpeed=.005*CLOUD.GlobalData.SceneSize,this.movementSpeed=this.defaultMovementSpeed,this.minMovementSpeed=.001,this.defaultKeyPanSpeed=2,this.keyPanSpeed=this.defaultKeyPanSpeed,this.minKeyPanSpeed=.01,this.wheelZoomFactor=45e-5},CLOUD.BaseEditor.prototype.getName=function(){return this.name},CLOUD.BaseEditor.prototype.destroy=function(){this.scene=null,this.cameraControl=null,this.mouseButtons=null},CLOUD.BaseEditor.prototype.onExit=function(){},CLOUD.BaseEditor.prototype.onEnter=function(){},CLOUD.BaseEditor.prototype.processMouseDown=function(e){},CLOUD.BaseEditor.prototype.processMouseMove=function(e){},CLOUD.BaseEditor.prototype.processMouseUp=function(e){},CLOUD.BaseEditor.prototype.processMouseWheel=function(e){},CLOUD.BaseEditor.prototype.processMouseDoubleClick=function(e){},CLOUD.BaseEditor.prototype.processKeyDown=function(e){},CLOUD.BaseEditor.prototype.processKeyUp=function(e){},CLOUD.BaseEditor.prototype.processTouchstart=function(e){},CLOUD.BaseEditor.prototype.processTouchmove=function(e){},CLOUD.BaseEditor.prototype.processTouchend=function(e){},CLOUD.BaseEditor.prototype.processHover=function(e){},CLOUD.BaseEditor.prototype.moveTo=function(e,t,i){},CLOUD.BaseEditor.prototype.rotateTo=function(e){},CLOUD.BaseEditor.prototype.dispatchEvent=function(e){this.cameraControl.viewer.modelManager.dispatchEvent(e)},CLOUD.BaseEditor.prototype.updateButtons=function(e){void 0!==e.ORBIT&&(this.mouseButtons.ORBIT=e.ORBIT),void 0!==e.PAN&&(this.mouseButtons.PAN=e.PAN),void 0!==e.PAN2&&(this.mouseButtons.PAN2=e.PAN2),void 0!==e.ZOOM&&(this.mouseButtons.ZOOM=e.ZOOM)},CLOUD.PickHelper=function(e){this.cameraControl=e,this.scene=e.scene,this.timerId=null,this.lastIntersected=null},CLOUD.PickHelper.prototype={constructor:CLOUD.PickHelper,destroy:function(){this.cameraControl=null,this.scene=null},click:function(e,t){function i(){t&&!1===t.pickable&&(t=null),CLOUD.Logger.time("handle mouse pick."),n.handleMousePick(e,!1,t),CLOUD.Logger.timeEnd("handle mouse pick.")}var n=this;if(e.button===THREE.MOUSE.RIGHT)return void i();this.timerId&&clearTimeout(this.timerId),this.timerId=setTimeout(i,500)},doubleClick:function(e){e.preventDefault(),this.timerId&&clearTimeout(this.timerId),this.handleMousePick(e,!0,null)},handleMousePick:function(e,t,i){function n(i,n){c.dispatchEvent({type:CLOUD.EVENTS.ON_CLICK_PICK,event:e,doubleClick:t,canvasPos:{x:l.x,y:l.y},intersectInfo:i?{selectedObjectId:i.userId,objectType:i.objectType,selectable:n,modelId:i.databagId,worldPosition:i.worldPosition,worldBoundingBox:i.worldBoundingBox,point:i.point,innnerDebugging:i.innnerDebugging}:null})}if(this._canPick()||e.button!==THREE.MOUSE.LEFT){var r=this,a=this.cameraControl,o=a.viewer.modelManager.sceneState,s=new THREE.Vector2(e.clientX,e.clientY),l=a.screenToCanvas(e.clientX,e.clientY),c=a.viewer.modelManager,u=null;if(i)i.pickable&&(u=i.intersect);else{var h=a.getIntersectContext(s);u=a.intersector.pick(h,null)}if(!u){var d=o.getSelection();if(e.ctrlKey)return;return d.length>0&&(o.clearSelection(),a.updateView(!0)),r.setSelectedIdsForOutline(o.getSelection()),void(i&&!i.pickable?(u=i.intersect,u.cx=s.x,u.cy=s.y,n(u,!1)):n(null))}var f=u.userId;if(CLOUD.Utils.isMobileDevice()&&(a.pivot=u.point),r.scene.intersectToWorld(u,a.viewer),u.innnerDebugging=e.altKey,u.cx=s.x,u.cy=s.y,e.button===THREE.MOUSE.RIGHT)return void n(u,!1);if(t)CLOUD.GlobalData.EnableDemolishByDClick?(o.setSelection([f]),n(u,!0),a.updateView(!0)):(o.setSelection([f]),a.fitAndRotateBySelection(),n(u,!0));else{var p=o.getSelection();if(e.ctrlKey){var m=p.indexOf(f);-1==m?o.addSelection([f]):(p.splice(m,1),o.setSelection(p))}else-1==p.indexOf(f)?o.setSelection([f]):o.clearSelection();r.setSelectedIdsForOutline(o.getSelection()),n(u,!0),a.updateView(!0)}}},handleShiftMeasure:function(e,t,i){function n(i,n,a,o){var s=r.viewer.modelManager;if(null!=i){var l=r.scene.drawingToWorld(i);i.copy(l)}if(null!=n){var c=r.scene.drawingToWorld(n[0]),u=r.scene.drawingToWorld(n[1]);n[0].copy(c),n[1].copy(u)}s.dispatchEvent({type:CLOUD.EVENTS.ON_MEASURE_PICK,event:e,pick:t,pickPoint:i,pickLine:n,pickPlane:a,userId:o})}if(this._canPick()){var r=this.cameraControl,a=new THREE.Vector2(e.clientX,e.clientY),o=r.getIntersectContext(a);r.intersector.pick(o,function(e){if(e){var r=new THREE.Vector3;r.subVectors(e.point,i),r.normalize();var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=a.dot(r),c=o.dot(r),u=s.dot(r),h=new THREE.Vector3;h.copy(i),Math.abs(c)>=.707?h.y=e.point.y:Math.abs(u)>=Math.abs(l)?h.z=e.point.z:h.x=e.point.x,t&&i.copy(h),n(h,null,!1,e.userId)}else n(null,null,!1)})}},handleMouseMeasure:function(e,t,i,n){function r(i,n,r,o,l){var c=a.viewer.modelManager;if(null!=i){var u=a.scene.drawingToWorld(i);i.copy(u)}if(null!=n){var h=a.scene.drawingToWorld(n[0]),d=a.scene.drawingToWorld(n[1]);n[0].copy(h),n[1].copy(d)}c.dispatchEvent({type:s,event:e,pick:t,pickPoint:i,pickLine:n,pickPlane:r,normal:o,userId:l})}if(this._canPick()){var a=this.cameraControl,o=a.scene,s=n||CLOUD.EVENTS.ON_MEASURE_PICK,l={x:e.clientX,y:e.clientY},c=this.pickToPoint(l,5);null!=c?(t&&i.copy(c.pickPoint),r(c.pickPoint,c.pickLine,c.pickPlane,c.face.normal,c.userId)):(o.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&o.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE),r(null,null,!1))}},handleMouseHover:function(e){function t(t,n){var a=i.viewer.modelManager;if(null!=t){r.scene.intersectToWorld(t,i.viewer);var o="ExtrudeBodyManager"==t.object.parent.name}a.dispatchEvent({type:CLOUD.EVENTS.ON_HOVER_PICK,event:e,canvasPos:{x:f.x,y:f.y},intersectInfo:t?{selectedObjectId:t.userId,objectType:t.objectType,selectable:n,modelId:t.databagId,worldPosition:t.worldPosition,worldBoundingBox:t.worldBoundingBox,point:t.point,innnerDebugging:t.innnerDebugging,isRoom:o}:null})}if(this._canPick()){var i=this.cameraControl,n=i.viewer.modelManager.sceneState,r=this;if(function(){if(0==r.scene.hasObjectGroup(CLOUD.ObjectGroupType.AXISGRIDMANAGER))return!1;var e=r.scene.getAxisGridManager();return 0!=e.getElements().length&&!1!==e.getIsEnableHover()}()){var a=this.scene.getMatrixGlobal(),o=new THREE.Matrix4;o.getInverse(a);var s=this.scene.getAxisGridManager(),l=s.getAxisGridPlane();l.applyMatrix4(a);var c=new THREE.Vector2(e.clientX,e.clientY),u=i.getRaycaster(c.x,c.y),h=u.ray.intersectPlane(l);if(null==h)return;h.applyMatrix4(o);var d=s.snaping(h);i.viewer.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_AXIS_GRID_HOVER,snap:d})}if(CLOUD.GlobalData.Hover||r.scene.hasObjectGroup(CLOUD.ObjectGroupType.MARKER3D)){var f=i.screenToCanvas(e.clientX,e.clientY),p=new THREE.Vector2(e.clientX,e.clientY),m=i.getIntersectContext(p);i.intersector.pick(m,function(e){function a(e){switch(e.objectType){case CLOUD.PICKABLETYPE.Marker3d:e.object.setAttributeSize(e.index,e.currentSize);break;default:n.clearHover()}}if(e){var o=CLOUD.GlobalData.Hover||e.hoverEnabled;r.lastIntersected&&(r.lastIntersected.userId!=e.userId&&a(r.lastIntersected),r.lastIntersected.hoverEnabled&&t(null)),o&&(r.lastIntersected&&r.lastIntersected.userId==e.userId||(!function(e){switch(e.objectType){case CLOUD.PICKABLETYPE.Marker3d:var t=e.object;e.currentSize=t.getAttributeSize(e.index),t.setAttributeSize(e.index,Math.floor(1.5*e.currentSize));break;default:CLOUD.GlobalData.EnableRenderPass?n.setHoverId(e.object.originalId):n.setHoverId(e.userId)}}(e),r.lastIntersected=e),t(e,!0)),i.updateHighlight()}else r.lastIntersected&&(a(r.lastIntersected),r.lastIntersected=null,t(null),i.updateHighlight())})}}},_canPick:function(){return!!this.cameraControl.viewer.modelManager.hasModelDataReady()},setSelectedIdsForOutline:function(e){this.cameraControl.viewer.composer&&this.cameraControl.viewer.composer.setSelectedIds(e)},pickToPoint:function(e,t){void 0==t&&(t=5);var i=this.cameraControl,n=i.scene,r=new THREE.Vector2(e.x,e.y),a=i.getIntersectContext(r),o=i.intersector.pick(a);if(o){if(o.object.parent instanceof CLOUD.ExtrudeBodyManager)return null;var s,l=o.point,c=o.object.geometry,u=o.object.matrixWorld.clone(),h=i.camera.projScreenMatrix,d=a.mouse,f=a.viewportSize;void 0!==o.indexInfo&&(s=o.indexInfo);var p=c.attributes.position.array,m=c.attributes.normal.array,g=[],v=0,y=0;s?(g=c.index.array,v=s.indexStart,y=s.indexStart+s.indexCount):(CLOUD.GlobalData.BatchMergeEnabled&&o.matrix&&u.multiply(o.matrix),g=CLOUD.RemoveDuplicateVertex(c.attributes.position.array,c.index.array),y=g.length);for(var E=1/0,e=new THREE.Vector3,x=[],b=[],C=CLOUD.Utils.getMin(g.slice(v,y)),M=v;M<y;++M){var _=new THREE.Vector3(p[3*g[M]],p[3*g[M]+1],p[3*g[M]+2]);_.applyMatrix4(u);var r=_.clone();r.applyMatrix4(h);var w=.5*(r.x-d.x)*f.width,L=.5*(r.y-d.y)*f.height,T=Math.sqrt(w*w+L*L);T<E&&(E=T,e.copy(_)),s&&b.push(g[M]-C)}var I=l.clone(),S=null,O=!1;if(E<t)n.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPICKPLANE)&&n.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPICKPLANE),I=e.clone();else{var E=1/0,D=new THREE.Vector3,R=new THREE.Vector3,e=new THREE.Vector3,A=[];s?(x=p.slice(s.positionStart,s.positionStart+s.positionCount),A=CLOUD.BuildEdge(x,b)):(x=p,A=CLOUD.BuildEdge(c.attributes.position.array,c.index.array));for(var M=0;M<A.length;M+=2){var U=new THREE.Vector3(x[3*A[M]],x[3*A[M]+1],x[3*A[M]+2]);U.applyMatrix4(u);var B=new THREE.Vector3(x[3*A[M+1]],x[3*A[M+1]+1],x[3*A[M+1]+2]);B.applyMatrix4(u);var P=function(e,t,i){var n=new THREE.Vector3;n.subVectors(t,e);var r=new THREE.Vector3;r.subVectors(i,e);var a=n.dot(r);if(a<0)return e;var o=n.dot(n);if(a>o)return t;a/=o;var s=e.clone();return s.addScaledVector(n,a),s}(U,B,l),r=P.clone();r.applyMatrix4(h);var w=.5*(r.x-d.x)*f.width,L=.5*(r.y-d.y)*f.height,T=Math.sqrt(w*w+L*L);T<E&&(E=T,D.copy(U),R.copy(B),e.copy(P))}if(x=null,b=null,E<t)n.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&n.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE),S=new Array,S.push(D),S.push(R),I=e.clone();else{if(CLOUD.GlobalData.MeasureHighlightPlane){g=c.index.array;var N=new THREE.Matrix4;N.getInverse(u);var k=new THREE.Vector3(l.x,l.y,l.z);k.applyMatrix4(N);var F=CLOUD.GetFaceIndex(p,m,g,k,o.face.normal),H=new THREE.BufferGeometry;H.setIndex(F),H.addAttribute("position",c.attributes.position,3),H.addAttribute("normal",c.attributes.normal,3);var G=CLOUD.BuildEdge(p,F),V=new THREE.BufferGeometry;V.setIndex(G),V.addAttribute("position",c.attributes.position,3),n.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE)&&n.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPLANE);var z=n.getOrCreateObjectGroup(CLOUD.ObjectGroupType.MEASUREPLANE,{priority:1,globalSpace:!0}),W=new THREE.Mesh(H,new THREE.MeshBasicMaterial({color:1170103,opacity:.1,transparent:!0}));W.applyMatrix(o.object.matrix),z.add(W);var q=new THREE.LineSegments(V,new THREE.LineBasicMaterial({color:1170103}));q.applyMatrix(o.object.matrix),z.add(q),z.updateMatrixWorld(!0),i.updateHighlight()}O=!0}}var j={};return j.pickPoint=I,j.pickLine=S,j.pickPlane=O,j.face=o.face,j.userId=o.userId,j}return null}},CLOUD.NormalEditor=function(e,t){CLOUD.BaseEditor.call(this,e,t),this.oldMouseX=-1,this.oldMouseY=-1,this.rotatePivot=null,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._lastTrackingPoint=null,this.rotateSpeed=1,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this.modelManager=t.viewer.modelManager,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.pickHelper=new CLOUD.PickHelper(t),this.intersectOfMouseDown=null,this.timeId=null,this.longTapFlag=!1,CLOUD.Utils.isMobileDevice()?this.selectPad=new CLOUD.SelectPad(this):this.selectPad=null,this.startPt=new THREE.Vector2;var i=this;this.longTap=function(){i.longTapFlag=!0,CLOUD.Logger.log("long tap"),i.selectPad&&i.selectPad.showOverlay(i.startPt)},this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this._moving=!1},CLOUD.NormalEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.NormalEditor.prototype.constructor=CLOUD.NormalEditor,CLOUD.NormalEditor.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.pickHelper.destroy(),this.pickHelper=null,this.intersectOfMouseDown=null,this.selectPad&&(this.selectPad=null),this.timeId=null},CLOUD.NormalEditor.prototype.beginPan=function(e,t){this._panStart.set(e,t),this._worldDimension=this.getWorldDimension(e,t)},CLOUD.NormalEditor.prototype.processMouseDown=function(e){this.oldMouseX=e.clientX,this.oldMouseY=e.clientY;var t=this.cameraControl;this.intersectOfMouseDown=null,e.preventDefault();var i="";if(e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotatePivot=t.calculatePivot(CLOUD.EditorConfig.RotatePivotMode,{x:e.clientX,y:e.clientY}),this.state=this.StateType.ROTATE,this._rotateStart.set(e.clientX,e.clientY),this._lastTrackingPoint=null,i=CLOUD.EditorMode.ORBIT}else if(e.button===this.mouseButtons.ZOOM){if(CLOUD.EditorConfig.NoZoom)return;this.state=this.StateType.DOLLY,this._dollyStart.set(e.clientX,e.clientY),i=CLOUD.EditorMode.ZOOM}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(CLOUD.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),this._worldDimension=t.getWorldDimension(e.clientX,e.clientY),this.state=this.StateType.PAN,this.intersectOfMouseDown=t.getLastIntersect(),i=CLOUD.EditorMode.PAN}this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:i,editor:this.name})},CLOUD.NormalEditor.prototype.processMouseMove=function(e){var t=this.cameraControl;switch(e.preventDefault(),this.state){case this.StateType.ROTATE:if(this._rotateEnd.set(e.clientX,e.clientY),this._rotateDelta.subVectors(this._rotateEnd,this._rotateStart),0==this._rotateDelta.x&&0==this._rotateDelta.y)return;this._rotateStart.copy(this._rotateEnd),t.processRotate(this._rotateDelta,this.rotatePivot);break;case this.StateType.DOLLY:if(this._dollyEnd.set(e.clientX,e.clientY),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),0===this._dollyDelta.x&&0===this._dollyDelta.y)return;var i;i=this._dollyDelta.y>0?this.zoomSpeed:1/this.zoomSpeed,this.cameraControl.adjustCameraForDolly(i,null),this._dollyStart.copy(this._dollyEnd);break;case this.StateType.PAN:if(this._panEnd.set(e.clientX,e.clientY),this._panDelta.subVectors(this._panEnd,this._panStart),0==this._panDelta.x&&0==this._panDelta.y)return;this.cameraControl.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),this.cameraControl.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd);break;case this.StateType.NONE:}this.state!==this.StateType.NONE&&this.cameraControl.update(!0)},CLOUD.NormalEditor.prototype.processMouseUp=function(e){if(this.state===this.StateType.NONE)return!1;this.intersectOfMouseDown=null;var t=this.cameraControl;this.oldMouseX===e.clientX&&this.oldMouseY===e.clientY||t.update(!0),this.state=this.StateType.NONE,this.rotatePivot=null,t.endOperation();var i="";return e.button===this.mouseButtons.ORBIT?i=CLOUD.EditorMode.ORBIT:e.button===this.mouseButtons.ZOOM?i=CLOUD.EditorMode.ZOOM:e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||(i=CLOUD.EditorMode.PAN),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:i,editor:this.name}),!0},CLOUD.NormalEditor.prototype.processMouseWheel=function(e){var t=this.cameraControl;if(!CLOUD.EditorConfig.NoZoom){e.preventDefault(),e.stopPropagation();var i=0;e.wheelDelta?i=e.wheelDelta:e.detail&&(i=40*-e.detail),Math.abs(i)>720&&(i=i>0?720:-720),i*=this.wheelZoomFactor,CLOUD.EditorConfig.ReverseWheelDirection&&(i*=-1),t.zoom(i,e.clientX,e.clientY),t.delayHandle(),this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_ZOOM})}},CLOUD.NormalEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan){var t,i=this.cameraControl;CLOUD.GlobalData.BatchMergeEnabled?(this.animationStarted||(this.animationStarted=!0,this._start()),t=!1):(t=!0,i.delayHandle()),this._moving=!0;var n=!1,r=this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate,a=this.keyPanSpeed*CLOUD.EditorConfig.MovementSpeedRate;switch(e.keyCode){case CLOUD.Keys.ZERO:this.keyPanSpeed=i.defaultKeyPanSpeed,this.movementSpeed=i.defaultMovementSpeed;break;case CLOUD.Keys.PLUS:this.keyPanSpeed*=1.1,this.movementSpeed*=1.1;break;case CLOUD.Keys.SUB:this.keyPanSpeed*=.9,this.keyPanSpeed<this.minKeyPanSpeed&&(this.keyPanSpeed=this.minKeyPanSpeed),this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case CLOUD.Keys.Q:i.pan(0,a),n=!0;break;case CLOUD.Keys.E:i.pan(0,-a),n=!0;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:i.pan(a,0),n=!0;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:i.pan(-a,0),n=!0;break;case CLOUD.Keys.UP:case CLOUD.Keys.W:i.moveStraight(r,!e.shiftKey),n=!0;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:i.moveStraight(-r,!e.shiftKey),n=!0}n&&t&&i.update(!0)}},CLOUD.NormalEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan)switch(e.keyCode){case CLOUD.Keys.ESC:this.cameraControl.viewer.modelManager.sceneState.clearSelection(),this.pickHelper.lastPickedUserId=void 0,this.cameraControl.updateView(!0)}},CLOUD.NormalEditor.prototype.processTouchstart=function(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);var t=this;switch(t.timeId=setTimeout(t.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return
;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE;break;case 2:if(!CLOUD.EditorConfig.NoZoom){var i=e.touches[0].clientX-e.touches[1].clientX,n=e.touches[0].clientY-e.touches[1].clientY;this._dollyStart.set(0,Math.sqrt(i*i+n*n))}if(!CLOUD.EditorConfig.NoPan){var r=.5*(e.touches[0].clientX+e.touches[1].clientX),a=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(r,a)}break;default:this.state=this.StateType.NONE}},CLOUD.NormalEditor.prototype.processTouchmove=function(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateStart,this._rotateEnd);var i=this.cameraControl.getClientSize(),n=2*Math.PI*this._rotateDelta.x/i.x*this.rotateSpeed,r=2*Math.PI*this._rotateDelta.y/i.y*this.rotateSpeed;t.touchUpdateRotation(n,r),this._rotateStart.copy(this._rotateEnd);break;case 2:if(t.clearTouchRotateState(),!CLOUD.EditorConfig.NoZoom){var a=e.touches[0].clientX-e.touches[1].clientX,o=e.touches[0].clientY-e.touches[1].clientY,s=Math.sqrt(a*a+o*o);if(this._dollyEnd.set(0,s),this._dollyDelta.subVectors(this._dollyEnd,this._dollyStart),Math.abs(this._dollyDelta.y)>3){var l;this._dollyDelta.y>0?l=1/Math.pow(this.zoomSpeed,.5*this._dollyDelta.y):this._dollyDelta.y<0&&(l=Math.pow(this.zoomSpeed,.5*-this._dollyDelta.y)),console.log(this._dollyDelta.y),this._dollyStart.copy(this._dollyEnd);var c=.5*(e.touches[0].clientX+e.touches[1].clientX),u=.5*(e.touches[0].clientY+e.touches[1].clientY);t.touchDolly(c,u,l),this.state=this.StateType.DOLLY}}if(!CLOUD.EditorConfig.NoPan){var h=.5*(e.touches[0].clientX+e.touches[1].clientX),d=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(h,d),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;this._worldDimension=t.getWorldDimension(h,d),t.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),t.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()},CLOUD.NormalEditor.prototype.processTouchend=function(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}},CLOUD.NormalEditor.prototype.processHover=function(e){this.pickHelper.handleMouseHover(e)},CLOUD.NormalEditor.prototype.moveTo=function(e){if(void 0!==e){var t=this.cameraControl;if(!CLOUD.EditorConfig.NoKey&&!CLOUD.EditorConfig.NoPan){var i=this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate,n=this.keyPanSpeed*CLOUD.EditorConfig.MovementSpeedRate,r=CLOUD.MoveDirection;switch(e){case r.FORWARD:t.moveForward(i,!0);break;case r.BACK:t.moveBackward(i,!0);break;case r.LEFT:t.pan(n,0);break;case r.RIGHT:t.pan(-n,0);break;case r.UP:t.pan(0,n);break;case r.DOWN:t.pan(0,-n);break;default:e=r.NONE}e!==r.NONE&&t.update(!0,!0)}}},CLOUD.NormalEditor.prototype._updateMove=function(){this._moving&&(this._moving=!1,this.cameraControl.update(!0))},CLOUD.NormalEditor.prototype._animate=function(){this._reqid=requestAnimationFrame(this._animateBinded),this._updateMove()},CLOUD.NormalEditor.prototype._start=function(){this._animate()},CLOUD.NormalEditor.prototype._stop=function(){cancelAnimationFrame(this._reqid)},CLOUD.NormalEditor.prototype.onExit=function(){CLOUD.GlobalData.BatchMergeEnabled&&this.animationStarted&&(this._stop(),this.animationStarted=!1)},CLOUD.OrbitEditor=function(e,t){CLOUD.NormalEditor.call(this,t||CLOUD.EditorMode.ORBIT,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}},CLOUD.OrbitEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.OrbitEditor.prototype.constructor=CLOUD.OrbitEditor,CLOUD.PickEditor=function(e){CLOUD.OrbitEditor.call(this,e,CLOUD.EditorMode.PICK)},CLOUD.PickEditor.prototype=Object.create(CLOUD.OrbitEditor.prototype),CLOUD.PickEditor.prototype.constructor=CLOUD.PickEditor,CLOUD.PickEditor.prototype.processMouseUp=function(e){e.preventDefault();var t=Math.abs(this.oldMouseX-e.clientX)<=1&&Math.abs(this.oldMouseY-e.clientY)<=1;if((e.button===THREE.MOUSE.LEFT||e.button===THREE.MOUSE.RIGHT)&&t)return this.pickHelper.click(e,this.intersectOfMouseDown),this.cameraControl.update(!0),void(this.intersectOfMouseDown=null);t||e.button!==this.mouseButtons.ORBIT&&e.button!==this.mouseButtons.PAN||this.cameraControl.update(!0),this.intersectOfMouseDown=null,this.state=this.StateType.NONE;var i="";e.button===this.mouseButtons.ORBIT?i=CLOUD.EditorMode.ORBIT:e.button===this.mouseButtons.ZOOM?i=CLOUD.EditorMode.ZOOM:e.button!==this.mouseButtons.PAN&&e.button!==this.mouseButtons.PAN2||(i=CLOUD.EditorMode.PAN,t||this.dispatchEvent({type:CLOUD.EVENTS.ON_MOUSE_DRAGGED,event:e})),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:i,editor:this.name})},CLOUD.PickEditor.prototype.processMouseDoubleClick=function(e){e.button===THREE.MOUSE.LEFT&&this.pickHelper.doubleClick(e)},CLOUD.EditTool=function(e){this.name=e,this._mousePressed=!1},CLOUD.EditTool.prototype.getName=function(){return this.name},CLOUD.EditTool.prototype.onExit=function(){},CLOUD.EditTool.prototype.processMouseDown=function(e){return!1},CLOUD.EditTool.prototype.processMouseMove=function(e){return!1},CLOUD.EditTool.prototype.processMouseUp=function(e){return!1},CLOUD.EditTool.prototype.processMouseWheel=function(e){return!1},CLOUD.EditTool.prototype.processMouseDoubleClick=function(e){return!1},CLOUD.EditTool.prototype.processKeyDown=function(e){return!1},CLOUD.EditTool.prototype.processKeyUp=function(e){switch(e.keyCode){case CLOUD.Keys.ESC:this._mousePressed=!1}return!1},CLOUD.EditTool.prototype.processTouchstart=function(e){return!1},CLOUD.EditTool.prototype.processTouchmove=function(e){return!1},CLOUD.EditTool.prototype.processTouchend=function(e){return!1},CLOUD.EditTool.prototype.processHover=function(e){return!1},CLOUD.EditTool.prototype.onEvent=function(e){var t=!1;switch(e.type){case"touchmove":t=this.processTouchmove(e);break;case"touchstart":t=this.processTouchstart(e);break;case"touchend":t=this.processTouchend(e);case"keydown":t=this.processKeyDown(e);break;case"keyup":t=this.processKeyUp(e);break;case"mousewheel":case"DOMMouseScroll":t=this.processMouseWheel(e);break;case"mousedown":this._mousePressed=!0,t=this.processMouseDown(e);break;case"mousemove":t=this._mousePressed?this.processMouseMove(e):this.processHover(e);break;case"mouseup":this._mousePressed=!1,t=this.processMouseUp(e);break;case"dblclick":t=this.processMouseDoubleClick(e)}return t},CLOUD.RectOpTool=function(e,t,i){CLOUD.EditTool.call(this,e),this.cameraControl=t,this.frustum=new THREE.Frustum,this.startPt=new THREE.Vector2,this.endPt=new THREE.Vector2,this.eventDispatcher=i},CLOUD.RectOpTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.RectOpTool.prototype.constructor=CLOUD.RectOpTool,CLOUD.RectOpTool.prototype.onUpdateUI=function(e){this.eventDispatcher.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_UPDATEUI,data:e,editor:this.name})},CLOUD.RectOpTool.prototype.updateFrustum=function(e,t){var i=this.startPt.x,n=this.endPt.x,r=this.startPt.y,a=this.endPt.y;if(i>n){var o=i;i=n,n=o}if(r>a){var s=r;r=a,a=s}if(n-i==0||a-r==0)return!1;var l=this.cameraControl,c=l.getContainerDimensions();return e&&l.computeFrustum(i,n,r,a,this.frustum,c),t&&this.onUpdateUI({visible:!0,dir:this.startPt.x<this.endPt.x,left:i-c.left,top:r-c.top,width:n-i,height:a-r}),!0},CLOUD.RectPickTool=function(e){CLOUD.RectOpTool.call(this,CLOUD.EditToolMode.PICK_BY_RECT,e.cameraControl,e.modelManager),this.viewer=e,this.scene=e.getScene(),this.pickHelper=new CLOUD.PickHelper(this.cameraControl),this.activatePick=!1,this.pickPoint=new THREE.Vector3,this.snapIsEnabled=!1},CLOUD.RectPickTool.prototype=Object.create(CLOUD.RectOpTool.prototype),CLOUD.RectPickTool.prototype.constructor=CLOUD.RectPickTool,CLOUD.RectPickTool.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.pickHelper.destroy(),this.pickHelper=null},CLOUD.RectPickTool.prototype.processMouseDown=function(e){return e.preventDefault(),this.activatePick=e.ctrlKey||e.altKey,this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),!0):CLOUD.RectOpTool.prototype.processMouseDown(this,e)},CLOUD.RectPickTool.prototype.processMouseMove=function(e){return this.activatePick&&e.button===THREE.MOUSE.LEFT?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):CLOUD.RectOpTool.prototype.processMouseMove(this,e)},CLOUD.RectPickTool.prototype.processMouseUp=function(e){if(this.onUpdateUI({visible:!1}),this.activatePick&&e.button===THREE.MOUSE.LEFT){if(this.activatePick=!1,Math.abs(this.startPt.x-e.clientX)<2&&Math.abs(this.startPt.y-e.clientY)<2)return this.pickHelper.click(e,null),!0;if(this.endPt.set(e.clientX,e.clientY),!this.updateFrustum(!0,!1))return this.pickHelper.click(e),!0;var t=CLOUD.OPSELECTIONTYPE.Clear;return e.ctrlKey?t=CLOUD.OPSELECTIONTYPE.Add:e.altKey&&(t=CLOUD.OPSELECTIONTYPE.Remove),CLOUD.PickUtil.pickByRect(this.scene,this.frustum,t,this.cameraControl.viewer.modelManager,this.viewer),this.pickHelper.lastPickedUserId="",this.cameraControl.updateView(!0),!0}return CLOUD.RectOpTool.prototype.processMouseUp(this,e)},CLOUD.RectPickTool.prototype.processHover=function(e){if(this.snapIsEnabled)return!!CLOUD.GlobalData.IsMobile||(this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint,CLOUD.EVENTS.ON_HOVER_SNAP),!0)},CLOUD.RectPickTool.prototype.enableSnap=function(e){this.snapIsEnabled=e},CLOUD.ZoomEditor=function(e){CLOUD.NormalEditor.call(this,CLOUD.EditorMode.ZOOM,e),this.mouseButtons={ZOOM:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT}},CLOUD.ZoomEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.ZoomEditor.prototype.constructor=CLOUD.ZoomEditor,CLOUD.RectZoomTool=function(e){CLOUD.RectOpTool.call(this,CLOUD.EditToolMode.ZOOM_BY_RECT,e.cameraControl,e.modelManager),this.scene=e.getScene(),this.activateZoom=!1},CLOUD.RectZoomTool.prototype=Object.create(CLOUD.RectOpTool.prototype),CLOUD.RectZoomTool.prototype.constructor=CLOUD.RectZoomTool,CLOUD.RectZoomTool.prototype.processMouseDown=function(e){return e.button===THREE.MOUSE.LEFT?(this.startPt.set(e.clientX,e.clientY),this.activateZoom=!0,!0):CLOUD.RectOpTool.prototype.processMouseDown.call(this,e)},CLOUD.RectZoomTool.prototype.processMouseMove=function(e){return this.activateZoom?(this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!1,!0),!0):CLOUD.RectOpTool.prototype.processMouseMove.call(this,e)},CLOUD.RectZoomTool.prototype.processMouseUp=function(e){return this.activateZoom?(this.activateZoom=!1,this.onUpdateUI({visible:!1}),this.endPt.set(e.clientX,e.clientY),this.updateFrustum(!0,!1)&&this.zoomToRectangle(),!0):CLOUD.RectOpTool.prototype.processMouseUp.call(this,e)},CLOUD.RectZoomTool.prototype.zoomToRectangle=function(){var e=this.cameraControl.camera,t=this.cameraControl.camera.target,i=(e.near,this.cameraControl.getContainerDimensions()),n=this.startPt.x,r=this.startPt.y,a=this.endPt.x,o=this.endPt.y,s=Math.abs(a-n),l=Math.abs(r-o);if(0!==s&&0!==l){var c,u=new THREE.Vector2((n+a)/2,(r+o)/2),h=e.position.clone(),d=t.clone().sub(h),f=d.length(),p=this.cameraControl.getIntersectContext(u),m=this.cameraControl.intersector.hitTest(p);if(m){var g=s/l>i.width/i.height?s/i.width:l/i.height,v=m.distanceTo(h),y=v*g;d.normalize(),c=d.clone().negate().multiplyScalar(y)}else{var E={};E.left=Math.min(n,a),E.top=Math.min(r,o),E.right=Math.max(n,a),E.bottom=Math.max(r,o);var x=this.scene.getNearDepthByRect(this.frustum,e);if(x===1/0)return;var b=new THREE.Vector3((n+a)/2,(r+o)/2,x),C=new THREE.Vector3(E.left,E.top,x),M=this.clientToWorld(b),_=this.clientToWorld(C),y=M.clone().sub(_).length();m=M.clone(),d.normalize(),c=d.clone().negate().multiplyScalar(y)}h=m.clone().add(c),e.position.copy(h),t.copy(h).sub(c.clone().normalize().multiplyScalar(f)),this.cameraControl.updateView(!0)}},CLOUD.RectZoomTool.prototype.worldToClient=function(e){var t=this.cameraControl.camera,i=new THREE.Vector3(e.x,e.y,e.z);return i.project(t),i},CLOUD.RectZoomTool.prototype.clientToWorld=function(e){var t=this.cameraControl.getContainerDimensions(),i=this.cameraControl.camera,n=new THREE.Vector3;return n.x=e.x/t.width*2-1,n.y=-e.y/t.height*2+1,n.z=e.z,n.unproject(i),n},CLOUD.PanEditor=function(e){CLOUD.NormalEditor.call(this,CLOUD.EditorMode.PAN,e),this.mouseButtons={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}},CLOUD.PanEditor.prototype=Object.create(CLOUD.NormalEditor.prototype),CLOUD.PanEditor.prototype.constructor=CLOUD.PanEditor,CLOUD.FlyEditor=function(e){CLOUD.BaseEditor.call(this,CLOUD.EditorMode.FLY,e),this.lookSpeed=.001,this.constrainPitch=!0,this.pitchMin=THREE.Math.degToRad(5)-.5*Math.PI,this.pitchMax=.5*Math.PI-this.pitchMin,this.pitchDeltaTotal=0,this.moveState=CLOUD.MoveDirection.NONE,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,this._worldDimension=new THREE.Vector2,this.lastMousePoint=new THREE.Vector2,this.isLockHeight=!1,this.lockedHeight=0,this.pickHelper=new CLOUD.PickHelper(e),this.intersectOfMouseDown=null},CLOUD.FlyEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.FlyEditor.prototype.constructor=CLOUD.FlyEditor,CLOUD.FlyEditor.prototype.destroy=function(){this.cameraControl=null,this.scene=null},CLOUD.FlyEditor.prototype.processMouseDown=function(e){e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY);var t=this.cameraControl;if(this.intersectOfMouseDown=null,e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}else if(e.button===this.mouseButtons.PAN||e.button===this.mouseButtons.PAN2){if(CLOUD.EditorConfig.NoPan)return;this._panStart.set(e.clientX,e.clientY),this._worldDimension=t.getWorldDimension(e.clientX,e.clientY),this.intersectOfMouseDown=t.getLastIntersect(),this.state=this.StateType.PAN,this.isLockHeight&&(this.lockedHeight=e.clientY)}},CLOUD.FlyEditor.prototype.doPan=function(e,t){var i=this.cameraControl;this._panEnd.set(e,this.isLockHeight?this.lockedHeight:t),this._panDelta.subVectors(this._panEnd,this._panStart),0===this._panDelta.x&&0===this._panDelta.y||(i.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),i.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),i.update(!0))},CLOUD.FlyEditor.prototype.processMouseMove=function(e){var t=this.cameraControl;if(e.preventDefault(),this.state===this.StateType.ROTATE){if(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),0!=this.rotateDelta.x||0!=this.rotateDelta.y){var i=this.rotateDelta.x*this.lookSpeed,n=this.rotateDelta.y*this.lookSpeed;t.rotateForFly(i,n,this.pitchMin,this.pitchMax)}}else this.state===this.StateType.PAN&&this.doPan(e.clientX,e.clientY)},CLOUD.FlyEditor.prototype.processMouseUp=function(e){if(e.preventDefault(),e.stopPropagation(),e.button===THREE.MOUSE.LEFT&&this.lastMousePoint.x===e.clientX&&this.lastMousePoint.y===e.clientY)return void this.pickHelper.click(e,this.intersectOfMouseDown);this.intersectOfMouseDown=null;var t=this.cameraControl;switch(this.state){case this.StateType.ROTATE:this.rotateDelta.set(0,0);t.rotateForFly(0,0,this.pitchMin,this.pitchMax),this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:"look",editor:this.name});break;case this.StateType.PAN:this.doPan(e.clientX,e.clientY)}t.endOperation(),this.state=this.StateType.NONE},CLOUD.FlyEditor.prototype.processHover=function(e){this.pickHelper.handleMouseHover(e)},CLOUD.FlyEditor.prototype.processMouseWheel=function(e){e.preventDefault(),e.stopPropagation();var t=this.cameraControl;if(!CLOUD.EditorConfig.NoZoom){var i=e.wheelDelta||e.detail;i=Math.abs(i)>10?i:40*-i,i*=5e-4,CLOUD.EditorConfig.ReverseWheelDirection&&(i*=-1),this.cameraControl.delayHandle();var n=t.getContainerDimensions(),r=n.left+.5*n.width,a=n.top+.5*n.height;t.zoom(i,r,a)}},CLOUD.FlyEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!e.altKey){var t=CLOUD.MoveDirection,i=t.NONE;switch(e.keyCode){case CLOUD.Keys.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case CLOUD.Keys.PLUS:this.movementSpeed*=1.1;break;case CLOUD.Keys.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case CLOUD.Keys.UP:case CLOUD.Keys.W:i=t.FORWARD;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:i=t.BACK;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:i=t.LEFT;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:i=t.RIGHT;break;case CLOUD.Keys.Q:i=t.UP;break;case CLOUD.Keys.E:i=t.DOWN}i!==t.NONE&&(this.moveState|=i,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYDOWN,event:e,state:i,direction:t,editor:this.name}),this.cameraControl.delayHandle(),this.cameraControl.updateFlyMove(this.moveState,this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate))}},CLOUD.FlyEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey){var t=CLOUD.MoveDirection,i=t.NONE;switch(e.keyCode){case CLOUD.Keys.UP:case CLOUD.Keys.W:i=t.FORWARD;break;case CLOUD.Keys.DOWN:case CLOUD.Keys.S:i=t.BACK;break;case CLOUD.Keys.LEFT:case CLOUD.Keys.A:i=t.LEFT;break;case CLOUD.Keys.RIGHT:case CLOUD.Keys.D:i=t.RIGHT;break;case CLOUD.Keys.Q:i=t.UP;break;case CLOUD.Keys.E:i=t.DOWN}i!==t.NONE&&(this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYUP,event:e,state:i,direction:t,editor:this.name}),this.moveState&=~i)}},CLOUD.FlyEditor.prototype.moveTo=function(e){this.cameraControl.updateFlyMove(e,this.movementSpeed*CLOUD.EditorConfig.MovementSpeedRate)},CLOUD.WalkEditor=function(e){CLOUD.BaseEditor.call(this,CLOUD.EditorMode.WALK,e),this.mouseButtons={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT},this.pickHelper=new CLOUD.PickHelper(e),this.lastMousePoint=new THREE.Vector2,this._reqid=0,this._animateBinded=this._animate.bind(this),this._clock=new THREE.Clock,this.moveState={up:0,down:0,left:0,right:0,forward:0,back:0,pitchUp:0,pitchDown:0,yawLeft:0,yawRight:0,rollLeft:0,rollRight:0},this.startPt=new THREE.Vector2,this.timeId=null,this.rotateSpeed=1,this._rotateStart=new THREE.Vector2,this._rotateEnd=new THREE.Vector2,this._rotateDelta=new THREE.Vector2,this._dollyStart=new THREE.Vector2,this._dollyEnd=new THREE.Vector2,this._dollyDelta=new THREE.Vector2,this._dollyCenter=new THREE.Vector2,this.zoomSpeed=Math.pow(.95,.2),this._panStart=new THREE.Vector2,this._panEnd=new THREE.Vector2,this._panDelta=new THREE.Vector2,this._pan=new THREE.Vector3,CLOUD.Utils.isMobileDevice()?this.selectPad=new CLOUD.SelectPad(this):this.selectPad=null,this.moveVector=new THREE.Vector3(0,0,0),this.rotationVector=new THREE.Vector3(0,0,0),this.zoomDelta=0,this.rotateStart=new THREE.Vector2,this.rotateEnd=new THREE.Vector2,this.rotateDelta=new THREE.Vector2,this.firstRotate=!0,this.dragLook=!0,this.lockHeightEnabled=!1,this.isLockHeight=!1,this.lockedHeight=0,this.pickEnabled=!0,this.defaultMovementSpeed=750,this.movementSpeed=this.defaultMovementSpeed},CLOUD.WalkEditor.prototype=Object.create(CLOUD.BaseEditor.prototype),CLOUD.WalkEditor.prototype.constructor=CLOUD.WalkEditor,CLOUD.WalkEditor.prototype._animate=function(){this._reqid=requestAnimationFrame(this._animateBinded),this.updateWalkMove()},CLOUD.WalkEditor.prototype._start=function(){this._animate()},CLOUD.WalkEditor.prototype._stop=function(){cancelAnimationFrame(this._reqid)},CLOUD.WalkEditor.prototype._updateMovement=function(){this.moveVector.x=-this.moveState.left+this.moveState.right,this.isLockHeight?this.moveVector.y=0:this.moveVector.y=-this.moveState.down+this.moveState.up,this.moveVector.z=-this.moveState.forward+this.moveState.back},CLOUD.WalkEditor.prototype._updateRotation=function(){CLOUD.EditorConfig.LockAxisZ?this.rotationVector.x=0:this.rotationVector.x=-this.moveState.pitchDown+this.moveState.pitchUp,this.rotationVector.y=-this.moveState.yawRight+this.moveState.yawLeft,this.rotationVector.z=-this.moveState.rollRight+this.moveState.rollLeft},CLOUD.WalkEditor.prototype._doRotate=function(e){var t=this.cameraControl.getContainerDimensions(),i=t.width/2,n=t.height/2;this.moveState.yawLeft=-e.x/i,this.moveState.pitchDown=e.y/n,this._updateRotation()},CLOUD.WalkEditor.prototype.destroy=function(){CLOUD.BaseEditor.prototype.destroy.call(this),this.rotateStart=null,this.rotateEnd=null,this.rotateDelta=null,this.pickHelper.destroy(),this.pickHelper=null,this.lastMousePoint=null,this._clock=null},CLOUD.WalkEditor.prototype.processMouseDown=function(e){if(e.preventDefault(),e.stopPropagation(),this.lastMousePoint.set(e.clientX,e.clientY),this.firstRotate=!1,e.button===this.mouseButtons.ORBIT){if(CLOUD.EditorConfig.NoRotate)return;this.rotateStart.set(e.clientX,e.clientY),this.state=this.StateType.ROTATE,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_BEGIN,name:"look",editor:this.name})}},CLOUD.WalkEditor.prototype.processMouseUp=function(e){return e.preventDefault(),e.stopPropagation(),this.pickEnabled&&e.button===THREE.MOUSE.LEFT&&Math.abs(this.lastMousePoint.x-e.clientX)<2&&Math.abs(this.lastMousePoint.y-e.clientY)<2?(this.state=this.StateType.NONE,void this.pickHelper.click(e)):(this.state===this.StateType.ROTATE&&(this.moveState.yawLeft=this.moveState.pitchDown=0,this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_END,name:"look",editor:this.name})),this.state=this.StateType.NONE,!0)},CLOUD.WalkEditor.prototype.processMouseMove=function(e){e.preventDefault(),this.dragLook&&this.state===this.StateType.ROTATE&&(this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))},CLOUD.WalkEditor.prototype.processTouchstart=function(e){this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.timeId&&clearTimeout(this.timeId);var t=this;switch(t.timeId=setTimeout(t.longTap,400),this.selectPad&&this.selectPad.hideOverlay(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE,console.log(this._rotateStart);break;case 2:if(!CLOUD.EditorConfig.NoPan){var i=.5*(e.touches[0].clientX+e.touches[1].clientX),n=.5*(e.touches[0].clientY+e.touches[1].clientY);this._panStart.set(i,n)}break;default:this.state=this.StateType.NONE}},CLOUD.WalkEditor.prototype.processTouchmove=function(e){this.timeId&&clearTimeout(this.timeId);var t=this.cameraControl;switch(e.preventDefault(),e.touches.length){case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateEnd.set(e.touches[0].clientX,e.touches[0].clientY),this._rotateDelta.subVectors(this._rotateStart,this._rotateEnd);var i=this.cameraControl.getClientSize(),n=2*Math.PI*this._rotateDelta.x/i.x*this.rotateSpeed,r=2*Math.PI*this._rotateDelta.y/i.y*this.rotateSpeed;t.touchUpdateRotation(n,r),this._rotateStart.copy(this._rotateEnd);break;case 2:if(t.clearTouchRotateState(),!CLOUD.EditorConfig.NoPan){var a=.5*(e.touches[0].clientX+e.touches[1].clientX),o=.5*(e.touches[0].clientY+e.touches[1].clientY);if(this._panEnd.set(a,o),this._panDelta.subVectors(this._panEnd,this._panStart),Math.abs(this._panDelta.x)<3&&Math.abs(this._panDelta.y)<3)return;this._worldDimension=t.getWorldDimension(a,o),t.panOnWorld(this._panStart,this._panEnd,this._pan,this._worldDimension),t.adjustCameraForPan(this._pan),this._panStart.copy(this._panEnd),this.state=this.StateType.PAN}}t.touchUpdate()},CLOUD.WalkEditor.prototype.processTouchend=function(e){this.timeId&&clearTimeout(this.timeId),this.longTapFlag&&(this.longTapFlag=!1,e.preventDefault());var t=this.cameraControl;switch(e.touches.length){case 0:this.state=this.StateType.NONE,t.touchEndHandler(e);break;case 1:if(CLOUD.EditorConfig.NoRotate)return;this._rotateStart.set(e.touches[0].clientX,e.touches[0].clientY),this.state=this.StateType.ROTATE}},CLOUD.WalkEditor.prototype.processHover=function(e){e.preventDefault(),this.dragLook||(this.firstRotate&&(this.firstRotate=!1,this.rotateStart.set(e.clientX,e.clientY)),this.rotateEnd.set(e.clientX,e.clientY),this.rotateDelta.subVectors(this.rotateEnd,this.rotateStart),this.rotateStart.copy(this.rotateEnd),this._doRotate(this.rotateDelta))},CLOUD.WalkEditor.prototype.processKeyDown=function(e){if(!CLOUD.EditorConfig.NoKey&&!e.altKey){var t=CLOUD.MoveDirection.NONE,i=CLOUD.Keys;switch(e.keyCode){case i.ZERO:this.movementSpeed=this.defaultMovementSpeed;break;case i.PLUS:this.movementSpeed*=1.1;break;case i.SUB:this.movementSpeed*=.9,this.movementSpeed<this.minMovementSpeed&&(this.movementSpeed=this.minMovementSpeed);break;case i.UP:case i.W:t=CLOUD.MoveDirection.FORWARD,this.moveState.forward=1;break;case i.DOWN:case i.S:t=CLOUD.MoveDirection.BACK,this.moveState.back=1;break;case i.LEFT:case i.A:t=CLOUD.MoveDirection.LEFT,this.moveState.left=1;break;case i.RIGHT:case i.D:t=CLOUD.MoveDirection.RIGHT,this.moveState.right=1;break;case i.Q:t=CLOUD.MoveDirection.UP,this.moveState.up=1;break;case i.E:t=CLOUD.MoveDirection.DOWN,this.moveState.down=1;break;case i.TAB:return this.moveVector.set(0,0,0),this.moveState.forward=0,this.moveState.back=0,this.moveState.left=0,this.moveState.right=0,this.moveState.up=0,void(this.moveState.down=0);default:return}this._updateMovement(),this._updateRotation(),t!==CLOUD.MoveDirection.NONE&&this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYDOWN,event:e,direction:t,editor:this.name})}},CLOUD.WalkEditor.prototype.processKeyUp=function(e){if(!CLOUD.EditorConfig.NoKey){var t=CLOUD.MoveDirection.NONE,i=CLOUD.Keys;switch(e.keyCode){case i.UP:case i.W:t=CLOUD.MoveDirection.FORWARD,this.moveState.forward=0;break;case i.DOWN:case i.S:t=CLOUD.MoveDirection.BACK,this.moveState.back=0;break;case i.LEFT:case i.A:t=CLOUD.MoveDirection.LEFT,this.moveState.left=0;break;case i.RIGHT:case i.D:t=CLOUD.MoveDirection.RIGHT,this.moveState.right=0;break;case i.Q:t=CLOUD.MoveDirection.UP,this.moveState.up=0;break;case i.E:t=CLOUD.MoveDirection.DOWN,this.moveState.down=0;break;default:return}this._updateMovement(),this._updateRotation(),t!==CLOUD.MoveDirection.NONE&&this.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_KEYUP,event:e,direction:t,editor:this.name})}},CLOUD.WalkEditor.prototype.updateWalkMove=function(){var e=this._clock.getDelta(),t=this.cameraControl,i=t.camera.position.y;if(0!==this.moveVector.x||0!==this.moveVector.y||0!==this.moveVector.z||0!==this.rotationVector.x||0!==this.rotationVector.y||0!==this.rotationVector.z||0!==this.zoomDelta||0!==t.gravity){var n=this.movementSpeed*CLOUD.EditorConfig.WalkSpeedRate*e;if(1==CLOUD.GlobalData.WalkingWithGravity&&(this.moveVector.y=0,t.computeManHeight(),t.computeGravity()),t.dirtyCamera(!0),0!==this.zoomDelta){var r=1+this.zoomDelta*e;t.zoomCameraForWalk(r),this.zoomDelta=0}t.translateCameraForWalk(this.moveVector,n),this.dragLook?t.rotateCameraForWalk(this.rotationVector,1):t.rotateCameraForWalk(this.rotationVector,2),t.flyOnWorld(!1),i!==t.camera.position.y&&t.viewer.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_HEIGHT_CHANGED,cameraPosition:t.camera.position.clone()})}},CLOUD.WalkEditor.prototype.onEnter=function(){var e=this.cameraControl.scene,t=this.cameraControl.getCamera();t.isPerspective||(console.log("Current camera is Orthographic"),t.toPerspective()),e.getBoundingBox().containsPoint(t.position)&&t.position.y!=t.target.y&&function(e){var t=e.target.clone().sub(e.position),i=t.length(),n=t.clone();n.y=0,n.normalize(),n.multiplyScalar(i),e.target.addVectors(e.position,n)}(t),this._start()},CLOUD.WalkEditor.prototype.onExit=function(){this._stop()},CLOUD.WalkEditor.prototype.rotateTo=function(e){this._doRotate(e)},CLOUD.WalkEditor.prototype.moveTo=function(e,t,i){if(void 0===i&&(i=!0),void 0===t&&(t=1),i)switch(e){case CLOUD.MoveDirection.FORWARD:this.moveState.forward=t;break;case CLOUD.MoveDirection.BACK:this.moveState.back=t;break;case CLOUD.MoveDirection.LEFT:this.moveState.left=t;break;case CLOUD.MoveDirection.RIGHT:this.moveState.right=t;break;case CLOUD.MoveDirection.UP:this.moveState.up=t;break;case CLOUD.MoveDirection.DOWN:this.moveState.down=t}else switch(e){case CLOUD.MoveDirection.FORWARD:this.moveState.forward=0;break;case CLOUD.MoveDirection.BACK:this.moveState.back=0;break;case CLOUD.MoveDirection.LEFT:this.moveState.left=0;break;case CLOUD.MoveDirection.RIGHT:this.moveState.right=0;break;case CLOUD.MoveDirection.UP:this.moveState.up=0;break;case CLOUD.MoveDirection.DOWN:this.moveState.down=0}this._updateMovement()},CLOUD.WalkEditor.prototype.setHeightLocked=function(e){this.lockHeightEnabled&&this.isLockHeight!==e&&(this.isLockHeight=e)},CLOUD.WalkEditor.prototype.setDragLook=function(e){this.dragLook!==e&&(this.firstRotate=!0,this.dragLook=e)},CLOUD.MeasureTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.PICK_BY_MEASURE),this.editorManager=e.editorManager,this.pickHelper=new CLOUD.PickHelper(e.cameraControl),this.mouseDown=new THREE.Vector2,this.lastEvent=null,this.pick=!1,this.pickPoint=new THREE.Vector3},CLOUD.MeasureTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.MeasureTool.prototype.constructor=CLOUD.MeasureTool,CLOUD.MeasureTool.prototype.processMouseDown=function(e){return!!CLOUD.GlobalData.IsMobile||(e.button===THREE.MOUSE.LEFT?(this.mouseDown.x=e.clientX,this.mouseDown.y=e.clientY,!1):CLOUD.EditTool.prototype.processMouseDown.call(this,e))},CLOUD.MeasureTool.prototype.processMouseMove=function(e){return!1},CLOUD.MeasureTool.prototype.processMouseUp=function(e){if(CLOUD.GlobalData.IsMobile)return!0;if(e.button===THREE.MOUSE.LEFT){if(new THREE.Vector2(e.clientX,e.clientY).distanceTo(this.mouseDown)<=2){this.editorManager.isUpdateRenderList=!0;var t=this.pickPoint.clone();return e.shiftKey?this.pickHelper.handleShiftMeasure(e,!0,t):this.pickHelper.handleMouseMeasure(e,!0,t),t.equals(this.pickPoint)||(this.pick=!this.pick,this.pickPoint.copy(t)),!0}return!0}return CLOUD.EditTool.prototype.processMouseUp.call(this,e)},CLOUD.MeasureTool.prototype.processHover=function(e){return!!CLOUD.GlobalData.IsMobile||(e.shiftKey?this.pickHelper.handleShiftMeasure(e,!1,this.pickPoint):this.pickHelper.handleMouseMeasure(e,!1,this.pickPoint),!0)},CLOUD.MeasureTool.prototype.processTouchstart=function(e){return this.mouseDown.x=e.touches[0].clientX,this.mouseDown.y=e.touches[0].clientY,e.clientX=e.touches[0].clientX,e.clientY=e.touches[0].clientY,this.lastEvent=e,CLOUD.EditTool.prototype.processTouchstart.call(this,e)},CLOUD.MeasureTool.prototype.processTouchmove=function(e){return this.lastEvent=null,CLOUD.EditTool.prototype.processTouchmove.call(this,e)},CLOUD.MeasureTool.prototype.processTouchend=function(e){return null!=this.lastEvent&&(this.pickHelper.handleMouseMeasure(this.lastEvent,!0,this.pickPoint),this.editorManager.isUpdateRenderList=!0),CLOUD.EditTool.prototype.processTouchend.call(this,e)},CLOUD.MeasureTool.prototype.onExit=function(e){var t=this.pickHelper.scene;t.hasObjectGroup(CLOUD.ObjectGroupType.MEASUREPICKPLANE)&&t.removeObjectGroupByName(CLOUD.ObjectGroupType.MEASUREPICKPLANE)},CLOUD.EditorManager=function(){function e(e){r(),a=!0,o.isUpdateRenderList=!1,o.editor.processMouseDown(e)}function t(e){a?(o.isUpdateRenderList=!1,o.cameraChange=!0,o.editor.processMouseMove(e)):o.editor.processHover(e)}function i(e){o.isUpdateRenderList=!0,a&&(o.editor.processMouseUp(e),a=!1)}function n(n){
if(!o.enabled)return void(o.cameraChange=!1);for(var r=o.tools,s=r.length-1;s>=0;s--)if(r[s].onEvent(n)){switch(n.type){case"mouseup":a=!1}return}switch(n.type){case"touchmove":o.editor.processTouchmove(n);break;case"touchstart":o.editor.processTouchstart(n);break;case"touchend":o.editor.processTouchend(n);case"keydown":o.editor.processKeyDown(n);break;case"keyup":o.editor.processKeyUp(n);break;case"mousewheel":case"DOMMouseScroll":o.cameraChange=!0,o.editor.processMouseWheel(n);break;case"mousedown":e(n);break;case"mousemove":t(n);break;case"mouseup":i(n);break;case"dblclick":o.editor.processMouseDoubleClick(n)}}function r(){if(o.domElement){var e=o.domElement.querySelector("#cloud-main-canvas");e&&e.focus&&e.focus()}}this.editor=null,this.editors={},this.tools=[],this.domElement=null,this.enabled=!0,this.isUpdateRenderList=!0;var a=!1,o=this;this.getCameraControl=function(){return this.cameraControl},this.registerDomEventListeners=function(e){this.domElement=e,e.addEventListener("touchstart",n,!1),e.addEventListener("touchend",n,!1),e.addEventListener("touchmove",n,!1),e.addEventListener("contextmenu",function(e){e.preventDefault()},!1),e.addEventListener("mousedown",n,!1),e.addEventListener("mousewheel",n,!1),e.addEventListener("DOMMouseScroll",n,!1),e.addEventListener("dblclick",n,!1),window.addEventListener("mousemove",n,!1),window.addEventListener("mouseup",n,!1),e.addEventListener("keydown",n,!1),e.addEventListener("keyup",n,!1),r()},this.unregisterDomEventListeners=function(e){e.removeEventListener("touchstart",n,!1),e.removeEventListener("touchend",n,!1),e.removeEventListener("touchmove",n,!1),e.removeEventListener("contextmenu",function(e){e.preventDefault()},!1),e.removeEventListener("mousedown",n,!1),e.removeEventListener("mousewheel",n,!1),e.removeEventListener("DOMMouseScroll",n,!1),e.removeEventListener("dblclick",n,!1),window.removeEventListener("mousemove",n,!1),window.removeEventListener("mouseup",n,!1),e.removeEventListener("keydown",n,!1),e.removeEventListener("keyup",n,!1)}},CLOUD.EditorManager.prototype={constructor:CLOUD.EditorManager,destroy:function(){this.editor=null;for(var e in this.editors){this.editors[e].destroy()}this.editors={}},getCurrentEditorName:function(){return this.editor?this.editor.name:""},_getEditorByName:function(e,t){var i=this.editors[t];if(i)return i;var n=CLOUD.EditorMode;this.viewer=e;var r=e.cameraControl,r=(e.getScene(),e.domElement,this.cameraControl);switch(t){case n.ORBIT:i=new CLOUD.OrbitEditor(r);break;case n.PICK:i=new CLOUD.PickEditor(r);break;case n.PAN:i=new CLOUD.PanEditor(r);break;case n.ZOOM:i=new CLOUD.ZoomEditor(r);break;case n.FLY:i=new CLOUD.FlyEditor(r);break;case n.WALK:i=new CLOUD.WalkEditor(r);break;default:i=null,console.error("invalid editor name")}return i&&(i.name=t,this.editors[t]=i),i},getCurrentEditor:function(){return this.editor},setEditorMode:function(e,t){this.cameraControl=new CLOUD.CameraControl(e,e.getScene(),e.camera,e.domElement,function(t){e.render(t)});var i=this._getEditorByName(e,t);i&&this.editor!==i&&(null!==this.editor&&(this.editor.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_EXIST,name:this.editor.getName()}),this.editor.onExit()),this.editor=i,this.editor.onEnter(),this.editor.dispatchEvent({type:CLOUD.EVENTS.ON_EDITOR_ENTER,name:this.editor.getName()}))},getToolByName:function(e){for(var t=this.tools.length,i=0;i<t;++i)if(this.tools[i].name==e)return this.tools[i]},enableTool:function(e,t){for(var i=CLOUD.EditToolMode,n=this.tools,r=0,a=n.length;r<a;r++)if(n[r].name==t)return;var o=null;switch(t){case i.PICK_BY_RECT:o=new CLOUD.RectPickTool(e);break;case i.ZOOM_BY_RECT:o=new CLOUD.RectZoomTool(e);break;case i.CLIP_BY_BOX:o=new CLOUD.ClipPlanesTool(e);break;case i.CLIP_FILL:o=new CLOUD.FillClipPlaneTool(e);break;case i.PICK_BY_MEASURE:o=new CLOUD.MeasureTool(e)}o&&n.push(o)},disableTool:function(e){for(var t=this.tools,i=0,n=t.length;i<n;i++)if(t[i].name==e){t[i].onExit(),t.splice(i,1);break}},setInteractiveState:function(e){this.enabled=e}},CLOUD.SelectPad=function(e){this.editor=e,this.cameraControl=e.cameraControl,this.dim=this.cameraControl.getContainerDimensions(),this.pad=null,this.padSize=96,this.startPt=new THREE.Vector2,this.position=new THREE.Vector2,this.callback=null,this.intersect=null,this.init=function(){window.addEventListener("resize",this.padInitBind,!1),this.pad=document.createElement("div"),this.padInit(),this.cameraControl.domElement.appendChild(this.pad),this.addEventListener()},this.addEventListener=function(){this.pad.addEventListener("touchstart",this.padOnTouchStartBind,!1),this.pad.addEventListener("touchmove",this.padOnTouchMoveBind,!1),this.pad.addEventListener("touchend",this.padOnTouchEndBind,!1)},this.padInit=function(){null!=this.pad&&(this.pad.style.backgroundImage="url(images/selectPad.png)",this.pad.style.backgroundSize="100%",this.pad.style.position="absolute",this.pad.style.width=this.padSize.toString()+"px",this.pad.style.height=this.padSize.toString()+"px",this.pad.style.zIndex="10",this.pad.style.display="none")},this.showOverlay=function(e){this.position=e,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.pad.style.display="",this.pick()},this.hideOverlay=function(){this.pad.style.display="none"},this.pick=function(){var e=this.position.x,t=this.position.y,i=this.cameraControl,n=(this.editor.pickHelper,i.viewer.modelManager.sceneState),r=this,a=new THREE.Vector2(e,t),o=i.getIntersectContext(a);i.intersector.pick(o,function(e){if(n.clearSelection(),!e)return i.updateView(!0),void(r.intersect=null);var t=e.userId;i.viewer.getScene().intersectToWorld(e,i.viewer),n.addSelection([t]),r.intersect=e,i.updateView(!0)}),null!=r.intersect&&(r.intersect.cx=e,r.intersect.cy=t)},this.onTouchStart=function(e){1===e.touches.length&&(e.stopPropagation(),e.preventDefault(),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY))},this.onTouchMove=function(e){if(1===e.touches.length){e.stopPropagation(),e.preventDefault();var t=e.touches[0].clientX-this.startPt.x,i=e.touches[0].clientY-this.startPt.y;this.position.x+=t,this.position.y+=i,this.pad.style.left=this.position.x.toString()+"px",this.pad.style.top=(this.position.y-this.dim.top).toString()+"px",this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.pick(e)}},this.onTouchEnd=function(e){e.stopPropagation(),null!=this.callback?this.callback(this.intersect):console.log("selectPad click",this.intersect)},this.padInitBind=this.padInit.bind(this),this.padOnTouchStartBind=this.onTouchStart.bind(this),this.padOnTouchEndBind=this.onTouchEnd.bind(this),this.padOnTouchMoveBind=this.onTouchMove.bind(this),this.init()},CLOUD.Version="1.0.0.20190521",CLOUD.GlobalData={SceneSize:1e3,TextureResRoot:"images/",EnableTextureMapping:!1,EnableTextureLoading:!0,MaxTexturePixels:25e4,EnableLightmap:!1,LightmapIntensity:.5,ClippingCaps:!1,SelectionColor:{color:633990,side:THREE.DoubleSide},DisableAntialias:!1,EnableDemolishByDClick:!1,IsMobile:!1,UseMpkWorker:!1,MpkWorkerUrl:"../libs/mpkWorker.min.js",ZipResourcePostfix:".gz",HasLayerData:!1,Instance:!0,DataProvider:0,Renderer:0,MaxMemeorySizeToFullRender:1500,BatchMergeEnabled:!1,SegmentedBatchMergeEnable:!1,maxIndicesNumberPerBathSegment:65535,IncrementRender:!0,LimitFrameTime:250,maxObjectNumInPool:6e4,maxDrawCacheNum:4e4,OctantDepth:15,MaximumDepth:0,ConcurrencyRequestCount:8,ShowOctant:!1,EnableOctant:!0,EnableRenderPass:!1,LightPreset:3,IBL:!1,ToneMapping:1,LightIntensityFactor:1.5,Hover:!0,OcclusionTranslucentEnabled:!1,OcclusionOpacity:.5,OcclusionDistanceToCamera:1e3,LineSelectRange:30,DrawingStyle:0,DrawingBoardlineEnabled:!0,DrawingBoardlineLimit:!0,DrawingBoardlineLimitThreshold:2e5,CanUseWireframeFromData:!0,BorderLineBatched:!1,BorderLineDelayLoaded:!1,InitWireframeData:!1,SSAO:!1,MeasureHighlightPlane:!1,WalkingWithGravity:!1,EnableHitDetection:!1,TranslucentDepthDisabled:!1,SharedMeshInstanceEnable:!1,LoadMpkOnDemand:!1,EnableLoadOnDemand:!0,EnableSelectionOutline:!1,EnableDisposeBufferAfterVbo:!0,OrganizeNodesByCameraView:!1,CanUseCompressedTexture:!1,CanUseSmallTexture:!0,DEBUG:!1,EnableExplosion:!1,EnableLogarithmicDepthBuffer:!1,ConstraintZoom:!0},CLOUD.EnumStandardView={ISO:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44},CLOUD.CAMERATYPE={ORTHOGRAPHIC:0,PERSPECTIVE:1},CLOUD.OPSELECTIONTYPE={Clear:0,Add:1,Remove:2},CLOUD.PICKABLETYPE={Geometry:1,Marker3d:2,UnPickable:0},CLOUD.EVENTS={ON_LOAD_START:0,ON_LOAD_PROGRESS:1,ON_LOAD_COMPLETE:2,ON_LOAD_EMPTY_SCENE:3,ON_LOAD_INVALID_SCENE:5,ON_DEMAND_LOAD_COMPLETE:6,ON_EDITOR_ENTER:40,ON_EDITOR_EXIST:41,ON_EDITOR_BEGIN:42,ON_EDITOR_END:43,ON_EDITOR_UPDATEUI:44,ON_EDITOR_ZOOM:45,ON_SELECTION_CHANGED:100,ON_CLICK_PICK:101,ON_HOVER_PICK:102,ON_MEASURE_PICK:103,ON_SELECTION_FAILED:104,ON_CLIP_HOVER:105,ON_HOVER_SNAP:106,ON_CLIP_MOUSE_MOVE:107,ON_MOUSE_DRAGGED:108,ON_VERSION_NO_MATCH:200,ON_AXIS_GRID_HOVER:260,ON_VIEWER_RESTORED:300,ON_CAMERA_HEIGHT_CHANGED:400,ON_CAMERA_ANIMATION_UPDATE:500,ON_FLOOR_EXPLOSION:501},CLOUD.LOADERROREVENTS={LOAD_ERROR:1e3,LOAD_SCENE_ERROR:1001,LOAD_MATERIAL_ERROR:1002,LOAD_SYMBOL_ERROR:1003,LOAD_OCTREEINNER_ERROR:1004,LOAD_OCTREEOUTER_ERROR:1005,LOAD_USERID_ERROR:1006,LOAD_USERDATA_ERROR:1007,LOAD_CAMERA_ERROR:1008,LOAD_TEXTURE_ERROR:1009,LOAD_MPK_ERROR:1010,LOAD_IBLCONFIG_ERROR:1011},CLOUD.EnumRenderType={RENDER:0,RENDER_FINISHED:1,RESIZE:2},CLOUD.PrimitiveCount={vertexCount:0,triangleCount:0},CLOUD.RotatePivotMode={MOUSEPOINT:0,SELECTION:1,CENTER:2,CAMERA:3},CLOUD.EditorMode={ORBIT:"orbit",PICK:"pick",PAN:"pan",ZOOM:"zoom",FLY:"fly",WALK:"walk"},CLOUD.EditToolMode={PICK_BY_RECT:"pickByRect",ZOOM_BY_RECT:"zoomByRect",CLIP_BY_BOX:"clipByBox",CLIP_FILL:"fillClip",PICK_BY_MEASURE:"pickByMeasure",EDIT_CONTROL:"editControl"},CLOUD.MoveDirection={NONE:0,UP:1,DOWN:2,LEFT:4,RIGHT:8,FORWARD:16,BACK:32},CLOUD.DrawingStyle={SHADING:0,BOARDLINE:1,SHADINGWITHLINE:2};CLOUD.EnumInstanceState={HIDDEN:-1,NONE:0,HOVER:1,SELECTED:2,OVERRIDED:3,TRANSPARENT:4,BLINK:5},CLOUD.EnumDataProvider={AUTO:0,DEFAULT:1,MERGED:2,LAYER:3,LAYER_SCENE:4},CLOUD.EnumRendererType={AUTO:0,FULL:1,INCREMENT:2},CLOUD.EnumShaderColorState={NONE:0,BLINK:1,SELECT:2},CLOUD.Utils={TemporaryMatrix:new THREE.Matrix4,isDesktop:function(){var e=navigator.userAgent,t=/(?:Windows Phone)/.test(e),i=/(?:SymbianOS)/.test(e)||t,n=/(?:Android)/.test(e),r=/(?:Firefox)/.test(e),a=(/(?:Chrome|CriOS)/.test(e),/(?:iPad|PlayBook)/.test(e)||n&&!/(?:Mobile)/.test(e)||r&&/(?:Tablet)/.test(e));return!(/(?:iPhone)/.test(e)&&!a||n||i||a)},box3FromArray:function(e,t){if(e instanceof Array){var i=t||new THREE.Box3;return i.min.fromArray(e,0),i.max.fromArray(e,3),i}return null},box3FromArrayRange:function(e,t,i){for(var n=new THREE.Box3,r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,c=-1/0,u=t,h=i;u<h;u+=3){var d=e[u],f=e[u+1],p=e[u+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>c&&(c=p)}return n.min.set(r,a,o),n.max.set(s,l,c),n},computeBBox:function(e){for(var t=new THREE.Box3,i=new THREE.Vector3,n=0,r=e.length;n<r;++n)i.fromArray(e[n],0),t.expandByPoint(i);return t},mergeBBox:function(e){if(e.length<1)return null;for(var t=new THREE.Box3,i=new THREE.Vector3,n=new THREE.Vector3,r=new THREE.Box3,a=0,o=e.length;a<o;a++)i.set(e[a].max.x,e[a].max.y,e[a].max.z),n.set(e[a].min.x,e[a].min.y,e[a].min.z),r.set(n,i),t.union(r);return t},parseTransform:function(e,t,i){var n=!1;if(t.rotation&&(e.rotation.fromArray(t.rotation),n=!0),t.position&&(e.position.fromArray(t.position),n=!0),t.scale&&(e.scale.fromArray(t.scale),n=!0),t.quaternion&&(e.quaternion.fromArray(t.quaternion),n=!0),n&&e.updateMatrix(),t.matrix&&e.matrix.fromArray(t.matrix),i){var r=e.matrix.clone();r.multiplyMatrices(i,e.matrix),e.matrix=r}e.matrixAutoUpdate=!1,void 0!==e.boundingBox&&(e.boundingBox=CLOUD.Utils.box3FromArray(t.bbox))},isMobileDevice:function(){var e=navigator.platform;return 0!==e.indexOf("Win")&&0!==e.indexOf("Mac")},findRange:function(e,t){if(t<Math.min.apply(null,e))return 0;if(t>Math.max.apply(null,e))return e.length-1;for(var i=0,n=0,r=e.length;n<r;++n)if(e[n]>t){i=n-1;break}return i},stringToByte:function(e){var t,i,n=new Array;t=e.length;for(var r=0;r<t;r++)i=e.charCodeAt(r),i>=65536&&i<=1114111?(n.push(i>>18&7|240),n.push(i>>12&63|128),n.push(i>>6&63|128),n.push(63&i|128)):i>=2048&&i<=65535?(n.push(i>>12&15|224),n.push(i>>6&63|128),n.push(63&i|128)):i>=128&&i<=2047?(n.push(i>>6&31|192),n.push(63&i|128)):n.push(255&i);return n},byteToString:function(e){if("string"==typeof e)return e;for(var t="",i=e,n=0;n<i.length;n++){var r=i[n].toString(2),a=r.match(/^1+?(?=0)/);if(a&&8==r.length){for(var o=a[0].length,s=i[n].toString(2).slice(7-o),l=1;l<o;l++)s+=i[l+n].toString(2).slice(2);t+=String.fromCharCode(parseInt(s,2)),n+=o-1}else t+=String.fromCharCode(i[n])}return t},strToBinary:function(e){for(var t=[],i=e.split(""),n=0;n<i.length;n++){0!=n&&t.push(" ");var r=i[n],a=r.charCodeAt().toString(2);t.push(a)}return t.join("")},binaryToStr:function(e){for(var t=[],i=e.split(" "),n=0;n<i.length;n++){var r=i[n],a=parseInt(r,2),o=String.fromCharCode(a);t.push(o)}return t.join("")},byteArr2Int:function(e){return(255&e[0])<<24|(255&e[1])<<16|(255&e[2])<<8|(255&e[3])<<0},int2ByteArr:function(e){var t=[];return t[0]=e>>24,t[1]=e>>16,t[2]=e>>8,t[3]=e>>0,t},checkVersionMatch:function(e,t){var i=e.split(".");if(i.length>1){var n=parseInt(i[0]),r=parseInt(i[1]),a=t.toLowerCase();if((a=parseFloat(a))<.04&&0===n&&r<7)return!0;if(a>=.04&&(n>0||0===n&&r>=7))return!0}return!1},isMirror:function(e){var t=new THREE.Vector3(e[0],e[1],e[2]),i=new THREE.Vector3(e[4],e[5],e[6]),n=new THREE.Vector3(e[8],e[9],e[10]);return(new THREE.Vector3).crossVectors(t,i).dot(n)<0},isEmptyObject:function(e){if(!e)return!0;if(e.length>0)return!1;if(0===e.length)return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},isEmptyObjectSimple:function(e){for(var t in e)return!1;return!0},isOwnEmptyObject:function(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0},hexStrToRgb:function(e){var t=e.replace("#",""),i=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return i?{r:parseInt(i[1],16)/255,g:parseInt(i[2],16)/255,b:parseInt(i[3],16)/255}:null},hexToRgb:function(e){var t={};return t.r=(e>>16&255)/255,t.g=(e>>8&255)/255,t.b=(255&e)/255,t},getMin:function(e){for(var t=e.length,i=1/0;t--;)i=e[t]<i?e[t]:i;return i},getMax:function(e){for(var t=e.length,i=-1/0;t--;)i=e[t]>i?e[t]:i;return i},freezeObject:function(e){return Object.freeze?Object.freeze(e):e},getEncodedId:function(e){return CLOUD.md5&&"function"==typeof CLOUD.md5?CLOUD.md5(e):e},arrayToMap:function(e,t){t=t||{};for(var i=0,n=e.length;i<n;i++)t[e[i]]=!0;return t},getDifferentialIdxs:function(e,t){var i,n={},r={},a={};if(t)if(this.isEmptyObject(e))r=t;else{for(i in t)e[i]&&(a[i]=!0);if(this.isEmptyObject(a))n=e,r=t;else{for(i in t)a[i]||(r[i]=!0);for(i in e)a[i]||(n[i]=!0)}}else this.isEmptyObject(e)||(n=e);return{objCurrUsedIdxs:e,addIdxs:Object.keys(n),removeIdxs:Object.keys(r)}},getCombinedKeyString:function(e,t){return t=t||"&",e.join(t)},splitCombinedKeyString:function(e,t){return t=t||"&",e.split(t)},isGroupObject:function(e){return!(!e.children||!e.children.length)},isMeshObject:function(e){return!!(e.isMesh||e.isLine||e.isPoints)},extendObject:function(e,t,i){if(i)for(var n in t)"object"===_typeof(t[n])?CLOUD.Utils.extendObject(e[n],t[n],!0):e[n]=t[n];else for(var n in t)null!==e[n]&&void 0!==e[n]?"object"===_typeof(t[n])&&CLOUD.Utils.extendObject(e[n],t[n],!1):e[n]=t[n];return e},computeExplodeTranslation:function(e,t,i){var n=t.getCenter(),r=e.distanceTo(n),a=i*r,o=new THREE.Vector3;return o.subVectors(n,e),o.normalize(),o.multiplyScalar(a),o},minDistanceBetweenTriToMesh:function(e,t,i,n){function r(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function a(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function o(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function s(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function l(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function c(e,t,i,n){var c,u,h=s(t,n),d=s(t,t),f=s(n,n),p=r(i,e),m=s(t,p),g=s(n,p);c=(m*f-g*h)/(d*f-h*h),c<0||isNaN(c)?c=0:c>1&&(c=1),u=(c*h-g)/f;var v,y,E,x;return u<=0||isNaN(u)?(y=i,c=m/d,c<=0||isNaN(c)?(v=e,E=r(i,e)):c>=1?(v=a(e,t),E=r(i,v)):(v=o(e,t,c),x=l(p,t),E=l(t,x))):u>=1?(y=a(i,n),c=(h+m)/d,c<=0||isNaN(c)?(v=e,E=r(y,e)):c>=1?(v=a(e,t),E=r(y,v)):(v=o(e,t,c),p=r(y,e),x=l(p,t),E=l(t,x))):(y=o(i,n,u),c<=0||isNaN(c)?(v=e,x=l(p,n),E=l(n,x)):c>=1?(v=a(e,t),p=r(i,v),x=l(p,n),E=l(n,x)):(v=o(e,t,c),E=l(t,n),s(E,p)<0&&E.multiplyScalar(-1))),{vec:E,closestP:v,closestQ:y}}for(var u,h,d,f,p=new THREE.Vector3,m=new THREE.Vector3,g=new THREE.Vector3,v={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},y=t.geometry,E=y.attributes.position,x=i?i.indexStart:0,b=y.getIndex().array,C=i?i.indexStart+i.indexCount:b.length,M=x,f=C;M<f;M+=3){u=b[M],h=b[M+1],d=b[M+2];var _=[];!function(e,t,i,n,r,a){p.fromBufferAttribute(t,i),m.fromBufferAttribute(t,n),g.fromBufferAttribute(t,r),a&&(p.applyMatrix4(a),m.applyMatrix4(a),g.applyMatrix4(a)),e.push(p),e.push(m),e.push(g)}(_,E,u,h,d,n);var w=function(e,t){var i,n,a,u=[],h=[];u[0]=r(e[1],e[0]),u[1]=r(e[2],e[1]),u[2]=r(e[0],e[2]),h[0]=r(t[1],t[0]),h[1]=r(t[2],t[1]),h[2]=r(t[0],t[2]);for(var d,f,p,m,g=0,v=e[0].distanceToSquared(t[0])+1,y=0;y<3;y++)for(var E=0;E<3;E++){var x=c(e[y],u[y],t[E],h[E]);a=x.vec,i=x.closestP,n=x.closestQ,d=r(n,i);var b=s(d,d);if(b<=v){p=i.clone(),m=n.clone(),v=b,f=r(e[(y+2)%3],i);var C=s(f,a);f=r(t[(E+2)%3],n);var M=s(f,a);if(C<=0&&M>=0)return{start:i.clone(),end:n.clone(),minDistance:Math.sqrt(b)};var _=s(d,a);C<0&&(C=0),M>0&&(M=0),_-C+M>0&&(g=1)}}var w=l(u[0],u[1]),L=s(w,w);if(L>1e-15){var T=[];d=r(e[0],t[0]),T[0]=s(d,w),d=r(e[0],t[1]),T[1]=s(d,w),d=r(e[0],t[2]),T[2]=s(d,w);var I=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(I=T[0]<T[1]?0:1,T[2]<T[I]&&(I=2)):T[0]<0&&T[1]<0&&T[2]<0&&(I=T[0]>T[1]?0:1,T[2]>T[I]&&(I=2)),I>=0&&(g=1,d=r(t[I],e[0]),f=l(w,u[0]),s(d,f)>0&&(d=r(t[I],e[1]),f=l(w,u[1]),s(d,f)>0&&(d=r(t[I],e[2]),f=l(w,u[2]),s(d,f)>0))))return i=o(t[I],w,T[I]/L),n=t[I].clone(),{start:i.clone(),end:n,minDistance:i.distanceTo(n)}}var S=l(h[0],h[1]),O=s(S,S);if(O>1e-15){var D=[];d=r(t[0],e[0]),D[0]=s(d,S),d=r(t[0],e[1]),D[1]=s(d,S),d=r(t[0],e[2]),D[2]=s(d,S);var I=-1;if(D[0]>0&&D[1]>0&&D[2]>0?(I=D[0]<D[1]?0:1,D[2]<D[I]&&(I=2)):D[0]<0&&D[1]<0&&D[2]<0&&(I=D[0]>D[1]?0:1,D[2]>D[I]&&(I=2)),I>=0&&(g=1,d=r(e[I],t[0]),f=l(S,h[0]),s(d,f)>0&&(d=r(e[I],t[1]),f=l(S,h[1]),s(d,f)>0&&(d=r(e[I],t[2]),f=l(S,h[2]),s(d,f)>0))))return i=e[I].clone(),n=o(e[I],S,D[I]/O),{start:i,end:n.clone(),minDistance:i.distanceTo(n)}}return g?(i=p,n=m,{start:p.clone(),end:m.clone(),minDistance:Math.sqrt(v)}):{start:p.clone(),end:m.clone(),minDistance:0}}(e,_);if(w.minDistance<=0)return v.minDistance=0,v;v.minDistance>w.minDistance&&(v.minDistance=w.minDistance,v.start=w.start.clone(),v.end=w.end.clone())}return v},asyncProcess:function(e,t,i,n,r){function a(o){var s=o;return function(){var o,l;for(l=s+i>t?t:s+i,o=s;o<l;o++){var c=o;n&&n(e,c),o===l-1&&(l!==t?requestAnimationFrame(a(o+1)):r&&r(e))}}}requestAnimationFrame(a(0))}},CLOUD.DomUtil={getContainerOffsetToClient:function(e){var t,i=function(e){for(var t=0,i=0;e;)t+=e.offsetTop,i+=e.offsetLeft,e=e.offsetParent;var n=document.body,r=document.documentElement,a=window.pageYOffset||r.scrollTop||n.scrollTop,o=window.pageXOffset||r.scrollLeft||n.scrollLeft;return t-=a,i-=o,{top:t,left:i}},n=function(e){var t=e.getBoundingClientRect(),i=document.body,n=document.documentElement,r=n.clientTop||i.clientTop,a=n.clientLeft||i.clientLeft,o=t.top-r,s=t.left-a;return{top:Math.round(o),left:Math.round(s)}};if(e!=document){var r=function(e){return e.getBoundingClientRect?n(e):i(e)}(e);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t}},CLOUD.GeomUtil={EmptyGeometry:new THREE.Geometry,UnitCylinderInstance:new THREE.CylinderBufferGeometry(1,1,1,8,1,!1),UnitBoxInstance:new THREE.BoxBufferGeometry(1,1,1),UnitTextureCylinder:null,UnitTextureBox:null,initializeUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.boundingBox||CLOUD.GeomUtil.UnitCylinderInstance.computeBoundingBox(),CLOUD.GeomUtil.UnitBoxInstance.boundingBox||CLOUD.GeomUtil.UnitBoxInstance.computeBoundingBox()},destroyUnitInstances:function(){CLOUD.GeomUtil.UnitCylinderInstance.dispose(),CLOUD.GeomUtil.UnitBoxInstance.dispose()},getBoxData:function(e){for(var t=[[-.5,-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5],[-.5,-.5,-.5,-.5,-.5,.5,.5,-.5,-.5,.5,-.5,.5],[-.5,-.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5,.5,-.5],[-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5,.5],[-.5,.5,-.5,-.5,.5,.5,.5,.5,-.5,.5,.5,.5],[.5,-.5,-.5,.5,-.5,.5,.5,.5,-.5,.5,.5,.5]],i=[[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3],[0,1,2,3,2,1],[2,1,0,1,2,3]],n=[[],[],[],[],[],[]],r=0;r<4;++r)n[0].push(-1,0,0);for(var r=0;r<4;++r)n[1].push(0,-1,0);for(var r=0;r<4;++r)n[2].push(0,0,-1);for(var r=0;r<4;++r)n[3].push(0,0,1);for(var r=0;r<4;++r)n[4].push(0,1,0);for(var r=0;r<4;++r)n[5].push(1,0,0);var a=[[],[],[],[],[],[]];return a[0]=a[2]=a[4]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],a[1]=a[3]=a[5]=[-.5,-.5,-.5,.5,.5,-.5,.5,.5],{vertex:t[e],normal:n[e],uv:a[e],index:i[e]}},getPipeData2:function(){var e=[.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5,.5,0,-.5,.5,0,.5,.353530875,.353530875,.5,0,.5,.5,-.353530875,.353530875,.5,-.5,0,.5,-.353530875,-.353530875,.5,0,-.5,.5,.353530875,-.353530875,.5,.5,0,-.5,.353530875,.353530875,-.5,0,.5,-.5,-.353530875,.353530875,-.5,-.5,0,-.5,-.353530875,-.353530875,-.5,0,-.5,-.5,.353530875,-.353530875,-.5],t=[0,9,1,1,9,10,1,10,2,2,10,11,2,11,3,3,11,12,3,12,4,4,12,13,4,13,5,5,13,14,5,14,6,6,14,15,6,15,7,7,15,16,7,16,8,8,16,17,18,19,20,18,20,21,18,21,22,18,22,23,18,23,24,18,24,25,26,28,27,26,29,28,26,30,29,26,31,30,26,32,31,26,33,32],i=[1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,1,0,0,.7,.7,0,0,1,0,-.7,.7,0,-1,0,0,-.7,-.7,0,0,-1,0,.7,-.7,0,1,0,0,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,-1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1,0,0,1],n=[-.5,.5,-.375,.5,-.25,.5,-.125,.5,0,.5,.125,.5,.25,.5,.375,.5,.5,.5,-.5,-.5,-.375,-.5,-.25,-.5,-.125,-.5,0,-.5,.125,-.5,.25,-.5,.375,-.5,.5,-.5,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875,.5,0,.353530875,.353530875,0,.5,-.353530875,.353530875,-.5,0,-.353530875,-.353530875,0,-.5,.353530875,-.353530875];return function(){return{vertex:e,normal:i,uv:n,index:t}}}(),getPipeData:function(e){(void 0===e||e<8)&&(e=8),e>256&&(e=256);var t,i,n=4*e+2,r=3*(4*e-4),a=e+1,o=1/e,s=6.28318530714/e,l=[];for(t=0;t<e;++t)l.push(.5*Math.cos(t*s)),l.push(.5*Math.sin(t*s));l.push(.5),l.push(0);var c=[];for(i=2*a,t=0;t<i;t+=2)c.push(l[t]),c.push(l[t+1]),c.push(.5);for(t=0;t<i;t+=2)c.push(l[t]),c.push(l[t+1]),c.push(-.5);for(i=2*e,t=0;t<i;t+=2)c.push(l[t]),c.push(l[t+1]),c.push(.5);for(t=i;t>0;t-=2)c.push(l[t]),c.push(l[t+1]),c.push(-.5);var u=[],h=e+1;for(t=0;t<e;++t)u.push(t),u.push(t+h),u.push(t+1),u.push(t+1),u.push(t+h),u.push(t+h+1);var d=2*a;for(t=1;t<e-1;++t)u.push(d),u.push(d+t),u.push(d+t+1);for(d+=e,t=1;t<e-1;++t)u.push(d),u.push(d+t),u.push(d+t+1);var f=[];for(t=e;t>=0;--t)f.push(t*o-.5),f.push(-.5);for(t=e;t>=0;--t)f.push(t*o-.5),f.push(.5);for(i=2*e,t=0;t<i;t+=2)f.push(l[t]),f.push(l[t+1]);for(t=i;t>0;t-=2)f.push(l[t]),f.push(l[t+1]);i=3*n;var p=[];for(t=0;t<i;++t)p.push(0);var m,g,v,y=new THREE.Vector3,E=new THREE.Vector3,x=new THREE.Vector3,b=new THREE.Vector3,C=new THREE.Vector3;for(t=0;t<r;t+=3)m=3*u[t],g=3*u[t+1],v=3*u[t+2],y.fromArray(c,m),E.fromArray(c,g),x.fromArray(c,v),b.subVectors(x,E),C.subVectors(y,E),b.cross(C),p[m]+=b.x,p[m+1]+=b.y,p[m+2]+=b.z,p[g]+=b.x,p[g+1]+=b.y,p[g+2]+=b.z,p[v]+=b.x,p[v+1]+=b.y,p[v+2]+=b.z;var M=new THREE.Vector3;for(i=3*n,t=0;t<i;t+=3)M.fromArray(p,t),M.normalize(),p[t]=M.x,p[t+1]=M.y,p[t+2]=M.z;return{vertex:c,normal:p,uv:f,index:u,edges:e}},getInstancePipeData:function(e,t){var i=this.getPipeData(e);(void 0===e||e<8)&&(e=8),e>256&&(e=256);var n=2*(e+1),r=n+e,a=4*e+2,o=[[],[],[]];o[0]=i.vertex.slice(0,3*n),o[1]=i.vertex.slice(3*n,3*r),o[2]=i.vertex.slice(3*r,3*a);var s=[[],[],[]],l=e+1,c=0;for(c=0;c<e;++c)s[0].push(c),s[0].push(c+l),s[0].push(c+1),s[0].push(c+1),s[0].push(c+l),s[0].push(c+l+1);for(c=1;c<e-1;++c)s[1].push(0),s[1].push(c),s[1].push(c+1);for(c=1;c<e-1;++c)s[2].push(0),s[2].push(c),s[2].push(c+1);var u=[[],[],[]];u[0]=i.uv.slice(0,2*n),u[1]=i.uv.slice(2*n,2*r),u[2]=i.uv.slice(2*r,2*a);var h=[[],[],[]];return h[0]=i.normal.slice(0,3*n),h[1]=i.normal.slice(3*n,3*r),h[2]=i.normal.slice(3*r,3*a),{vertex:o[t],normal:h[t],uv:u[t],index:s[t]}},getUnitTextureCylinder:function(){if(null==CLOUD.GeomUtil.UnitTextureCylinder){CLOUD.GeomUtil.UnitTextureCylinder=new Array(3);for(var e=0;e<3;++e){var t=CLOUD.GeomUtil.getInstancePipeData(32,e);CLOUD.GeomUtil.UnitTextureCylinder[e]=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitTextureCylinder[e].setIndex(t.index),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),CLOUD.GeomUtil.UnitTextureCylinder[e].addAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return CLOUD.GeomUtil.UnitTextureCylinder},getUnitTextureBox:function(){if(null===CLOUD.GeomUtil.UnitTextureBox){CLOUD.GeomUtil.UnitTextureBox=new Array(6);for(var e=0;e<6;++e){var t=CLOUD.GeomUtil.getBoxData(e);CLOUD.GeomUtil.UnitTextureBox[e]=new THREE.BufferGeometry,CLOUD.GeomUtil.UnitTextureBox[e].setIndex(t.index),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),CLOUD.GeomUtil.UnitTextureBox[e].addAttribute("uv",new THREE.Float32BufferAttribute(t.uv,2))}}return CLOUD.GeomUtil.UnitTextureBox},getBoxBufferGeometryWithUvMatrices:function(e){for(var t,i=[],n=new THREE.Matrix3,r=new THREE.Vector3,a=!!e,o=0;o<6;++o){t=new THREE.BufferGeometry;var s=CLOUD.GeomUtil.getBoxData(o);if(a){var l=[];n.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1);for(var c=0,u=s.uv.length;c<u;c+=2)r.set(s.uv[c],s.uv[c+1],1),r.applyMatrix3(n),l.push(r.x),l.push(r.y);t.addAttribute("uv",new THREE.Float32BufferAttribute(l,2))}t.setIndex(new THREE.BufferAttribute(Uint32Array.from(s.index),1)),t.addAttribute("position",new THREE.Float32BufferAttribute(s.vertex,3)),t.addAttribute("normal",new THREE.Float32BufferAttribute(s.normal,3)),i.push(t)}return CLOUD.GeomUtil.mergeBufferGeometries2(i)},getPipeBufferGeometryWithUvMatrices:function(e){var t=CLOUD.GeomUtil.getPipeData(32),i=t.edges,n=!(!e||18!==e.length),r=new THREE.BufferGeometry;if(n){for(var a=[],o=0,s=e.length;o<s;o+=6){var l=new THREE.Matrix3;l.set(e[6*o],e[6*o+2],e[6*o+4],e[6*o+1],e[6*o+3],e[6*o+5],0,0,1),a.push(l)}for(var c=[],u=new THREE.Vector3,h=4*(i+1),d=h+2*i,f=0,p=t.uv.length;f<p;f+=2)u.set(t.uv[f],t.uv[f+1],1),f<h?u.applyMatrix3(a[0]):f<d?u.applyMatrix3(a[1]):u.applyMatrix3(a[2]),c.push(u.x),c.push(u.y);r.addAttribute("uv",new THREE.Float32BufferAttribute(c,2))}return r.setIndex(new THREE.Uint32BufferAttribute(t.index,1)),r.addAttribute("position",new THREE.Float32BufferAttribute(t.vertex,3)),r.addAttribute("normal",new THREE.Float32BufferAttribute(t.normal,3)),r},getWorldMatrixOfMesh:function(e){for(var t=[],i=e.parent;i;)t.push(i.matrix),i=i.parent;var n=new THREE.Matrix4;if(t.length>0){n=t[t.length-1];for(var r=t.length-2;r>=0;--r)n.multiply(t[r])}var a=new THREE.Matrix4;return a.multiplyMatrices(n,e.matrix),a},getWorldPositionOfMesh:function(e,t){t||(t=new THREE.Matrix4);var i=new THREE.Matrix4;i.getInverse(t);var n=e.clone();return n.applyMatrix4(i),n},getBoundingBoxWorldOfMesh:function(e,t){var i=e.boundingBox;i||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),i=e.geometry.boundingBox);var n=i.clone();n.applyMatrix4(e.matrixWorld);var r=new THREE.Matrix4;return r.getInverse(t),n.applyMatrix4(r),n},mergeBufferGeometries:function(e,t){for(var i=null!==e[0].geometry.index,n=new Set(Object.keys(e[0].geometry.attributes)),r=new Set(Object.keys(e[0].geometry.morphAttributes)),a={},o={},s=new THREE.BufferGeometry,l=0;l<e.length;++l){var c=e[l].geometry;if(i!==(null!==c.index))return null;for(var u in c.attributes){if(!n.has(u))return console.log("attributes not Used: ",u),null;void 0===a[u]&&(a[u]=[]),a[u].push(c.attributes[u])}for(var u in c.morphAttributes){if(!r.has(u))return null;void 0===o[u]&&(o[u]=[]),o[u].push(c.morphAttributes[u])}void 0!==c.userData&&(s.userData=s.userData||{},s.userData.mergedUserData=s.userData.mergedUserData||[],s.userData.mergedUserData.push(c.userData))}if(i){for(var h=0,d=[],f=0,l=0;l<e.length;++l){var p=e[l].geometry.index;if(h>0){p=p.clone();for(var m=0;m<p.count;++m)p.setX(m,p.getX(m)+h)}d.push(p),h+=e[l].geometry.attributes.position.count,void 0===t[e[l].name]&&(t[e[l].name]=[]),t[e[l].name].push({nodeId:e[l].nodeId,indexStart:f,indexCount:p.count}),f+=p.count}var g=this.mergeBufferAttributes(d);if(!g)return null;s.index=g}for(var u in a){var v=this.mergeBufferAttributes(a[u]);if(!v)return null;s.addAttribute(u,v)}for(var u in o){var y=o[u][0].length;if(0===y)break;s.morphAttributes=s.morphAttributes||{},s.morphAttributes[u]=[];for(var l=0;l<y;++l){for(var E=[],m=0;m<o[u].length;++m)E.push(o[u][m][l]);var x=this.mergeBufferAttributes(E);if(!x)return null;s.morphAttributes[u].push(x)}}return s},mergeBufferGeometries2:function(e){for(var t=null!==e[0].index,i=new Set(Object.keys(e[0].attributes)),n={},r=new THREE.BufferGeometry,a=0;a<e.length;++a){var o=e[a];if(t!==(null!==o.index))return null;for(var s in o.attributes){if(!i.has(s))return null;void 0===n[s]&&(n[s]=[]),n[s].push(o.attributes[s])}}if(t){for(var l=0,c=[],a=0;a<e.length;++a){var u=e[a].index;if(l>0){u=u.clone();for(var h=0;h<u.count;++h)u.setX(h,u.getX(h)+l)}c.push(u),l+=e[a].attributes.position.count}var d=this.mergeBufferAttributes(c);if(!d)return null;r.index=d}for(var s in n){var f=this.mergeBufferAttributes(n[s]);if(!f)return null;r.addAttribute(s,f)}return r},mergeBufferAttributes:function(e){for(var t,i,n,r=0,a=0;a<e.length;++a){var o=e[a];if(o.isInterleavedBufferAttribute)return null;if(void 0===t&&(t=o.array.constructor),t!==o.array.constructor)return null;if(void 0===i&&(i=o.itemSize),i!==o.itemSize)return null;if(void 0===n&&(n=o.normalized),n!==o.normalized)return null;r+=o.array.length}for(var s=new t(r),l=0,c=0;c<e.length;++c)s.set(e[c].array,l),l+=e[c].array.length;return new THREE.BufferAttribute(s,i,n)},applyMatrix3ToBuffer:function(){var e=new THREE.Vector3;return function(t,i){for(var n=0,r=i.length;n<r;n+=3)e.x=i[n+0],e.y=i[n+1],e.z=i[n+2],e.applyMatrix3(t),i[n+0]=e.x,i[n+1]=e.y,i[n+2]=e.z;return i}}(),applyMatrix4ToBuffer:function(){var e=new THREE.Vector3;return function(t,i){for(var n=0,r=i.length;n<r;n+=3)e.x=i[n+0],e.y=i[n+1],e.z=i[n+2],e.applyMatrix4(t),i[n+0]=e.x,i[n+1]=e.y,i[n+2]=e.z;return i}}(),normalizeBuffer:function(e){for(var t,i,n,r,a=0,o=e.length;a<o;a+=3)t=e[a],
i=e[a+1],n=e[a+2],r=1/Math.sqrt(t*t+i*i+n*n),e[a+0]=t*r,e[a+1]=i*r,e[a+2]=n*r},disposeBufferFromGeometry:function(e,t){for(var i=0,n=t.length;i<n;i++){var r=e.getAttribute(t[i]);r&&(r.array=null)}},disposeIndexBufferFromGeometry:function(e){e.index&&(e.index.array=null)}},CLOUD.GeomUtil.getBoxMBuffer=function(){for(var e,t,i=[],n=[],r=[],a=0,o=0;o<6;++o){var s=CLOUD.GeomUtil.getBoxData(o);for(e=0,t=s.vertex.length;e<t;e++)i.push(s.vertex[e]);for(e=0,t=s.index.length;e<t;e++)r.push(s.index[e]+a);for(a+=s.vertex.length/3,e=0,t=s.normal.length;e<t;e++)n.push(s.normal[e])}return function(e){var t=null;if(e){var a=new THREE.Matrix3,o=new THREE.Vector3;t=[];for(var s=0;s<6;++s){var l=CLOUD.GeomUtil.getBoxData(s);a.set(e[6*s],e[6*s+2],e[6*s+4],e[6*s+1],e[6*s+3],e[6*s+5],0,0,1);for(var c=0,u=l.uv.length;c<u;c+=2)o.set(l.uv[c],l.uv[c+1],1),o.applyMatrix3(a),t.push(o.x),t.push(o.y)}}return{vertex:i,normal:n,uv:t,index:r}}}(),CLOUD.GeomUtil.getPipeMBuffer=function(){var e=CLOUD.GeomUtil.getPipeData(32),t=e.edges,i=e.vertex,n=e.normal,r=e.index;return function(e){var a=null;if(!(!e||18!==e.length)){a=[];for(var o=[],s=0,l=e.length/6;s<l;s++){var c=new THREE.Matrix3;c.set(e[6*s],e[6*s+2],e[6*s+4],e[6*s+1],e[6*s+3],e[6*s+5],0,0,1),o.push(c)}for(var u=CLOUD.GeomUtil.getPipeData(32),h=4*(t+1),d=h+2*t,f=new THREE.Vector3,p=0,m=u.uv.length;p<m;p+=2)f.set(u.uv[p],u.uv[p+1],1),p<h?f.applyMatrix3(o[0]):p<d?f.applyMatrix3(o[1]):f.applyMatrix3(o[2]),a.push(f.x),a.push(f.y)}return{vertex:i,normal:n,uv:a,index:r}}}(),CLOUD.MaterialUtil={DefaultMaterial:new THREE.MeshPhongMaterial({color:255,side:THREE.DoubleSide}),getDefaultStandardMaterial:function(){var e=null;return function(){return e||(e=new CLOUD.CloudStandardMaterial({color:0,side:THREE.DoubleSide})),e}}(),createInstancePhongMaterial:function(e){return e.clone()},updateBasicMaterial:function(e,t){e.needsUpdate=!0},setMatrixUniform:function(e){CLOUD.ShaderMaterial.ShaderLib.base_cust_clip.uniforms.transformMatrix.value=e},createPhongMaterial:function(e){var t=new THREE.MeshPhongMaterial(e);return t.type="FillFacePhong",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.fillFacePhong.uniforms]),t.vertexShader=THREE.ShaderLib.fillFacePhong.vertexShader,t.fragmentShader=THREE.ShaderLib.fillFacePhong.fragmentShader,t.side=THREE.DoubleSide,t},createStandardMaterial:function(e){return new CLOUD.CloudStandardMaterial(e)},createInstanceMaterial:function(e,t){var i=CLOUD.MaterialUtil.createStandardMaterial(e);return i.defines.USE_INSTANCE="",t&&(i.defines.USE_INSTANCE_NORMAL=""),i.colorState=CLOUD.EnumShaderColorState.BLINK,i.refreshUniforms(),i},createNewStyleMaterial:function(e){var t=new THREE.MeshStandardMaterial(e);return t.type="NewStyle",t.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms]),t.vertexShader=THREE.ShaderLib.newStyle.vertexShader,t.fragmentShader=THREE.ShaderLib.newStyle.fragmentShader,t.metalness=0,t},createHighlightMaterial:function(){return this.createStandardMaterial(CLOUD.GlobalData.SelectionColor)},getBlinkMaterial:function(e,t){var i=CLOUD.MaterialUtil.getMaterialParameters(e),n=CLOUD.MaterialUtil.createStandardMaterial(i);return n.blinkColor.copy(t),n.colorState=CLOUD.EnumShaderColorState.BLINK,n.refreshUniforms(),n},getMaterialParameters:function(e){var t={};return e.hasOwnProperty("color")&&(t.color=e.color),t.opacity=1,t.transparent=!1,e.hasOwnProperty("opacity")&&(t.opacity=e.opacity,e.opacity<1&&(t.transparent=!0)),e.hasOwnProperty("side")&&(t.side=e.side),e.hasOwnProperty("emissive")&&(t.emissive=e.emissive),e.hasOwnProperty("specular")&&(t.specular=e.specular),e.hasOwnProperty("shininess")&&(t.shininess=e.shininess),e.hasOwnProperty("map")&&(t.map=e.map),e.hasOwnProperty("bumpMap")&&(t.bumpMap=e.bumpMap),e.hasOwnProperty("bumpScale")&&(t.bumpScale=e.bumpScale),e.hasOwnProperty("normalMap")&&(t.normalMap=e.normalMap),e.hasOwnProperty("normalScale")&&(t.normalScale=e.normalScale),e.hasOwnProperty("alphaMap")&&(t.alphaMap=e.alphaMap),e.hasOwnProperty("alphaTest")&&(t.alphaTest=e.alphaTest),e.hasOwnProperty("transparent")&&(t.transparent=e.transparent),e.hasOwnProperty("emissiveMap")&&(t.emissiveMap=e.emissiveMap),e.hasOwnProperty("envMap")&&(t.envMap=e.envMap),e.hasOwnProperty("envMapIntensity")&&(t.envMapIntensity=e.envMapIntensity),e.hasOwnProperty("roughness")&&(t.roughness=e.roughness),e.hasOwnProperty("metalness")&&(t.metalness=e.metalness),e.hasOwnProperty("originRoughness")&&(t.originRoughness=e.originRoughness),e.hasOwnProperty("originMetalness")&&(t.originMetalness=e.originMetalness),CLOUD.GlobalData.IBL&&e.hasOwnProperty("iblProbe")&&(t.iblProbe=e.iblProbe),e.hasOwnProperty("shift")&&(t.shift=e.shift),e.hasOwnProperty("pureColor")&&(t.pureColor=e.pureColor),e.hasOwnProperty("textureColor")&&(t.textureColor=e.textureColor),e.hasOwnProperty("imageFade")&&(t.imageFade=e.imageFade),"cloudStandard"==e.type&&e.hasOwnProperty("lights")&&(t.lights=e.lights),t},nextHighestPowerOfTwo:function(e){--e;for(var t=1;t<32;t<<=1)e|=e>>t;return e+1},ensurePowerOfTwo:function(e){if(0==e.width||0==e.height)return e;if(!THREE.Math.isPowerOfTwo(e.width)||!THREE.Math.isPowerOfTwo(e.height)){var t=document.createElement("canvas");t.width=CLOUD.MaterialUtil.nextHighestPowerOfTwo(e.width),t.height=CLOUD.MaterialUtil.nextHighestPowerOfTwo(e.height);return t.getContext("2d").drawImage(e,0,0,e.width,e.height,0,0,t.width,t.height),t}return e},ensureQuadrate:function(e){var t=e.width,i=e.height;if(0==t||0==i||THREE.Math.isPowerOfTwo(t)&&THREE.Math.isPowerOfTwo(i)&&t===i)return e;THREE.Math.isPowerOfTwo(t)||(t=CLOUD.MaterialUtil.nextHighestPowerOfTwo(t)),THREE.Math.isPowerOfTwo(i)||(i=CLOUD.MaterialUtil.nextHighestPowerOfTwo(i));var n=0,r=0;t>=i?r=.5*(t-i):n=.5*(i-t);var a=document.createElement("canvas");return a.width=a.height=Math.max(t,i),a.getContext("2d").drawImage(e,0,0,e.width,e.height,n,r,t,i),a},getColorParamsByMaterial:function(e){return{rgbaColor:[e.color.r,e.color.g,e.color.b,e.opacity],transparent:e.transparent}},getHoverColorByColor:function(e){var t={};return t.r=e.r,t.g=e.g,t.b=e.b,t.a=e.a>=.3?e.a-.3:e.a+.3,t}},CLOUD.Logger={log:function(){CLOUD.GlobalData.DEBUG&&console.log.apply(console,arguments)},debug:function(){CLOUD.GlobalData.DEBUG&&console.debug.apply(console,arguments)},warn:function(){CLOUD.GlobalData.DEBUG&&console.warn.apply(console,arguments)},error:function(){CLOUD.GlobalData.DEBUG&&console.error.apply(console,arguments)},time:function(){CLOUD.GlobalData.DEBUG&&console.time.apply(console,arguments)},timeEnd:function(){CLOUD.GlobalData.DEBUG&&console.timeEnd.apply(console,arguments)}},CLOUD.UIHelper={debugInfoDiv:null,lastDebugInfoDivShow:null,showPickedInformation:function(e){function t(){var e=r.debugInfoDiv;e&&"none"!==e.style.display&&(e.style.display="none",r.lastDebugInfoDivShow&&(e.removeEventListener("dblclick",t,!1),r.lastDebugInfoDivShow=!1))}var i=340,n=320,r=this;if(!e||!e.intersectInfo)return void t();var a=e.intersectInfo,o=e.canvasPos.x,s=e.canvasPos.y;this.debugInfoDiv||(this.debugInfoDiv=document.createElement("div"),this.debugInfoDiv.id="debugPickedInfo",this.debugInfoDiv.style.display="block",this.debugInfoDiv.style.position="absolute",this.debugInfoDiv.style.width=i+"px",this.debugInfoDiv.style.height=n+"px",this.debugInfoDiv.style.backgroundColor="#ffffdd",this.debugInfoDiv.style.borderWidth="2px",this.debugInfoDiv.style.borderStyle="solid",this.debugInfoDiv.style.opacity="0.8",document.body.appendChild(this.debugInfoDiv)),this.debugInfoDiv.style.display="",this.lastDebugInfoDivShow||(this.lastDebugInfoDivShow=!0,this.debugInfoDiv.addEventListener("dblclick",t,!1));var l=a.axisGridInfo,c=a.worldPosition,u="";u+="<span>&#9830;&nbsp;&nbsp;Base Information</span><ul style='width:340px;list-style:none'>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;border-bottom: 1px solid #ccc;float:left;width:80px;height:66px;text-align:left;line-height:66px'>ID</li>",u+="<li style='border:1px solid #ccc;float:left;width:200px;height:66px;text-align:left;'>"+a.selectedObjectId+"</li>",u+="</ul>",u+="</br><span>&#9830;&nbsp;&nbsp;Position</span><ul style='width:340px;list-style:none'>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>X</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+c.x+"</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>Y</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>"+c.y+"</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>Z</li>",u+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>"+c.z+"</li>",u+="</ul>",l?(u+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px'>distanceX</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px;border-right: 1px solid #ccc'>("+l.numeralName+", "+l.offsetX+")</li>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>distanceY</li>",u+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'>("+l.abcName+", "+l.offsetY+")</li>",u+="</ul>"):(u+="</br><span>&#9830;&nbsp;&nbsp;Axis Grid Information</span><ul style='width:340px;list-style:none'>",u+="<li style='border-left:1px solid #ccc;border-top:1px solid #ccc;float:left;width:80px;height:33px;text-align:left;line-height:33px;border-bottom: 1px solid #ccc'>message</li>",u+="<li style='border:1px solid #ccc;float:left;width:200px;height:33px;text-align:left;line-height:33px'><span style='color: red'> not exist axis grid!!!</span></li>",u+="</ul>"),this.debugInfoDiv.innerHTML=u+"<br /><br />",function(e,t,r){if(e&&"none"!=e.style.display){var a,o,s=t+i,l=r+n;if(void 0!==t&&void 0!==r)if(window.innerWidth)a=s>window.innerWidth?window.pageXOffset+(t-i)+"px":window.pageXOffset+t+"px",o=l>window.innerHeight?window.pageYOffset+(r-n)+"px":window.pageYOffset+r+"px";else{var c=document.documentElement;a=c.scrollLeft+t+"px",o=c.scrollTop+r+"px"}else if(window.innerWidth)a=window.pageXOffset+(window.innerWidth-i)/2+"px",o=window.pageYOffset+(window.innerHeight-n)/2+"px";else{var c=document.documentElement;a=c.scrollLeft+(c.offsetWidth-i)/2+"px",o=c.scrollTop+(c.offsetHeight-n)/2+"px"}e.style.left=a,e.style.top=o}}(this.debugInfoDiv,o,s)}},CLOUD.OctantNeighborUtil=function(e,t){this.camera=e,this.root=t,this.searchNeighborOfNeighbor=!1,this.containChildOfNeighbor=!1,this.containedOctants=[],this.father=function(e){return e++,e<this.containedOctants.length?this.containedOctants[e]:null},this.adjFace=function(e,t){return i[8*e+t]},this.adjEdge=function(e,t){return n[8*e+t]},this.adjVertex=function(e,t){return e==t},this.refelectFace=function(e,t){return r[8*e+t]},this.refelectEdge=function(e,t){return a[8*e+t]},this.refelectVertex=function(e,t){return this.OctType.MAXTYPEID-t},this.common_face_edge=function(e,t){return o[8*e+t]},this.common_face_vertex=function(e,t){return s[8*e+t]},this.common_edge=function(e,t){return l[8*e+t]},this.son=function(e,t){var i,n=e.childOctants.length;for(i=0;i<n;i++)if(e.childOctants[i].octType==t)return e.childOctants[i];return null},this.FaceType={L:0,R:1,D:2,U:3,B:4,F:5,UNKNOWN:6},this.EdgeType={LD:0,LU:1,LB:2,LF:3,RD:4,RU:5,RB:6,RF:7,DB:8,DF:9,UB:10,UF:11,UNKNOWN:12},this.OctType={RUF:0,LUF:1,RDF:2,LDF:3,RUB:4,LUB:5,RDB:6,LDB:7,MAXTYPEID:7};var i=[!1,!0,!1,!0,!1,!0,!1,!0,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!0,!0,!1,!1,!0,!0,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!0,!0,!0,!0,!0,!0,!0,!0,!1,!1,!1,!1],n=[!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!0,!1,!1,!1,!0,!1,!0,!1,!1,!1,!0,!1,!1,!1,!1,!1,!1,!1,!0,!1,!0,!1,!0,!1,!0,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1,!1,!1,!0,!0,!1,!1,!0,!0,!1,!1,!1,!1,!1,!1],r=[1,0,3,2,5,4,7,6,1,0,3,2,5,4,7,6,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,4,5,6,7,0,1,2,3,4,5,6,7,0,1,2,3],a=[3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,3,2,1,0,7,6,5,4,3,2,1,0,7,6,5,4,5,4,7,6,1,0,3,2,5,4,7,6,1,0,3,2,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1,6,7,4,5,2,3,0,1],o=[6,0,2,6,6,0,2,6,3,6,6,0,3,6,6,0,6,0,6,0,4,6,4,6,5,6,5,6,6,0,6,0,1,6,6,2,1,6,6,2,6,3,1,6,6,3,1,6,1,6,1,6,6,4,6,4,6,5,6,5,1,6,1,6,6,6,2,2,4,4,6,6,5,5,6,6,6,6,2,2,3,3,6,6,6,6,4,4,6,6,5,5,3,3,6,6],s=[6,6,6,5,6,3,1,6,6,6,5,6,3,6,6,0,6,5,6,6,1,6,6,2,5,6,6,6,6,0,2,6,6,3,1,6,6,6,6,4,3,6,6,0,6,6,4,6,1,6,6,2,6,4,6,6,6,0,2,6,1,6,6,6],l=[12,11,7,12,5,12,12,12,11,12,12,3,12,1,12,12,7,12,12,9,12,12,4,12,12,3,9,12,12,12,12,0,5,12,12,12,12,10,6,12,12,1,12,12,10,12,12,2,12,12,4,12,6,12,12,8,12,12,12,0,12,2,8,12]},CLOUD.OctantNeighborUtil.prototype.findFaceNeighborImpl=function(e,t){var i={node:null,cont:!1},n=this.containedOctants,r=n[e];if(e>=n.length)return i;if(this.father(e)&&this.adjFace(t,r.octType)?i=this.findFaceNeighborImpl(e+1,t):(i.node=this.father(e),i.cont=!0),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectFace(t,r.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},CLOUD.OctantNeighborUtil.prototype.findFaceNeighbor=function(e,t){var i=this.findFaceNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},CLOUD.OctantNeighborUtil.prototype.findEdgeNeighborImpl=function(e,t){var i={node:null,cont:!1},n=this.containedOctants,r=n[e];if(e>=n.length)return i;if(this.father(e)&&(this.adjEdge(t,r.octType)?i=this.findEdgeNeighborImpl(e+1,t):this.common_face_edge(t,r.octType)!==this.FaceType.UNKNOWN?i=this.findFaceNeighborImpl(e+1,this.common_face_edge(t,r.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectEdge(t,r.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},CLOUD.OctantNeighborUtil.prototype.findEdgeNeighbor=function(e,t){var i=this.findEdgeNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},CLOUD.OctantNeighborUtil.prototype.findVertexNeighborImpl=function(e,t){var i={node:null,cont:!1},n=this.containedOctants,r=n[e];if(e>=n.length)return i;if(this.father(e)&&(this.adjVertex(t,r.octType)?i=this.findVertexNeighborImpl(e+1,t):this.common_edge(t,r.octType)!==this.EdgeType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_edge(t,r.octType)):this.common_face_vertex(t,r.octType)!=this.FaceType.UNKNOWN?i=this.findVertexNeighborImpl(e+1,this.common_face_vertex(t,r.octType)):(i.node=this.father(e),i.cont=!0)),i.cont&&null!==i.node&&i.node.childOctants.length>0){var a=this.son(i.node,this.refelectVertex(t,r.octType));return a?{node:a,cont:!0}:{node:i.node,cont:!1}}return i},CLOUD.OctantNeighborUtil.prototype.findVertexNeighbor=function(e,t){var i=this.findVertexNeighborImpl(e,t);return i.node&&!i.node.isRoot()?i.node:null},CLOUD.OctantNeighborUtil.prototype.findContainNode=function(e){var t,i=this.camera,n=i.position;if(!(n.x<e.min.x||n.x>e.max.x||n.y<e.min.y||n.y>e.max.y||n.z<e.min.z||n.z>e.max.z)){if(0!=e.childOctants.length){var r,a;for(r=0,a=e.childOctants.length;r<a&&(t=e.childOctants[r],!this.findContainNode(t));++r);}return this.containedOctants.push(e),!0}return!1},CLOUD.OctantNeighborUtil.prototype.findNeighborNode=function(){var e,t=this.searchNeighborOfNeighbor,i=this.containChildOfNeighbor,n=this.camera,r=this.containedOctants,a=this.OctType,o=this.EdgeType,s=[];if(0==r.length)return s;var l,c,u,h,d,f,p,m,g=n.frustum,v=r[0];p=v.min,m=v.max;var y=n.target,E=n.position,x=new THREE.Vector3(y.x-E.x,y.y-E.y,y.z-E.z),b=new THREE.Ray(E,x),C=[],M=new THREE.Box3(p,m),_=b.intersectBox(M);if(_&&(_.y==p.y||_.y==m.y?_.x<=m.x&&_.x>=p.x&&_.z<=m.z&&_.z>=p.z&&(_.y==p.y?C.push(2):C.push(3)):_.z==p.z||_.z==m.z?_.x<=m.x&&_.x>=p.x&&_.y<=m.y&&_.y>=p.y&&(_.z==p.z?C.push(4):C.push(5)):_.x!=p.x&&_.x!=m.x||_.z<=m.z&&_.z>=p.z&&_.y<=m.y&&_.y>=p.y&&(_.x==p.x?C.push(0):C.push(1))),0==C.length)return s;h=m.x-p.x,d=m.y-p.y,f=m.z-p.z,d>h&&(h=d),f>h&&(h=f);var w=h,L=new THREE.Vector3;for(l=0;l<6;l++)if(l!=C[0]){switch(L.copy(v.center),l){case 0:L.x-=w;break;case 1:L.x+=w;break;case 2:L.y-=w;break;case 3:L.y+=w;break;case 4:L.z-=w;break;case 5:L.z+=w}var T=w/2,I=new THREE.Box3(new THREE.Vector3(L.x-T,L.y-T,L.z-T),new THREE.Vector3(L.x+T,L.y+T,L.z+T));g.intersectsBox(I)&&C.push(l)}if(C.length>1&&C.sort(),C.length>2){var S=0;for(l=0;l<C.length;l++)for(c=l+1;c<C.length;c++)for(u=c+1;u<C.length;u++){if(1==C[l]&&3==C[c]&&5==C[u])S=a.RUF;else if(0==C[l]&&3==C[c]&&5==C[u])S=a.LUF;else if(1==C[l]&&2==C[c]&&5==C[u])S=a.RDF;else if(0==C[l]&&2==C[c]&&5==C[u])S=a.LDF;else if(1==C[l]&&3==C[c]&&4==C[u])S=a.RUB;else if(0==C[l]&&3==C[c]&&4==C[u])S=a.LUB;else if(1==C[l]&&2==C[c]&&4==C[u])S=a.RDB;else{if(0!=C[l]||2!=C[c]||4!=C[u])continue;S=a.LDB}e=this.findVertexNeighbor(0,S),e&&(s.push(e),i&&this.getChildOfOctant(e,2,S,s),t&&(e=this.getNeighborOfSecondLevel(e,2,S))&&s.push(e))}}if(C.length>1){var O=0;for(l=0;l<C.length;l++)for(c=l+1;c<C.length;c++){if(0==C[l]&&2==C[c])O=o.LD;else if(0==C[l]&&3==C[c])O=o.LU;else if(0==C[l]&&4==C[c])O=o.LB;else if(0==C[l]&&5==C[c])O=o.LF;else if(1==C[l]&&2==C[c])O=o.RD;else if(1==C[l]&&3==C[c])O=o.RU;else if(1==C[l]&&4==C[c])O=o.RB;else if(1==C[l]&&5==C[c])O=o.RF;else if(2==C[l]&&4==C[c])O=o.DB;else if(2==C[l]&&5==C[c])O=o.DF;else if(3==C[l]&&4==C[c])O=o.UB;else{if(3!=C[l]||5!=C[c])continue;O=o.UF}e=this.findEdgeNeighbor(0,O),e&&(s.push(e),i&&this.getChildOfOctant(e,1,O,s),t&&(e=this.getNeighborOfSecondLevel(e,1,O))&&s.push(e))}}for(l=0;l<C.length;l++)(e=this.findFaceNeighbor(0,C[l]))&&(s.push(e),i&&this.getChildOfOctant(e,0,C[l],s),t&&(e=this.getNeighborOfSecondLevel(e,0,C[l]))&&s.push(e));return s.sort(function(e,t){return e.octantId<t.octantId?-1:1}),s},CLOUD.OctantNeighborUtil.prototype.getChildOfOctant=function(e,t,i,n){if(!(0==e.childOctants.length||e.depth<4)){var r=this.FaceType,a=[];switch(t){case 0:a.push(i%2==0?i+1:i-1);break;case 1:var o=this.EdgeType;switch(i){case o.LD:a.push(r.R),a.push(r.U);break;case o.LU:a.push(r.R),a.push(r.D);break;case o.LB:a.push(r.R),a.push(r.F);break;case o.LF:a.push(r.R),a.push(r.B);break;case o.RD:a.push(r.L),a.push(r.U);break;case o.RU:a.push(r.L),a.push(r.D);break;case o.RB:a.push(r.L),a.push(r.F);break;case o.RF:a.push(r.L),a.push(r.B);break;case o.DB:a.push(r.U),a.push(r.F);break;case o.DF:a.push(r.U),a.push(r.B);break;case o.UB:a.push(r.D),a.push(r.F);break;case o.UF:a.push(r.D),a.push(r.B)}break;case 2:var s=this.OctType;switch(i){case s.RUF:a.push(r.L),a.push(r.D),a.push(r.B);break;case s.LUF:a.push(r.R),a.push(r.D),a.push(r.B);break;case s.RDF:a.push(r.L),a.push(r.U),a.push(r.B);break;case s.LDF:a.push(r.R),a.push(r.U),a.push(r.B);break;case s.RUB:a.push(r.L),a.push(r.D),a.push(r.F);break;case s.LUB:a.push(r.R),a.push(r.D),a.push(r.F);break;case s.RDB:a.push(r.L),a.push(r.U),a.push(r.F);break;case s.LDB:a.push(r.R),a.push(r.U),a.push(r.F)}}for(var l=0;l<a.length;l++)this.getFaceChildOfOctant(e,a[l],n)}},CLOUD.OctantNeighborUtil.prototype.getFaceChildOfOctant=function(e,t,i){for(var n,r,a=0,o=e.childOctants.length;a<o;a++)if(n=e.childOctants[a],this.adjFace(t,n.octType))i.push(n),this.getFaceChildOfOctant(n,t,i);else{r=this.refelectFace(t,n.octType);for(var s=0;s<o&&e.childOctants[s].octType!=r;s++);s==o&&(i.push(n),this.getFaceChildOfOctant(n,t,i))}},CLOUD.OctantNeighborUtil.prototype.getNeighborOfSecondLevel=function(e,t,i){var n=[],r=[],a=[];a[0]=e,this.getAncestorNodes(this.root,a,0,n,r);var o=new CLOUD.OctantNeighborUtil(this.camera,this.root);o.containedOctants=r;var s=null;switch(t){case 0:s=o.findFaceNeighbor(0,i);break;case 1:s=o.findEdgeNeighbor(0,i);break;case 2:s=o.findVertexNeighbor(0,i)}return s},CLOUD.OctantNeighborUtil.prototype.getAncestorAndNeighbors=function(){this.searchNeighborOfNeighbor=!0,this.containChildOfNeighbor=!0;var e=this.containedOctants;this.findContainNode(this.root);var t=this.findNeighborNode(this.camera,e),i=[],n=[];this.getAncestorNodes(this.root,t,0,i,n);var r,a,o={};for(r=0,a=e.length;r<a;r++)o[e[r].octantId]=1;for(r=0,a=t.length;r<a;r++)o[t[r].octantId]=1;for(r=0,a=n.length;r<a;r++)o[n[r].octantId]=1;return o},CLOUD.OctantNeighborUtil.prototype.getAncestorNodes=function(e,t,i,n,r){var a,o,s;for(a=0,o=e.childOctants.length;a<o&&i<t.length;a++){if(s=e.childOctants[a],n.push(s),s.octantId==t[i].octantId){for(var l=n.length-1;l>=0;l--)r.push(n[l]);i++}else(a==o-1||e.childOctants[a+1].octantId>t[i].octantId)&&(i=this.getAncestorNodes(s,t,i,n,r));n.pop()}return i},CLOUD.OctantNeighborUtil.prototype.outputOctants=function(e,t){console.group(),console.log("Node that contains camera: %d",t.octantId);var i="",n=0;for(var r in e)i+=r,i+="  ",n%9==0&&(i+="\n"),n++;console.log("nodes: %s",i),console.groupEnd()},CLOUD.OctantNeighborUtil.prototype.outputOctree=function(e,t){console.group();var i,n="";for(i=0;i<e.depth;i++)n+="  ";console.log("%sNode id: %i, depth: %i, octType: %i, parent: %i",n,e.octantId,e.depth,e.octType,t),console.log("%s  size: %f, center: %f, %f, %f",n,e.size,e.center.x,e.center.y,e.center.z),console.log("%s  child number: %i",n,e.childOctants.length);var r="";for(i=0;i<e.childOctants.length;i++)r+=e.childOctants[i].octantId,r+="  ";for(console.log("%s  children: %i",n,r),i=0;i<e.childOctants.length;i++)this.outputOctree(e.childOctants[i],e.octantId);console.groupEnd()},CLOUD.Edge=function(){this.vertexIndex=new Array(2),this.faceIndex=new Array(2)},CLOUD.RemoveDuplicateIndex=function(e,t){function i(e,t){var i=a[e],n=a[t];return i.x!=n.x?i.x-n.x:i.y!=n.y?i.y-n.y:i.z-n.z}function n(e,t){var n=i(e,t);return 0==n?e-t:n}for(var r=e.length/3,a=new Array(r),o=new Array(r),s=0;s<r;++s)a[s]=new THREE.Vector3(e[3*s],e[3*s+1],e[3*s+2]),o[s]=s;o.sort(n);for(var l={},c=o[0],s=1;s<r;++s)0==i(c,o[s])?l[o[s]]=c:c=o[s];for(var u=new Array(t.length),s=0;s<t.length;++s)l.hasOwnProperty(t[s])?u[s]=l[t[s]]:u[s]=t[s];return u},CLOUD.RemoveDuplicateVertex=function(e,t){function i(e,t){return e-t}var n=CLOUD.RemoveDuplicateIndex(e,t);n.sort(i);var r=new Array,a=n[0];r.push(a);for(var o=1;o<n.length;++o)n[o]!=a&&(a=n[o],r.push(a));return r.sort(i)},CLOUD.BuildEdge=function(e,t,i){i=void 0==i?Math.PI/4:i;for(var n=CLOUD.RemoveDuplicateIndex(e,t),r=n.length,a=e.length/3,o=new Array(a+r),s=a,l=n.length/3,c=0;c<a;++c)o[c]=-1;for(var u=new Array(r),h=0,c=0;c<l;++c)for(var d=n[3*c+2],f=0;f<3;++f){var p=!1,m=n[3*c+f];if(d>m){p=!0;var g=d;d=m,m=g}var v=new CLOUD.Edge;v.vertexIndex[0]=d,v.vertexIndex[1]=m,v.faceIndex[0]=c,v.faceIndex[1]=c;var y=o[d];if(-1==y)o[d]=h,u[h]=v,o[s+h]=-1,h++;else for(;;){var E=u[y];if(E.vertexIndex[1]==m){E.faceIndex[1]=c;break}var x=o[s+y];if(-1==x){o[s+y]=h,u[h]=v,o[s+h]=-1,h++;break}y=x}p||(d=m)}for(var b=[],c=0;c<h;++c){var E=u[c];if(E.faceIndex[0]==E.faceIndex[1])b.push(E.vertexIndex[0]),b.push(E.vertexIndex[1]);else{var C=E.faceIndex[0],M=n[3*C],_=n[3*C+1],w=n[3*C+2],L=new THREE.Vector3(e[3*M],e[3*M+1],e[3*M+2]),T=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),I=new THREE.Vector3(e[3*w],e[3*w+1],e[3*w+2]),S=L.sub(T),O=T.sub(I),D=S.cross(O);D.normalize();var R=E.faceIndex[1];M=n[3*R],_=n[3*R+1],w=n[3*R+2],L=new THREE.Vector3(e[3*M],e[3*M+1],e[3*M+2]),T=new THREE.Vector3(e[3*_],e[3*_+1],e[3*_+2]),I=new THREE.Vector3(e[3*w],e[3*w+1],e[3*w+2]),S=L.sub(T),O=T.sub(I);var A=S.cross(O);A.normalize(),Math.abs(D.dot(A))<i&&(b.push(E.vertexIndex[0]),b.push(E.vertexIndex[1]))}}return b},CLOUD.GetFaceIndex=function(e,t,i,n,r){for(var a=i.length/3,o=new Array,s=0;s<a;++s){var l=i[3*s],c=new THREE.Vector3(t[3*l],t[3*l+1],t[3*l+2]),u=c.dot(r);if(Math.abs(u-1)<.001){var h=new THREE.Vector3(e[3*l],e[3*l+1],e[3*l+2]),d=-h.dot(c),f=Math.abs(n.dot(c)+d);Math.abs(f)<3&&o.push(i[3*s],i[3*s+1],i[3*s+2])}}return o},function(e){function t(e,t){var i=(65535&e)+(65535&t);return(e>>16)+(t>>16)+(i>>16)<<16|65535&i}function i(e,t){return e<<t|e>>>32-t}function n(e,n,r,a,o,s){return t(i(t(t(n,e),t(a,s)),o),r)}function r(e,t,i,r,a,o,s){return n(t&i|~t&r,e,t,a,o,s)}function a(e,t,i,r,a,o,s){return n(t&r|i&~r,e,t,a,o,s)}function o(e,t,i,r,a,o,s){return n(t^i^r,e,t,a,o,s)}function s(e,t,i,r,a,o,s){return n(i^(t|~r),e,t,a,o,s)}function l(e,i){e[i>>5]|=128<<i%32,e[14+(i+64>>>9<<4)]=i;var n,l,c,u,h,d=1732584193,f=-271733879,p=-1732584194,m=271733878;for(n=0;n<e.length;n+=16)l=d,c=f,u=p,h=m,d=r(d,f,p,m,e[n],7,-680876936),m=r(m,d,f,p,e[n+1],12,-389564586),p=r(p,m,d,f,e[n+2],17,606105819),f=r(f,p,m,d,e[n+3],22,-1044525330),d=r(d,f,p,m,e[n+4],7,-176418897),m=r(m,d,f,p,e[n+5],12,1200080426),p=r(p,m,d,f,e[n+6],17,-1473231341),f=r(f,p,m,d,e[n+7],22,-45705983),d=r(d,f,p,m,e[n+8],7,1770035416),m=r(m,d,f,p,e[n+9],12,-1958414417),p=r(p,m,d,f,e[n+10],17,-42063),f=r(f,p,m,d,e[n+11],22,-1990404162),d=r(d,f,p,m,e[n+12],7,1804603682),m=r(m,d,f,p,e[n+13],12,-40341101),p=r(p,m,d,f,e[n+14],17,-1502002290),f=r(f,p,m,d,e[n+15],22,1236535329),d=a(d,f,p,m,e[n+1],5,-165796510),m=a(m,d,f,p,e[n+6],9,-1069501632),p=a(p,m,d,f,e[n+11],14,643717713),f=a(f,p,m,d,e[n],20,-373897302),d=a(d,f,p,m,e[n+5],5,-701558691),m=a(m,d,f,p,e[n+10],9,38016083),p=a(p,m,d,f,e[n+15],14,-660478335),f=a(f,p,m,d,e[n+4],20,-405537848),d=a(d,f,p,m,e[n+9],5,568446438),m=a(m,d,f,p,e[n+14],9,-1019803690),p=a(p,m,d,f,e[n+3],14,-187363961),f=a(f,p,m,d,e[n+8],20,1163531501),d=a(d,f,p,m,e[n+13],5,-1444681467),m=a(m,d,f,p,e[n+2],9,-51403784),p=a(p,m,d,f,e[n+7],14,1735328473),f=a(f,p,m,d,e[n+12],20,-1926607734),d=o(d,f,p,m,e[n+5],4,-378558),m=o(m,d,f,p,e[n+8],11,-2022574463),p=o(p,m,d,f,e[n+11],16,1839030562),f=o(f,p,m,d,e[n+14],23,-35309556),d=o(d,f,p,m,e[n+1],4,-1530992060),m=o(m,d,f,p,e[n+4],11,1272893353),p=o(p,m,d,f,e[n+7],16,-155497632),f=o(f,p,m,d,e[n+10],23,-1094730640),d=o(d,f,p,m,e[n+13],4,681279174),m=o(m,d,f,p,e[n],11,-358537222),p=o(p,m,d,f,e[n+3],16,-722521979),f=o(f,p,m,d,e[n+6],23,76029189),d=o(d,f,p,m,e[n+9],4,-640364487),m=o(m,d,f,p,e[n+12],11,-421815835),p=o(p,m,d,f,e[n+15],16,530742520),f=o(f,p,m,d,e[n+2],23,-995338651),d=s(d,f,p,m,e[n],6,-198630844),m=s(m,d,f,p,e[n+7],10,1126891415),p=s(p,m,d,f,e[n+14],15,-1416354905),f=s(f,p,m,d,e[n+5],21,-57434055),d=s(d,f,p,m,e[n+12],6,1700485571),m=s(m,d,f,p,e[n+3],10,-1894986606),p=s(p,m,d,f,e[n+10],15,-1051523),f=s(f,p,m,d,e[n+1],21,-2054922799),d=s(d,f,p,m,e[n+8],6,1873313359),m=s(m,d,f,p,e[n+15],10,-30611744),p=s(p,m,d,f,e[n+6],15,-1560198380),f=s(f,p,m,d,e[n+13],21,1309151649),d=s(d,f,p,m,e[n+4],6,-145523070),m=s(m,d,f,p,e[n+11],10,-1120210379),p=s(p,m,d,f,e[n+2],15,718787259),f=s(f,p,m,d,e[n+9],21,-343485551),d=t(d,l),f=t(f,c),p=t(p,u),m=t(m,h);return[d,f,p,m]}function c(e){var t,i="",n=32*e.length;for(t=0;t<n;t+=8)i+=String.fromCharCode(e[t>>5]>>>t%32&255);return i}function u(e){var t,i=[];for(i[(e.length>>2)-1]=void 0,t=0;t<i.length;t+=1)i[t]=0;var n=8*e.length;for(t=0;t<n;t+=8)i[t>>5]|=(255&e.charCodeAt(t/8))<<t%32;return i}function h(e){return c(l(u(e),8*e.length))}function d(e,t){var i,n,r=u(e),a=[],o=[];for(a[15]=o[15]=void 0,r.length>16&&(r=l(r,8*e.length)),i=0;i<16;i+=1)a[i]=909522486^r[i],o[i]=1549556828^r[i];return n=l(a.concat(u(t)),512+8*t.length),c(l(o.concat(n),640))}function f(e){var t,i,n="0123456789abcdef",r="";for(i=0;i<e.length;i+=1)t=e.charCodeAt(i),r+=n.charAt(t>>>4&15)+n.charAt(15&t);return r}function p(e){return unescape(encodeURIComponent(e))}function m(e){return h(p(e))}function g(e){return f(m(e))}function v(e,t){return d(p(e),p(t))}function y(e,t){return f(v(e,t))}function E(e,t,i){return t?i?v(t,e):y(t,e):i?m(e):g(e)}CLOUD.md5=E}(),THREE.SSAOShader={uniforms:{tDiffuse:{value:null},tDepth:{value:null},size:{value:new THREE.Vector2(512,512)},cameraNear:{value:1},cameraFar:{value:100},radius:{value:32},onlyAO:{value:0},aoClamp:{value:.25},lumInfluence:{value:.7}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),
fragmentShader:["uniform float cameraNear;","uniform float cameraFar;","#ifdef USE_LOGDEPTHBUF","uniform float logDepthBufFC;","#endif","uniform float radius;","uniform bool onlyAO;","uniform vec2 size;","uniform float aoClamp;","uniform float lumInfluence;","uniform sampler2D tDiffuse;","uniform sampler2D tDepth;","varying vec2 vUv;","#define DL 2.399963229728653","#define EULER 2.718281828459045","const int samples = 64;","const bool useNoise = true;","const float noiseAmount = 0.0004;","const float diffArea = 0.4;","const float gDisplace = 0.4;","#include <packing>","vec2 rand( const vec2 coord ) {","vec2 noise;","if ( useNoise ) {","float nx = dot ( coord, vec2( 12.9898, 78.233 ) );","float ny = dot ( coord, vec2( 12.9898, 78.233 ) * 2.0 );","noise = clamp( fract ( 43758.5453 * sin( vec2( nx, ny ) ) ), 0.0, 1.0 );","} else {","float ff = fract( 1.0 - coord.s * ( size.x / 2.0 ) );","float gg = fract( coord.t * ( size.y / 2.0 ) );","noise = vec2( 0.25, 0.75 ) * vec2( ff ) + vec2( 0.75, 0.25 ) * gg;","}","return ( noise * 2.0  - 1.0 ) * noiseAmount;","}","vec4 blurX( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x - 4.0 * s, uv.y ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x - 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x - 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x - 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x + 1.0 * s, uv.y ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x + 2.0 * s, uv.y ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x + 3.0 * s, uv.y ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x + 4.0 * s, uv.y ) ) * 0.051;","\treturn sum;","}","vec4 blurY( sampler2D texture, vec2 uv, float s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x, uv.y - 4.0 * s ) ) * 0.051;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y - 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.1633;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 1.0 * s ) ) * 0.1531;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 2.0 * s ) ) * 0.12245;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 3.0 * s ) ) * 0.0918;","\tsum += texture2D( texture, vec2( uv.x, uv.y + 4.0 * s ) ) * 0.051;","\treturn sum;","}","vec4 blur( sampler2D texture, vec2 uv, vec2 s ) {","\tvec4 sum = vec4( 0.0 );","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y + s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x, uv.y + s.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y + s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x, uv.y ) ) * 0.147761;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x - s.x, uv.y - s.y ) ) * 0.0947416;","\tsum += texture2D( texture, vec2( uv.x, uv.y - s.y ) ) * 0.118318;","\tsum += texture2D( texture, vec2( uv.x + s.x, uv.y - s.y ) ) * 0.0947416;","\treturn sum;","}","float readDepth( const in vec2 coord ) {","float cameraFarPlusNear = cameraFar + cameraNear;","float cameraFarMinusNear = cameraFar - cameraNear;","float cameraCoef = 2.0 * cameraNear;","vec4 depthColor = texture2D( tDepth, coord );","#ifdef USE_LOGDEPTHBUF","float logz = unpackRGBAToDepth( depthColor );","float w = pow(2.0, (logz / logDepthBufFC)) - 1.0;","float z = (logz / w) + 1.0;","#else","float z = unpackRGBAToDepth( depthColor );","#endif","return cameraCoef / ( cameraFarPlusNear - z * cameraFarMinusNear );","}","float compareDepths( const in float depth1, const in float depth2, inout int far ) {","float garea = 8.0;","float diff = ( depth1 - depth2 ) * 100.0;","if ( diff < gDisplace ) {","garea = diffArea;","} else {","far = 1;","}","float dd = diff - gDisplace;","float gauss = pow( EULER, -2.0 * ( dd * dd ) / ( garea * garea ) );","return gauss;","}","float calcAO( float depth, float dw, float dh ) {","vec2 vv = vec2( dw, dh );","vec2 coord1 = vUv + radius * vv;","vec2 coord2 = vUv - radius * vv;","float temp1 = 0.0;","float temp2 = 0.0;","int far = 0;","temp1 = compareDepths( depth, readDepth( coord1 ), far );","if ( far > 0 ) {","temp2 = compareDepths( readDepth( coord2 ), depth, far );","temp1 += ( 1.0 - temp1 ) * temp2;","}","return temp1;","}","void main() {","vec2 noise = rand( vUv );","float depth = readDepth( vUv );","float tt = clamp( depth, aoClamp, 1.0 );","float w = ( 1.0 / size.x ) / tt + ( noise.x * ( 1.0 - noise.x ) );","float h = ( 1.0 / size.y ) / tt + ( noise.y * ( 1.0 - noise.y ) );","float ao = 0.0;","float dz = 1.0 / float( samples );","float l = 0.0;","float z = 1.0 - dz / 2.0;","for ( int i = 0; i <= samples; i ++ ) {","float r = sqrt( 1.0 - z );","float pw = cos( l ) * r;","float ph = sin( l ) * r;","ao += calcAO( depth, pw * w, ph * h );","z = z - dz;","l = l + DL;","}","ao /= float( samples );","ao = 1.0 - ao;","vec4 color = texture2D( tDiffuse, vUv ).rgba;","vec3 lumcoeff = vec3( 0.299, 0.587, 0.114 );","float lum = dot( color.rgb, lumcoeff );","vec3 luminance = vec3( lum );","vec3 final = vec3( color.rgb * mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","if ( onlyAO ) {","final = vec3( mix( vec3( ao ), vec3( 1.0 ), luminance * lumInfluence ) );","}","gl_FragColor = vec4( final, color.a );","}"].join("\n")},THREE.CopyShader={uniforms:{tDiffuse:{value:null},opacity:{value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform float opacity;","uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","gl_FragColor = opacity * texel;","}"].join("\n")},THREE.FXAAShader={uniforms:{tDiffuse:{value:null},resolution:{value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),
fragmentShader:["precision highp float;","","uniform sampler2D tDiffuse;","","uniform vec2 resolution;","","varying vec2 vUv;","","// FXAA 3.11 implementation by NVIDIA, ported to WebGL by Agost Biro (biro@archilogic.com)","","//----------------------------------------------------------------------------------","// File:        es3-keplerFXAAassetsshaders/FXAA_DefaultES.frag","// SDK Version: v3.00","// Email:       gameworks@nvidia.com","// Site:        http://developer.nvidia.com/","//","// Copyright (c) 2014-2015, NVIDIA CORPORATION. All rights reserved.","//","// Redistribution and use in source and binary forms, with or without","// modification, are permitted provided that the following conditions","// are met:","//  * Redistributions of source code must retain the above copyright","//    notice, this list of conditions and the following disclaimer.","//  * Redistributions in binary form must reproduce the above copyright","//    notice, this list of conditions and the following disclaimer in the","//    documentation and/or other materials provided with the distribution.","//  * Neither the name of NVIDIA CORPORATION nor the names of its","//    contributors may be used to endorse or promote products derived","//    from this software without specific prior written permission.","//","// THIS SOFTWARE IS PROVIDED BY THE COPYRIGHT HOLDERS ``AS IS'' AND ANY","// EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED TO, THE","// IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR","// PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE COPYRIGHT OWNER OR","// CONTRIBUTORS BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL,","// EXEMPLARY, OR CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO,","// PROCUREMENT OF SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR","// PROFITS; OR BUSINESS INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY","// OF LIABILITY, WHETHER IN CONTRACT, STRICT LIABILITY, OR TORT","// (INCLUDING NEGLIGENCE OR OTHERWISE) ARISING IN ANY WAY OUT OF THE USE","// OF THIS SOFTWARE, EVEN IF ADVISED OF THE POSSIBILITY OF SUCH DAMAGE.","//","//----------------------------------------------------------------------------------","","#define FXAA_PC 1","#define FXAA_GLSL_100 1","#define FXAA_QUALITY_PRESET 12","","#define FXAA_GREEN_AS_LUMA 1","","/*--------------------------------------------------------------------------*/","#ifndef FXAA_PC_CONSOLE","    //","    // The console algorithm for PC is included","    // for developers targeting really low spec machines.","    // Likely better to just run FXAA_PC, and use a really low preset.","    //","    #define FXAA_PC_CONSOLE 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_120","    #define FXAA_GLSL_120 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GLSL_130","    #define FXAA_GLSL_130 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_3","    #define FXAA_HLSL_3 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_4","    #define FXAA_HLSL_4 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_HLSL_5","    #define FXAA_HLSL_5 0","#endif","/*==========================================================================*/","#ifndef FXAA_GREEN_AS_LUMA","    //","    // For those using non-linear color,","    // and either not able to get luma in alpha, or not wanting to,","    // this enables FXAA to run using green as a proxy for luma.","    // So with this enabled, no need to pack luma in alpha.","    //","    // This will turn off AA on anything which lacks some amount of green.","    // Pure red and blue or combination of only R and B, will get no AA.","    //","    // Might want to lower the settings for both,","    //    fxaaConsoleEdgeThresholdMin","    //    fxaaQualityEdgeThresholdMin","    // In order to insure AA does not get turned off on colors","    // which contain a minor amount of green.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_GREEN_AS_LUMA 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_EARLY_EXIT","    //","    // Controls algorithm's early exit path.","    // On PS3 turning this ON adds 2 cycles to the shader.","    // On 360 turning this OFF adds 10ths of a millisecond to the shader.","    // Turning this off on console will result in a more blurry image.","    // So this defaults to on.","    //","    // 1 = On.","    // 0 = Off.","    //","    #define FXAA_EARLY_EXIT 1","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_DISCARD","    //","    // Only valid for PC OpenGL currently.","    // Probably will not work when FXAA_GREEN_AS_LUMA = 1.","    //","    // 1 = Use discard on pixels which don't need AA.","    //     For APIs which enable concurrent TEX+ROP from same surface.","    // 0 = Return unchanged color on pixels which don't need AA.","    //","    #define FXAA_DISCARD 0","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_FAST_PIXEL_OFFSET","    //","    // Used for GLSL 120 only.","    //","    // 1 = GL API supports fast pixel offsets","    // 0 = do not use fast pixel offsets","    //","    #ifdef GL_EXT_gpu_shader4","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_FAST_PIXEL_OFFSET 1","    #endif","    #ifndef FXAA_FAST_PIXEL_OFFSET","        #define FXAA_FAST_PIXEL_OFFSET 0","    #endif","#endif","/*--------------------------------------------------------------------------*/","#ifndef FXAA_GATHER4_ALPHA","    //","    // 1 = API supports gather4 on alpha channel.","    // 0 = API does not support gather4 on alpha channel.","    //","    #if (FXAA_HLSL_5 == 1)","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_ARB_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifdef GL_NV_gpu_shader5","        #define FXAA_GATHER4_ALPHA 1","    #endif","    #ifndef FXAA_GATHER4_ALPHA","        #define FXAA_GATHER4_ALPHA 0","    #endif","#endif","","","/*============================================================================","                        FXAA QUALITY - TUNING KNOBS","------------------------------------------------------------------------------","NOTE the other tuning knobs are now in the shader function inputs!","============================================================================*/","#ifndef FXAA_QUALITY_PRESET","    //","    // Choose the quality preset.","    // This needs to be compiled into the shader as it effects code.","    // Best option to include multiple presets is to","    // in each shader define the preset, then include this file.","    //","    // OPTIONS","    // -----------------------------------------------------------------------","    // 10 to 15 - default medium dither (10=fastest, 15=highest quality)","    // 20 to 29 - less dither, more expensive (20=fastest, 29=highest quality)","    // 39       - no dither, very expensive","    //","    // NOTES","    // -----------------------------------------------------------------------","    // 12 = slightly faster then FXAA 3.9 and higher edge quality (default)","    // 13 = about same speed as FXAA 3.9 and better than 12","    // 23 = closest to FXAA 3.9 visually and performance wise","    //  _ = the lowest digit is directly related to performance","    // _  = the highest digit is directly related to style","    //","    #define FXAA_QUALITY_PRESET 12","#endif","","","/*============================================================================","","                           FXAA QUALITY - PRESETS","","============================================================================*/","","/*============================================================================","                     FXAA QUALITY - MEDIUM DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 10)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 3.0","    #define FXAA_QUALITY_P2 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 11)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 3.0","    #define FXAA_QUALITY_P3 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 12)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 4.0","    #define FXAA_QUALITY_P4 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 13)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 4.0","    #define FXAA_QUALITY_P5 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 14)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 4.0","    #define FXAA_QUALITY_P6 12.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 15)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 12.0","#endif","","/*============================================================================","                     FXAA QUALITY - LOW DITHER PRESETS","============================================================================*/","#if (FXAA_QUALITY_PRESET == 20)","    #define FXAA_QUALITY_PS 3","    #define FXAA_QUALITY_P0 1.5","    #define FXAA_QUALITY_P1 2.0","    #define FXAA_QUALITY_P2 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 21)","    #define FXAA_QUALITY_PS 4","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 22)","    #define FXAA_QUALITY_PS 5","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 23)","    #define FXAA_QUALITY_PS 6","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 24)","    #define FXAA_QUALITY_PS 7","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 3.0","    #define FXAA_QUALITY_P6 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 25)","    #define FXAA_QUALITY_PS 8","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 4.0","    #define FXAA_QUALITY_P7 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 26)","    #define FXAA_QUALITY_PS 9","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 4.0","    #define FXAA_QUALITY_P8 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 27)","    #define FXAA_QUALITY_PS 10","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 4.0","    #define FXAA_QUALITY_P9 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 28)","    #define FXAA_QUALITY_PS 11","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 4.0","    #define FXAA_QUALITY_P10 8.0","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_QUALITY_PRESET == 29)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.5","    #define FXAA_QUALITY_P2 2.0","    #define FXAA_QUALITY_P3 2.0","    #define FXAA_QUALITY_P4 2.0","    #define FXAA_QUALITY_P5 2.0","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","/*============================================================================","                     FXAA QUALITY - EXTREME QUALITY","============================================================================*/","#if (FXAA_QUALITY_PRESET == 39)","    #define FXAA_QUALITY_PS 12","    #define FXAA_QUALITY_P0 1.0","    #define FXAA_QUALITY_P1 1.0","    #define FXAA_QUALITY_P2 1.0","    #define FXAA_QUALITY_P3 1.0","    #define FXAA_QUALITY_P4 1.0","    #define FXAA_QUALITY_P5 1.5","    #define FXAA_QUALITY_P6 2.0","    #define FXAA_QUALITY_P7 2.0","    #define FXAA_QUALITY_P8 2.0","    #define FXAA_QUALITY_P9 2.0","    #define FXAA_QUALITY_P10 4.0","    #define FXAA_QUALITY_P11 8.0","#endif","","","","/*============================================================================","","                                API PORTING","","============================================================================*/","#if (FXAA_GLSL_100 == 1) || (FXAA_GLSL_120 == 1) || (FXAA_GLSL_130 == 1)","    #define FxaaBool bool","    #define FxaaDiscard discard","    #define FxaaFloat float","    #define FxaaFloat2 vec2","    #define FxaaFloat3 vec3","    #define FxaaFloat4 vec4","    #define FxaaHalf float","    #define FxaaHalf2 vec2","    #define FxaaHalf3 vec3","    #define FxaaHalf4 vec4","    #define FxaaInt2 ivec2","    #define FxaaSat(x) clamp(x, 0.0, 1.0)","    #define FxaaTex sampler2D","#else","    #define FxaaBool bool","    #define FxaaDiscard clip(-1)","    #define FxaaFloat float","    #define FxaaFloat2 float2","    #define FxaaFloat3 float3","    #define FxaaFloat4 float4","    #define FxaaHalf half","    #define FxaaHalf2 half2","    #define FxaaHalf3 half3","    #define FxaaHalf4 half4","    #define FxaaSat(x) saturate(x)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_100 == 1)","  #define FxaaTexTop(t, p) texture2D(t, p, 0.0)","  #define FxaaTexOff(t, p, o, r) texture2D(t, p + (o * r), 0.0)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_120 == 1)","    // Requires,","    //  #version 120","    // And at least,","    //  #extension GL_EXT_gpu_shader4 : enable","    //  (or set FXAA_FAST_PIXEL_OFFSET 1 to work like DX9)","    #define FxaaTexTop(t, p) texture2DLod(t, p, 0.0)","    #if (FXAA_FAST_PIXEL_OFFSET == 1)","        #define FxaaTexOff(t, p, o, r) texture2DLodOffset(t, p, 0.0, o)","    #else","        #define FxaaTexOff(t, p, o, r) texture2DLod(t, p + (o * r), 0.0)","    #endif","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_GLSL_130 == 1)",'    // Requires "#version 130" or better',"    #define FxaaTexTop(t, p) textureLod(t, p, 0.0)","    #define FxaaTexOff(t, p, o, r) textureLodOffset(t, p, 0.0, o)","    #if (FXAA_GATHER4_ALPHA == 1)","        // use #extension GL_ARB_gpu_shader5 : enable","        #define FxaaTexAlpha4(t, p) textureGather(t, p, 3)","        #define FxaaTexOffAlpha4(t, p, o) textureGatherOffset(t, p, o, 3)","        #define FxaaTexGreen4(t, p) textureGather(t, p, 1)","        #define FxaaTexOffGreen4(t, p, o) textureGatherOffset(t, p, o, 1)","    #endif","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_3 == 1)","    #define FxaaInt2 float2","    #define FxaaTex sampler2D","    #define FxaaTexTop(t, p) tex2Dlod(t, float4(p, 0.0, 0.0))","    #define FxaaTexOff(t, p, o, r) tex2Dlod(t, float4(p + (o * r), 0, 0))","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_4 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","#endif","/*--------------------------------------------------------------------------*/","#if (FXAA_HLSL_5 == 1)","    #define FxaaInt2 int2","    struct FxaaTex { SamplerState smpl; Texture2D tex; };","    #define FxaaTexTop(t, p) t.tex.SampleLevel(t.smpl, p, 0.0)","    #define FxaaTexOff(t, p, o, r) t.tex.SampleLevel(t.smpl, p, 0.0, o)","    #define FxaaTexAlpha4(t, p) t.tex.GatherAlpha(t.smpl, p)","    #define FxaaTexOffAlpha4(t, p, o) t.tex.GatherAlpha(t.smpl, p, o)","    #define FxaaTexGreen4(t, p) t.tex.GatherGreen(t.smpl, p)","    #define FxaaTexOffGreen4(t, p, o) t.tex.GatherGreen(t.smpl, p, o)","#endif","","","/*============================================================================","                   GREEN AS LUMA OPTION SUPPORT FUNCTION","============================================================================*/","#if (FXAA_GREEN_AS_LUMA == 0)","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.w; }","#else","    FxaaFloat FxaaLuma(FxaaFloat4 rgba) { return rgba.y; }","#endif","","","","","/*============================================================================","","                             FXAA3 QUALITY - PC","","============================================================================*/","#if (FXAA_PC == 1)","/*--------------------------------------------------------------------------*/","FxaaFloat4 FxaaPixelShader(","    //","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy} = center of pixel","    FxaaFloat2 pos,","    //","    // Used only for FXAA Console, and not used on the 360 version.","    // Use noperspective interpolation here (turn off perspective interpolation).","    // {xy_} = upper left of pixel","    // {_zw} = lower right of pixel","    FxaaFloat4 fxaaConsolePosPos,","    //","    // Input color texture.","    // {rgb_} = color in linear or perceptual color space","    // if (FXAA_GREEN_AS_LUMA == 0)","    //     {__a} = luma in perceptual color space (not linear)","    FxaaTex tex,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 2nd sampler.","    // This sampler needs to have an exponent bias of -1.","    FxaaTex fxaaConsole360TexExpBiasNegOne,","    //","    // Only used on the optimized 360 version of FXAA Console.",'    // For everything but 360, just use the same input here as for "tex".',"    // For 360, same texture, just alias with a 3nd sampler.","    // This sampler needs to have an exponent bias of -2.","    FxaaTex fxaaConsole360TexExpBiasNegTwo,","    //","    // Only used on FXAA Quality.","    // This must be from a constant/uniform.","    // {x_} = 1.0/screenWidthInPixels","    // {_y} = 1.0/screenHeightInPixels","    FxaaFloat2 fxaaQualityRcpFrame,","    //","    // Only used on FXAA Console.","    // This must be from a constant/uniform.","    // This effects sub-pixel AA quality and inversely sharpness.","    //   Where N ranges between,","    //     N = 0.50 (default)","    //     N = 0.33 (sharper)","    // {x__} = -N/screenWidthInPixels","    // {_y_} = -N/screenHeightInPixels","    // {_z_} =  N/screenWidthInPixels","    // {__w} =  N/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt,","    //","    // Only used on FXAA Console.","    // Not used on 360, but used on PS3 and PC.","    // This must be from a constant/uniform.","    // {x__} = -2.0/screenWidthInPixels","    // {_y_} = -2.0/screenHeightInPixels","    // {_z_} =  2.0/screenWidthInPixels","    // {__w} =  2.0/screenHeightInPixels","    FxaaFloat4 fxaaConsoleRcpFrameOpt2,","    //","    // Only used on FXAA Console.","    // Only used on 360 in place of fxaaConsoleRcpFrameOpt2.","    // This must be from a constant/uniform.","    // {x__} =  8.0/screenWidthInPixels","    // {_y_} =  8.0/screenHeightInPixels","    // {_z_} = -4.0/screenWidthInPixels","    // {__w} = -4.0/screenHeightInPixels","    FxaaFloat4 fxaaConsole360RcpFrameOpt2,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_SUBPIX define.","    // It is here now to allow easier tuning.","    // Choose the amount of sub-pixel aliasing removal.","    // This can effect sharpness.","    //   1.00 - upper limit (softer)","    //   0.75 - default amount of filtering","    //   0.50 - lower limit (sharper, less sub-pixel aliasing removal)","    //   0.25 - almost off","    //   0.00 - completely off","    FxaaFloat fxaaQualitySubpix,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // The minimum amount of local contrast required to apply algorithm.","    //   0.333 - too little (faster)","    //   0.250 - low quality","    //   0.166 - default","    //   0.125 - high quality","    //   0.063 - overkill (slower)","    FxaaFloat fxaaQualityEdgeThreshold,","    //","    // Only used on FXAA Quality.","    // This used to be the FXAA_QUALITY_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    //   0.0833 - upper limit (default, the start of visible unfiltered edges)","    //   0.0625 - high quality (faster)","    //   0.0312 - visible limit (slower)","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaQualityEdgeThresholdMin,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_SHARPNESS define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_SHARPNESS for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only three safe values here: 2 and 4 and 8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // For all other platforms can be a non-power of two.","    //   8.0 is sharper (default!!!)","    //   4.0 is softer","    //   2.0 is really soft (good only for vector graphics inputs)","    FxaaFloat fxaaConsoleEdgeSharpness,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD define.","    // It is here now to allow easier tuning.","    // This does not effect PS3, as this needs to be compiled in.","    //   Use FXAA_CONSOLE_PS3_EDGE_THRESHOLD for PS3.","    //   Due to the PS3 being ALU bound,","    //   there are only two safe values here: 1/4 and 1/8.","    //   These options use the shaders ability to a free *|/ by 2|4|8.","    // The console setting has a different mapping than the quality setting.","    // Other platforms can use other values.","    //   0.125 leaves less aliasing, but is softer (default!!!)","    //   0.25 leaves more aliasing, and is sharper","    FxaaFloat fxaaConsoleEdgeThreshold,","    //","    // Only used on FXAA Console.","    // This used to be the FXAA_CONSOLE_EDGE_THRESHOLD_MIN define.","    // It is here now to allow easier tuning.","    // Trims the algorithm from processing darks.","    // The console setting has a different mapping than the quality setting.","    // This only applies when FXAA_EARLY_EXIT is 1.","    // This does not apply to PS3,","    // PS3 was simplified to avoid more shader instructions.","    //   0.06 - faster but more aliasing in darks","    //   0.05 - default","    //   0.04 - slower and less aliasing in darks","    // Special notes when using FXAA_GREEN_AS_LUMA,","    //   Likely want to set this to zero.","    //   As colors that are mostly not-green","    //   will appear very dark in the green channel!","    //   Tune by looking at mostly non-green content,","    //   then start at zero and increase until aliasing is a problem.","    FxaaFloat fxaaConsoleEdgeThresholdMin,","    //","    // Extra constants for 360 FXAA Console only.","    // Use zeros or anything else for other platforms.","    // These must be in physical constant registers and NOT immediates.","    // Immediates will result in compiler un-optimizing.","    // {xyzw} = float4(1.0, -1.0, 0.25, -0.25)","    FxaaFloat4 fxaaConsole360ConstDir",") {","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posM;","    posM.x = pos.x;","    posM.y = pos.y;","    #if (FXAA_GATHER4_ALPHA == 1)","        #if (FXAA_DISCARD == 0)","            FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","            #if (FXAA_GREEN_AS_LUMA == 0)","                #define lumaM rgbyM.w","            #else","                #define lumaM rgbyM.y","            #endif","        #endif","        #if (FXAA_GREEN_AS_LUMA == 0)","            FxaaFloat4 luma4A = FxaaTexAlpha4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffAlpha4(tex, posM, FxaaInt2(-1, -1));","        #else","            FxaaFloat4 luma4A = FxaaTexGreen4(tex, posM);","            FxaaFloat4 luma4B = FxaaTexOffGreen4(tex, posM, FxaaInt2(-1, -1));","        #endif","        #if (FXAA_DISCARD == 1)","            #define lumaM luma4A.w","        #endif","        #define lumaE luma4A.z","        #define lumaS luma4A.x","        #define lumaSE luma4A.y","        #define lumaNW luma4B.w","        #define lumaN luma4B.z","        #define lumaW luma4B.x","    #else","        FxaaFloat4 rgbyM = FxaaTexTop(tex, posM);","        #if (FXAA_GREEN_AS_LUMA == 0)","            #define lumaM rgbyM.w","        #else","            #define lumaM rgbyM.y","        #endif","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 0.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 0.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 0.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaS = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaN = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 0,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 0), fxaaQualityRcpFrame.xy));","        #endif","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat maxSM = max(lumaS, lumaM);","    FxaaFloat minSM = min(lumaS, lumaM);","    FxaaFloat maxESM = max(lumaE, maxSM);","    FxaaFloat minESM = min(lumaE, minSM);","    FxaaFloat maxWN = max(lumaN, lumaW);","    FxaaFloat minWN = min(lumaN, lumaW);","    FxaaFloat rangeMax = max(maxWN, maxESM);","    FxaaFloat rangeMin = min(minWN, minESM);","    FxaaFloat rangeMaxScaled = rangeMax * fxaaQualityEdgeThreshold;","    FxaaFloat range = rangeMax - rangeMin;","    FxaaFloat rangeMaxClamped = max(fxaaQualityEdgeThresholdMin, rangeMaxScaled);","    FxaaBool earlyExit = range < rangeMaxClamped;","/*--------------------------------------------------------------------------*/","    if(earlyExit)","        #if (FXAA_DISCARD == 1)","            FxaaDiscard;","        #else","            return rgbyM;","        #endif","/*--------------------------------------------------------------------------*/","    #if (FXAA_GATHER4_ALPHA == 0)","        #if (FXAA_GLSL_100 == 1)","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0, 1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2( 1.0,-1.0), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaFloat2(-1.0, 1.0), fxaaQualityRcpFrame.xy));","        #else","          FxaaFloat lumaNW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1, 1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2( 1,-1), fxaaQualityRcpFrame.xy));","          FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","        #endif","    #else","        FxaaFloat lumaNE = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(1, -1), fxaaQualityRcpFrame.xy));","        FxaaFloat lumaSW = FxaaLuma(FxaaTexOff(tex, posM, FxaaInt2(-1, 1), fxaaQualityRcpFrame.xy));","    #endif","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNS = lumaN + lumaS;","    FxaaFloat lumaWE = lumaW + lumaE;","    FxaaFloat subpixRcpRange = 1.0/range;","    FxaaFloat subpixNSWE = lumaNS + lumaWE;","    FxaaFloat edgeHorz1 = (-2.0 * lumaM) + lumaNS;","    FxaaFloat edgeVert1 = (-2.0 * lumaM) + lumaWE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNESE = lumaNE + lumaSE;","    FxaaFloat lumaNWNE = lumaNW + lumaNE;","    FxaaFloat edgeHorz2 = (-2.0 * lumaE) + lumaNESE;","    FxaaFloat edgeVert2 = (-2.0 * lumaN) + lumaNWNE;","/*--------------------------------------------------------------------------*/","    FxaaFloat lumaNWSW = lumaNW + lumaSW;","    FxaaFloat lumaSWSE = lumaSW + lumaSE;","    FxaaFloat edgeHorz4 = (abs(edgeHorz1) * 2.0) + abs(edgeHorz2);","    FxaaFloat edgeVert4 = (abs(edgeVert1) * 2.0) + abs(edgeVert2);","    FxaaFloat edgeHorz3 = (-2.0 * lumaW) + lumaNWSW;","    FxaaFloat edgeVert3 = (-2.0 * lumaS) + lumaSWSE;","    FxaaFloat edgeHorz = abs(edgeHorz3) + edgeHorz4;","    FxaaFloat edgeVert = abs(edgeVert3) + edgeVert4;","/*--------------------------------------------------------------------------*/","    FxaaFloat subpixNWSWNESE = lumaNWSW + lumaNESE;","    FxaaFloat lengthSign = fxaaQualityRcpFrame.x;","    FxaaBool horzSpan = edgeHorz >= edgeVert;","    FxaaFloat subpixA = subpixNSWE * 2.0 + subpixNWSWNESE;","/*--------------------------------------------------------------------------*/","    if(!horzSpan) lumaN = lumaW;","    if(!horzSpan) lumaS = lumaE;","    if(horzSpan) lengthSign = fxaaQualityRcpFrame.y;","    FxaaFloat subpixB = (subpixA * (1.0/12.0)) - lumaM;","/*--------------------------------------------------------------------------*/","    FxaaFloat gradientN = lumaN - lumaM;","    FxaaFloat gradientS = lumaS - lumaM;","    FxaaFloat lumaNN = lumaN + lumaM;","    FxaaFloat lumaSS = lumaS + lumaM;","    FxaaBool pairN = abs(gradientN) >= abs(gradientS);","    FxaaFloat gradient = max(abs(gradientN), abs(gradientS));","    if(pairN) lengthSign = -lengthSign;","    FxaaFloat subpixC = FxaaSat(abs(subpixB) * subpixRcpRange);","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posB;","    posB.x = posM.x;","    posB.y = posM.y;","    FxaaFloat2 offNP;","    offNP.x = (!horzSpan) ? 0.0 : fxaaQualityRcpFrame.x;","    offNP.y = ( horzSpan) ? 0.0 : fxaaQualityRcpFrame.y;","    if(!horzSpan) posB.x += lengthSign * 0.5;","    if( horzSpan) posB.y += lengthSign * 0.5;","/*--------------------------------------------------------------------------*/","    FxaaFloat2 posN;","    posN.x = posB.x - offNP.x * FXAA_QUALITY_P0;","    posN.y = posB.y - offNP.y * FXAA_QUALITY_P0;","    FxaaFloat2 posP;","    posP.x = posB.x + offNP.x * FXAA_QUALITY_P0;","    posP.y = posB.y + offNP.y * FXAA_QUALITY_P0;","    FxaaFloat subpixD = ((-2.0)*subpixC) + 3.0;","    FxaaFloat lumaEndN = FxaaLuma(FxaaTexTop(tex, posN));","    FxaaFloat subpixE = subpixC * subpixC;","    FxaaFloat lumaEndP = FxaaLuma(FxaaTexTop(tex, posP));","/*--------------------------------------------------------------------------*/","    if(!pairN) lumaNN = lumaSS;","    FxaaFloat gradientScaled = gradient * 1.0/4.0;","    FxaaFloat lumaMM = lumaM - lumaNN * 0.5;","    FxaaFloat subpixF = subpixD * subpixE;","    FxaaBool lumaMLTZero = lumaMM < 0.0;","/*--------------------------------------------------------------------------*/","    lumaEndN -= lumaNN * 0.5;","    lumaEndP -= lumaNN * 0.5;","    FxaaBool doneN = abs(lumaEndN) >= gradientScaled;","    FxaaBool doneP = abs(lumaEndP) >= gradientScaled;","    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P1;","    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P1;","    FxaaBool doneNP = (!doneN) || (!doneP);","    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P1;","    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P1;","/*--------------------------------------------------------------------------*/","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P2;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P2;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P2;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P2;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 3)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P3;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P3;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P3;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P3;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 4)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P4;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P4;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P4;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P4;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 5)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P5;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P5;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P5;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P5;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 6)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P6;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P6;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P6;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P6;","/*--------------------------------------------------------------------------*/","                        #if (FXAA_QUALITY_PS > 7)","                        if(doneNP) {","                            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                            doneN = abs(lumaEndN) >= gradientScaled;","                            doneP = abs(lumaEndP) >= gradientScaled;","                            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P7;","                            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P7;","                            doneNP = (!doneN) || (!doneP);","                            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P7;","                            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P7;","/*--------------------------------------------------------------------------*/","    #if (FXAA_QUALITY_PS > 8)","    if(doneNP) {","        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","        doneN = abs(lumaEndN) >= gradientScaled;","        doneP = abs(lumaEndP) >= gradientScaled;","        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P8;","        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P8;","        doneNP = (!doneN) || (!doneP);","        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P8;","        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P8;","/*--------------------------------------------------------------------------*/","        #if (FXAA_QUALITY_PS > 9)","        if(doneNP) {","            if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","            if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","            if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","            if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","            doneN = abs(lumaEndN) >= gradientScaled;","            doneP = abs(lumaEndP) >= gradientScaled;","            if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P9;","            if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P9;","            doneNP = (!doneN) || (!doneP);","            if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P9;","            if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P9;","/*--------------------------------------------------------------------------*/","            #if (FXAA_QUALITY_PS > 10)","            if(doneNP) {","                if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                doneN = abs(lumaEndN) >= gradientScaled;","                doneP = abs(lumaEndP) >= gradientScaled;","                if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P10;","                if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P10;","                doneNP = (!doneN) || (!doneP);","                if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P10;","                if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P10;","/*--------------------------------------------------------------------------*/","                #if (FXAA_QUALITY_PS > 11)","                if(doneNP) {","                    if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                    if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                    if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                    if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                    doneN = abs(lumaEndN) >= gradientScaled;","                    doneP = abs(lumaEndP) >= gradientScaled;","                    if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P11;","                    if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P11;","                    doneNP = (!doneN) || (!doneP);","                    if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P11;","                    if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P11;","/*--------------------------------------------------------------------------*/","                    #if (FXAA_QUALITY_PS > 12)","                    if(doneNP) {","                        if(!doneN) lumaEndN = FxaaLuma(FxaaTexTop(tex, posN.xy));","                        if(!doneP) lumaEndP = FxaaLuma(FxaaTexTop(tex, posP.xy));","                        if(!doneN) lumaEndN = lumaEndN - lumaNN * 0.5;","                        if(!doneP) lumaEndP = lumaEndP - lumaNN * 0.5;","                        doneN = abs(lumaEndN) >= gradientScaled;","                        doneP = abs(lumaEndP) >= gradientScaled;","                        if(!doneN) posN.x -= offNP.x * FXAA_QUALITY_P12;","                        if(!doneN) posN.y -= offNP.y * FXAA_QUALITY_P12;","                        doneNP = (!doneN) || (!doneP);","                        if(!doneP) posP.x += offNP.x * FXAA_QUALITY_P12;","                        if(!doneP) posP.y += offNP.y * FXAA_QUALITY_P12;","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","    #endif","/*--------------------------------------------------------------------------*/","                        }","                        #endif","/*--------------------------------------------------------------------------*/","                    }","                    #endif","/*--------------------------------------------------------------------------*/","                }","                #endif","/*--------------------------------------------------------------------------*/","            }","            #endif","/*--------------------------------------------------------------------------*/","        }","        #endif","/*--------------------------------------------------------------------------*/","    }","/*--------------------------------------------------------------------------*/","    FxaaFloat dstN = posM.x - posN.x;","    FxaaFloat dstP = posP.x - posM.x;","    if(!horzSpan) dstN = posM.y - posN.y;","    if(!horzSpan) dstP = posP.y - posM.y;","/*--------------------------------------------------------------------------*/","    FxaaBool goodSpanN = (lumaEndN < 0.0) != lumaMLTZero;","    FxaaFloat spanLength = (dstP + dstN);","    FxaaBool goodSpanP = (lumaEndP < 0.0) != lumaMLTZero;","    FxaaFloat spanLengthRcp = 1.0/spanLength;","/*--------------------------------------------------------------------------*/","    FxaaBool directionN = dstN < dstP;","    FxaaFloat dst = min(dstN, dstP);","    FxaaBool goodSpan = directionN ? goodSpanN : goodSpanP;","    FxaaFloat subpixG = subpixF * subpixF;","    FxaaFloat pixelOffset = (dst * (-spanLengthRcp)) + 0.5;","    FxaaFloat subpixH = subpixG * fxaaQualitySubpix;","/*--------------------------------------------------------------------------*/","    FxaaFloat pixelOffsetGood = goodSpan ? pixelOffset : 0.0;","    FxaaFloat pixelOffsetSubpix = max(pixelOffsetGood, subpixH);","    if(!horzSpan) posM.x += pixelOffsetSubpix * lengthSign;","    if( horzSpan) posM.y += pixelOffsetSubpix * lengthSign;","    #if (FXAA_DISCARD == 1)","        return FxaaTexTop(tex, posM);","    #else","        return FxaaFloat4(FxaaTexTop(tex, posM).xyz, lumaM);","    #endif","}","/*==========================================================================*/","#endif","","void main() {","  gl_FragColor = FxaaPixelShader(","    vUv,","    vec4(0.0),","    tDiffuse,","    tDiffuse,","    tDiffuse,","    resolution,","    vec4(0.0),","    vec4(0.0),","    vec4(0.0),","    0.75,","    0.166,","    0.0833,","    0.0,","    0.0,","    0.0,","    vec4(0.0)","  );","","  // TODO avoid querying texture twice for same texel","  gl_FragColor.a = texture2D(tDiffuse, vUv).a;","}"].join("\n")
},THREE.EffectComposer=function(e,t){if(this.renderer=e,void 0===t){var i={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1},n=e.getSize();t=new THREE.WebGLRenderTarget(n.width,n.height,i),t.texture.name="EffectComposer.rt1"}this.renderTarget1=t,this.renderTarget2=t.clone(),this.renderTarget2.texture.name="EffectComposer.rt2",this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2,this.passes=[],void 0===THREE.CopyShader&&console.error("THREE.EffectComposer relies on THREE.CopyShader"),this.copyPass=new THREE.ShaderPass(THREE.CopyShader)},Object.assign(THREE.EffectComposer.prototype,{swapBuffers:function(){var e=this.readBuffer;this.readBuffer=this.writeBuffer,this.writeBuffer=e},addPass:function(e){this.passes.push(e);var t=this.renderer.getSize();e.setSize(t.width,t.height)},insertPass:function(e,t){this.passes.splice(t,0,e)},render:function(e){var t,i,n=!1,r=this.passes.length;for(i=0;i<r;i++)if(t=this.passes[i],!1!==t.enabled){if(t.render(this.renderer,this.writeBuffer,this.readBuffer,e,n),t.needsSwap){if(n){var a=this.renderer.context;a.stencilFunc(a.NOTEQUAL,1,4294967295),this.copyPass.render(this.renderer,this.writeBuffer,this.readBuffer,e),a.stencilFunc(a.EQUAL,1,4294967295)}this.swapBuffers()}void 0!==THREE.MaskPass&&(t instanceof THREE.MaskPass?n=!0:t instanceof THREE.ClearMaskPass&&(n=!1))}},reset:function(e){if(void 0===e){var t=this.renderer.getSize();e=this.renderTarget1.clone(),e.setSize(t.width,t.height)}this.renderTarget1.dispose(),this.renderTarget2.dispose(),this.renderTarget1=e,this.renderTarget2=e.clone(),this.writeBuffer=this.renderTarget1,this.readBuffer=this.renderTarget2},setSize:function(e,t){this.renderTarget1.setSize(e,t),this.renderTarget2.setSize(e,t);for(var i=0;i<this.passes.length;i++)this.passes[i].setSize(e,t)}}),THREE.Pass=function(){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1},Object.assign(THREE.Pass.prototype,{setSize:function(e,t){},render:function(e,t,i,n,r){console.error("THREE.Pass: .render() must be implemented in derived pass.")}}),THREE.ShaderPass=function(e,t){THREE.Pass.call(this),this.textureID=void 0!==t?t:"tDiffuse",e instanceof THREE.ShaderMaterial?(this.uniforms=e.uniforms,this.material=e):e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},THREE.ShaderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.ShaderPass,render:function(e,t,i,n,r){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}}),THREE.SSAOPass=function(e,t,i,n){if(void 0===THREE.SSAOShader)return console.warn("THREE.SSAOPass depends on THREE.SSAOShader"),new THREE.ShaderPass;THREE.ShaderPass.call(this,THREE.SSAOShader),this.width=void 0!==i?i:512,this.height=void 0!==n?n:256,this.renderToScreen=!1,this.camera2=t,this.scene2=e,this.depthMaterial=new THREE.MeshDepthMaterial,this.depthMaterial.depthPacking=THREE.RGBADepthPacking,this.depthMaterial.blending=THREE.NoBlending,this.depthRenderTarget=new THREE.WebGLRenderTarget(this.width,this.height,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter}),this.uniforms.tDepth.value=this.depthRenderTarget.texture,this.uniforms.size.value.set(this.width,this.height),this.uniforms.cameraNear.value=this.camera2.near,this.uniforms.cameraFar.value=this.camera2.far,this.uniforms.radius.value=4,this.uniforms.onlyAO.value=!1,this.uniforms.aoClamp.value=.25,this.uniforms.lumInfluence.value=.7,Object.defineProperties(this,{radius:{get:function(){return this.uniforms.radius.value},set:function(e){this.uniforms.radius.value=e}},onlyAO:{get:function(){return this.uniforms.onlyAO.value},set:function(e){this.uniforms.onlyAO.value=e}},aoClamp:{get:function(){return this.uniforms.aoClamp.value},set:function(e){this.uniforms.aoClamp.value=e}},lumInfluence:{get:function(){return this.uniforms.lumInfluence.value},set:function(e){this.uniforms.lumInfluence.value=e}}})},THREE.SSAOPass.prototype=Object.create(THREE.ShaderPass.prototype),THREE.SSAOPass.prototype.render=function(e,t,i,n,r){this.scene2.overrideMaterial=this.depthMaterial,e.render(this.scene2,this.camera2,this.depthRenderTarget,!0),this.scene2.overrideMaterial=null,THREE.ShaderPass.prototype.render.call(this,e,t,i,n,r)},THREE.SSAOPass.prototype.setScene=function(e){this.scene2=e},THREE.SSAOPass.prototype.setCamera=function(e){this.camera2=e,this.uniforms.cameraNear.value=this.camera2.near,this.uniforms.cameraFar.value=this.camera2.far},THREE.SSAOPass.prototype.setSize=function(e,t){this.width=e,this.height=t,this.uniforms.size.value.set(this.width,this.height),this.depthRenderTarget.setSize(this.width,this.height)},THREE.RenderPass=function(e,t,i,n,r){THREE.Pass.call(this),this.scene=e,this.camera=t,this.overrideMaterial=i,this.clearColor=n,this.clearAlpha=void 0!==r?r:0,this.clear=!0,this.clearDepth=!1,this.needsSwap=!1},THREE.RenderPass.prototype=Object.assign(Object.create(THREE.Pass.prototype),{constructor:THREE.RenderPass,render:function(e,t,i,n,r){var a=e.autoClear;e.autoClear=!1,this.scene.overrideMaterial=this.overrideMaterial;var o,s;this.clearColor&&(o=e.getClearColor().getHex(),s=e.getClearAlpha(),e.setClearColor(this.clearColor,this.clearAlpha)),this.clearDepth&&e.clearDepth(),e.render(this.scene,this.camera,this.renderToScreen?null:i,this.clear),this.clearColor&&e.setClearColor(o,s),this.scene.overrideMaterial=null,e.autoClear=a}}),function(){var e=function(e){function t(e,i,n,r,a){_classCallCheck(this,t);var o=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));o.modelManager=i,o.renderScene=n,o.renderCamera=r,o.selectedObjectIds=void 0!==a?a:[],o.defaultEdgeColor=(new THREE.Color).setHex(7733223),o.defaultEdgeAlpha=.95,o.edgeColor=new THREE.Vector4(o.defaultEdgeColor.r,o.defaultEdgeColor.g,o.defaultEdgeColor.b,o.defaultEdgeAlpha),o.edgeLength=2,o.resolution=void 0!==e?new THREE.Vector2(e.x,e.y):new THREE.Vector2(256,256);var s={minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat};o.renderTargetDepthBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetDepthBuffer.texture.name="OutlinePass.depth",o.renderTargetDepthBuffer.texture.generateMipmaps=!1,o.renderTargetMaskBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetMaskBuffer.texture.name="OutlinePass.mask",o.renderTargetMaskBuffer.texture.generateMipmaps=!1,o.renderTargetMaskDownSampleBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetMaskDownSampleBuffer.texture.name="OutlinePass.depthDownSample",o.renderTargetMaskDownSampleBuffer.texture.generateMipmaps=!1,o.renderTargetEdgeBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetEdgeBuffer.texture.name="OutlinePass.edge",o.renderTargetEdgeBuffer.texture.generateMipmaps=!1,o.renderTargetColorBuffer=new THREE.WebGLRenderTarget(o.resolution.x,o.resolution.y,s),o.renderTargetColorBuffer.texture.name="OutlinePass.color",o.renderTargetColorBuffer.texture.generateMipmaps=!1,o.depthMaterial=new THREE.MeshDepthMaterial,o.depthMaterial.side=THREE.DoubleSide,o.depthMaterial.depthPacking=THREE.RGBADepthPacking,o.depthMaterial.blending=THREE.NoBlending,o.InstancedDepthMaterial=new CLOUD.InstancedDepthMaterial,o.InstancedDepthMaterial.side=THREE.DoubleSide,o.InstancedDepthMaterial.depthPacking=THREE.RGBADepthPacking,o.InstancedDepthMaterial.blending=THREE.NoBlending,o.prepareMaskMaterial=o.getPrepareMaskMaterial(),o.prepareMaskMaterial.side=THREE.DoubleSide,o.prepareMaskInstancedMaterial=o.getPrepareMaskInstancedMaterial(),o.prepareMaskInstancedMaterial.side=THREE.DoubleSide,o.edgeDetectionMaterial=o.getEdgeDetectionMaterial(),o.overlayMaterial=o.getOverlayMaterial(),void 0===THREE.CopyShader&&console.error("CLOUD.OutlinePass relies on THREE.CopyShader");var l=THREE.CopyShader;return o.copyUniforms=THREE.UniformsUtils.clone(l.uniforms),o.copyUniforms.opacity.value=1,o.materialCopy=new THREE.ShaderMaterial({uniforms:o.copyUniforms,vertexShader:l.vertexShader,fragmentShader:l.fragmentShader,blending:THREE.NoBlending,depthTest:!1,depthWrite:!1,transparent:!0}),o.enabled=!0,o.needsSwap=!1,o.oldClearColor=new THREE.Color,o.oldClearAlpha=1,o.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),o.scene=new THREE.Scene,o.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),o.quad.frustumCulled=!1,o.scene.add(o.quad),o.textureMatrix=new THREE.Matrix4,o}return _inherits(t,e),_createClass(t,[{key:"dispose",value:function(){this.renderTargetDepthBuffer.dispose(),this.renderTargetMaskBuffer.dispose(),this.renderTargetMaskDownSampleBuffer.dispose(),this.renderTargetEdgeBuffer.dispose(),this.renderTargetColorBuffer.dispose()}},{key:"setSize",value:function(e,t){this.renderTargetDepthBuffer.setSize(e,t),this.renderTargetMaskBuffer.setSize(e,t),this.renderTargetMaskDownSampleBuffer.setSize(e,t),this.renderTargetEdgeBuffer.setSize(e,t),this.renderTargetColorBuffer.setSize(e,t)}},{key:"adjustVisibility",value:function(e){this.modelManager.adjustVisibility(e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){this.modelManager.changeVisibilityOfSelectedObjects(e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){this.modelManager.changeVisibilityOfNonSelectedObjects(e)}},{key:"adjustInstanceVisibility",value:function(e){this.modelManager.adjustInstanceVisibility(e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){this.modelManager.changeInstanceVisibilityOfSelectedObjects(e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){this.modelManager.changeInstanceVisibilityOfNonSelectedObjects(e)}},{key:"restoreVisibilityOfObjects",value:function(){this.modelManager.restoreVisibilityOfObjects()}},{key:"updateTextureMatrix",value:function(){this.textureMatrix.set(.5,0,0,.5,0,.5,0,.5,0,0,.5,.5,0,0,0,1),this.textureMatrix.multiply(this.renderCamera.projectionMatrix),this.textureMatrix.multiply(this.renderCamera.matrixWorldInverse)}},{key:"render",value:function(e,t,i,n,r){if(0!==this.selectedObjectIds.length){this.oldClearColor.copy(e.getClearColor()),this.oldClearAlpha=e.getClearAlpha();var a=e.autoClear;e.autoClear=!1,r&&e.context.disable(e.context.STENCIL_TEST),e.setClearColor(0,0),this.adjustInstanceVisibility(!1),this.changeVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.depthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfSelectedObjects(!1),this.renderScene.overrideMaterial=this.InstancedDepthMaterial,e.render(this.renderScene,this.renderCamera,this.renderTargetDepthBuffer,!1),this.adjustVisibility(!0),this.changeInstanceVisibilityOfSelectedObjects(!0),this.updateTextureMatrix(),this.adjustInstanceVisibility(!1),this.changeVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskMaterial,this.prepareMaskMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!0),this.adjustInstanceVisibility(!0),this.changeVisibilityOfNonSelectedObjects(!0),this.adjustVisibility(!1),this.changeInstanceVisibilityOfNonSelectedObjects(!1),this.renderScene.overrideMaterial=this.prepareMaskInstancedMaterial,this.prepareMaskInstancedMaterial.uniforms.cameraNearFar.value=new THREE.Vector2(this.renderCamera.near,this.renderCamera.far),this.prepareMaskInstancedMaterial.uniforms.depthTexture.value=this.renderTargetDepthBuffer.texture,this.prepareMaskInstancedMaterial.uniforms.textureMatrix.value=this.textureMatrix,e.render(this.renderScene,this.renderCamera,this.renderTargetMaskBuffer,!1),this.renderScene.overrideMaterial=null,this.adjustVisibility(!0),this.changeInstanceVisibilityOfNonSelectedObjects(!0),this.restoreVisibilityOfObjects(),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetMaskBuffer.texture,e.render(this.scene,this.camera,this.renderTargetMaskDownSampleBuffer,!0),this.quad.material=this.edgeDetectionMaterial,this.edgeDetectionMaterial.uniforms.maskTexture.value=this.renderTargetMaskDownSampleBuffer.texture,this.edgeDetectionMaterial.uniforms.texSize.value=new THREE.Vector2(this.renderTargetMaskDownSampleBuffer.width,this.renderTargetMaskDownSampleBuffer.height),this.edgeDetectionMaterial.uniforms.edgeColor.value=this.edgeColor,this.edgeDetectionMaterial.uniforms.edgeLength.value=this.edgeLength,e.render(this.scene,this.camera,this.renderTargetEdgeBuffer,!0),this.quad.material=this.overlayMaterial,this.overlayMaterial.uniforms.colorTexture.value=i.texture,this.overlayMaterial.uniforms.outlineTexture.value=this.renderTargetEdgeBuffer.texture,e.render(this.scene,this.camera,this.renderTargetColorBuffer,!0),this.quad.material=this.materialCopy,this.copyUniforms.tDiffuse.value=this.renderTargetColorBuffer.texture,r&&e.context.enable(e.context.STENCIL_TEST),e.render(this.scene,this.camera,i,!0),e.setClearColor(this.oldClearColor,this.oldClearAlpha),e.autoClear=a}}},{key:"getPrepareMaskMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vec4( position, 1.0 );\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                #include <packing>\n\t\t\t\tvarying vec2 vUv;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tuniform sampler2D depthTexture;\n\t\t\t\tuniform vec2 cameraNearFar;\n\t\t\t\t\n\t\t\t\tfloat linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tfloat depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = vec4(depth);\n\t\t\t\t}"})}},{key:"getPrepareMaskInstancedMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{depthTexture:{value:null},cameraNearFar:{value:new THREE.Vector2(.5,.5)},textureMatrix:{value:new THREE.Matrix4}},vertexShader:"\n                attribute float vState;            \n                attribute vec4 aColor;            \n                attribute vec3 mcol0;\n                attribute vec3 mcol1;\n                attribute vec3 mcol2;\n                attribute vec3 mcol3;\n                #if defined(USE_MAP)\n                    attribute vec2 muvCol0;\n                    attribute vec2 muvCol1;\n                    attribute vec2 muvCol2;\n                #endif\n                \n                varying float vfState;\n                varying vec2 vUv;\n\t\t\t\tvarying vec4 projTexCoord;\n\t\t\t\tvarying vec4 vPosition;\n\t\t\t\tuniform mat4 textureMatrix;\n\t\t\t\t\n\t\t\t\tvec3 getInstancePosition(vec3 position) {\n                    return vec3(mat4(vec4(mcol0, 0.0),\n                                     vec4(mcol1, 0.0),\n                                     vec4(mcol2, 0.0),\n                                     vec4(mcol3, 1.0)) * vec4(position, 1.0));\n                }\n                \n                vec2 getInstanceUV(vec2 uv) {\n                \n                    #if defined(USE_MAP)\n                        return vec2(mat3(vec3(muvCol0, 0.0),\n                                         vec3(muvCol1, 0.0), \n                                         vec3(muvCol2, 1.0)) * vec3(uv, 1.0));\n                    #else\n                        return uv;\n                    #endif                    \n                    \n                }\n            \n\t\t\t\tvoid main() {\n\t\t\t\t    vfState = vState;\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tvPosition = vec4(getInstancePosition(position), 1.0);\n\t\t\t\t\tvec4 worldPosition = modelMatrix * vPosition;\n\t\t\t\t\tprojTexCoord = textureMatrix * worldPosition;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vPosition;\n\t\t\t\t}",fragmentShader:"#include <packing>\n                varying float vfState;\n                varying vec2 vUv;\n                varying vec4 vPosition;\n                varying vec4 projTexCoord;\n                uniform sampler2D depthTexture;\n                uniform vec2 cameraNearFar;\n                \n                float linearDepth(float depth)\n                {\n                    float far = cameraNearFar.y;\n                    float near = cameraNearFar.x;\n                    return (2.0 * near) / (far + near - depth * (far - near));\n                }\n                \n                void main() {\n                    if (vfState <= -0.99 && vfState >= -1.01) discard;\n                    float depth = unpackRGBAToDepth(texture2DProj( depthTexture, projTexCoord ));\n                    gl_FragColor = vec4(depth);\n                }"})}},{key:"getEdgeDetectionMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{maskTexture:{value:null},texSize:{value:new THREE.Vector2(.5,.5)},edgeColor:{value:new THREE.Vector4(1,1,1,1)},edgeLength:{value:2}},vertexShader:"\n                varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"\n                varying vec2 vUv;\n\t\t\t\tuniform sampler2D maskTexture;\n\t\t\t\tuniform vec2 texSize;\n\t\t\t\tuniform vec4 edgeColor;\n                uniform float edgeLength; \n                \n                void main(void)\n                {\n                    float directions[3];\n                    directions[0] = -1.0;\n                    directions[1] = 0.0;\n                    directions[2] = 1.0;\n                \n                    float scalars[3];\n                    scalars[0] = 3.0;\n                    scalars[1] = 10.0;\n                    scalars[2] = 3.0;\n                \n                    float padx = 1.0 / texSize.x;\n                    float pady = 1.0 / texSize.y ; \n                \n                    float edgeSize  = 0.0; \n                    float horizEdge = 0.0;\n                    float vertEdge = 0.0;                    \n                \n                    for (int i = 0; i < 3; ++i)\n                    {\n                        float dir = directions[i];\n                        float scale = scalars[i];\n                \n                        horizEdge -= texture2D(maskTexture, vUv + vec2(-padx, dir * pady)).x * scale;\n                        horizEdge += texture2D(maskTexture, vUv + vec2(padx, dir * pady)).x * scale;\n                \n                        vertEdge -= texture2D(maskTexture, vUv + vec2(dir * padx, -pady)).x * scale;\n                        vertEdge += texture2D(maskTexture, vUv + vec2(dir * padx, pady)).x * scale;\n                    }                    \n                  \n                    float len = sqrt(horizEdge * horizEdge + vertEdge * vertEdge);    \n                    float alpha = len > edgeLength ? edgeColor.a : (texture2D(maskTexture, vUv).w > 0.1 ? 0.1 : 0.0);\n                    gl_FragColor = vec4(edgeColor.rgb, alpha);\n                }"})}},{key:"getOverlayMaterial",value:function(){return new THREE.ShaderMaterial({uniforms:{colorTexture:{value:null},outlineTexture:{value:null}},vertexShader:"varying vec2 vUv;\n\t\t\t\tvoid main() {\n\t\t\t\t\tvUv = uv;\n\t\t\t\t\tgl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );\n\t\t\t\t}",fragmentShader:"varying vec2 vUv;\n\t\t\t\tuniform sampler2D colorTexture;\n\t\t\t\tuniform sampler2D outlineTexture;\n\t\t\t\t\n\t\t\t\tvoid main() {\n\t\t\t\t\tvec4 outlineColor = texture2D(outlineTexture, vUv);\t\t\t\t\t\n\t\t\t\t\tgl_FragColor = mix(texture2D(colorTexture, vUv), outlineColor, outlineColor.a);\t\t\t\t\t\n\t\t\t\t}",blending:THREE.AdditiveBlending,depthTest:!1,depthWrite:!1,transparent:!0})}},{key:"setOutlineEdgeColor",value:function(e){var t=CLOUD.Utils.hexToRgb(e.color);this.edgeColor.fromArray([t.r,t.g,t.b,e.opacity?e.opacity:1])}}]),t}(THREE.Pass);CLOUD.OutlinePass=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.renderer=t,this.composer=null,this.renderPass=null,this.outlinePass=null,this.effectFXAA=null,this.selectedObjectIds=[]}return _createClass(e,[{key:"destroy",value:function(){this.renderer=null,this.composer=null,this.renderPass.dispose(),this.renderPass=null,this.outlinePass.dispose(),this.outlinePass=null,this.effectFXAA=null,this.selectedObjectIds=null}},{key:"init",value:function(e,t,i,n,r){this.composer=new THREE.EffectComposer(this.renderer),this.renderPass=new THREE.RenderPass(t,i),this.composer.addPass(this.renderPass),this.outlinePass=new CLOUD.OutlinePass(new THREE.Vector2(n,r),e,t,i),this.composer.addPass(this.outlinePass),this.effectFXAA=new THREE.ShaderPass(THREE.FXAAShader),this.effectFXAA.uniforms.resolution.value.set(1/n,1/r),this.effectFXAA.renderToScreen=!0,this.composer.addPass(this.effectFXAA)}},{key:"render",value:function(){this.composer.render()}},{key:"setSize",value:function(e,t){this.composer.setSize(e,t),this.effectFXAA.uniforms.resolution.value.set(1/e,1/t)}},{key:"addSelectedId",value:function(e){this.selectedObjectIds.push(e)}},{key:"clearSelectedIds",value:function(){this.selectedObjectIds.length=0}},{key:"setSelectedIds",value:function(e){if(this.outlinePass){this.clearSelectedIds();for(var t=0,i=e.length;t<i;t++)this.addSelectedId(e[t]);this.outlinePass.selectedObjectIds=this.selectedObjectIds}}},{key:"setOutlineEdgeColor",value:function(e){this.outlinePass.setOutlineEdgeColor(e)}}]),e}();CLOUD.RenderEffectComposer=e}(),CLOUD.RenderGroup=function(){function e(e,t){return e.material.id!==t.material.id?e.material.id-t.material.id:e.id-t.id}function t(e,t){return e.z!==t.z?t.z-e.z:e.id-t.id}function i(e,t,i,n,r,a){u=Date.now();for(var o=t.length,l=s;l<o;l++){var c=t[l],f=c.object,p=c.material,m=c.group,g=c.geometry;if(f.modelViewMatrix.multiplyMatrices(i.matrixWorldInverse,f.matrixWorld),f.normalMatrix.getNormalMatrix(f.modelViewMatrix),g=e.updateObject(f),e.renderBufferDirect(i,r,g,p,f,m),h=Date.now(),(d=h-u)>CLOUD.GlobalData.LimitFrameTime)return s=l+1,!1}return s=0,!0}var n=[],r=[],a=-1,o=-1,s=0,l=!1,c=!1,u=0,h=0,d=0;this.getOpaqueObjects=function(){return n},this.getTransparentObjects=function(){return r},this.destroy=function(){n=[],r=[]},this.restart=function(){s=0,l=!1,c=!1},this.prepare=function(){this.restart(),a=-1,o=-1},this.renderableCount=function(){return a+o},this.pushRenderItem=function(e,t,i,s,l){var c,u;i.transparent?(c=r,u=++o):(c=n,u=++a);var h=c[u];void 0!==h?(h.id=e.id,h.object=e,h.geometry=t,h.material=i,h.z=s,h.group=l):(h={id:e.id,object:e,geometry:t,material:i,z:s,group:l},c[u]=h)},this.sortRenderList=function(i){n.length=a+1,r.length=o+1,i&&(n.sort(e),r.sort(t))},this.renderOpaqueObjects=function(e,t,r,a,o){return l||(l=i(e,n,t,r,a,o)),l},this.renderTransparentObjects=function(e,t,n,a,o){return c||(c=i(e,r,t,n,a,o)),c}},CLOUD.OrderedRenderer=function(){function e(){++s>1e5&&(s=0);for(var e=0,t=d.length;e<t;++e){var i=d[e];void 0!==i&&i.prepare()}}function t(e,t,i,n){var r=d[e.renderOrder];void 0===r&&(r=new CLOUD.RenderGroup,d[e.renderOrder]=r),r.pushRenderItem(e,t,i,n,null)}function i(){for(var e=0,t=d.length;e<t;++e){var i=d[e];void 0!==i&&i.sortRenderList(l)}}function n(e,i){if(!1===e.visible||!1===e.alive)return!0;if(e._cullTicket!=s){if(Date.now()-u>30)return!1;if(e._cullTicket=s,(e.isMesh||e.isLine||e.isPoints)&&(!1===e.frustumCulled||!0===f.intersectsObject(e))){var r=e.material,a=e.geometry;if(m.setFromMatrixPosition(e.matrixWorld),m.applyMatrix4(p),Array.isArray(r))for(var o=a.groups,l=0,c=o.length;l<c;l++){var h=o[l],d=r[h.materialIndex];r.transparent?t(e,a,d,m.z):t(e,a,d,0)}else r.transparent?t(e,a,r,m.z):t(e,a,r,0)}}var g=e.children;if(g)for(var l=0,c=g.length;l<c;l++)if(!n(g[l],i))return!1;return!0}function r(e,t){t.length=0;for(var i=e.children,n=0,r=i.length;n<r;n++){var a=i[n];a.isLight&&t.push(a)}}function a(t,a,o){if(!g)return void(l=!0);l&&(e(),r(t,o)),u=Date.now(),l=n(t,a),i()}function o(){g&&!v||++h,h>1e4&&(h=0)}var s=0,l=!1,c=!1,u=0,h=0,d=[],f=null,p=null,m=new THREE.Vector3,g=!0,v=!0;this.updateObjectList=function(e){g=e},this.destroy=function(){for(var e=0,t=d.length;e<t;++e){var i=d[e];void 0!==i&&i.destroy()}},this.restart=function(){for(var e=0,t=d.length;e<t;++e){var i=d[e];void 0!==i&&i.restart()}v=!0,l=!0},this.setFilter=function(e){},this.update=function(e,t){p=t,f=e},this.render=function(e,t,i,n,r,s,u){if(o(),v){if(CLOUD.Logger.time("build object list"),a(t,i,n),CLOUD.Logger.timeEnd("build object list"),!l)return!1;s=!0,v=!1,e.setupLights(n,i),e.setRenderTarget(r)}CLOUD.Logger.time("increment render object"),(e.autoClear||s)&&e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil,g);var f=t.fog;e.setRenderTicket(h),u.setBlending(THREE.NoBlending);for(var p=d.length-1;p>=0;--p){var m=d[p];if(void 0!==m&&!(c=m.renderOpaqueObjects(e,i,n,f,g)))break}if(c)for(var p=d.length-1;p>=0;--p){var m=d[p];if(void 0!==m&&!(c=m.renderTransparentObjects(e,i,n,f)))break}return u.buffers.depth.setTest(!0),u.buffers.depth.setMask(!0),u.buffers.color.setMask(!0),CLOUD.Logger.timeEnd("increment render object"),c}},CLOUD.RenderComposer=function(){function e(){function e(e){e.material.blending=THREE.NoBlending,e.material.depthWrite=!1,e.material.depthTest=!1}r=new CLOUD.ShaderPass(FXAAShader),e(r),a=new CLOUD.ShaderPass(CopyShader),e(a)}var t,i,n,r,a,o,s,l=null,c=null,u=!1,h=!0,d=!1;this.init=function(i,n,r){if(e(),!i)return void console.log("You need a gl context to make a renderer. Things will go downhill from here.");o=n,s=r,t=i,this.setSize(n,r,!0)},this.cleanup=function(){l&&(l.dispose(),l=null),c&&(c.dispose(),c=null)},this.setSize=function(e,i,n){if(o=e,s=i,0===e&&0===i||!t)return void this.cleanup();var a=0|e*t.getPixelRatio(),u=0|i*t.getPixelRatio(),h=1/a,d=1/u;!n&&l&&l.width==a&&l.height==u||(this.cleanup(),l=new THREE.WebGLRenderTarget(a,u,{minFilter:THREE.LinearFilter,magFilter:THREE.LinearFilter,format:THREE.RGBAFormat,stencilBuffer:!1}),l.texture.generateMipmaps=!1,l.texture.name="_color_rt1",c=l.clone(),c.texture.name="_write_rt1"),r.uniforms.uResolution.value.set(h,d)},this.renderIncrement=function(e,r){if(!l&&o)this.setSize();else if(!l&&!o)return;return CLOUD.GlobalData.SSAO&&!n&&(n=new THREE.SSAOPass(e,r,o,s)),i=r,h&&(d||(t.resetIncrementRender(),t.setClearColor(0,0),t.clearTarget(l,!0,!0,!1)),h=!1),t.autoClear=!1,u||(u=t.render(e,i,l))&&(a.renderToScreen=!0,t.resetIncrementRender(),a.render(t,null,l)),u},this.render=function(e,r){if(!l&&o)this.setSize();else if(!l&&!o)return;var c=CLOUD.GlobalData.SSAO;c&&!n&&(n=new THREE.SSAOPass(e,r,o,s)),i=r,h&&(d||(t.setClearColor(0,0),t.clearTarget(l,!0,!0,!1)),h=!1),t.autoClear=!1,d||t.render(e,i,l);var u=c?n:a;u.renderToScreen=!0,u.render(t,null,l)},this.restart=function(e,t){d=!!e,u=!1,h=!0},this.finish=function(){}},CLOUD._renderComposer=new CLOUD.RenderComposer,CLOUD.ShaderPass=function(e,t){this.enabled=!0,this.needsSwap=!0,this.clear=!1,this.renderToScreen=!1,this.textureID=void 0!==t?t:"tDiffuse",e&&(this.uniforms=THREE.UniformsUtils.clone(e.uniforms),this.material=new THREE.ShaderMaterial({defines:e.defines||{},uniforms:this.uniforms,vertexShader:e.vertexShader,fragmentShader:e.fragmentShader})),this.camera=new THREE.OrthographicCamera(-1,1,1,-1,0,1),this.scene=new THREE.Scene,this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2),null),this.quad.frustumCulled=!1,this.scene.add(this.quad)},CLOUD.ShaderPass.prototype={constructor:CLOUD.ShaderPass,render:function(e,t,i,n){this.uniforms[this.textureID]&&(this.uniforms[this.textureID].value=i.texture),this.quad.material=this.material,this.renderToScreen?e.render(this.scene,this.camera):e.render(this.scene,this.camera,t,this.clear)}};var CopyShader={uniforms:{tDiffuse:{value:null}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","varying vec2 vUv;","void main() {","gl_FragColor = texture2D(tDiffuse, vUv);","}"].join("\n")},HighlightShader={uniforms:{tDiffuse:{type:"t",value:null},tID:{type:"t",value:null},objID:{type:"i",value:0},objIDv3:{type:"v3",value:new THREE.Vector3(0,0,0)},highlightIntensity:{type:"f",value:1}},vertexShader:["varying vec2 vUv;","void main() {","vUv = uv;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),fragmentShader:["uniform sampler2D tDiffuse;","uniform sampler2D tID;","uniform int objID;","uniform vec3 objIDv3;","uniform float highlightIntensity;","varying vec2 vUv;","void main() {","vec4 texel = texture2D( tDiffuse, vUv );","if (objID != 0) {","vec4 idAtPixel = texture2D(tID, vUv);","vec3 idDelta = abs(idAtPixel.rgb - objIDv3.rgb);","if (max(max(idDelta.r, idDelta.g), idDelta.b) < 1e-3) {","texel.rgb += highlightIntensity * 0.2;","}","}","gl_FragColor = texel;","}"].join("\n")},FXAAShader={uniforms:{tDiffuse:{type:"t",value:null},uResolution:{type:"v2",value:new THREE.Vector2(1/1024,1/512)}},vertexShader:["uniform vec2 uResolution;","varying vec2 vPos;","varying vec4 vPosPos;","void main() {","vPos = uv;","vPosPos.xy = uv + vec2(-0.5, -0.5) * uResolution;","vPosPos.zw = uv + vec2( 0.5,  0.5) * uResolution;","gl_Position = projectionMatrix * modelViewMatrix * vec4( position, 1.0 );","}"].join("\n"),
fragmentShader:["#define FXAA_EDGE_SHARPNESS (8.0)","#define FXAA_EDGE_THRESHOLD (0.125)","#define FXAA_EDGE_THRESHOLD_MIN (0.05)","#define FXAA_RCP_FRAME_OPT (0.50)","#define FXAA_RCP_FRAME_OPT2 (2.0)","uniform sampler2D tDiffuse;","uniform highp vec2 uResolution;","varying vec2 vPos;","varying vec4 vPosPos;","float FxaaLuma(vec3 rgb) {","return dot(rgb, vec3(0.299, 0.587, 0.114));","}","void main() {","float lumaNw = FxaaLuma(texture2D(tDiffuse, vPosPos.xy).rgb);","float lumaSw = FxaaLuma(texture2D(tDiffuse, vPosPos.xw).rgb);","float lumaNe = FxaaLuma(texture2D(tDiffuse, vPosPos.zy).rgb) + 1.0/384.0;","float lumaSe = FxaaLuma(texture2D(tDiffuse, vPosPos.zw).rgb);","vec3 rgbM = texture2D(tDiffuse, vPos.xy).rgb;","float lumaM = FxaaLuma(rgbM.rgb);","float lumaMax = max(max(lumaNe, lumaSe), max(lumaNw, lumaSw));","float lumaMin = min(min(lumaNe, lumaSe), min(lumaNw, lumaSw));","float lumaMaxSubMinM = max(lumaMax, lumaM) - min(lumaMin, lumaM);","float lumaMaxScaledClamped = max(FXAA_EDGE_THRESHOLD_MIN, lumaMax * FXAA_EDGE_THRESHOLD);","if (lumaMaxSubMinM < lumaMaxScaledClamped) {","   gl_FragColor = rgbM;","   return;","}","float dirSwMinusNe = lumaSw - lumaNe;","float dirSeMinusNw = lumaSe - lumaNw;","vec2 dir1 = normalize(vec2(dirSwMinusNe + dirSeMinusNw, dirSwMinusNe - dirSeMinusNw));","vec3 rgbN1 = texture2D(tDiffuse, vPos.xy - dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;","vec3 rgbP1 = texture2D(tDiffuse, vPos.xy + dir1 * FXAA_RCP_FRAME_OPT*uResolution).rgb;","float dirAbsMinTimesC = min(abs(dir1.x), abs(dir1.y)) * FXAA_EDGE_SHARPNESS;","vec2 dir2 = clamp(dir1.xy / dirAbsMinTimesC, -2.0, 2.0);","vec3 rgbN2 = texture2D(tDiffuse, vPos.xy - dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;","vec3 rgbP2 = texture2D(tDiffuse, vPos.xy + dir2 * FXAA_RCP_FRAME_OPT2*uResolution).rgb;","vec3 rgbA = rgbN1 + rgbP1;","vec3 rgbB = ((rgbN2 + rgbP2) * 0.25) + (rgbA * 0.25);","float lumaB = FxaaLuma(rgbB);","if ((lumaB < lumaMin) || (lumaB > lumaMax))","   gl_FragColor = vec4(rgbA * 0.5, rgbM.a);","else","   gl_FragColor = vec4(rgbB, rgbM.a);","}"].join("\n")};CLOUD.CombinedCamera=function(e,t){THREE.Camera.call(this),this.target=new THREE.Vector3,this.name=t.name||"",this.near=t.near,this.far=t.far,e===CLOUD.CAMERATYPE.PERSPECTIVE?(this.aspect=t.width/t.height,this.fov=t.fov,this.left=-t.width/2,this.right=t.width/2,this.top=t.height/2,this.bottom=-t.height/2,this.perspectiveCamera=new THREE.PerspectiveCamera(this.fov,this.aspect,this.near,this.far),this.orthoCamera=null,this.toPerspective()):(this.left=t.left,this.right=t.right,this.top=t.top,this.bottom=t.bottom,this.fov=45,this.aspect=(this.right-this.left)/(this.top-this.bottom),this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far),this.perspectiveCamera=null,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1),this.zoom=t.zoom||1},CLOUD.CombinedCamera.prototype=Object.create(THREE.Camera.prototype),CLOUD.CombinedCamera.prototype.constructor=CLOUD.CombinedCamera,CLOUD.CombinedCamera.prototype.toPerspective=function(){if(null===this.perspectiveCamera)return void console.log("Can not convert to perspective camera because the camera original type is orthographic.");this.perspectiveCamera.aspect=this.aspect,this.perspectiveCamera.near=this.near,this.perspectiveCamera.far=this.far,this.perspectiveCamera.fov=this.fov,this.perspectiveCamera.updateProjectionMatrix(),this.projectionMatrix=this.perspectiveCamera.projectionMatrix,this.isPerspective=!0,this.dirty=!0},CLOUD.CombinedCamera.prototype.toOrthographic=function(){null===this.orthoCamera&&(this.orthoCamera=new THREE.OrthographicCamera(this.left,this.right,this.top,this.bottom,this.near,this.far));var e=this.fov,t=this.target.clone().sub(this.position).length(),i=Math.tan(e*Math.PI/180/2)*t,n=i*this.aspect;i/=this.zoom,n/=this.zoom,this.left=this.orthoCamera.left=-n,this.right=this.orthoCamera.right=n,this.top=this.orthoCamera.top=i,this.bottom=this.orthoCamera.bottom=-i,this.orthoCamera.near=this.near,this.orthoCamera.far=this.far,this.orthoCamera.updateProjectionMatrix(),this.projectionMatrix=this.orthoCamera.projectionMatrix,this.isPerspective=!1,this.dirty=!0},CLOUD.CombinedCamera.prototype.setSize=function(e,t){this.left=-e/2,this.right=e/2,this.top=t/2,this.bottom=-t/2,this.aspect=e/t,this.dirty=!0},CLOUD.CombinedCamera.prototype.setFov=function(e){this.fov=e,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.setNearFar=function(e,t){this.near=e,this.far=t,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.updateProjectionMatrix=function(){this.isPerspective?this.toPerspective():this.toOrthographic()},CLOUD.CombinedCamera.prototype.setLens=function(e,t){void 0===t&&(t=24);var i=2*THREE.Math.radToDeg(Math.atan(t/(2*e)));return this.setFov(i),this.dirty=!0,i},CLOUD.CombinedCamera.prototype.setZoom=function(e){this.zoom=e,this.dirty=!0,this.updateProjectionMatrix()},CLOUD.CombinedCamera.prototype.copy=function(e){THREE.Camera.prototype.copy.call(this,e),this.target.copy(e.target),this.aspect=e.aspect,this.fov=e.fov,this.near=e.near,this.far=e.far,this.left=e.left,this.right=e.right,this.top=e.top,this.bottom=e.bottom,this.zoom=e.zoom,this.isPerspective=e.isPerspective,this.orthoCamera.copy(e.orthoCamera),this.perspectiveCamera.copy(e.perspectiveCamera)},CLOUD.Camera=function(e,t){CLOUD.CombinedCamera.call(this,e,t),this.realUp=this.up.clone(),this.dirty=!1,this.orthoScale=1,this.positionPlane=new THREE.Plane,this.projScreenMatrix=new THREE.Matrix4,this.viewProjInverse=new THREE.Matrix4,this.frustum=new THREE.Frustum},CLOUD.Camera.prototype=Object.create(CLOUD.CombinedCamera.prototype),CLOUD.Camera.prototype.constructor=CLOUD.Camera,CLOUD.Camera.prototype._updatePositionPlane=function(){this.positionPlane.setFromNormalAndCoplanarPoint(this.getWorldDirection(),this.position)},CLOUD.Camera.prototype._updateFrustum=function(){this.frustum.setFromMatrix(this.projScreenMatrix)},CLOUD.Camera.prototype.updateMVP=function(){this.dirty&&(null===this.parent&&this.updateMatrixWorld(),this.matrixWorldInverse.getInverse(this.matrixWorld),this.projScreenMatrix.multiplyMatrices(this.projectionMatrix,this.matrixWorldInverse),this.viewProjInverse.getInverse(this.projScreenMatrix),this._updateFrustum(),this._updatePositionPlane(),this.dirty=!1)},CLOUD.Camera.prototype.getFrustum=function(){return this.dirty&&this.updateMVP(),this.frustum},CLOUD.Camera.prototype.LookAt=function(e,t,i,n){var r=new THREE.Vector3;r.copy(t),void 0!==n&&r.setLength(n),this.position.subVectors(e,r),this.up=i,this.lookAt(e),this.realUp=i.clone(),this.target=e.clone(),this.dirty=!0},CLOUD.Camera.prototype.copy=function(e){return CLOUD.CombinedCamera.prototype.copy.call(this,e),this.realUp.copy(e.realUp),this.orthoScale=e.orthoScale,this.dirty=e.dirty,this.updateProjectionMatrix(),this.updateMVP(),this},CLOUD.Camera.prototype.setStandardView=function(e,t){var i;i=t?t.getCenter():new THREE.Vector3(0,0,0);var n=CLOUD.GlobalData.SceneSize,r=n/2;switch(e){case CLOUD.EnumStandardView.ISO:var a=new THREE.Vector3(-n,n,n),o=new THREE.Vector3,s=new THREE.Vector3(0,0,0);o.subVectors(s,a),this.LookAt(i,o,THREE.Object3D.DefaultUp);break;case CLOUD.EnumStandardView.Top:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.Bottom:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.Front:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Back:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Right:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.Left:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthEast:this.LookAt(i,new THREE.Vector3(-1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.SouthWest:this.LookAt(i,new THREE.Vector3(1,0,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthWest:this.LookAt(i,new THREE.Vector3(1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.NorthEast:this.LookAt(i,new THREE.Vector3(-1,0,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomFront:this.LookAt(i,new THREE.Vector3(0,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomBack:this.LookAt(i,new THREE.Vector3(0,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomRight:this.LookAt(i,new THREE.Vector3(-1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomLeft:this.LookAt(i,new THREE.Vector3(1,1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthEast:this.LookAt(i,new THREE.Vector3(-1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomSouthWest:this.LookAt(i,new THREE.Vector3(1,1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthWest:this.LookAt(i,new THREE.Vector3(1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.BottomNorthEast:this.LookAt(i,new THREE.Vector3(-1,1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofFront:this.LookAt(i,new THREE.Vector3(0,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofBack:this.LookAt(i,new THREE.Vector3(0,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofRight:this.LookAt(i,new THREE.Vector3(-1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofLeft:this.LookAt(i,new THREE.Vector3(1,-1,0),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthEast:this.LookAt(i,new THREE.Vector3(-1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofSouthWest:this.LookAt(i,new THREE.Vector3(1,-1,-1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthWest:this.LookAt(i,new THREE.Vector3(1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.RoofNorthEast:this.LookAt(i,new THREE.Vector3(-1,-1,1),new THREE.Vector3(0,1,0),r);break;case CLOUD.EnumStandardView.TopTurnRight:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.TopTurnBack:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.TopTurnLeft:this.LookAt(i,new THREE.Vector3(0,-1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnRight:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BottomTurnBack:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.BottomTurnLeft:this.LookAt(i,new THREE.Vector3(0,1,0),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnTop:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.FrontTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.FrontTurnRight:this.LookAt(i,new THREE.Vector3(0,0,-1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.RightTurnTop:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.RightTurnFront:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,-1),r);break;case CLOUD.EnumStandardView.RightTurnBack:this.LookAt(i,new THREE.Vector3(-1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.BackTurnTop:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.BackTurnLeft:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(-1,0,0),r);break;case CLOUD.EnumStandardView.BackTurnRight:this.LookAt(i,new THREE.Vector3(0,0,1),new THREE.Vector3(1,0,0),r);break;case CLOUD.EnumStandardView.LeftTurnTop:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,-1,0),r);break;case CLOUD.EnumStandardView.LeftTurnBack:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,1),r);break;case CLOUD.EnumStandardView.LeftTurnFront:this.LookAt(i,new THREE.Vector3(1,0,0),new THREE.Vector3(0,0,-1),r)}return this.updateProjectionMatrix(),i},CLOUD.Camera.prototype.zoomToBBox=function(e,t,i,n){i=i||1,t=t||0,t=t<-1?-1:t;var r=new THREE.Box3;if(r.copy(e),0!==t){var a=.5*e.getSize().length(),o=new THREE.Vector3;o.subVectors(r.max,r.min).normalize(),o.multiplyScalar(a*t),r.expandByVector(o)}var s=n||this.getWorldDirection(),l=this.up,c=this.aspect,u=THREE.Math.degToRad(.5*this.fov),h=r.getSize(),d=r.getCenter(),f=.5*h.length(),p=f/Math.sin(u)*i,m=new THREE.Vector3;m.copy(s),m.setLength(p);var g=new THREE.Vector3;g.subVectors(d,m);var v=new THREE.Vector3;v.crossVectors(s,l),v.normalize();var y=new THREE.Vector3;y.crossVectors(s,v),y.normalize();var E=new THREE.Plane;E.setFromNormalAndCoplanarPoint(v,g);var x=new THREE.Plane;x.setFromNormalAndCoplanarPoint(y,g);var b=0,C=0,M=0,_=0,w=0,L=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];L[0].set(r.min.x,r.min.y,r.min.z),L[1].set(r.min.x,r.min.y,r.max.z),L[2].set(r.min.x,r.max.y,r.min.z),L[3].set(r.min.x,r.max.y,r.max.z),L[4].set(r.max.x,r.min.y,r.min.z),L[5].set(r.max.x,r.min.y,r.max.z),L[6].set(r.max.x,r.max.y,r.min.z),L[7].set(r.max.x,r.max.y,r.max.z);for(var T=0;T<8;T++){var I=new THREE.Vector3;I.subVectors(L[T],g);var S=Math.abs(I.dot(s)),O=Math.abs(x.distanceToPoint(L[T])),D=O*c,R=Math.abs(E.distanceToPoint(L[T])),A=R/c,U=Math.max(O,A),B=Math.max(D,R);b<U&&(b=U),(!C||!M||U>C*S/M)&&(C=U,M=S),(!_||!w||B>_*S/w)&&(_=B,w=S)}var P,N=_/Math.tan(u)+(p-w),k=C/Math.tan(u)+(p-M);if((P=c<1?Math.max(N,k):Math.min(N,k))<this.near){this.near=(P*P+.001*P)/16777.216}if(m.copy(s).normalize().setLength(P),g.subVectors(d,m),this.position.copy(g),this.lookAt(d),this.target.copy(d),!this.isPerspective){var F=Math.tan(this.fov*Math.PI/180/2)*P;this.orthoScale=F/b,this.zoom=this.orthoScale}return this.updateProjectionMatrix(),this.dirty=!0,d},CLOUD.Camera.prototype.computeRay=function(e,t,i){var n=new THREE.Vector2;if(void 0===i)n.x=window.innerWidth,n.y=window.innerHeight;else{var r=i===document?i.body:i;n.x=r.offsetWidth,n.y=r.offsetHeight}var a=new THREE.Vector2;a.x=e/n.x*2-1,a.y=-t/n.y*2+1;var o=new THREE.Ray;return this.isPerspective?(o.origin.copy(this.position),o.direction.set(a.x,a.y,.5).unproject(this).sub(this.position).normalize()):(o.origin.set(a.x,a.y,-1).unproject(this),o.direction.set(0,0,-1).transformDirection(this.matrixWorld)),o},CLOUD.Camera.prototype.screenToWorld=function(e,t,i,n){var r=this.computeRay(e,t,i),a=this.getWorldDirection().normalize(),o=new THREE.Plane(a);return o.setFromNormalAndCoplanarPoint(a,n),r.intersectPlane(o,n)},CLOUD.Camera.prototype.getWorldFrustum=function(e){var t=new THREE.Matrix4,i=new THREE.Frustum,n=this.clone(),r=this.target,a=r.clone().sub(this.position).length(),o=new THREE.Matrix4;o.getInverse(e);var s=new THREE.Matrix4;s.extractRotation(e);var l=new THREE.Quaternion;l.setFromRotationMatrix(s),l.inverse(),n.position.applyMatrix4(o);var c=r.clone();c.applyMatrix4(o);var u=c.clone().sub(n.position),h=u.length();u.normalize();var d=h/a;return n.far=camera.far*d,n.up.applyQuaternion(l).normalize(),n.realUp.applyQuaternion(l).normalize(),n.updateProjectionMatrix(),n.updateMatrixWorld(),t.getInverse(n.matrixWorld),i.setFromMatrix((new THREE.Matrix4).multiplyMatrices(n.projectionMatrix,t)),n=null,i},CLOUD.Camera.prototype.distanceFromWorldToDrawing=function(e,t){var i=this.position.clone(),n=this.target.clone();n.subVectors(this.target,this.position),n.normalize();var r=new THREE.Matrix4;return r.getInverse(e),n.add(i).applyMatrix4(r),i.applyMatrix4(r),n.sub(i),n.normalize().multiplyScalar(t),n.add(i).applyMatrix4(e),n.sub(this.position),n.length()},CLOUD.Camera.drawingToWorld=function(e,t){var i=e.position.clone(),n=e.target.clone(),r=e.up.clone(),a=new THREE.Matrix4;return a.getInverse(t),r.add(i),r.applyMatrix4(a),i.applyMatrix4(a),n.applyMatrix4(a),r.sub(i),r.normalize(),{position:i,target:n,up:r}},CLOUD.Camera.worldToDrawing=function(e,t){var i=e.position.clone(),n=e.target.clone(),r=e.up.clone();return r.add(i),r.applyMatrix4(t),i.applyMatrix4(t),n.applyMatrix4(t),r.sub(i),r.normalize(),{position:i,target:n,up:r}},CLOUD.Animation=function(){var e=this,t=null,i={},n={},r=1e3,a=null,o=null,s=null,l=!1,c=null,u=null,h=null;this.from=function(e){t=e;for(var n in t)i[n]=t[n];return this},this.to=function(e,t){return void 0!==t&&(r=t),n=e,this},this.onStart=function(e){return c=e,this},this.onUpdate=function(e){return u=e,this},this.onComplete=function(e){return h=e,this},this.start=function(e){function d(){var f,p=i,m=n,g=Date.now();!1===l&&(null!==c&&c.call(t),l=!0),f=(g-a)/r,f=f>1?1:f,t=s(p,m,f),1===f?(cancelAnimationFrame(o),null!==h&&h.call(t)):(requestAnimationFrame(d,e),null!==u&&u.call(t,f))}l=!1,o&&cancelAnimationFrame(o),a=Date.now(),s=this.interpolate,o=requestAnimationFrame(d,e)},this.isAngleGreaterThanPi=function(e,t,i){var n=new THREE.Vector3;return n.crossVectors(e,t),!(n.dot(i)>=0)},this.conicInterpolate=function(e,t,i,n){var r=t.angleTo(e),a=-r*n,o=new THREE.Vector3;o.crossVectors(t,e).normalize();var s=new THREE.Quaternion;s.setFromAxisAngle(o,a),i.copy(e),i.applyQuaternion(s)},this.quaternionInterpolate=function(e,t,i,n,r){var a=new THREE.Quaternion(e.x,e.y,e.z,1).normalize(),o=new THREE.Quaternion(t.x,t.y,t.z,1).normalize(),s=new THREE.Quaternion(0,0,0,1),l=new THREE.Quaternion(0,0,0,1),c=new THREE.Vector3;c.crossVectors(e,i).normalize(),s.set(c.x,c.y,c.z,1).normalize();var u=0;r<.5?(u=2*r,THREE.Quaternion.slerp(a,s,l,u),n.set(l.x,l.y,l.z)):(u=2*(r-.5),THREE.Quaternion.slerp(s,o,l,u),n.set(l.x,l.y,l.z))},this.slerpInterpolate=function(e,t,i,n,r,a){var o=e.dot(t);a<o?n.copy(t):a<Math.abs(o)?this.quaternionInterpolate(e,t,i,n,r):this.conicInterpolate(e,t,n,r),n.normalize()},this.linearInterpolate=function(e,t,i,n,r){if(e.equals(t))return void i.copy(t);var a=new THREE.Vector3(1,0,0),o=new THREE.Vector3(0,0,1),s=new THREE.Vector3,l=0,c=e.dot(t);r<c?i.copy(t):r<-c?(r>Math.abs(e.dot(o))?s.crossVectors(e,o).normalize():s.crossVectors(e,a).normalize(),n<.5?(l=2*n,i.lerpVectors(e,s,l)):(l=2*(n-.5),i.lerpVectors(s,t,l))):i.lerpVectors(e,t,n),i.normalize()},this.linearInterpolatePosition=function(e,t,i,n){i.lerpVectors(e,t,n)},this.sphericalInterpolate=function(e,t,i,n,r,a){var o=new THREE.Vector3(0,1,0),s=new THREE.Vector3(0,0,1),l=new THREE.Plane(o,0),c=e.clone().sub(t),u=c.clone().angleTo(l.normal),h=c.clone().projectOnPlane(l.normal),d=h.clone().angleTo(s),f=s.clone().cross(h);f.y<=0&&(d=-d);var p=i.clone().sub(n),m=p.clone().angleTo(l.normal);h=p.clone().projectOnPlane(l.normal);var g=h.clone().angleTo(s),f=s.clone().cross(h);f.y<0&&(g=-g),g-d>Math.PI?d<0&&g>0&&(g-=2*Math.PI):g-d<-Math.PI&&g<0&&d>0&&(g+=2*Math.PI);var v=u+(m-u)*a,y=d+(g-d)*a,E=c.length(),x=new THREE.Vector3;x.x=E*Math.sin(v)*Math.sin(y),x.z=E*Math.sin(v)*Math.cos(y),x.y=E*Math.cos(v),r.copy(x).multiplyScalar(-1)},this.interpolate=function(t,i,n){var r=new THREE.Vector3,a=new THREE.Vector3,o=new THREE.Vector3,s=new THREE.Vector3,l=t.animPos,c=t.animTarget,u=(t.animDir,t.animUp),h=t.animFocal,d=i.animPos,f=i.animTarget,p=(i.animDir,i.animUp),m=i.animFocal;return e.sphericalInterpolate(l,c,d,f,r,n),e.linearInterpolate(u,p,a,n,.9995),e.linearInterpolatePosition(c,f,o,n),e.linearInterpolatePosition(h,m,s,n),{animDir:r,animUp:a,animTarget:o,animFocal:s}}},CLOUD.CameraAnimator=function(){var e=500,t=13,i=new CLOUD.Animation;this.setDuration=function(t){e=t},this.setFrameTime=function(e){t=e},this.setStandardView=function(n,r,a,o,s){var l=r.camera,c=l.position.clone(),u=l.target.clone(),h=l.getWorldDirection().clone();h.normalize();var d=new THREE.Vector3;d.copy(l.realUp||l.up),d.normalize();var f=new THREE.Vector3(l.position.clone().sub(u).length(),0,0),p=l.setStandardView(n,a);p=r.camera.zoomToBBox(a,o);var m=l.position.clone(),g=l.getWorldDirection().clone();g.normalize();var v=new THREE.Vector3;v.copy(l.realUp||l.up),v.normalize();var y=new THREE.Vector3(l.position.clone().sub(p).length(),0,0);r.getEditorManager().setInteractiveState(!1),i.from({animPos:c,animDir:h,animUp:d,animTarget:u,animFocal:f}).to({animPos:m,animDir:g,animUp:v,animTarget:p,animFocal:y},e).onUpdate(function(){var e=this.animTarget,t=this.animDir,i=this.animUp,n=this.animFocal.x;r.camera.LookAt(e,t,i,n),r.cameraControl.update(!0,!0),r.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CAMERA_ANIMATION_UPDATE}),s&&s()}).onComplete(function(){r.camera.LookAt(p,g,v,y.x),r.cameraControl.update(!0,!0),s&&s(),r.getEditorManager().setInteractiveState(!0),r.camera.up.copy(THREE.Object3D.DefaultUp)}).start(t)},this.active=function(n,r,a,o,s){var l=a.camera,c=new THREE.Vector3(n.position.x,n.position.y,n.position.z),u=new THREE.Vector3(n.target.x,n.target.y,n.target.z),h=new THREE.Vector3(u.distanceTo(c),0,0),d=u.clone().sub(c).normalize(),f=new THREE.Vector3(n.up.x,n.up.y,n.up.z);f.normalize();var p=new THREE.Vector3(r.position.x,r.position.y,r.position.z),m=new THREE.Vector3(r.target.x,r.target.y,r.target.z),g=new THREE.Vector3(m.distanceTo(p),0,0),v=m.clone().sub(p).normalize(),y=new THREE.Vector3(r.up.x,r.up.y,r.up.z);y.normalize(),a.getEditorManager().setInteractiveState(!1),i.from({animPos:c,animDir:d,animUp:f,animTarget:u,animFocal:h}).to({animPos:p,animDir:v,animUp:y,animTarget:m,animFocal:g},e).onUpdate(function(){var e=this.animTarget,t=this.animDir,i=this.animUp,n=this.animFocal.x;l.LookAt(e,t,i,n),o&&o(e)}).onComplete(function(){l.LookAt(m,v,y,g.x),o&&o(m),s&&s(),a.getEditorManager().setInteractiveState(!0),l.up.copy(THREE.Object3D.DefaultUp)}).start(t)}},CLOUD.CameraInfo=function(e,t,i,n,r,a){this.name=e,this.position=t,this.target=i,this.up=n,this.fov=r,this.version=void 0===a?1:a},CLOUD.CameraUtil={createCameraInfo:function(e){var t=e.camera,i=new CameraInfo(e.getCameraName(),t.position,t.target,t.up);return JSON.stringify(i)},transformCamera:function(e,t){var i=new THREE.Vector3,n=function(e){return[parseFloat(e[0]),parseFloat(e[1]),parseFloat(e[2])]};i.fromArray(n(e.position.split(",")));var r=new THREE.Vector3;r.fromArray(n(e.direction.split(",")));var a=new THREE.Vector3;a.fromArray(n(e.up.split(",")));var o=new THREE.Vector3;o.addVectors(i,r),i.applyMatrix4(t.rootNode.matrix),o.applyMatrix4(t.rootNode.matrix);var s=new THREE.Matrix4;return s.makeRotationFromEuler(t.rootNode.rotation),a.applyMatrix4(s),a.normalize(),new CLOUD.CameraInfo(e.name,i,o,a)},parseCameraInfo:function(e){if(!e)return null;var t=JSON.parse(e);if(!t.hasOwnProperty("position")||!t.hasOwnProperty("target")||!t.hasOwnProperty("up"))return null;var i=t.name||"persp",n=new THREE.Vector3;n.x=t.position.x,n.y=t.position.y,n.z=t.position.z;var r=new THREE.Vector3;r.x=t.target.x,r.y=t.target.y,r.z=t.target.z;var a=new THREE.Vector3;a.x=t.up.x,a.y=t.up.y,a.z=t.up.z;var o=void 0===t.version?0:t.version;return new CLOUD.CameraInfo(i,n,r,a,o)},canvasToNormalized:function(e,t,i){var n={x:0,y:0,z:0};return n.x=e.x/t*2-1,n.y=-e.y/i*2+1,n.z=e.z||0,n},normalizedToCanvas:function(e,t,i){var n={x:0,y:0,z:0};return n.x=Math.floor(.5*(e.x+1)*t+.5),n.y=Math.floor(-.5*(e.y-1)*i+.5),n.z=e.z||0,n},drawingToCanvas:function(e,t,i,n){var r=new THREE.Vector3(t.x,t.y,t.z);return r.project(e),this.normalizedToCanvas(r,i,n)},drawingPointsToCanvas:function(e,t,i,n,r){var a={},o=(new THREE.Matrix4).getInverse(e.matrixWorld),s=new THREE.Vector3(t.x,t.y,t.z);s.applyMatrix4(o);var l=new THREE.Vector3(i.x,i.y,i.z);if(l.applyMatrix4(o),s.z>0&&l.z>0)return null;var c=s.clone().sub(l);if(c.normalize(),s.z>0){var u=(s.z+e.near)/c.z;s.sub(c.multiplyScalar(u))}else if(l.z>0){var u=(l.z+e.near)/c.z;l.sub(c.multiplyScalar(u))}return s.applyMatrix4(e.projectionMatrix),l.applyMatrix4(e.projectionMatrix),a.start=this.normalizedToCanvas(s,n,r),a.end=this.normalizedToCanvas(l,n,r),a},lineIntersectWithRect:function(e,t){if(e&&e.start.x==e.end.x&&e.start.y==e.end.y)return console.log("Invalid line."),null;var i=0,n=0;e.start.x!=e.end.x&&(i=(e.start.y-e.end.y)/(e.start.x-e.end.x)),n=e.start.y-i*e.start.x;var r=[],a=t.min,o=t.max;return i*a.x+n>=a.y&&i*a.x+n<=o.y&&r.push(new THREE.Vector2(a.x,i*a.x+n)),i*o.x+n>=a.y&&i*o.x+n<=o.y&&r.push(new THREE.Vector2(o.x,i*o.x+n)),0==i&&(r.push(new THREE.Vector2(a.x,n)),r.push(new THREE.Vector2(o.x,n))),(a.y-n)/i>a.x&&(a.y-n)/i<o.x&&r.push(new THREE.Vector2((a.y-n)/i,a.y)),(o.y-n)/i>a.x&&(o.y-n)/i<o.x&&r.push(new THREE.Vector2((o.y-n)/i,o.y)),r},canvasToDrawing:function(e,t,i,n){var r=this.canvasToNormalized(t,i,n),a=new THREE.Vector3(r.x,r.y,r.z);return a.unproject(e),{x:a.x,y:a.y,z:a.z}},intersectBoxByRay:function(e,t){var i,n,r,a,o,s,l=1/e.direction.x,c=1/e.direction.y,u=1/e.direction.z,h=e.origin;return l>=0?(i=(t.min.x-h.x)*l,n=(t.max.x-h.x)*l):(i=(t.max.x-h.x)*l,n=(t.min.x-h.x)*l),c>=0?(r=(t.min.y-h.y)*c,a=(t.max.y-h.y)*c):(r=(t.max.y-h.y)*c,a=(t.min.y-h.y)*c),i>a||r>n?null:((r>i||i!==i)&&(i=r),(a<n||n!==n)&&(n=a),u>=0?(o=(t.min.z-h.z)*u,s=(t.max.z-h.z)*u):(o=(t.max.z-h.z)*u,s=(t.min.z-h.z)*u),i>s||o>n?null:((o>i||i!==i)&&(i=o),(s<n||n!==n)&&(n=s),n<0?null:i>=0?i:n))},intersectObjectWithFrustum:function(){var e=new THREE.Box3;return function(t,i){if(!t.boundingBox||t instanceof THREE.Mesh){var n=t.geometry;null===n.boundingBox&&n.computeBoundingBox(),e.copy(n.boundingBox)}else e.copy(t.boundingBox);return e.applyMatrix4(t.matrixWorld),i.intersectsBox(e)}}()},CLOUD.SceneStateHelper=function(e){this.selectionSet={},this.selectionMaterial=CLOUD.MaterialUtil.createHighlightMaterial(),this.selectionMaterial.colorState=CLOUD.EnumShaderColorState.SELECT,this.selectionMaterial.name="selection",this.selectionMaterial.refreshUniforms(),this.hoverId=void 0,this.hoverMaterialDefaultParams={color:14540253,opacity:.9,transparent:!0,side:THREE.DoubleSide},this.hoverMaterial=CLOUD.MaterialUtil.createStandardMaterial(this.hoverMaterialDefaultParams),this.hoverMaterial.name="hover",this.modelManager=e,this.blinkComponentIds={},this.phongHoverMaterial=new THREE.MeshPhongMaterial(this.hoverMaterialDefaultParams),this.phongSelectionMaterial=new THREE.MeshPhongMaterial(CLOUD.GlobalData.SelectionColor)},CLOUD.SceneStateHelper.prototype={constructor:CLOUD.SceneStateHelper,_dispatchChangeEvent:function(){var e=this.getSelection();this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_CHANGED,selectionList:e})},clearSelection:function(){var e=!1;for(var t in this.selectionSet)if(this.selectionSet.hasOwnProperty(t)){e=!0,this.selectionSet={};break}e&&(this.modelManager.clearSelection(),this._dispatchChangeEvent())},addSelection:function(e){if(e){for(var t=this.selectionSet,i=!1,n=e.length-1;n>=0;n--)t.hasOwnProperty(e[n])||(t[e[n]]=!0,i=!0);i&&(this.modelManager.applySelection(),this._dispatchChangeEvent())}},setSelection:function(e){e||(e=[]);for(var t=[],i=e.length-1;i>=0;i--)this.modelManager.isUserIdExist(e[i])||t.push(e[i]);t.length>0&&this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_SELECTION_FAILED,failedId:t});for(var n=this.selectionSet={},i=e.length-1;i>=0;i--)n[e[i]]=!0;this.modelManager.applySelection(),this._dispatchChangeEvent()},removeSelection:function(e){var t=!1,i=this.selectionSet;if(e&&e.length>0)for(var n=0,r=e.length;n<r;++n){var a=e[n];i.hasOwnProperty(a)&&(delete i[a],t=!0)}t&&(this.modelManager.applySelection(),this._dispatchChangeEvent())},getSelection:function(){var e=[];for(var t in this.selectionSet)e.push(t);return e},getSelectionSet:function(){return this.selectionSet},isSelected:function(e){return this.selectionSet.hasOwnProperty(e)},setHoverId:function(e){this.hoverId=e,this.modelManager.applyHover()},clearHover:function(){this.hoverId=void 0,this.modelManager.clearHover()},getHoverMaterial:function(e){var t=e&&e.isMeshPhongMaterial?this.phongHoverMaterial.clone():this.hoverMaterial.clone();if(e&&e.hasOwnProperty("color")){var i=e.color.clone(),n=Math.max(i.r,Math.max(i.g,i.b));0==n&&(n=.5),i.r+=0==i.r?.3*n:.2*i.r,i.g+=0==i.g?.3*n:.2*i.g,i.b+=0==i.b?.3*n:.2*i.b,i.r>1&&(i.r=1),i.g>1&&(i.g=1),i.b>1&&(i.b=1),1===i.r&&1===i.g&&1===i.b&&(i.r=.7,i.g=.7,i.b=.7),t.color.setHex(i.getHex()),void 0!==e.opacity?t.opacity=e.opacity:t.opacity=this.hoverMaterialDefaultParams.opacity,void 0!==e.transparent?t.transparent=e.transparent:t.transparent=this.hoverMaterialDefaultParams.transparent,void 0!==e.side?t.side=e.side:t.side=this.hoverMaterialDefaultParams.side,void 0!==e.metalness&&(t.metalness=e.metalness),void 0!==e.roughness&&(t.roughness=e.roughness),void 0!==e.bumpMap&&(t.bumpMap=e.bumpMap),void 0!==e.alphaMap&&(t.alphaMap=e.alphaMap),void 0!==e.emissiveMap&&(t.emissiveMap=e.emissiveMap),void 0!==e.envMap&&(t.envMap=e.envMap),void 0!==e.envMapIntensity&&(t.envMapIntensity=e.envMapIntensity),void 0!==e.map&&null!==e.map&&(t.map=e.map,t.opacity=.7*t.opacity,t.transparent=!0),t.needsUpdate=!0}return t},getHoverColorByMaterial:function(e){if(!e.hasOwnProperty("color"))return{rgbaColor:[this.hoverMaterial.color.r,this.hoverMaterial.color.g,this.hoverMaterial.color.b,this.hoverMaterial.opacity],transparent:this.hoverMaterial.transparent};var t=e.color.clone(),i=Math.max(t.r,Math.max(t.g,t.b));0==i&&(i=.5),t.r+=0==t.r?.3*i:.2*t.r,t.g+=0==t.g?.3*i:.2*t.g,t.b+=0==t.b?.3*i:.2*t.b,t.r>1&&(t.r=1),t.g>1&&(t.g=1),t.b>1&&(t.b=1),1===t.r&&1===t.g&&1===t.b&&(t.r=.7,t.g=.7,t.b=.7);var n=e.opacity?e.opacity:this.hoverMaterialDefaultParams.opacity,r=e.transparent?e.transparent:this.hoverMaterialDefaultParams.transparent;return{rgbaColor:[t.r,t.g,t.b,n],transparent:r}},setSelectionColor:function(e,t){var i=this.selectionMaterial.color,n=this.selectionMaterial.opacity;t=void 0==t?n:t,"0x"+i.getHexString()==e&&n==t||(this.selectionMaterial.color.setHex(e),t&&(this.selectionMaterial.opacity=t),this.selectionMaterial.needsUpdate=!0)},getSelectionMaterial:function(){return this.selectionMaterial.clone()},setBlinkComponentsById:function(e){if(this.blinkComponentIds={},e&&0!==e.length){for(var t=e.length-1;t>=0;t--)this.blinkComponentIds[e[t]]=!0;this.modelManager.applyBlink()}},addBlinkComponentsById:function(e){if(e&&e.length){for(var t=this.blinkComponentIds,i=!1,n=e.length-1;n>=0;n--)t[e[n]]||(t[e[n]]=!0,i=!0);i&&this.modelManager.applyBlink()}},clearBlinkComponentsById:function(e){if(e&&e.length){for(var t=!1,i=this.blinkComponentIds,n=0,r=e.length;n<r;++n){var a=e[n];i[a]&&(delete i[a],t=!0)}t&&this.modelManager.applyBlink()}},clearAllBlinkComponents:function(){var e=!1,t=this.blinkComponentIds;CLOUD.Utils.isOwnEmptyObject(t)||(e=!0,this.blinkComponentIds={}),e&&this.modelManager.clearBlink()},getBlinkComponents:function(){return Object.keys(this.blinkComponentIds)},getBlinkComponentsIdMap:function(){return this.modelManager.getBlinkEnabled()?this.blinkComponentIds:null},getBlinkMaterial:function(e){return CLOUD.MaterialUtil.getBlinkMaterial(e,this.modelManager.getBlinkColor())}},CLOUD.Object3DEx=function(e,t){THREE.Object3D.call(this),this.type="Object3DEx",this.geometry=e||CLOUD.GeomUtil.EmptyGeometry,this.material=t||CLOUD.MaterialUtil.getDefaultStandardMaterial(),this.matrixAutoUpdate=!1,this.alive=!1,this.originalId=void 0,this.drawMode=THREE.TrianglesDrawMode},CLOUD.Object3DEx.prototype=Object.create(THREE.Mesh.prototype),CLOUD.Object3DEx.prototype.constructor=CLOUD.Object3DEx,CLOUD.Object3DEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},CLOUD.Object3DEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},CLOUD.Object3DEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),void 0!=e.meshId?this.meshId=e.meshId:this.meshId="",e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),
this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),void 0!=e.visible&&(this.visible=e.visible),void 0!=e.isMesh&&(this.isMesh=e.isMesh),void 0!=e.isLine&&(this.isLine=e.isLine),void 0!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),void 0!=e.instanceOrNot?this.instanceOrNot=e.instanceOrNot:this.instanceOrNot=!1,this.renderOrder=e.renderOrder||0,this.alive=!0,this.frustumCulled=!1,this.material.visible=!0},CLOUD.Object3DEx.prototype.clear=function(){this.geometry=CLOUD.GeomUtil.EmptyGeometry,this.material=CLOUD.MaterialUtil.DefaultMaterial,this.alive=!1,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},CLOUD.Object3DEx.prototype.isVisible=function(){return this.visible&&this.alive},CLOUD.Object3DEx.prototype.intersectBoxWithDistance=function(){var e=new THREE.Box3;return function(t,i){var n=this.geometry,r=this.material,a=this.matrixWorld;return i&&(a=new THREE.Matrix4,a.multiplyMatrices(this.matrixWorld,i)),void 0===r?-1:(n.boundingBox||n.computeBoundingBox(),e.copy(n.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e))}}(),CLOUD.Object3DEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var i=this.matrixWorld,n=this.computeBoundingBox(t);return n.applyMatrix4(i),e.ray.intersectBoxWithDistance(n)},CLOUD.Object3DEx.prototype.intersectBoxWithClipPlane=function(e,t){var i=this.matrixWorld,n=this.computeBoundingBox(t);return n.applyMatrix4(i),n.intersectsPlane(e)},CLOUD.Object3DEx.prototype.raycastByIndices=function(){function e(e,t,i,n,r,a,o){return THREE.Triangle.barycoordFromPoint(e,t,i,n,d),r.multiplyScalar(d.x),a.multiplyScalar(d.y),o.multiplyScalar(d.z),r.add(a).add(o),r.clone()}function t(e,t,i,n,r,a,o){var s=e.material;if(null===(s instanceof Array?i.intersectTriangle(n,r,a,!1,o):s.side===THREE.BackSide?i.intersectTriangle(a,r,n,!0,o):i.intersectTriangle(n,r,a,s.side!==THREE.DoubleSide,o)))return null;p.copy(o),p.applyMatrix4(m);var l=t.ray.origin.distanceTo(p);return l<t.near||l>t.far?null:{distance:l,point:p.clone(),object:e}}function i(i,n,r,a,d,p,m,g){o.fromBufferAttribute(a,p),s.fromBufferAttribute(a,m),l.fromBufferAttribute(a,g);var v=t(i,n,r,o,s,l,f);if(v){if(d&&d.array&&d.array.length&&(c.fromBufferAttribute(d,p),u.fromBufferAttribute(d,m),h.fromBufferAttribute(d,g),v.uv=e(f,o,s,l,c,u,h)),a.instanceMatrix){var y=o.clone().applyMatrix4(a.instanceMatrix),E=s.clone().applyMatrix4(a.instanceMatrix),x=l.clone().applyMatrix4(a.instanceMatrix);v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(y,E,x))}else v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(o,s,l));v.faceIndex=p}return v}var n=new THREE.Matrix4,r=new THREE.Ray,a=new THREE.Sphere,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.Vector2,d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4;return function(e,t,o,s){var l=this.geometry,c=this.material;if(s){var l=this.geometry,c=this.material;if(m=new THREE.Matrix4,m.multiplyMatrices(this.matrixWorld,s),void 0===c)return;if(null===l.boundingSphere&&l.computeBoundingSphere(),a.copy(l.boundingSphere),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;if(n.getInverse(m),r.copy(e.ray).applyMatrix4(n),null!==l.boundingBox&&!1===r.intersectsBox(l.boundingBox))return;var u,h,d,f,p=l.index,g=l.attributes.position;g.instanceMatrix=s;var v,y,E=l.attributes.uv;if(null!==p)for(v=0,y=p.count;v<y;v+=3)h=p.getX(v),d=p.getX(v+1),f=p.getX(v+2),(u=i(this,e,r,g,E,h,d,f))&&(u.faceIndex=Math.floor(v/3),t.push(u));else for(v=0,y=g.count;v<y;v+=3)h=v,d=v+1,f=v+2,(u=i(this,e,r,g,E,h,d,f))&&(u.index=h,t.push(u))}else{if(m=this.matrixWorld,void 0===c)return;if(a.copy(this.computeBoundingSphere(o)),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;n.getInverse(m),r.copy(e.ray).applyMatrix4(n);var x=this.computeBoundingBox(o);if(!1===r.intersectsBox(x))return;var u,h,d,f,v,b,g=l.attributes.position,E=l.attributes.uv,C=o.indexStart,M=o.indexStart+o.indexCount,_=l.getIndex().array;for(v=C,b=M;v<b;v+=3)h=_[v],d=_[v+1],f=_[v+2],(u=i(this,e,r,g,E,h,d,f))&&(u.faceIndex=Math.floor(v/3),t.push(u))}}}(),CLOUD.Object3DEx.prototype.minDistanceToTri=function(e,t,i){function n(e,t){return new THREE.Vector3(e.x-t.x,e.y-t.y,e.z-t.z)}function r(e,t){return new THREE.Vector3(e.x+t.x,e.y+t.y,e.z+t.z)}function a(e,t,i){return new THREE.Vector3(e.x+t.x*i,e.y+t.y*i,e.z+t.z*i)}function o(e,t){return e.x*t.x+e.y*t.y+e.z*t.z}function s(e,t){return new THREE.Vector3(e.y*t.z-e.z*t.y,e.z*t.x-e.x*t.z,e.x*t.y-e.y*t.x)}function l(e,t,i,l){var c,u,h=o(t,l),d=o(t,t),f=o(l,l),p=n(i,e),m=o(t,p),g=o(l,p);c=(m*f-g*h)/(d*f-h*h),c<0||isNaN(c)?c=0:c>1&&(c=1),u=(c*h-g)/f;var v,y,E,x;return u<=0||isNaN(u)?(y=i,c=m/d,c<=0||isNaN(c)?(v=e,E=n(i,e)):c>=1?(v=r(e,t),E=n(i,v)):(v=a(e,t,c),x=s(p,t),E=s(t,x))):u>=1?(y=r(i,l),c=(h+m)/d,c<=0||isNaN(c)?(v=e,E=n(y,e)):c>=1?(v=r(e,t),E=n(y,v)):(v=a(e,t,c),p=n(y,e),x=s(p,t),E=s(t,x))):(y=a(i,l,u),c<=0||isNaN(c)?(v=e,x=s(p,l),E=s(l,x)):c>=1?(v=r(e,t),p=n(i,v),x=s(p,l),E=s(l,x)):(v=a(e,t,c),E=s(t,l),o(E,p)<0&&E.multiplyScalar(-1))),{vec:E,closestP:v,closestQ:y}}for(var c,u,h,d,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g={start:null,end:null,minDistance:Number.POSITIVE_INFINITY},v=this.geometry,y=v.attributes.position,E=t?t.indexStart:0,x=v.getIndex().array,b=t?t.indexStart+t.indexCount:x.length,C=E,d=b;C<d;C+=3){c=x[C],u=x[C+1],h=x[C+2];var M=[];!function(e,t,i,n,r,a){f.fromBufferAttribute(t,i),p.fromBufferAttribute(t,n),m.fromBufferAttribute(t,r),a&&(f.applyMatrix4(a),p.applyMatrix4(a),m.applyMatrix4(a)),e.push(f),e.push(p),e.push(m)}(M,y,c,u,h,i);var _=function(e,t){var i,r,c,u=[],h=[];u[0]=n(e[1],e[0]),u[1]=n(e[2],e[1]),u[2]=n(e[0],e[2]),h[0]=n(t[1],t[0]),h[1]=n(t[2],t[1]),h[2]=n(t[0],t[2]);for(var d,f,p,m,g=0,v=e[0].distanceToSquared(t[0])+1,y=0;y<3;y++)for(var E=0;E<3;E++){var x=l(e[y],u[y],t[E],h[E]);c=x.vec,i=x.closestP,r=x.closestQ,d=n(r,i);var b=o(d,d);if(b<=v){p=i.clone(),m=r.clone(),v=b,f=n(e[(y+2)%3],i);var C=o(f,c);f=n(t[(E+2)%3],r);var M=o(f,c);if(C<=0&&M>=0)return{start:i.clone(),end:r.clone(),minDistance:Math.sqrt(b)};var _=o(d,c);C<0&&(C=0),M>0&&(M=0),_-C+M>0&&(g=1)}}var w=s(u[0],u[1]),L=o(w,w);if(L>1e-15){var T=[];d=n(e[0],t[0]),T[0]=o(d,w),d=n(e[0],t[1]),T[1]=o(d,w),d=n(e[0],t[2]),T[2]=o(d,w);var I=-1;if(T[0]>0&&T[1]>0&&T[2]>0?(I=T[0]<T[1]?0:1,T[2]<T[I]&&(I=2)):T[0]<0&&T[1]<0&&T[2]<0&&(I=T[0]>T[1]?0:1,T[2]>T[I]&&(I=2)),I>=0&&(g=1,d=n(t[I],e[0]),f=s(w,u[0]),o(d,f)>0&&(d=n(t[I],e[1]),f=s(w,u[1]),o(d,f)>0&&(d=n(t[I],e[2]),f=s(w,u[2]),o(d,f)>0))))return i=a(t[I],w,T[I]/L),r=t[I].clone(),{start:i.clone(),end:r,minDistance:i.distanceTo(r)}}var S=s(h[0],h[1]),O=o(S,S);if(O>1e-15){var D=[];d=n(t[0],e[0]),D[0]=o(d,S),d=n(t[0],e[1]),D[1]=o(d,S),d=n(t[0],e[2]),D[2]=o(d,S);var I=-1;if(D[0]>0&&D[1]>0&&D[2]>0?(I=D[0]<D[1]?0:1,D[2]<D[I]&&(I=2)):D[0]<0&&D[1]<0&&D[2]<0&&(I=D[0]>D[1]?0:1,D[2]>D[I]&&(I=2)),I>=0&&(g=1,d=n(e[I],t[0]),f=s(S,h[0]),o(d,f)>0&&(d=n(e[I],t[1]),f=s(S,h[1]),o(d,f)>0&&(d=n(e[I],t[2]),f=s(S,h[2]),o(d,f)>0))))return i=e[I].clone(),r=a(e[I],S,D[I]/O),{start:i,end:r.clone(),minDistance:i.distanceTo(r)}}return g?(i=p,r=m,{start:p.clone(),end:m.clone(),minDistance:Math.sqrt(v)}):{start:p.clone(),end:m.clone(),minDistance:0}}(e,M);if(_.minDistance<=0)return g.minDistance=0,g;g.minDistance>_.minDistance&&(g.minDistance=_.minDistance,g.start=_.start.clone(),g.end=_.end.clone())}return g},CLOUD.Object3DEx.prototype.computeBoundingBox=function(e){var t,i,n=new THREE.Box3,r=this.geometry,a=r.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length),this.setBoundingBoxFromArray(n,a,t,i),n},CLOUD.Object3DEx.prototype.computeBoundingSphere=function(e){var t,i,n=new THREE.Box3,r=new THREE.Vector3,a=this.geometry,o=a.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=o.length);var s=new THREE.Sphere,l=s.center;this.setBoundingBoxFromArray(n,o,t,i),n.getCenter(l);for(var c=0,u=t,h=i;u<h;u+=3)r.x=o[u],r.y=o[u+1],r.z=o[u+2],c=Math.max(c,l.distanceToSquared(r));return s.radius=Math.sqrt(c),s},CLOUD.Object3DEx.prototype.setBoundingBoxFromArray=function(e,t,i,n){for(var r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,c=-1/0,u=i,h=n;u<h;u+=3){var d=t[u],f=t[u+1],p=t[u+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>c&&(c=p)}e.min.set(r,a,o),e.max.set(s,l,c)},CLOUD.PointsEx=function(e,t){THREE.Points.call(this,e,t),this.pointIds=[]},CLOUD.PointsEx.prototype=Object.create(THREE.Points.prototype),CLOUD.PointsEx.prototype.constructor=CLOUD.PointsEx,CLOUD.PointsEx.prototype.raycast=function(){var e=new THREE.Matrix4,t=new THREE.Ray,i=new THREE.Sphere;return function(n,r){function a(t,i){var n=t.clone();return n.applyMatrix4(c),n.project(h),n.y+=i/d,n.unproject(h),n.applyMatrix4(e),n}function o(e,i,o){var l=a(e,i),u=l.distanceToSquared(e),h=t.distanceSqToPoint(l);if(h<u){var d=t.closestPointToPoint(l);d.applyMatrix4(c);var p=n.ray.origin.distanceTo(d);if(p<n.near||p>n.far)return;r.push({id:f[o],distance:p,distanceToRay:Math.sqrt(h),point:d.clone(),index:o,face:null,object:s})}}var s=this,l=this.geometry,c=this.matrixWorld,u=this.size,h=n.camera,d=n.viewportSize.height,f=this.pointIds;e.getInverse(c),null===l.boundingSphere&&l.computeBoundingSphere(),i.copy(l.boundingSphere);var p=i.center,m=a(p,u),g=m.distanceToSquared(p);if(i.radius+=g,i.center.copy(m),i.applyMatrix4(c),!1!==n.ray.intersectsSphere(i)){t.copy(n.ray).applyMatrix4(e);var v=new THREE.Vector3,y=u;if(l.isBufferGeometry){var E,x=l.index,b=l.attributes,C=b.position.array,M=!1;if(b.attrSize&&(M=!0,E=b.attrSize.array),null!==x)for(var _=x.array,w=0,L=_.length;w<L;w++){var T=_[w];v.fromArray(C,3*T),M&&(y=E[T]),o(v,y,T)}else for(var w=0,I=C.length/3;w<I;w++)v.fromArray(C,3*w),M&&(y=E[w]),o(v,y,w)}else for(var S=l.vertices,w=0,I=S.length;w<I;w++)o(S[w],y,w)}}}(),CLOUD.PointsEx.prototype.setAttributeSize=function(e,t){var i=this.geometry.attributes;i.attrSize&&(i.attrSize.array[e]=t,i.attrSize.needsUpdate=!0)},CLOUD.PointsEx.prototype.getAttributeSize=function(e){var t=this.geometry.attributes,i=this.size;return t.attrSize&&(i=t.attrSize.array[e]),i},CLOUD.MeshEx=function(e,t){e=e||CLOUD.GeomUtil.EmptyGeometry,t=t||CLOUD.MaterialUtil.getDefaultStandardMaterial(),THREE.Mesh.call(this,e,t),this.type="MeshEx",this.matrixAutoUpdate=!1,this.alive=!1,this.originalId=void 0,this.pickable=!0},CLOUD.MeshEx.prototype=Object.create(THREE.Mesh.prototype),CLOUD.MeshEx.prototype.constructor=CLOUD.MeshEx,CLOUD.MeshEx.prototype.init=function(e){e&&e.parent&&e.parent.add(this)},CLOUD.MeshEx.prototype.destroy=function(){this.parent&&this.parent.remove(this),this.userData&&(this.userData=null),this.geometry=null,this.material=null},CLOUD.MeshEx.prototype.spawn=function(e){void 0!==e.userId?this.name=e.userId:void 0!==e.nodeId&&(this.name=e.nodeId),e.geometry&&(this.geometry=e.geometry),e.material&&(this.material=e.material),e.matrix?(this.matrix.copy(e.matrix),this.updateMatrixWorld(!0)):(this.matrix.identity(),this.updateMatrixWorld(!0)),e.databagId?this.databagId=e.databagId:this.databagId="",e.userData?this.userData=e.userData:this.userData&&(this.userData=null),e.originalId&&(this.originalId=e.originalId),void 0!=e.visible&&(this.visible=e.visible),void 0!=e.isMesh&&(this.isMesh=e.isMesh),void 0!=e.isLine&&(this.isLine=e.isLine),void 0!=e.isLineSegments&&(this.isLineSegments=e.isLineSegments),void 0!=e.pickable?this.pickable=e.pickable:this.pickable=!0,this.renderOrder=e.renderOrder||0,this.alive=!0,this.frustumCulled=!1,this.material.visible=!0},CLOUD.MeshEx.prototype.clear=function(){this.geometry=CLOUD.GeomUtil.EmptyGeometry,this.material=CLOUD.MaterialUtil.DefaultMaterial,this.alive=!1,this.visible=!0,this.frustumCulled=!0,this.material.visible=!1},CLOUD.MeshEx.prototype.isVisible=function(){return this.visible&&this.alive},CLOUD.MeshEx.prototype.intersectBoxWithDistance=function(){var e=new THREE.Box3;return function(t,i){var n=this.geometry,r=this.material,a=this.matrixWorld;return i&&(a=new THREE.Matrix4,a.multiplyMatrices(this.matrixWorld,i)),void 0===r?-1:(n.boundingBox||n.computeBoundingBox(),e.copy(n.boundingBox),e.applyMatrix4(a),t.ray.intersectBoxWithDistance(e))}}(),CLOUD.MeshEx.prototype.intersectBoxWithDistanceByIndices=function(e,t){var i=this.matrixWorld,n=this.computeBoundingBox(t);return n.applyMatrix4(i),e.ray.intersectBoxWithDistance(n)},CLOUD.MeshEx.prototype.intersectBoxWithClipPlane=function(e,t){var i=this.matrixWorld,n=this.computeBoundingBox(t);return n.applyMatrix4(i),n.intersectsPlane(e)},CLOUD.MeshEx.prototype.raycastByIndices=function(){function e(e,t,i,n,r,a,o){return THREE.Triangle.barycoordFromPoint(e,t,i,n,d),r.multiplyScalar(d.x),a.multiplyScalar(d.y),o.multiplyScalar(d.z),r.add(a).add(o),r.clone()}function t(e,t,i,n,r,a,o){var s=e.material;if(null===(s instanceof Array?i.intersectTriangle(n,r,a,!1,o):s.side===THREE.BackSide?i.intersectTriangle(a,r,n,!0,o):i.intersectTriangle(n,r,a,s.side!==THREE.DoubleSide,o)))return null;p.copy(o),p.applyMatrix4(m);var l=t.ray.origin.distanceTo(p);return l<t.near||l>t.far?null:{distance:l,point:p.clone(),object:e}}function i(i,n,r,a,d,p,m,g){o.fromBufferAttribute(a,p),s.fromBufferAttribute(a,m),l.fromBufferAttribute(a,g);var v=t(i,n,r,o,s,l,f);if(v){if(d&&d.array&&d.array.length&&(c.fromBufferAttribute(d,p),u.fromBufferAttribute(d,m),h.fromBufferAttribute(d,g),v.uv=e(f,o,s,l,c,u,h)),a.instanceMatrix){var y=o.clone().applyMatrix4(a.instanceMatrix),E=s.clone().applyMatrix4(a.instanceMatrix),x=l.clone().applyMatrix4(a.instanceMatrix);v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(y,E,x))}else v.face=new THREE.Face3(p,m,g,THREE.Triangle.normal(o,s,l));v.faceIndex=p}return v}var n=new THREE.Matrix4,r=new THREE.Ray,a=new THREE.Sphere,o=new THREE.Vector3,s=new THREE.Vector3,l=new THREE.Vector3,c=new THREE.Vector2,u=new THREE.Vector2,h=new THREE.Vector2,d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Matrix4;return function(e,t,o,s){var l=this.geometry,c=this.material;if(s){var l=this.geometry,c=this.material;if(m=new THREE.Matrix4,m.multiplyMatrices(this.matrixWorld,s),void 0===c)return;if(null===l.boundingSphere&&l.computeBoundingSphere(),a.copy(l.boundingSphere),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;if(n.getInverse(m),r.copy(e.ray).applyMatrix4(n),null!==l.boundingBox&&!1===r.intersectsBox(l.boundingBox))return;var u,h,d,f,p=l.index,g=l.attributes.position;g.instanceMatrix=s;var v,y,E=l.attributes.uv;if(null!==p)for(v=0,y=p.count;v<y;v+=3)h=p.getX(v),d=p.getX(v+1),f=p.getX(v+2),(u=i(this,e,r,g,E,h,d,f))&&(u.faceIndex=Math.floor(v/3),t.push(u));else for(v=0,y=g.count;v<y;v+=3)h=v,d=v+1,f=v+2,(u=i(this,e,r,g,E,h,d,f))&&(u.index=h,t.push(u))}else{if(m=this.matrixWorld,void 0===c)return;if(a.copy(this.computeBoundingSphere(o)),a.applyMatrix4(m),!1===e.ray.intersectsSphere(a))return;n.getInverse(m),r.copy(e.ray).applyMatrix4(n);var x=this.computeBoundingBox(o);if(!1===r.intersectsBox(x))return;var u,h,d,f,v,b,g=l.attributes.position,E=l.attributes.uv,C=o.indexStart,M=o.indexStart+o.indexCount,_=l.getIndex().array;for(v=C,b=M;v<b;v+=3)h=_[v],d=_[v+1],f=_[v+2],(u=i(this,e,r,g,E,h,d,f))&&(u.faceIndex=Math.floor(v/3),t.push(u))}}}(),CLOUD.MeshEx.prototype.computeBoundingBox=function(e){var t,i,n=new THREE.Box3,r=this.geometry,a=r.attributes.position.array;return e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=a.length),this.setBoundingBoxFromArray(n,a,t,i),n},CLOUD.MeshEx.prototype.computeBoundingSphere=function(e){var t,i,n=new THREE.Box3,r=new THREE.Vector3,a=this.geometry,o=a.attributes.position.array;e?(t=e.positionStart,i=e.positionStart+e.positionCount):(t=0,i=o.length);var s=new THREE.Sphere,l=s.center;this.setBoundingBoxFromArray(n,o,t,i),n.getCenter(l);for(var c=0,u=t,h=i;u<h;u+=3)r.x=o[u],r.y=o[u+1],r.z=o[u+2],c=Math.max(c,l.distanceToSquared(r));return s.radius=Math.sqrt(c),s},CLOUD.MeshEx.prototype.setBoundingBoxFromArray=function(e,t,i,n){for(var r=1/0,a=1/0,o=1/0,s=-1/0,l=-1/0,c=-1/0,u=i,h=n;u<h;u+=3){var d=t[u],f=t[u+1],p=t[u+2];d<r&&(r=d),f<a&&(a=f),p<o&&(o=p),d>s&&(s=d),f>l&&(l=f),p>c&&(c=p)}e.min.set(r,a,o),e.max.set(s,l,c)},function(){var e=new THREE.Box3,t=new THREE.Matrix4,i=new THREE.Ray,n=new THREE.Sphere,r=function(r){function a(e,t){_classCallCheck(this,a);var i=_possibleConstructorReturn(this,(a.__proto__||Object.getPrototypeOf(a)).call(this,e,t));return i.type="LineSegmentsEx",i}return _inherits(a,r),_createClass(a,[{key:"init",value:function(e){}},{key:"destroy",value:function(){}},{key:"intersectBoxWithDistance",value:function(t,i){var n=this.geometry,r=this.matrixWorld;return i&&(r=this.matrixWorld.clone(),r.multiplyMatrices(this.matrixWorld,i)),n.boundingBox||n.computeBoundingBox(),e.copy(n.boundingBox),e.applyMatrix4(r),t.ray.intersectBoxWithDistance(e)}},{key:"intersectBoxWithDistanceByIndices",value:function(e,t){var i=this.geometry.attributes.position.array,n=0,r=i.length;t&&t.indexCount>0&&(n=t.positionStart,r=t.positionStart+t.positionCount);var a=CLOUD.Utils.box3FromArrayRange(i,n,r);return a.applyMatrix4(this.matrixWorld),e.ray.intersectBoxWithDistance(a)}},{key:"raycastByIndices",value:function(e,r,a,o){var s=e.linePrecision;e.linePrecision=CLOUD.GlobalData.LineSelectRange;var l,c=e.linePrecision,u=c*c;o?(l=this.matrixWorld.clone(),l.multiplyMatrices(this.matrixWorld,o)):l=this.matrixWorld;var h=this.geometry;if(null===h.boundingSphere&&h.computeBoundingSphere(),n.copy(h.boundingSphere),n.applyMatrix4(l),!1!==e.ray.intersectsSphere(n)){t.getInverse(l),i.copy(e.ray).applyMatrix4(t);var d=new THREE.Vector3,f=new THREE.Vector3,p=new THREE.Vector3,m=new THREE.Vector3,g=h.attributes.position.array,v=h.index.array,y=0,E=v.length;a&&a.indexCount>0&&(y=a.indexStart,E=a.indexStart+a.indexCount);for(var x=y;x<E-1;x+=2){var b=v[x],C=v[x+1];d.fromArray(g,3*b),f.fromArray(g,3*C);if(!(i.distanceSqToSegment(d,f,m,p)>u)){m.applyMatrix4(l);var M=e.ray.origin.distanceTo(m);M<e.near||M>e.far||r.push({distance:M,point:p.clone().applyMatrix4(l),index:x,face:null,faceIndex:null,object:this})}}e.linePrecision=s}}}]),a}(THREE.LineSegments);CLOUD.LineSegmentsEx=r}(),CLOUD.MaterialEx=function(){this.materialDefaultParams={color:14540253,opacity:.5,transparent:!0,side:THREE.DoubleSide},this.material=CLOUD.MaterialUtil.createStandardMaterial(this.materialDefaultParams)},CLOUD.MaterialEx.prototype.destroy=function(){this.material=null},CLOUD.MaterialEx.prototype.resetColor=function(){this.material.color.setHex(this.materialDefaultParams.color)},CLOUD.MaterialEx.prototype.resetOpacity=function(){this.material.opacity=this.materialDefaultParams.opacity},CLOUD.MaterialEx.prototype.reset=function(){this.material.color.setHex(this.materialDefaultParams.color),this.material.opacity=this.materialDefaultParams.opacity,this.material.transparent=this.materialDefaultParams.transparent,this.material.side=this.materialDefaultParams.side,this.material.needsUpdate=!0},CLOUD.ObjectPool=function(e,t){this.cls=e,this.size=t,this._pool=[],this.counter=0},CLOUD.ObjectPool.prototype.init=function(e){for(var t=0,i=this.size;t<i;++t){var n=new this.cls;n.init(e),this._pool[t]=n}},CLOUD.ObjectPool.prototype.resize=function(e,t){this.size=e,this.collect(),this.init(t)},CLOUD.ObjectPool.prototype.get=function(e){if(this.counter>=this.size)return null;var t=this._pool[this.counter];return t.spawn(e),++this.counter,t},CLOUD.ObjectPool.prototype.clear=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].clear();this.counter=0},CLOUD.ObjectPool.prototype.destroy=function(){this.collect()},CLOUD.ObjectPool.prototype.collect=function(){this._pool=[],this.counter=0},CLOUD.ObjectPool.prototype.getObjects=function(){return this._pool},CLOUD.ExpandableObjectPool=function(){this.size=0,this.counter=0,this.expansion=1,this._pool=null},CLOUD.ExpandableObjectPool.prototype.init=function(e,t){this.classType=e,this._pool=[],this._expand(t)},CLOUD.ExpandableObjectPool.prototype._expand=function(e){this.size+=e;for(var t=0;t<e;t++)this._pool.push(new this.classType)},CLOUD.ExpandableObjectPool.prototype.acquire=function(){return this.counter>=this.size&&(this.expansion=Math.round(1.2*this.expansion)+1,this._expand(this.expansion),console.log("_expand")),this._pool[this.counter++]},CLOUD.ExpandableObjectPool.prototype.clear=function(){this.counter=0},CLOUD.ExpandableObjectPool.prototype.destroy=function(){for(var e=0,t=this.size;e<t;++e)this._pool[e].destroy();this.counter=0,this.size=0,this.expansion=1,this._pool=null},CLOUD.ExpandableObjectPool.prototype.getObjects=function(){return this._pool},CLOUD.ObjectGroup=function(e,t){THREE.Group.call(this),this.name=e,this.priority=t&&t.priority?t.priority:5,this.pickableType=t&&t.pickableType?t.pickableType:CLOUD.PICKABLETYPE.UnPickable,this.globalSpace=!(!t||!t.globalSpace)&&t.globalSpace,this.boundingBox=null,this.hoverEnabled=!(!t||!t.hoverEnabled)&&t.hoverEnabled},CLOUD.ObjectGroup.prototype=Object.create(THREE.Group.prototype),CLOUD.ObjectGroup.prototype.constructor=CLOUD.ObjectGroup,CLOUD.ObjectGroup.prototype.removeByName=function(e){for(var t=this.children,i=0,n=t.length;i<n;++i)if(t[i].name===e){t.splice(i,1);break}},CLOUD.ObjectGroup.prototype.clear=function(){this.children.length=0},CLOUD.ObjectGroup.prototype.isGlobalSpace=function(){return this.globalSpace},CLOUD.ObjectGroup.prototype.hasChild=function(e){for(var t=0,i=this.children.length;t<i;t++)if(this.children[t].name==e)return!0;return!1},CLOUD.ObjectGroup.prototype.isPickable=function(){return this.pickableType!==CLOUD.PICKABLETYPE.UnPickable},CLOUD.ObjectGroup.prototype.raycast=function(e,t){for(var i=0,n=this.children.length;i<n;i++){var r=this.children[i];if(CLOUD.Utils.isGroupObject(r)){var a=r.name;r.traverseVisible(function(i){CLOUD.Utils.isMeshObject(i)&&(void 0===i.userId&&(i.userId=a),i.raycast(e,t))})}else r.visible&&r.raycast(e,t)}},CLOUD.ObjectGroupType={MODEL:"Model",GEOMETRY:"Geometry",LINESEGMENTS:"LineSegments",INSTANCEGEOMETRY:"InstanceGeometry",INSTANCEWIREFRAMEGEOMETRY:"InstanceWireframeGeometry",WIREFRAME:"Wireframe",MARKER3D:"Marker3D",CLIPPLANE:"ClipPlane",FILLCLIPPLANE:"FillClipPlane",IBLCUBE:"IBLCube",CUSTOMPLANE:"CustomPlane",PIVOTBALL:"PivotBall",MEASUREPICKPOINT:"MeasurePickPoint",MEASUREPICKLINE:"MeasurePickLine",MEASUREPLANE:"MeasurePlane",MEASURELINE:"MeasureLine",OCTREENODE:"OctreeNode",AREANODE:"AreaNode",AXISGRIDMANAGER:"AxisGridManager",EXTRUDEBODYMANAGER:"ExtrudeBodyManager",EXTERNALCOMPONENTMANAGER:"ExternalComponentManager"},CLOUD.Scene=function(){THREE.Object3D.call(this),this.type="Scene",this.autoUpdate=!1,this.objectGroups=new CLOUD.ObjectGroup,this.add(this.objectGroups),this.geometryGroup=new CLOUD.ObjectGroup(CLOUD.ObjectGroupType.GEOMETRY,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),this.objectGroups.add(this.geometryGroup),this.pool=new CLOUD.ObjectPool(CLOUD.MeshEx,0),this.expandScalar=1.02,this.clipPlanes=null,this.fillClipPlane=null,this.areaNode=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.axisGridManager=null,this.IBLMaps=new ImageBasedLighting.IBLMaps,this.transformMatrix=new THREE.Matrix4,this.lightArray=[],this.lightHelperArray=[],this.lightHelper=!1,this.lightPreset(),this.selectedMeshes=[],this.nonSelectedMeshes=[],this.selectedInstanceMeshes=[],this.nonSelectedInstanceMeshes=[]},CLOUD.Scene.prototype=Object.create(THREE.Object3D.prototype),CLOUD.Scene.prototype.constructor=CLOUD.Scene,CLOUD.Scene.prototype.createCapStencilMaterials=function(){this.backMaterial||(this.backMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.frontMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.backInstanceMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:16711680,colorWrite:!1,depthWrite:!1,side:THREE.BackSide}),this.backInstanceMaterial.defines.USE_INSTANCE="",this.backInstanceMaterial.defines.USE_INSTANCE_NORMAL="",this.frontInstanceMaterial=CLOUD.MaterialUtil.createStandardMaterial({color:255,colorWrite:!1,depthWrite:!1,side:THREE.FrontSide}),this.frontInstanceMaterial.defines.USE_INSTANCE="",this.frontInstanceMaterial.defines.USE_INSTANCE_NORMAL="")},CLOUD.Scene.prototype.destroy=function(){this.clearLight(),this.clearLightHelper(),this.sunLight&&(this.remove(this.sunLight),this.sunLight=null),this.fillLight0&&(this.remove(this.fillLight0),this.fillLight0=null),this.fillLight1&&(this.remove(this.fillLight1),this.fillLight1=null),this.fillLight2&&(this.remove(this.fillLight2),this.fillLight2=null),this.hemisphereLight&&(this.remove(this.hemisphereLight),this.hemisphereLight=null),this.dirLight&&(this.remove(this.dirLight),this.dirLight=null),this.clearAll(),this.pool.destroy(),this.pool=null,this.geometryGroup=null,this.objectGroups=null,this.clipPlanes=null,this.fillClipPlane=null,this.areaNode=null,this.extrudeBodyManager=null,this.externalComponentManager=null,this.axisGridManager=null,this.IBLMaps=null,this.transformMatrix=null,this.lightArray=null,this.lightHelperArray=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedInstanceMeshes=null,this.nonSelectedInstanceMeshes=null},CLOUD.Scene.prototype.resizePool=function(e){CLOUD.GlobalData.BatchMergeEnabled||(this.geometryGroup.clear(),this.pool.resize(e,{parent:this.geometryGroup}))},CLOUD.Scene.prototype.clearAll=function(){this.pool.clear(),this.autoUpdate=!1},CLOUD.Scene.prototype.getRootNode=function(){return this.geometryGroup},CLOUD.Scene.prototype.getBoundingBox=function(){var e=new THREE.Box3;return function(){return e.copy(this.geometryGroup.boundingBox),e.applyMatrix4(this.geometryGroup.matrix),e}}(),CLOUD.Scene.prototype.getBoundingBoxWorld=function(){return this.geometryGroup.boundingBox.clone()},CLOUD.Scene.prototype.getMatrixGlobal=function(){return this.geometryGroup.matrix.clone()},CLOUD.Scene.prototype.getGlobalScaleFactor=function(){return this.geometryGroup.matrix.elements[0]},CLOUD.Scene.prototype.getMatrixWorldGlobal=function(){return this.geometryGroup.matrixWorld},CLOUD.Scene.prototype.getRotationGlobal=function(){if(this.geometryGroup.matrix){var e=new THREE.Matrix4;e.extractRotation(this.geometryGroup.matrix);var t=new THREE.Euler;return t.setFromRotationMatrix(e),t}return null},CLOUD.Scene.prototype.getTrackingPointFromBoundingBox=function(e,t){if(!this.geometryGroup.boundingBox)return null;var i=t.origin,n=this.getBoundingBox(),r=0,a=[new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3,new THREE.Vector3];a[0].set(n.min.x,n.min.y,n.min.z),a[1].set(n.min.x,n.min.y,n.max.z),a[2].set(n.min.x,n.max.y,n.min.z),a[3].set(n.min.x,n.max.y,n.max.z),a[4].set(n.max.x,n.min.y,n.min.z),a[5].set(n.max.x,n.min.y,n.max.z),a[6].set(n.max.x,n.max.y,n.min.z),a[7].set(n.max.x,n.max.y,n.max.z);for(var o=0;o<8;o++){var s=new THREE.Vector3;s.subVectors(a[o],i);var l=s.dot(e);r<l&&(r=l)}var c=e.clone().multiplyScalar(r),u=i.clone().add(c),h=new THREE.Plane;return h.setFromNormalAndCoplanarPoint(e,u),t.intersectPlane(h)},CLOUD.Scene.prototype.getNearDepthByRect=function(){function e(e){a.setFromMatrixPosition(e.matrixWorld),a.applyProjection(r);var t=a.z;t<n&&t>=0&&t<=1&&(n=t)}function t(e,t){if(!t.boundingBox||t instanceof THREE.Mesh){var n=t.geometry;null===n.boundingBox&&n.computeBoundingBox(),i.copy(n.boundingBox),i.applyMatrix4(t.matrixWorld)}else i.copy(t.boundingBox),i.applyMatrix4(t.matrixWorld);return e.intersectsBox(i)}var i=new THREE.Box3,n=1/0,r=new THREE.Matrix4,a=new THREE.Vector3;return function(i,a){function o(n){if(n instanceof CLOUD.MeshEx){if(!t(i,n))return;e(n)}else if(n.worldBoundingBox){if(!i.intersectsBox(n.worldBoundingBox))return;e(n)}var r=n.children;if(r)for(var a=0,s=r.length;a<s;a++){var l=r[a];l.visible&&o(l)}}n=1/0,r.multiplyMatrices(a.projectionMatrix,a.matrixWorldInverse);for(var s=this.geometryGroup.children,l=0,c=s.length;l<c;l++){var u=s[l];u.visible&&o(u)}return n}}(),CLOUD.Scene.prototype.getExpandScalar=function(){return this.expandScalar},CLOUD.Scene.prototype.hasClipPlanes=function(){return null!=this.clipPlanes},CLOUD.Scene.prototype.getClipPlanes=function(){if(null==this.clipPlanes){var e=this.getBoundingBox();this.clipPlanes=new CLOUD.ClipPlanes(e.getSize().multiplyScalar(this.expandScalar),e.getCenter()),this.objectGroups.add(this.clipPlanes)}return this.clipPlanes},CLOUD.Scene.prototype.setClipPlanes=function(e){if(e){var t=this.getClipPlanes();e.setFromCenterAndSize(e.getCenter(),e.getSize().multiplyScalar(this.expandScalar)),t.setSectionBox(e.min,e.max)}},CLOUD.Scene.prototype.resetClipPlanes=function(){var e=this.getClipPlanes(),t=this.getBoundingBox();if(e.reset(),t.max.x==-1/0||t.max.y==-1/0||t.max.z==-1/0||t.min.x==1/0||t.min.y==1/0||t.min.z==1/0)return void(this.clipPlanes=null);t.setFromCenterAndSize(t.getCenter(),t.getSize().multiplyScalar(this.expandScalar)),e.setSectionBox(t.min,t.max)},CLOUD.Scene.prototype.hasFillClipPlanes=function(){return null!=this.fillClipPlane},CLOUD.Scene.prototype.getFillClipPlane=function(){if(null==this.fillClipPlane){var e=new THREE.Box3;e.copy(this.geometryGroup.boundingBox),e.applyMatrix4(this.geometryGroup.matrix),this.fillClipPlane=new CLOUD.FillClipPlane(e.getSize().multiplyScalar(this.expandScalar),e.getCenter()),this.objectGroups.add(this.fillClipPlane)}return this.fillClipPlane},CLOUD.Scene.prototype.disableClipPlanes=function(){null!=this.clipPlanes&&(this.clipPlanes.enable(!1,!1),this.clipPlanes.update()),null!=this.fillClipPlane&&(this.fillClipPlane.enable(!1,!1),this.fillClipPlane.update())},CLOUD.Scene.prototype.getAreaNode=function(){return null==this.areaNode&&(this.areaNode=new CLOUD.AreaNode,this.objectGroups.add(this.areaNode),this.areaNode.matrix.copy(this.geometryGroup.matrix),this.areaNode.matrixAutoUpdate=!1,this.areaNode.updateMatrixWorld(!0)),this.areaNode},CLOUD.Scene.prototype.getAxisGridManager=function(){return null==this.axisGridManager&&(this.axisGridManager=new CLOUD.AxisGridManager,this.objectGroups.add(this.axisGridManager),this.axisGridManager.matrix.copy(this.geometryGroup.matrix),this.axisGridManager.matrixAutoUpdate=!1,this.axisGridManager.updateMatrixWorld(!0)),this.axisGridManager},CLOUD.Scene.prototype.getExtrudeBodyManager=function(){return null==this.extrudeBodyManager&&(this.extrudeBodyManager=new CLOUD.ExtrudeBodyManager,this.objectGroups.add(this.extrudeBodyManager),this.extrudeBodyManager.matrix.copy(this.geometryGroup.matrix),this.extrudeBodyManager.matrixAutoUpdate=!1,this.extrudeBodyManager.updateMatrixWorld(!0)),this.extrudeBodyManager},CLOUD.Scene.prototype.shrinkScopeByClipPlane=function(e,t){if(this.clipPlanes&&this.clipPlanes.isEnabled()){var i=this.clipPlanes.hitTest(e);if(null==i.distance)return;i.sign?i.distance>t.near&&(t.near=i.distance):i.distance<t.far&&(t.far=i.distance)}},CLOUD.Scene.prototype.updateWorldMatrix=function(e,t,i){var n=new THREE.Matrix4;n.compose(e,t,i),this.updateWorldMatrixByMatrix(n)},CLOUD.Scene.prototype.updateWorldMatrixByMatrix=function(e){for(var t=this.objectGroups.children,i=0,n=t.length;i<n;i++)t[i].globalSpace&&(t[i].matrix.copy(e),t[i].matrixAutoUpdate=!1,t[i].updateMatrixWorld(!0))},CLOUD.Scene.prototype.clearLight=function(){for(var e=0;e<this.lightArray.length;e++){var t=this.lightArray[e];this.remove(t)}this.lightArray=[]},CLOUD.Scene.prototype.defaultLightPreset=function(){var e=.3;this.hemisphereLight||(this.hemisphereLight=new THREE.HemisphereLight(16777215,16777215,e*CLOUD.GlobalData.LightIntensityFactor)),this.add(this.hemisphereLight),this.lightArray.push(this.hemisphereLight),this.hemisphereLight.initIntensity=e,this.hemisphereLight.position.set(0,500,0),this.hemisphereLight.updateMatrixWorld(!0),e=.7,this.dirLight||(this.dirLight=new THREE.DirectionalLight(16777215,e*CLOUD.GlobalData.LightIntensityFactor)),
this.add(this.dirLight),this.lightArray.push(this.dirLight),this.dirLight.initIntensity=e,this.dirLight.color.setHSL(.1,1,.95),this.dirLight.position.set(-1,.75,1),this.dirLight.position.multiplyScalar(50)},CLOUD.Scene.prototype.updateDefaultLight=function(e){var t=this.dirLight;t.intensity=t.initIntensity*CLOUD.GlobalData.LightIntensityFactor,t.position.set(e.x,e.y,e.z),t.updateMatrixWorld(!0);var i=this.hemisphereLight;i.intensity=i.initIntensity*CLOUD.GlobalData.LightIntensityFactor},CLOUD.Scene.prototype.setupCommonLight=function(){this.ambientLight||(this.ambientLight=new THREE.AmbientLight(16777215,.6)),this.ambientLight.intensity=.6,this.add(this.ambientLight),this.lightArray.push(this.ambientLight),this.sunLight||(this.sunLight=new THREE.DirectionalLight(16777215,1)),this.add(this.sunLight),this.lightArray.push(this.sunLight),this.sunLight.color.setHex(14800580),this.sunLight.position.set(-100,160,100),this.sunLight.intensity=.72,this.sunLight.distance=300,this.sunLight.updateMatrixWorld()},CLOUD.Scene.prototype.lightPreset01=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=1,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.24,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.6,this.sunLight.intensity=.9},CLOUD.Scene.prototype.lightPreset02=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.position.set(60,80,130),this.fillLight01.intensity=.28,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(8100788),this.fillLight02.position.set(100,80,-100),this.fillLight02.intensity=.22,this.fillLight02.updateMatrixWorld(),this.fillLight03||(this.fillLight03=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight03),this.lightArray.push(this.fillLight03),this.fillLight03.color.setHex(8100788),this.fillLight03.position.set(-140,80,-50),this.fillLight03.intensity=.18,this.fillLight03.updateMatrixWorld()},CLOUD.Scene.prototype.lightPreset03=function(){this.setupCommonLight(),this.fillLight01||(this.fillLight01=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight01),this.lightArray.push(this.fillLight01),this.fillLight01.color.setHex(16777215),this.fillLight01.position.set(100,100,100),this.fillLight01.intensity=.75,this.fillLight01.updateMatrixWorld(),this.fillLight02||(this.fillLight02=new THREE.DirectionalLight(16777215,1)),this.add(this.fillLight02),this.lightArray.push(this.fillLight02),this.fillLight02.color.setHex(16777215),this.fillLight02.position.set(-100,100,-100),this.fillLight02.intensity=.21,this.fillLight02.updateMatrixWorld(),this.ambientLight.intensity=.4,this.sunLight.intensity=.56},CLOUD.Scene.prototype.lightPreset=function(){switch(this.clearLight(),CLOUD.GlobalData.LightPreset){case 0:this.defaultLightPreset();break;case 1:this.lightPreset01();break;case 2:this.lightPreset02();break;case 3:this.lightPreset03();break;default:this.setupCommonLight(),this.sunLight.color.setHex(16777215),this.ambientLight.intensity=.72}this.lightHelper&&this.addLightHelper()},CLOUD.Scene.prototype.clearLightHelper=function(){for(var e=0;e<this.lightHelperArray.length;e++){var t=this.lightHelperArray[e];this.remove(t)}this.lightHelperArray=[]},CLOUD.Scene.prototype.addLightHelper=function(){this.clearLightHelper();for(var e=0;e<this.lightArray.length;++e){var t=this.lightArray[e];if(t instanceof THREE.DirectionalLight){var i=new THREE.DirectionalLightHelper(t,200);this.add(i),this.lightHelperArray.push(i)}}},CLOUD.Scene.prototype.updateLightHelper=function(){for(var e=0;e<this.lightHelperArray.length;++e){var t=this.lightHelperArray[e];t.update(),t.updateMatrixWorld(!0)}},CLOUD.Scene.prototype.updateLights=function(e){var t=new THREE.Vector3(0,1,0),i=Math.PI/4,n=e.position.clone();switch(n.sub(e.target),n.normalize(),CLOUD.GlobalData.LightPreset){case 0:this.updateDefaultLight(n);break;case 1:case 3:var r=n.clone().applyAxisAngle(t,-1.2*i);this.fillLight01.position.copy(r).normalize(),this.fillLight01.position.multiplyScalar(1e3),this.fillLight01.position.y=600,this.fillLight01.updateMatrixWorld(),r=n.clone().applyAxisAngle(t,1*i),this.fillLight02.position.copy(r).normalize(),this.fillLight02.position.multiplyScalar(1e3),this.fillLight02.position.y=600,this.fillLight02.updateMatrixWorld();break;case 2:break;default:var r=n.clone().applyAxisAngle(t,-2*i);this.sunLight.position.copy(r).normalize(),this.sunLight.position.multiplyScalar(1e3),this.sunLight.position.y=600,this.sunLight.updateMatrixWorld()}this.lightHelper&&this.updateLightHelper()},CLOUD.Scene.prototype.getOrCreateObjectGroup=function(e,t){for(var i=this.objectGroups.children,n=0,r=i.length;n<r;n++)if(i[n].name==e)return i[n];var a=new CLOUD.ObjectGroup(e,t);return a.isGlobalSpace()&&(a.matrix.copy(this.geometryGroup.matrix),a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),this.objectGroups.add(a),a},CLOUD.Scene.prototype.getObjectGroup=function(e){for(var t=this.objectGroups.children,i=0,n=t.length;i<n;i++)if(t[i].name==e)return t[i];return null},CLOUD.Scene.prototype.getObjectGroupType=function(e){var t=e.split("|");return{groupType:t[0],databagId:t.length>1?t[1]:void 0}},CLOUD.Scene.prototype.getObjectGroups=function(){return this.objectGroups.children},CLOUD.Scene.prototype.removeObjectGroup=function(e){this.objectGroups.remove(e)},CLOUD.Scene.prototype.removeObjectGroupByName=function(e){this.objectGroups.removeByName(e)},CLOUD.Scene.prototype.hasObjectGroup=function(e){return this.objectGroups.hasChild(e)},CLOUD.Scene.prototype.intersectToWorld=function(e,t){var i=this.getMatrixGlobal();e.worldPosition=CLOUD.GeomUtil.getWorldPositionOfMesh(e.point,i);var n=t.getComponentInfoByUserId(e.userId);n&&(e.worldBoundingBox=n.boundingBox.clone())},CLOUD.Scene.prototype.worldToDrawing=function(e){var t=this.getMatrixGlobal(),i=new THREE.Vector3(e.x,e.y,e.z);return i.applyMatrix4(t),i},CLOUD.Scene.prototype.drawingToWorld=function(e){var t=this.getMatrixGlobal(),i=new THREE.Matrix4;i.getInverse(t);var n=new THREE.Vector3(e.x,e.y,e.z);return n.applyMatrix4(i),n},CLOUD.Scene.prototype.getBoundingBoxWorldByMesh=function(e){var t=this.getMatrixGlobal(),i=e.boundingBox;i||(e.geometry.boundingBox||e.geometry.computeBoundingBox(),i=e.geometry.boundingBox);var n=i.clone();n.applyMatrix4(e.matrixWorld);var r=new THREE.Matrix4;return r.getInverse(t),n.applyMatrix4(r),n},CLOUD.Scene.prototype.getObjectPool=function(){return this.pool},CLOUD.Scene.prototype.setBoundingBoxWorld=function(e){this.geometryGroup.boundingBox?this.geometryGroup.boundingBox.copy(e):this.geometryGroup.boundingBox=e},CLOUD.Scene.prototype.getBoundingBoxOfGeometries=function(e){for(var t=!e,i=new THREE.Box3,n=this.pool._pool,r=0,a=this.pool.counter;r<a;++r){var o=n[r];if(o.isVisible()){var s=o.geometry;if(s){if(t||void 0!==e[o.name]){s.boundingBox||s.computeBoundingBox();var l=s.boundingBox;if(l){var c=l.clone();o.matrixWorld&&c.applyMatrix4(o.matrixWorld),i.expandByPoint(c.min),i.expandByPoint(c.max)}}}else CLOUD.Logger.log("empty geometry!")}}return i},CLOUD.Scene.prototype.getTransformMatrixGlobal=function(){return this.transformMatrix},CLOUD.Scene.prototype.setTransformMatrixGlobal=function(e){this.transformMatrix.copy(e)},CLOUD.Scene.prototype.adjustInstanceVisibility=function(e){function t(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&t.geometry instanceof THREE.InstancedBufferGeometry){var i=t.visible;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}this.traverse(t)},CLOUD.Scene.prototype.adjustVisibility=function(e){function t(t){if((t instanceof THREE.Mesh||t instanceof THREE.LineSegments)&&!(t.geometry instanceof THREE.InstancedBufferGeometry)){var i=t.visible;e&&!t.bVisible||(t.visible=e),t.bVisible=i}}this.traverse(t)},CLOUD.Scene.prototype.changeVisibilityOfSelectedObjects=function(e){function t(e){if(e._indicesGroup&&e.visible){var t=[],i=e.geometry.groups;if(i&&i.length){for(var n=0,r=i.length;n<r;n++){var a=i[n];a.materialIndex===CLOUD.Model.EnumFilterState.SELECTED&&(t.push({idx:n,start:a.start,count:a.count}),a.start=0,a.count=0)}t.length&&s.push({object:e,indices:t})}}}function i(e){for(var t=0,i=o.selectedMeshes.length;t<i;t++){if(e===o.selectedMeshes[t].object)for(var n=o.selectedMeshes[t].indices,r=0,a=n.length;r<a;r++){var s=n[r],l=e.geometry.groups[s.idx];l.start=s.start,l.count=s.count}}}function n(e){if(e.visible){for(var t=[],i=e.geometry.getAttribute("vState").array,n=0;n<i.length;++n)i[n]===CLOUD.EnumInstanceState.SELECTED&&(t.push(n),i[n]=CLOUD.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,l.push({object:e,indices:t}))}}function r(e){for(var t=0,i=o.selectedInstanceMeshes.length;t<i;t++){if(e===o.selectedInstanceMeshes[t].object){for(var n=o.selectedInstanceMeshes[t].indices,r=e.geometry.getAttribute("vState").array,a=0,s=n.length;a<s;a++)r[n[a]]=CLOUD.EnumInstanceState.SELECTED;e.geometry.getAttribute("vState").needsUpdate=!0}}}function a(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?r(a):n(a):e?i(a):t(a))}var o=this;e||(o.selectedMeshes.length=0,o.selectedInstanceMeshes.length=0);var s=o.selectedMeshes,l=o.selectedInstanceMeshes;this.traverse(a)},CLOUD.Scene.prototype.changeVisibilityOfNonSelectedObjects=function(e){function t(e){if(e._indicesGroup&&e.visible){var t=[],i=e.geometry.groups;if(i&&i.length){for(var n=0,r=i.length;n<r;n++){var a=i[n];a.materialIndex!==CLOUD.Model.EnumFilterState.SELECTED&&(t.push({idx:n,start:a.start,count:a.count}),a.start=0,a.count=0)}t.length?s.push({object:e,indices:t}):(e.visible=!1,s.push({object:e,indices:null}))}else e.visible=!1,s.push({object:e,indices:null})}}function i(e){for(var t=0,i=o.nonSelectedMeshes.length;t<i;t++){if(e===o.nonSelectedMeshes[t].object){var n=o.nonSelectedMeshes[t].indices;if(null===n)e.visible=!0;else for(var r=0,a=n.length;r<a;r++){var s=n[r],l=e.geometry.groups[s.idx];l.start=s.start,l.count=s.count}}}}function n(e){if(e.visible){for(var t=[],i=e.geometry.getAttribute("vState").array,n=0,r=i.length;n<r;++n)i[n]!==CLOUD.EnumInstanceState.SELECTED&&i[n]!==CLOUD.EnumInstanceState.HIDDEN&&(t.push({idx:n,state:i[n]}),i[n]=CLOUD.EnumInstanceState.HIDDEN);t.length&&(e.geometry.getAttribute("vState").needsUpdate=!0,l.push({object:e,indices:t}))}}function r(e){for(var t=0,i=o.nonSelectedInstanceMeshes.length;t<i;t++){if(e===o.nonSelectedInstanceMeshes[t].object){for(var n=o.nonSelectedInstanceMeshes[t].indices,r=e.geometry.getAttribute("vState").array,a=0,s=n.length;a<s;a++)r[n[a].idx]=n[a].state;e.geometry.getAttribute("vState").needsUpdate=!0}}}function a(a){(a instanceof THREE.Mesh||a instanceof THREE.LineSegments)&&(a.geometry instanceof THREE.InstancedBufferGeometry?e?r(a):n(a):e?i(a):t(a))}var o=this;e||(o.nonSelectedMeshes.length=0,o.nonSelectedInstanceMeshes.length=0);var s=o.nonSelectedMeshes,l=o.nonSelectedInstanceMeshes;this.traverse(a)},CLOUD.Scene.prototype.clearSelectedAndNonSelectedMeshes=function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0,this.selectedInstanceMeshes.length=0,this.nonSelectedInstanceMeshes.length=0},CLOUD.Raycaster=function(e,t,i,n){this.ray=new THREE.Ray(e,t),this.near=i||0,this.far=n||1/0,this.params={Sprite:{},Mesh:{},Points:{threshold:1},LOD:{},Line:{}}},CLOUD.Raycaster.prototype={constructor:CLOUD.Raycaster,precision:1e-4,linePrecision:1,descSort:function(e,t){return e.distance-t.distance},set:function(e,t){this.ray.set(e,t)},setFromCamera:function(e,t){t instanceof CLOUD.CombinedCamera?t.isPerspective?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):t instanceof THREE.PerspectiveCamera?(this.ray.origin.copy(t.position),this.ray.direction.set(e.x,e.y,.5).unproject(t).sub(t.position).normalize()):t instanceof THREE.OrthographicCamera?(this.ray.origin.set(e.x,e.y,(t.near+t.far)/(t.near-t.far)).unproject(t),this.ray.direction.set(0,0,-1).transformDirection(t.matrixWorld)):console.error("CLOUD.Raycaster: Unsupported camera type.")},intersectOctantForNode:function(e,t){function i(e){var a,o;if(r.set(e.min,e.max),n.ray.intersectBox(r)&&(t.push(e),e.childOctants))for(a=0,o=e.childOctants.length;a<o;a++)i(e.childOctants[a])}var n=this,r=new THREE.Box3;i(e)}},THREE.Ray.prototype.intersectBoxWithDistance=function(e){var t,i,n,r,a,o,s=1/this.direction.x,l=1/this.direction.y,c=1/this.direction.z,u=this.origin;if(s>=0?(t=(e.min.x-u.x)*s,i=(e.max.x-u.x)*s):(t=(e.max.x-u.x)*s,i=(e.min.x-u.x)*s),l>=0?(n=(e.min.y-u.y)*l,r=(e.max.y-u.y)*l):(n=(e.max.y-u.y)*l,r=(e.min.y-u.y)*l),t>r||n>i)return-1;if((n>t||t!==t)&&(t=n),(r<i||i!==i)&&(i=r),c>=0?(a=(e.min.z-u.z)*c,o=(e.max.z-u.z)*c):(a=(e.max.z-u.z)*c,o=(e.min.z-u.z)*c),t>o||a>i)return-1;if((a>t||t!==t)&&(t=a),(o<i||i!==i)&&(i=o),i<0)return-1;if(t<0)return 0;var h=this.at(t>=0?t:i),d=h.x-u.x,f=h.y-u.y,p=h.z-u.z;return Math.sqrt(d*d+f*f+p*p)},CLOUD.PhongLightingMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="PhoneLightingMaterial",this.color=new THREE.Color(16777215),this.specular=new THREE.Color(1118481),this.shininess=30,this.emissive=new THREE.Color(0),this.map=null,this.defines={},this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.lights,{diffuse:{value:new THREE.Color(16711680)},opacity:{value:1},specular:{value:new THREE.Color(1118481)},shininess:{value:30},emissive:{value:new THREE.Color(0)}}]),this.vertexShader=["varying vec3 vViewPosition;","varying vec3 vNormal;","#include <uv_pars_vertex>","void main() {","   #include <uv_vertex>","   #include <begin_vertex>","   #include <project_vertex>","   #include <beginnormal_vertex>","   #include <defaultnormal_vertex>","   vNormal = normalize( transformedNormal );","   vViewPosition = - mvPosition.xyz;","}"].join("\n"),this.fragmentShader=["uniform vec3 diffuse;","uniform float opacity;","uniform vec3 specular;","uniform float shininess;","uniform vec3 emissive;","#include <common>","#include <uv_pars_fragment>","#include <map_pars_fragment>","#include <packing>","#include <bsdfs>","#include <lights_pars>","#include <lights_phong_pars_fragment>","#include <specularmap_pars_fragment>","void main() {","   vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4(texelColor.rgb, opacity);","#endif","   ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","   vec3 totalEmissiveRadiance = emissive;","   float specularStrength = 1.0;","   #include <normal_flip>","   #include <normal_fragment>","   #include <lights_phong_fragment>","   #include <lights_template>","   vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","   gl_FragColor = vec4( outgoingLight, diffuseColor.a );","   #if defined( TONE_MAPPING )","       gl_FragColor.rgb = toneMapping( gl_FragColor.rgb );","   #endif","   gl_FragColor = linearToOutputTexel( gl_FragColor );","}"].join("\n"),this.lights=!0,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("PhoneLightingMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},CLOUD.PhongLightingMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),CLOUD.PhongLightingMaterial.prototype.constructor=CLOUD.PhongLightingMaterial,CLOUD.PhongLightingMaterial.prototype.isShaderMaterial=!0,CLOUD.PhongLightingMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.specular.copy(e.specular),this.shininess=e.shininess,this.emissive.copy(e.emissive),this},CLOUD.PhongLightingMaterial.prototype.refreshUniforms=function(){this.uniforms.diffuse.value.set(this.color),this.uniforms.opacity.value=this.opacity,this.uniforms.specular.value.set(this.specular),this.uniforms.shininess.value=this.shininess,this.uniforms.emissive.value.set(this.emissive),this.uniforms.map.value=this.map}
;var lights_fillFace_template=["GeometricContext geometry;","geometry.position = - vViewPosition;","#if NUM_CLIPPING_PLANES == 1","\tif (gl_FrontFacing) geometry.normal = normal;","\telse if (fillFaceClipDistance < 0.0) geometry.normal = -clippingPlanes[0].xyz;","\telse geometry.normal = -normal;","#else","\tgeometry.normal = normal;","#endif","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","\tPointLight pointLight;","\tfor ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {","\t\tpointLight = pointLights[ i ];","\t\tgetPointDirectLightIrradiance( pointLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","\tSpotLight spotLight;","\tfor ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","\t\tspotLight = spotLights[ i ];","\t\tgetSpotDirectLightIrradiance( spotLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","\t\t#endif","\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","\tDirectionalLight directionalLight;","\tfor ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","\t\tdirectionalLight = directionalLights[ i ];","\t\tgetDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","\t\t#ifdef USE_SHADOWMAP","\t\tdirectLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","\t\t#endif","\t\tRE_Direct( directLight, geometry, material, reflectedLight );","\t}","#endif","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","\tRectAreaLight rectAreaLight;","\tfor ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","\t\trectAreaLight = rectAreaLights[ i ];","\t\tRE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","\t}","#endif","#if defined( RE_IndirectDiffuse )","\tvec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","\t#ifdef USE_LIGHTMAP","\t\tvec3 lightMapIrradiance = texture2D( lightMap, vUv2 ).xyz * lightMapIntensity;","\t\t#ifndef PHYSICALLY_CORRECT_LIGHTS","\t\t\tlightMapIrradiance *= PI; // factor of PI should not be present; included here to prevent breakage","\t\t#endif","\t\tirradiance += lightMapIrradiance;","\t#endif","\t#if ( NUM_HEMI_LIGHTS > 0 )","\t\tfor ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","\t\t\tirradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","\t\t}","\t#endif","\t#if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","\t\tirradiance += getLightProbeIndirectIrradiance( /*lightProbe,*/ geometry, 8 );","\t#endif","\tRE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","#endif","#if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","\tvec3 radiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, Material_BlinnShininessExponent( material ), 8 );","\t#ifndef STANDARD","\t\tvec3 clearCoatRadiance = getLightProbeIndirectRadiance( /*specularLightProbe,*/ geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );","\t#else","\t\tvec3 clearCoatRadiance = vec3( 0.0 );","\t#endif","\tRE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","#endif"].join("\n"),fillFaceFragment=["#define PHONG","uniform vec3 diffuse;","uniform vec3 emissive;","uniform vec3 specular;","uniform float shininess;","uniform float opacity;","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <gradientmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <lights_pars>","#include <lights_phong_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","\t#include <clipping_planes_fragment>","\tvec4 diffuseColor = vec4( diffuse, opacity );","\tReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","\tvec3 totalEmissiveRadiance = emissive;","\t#include <logdepthbuf_fragment>","\t#include <map_fragment>","\t#include <color_fragment>","\t#include <alphamap_fragment>","\t#include <alphatest_fragment>","\t#include <specularmap_fragment>","\t#include <normal_flip>","\t#include <normal_fragment>","\t#include <emissivemap_fragment>","   float fillFaceClipDistance = 0.0;","   #if NUM_CLIPPING_PLANES == 1","       vec4 plane = clippingPlanes[ 0 ];","\t    fillFaceClipDistance = dot( vViewPosition, plane.xyz ) - plane.w;","   #endif","\t#include <lights_phong_fragment>","\t#include <lights_fillFace_template>","\t#include <aomap_fragment>","\tvec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","\t#include <envmap_fragment>","\tgl_FragColor = vec4( outgoingLight, diffuseColor.a );","\t#include <tonemapping_fragment>","\t#include <encodings_fragment>","\t#include <fog_fragment>","\t#include <premultiplied_alpha_fragment>","\t#include <dithering_fragment>","}"].join("\n"),meshphongIdVertex=["#define PHONG","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <envmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <envmap_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),newStyleVertex=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <begin_vertex>","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),newStyleFragment=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","void main() {","#include <clipping_planes_fragment>","vec4 diffuseColor = vec4( diffuse, opacity );","vec3 totalEmissiveRadiance = emissive;","#include <logdepthbuf_fragment>","#include <map_fragment>","#include <color_fragment>","#include <alphamap_fragment>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","#include <normal_flip>","#include <normal_fragment>","#include <emissivemap_fragment>","const mat4 diffuseMatrix = mat4(-0.07425443828105927, -0.05652861297130585, 0.12247831374406815, 0.2297295778989792,","                               -0.05652860924601555, 0.034799136221408844, -0.08437120914459229, -0.13896968960762024,","                               0.12247832119464874, -0.08437121659517288, 0.021763987839221954, 0.12510454654693604,","                               0.2297295778989792, -0.13896968960762024, 0.12510454654693604, 0.6190560460090637);","const vec3 sunDir = vec3(-0.6632131338119507, 0.5486575961112976, -0.509041428565979);","vec3 viewDir = normalize( vViewPosition );","vec4 diffuseDir = diffuseMatrix * vec4(normal, 1.0);","float diffuseTerm = dot(vec4(normal, 1.0), diffuseDir);","float nv = max(dot(normal, -viewDir), 0.0);","float vl = max(dot(viewDir, sunDir), 0.0);","diffuseTerm = diffuseTerm + (nv * (1.0 - vl)) * 0.8;","vec3 H = -normalize(sunDir + viewDir);","float nh = max(dot(normal, H), 0.0);","float specularTerm = pow(nh, 100.0);","vec3 color = 1.05 * vec3(0.5, 0.497, 0.49) * (diffuse * diffuseTerm + vec3(specularTerm)) + diffuse * 0.5;","vec3 outgoingLight = color + totalEmissiveRadiance;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#include <tonemapping_fragment>","#include <encodings_fragment>","#include <fog_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","}"].join("\n"),cloudStandardVertex=["#define PHYSICAL","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   attribute float vState;","   attribute float vState2;","   varying float fState;","   attribute vec4 aColor;","   varying vec4 vaColor;","   attribute vec3 mcol0;","   attribute vec3 mcol1;","   attribute vec3 mcol2;","   attribute vec3 mcol3;","   #if defined(USE_MAP)||defined(USE_BUMPMAP) ","       attribute vec2 muvCol0;","       attribute vec2 muvCol1;","       attribute vec2 muvCol2;","   #endif","#endif","#include <common>","#include <uv_pars_vertex>","#include <uv2_pars_vertex>","#include <displacementmap_pars_vertex>","#include <color_pars_vertex>","#include <fog_pars_vertex>","#include <morphtarget_pars_vertex>","#include <skinning_pars_vertex>","#include <shadowmap_pars_vertex>","#include <specularmap_pars_fragment>","#include <logdepthbuf_pars_vertex>","#include <clipping_planes_pars_vertex>","mat3 inverse_mat3(in mat3 m)","{","   float determinant =","    m[0][0] * (m[1][1] * m[2][2] - m[2][1] * m[1][2])","    - m[1][0] * (m[0][1] * m[2][2] - m[2][1] * m[0][2])","    + m[2][0] * (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    mat3 inverse;","    inverse[0][0] = + (m[1][1] * m[2][2] - m[2][1] * m[1][2]);","    inverse[1][0] = - (m[1][0] * m[2][2] - m[2][0] * m[1][2]);","    inverse[2][0] = + (m[1][0] * m[2][1] - m[2][0] * m[1][1]);","    inverse[0][1] = - (m[0][1] * m[2][2] - m[2][1] * m[0][2]);","    inverse[1][1] = + (m[0][0] * m[2][2] - m[2][0] * m[0][2]);","    inverse[2][1] = - (m[0][0] * m[2][1] - m[2][0] * m[0][1]);","    inverse[0][2] = + (m[0][1] * m[1][2] - m[1][1] * m[0][2]);","    inverse[1][2] = - (m[0][0] * m[1][2] - m[1][0] * m[0][2]);","    inverse[2][2] = + (m[0][0] * m[1][1] - m[1][0] * m[0][1]);","    inverse /= determinant;","    return inverse;","}","void main() {","#include <uv_vertex>","#include <uv2_vertex>","#include <color_vertex>","#include <beginnormal_vertex>","#include <morphnormal_vertex>","#include <skinbase_vertex>","#include <skinnormal_vertex>","#include <defaultnormal_vertex>","#if (defined(USE_MAP)||defined(USE_BUMPMAP)) && defined(USE_INSTANCE)  ","   vUv = vec2(mat3(vec3(muvCol0, 0.0),","                   vec3(muvCol1, 0.0),","                   vec3(muvCol2, 1.0)) * vec3(uv, 1.0));","   vUv = mat2(rotateMatrix) * vec2(vUv.x - 0.5, vUv.y - 0.5) + vec2(0.5, 0.5);","   vUv = (vUv -  offsetRepeat.xy)* offsetRepeat.zw;","#endif","vec3 transformed = vec3( position );","#ifdef USE_INSTANCE","vaColor = aColor;","#ifdef INSTANCE_STATE_SECONDARY","fState = vState2;","#else","fState = vState;","#endif","transformed = vec3(mat4(vec4(mcol0, 0.0),","                   vec4(mcol1, 0.0),","                   vec4(mcol2, 0.0),","                   vec4(mcol3, 1.0)) * vec4(transformed, 1.0));","#ifdef USE_INSTANCE_NORMAL","    mat3 normalMat = mat3(mcol0, mcol1, mcol2);","    normalMat = inverse_mat3(normalMat);","    normalMat = transpose(normalMat);","    transformedNormal = normalMat * objectNormal;","    transformedNormal = normalMatrix * transformedNormal;","#ifdef FLIP_SIDED","   transformedNormal = - transformedNormal;","#endif","    transformedNormal = normalize( transformedNormal );","#endif","#endif","#ifndef FLAT_SHADED","vNormal = normalize( transformedNormal );","#endif","#include <displacementmap_vertex>","#include <morphtarget_vertex>","#include <skinning_vertex>","#include <project_vertex>","#include <logdepthbuf_vertex>","#include <clipping_planes_vertex>","vViewPosition = - mvPosition.xyz;","#include <worldpos_vertex>","#include <shadowmap_vertex>","#include <fog_vertex>","}"].join("\n"),cloudStandardFragment=["#define PHYSICAL","uniform vec3 diffuse;","uniform vec3 emissive;","uniform float roughness;","uniform float metalness;","uniform float opacity;","uniform float imageFade;","#ifndef STANDARD","uniform float clearCoat;","uniform float clearCoatRoughness;","#endif","varying vec3 vViewPosition;","#ifndef FLAT_SHADED","varying vec3 vNormal;","#endif","#ifdef USE_INSTANCE","   varying vec4 vaColor;","   varying float fState;","#endif","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","uniform vec4 blinkColor;","uniform float colorState;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","#include <common>","#include <packing>","#include <dithering_pars_fragment>","#include <color_pars_fragment>","#include <uv_pars_fragment>","#include <uv2_pars_fragment>","#include <map_pars_fragment>","#include <alphamap_pars_fragment>","#include <aomap_pars_fragment>","#include <lightmap_pars_fragment>","#include <emissivemap_pars_fragment>","#include <envmap_pars_fragment>","#include <fog_pars_fragment>","#include <bsdfs>","#include <cube_uv_reflection_fragment>","#include <lights_pars>","#include <lights_physical_pars_fragment>","#include <shadowmap_pars_fragment>","#include <bumpmap_pars_fragment>","#include <normalmap_pars_fragment>","#include <roughnessmap_pars_fragment>","#include <metalnessmap_pars_fragment>","#include <logdepthbuf_pars_fragment>","#include <clipping_planes_pars_fragment>","vec3 hdrDecode(in vec4 rgbm) {","const float rgbmScale = 2.82842712;","vec3 r = rgbm.rgb * (rgbmScale * (1.0 - rgbm.a));","return r * r;","}","vec3 linearToGammaUnreal(in vec3 rgb) {","    return rgb / (rgb + 0.187) * 1.035;","}","bool floatEqual(in float x, in float y) {","    return (x >= y - 0.01) && (x <= y + 0.01);","}","bool floatNotEqual(in float x, in float y) {","    return (x <= y - 0.01) || (x >= y + 0.01);","}","void main() {","#include <clipping_planes_fragment>","vec4 diffuseColor = vec4( diffuse, opacity );","#ifdef USE_INSTANCE","   if (floatEqual(fState, -1.0)) ","       discard;","   if (floatNotEqual(fState, 0.0)) ","       diffuseColor = vaColor;","#endif","vec4 selectedColor = diffuseColor;","diffuseColor.rgb = pow(diffuseColor.rgb, vec3(GAMMA_FACTOR));","ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );","vec3 totalEmissiveRadiance = emissive;","#include <logdepthbuf_fragment>","#ifdef USE_MAP","   vec4 texelColor = texture2D( map, vUv );","   texelColor = mapTexelToLinear( texelColor );","   diffuseColor = vec4( mix(diffuseColor.rgb , texelColor.rgb, imageFade), opacity);","   #ifdef USE_INSTANCE","       if (floatNotEqual(fState, 0.0)) ","           diffuseColor.a = vaColor.a;","   #endif","#endif","#include <color_fragment>","#include <alphamap_fragment>","#include <alphatest_fragment>","#include <specularmap_fragment>","#include <roughnessmap_fragment>","#include <metalnessmap_fragment>","float flipNormal = 1.0;","#include <normal_fragment>","#include <emissivemap_fragment>","#include <lights_physical_fragment>"," GeometricContext geometry;","geometry.position = - vViewPosition;","geometry.normal = normal;","geometry.viewDir = normalize( vViewPosition );","IncidentLight directLight;","#if ( NUM_POINT_LIGHTS > 0 ) && defined( RE_Direct )","PointLight pointLight;","for ( int i = 0; i < NUM_POINT_LIGHTS; i ++ ) {"," pointLight = pointLights[ i ];","getPointDirectLightIrradiance( pointLight, geometry, directLight );","#ifdef USE_SHADOWMAP","        directLight.color *= all( bvec2( pointLight.shadow, directLight.visible ) ) ? getPointShadow( pointShadowMap[ i ], pointLight.shadowMapSize, pointLight.shadowBias, pointLight.shadowRadius, vPointShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_SPOT_LIGHTS > 0 ) && defined( RE_Direct )","    SpotLight spotLight;","    for ( int i = 0; i < NUM_SPOT_LIGHTS; i ++ ) {","        spotLight = spotLights[ i ];","        getSpotDirectLightIrradiance( spotLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        directLight.color *= all( bvec2( spotLight.shadow, directLight.visible ) ) ? getShadow( spotShadowMap[ i ], spotLight.shadowMapSize, spotLight.shadowBias, spotLight.shadowRadius, vSpotShadowCoord[ i ] ) : 1.0;","        #endif","        RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_DIR_LIGHTS > 0 ) && defined( RE_Direct )","    DirectionalLight directionalLight;","    for ( int i = 0; i < NUM_DIR_LIGHTS; i ++ ) {","        directionalLight = directionalLights[ i ];","        getDirectionalDirectLightIrradiance( directionalLight, geometry, directLight );","        #ifdef USE_SHADOWMAP","        directLight.color *= all( bvec2( directionalLight.shadow, directLight.visible ) ) ? getShadow( directionalShadowMap[ i ], directionalLight.shadowMapSize, directionalLight.shadowBias, directionalLight.shadowRadius, vDirectionalShadowCoord[ i ] ) : 1.0;","        #endif","       RE_Direct( directLight, geometry, material, reflectedLight );","    }","#endif","#if ( NUM_RECT_AREA_LIGHTS > 0 ) && defined( RE_Direct_RectArea )","   RectAreaLight rectAreaLight;","    for ( int i = 0; i < NUM_RECT_AREA_LIGHTS; i ++ ) {","        rectAreaLight = rectAreaLights[ i ];","        RE_Direct_RectArea( rectAreaLight, geometry, material, reflectedLight );","    }","#endif","#if defined( RE_IndirectDiffuse )","    vec3 irradiance = getAmbientLightIrradiance( ambientLightColor );","    #ifdef USE_LIGHTMAP","       vec3 lightMapIrradiance = hdrDecode(texture2D(lightMap, vUv2)) * lightMapIntensity ;","       #ifndef PHYSICALLY_CORRECT_LIGHTS","           lightMapIrradiance *= PI;","       #endif","       irradiance += lightMapIrradiance;","    #endif","    #if ( NUM_HEMI_LIGHTS > 0 )","       for ( int i = 0; i < NUM_HEMI_LIGHTS; i ++ ) {","           irradiance += getHemisphereLightIrradiance( hemisphereLights[ i ], geometry );","       }","    #endif","    #if defined( USE_ENVMAP ) && defined( PHYSICAL ) && defined( ENVMAP_TYPE_CUBE_UV )","       irradiance += getLightProbeIndirectIrradiance( geometry, 8 );","    #endif","    RE_IndirectDiffuse( irradiance, geometry, material, reflectedLight );","    #endif","    #if defined( USE_ENVMAP ) && defined( RE_IndirectSpecular )","    vec3 radiance = getLightProbeIndirectRadiance( geometry, Material_BlinnShininessExponent( material ), 8 );","    #ifndef STANDARD","    vec3 clearCoatRadiance = getLightProbeIndirectRadiance( geometry, Material_ClearCoat_BlinnShininessExponent( material ), 8 );","    #else","    vec3 clearCoatRadiance = vec3( 0.0 );","    #endif","    RE_IndirectSpecular( radiance, clearCoatRadiance, geometry, material, reflectedLight );","    #endif","#include <aomap_fragment>","vec3 outgoingLight = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse + reflectedLight.directSpecular + reflectedLight.indirectSpecular + totalEmissiveRadiance;","gl_FragColor = vec4( outgoingLight, diffuseColor.a );","#ifdef USE_INSTANCE","    #ifdef USE_MAP","         if (floatEqual(fState, 3.0))","             gl_FragColor = vaColor;","    #endif","#endif","#if defined( TONE_MAPPING )","   #if defined(USE_LIGHTMAP)","       gl_FragColor.rgb = linearToGammaUnreal(gl_FragColor.rgb );","   #else","       gl_FragColor.rgb = toneMapCanonFilmic( gl_FragColor.rgb );","   #endif","#endif","#ifdef USE_INSTANCE","       if (floatEqual(fState, 2.0))","           gl_FragColor = selectedColor;","       if (floatEqual(fState, 5.0) && floatEqual(colorState, 1.0))","           gl_FragColor = blinkColor;","#else","       if (floatEqual(colorState, 1.0))","           gl_FragColor = blinkColor;","       if (floatEqual(colorState, 2.0))","           gl_FragColor = selectedColor;","#endif","#include <encodings_fragment>","#include <fog_fragment>","#include <premultiplied_alpha_fragment>","#include <dithering_fragment>","}"].join("\n");THREE.ShaderChunk.meshphong_id_vert=meshphongIdVertex,THREE.ShaderChunk.lights_fillFace_template=lights_fillFace_template,THREE.ShaderChunk.fillFaceFragment=fillFaceFragment,THREE.ShaderChunk.cloudStandardVertex=cloudStandardVertex,THREE.ShaderChunk.cloudStandardFragment=cloudStandardFragment,THREE.ShaderChunk.newStyleVertex=newStyleVertex,THREE.ShaderChunk.newStyleFragment=newStyleFragment,THREE.ShaderLib.fillFacePhong={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.gradientmap,THREE.UniformsLib.fog,THREE.UniformsLib.lights,{emissive:{value:new THREE.Color(0)},specular:{value:new THREE.Color(1118481)},shininess:{value:30}}]),vertexShader:THREE.ShaderChunk.meshphong_id_vert,fragmentShader:THREE.ShaderChunk.fillFaceFragment},THREE.ShaderLib.newStyle={vertexShader:THREE.ShaderChunk.newStyleVertex,fragmentShader:THREE.ShaderChunk.newStyleFragment},THREE.ShaderLib.cloudStandard={vertexShader:THREE.ShaderChunk.cloudStandardVertex,fragmentShader:THREE.ShaderChunk.cloudStandardFragment},CLOUD.CloudStandardMaterial=function(e){THREE.MeshStandardMaterial.call(this),this.type="cloudStandard",this.roughness=1,this.metalness=0,this.originRoughness=1,this.originMetalness=0,this.pureColor=0,this.textureColor=0,this.imageFade=1,this.shift=.5,this.A=.64,this.B=.03,this.C=.02,this.D=.54,this.E=0,this.F=.81,this.scale=.92;var t=(new THREE.Color).setHex(3330982),i=[t.r,t.g,t.b,1];this.colorState=CLOUD.EnumShaderColorState.NONE,this.blinkColor=(new THREE.Vector4).fromArray(i),this.uniforms=THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.aomap,THREE.UniformsLib.lightmap,THREE.UniformsLib.emissivemap,THREE.UniformsLib.bumpmap,THREE.UniformsLib.normalmap,THREE.UniformsLib.displacementmap,THREE.UniformsLib.roughnessmap,THREE.UniformsLib.metalnessmap,THREE.UniformsLib.fog,{emissive:{value:new THREE.Color(0)},roughness:{value:.5},metalness:{value:.5},envMapIntensity:{value:1}},{shift:{value:.5},A:{value:.64},B:{value:.03},C:{value:.02},D:{value:.54},E:{value:0},F:{value:.81},scale:{value:.92},colorState:{value:0},blinkColor:{value:(new THREE.Vector4).fromArray(i)},imageFade:{value:1}}]),this.vertexShader=THREE.ShaderChunk.cloudStandardVertex,this.fragmentShader=THREE.ShaderChunk.cloudStandardFragment,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.lights&&(this.uniforms=THREE.UniformsUtils.merge([this.uniforms,THREE.UniformsLib.lights]))},CLOUD.CloudStandardMaterial.prototype=Object.create(THREE.MeshStandardMaterial.prototype),CLOUD.CloudStandardMaterial.prototype.constructor=CLOUD.CloudStandardMaterial,CLOUD.CloudStandardMaterial.prototype.copy=function(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this.colorState=e.colorState,this.blinkColor.copy(e.blinkColor),this.imageFade=e.imageFade,this},CLOUD.CloudStandardMaterial.prototype.refreshUniforms=function(){this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale,this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.colorState.value=this.colorState,this.uniforms.imageFade.value=this.imageFade},CLOUD.CloudStandardMaterial.prototype.setBlinkColor=function(e){this.blinkColor.fromArray(e.toArray()),this.uniforms.blinkColor.value.copy(this.blinkColor),this.uniforms.colorState.value=CLOUD.EnumShaderColorState.BLINK},CLOUD.CloudStandardMaterial.prototype.updateBlinkUniformValue=function(e,t){this.uniforms.colorState.value=e,this.uniforms.blinkColor.value.copy(t)},CLOUD.CloudStandardMaterial.prototype.resetBlinkUniformValue=function(){this.uniforms.colorState.value=this.colorState,this.uniforms.blinkColor.value.copy(this.blinkColor)},function(){function e(e){return e.replace("void main() {","\n            attribute float vState;            \n            attribute vec4 aColor;            \n            attribute vec3 mcol0;\n            attribute vec3 mcol1;\n            attribute vec3 mcol2;\n            attribute vec3 mcol3;\n            #if defined(USE_MAP)\n                attribute vec2 muvCol0;\n                attribute vec2 muvCol1;\n                attribute vec2 muvCol2;\n            #endif\n            \n            varying float vfState;\n            \n            vec3 getInstancePosition(vec3 position) {\n                return vec3(mat4(vec4(mcol0, 0.0),\n                                 vec4(mcol1, 0.0),\n                                 vec4(mcol2, 0.0),\n                                 vec4(mcol3, 1.0)) * vec4(position, 1.0));\n            }\n            \n            void main() {\n                vfState = vState;\n        ")}function t(e){return e.replace("#include <project_vertex>",n)}function i(e){return e.replace("void main() {","\n            varying float vfState;            \n            void main() {\n                if (vfState <= -0.99 && vfState >= -1.01) discard;\n                \n        ")}var n="\n        vec4 mvPosition = modelViewMatrix * vec4(getInstancePosition(transformed), 1.0);\n        gl_Position = projectionMatrix * mvPosition;\n    ",r=function(n){function r(n){_classCallCheck(this,r);var a=_possibleConstructorReturn(this,(r.__proto__||Object.getPrototypeOf(r)).call(this,n));return a.type="InstancedDepthMaterial",a.uniforms=THREE.ShaderLib.depth.uniforms,a.vertexShader=t(e(THREE.ShaderLib.depth.vertexShader)),a.fragmentShader=i(THREE.ShaderLib.depth.fragmentShader),a}return _inherits(r,n),r}(THREE.MeshDepthMaterial);CLOUD.InstancedDepthMaterial=r}(),CLOUD.MaterialSelector=function(){var e=[{name:"scene",param:{name:"scene",color:8947848,opacity:.4,transparent:!0,side:THREE.DoubleSide}},{name:"darkRed",param:{name:"darkRed",color:10496040,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"lightBlue",param:{name:"lightBlue",color:1275840,opacity:1,transparent:!1,side:THREE.DoubleSide}},{name:"black",param:{name:"black",color:0,opacity:.3,transparent:!0,side:THREE.DoubleSide}},{name:"add",param:{name:"add",color:65280,opacity:1,transparent:!0,side:THREE.DoubleSide}},{name:"delete",param:{name:"delete",color:16711680,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"beforeEdit",param:{name:"beforeEdit",color:16432389,opacity:.5,transparent:!0,side:THREE.DoubleSide}},{name:"afterEdit",param:{name:"afterEdit",color:16432389,opacity:1,transparent:!0,side:THREE.DoubleSide}}],t={};t.selection=CLOUD.MaterialUtil.createHighlightMaterial(),t.selection.name="selection";for(var i=0,n=e.length;i<n;++i){var r=e[i],a=r.name,o=r.param;t[a]=CLOUD.MaterialUtil.createStandardMaterial(o)}t.red=t.delete,t.green=t.add,t.yellow=t.beforeEdit,t.blue=t.selection;var s={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},l=CLOUD.MaterialUtil.createStandardMaterial(s);l.name="isolate";var c={color:8947848,opacity:.2,transparent:!0,side:THREE.DoubleSide},u=CLOUD.MaterialUtil.createStandardMaterial(c);u.name="frozen";var h={color:15293,side:THREE.DoubleSide},d=CLOUD.MaterialUtil.createStandardMaterial(h);d.name="selected",this.getDefaultMaterialName=function(){return"lightBlue"},this.get=function(e){return t[e]},this.getAll=function(){return t},this.add=function(e){var i,n,r={};return e&&e.hasOwnProperty("color")&&(r.color=e.color,r.side=THREE.DoubleSide,e.hasOwnProperty("opacity")&&(r.opacity=e.opacity,r.transparent=1!=e.opacity)),i=this._getMaterialName(e),n=t[i],n||(r.name=i,n=CLOUD.MaterialUtil.createStandardMaterial(r),t[i]=n),i},this.remove=function(e){var i,n;i=this._getMaterialName(e),(n=t[i])&&delete t[i]},this.has=function(e){return!!t[e]},this.getMaterialNameByColor=function(e){var i,n;return i=this._getMaterialName(e),n=t[i],n?i:this.add(e)},this.addOverrideMaterial=function(e){if(e){var i=e.name;t[i]||(t[i]=e)}},this.getMaterialParamsFromName=function(e){var t={},i=e.split("_");return"mat"==i[0]?(t.color=parseInt(i[1]),t.opacity=1):(t.color=parseInt(i[0]),t.opacity=parseFloat(i[1])),t},this._getMaterialName=function(e){
return e&&e.hasOwnProperty("color")?e.hasOwnProperty("opacity")?e.color+"_"+e.opacity:"mat_"+e.color:"mat_"+e},this.setFrozonMaterial=function(e){void 0!==e.color?u.color.setHex(e.color):u.color.setHex(c.color),void 0!==e.opacity?u.opacity=e.opacity:u.opacity=c.opacity,void 0!==e.transparent?u.transparent=e.transparent:u.transparent=c.transparent,void 0!==e.side?u.side=e.side:u.side=c.side,u.needsUpdate=!0},this.getFrozonMaterial=function(){return u},this.setSelectedMaterial=function(e){void 0!==e.color?d.color.setHex(e.color):d.color.setHex(h.color),void 0!==e.opacity?d.opacity=e.opacity:d.opacity=h.opacity,void 0!==e.transparent?d.transparent=e.transparent:d.transparent=h.transparent,void 0!==e.side?d.side=e.side:d.side=h.side,d.needsUpdate=!0},this.getSelectedMaterial=function(){return d},this.setIsolateMaterial=function(e){void 0!==e.color?l.color.setHex(e.color):l.color.setHex(s.color),void 0!==e.opacity?l.opacity=e.opacity:l.opacity=s.opacity,void 0!==e.transparent?l.transparent=e.transparent:l.transparent=s.transparent,void 0!==e.side?l.side=e.side:l.side=s.side,l.needsUpdate=!0},this.getIsolateMaterial=function(){return l},this.resetIsolateMaterial=function(){l.color.setHex(s.color),l.opacity=s.opacity,l.transparent=s.transparent,l.side=s.side,l.needsUpdate=!0}},CLOUD.EnumConditionType={HIDDEN_OTHERS:0,TRANSLUCENT_OTHERS:1,OVERRIDE:2,BORDERLINE:3},CLOUD.EnumIdBasedType={FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6},CLOUD.EnumUserType={HIDDEN_DATA:0,OVERRIDE_DATA:1},CLOUD.EnumIsolateState={HIDDEN:0,HIDDEN_OTHERS:1,TRANSLUCENT:2,TRANSLUCENT_OTHERS:3},CLOUD.EnumSceneState={DISABLED:0,TRANSLUCENT:1,HIDDEN:2},CLOUD.FilterManager=function(){this._filterImpl=new CLOUD.FilterManager2;var e=[],t=null,i=this._filterImpl.getMaterialSelector(),n=new CLOUD.ObjectInfoManager,r=new CLOUD.FilterManagerIO(i);this.setSceneStateHelper=function(e){},this.getFilterActionList=function(){return e},this.clearFilterActionList=function(){e=[]},this.initFilterManager=function(e){n.init(e)},this.reinitFilterManager=function(e){n.reinit(e)},this.clearFilterManager=function(){n.clearData()};var a=!1;this.isStateChanged=function(){return a},this.enableStateChanged=function(){a=!0},this.diableStateChanged=function(){a=!1},this.getIsolateFilterAction=function(){return t},this.setIsolateAction=function(e){t=e,t.apply()},this.getVisibleComponentsBbox=function(){return n.getVisibleComponentsBbox()},this.pushBack=function(i){var r=i.getClassName();"IsolateIdsFA"==r||"IsolateConditionFA"==r?t=i:e.push(i),a=!0,i.applyFilter(n)};var o=function(t){for(var i=0;i<e.length;){t==e[i].getClassName()?e.splice(i,1):i++}};this.showAll=function(){o("VisibleIdsFA"),o("VisibleConditionFA"),n.clearVisible(),n.calculateVisibleComponentsBbox(),this.enableStateChanged()},this.hideAll=function(){var e=new CLOUD.VisibleIdsFA(!1,!1);e.ids=[],this.pushBack(e)},this.getObjectInfoManager=function(){return n},this.getMatchIds=function(e){return n.getMatchIds(e)},this._isVisible=function(e){var t=e.name;return!n.isHidden(t)},this._isTransparent=function(e){var t=e.name;return n.isTransparent(t)},this._isSelectable=function(e){var t=e.name;return!n.isFrozen(t)},this._isSelectableById=function(e){return!n.isFrozen(e)},this._getOverrideMaterial=function(e){var t=e.name;return n.isFrozen(t)?this._filterImpl.getFrozonMaterial():n.getMaterial(t)},this._getMaterialName=function(e){return this._filterImpl._getMaterialName(e)},this._getMaterialByName=function(e){return this._filterImpl._getMaterialByName(e)},this._hasOverrideMaterial=function(e){var t=e.name;return n.hasOverrideMaterial(t)},this._hasHighPriorityOverrideMaterial=function(e){return this._filterImpl._hasHighPriorityOverrideMaterial(e)},this._isHiddenFileId=function(e){return this._filterImpl._isHiddenFileId(e)},this._isRenderPromotion=function(e){return this._filterImpl._isRenderPromotion(e)},this._isRenderWithBoardline=function(e){return this._filterImpl._isRenderWithBoardline(e)},this._hasHiddenFileIdFilter=function(){return this._filterImpl._hasHiddenFileIdFilter()},this._hasVisibleFilter=function(){return n.hasObjectHidden()},this._hasSelectableFilter=function(){return n.hasObjectCantSelected()},this._hasTransparentFilter=function(){return n.hasObjectTransparent()},this._hasOverrideMaterialFilter=function(){return n.hasOverrideMaterial()},this._hasLowPriorityOverride=function(){return this._filterImpl._hasLowPriorityOverride()},this._hasRenderPromotionFilter=function(){return this._filterImpl._hasRenderPromotionFilter()},this._hasRenderWithBoardlineFilter=function(){return this._filterImpl._hasRenderWithBoardlineFilter()},this.saveState=function(){return r.saveState(this)},this.loadState=function(e){r.loadState(e,this)},this.clear=function(){n.resetAll(),a=!0},this.clearAll=function(){return this.enableStateChanged(),this._filterImpl.clearAll()},this.clearIsolate=function(){n.clearIsolates()},this.clearFrozenList=function(){return this.enableStateChanged(),this._filterImpl.clearFrozenList()},this.addToFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.addToFrozenList(e)},this.removeFromFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.removeFromFrozenList(e)},this.setFrozenList=function(e){return this.enableStateChanged(),this._filterImpl.setFrozenList(e)},this.setFrozenConditions=function(e){this.enableStateChanged(),this._filterImpl.setFrozenConditions(e)},this.getFrozenConditions=function(){return this._filterImpl.getFrozenConditions()},this.clearFrozenConditions=function(){this.enableStateChanged(),this._filterImpl.clearFrozenConditions()},this.clearFrozen=function(){this.enableStateChanged(),this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){return this.enableStateChanged(),this._filterImpl.clearAllIdList()},this.clearIdList=function(e){return this.enableStateChanged(),this._filterImpl.clearIdList(e)},this.addToIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.addToIdList(e,t)},this.removeFromIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.removeFromIdList(e,t)},this.setIdList=function(e,t){return this.enableStateChanged(),this._filterImpl.setIdList(e,t)},this.clearAllOverrideList=function(){o("OverrideIdsFA"),o("OverrideConditionFA"),n.clearMaterial(),this.enableStateChanged()},this.clearOverrideList=function(e){return this.enableStateChanged(),this._filterImpl.clearOverrideList(e)},this.addToOverrideList=function(e,t,i){return this.enableStateChanged(),this._filterImpl.addToOverrideList(e,t,i)},this.removeFromOverrideList=function(e,t){return this.enableStateChanged(),this._filterImpl.removeFromOverrideList(e,t)},this.setOverrideList=function(e,t,i){return this.enableStateChanged(),this._filterImpl.setOverrideList(e,t,i)},this.addToOverrideListByColor=function(e,t){var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var r=new CLOUD.OverrideIdsFA(!0,i);r.ids=e,this.pushBack(r)},this.addToOverrideListByConditions=function(e,t){var i=null;if(t){var n=this._filterImpl.getMaterialNameByColor(t);i=this._filterImpl.getMaterialByName(n)}var r=new CLOUD.OverrideConditionFA(!0,i);r.conditions=e,this.pushBack(r)},this.addToOverrideListByMaterial=function(e,t){this._filterImpl.addOverrideMaterial(t);var i=new CLOUD.OverrideConditionFA(!0,t);i.conditions=e,this.pushBack(i)},this.addToOverrideListByMaterialAndId=function(e,t){this._filterImpl.addOverrideMaterial(t);var i=new CLOUD.OverrideIdsFA(!0,t);i.ids=e,this.pushBack(i)},this.setOverrideListByColor=function(e,t,i){for(var r=0;r<t.length;r++){var a=this._filterImpl.getMaterialNameByColor(i),o=this._filterImpl.getMaterialByName(a);n.setMaterial(t[r],o)}},this.clearAllUserList=function(){return this.enableStateChanged(),this._filterImpl.clearAllUserList()},this.clearUserListByType=function(e){return this.enableStateChanged(),this._filterImpl.clearUserListByType(e)},this.clearUserList=function(e,t){return this.enableStateChanged(),this._filterImpl.clearUserList(e,t)},this.addToUserList=function(e,t,i,n){return this.enableStateChanged(),this._filterImpl.addToUserList(e,t,i,n)},this.removeFromUserList=function(e,t,i){this.enableStateChanged(),this._filterImpl.removeFromUserList(e,t,i)},this.setUserList=function(e,t,i,n){this.enableStateChanged(),this._filterImpl.setUserList(e,t,i,n)},this.isIsolate=function(){var e=n.getObjectsMap();for(var t in e){if(e.hasOwnProperty(t))var i=e[t];for(var r in i){var a=n.isIsolateHide(r);if(a|=n.isIsolateTransparent(r))return!0}}return!1},this.isFiltering=function(){var e=this.filterActionList.length>0;return this.isIsolate()||e},this.setIsolateMaterial=function(e){this.enableStateChanged(),this._filterImpl.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return this._filterImpl.getIsolateMaterial()},this.resetIsolateMaterial=function(){this.enableStateChanged(),this._filterImpl.resetIsolateMaterial()},this.clearAllIsolateList=function(){n.clearIsolates()},this.clearIsolation=function(){n.clearIsolates(),t=null,a=!0},this.addToIsolateList=function(e,t){var i="HideOthers"==t,n=new CLOUD.IsolateIdsFA(i);n.ids=e,this.pushBack(n),this.clearFilterActionList()},this.removeFromIsolateList=function(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)},this.setIsolateList=function(e,t){var i=new CLOUD.IsolateIdsFA(t);i.ids=e,this.pushBack(i)},this.removeFromIsolateList=function(e,t){this.enableStateChanged(),this._filterImpl.removeFromIsolateList(e,t)},this.setIsolateConditions=function(e,t){var i=t==CLOUD.EnumIsolateState.HIDDEN_OTHERS,n=new CLOUD.IsolateConditionFA(i);n.conditions=e,this.pushBack(n),this.clearFilterActionList()},this.getIsolateConditions=function(e){return this._filterImpl.getIsolateConditions(e)},this.clearIsolateConditions=function(e){this.enableStateChanged(),this._filterImpl.clearIsolateConditions(e)},this.clearAllIsolateConditions=function(){this.enableStateChanged(),this._filterImpl.clearAllIsolateConditions()},this.setConditions=function(e,t){if(0==e){n.hideAll();var i=new CLOUD.VisibleConditionFA(!0,!0);i.conditions=t,this.pushBack(i)}3==e&&this._filterImpl.setConditions(e,t)},this.getConditions=function(e){return this._filterImpl.getConditions(e)},this.clearConditions=function(e){this.enableStateChanged(),this._filterImpl.clearConditions(e)},this.clearAllConditions=function(){this.enableStateChanged(),this._filterImpl.clearAllConditions()},this.makeSceneTranslucent=function(){this.enableStateChanged(),this._filterImpl.makeSceneTranslucent()},this.cancelSceneTranslucent=function(){this.enableStateChanged(),this._filterImpl.cancelSceneTranslucent()},this.hideScene=function(){this.enableStateChanged(),this._filterImpl.hideScene()},this.showScene=function(){this.enableStateChanged(),this._filterImpl.showScene()},this.setSceneState=function(e){this.enableStateChanged(),this._filterImpl.setSceneState(e)},this.getSceneState=function(){return this._filterImpl.getSceneState()},this.cancelHidden=function(){this.enableStateChanged(),this._filterImpl.cancelHidden()},this.cancelTranslucent=function(){this.enableStateChanged(),this._filterImpl.cancelTranslucent()},this.hideByIds=function(e){var t=new CLOUD.VisibleIdsFA(!0,!1);t.ids=e,this.pushBack(t)},this.hideByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!0,!1);t.conditions=e,this.pushBack(t)},this.hideOthersByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!1,!1);t.conditions=e,this.pushBack(t)},this.showByIds=function(e){var t=new CLOUD.VisibleIdsFA(!0,!0);t.ids=e,this.pushBack(t)},this.showByConditions=function(e){var t=new CLOUD.VisibleConditionFA(!0,!0);t.conditions=e,this.pushBack(t)},this.makeTranslucentByIds=function(e){var t=new CLOUD.TransparentIdsFA(!0,!1);t.ids=e,this.pushBack(t)},this.makeTranslucentByConditions=function(e){var t=new CLOUD.TransparentConditionFA(!0,!1);t.conditions=e,this.pushBack(t)},this.opaqueByIds=function(e){var t=new CLOUD.TransparentIdsFA(!0,!0);t.ids=e,this.pushBack(t)},this.opaqueByConditions=function(e){var t=new CLOUD.TransparentConditionFA(!0,!0);t.conditions=e,this.pushBack(t)},this.setFrozonMaterial=function(e){this._filterImpl.setFrozonMaterial(e),this.enableStateChanged()},this.makeTranslucentOthersByIds=function(e){var t=new CLOUD.TransparentIdsFA(!1,!1);t.ids=e,this.pushBack(t)},this.opaqueAll=function(){o("TransparentIdsFA"),o("TransparentConditionFA"),n.clearTransparent(),this.enableStateChanged()},this.getFilterType=function(){return this._filterImpl.getFilterType()}},CLOUD.FilterManager2=function(){var e,t,i=CLOUD.EnumIdBasedType,n=CLOUD.EnumSceneState,r=CLOUD.FilterResultMode,a={IDFILTER_OFFSET:0,FILE_VISIBLE:0,FILE_HIDDEN:1,VISIBLE:2,HIDDEN:3,TRANSLUCENT:4,TRANSLUCENT_OTHERS:5,RENDER_PROMOTION:6,IDFILTER_ENDOFFSET:6,ISOLATEFILTER_OFFSET:7,ISOLATE_HIDDEN:7,ISOLATE_HIDDEN_OTHERS:8,ISOLATE_TRANSLUCENT:9,ISOLATE_TRANSLUCENT_OTHERS:10,ISOLATEFILTER_ENDOFFSET:10,USERFILTER_OFFSET:11,USER_HIDDEN:11,USER_OVERRIDE:12,USERFILTER_ENDOFFSET:12,CONDITIONFILTER_OFFSET:13,CONDITION_HIDDEN_OTHERS:13,CONDITION_TRANSLUCENT_OTHERS:14,CONDITION_OVERRIDE:15,CONDITION_BORDERLINE:16,CONDITIONFILTER_ENDOFFSET:16,ISOLATECONDITIONFILTER_OFFSET:17,ISOLATE_CONDITION_HIDDEN:17,ISOLATE_CONDITION_HIDDEN_OTHERS:18,ISOLATE_CONDITION_TRANSLUCENT:19,ISOLATE_CONDITION_TRANSLUCENT_OTHERS:20,ISOLATECONDITIONFILTER_ENDOFFSET:20,FROZENFILTER:21,FROZENCONDITIONFILTER:22,OVERRIDEFILTER:23,BASICFILTER_COUNT:23},o=new CLOUD.CompoundFilter(!0),s=new CLOUD.CompoundFilter(!0),l=new CLOUD.CompoundFilter(!1),c=new CLOUD.CompoundFilter(!0),u=new CLOUD.CompoundFilter(!1),h=new CLOUD.CompoundFilter(!1),d=new CLOUD.CompoundFilter(!1),f=[],p=n.DISABLED,m=new CLOUD.MaterialSelector;!function(){f[a.FILE_VISIBLE]=new CLOUD.FileIdFilter(a.FILE_VISIBLE,"FILE_VISIBLE"),f[a.FILE_HIDDEN]=new CLOUD.FileIdFilter(a.FILE_HIDDEN,"FILE_HIDDEN"),f[a.VISIBLE]=new CLOUD.GeneralIdFilter(a.VISIBLE,"VISIBLE"),f[a.HIDDEN]=new CLOUD.GeneralIdFilter(a.HIDDEN,"HIDDEN"),f[a.TRANSLUCENT]=new CLOUD.GeneralIdFilter(a.TRANSLUCENT,"TRANSLUCENT"),f[a.TRANSLUCENT_OTHERS]=new CLOUD.GeneralIdFilter(a.TRANSLUCENT_OTHERS,"TRANSLUCENT_OTHERS"),f[a.RENDER_PROMOTION]=new CLOUD.GeneralIdFilter(a.RENDER_PROMOTION,"RENDER_PROMOTION"),f[a.ISOLATE_HIDDEN]=new CLOUD.GeneralIdFilter(a.ISOLATE_HIDDEN,"ISOLATE_HIDDEN"),f[a.ISOLATE_HIDDEN_OTHERS]=new CLOUD.GeneralIdFilter(a.ISOLATE_HIDDEN_OTHERS,"ISOLATE_HIDDEN_OTHERS"),f[a.ISOLATE_TRANSLUCENT]=new CLOUD.GeneralIdFilter(a.ISOLATE_TRANSLUCENT,"ISOLATE_TRANSLUCENT"),f[a.ISOLATE_TRANSLUCENT_OTHERS]=new CLOUD.GeneralIdFilter(a.ISOLATE_TRANSLUCENT_OTHERS,"ISOLATE_TRANSLUCENT_OTHERS"),f[a.USER_HIDDEN]=new CLOUD.UserListFilter(a.USER_HIDDEN,"USER_HIDDEN"),f[a.USER_OVERRIDE]=new CLOUD.UserListFilter(a.USER_OVERRIDE,"USER_OVERRIDE"),f[a.CONDITION_HIDDEN_OTHERS]=new CLOUD.ConditionFilter(a.CONDITION_HIDDEN_OTHERS,"CONDITION_HIDDEN_OTHERS"),f[a.CONDITION_TRANSLUCENT_OTHERS]=new CLOUD.ConditionFilter(a.CONDITION_TRANSLUCENT_OTHERS,"CONDITION_TRANSLUCENT_OTHERS"),f[a.CONDITION_OVERRIDE]=new CLOUD.MultiConditionFilter(a.CONDITION_OVERRIDE,"CONDITION_OVERRIDE"),f[a.CONDITION_BORDERLINE]=new CLOUD.ConditionFilter(a.CONDITION_BORDERLINE,"CONDITION_BORDERLINE"),f[a.ISOLATE_CONDITION_HIDDEN]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_HIDDEN,"ISOLATE_CONDITION_HIDDEN"),f[a.ISOLATE_CONDITION_HIDDEN_OTHERS]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_HIDDEN_OTHERS,"ISOLATE_CONDITION_HIDDEN_OTHERS"),f[a.ISOLATE_CONDITION_TRANSLUCENT]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_TRANSLUCENT,"ISOLATE_CONDITION_TRANSLUCENT"),f[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=new CLOUD.ConditionFilter(a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS,"ISOLATE_CONDITION_TRANSLUCENT_OTHERS"),t=new CLOUD.GeneralIdFilter(a.FROZENFILTER,"FROZENFILTER"),f[a.FROZENCONDITIONFILTER]=new CLOUD.ConditionFilter(a.FROZENCONDITIONFILTER,"FROZENCONDITIONFILTER"),f[a.FROZENFILTER]=t,e=new CLOUD.OverrideListFilter(a.OVERRIDEFILTER,"OVERRIDEFILTER"),f[a.OVERRIDEFILTER]=e;var i,n={};n[a.HIDDEN]=r.MATCH_RETURN_FALSE,n[a.VISIBLE]=r.NOMATCH_RETURN_FALSE,n[a.USER_HIDDEN]=r.MATCH_RETURN_FALSE,n[a.CONDITION_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,n[a.ISOLATE_HIDDEN]=r.MATCH_RETURN_FALSE,n[a.ISOLATE_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,n[a.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.NOMATCH_RETURN_FALSE,o.setFilterMode(n);for(i in n)f[i].registerToCompoundFilter(o);var p={};p[a.FROZENFILTER]=r.MATCH_RETURN_FALSE,p[a.FROZENCONDITIONFILTER]=r.MATCH_RETURN_FALSE,p[a.TRANSLUCENT]=r.MATCH_RETURN_FALSE,p[a.TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.ISOLATE_TRANSLUCENT]=r.MATCH_RETURN_FALSE,p[a.ISOLATE_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,p[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_FALSE,c.setFilterMode(p);for(i in p)f[i].registerToCompoundFilter(c);var m={};m[a.ISOLATE_TRANSLUCENT]=r.MATCH_RETURN_TRUE,m[a.ISOLATE_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.CONDITION_TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.TRANSLUCENT]=r.MATCH_RETURN_TRUE,m[a.TRANSLUCENT_OTHERS]=r.NOMATCH_RETURN_TRUE,m[a.OVERRIDEFILTER]=r.MATCH_RETURN_TRUE,m[a.USER_OVERRIDE]=r.MATCH_RETURN_TRUE,m[a.CONDITION_OVERRIDE]=r.MATCH_RETURN_TRUE,m[a.FROZENFILTER]=r.MATCH_RETURN_TRUE,m[a.FROZENCONDITIONFILTER]=r.MATCH_RETURN_TRUE;var g={};g[a.ISOLATE_TRANSLUCENT]=5,g[a.ISOLATE_TRANSLUCENT_OTHERS]=5,g[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=5,g[a.CONDITION_TRANSLUCENT_OTHERS]=5,g[a.TRANSLUCENT]=5,g[a.TRANSLUCENT_OTHERS]=5,g[a.OVERRIDEFILTER]=0,g[a.USER_OVERRIDE]=0,g[a.CONDITION_OVERRIDE]=0,g[a.FROZENFILTER]=3,g[a.FROZENCONDITIONFILTER]=3,s.setFilterMode(m),s.setFilterPriority(g);for(i in m)f[i].registerToCompoundFilter(s);var v={};v[a.OVERRIDEFILTER]=r.MATCH_RETURN_TRUE,v[a.USER_OVERRIDE]=r.MATCH_RETURN_TRUE,v[a.CONDITION_OVERRIDE]=r.MATCH_RETURN_TRUE,v[a.CONDITION_TRANSLUCENT_OTHERS]=r.MATCH_RETURN_TRUE,l.setFilterMode(v);for(i in v)f[i].registerToCompoundFilter(l);var y={};y[a.FILE_VISIBLE]=r.NOMATCH_RETURN_TRUE,y[a.FILE_HIDDEN]=r.MATCH_RETURN_TRUE,u.setFilterMode(y);for(i in y)f[i].registerToCompoundFilter(u);var E={};E[a.RENDER_PROMOTION]=r.MATCH_RETURN_TRUE,E[a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.MATCH_RETURN_TRUE,h.setFilterMode(E);for(i in E)f[i].registerToCompoundFilter(h);var x={};x[a.CONDITION_BORDERLINE]=r.MATCH_RETURN_TRUE,d.setFilterMode(x);for(i in x)f[i].registerToCompoundFilter(d)}(),this.getMaterialSelector=function(){return m},this.getBasicFilterList=function(){return f},this.getFilterType=function(){return a},this.saveState=function(){for(var e,t={},i=0,n=f.length;i<n;i++)e=f[i],t[e.getName()]=e.getAll();return t.sceneState=this.getSceneState(),t.version="0.4",t},this.loadState=function(e){if(this.clearAll(),e.hasOwnProperty("version")){if("0.4"==e.version){for(var t={},i=0,n=f.length;i<n;i++)t[f[i].getName()]=i;for(var r in e)"sceneState"!==r&&"version"!==r&&(t.hasOwnProperty(r)?f[t[r]].setByData(e[r]):CLOUD.Logger.warn("Warning: Not supported filter '"+r+"'"))}}else for(var o in e)"sceneState"!==o&&(o<2?f[o].setByData(e[o]):o>2?o<a.BASICFILTER_COUNT+2&&f[o-1].setByData(e[o]):2==o&&CLOUD.Logger.warn("Warning: Old version filter data! The selection state is out of the filter, can not restore it."));this.setSceneState(e.sceneState)},this.clear=function(){for(var e=0,t=f.length;e<t;e++){var i=f[e].getType();i!==a.FROZENFILTER&&i!==a.CONDITION_BORDERLINE&&f[e].clearAll()}this.setSceneState(n.DISABLED)},this.clearAll=function(){for(var e=0,t=f.length;e<t;e++)f[e].clearAll();this.setSceneState(n.DISABLED)},this.clearIsolate=function(){this.clearAllIsolateList(),this.clearAllIsolateConditions()},this.clearFrozenList=function(){t.clearAll()},this.addToFrozenList=function(e){t.add(e)},this.removeFromFrozenList=function(e){t.remove(e)},this.setFrozenList=function(e){this.clearFrozenList(),this.addToFrozenList(e)},this.setFrozenConditions=function(e){f[a.FROZENCONDITIONFILTER].setByData(e)},this.getFrozenConditions=function(){return f[a.FROZENCONDITIONFILTER].getAll()},this.clearFrozenConditions=function(){f[a.FROZENCONDITIONFILTER].clear()},this.clearFrozen=function(){this.clearFrozenList(),this.clearFrozenConditions()},this.clearAllIdList=function(){var e;for(e=a.IDFILTER_OFFSET;e<=a.IDFILTER_ENDOFFSET;e++)f[e].clearAll()},this.clearIdList=function(e){var t=a.IDFILTER_OFFSET+e;t>=a.IDFILTER_OFFSET&&t<=a.IDFILTER_ENDOFFSET&&f[t].clear()},this.addToIdList=function(e,t){var i=a.IDFILTER_OFFSET+e;i>=a.IDFILTER_OFFSET&&i<=a.IDFILTER_ENDOFFSET&&f[i].add(t)},this.removeFromIdList=function(e,t){var i=a.IDFILTER_OFFSET+e;i>=a.IDFILTER_OFFSET&&i<=a.IDFILTER_ENDOFFSET&&f[i].remove(t)},this.setIdList=function(e,t){this.clearIdList(e),this.addToIdList(e,t)},this.clearAllOverrideList=function(){e.clearAll()},this.clearOverrideList=function(t){e.clear(t)},this.addToOverrideList=function(t,i,n){i&&i.length>0&&(m.has(n)||(n=m.getDefaultMaterialName()),e.add(t,i,n))},this.removeFromOverrideList=function(t,i){e.remove(t,i)},this.setOverrideList=function(e,t,i){this.clearOverrideList(e),this.addToOverrideList(e,t,i)},this.addToOverrideListByColor=function(t,i,n){var r=m.add(n);e.add(t,i,r)},this.setOverrideListByColor=function(e,t,i){this.clearOverrideList(e),this.addToOverrideListByColor(e,t,i)},this.clearAllUserList=function(){var e;for(e=a.USERFILTER_OFFSET;e<=a.USERFILTER_ENDOFFSET;e++)f[e].clearAll()},this.clearUserListByType=function(e){var t=a.USERFILTER_OFFSET+e;t>=a.USERFILTER_OFFSET&&t<=a.USERFILTER_ENDOFFSET&&f[t].clearAll()},this.clearUserList=function(e,t){var i=a.USERFILTER_OFFSET+e;i>=a.USERFILTER_OFFSET&&i<=a.USERFILTER_ENDOFFSET&&f[i].clear(t)},this.addToUserList=function(e,t,i,n){var r=a.USERFILTER_OFFSET+e;r>=a.USERFILTER_OFFSET&&r<=a.USERFILTER_ENDOFFSET&&f[r].add(t,i,n)},this.removeFromUserList=function(e,t,i){var n=a.USERFILTER_OFFSET+e;n>=a.USERFILTER_OFFSET&&n<=a.USERFILTER_ENDOFFSET&&f[n].remove(t,i)},this.setUserList=function(e,t,i,n){this.clearUserList(e,t),this.addToUserList(e,t,i,n)},this.isIsolate=function(){var e;for(e=a.ISOLATEFILTER_OFFSET;e<=a.ISOLATEFILTER_ENDOFFSET;e++)if(!f[e].isEmpty())return!0;return!1},this.isFiltering=function(){return!!this.isIsolate()||!(f[a.HIDDEN].isEmpty()&&f[a.VISIBLE].isEmpty()&&f[a.TRANSLUCENT].isEmpty()&&f[a.TRANSLUCENT_OTHERS].isEmpty()&&this.getSceneState()===n.DISABLED)},this.setFrozonMaterial=function(e){m.setFrozonMaterial(e)},this.getFrozonMaterial=function(){return m.getFrozonMaterial()},this.setSelectedMaterial=function(e){m.setSelectedMaterial(e)},this.getSelectedMaterial=function(){return m.getSelectedMaterial()},this.setIsolateMaterial=function(e){m.setIsolateMaterial(e)},this.getIsolateMaterial=function(){return m.getIsolateMaterial()},this.resetIsolateMaterial=function(){m.resetIsolateMaterial()},this.clearAllIsolateList=function(){var e;for(e=a.ISOLATEFILTER_OFFSET;e<=a.ISOLATEFILTER_ENDOFFSET;e++)f[e].clear()},this.clearIsolateList=function(e){var t=a.ISOLATEFILTER_OFFSET+e;t>=a.ISOLATEFILTER_OFFSET&&t<=a.ISOLATEFILTER_ENDOFFSET&&f[t].clear()},this.addToIsolateList=function(e,t){var i=a.ISOLATEFILTER_OFFSET+e;i>=a.ISOLATEFILTER_OFFSET&&i<=a.ISOLATEFILTER_ENDOFFSET&&f[i].add(t)},this.removeFromIsolateList=function(e,t){var i=a.ISOLATEFILTER_OFFSET+e;i>=a.ISOLATEFILTER_OFFSET&&i<=a.ISOLATEFILTER_ENDOFFSET&&f[i].remove(t)},this.setIsolateList=function(e,t){this.clearIsolateList(e),this.addToIsolateList(e,t)},this.setIsolateConditions=function(e,t){var i=a.ISOLATECONDITIONFILTER_OFFSET+t;i>=a.ISOLATECONDITIONFILTER_OFFSET&&i<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&f[i].setByData(e)},this.getIsolateConditions=function(e){var t=null,i=a.ISOLATECONDITIONFILTER_OFFSET+e;return i>=a.ISOLATECONDITIONFILTER_OFFSET&&i<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&(t=f[i].getAll()),t},this.clearIsolateConditions=function(e){var t=a.ISOLATECONDITIONFILTER_OFFSET+e;t>=a.ISOLATECONDITIONFILTER_OFFSET&&t<=a.ISOLATECONDITIONFILTER_ENDOFFSET&&f[t].clear()},this.clearAllIsolateConditions=function(){var e;for(e=a.ISOLATECONDITIONFILTER_OFFSET;e<=a.ISOLATECONDITIONFILTER_ENDOFFSET;e++)f[e].clearAll()},this.setConditions=function(e,t){var i=a.CONDITIONFILTER_OFFSET+e;i>=a.CONDITIONFILTER_OFFSET&&i<=a.CONDITIONFILTER_ENDOFFSET&&f[i].setByData(t)},this.getConditions=function(e){var t=null,i=a.CONDITIONFILTER_OFFSET+e;return i>=a.CONDITIONFILTER_OFFSET&&i<=a.CONDITIONFILTER_ENDOFFSET&&(t=f[i].get()),t},this.clearConditions=function(e){var t=a.CONDITIONFILTER_OFFSET+e;t>=a.CONDITIONFILTER_OFFSET&&t<=a.CONDITIONFILTER_ENDOFFSET&&f[t].clearAll()},this.clearAllConditions=function(){var e;for(e=a.CONDITIONFILTER_OFFSET;e<=a.CONDITIONFILTER_ENDOFFSET;e++)f[e].clear()},this.makeSceneTranslucent=function(){this.setSceneState(n.TRANSLUCENT)},this.cancelSceneTranslucent=function(){this.setSceneState(n.DISABLED)},this.hideScene=function(){this.setSceneState(n.HIDDEN)},this.showScene=function(){this.setSceneState(n.DISABLED)},this.setSceneState=function(e){p=e},this.getSceneState=function(){return p},this.cancelTranslucent=function(){this.clearIdList(i.TRANSLUCENT),this.clearIdList(i.TRANSLUCENT_OTHERS)},this._addIdsToFilter=function(e,t){var i=a.IDFILTER_OFFSET+e;i>=a.IDFILTER_OFFSET&&i<=a.IDFILTER_ENDOFFSET&&f[i].add(t)},this.hideByIds=function(e){this._addIdsToFilter(i.HIDDEN,e)},this.showByIds=function(e){this._addIdsToFilter(i.VISIBLE,e)},this.makeTranslucentByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT,e)},this.makeTranslucentOthersByIds=function(e){this._addIdsToFilter(i.TRANSLUCENT_OTHERS,e)},this._isVisible=function(e){return this.getSceneState()!==n.HIDDEN&&o.apply(e)},this._isSelectable=function(e){return this.getSceneState()!==n.TRANSLUCENT&&c.apply(e,this.getSceneState())},this.getMaterialNameByColor=function(e){return m.getMaterialNameByColor(e)},this.addOverrideMaterial=function(e){m.addOverrideMaterial(e)},this.getMaterialByName=function(e){return m.get(e)},this._getOverrideMaterial=function(e){if(this.getSceneState()===n.TRANSLUCENT)return m.get("scene");var t=s.getApplyFilterId(e),i=null,r="";switch(t){case a.ISOLATE_TRANSLUCENT:case a.ISOLATE_TRANSLUCENT_OTHERS:case a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial();break;case a.CONDITION_TRANSLUCENT_OTHERS:case a.TRANSLUCENT:case a.TRANSLUCENT_OTHERS:i=m.get("scene");break;case a.FROZENFILTER:case a.FROZENCONDITIONFILTER:break;case a.OVERRIDEFILTER:case a.USER_OVERRIDE:case a.CONDITION_OVERRIDE:var o=f[t].getMatchItem(e);r=o.hasOwnProperty("color")?m.getMaterialNameByColor(o.color):o.material?o.material:o}return i||""===r||(m.has(r)||(r=m.getDefaultMaterialName()),i=m.get(r)),i},this._getMaterialName=function(e){if(this.getSceneState()===n.TRANSLUCENT)return"scene";var t=s.getApplyFilterId(e),i=null,r="";switch(t){case a.ISOLATE_TRANSLUCENT:case a.ISOLATE_TRANSLUCENT_OTHERS:case a.ISOLATE_CONDITION_TRANSLUCENT_OTHERS:i=this.getIsolateMaterial(),r=i.name;break;case a.CONDITION_TRANSLUCENT_OTHERS:case a.TRANSLUCENT:case a.TRANSLUCENT_OTHERS:r="scene";break;case a.FROZENFILTER:case a.FROZENCONDITIONFILTER:break;case a.OVERRIDEFILTER:case a.USER_OVERRIDE:case a.CONDITION_OVERRIDE:var o=f[t].getMatchItem(e);r=o.hasOwnProperty("color")?m.getMaterialNameByColor(o.color):o.material?o.material:o}return r},this._getMaterialByName=function(e){return"isolate"==e?m.getIsolateMaterial():"frozen"==e||"scene"==e?m.getFrozonMaterial():"selected"==e?m.getSelectedMaterial():m.get(e)},this._hasHighPriorityOverrideMaterial=function(e){return this.getSceneState()===n.TRANSLUCENT||l.apply(e)},this._hasOverrideMaterial=function(e){return this.getSceneState()===n.TRANSLUCENT||l.apply(e)||s.apply(e)},this._isHiddenFileId=function(e){return u.apply(e)},this._hasHiddenFileIdFilter=function(){return!u.isEmpty()},this._hasVisibleFilter=function(){return this.getSceneState()===n.HIDDEN||!o.isEmpty()},this._hasSelectableFilter=function(){return this.getSceneState()===n.TRANSLUCENT||!c.isEmpty()},this._hasOverrideMaterialFilter=function(){return this.getSceneState()===n.TRANSLUCENT||!s.isEmpty()},this._hasLowPriorityOverride=function(){return s.hasFilterNotIn(l)},this._isRenderPromotion=function(e){return h.apply(e)},this._hasRenderPromotionFilter=function(){return!h.isEmpty()},this._isRenderWithBoardline=function(e){return d.apply(e)},this._hasRenderWithBoardlineFilter=function(){return!d.isEmpty()}},CLOUD.BasicFilter=function(e,t){this._type=e,this._name=t,this._enabled=!1,this._items={},this._relatedCompoundFilterList=[]},CLOUD.BasicFilter.prototype.getType=function(){return this._type},CLOUD.BasicFilter.prototype.getName=function(){return this._name},CLOUD.BasicFilter.prototype.get=function(){return this._items},CLOUD.BasicFilter.prototype.getAll=function(){return this._items},CLOUD.BasicFilter.prototype.clearAll=function(){var e=this;e._items={},e._enabled&&(e._enabled=!1,e.enableStateChanged())},CLOUD.BasicFilter.prototype.clear=function(){this.clearAll()},CLOUD.BasicFilter.prototype.isEmpty=function(){return!this._enabled},CLOUD.BasicFilter.prototype.forceEnable=function(){this._enabled||(this._enabled=!0,this.enableStateChanged())},CLOUD.BasicFilter.prototype.setByData=function(e){var t=this;!function(e){if(null==e)return!0;if("object"!==(void 0===e?"undefined":_typeof(e)))return!0;for(var t in e)if(e.hasOwnProperty(t))return!1;return!0}(e)?(t._items=e,t._enabled||(t._enabled=!0,t.enableStateChanged())):(t._items={},t._enabled&&(t._enabled=!1,t.enableStateChanged()))},CLOUD.BasicFilter.prototype.match=function(e){return!1},CLOUD.BasicFilter.prototype.registerToCompoundFilter=function(e){this._relatedCompoundFilterList.push(e)},CLOUD.BasicFilter.prototype.enableStateChanged=function(){for(var e=this,t=0,i=e._relatedCompoundFilterList.length;t<i;t++)e._enabled?e._relatedCompoundFilterList[t].addBaseFilter(e):e._relatedCompoundFilterList[t].removeBaseFilter(e)},CLOUD.BasicIdFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.BasicIdFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.BasicIdFilter.prototype.constructor=CLOUD.BasicIdFilter,CLOUD.BasicIdFilter.prototype.add=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var n=0,r=e.length;n<r;++n)i[e[n]]=!0;t._enabled||(t._enabled=!0,t.enableStateChanged())}},CLOUD.BasicIdFilter.prototype.remove=function(e){var t=this,i=t._items;if(e&&e.length>0){for(var n=0,r=e.length;n<r;++n){var a=e[n];i.hasOwnProperty(a)&&delete i[a]}0===i.length&&t._enabled&&(t._enabled=!1,t.enableStateChanged())}},CLOUD.ListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.ListFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.ListFilter.prototype.constructor=CLOUD.ListFilter,CLOUD.ListFilter.prototype.remove=function(e,t){var i=this,n=i._items[e];if(n&&t&&t.length>0){for(var r=0,a=t.length;r<a;++r){var o=t[r];n.hasOwnProperty(o)&&delete n[o]}CLOUD.Utils.isEmptyObject(i._items)&&i._enabled&&(i._enabled=!1,i.enableStateChanged())}},CLOUD.ListFilter.prototype.add=function(e,t,i){var n=this,r=n._items,a=r[e];if(t&&t.length>0){void 0===i&&(i=!0),a||(a=r[e]={});for(var o=0,s=t.length;o<s;++o)a[t[o]]=i;n._enabled||(n._enabled=!0,n.enableStateChanged())}},CLOUD.ListFilter.prototype.clear=function(e){var t=this,i=t._items;i.hasOwnProperty(e)&&(delete i[e],CLOUD.Utils.isEmptyObject(i)&&t._enabled&&(t._enabled=!1,t.enableStateChanged()))},CLOUD.UserListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.UserListFilter.prototype=Object.create(CLOUD.ListFilter.prototype),CLOUD.UserListFilter.prototype.constructor=CLOUD.UserListFilter,CLOUD.UserListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.UserListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.userData;if(i)for(var n in t){var r=t[n],a=i[n];if(a&&void 0!==r[a])return r[a]}return null},CLOUD.OverrideListFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.OverrideListFilter.prototype=Object.create(CLOUD.ListFilter.prototype),
CLOUD.OverrideListFilter.prototype.constructor=CLOUD.OverrideListFilter,CLOUD.OverrideListFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.OverrideListFilter.prototype.getMatchItem=function(e){var t=this._items,i=e.name;for(var n in t){var r=t[n];if(r[i])return r[i]}return null},CLOUD.ConditionFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.ConditionFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.ConditionFilter.prototype.constructor=CLOUD.ConditionFilter,CLOUD.ConditionFilter.prototype.match=function(e){var t=e.userData;return!!t&&function(e,t){for(var i,n=0,r=e.length;n<r;++n){i=!0;var a=e[n];for(var o in a){if(!(a[o]instanceof Array)&&t[o]!=a[o]){i=!1;break}if(a[o]instanceof Array&&-1==a[o].indexOf(t[o])){i=!1;break}}if(i)return!0}return!1}(this._items,t)},CLOUD.MultiConditionFilter=function(e,t){CLOUD.BasicFilter.call(this,e,t)},CLOUD.MultiConditionFilter.prototype=Object.create(CLOUD.BasicFilter.prototype),CLOUD.MultiConditionFilter.prototype.constructor=CLOUD.MultiConditionFilter,CLOUD.MultiConditionFilter.prototype.match=function(e){return null!==this.getMatchItem(e)},CLOUD.MultiConditionFilter.prototype.getMatchItem=function(e){var t,i=this._items,n=e.userData;if(n)for(var r=i.length,a=0;a<r;++a){var o=i[a],s=o.condition;t=!0;for(var l in s)if(s[l]!=n[l]){t=!1;break}if(t)return o}return null},CLOUD.FileIdFilter=function(e,t){CLOUD.BasicIdFilter.call(this,e,t)},CLOUD.FileIdFilter.prototype=Object.create(CLOUD.BasicIdFilter.prototype),CLOUD.FileIdFilter.prototype.constructor=CLOUD.FileIdFilter,CLOUD.FileIdFilter.prototype.match=function(e){var t=e.name;if(t){var i=t.indexOf(".");if(-1!==i){var n=t.substring(0,i);return!!this._items[n]}}var r=e.userData;if(r){var n=r.sceneId;if(n)return!!this._items[n]}return!1},CLOUD.GeneralIdFilter=function(e,t){CLOUD.BasicIdFilter.call(this,e,t)},CLOUD.GeneralIdFilter.prototype=Object.create(CLOUD.BasicIdFilter.prototype),CLOUD.GeneralIdFilter.prototype.constructor=CLOUD.GeneralIdFilter,CLOUD.GeneralIdFilter.prototype.match=function(e){return!!this._items[e.name]},CLOUD.FilterResultMode={MATCH_RETURN_TRUE:0,MATCH_RETURN_FALSE:1,NOMATCH_RETURN_TRUE:2,NOMATCH_RETURN_FALSE:3},CLOUD.CompoundFilter=function(e){this._activeFilterList=[],this._filterResultModes={},this._defaultRetValue=e,this._filterPriority=null},CLOUD.CompoundFilter.prototype.setFilterMode=function(e){this._filterResultModes=e},CLOUD.CompoundFilter.prototype.setFilterPriority=function(e){this._filterPriority=e},CLOUD.CompoundFilter.prototype.addBaseFilter=function(e){var t=this._activeFilterList,i=t.indexOf(e);if(null===this._filterPriority)-1===i?t.push(e):i!==t.length-1&&(t.splice(i,1),t.push(e));else if(0===t.length)t.push(e);else{-1!==i&&i!==t.length-1&&t.splice(i,1);for(var n=this._filterPriority[e.getType()],r=0,a=t.length;r<a;r++)if(this._filterPriority[t[r].getType()]>n){t.splice(r,0,e);break}r===a&&t.push(e)}},CLOUD.CompoundFilter.prototype.removeBaseFilter=function(e){var t=this._activeFilterList.indexOf(e);-1!==t&&this._activeFilterList.splice(t,1)},CLOUD.CompoundFilter.prototype.isEmpty=function(){return 0===this._activeFilterList.length},CLOUD.CompoundFilter.prototype.hasFilterNotIn=function(e){for(var t=this._activeFilterList,i=t.length-1;i>=0;i--){var n=t[i];if(void 0===e._filterResultModes[n.getType()])return!0}return!1},CLOUD.CompoundFilter.prototype.apply=function(e){for(var t,i=this,n=CLOUD.FilterResultMode,r=i._activeFilterList.length-1;r>=0;r--)switch(t=i._activeFilterList[r],i._filterResultModes[t.getType()]){case n.MATCH_RETURN_TRUE:if(t.match(e))return!0;break;case n.MATCH_RETURN_FALSE:if(t.match(e))return!1;break;case n.NOMATCH_RETURN_TRUE:if(!t.match(e))return!0;break;case n.NOMATCH_RETURN_FALSE:if(!t.match(e))return!1}return i._defaultRetValue},CLOUD.CompoundFilter.prototype.getApplyFilterId=function(e){for(var t,i=this,n=CLOUD.FilterResultMode,r=i._activeFilterList.length-1;r>=0;r--)switch(t=i._activeFilterList[r],i._filterResultModes[t.getType()]){case n.MATCH_RETURN_TRUE:case n.MATCH_RETURN_FALSE:if(t.match(e))return t.getType();break;case n.NOMATCH_RETURN_TRUE:case n.NOMATCH_RETURN_FALSE:if(!t.match(e))return t.getType()}return-1},CLOUD.FilterAction=function(){this.className="FilterAction"},CLOUD.FilterAction.prototype.getClassName=function(){return this.className},CLOUD.FilterAction.prototype.applyFilter=function(e){},CLOUD.IdsFilterAction=function(){CLOUD.FilterAction.call(this),this.className="IdsFilterAction",this.ids=[]},CLOUD.IdsFilterAction.prototype=Object.create(CLOUD.FilterAction.prototype),CLOUD.IdsFilterAction.prototype.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var n=e[i];t[n]=n}return t},CLOUD.IdsFilterAction.prototype.constructor=CLOUD.IdsFilterAction,CLOUD.VisibleIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="VisibleIdsFA",this.flag=e,this.isVisible=t},CLOUD.IdsFilterAction.prototype.setIds=function(e){this.ids=e},CLOUD.VisibleIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.VisibleIdsFA.prototype.constructor=CLOUD.VisibleIdsFA,CLOUD.VisibleIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.setVisible(this.ids,this.isVisible,this.flag),e.calculateVisibleComponentsBbox()):console.warn("Ids should be type of array.")},CLOUD.OverrideIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="OverrideIdsFA",this.flag=e,this.material=t},CLOUD.OverrideIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.OverrideIdsFA.prototype.constructor=CLOUD.OverrideIdsFA,CLOUD.OverrideIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setMaterial(this.ids,this.material,this.flag):console.warn("Ids should be type of array.")},CLOUD.IsolateIdsFA=function(e){CLOUD.IdsFilterAction.call(this),this.className="IsolateIdsFA",this.isolateHide=e},CLOUD.IsolateIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.IsolateIdsFA.prototype.constructor=CLOUD.IsolateIdsFA,CLOUD.IsolateIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?(e.clearIsolates(),this.isolateHide?(e.setIsolateHide(this.ids,!0,!1),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(this.ids,!0,!1)):console.warn("Ids should be type of array.")},CLOUD.TransparentIdsFA=function(e,t){CLOUD.IdsFilterAction.call(this),this.className="TransparentIdsFA",this.flag=e,this.isOpaque=t},CLOUD.TransparentIdsFA.prototype=Object.create(CLOUD.IdsFilterAction.prototype),CLOUD.TransparentIdsFA.prototype.constructor=CLOUD.TransparentIdsFA,CLOUD.TransparentIdsFA.prototype.applyFilter=function(e){this.ids instanceof Array?e.setTransparent(this.ids,!this.isOpaque,this.flag):console.warn("Ids should be type of array.")},CLOUD.ConditionFilterAction=function(){CLOUD.FilterAction.call(this),this.className="ConditionFilterAction",this.conditions=null},CLOUD.ConditionFilterAction.prototype=Object.create(CLOUD.FilterAction.prototype),CLOUD.ConditionFilterAction.prototype.constructor=CLOUD.ConditionFilterAction,CLOUD.VisibleConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="VisibleConditionFA",this.flag=e,this.isVisible=t},CLOUD.VisibleConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.VisibleConditionFA.prototype.constructor=CLOUD.VisibleConditionFA,CLOUD.VisibleConditionFA.prototype.applyFilter=function(e){var t=this,i=function(i,n){t.flag==n&&(e.setVisible(i,t.isVisible),i=null)};this.conditions instanceof Array?(e.matchConditions(this.conditions,i),e.calculateVisibleComponentsBbox()):console.warn("Conditions should be type of array.")},CLOUD.OverrideConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="OverrideConditionFA",this.flag=e,this.material=t},CLOUD.OverrideConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.OverrideConditionFA.prototype.constructor=CLOUD.OverrideConditionFA,CLOUD.OverrideConditionFA.prototype.applyFilter=function(e,t){var i=this,n=function(t,n){i.flag==n&&(e.setMaterial(t,i.material),t=null)};this.conditions instanceof Array?e.matchConditions(this.conditions,n):console.warn("Conditions should be type of array.")},CLOUD.TransparentConditionFA=function(e,t){CLOUD.ConditionFilterAction.call(this),this.className="TransparentConditionFA",this.flag=e,this.isOpaque=t},CLOUD.TransparentConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.TransparentConditionFA.prototype.constructor=CLOUD.TransparentConditionFA,CLOUD.TransparentConditionFA.prototype.applyFilter=function(e){var t=this,i=function(i,n){t.flag==n&&(e.setTransparent(i,!t.isOpaque),i=null)};this.conditions instanceof Array?e.matchConditions(this.conditions,i):console.warn("Conditions should be type of array.")},CLOUD.IsolateConditionFA=function(e){CLOUD.ConditionFilterAction.call(this),this.className="IsolateConditionFA",this.isolateHide=e},CLOUD.IsolateConditionFA.prototype=Object.create(CLOUD.ConditionFilterAction.prototype),CLOUD.IsolateConditionFA.prototype.constructor=CLOUD.IsolateConditionFA,CLOUD.IsolateConditionFA.prototype.applyFilter=function(e){e.clearIsolates();var t=this.isolateHide,i=function(i,n){if(1==n)return void(i=null);t?(e.setIsolateHide(i,!n),e.calculateVisibleComponentsBbox()):e.setIsolateTransparent(i,!n),i=null};this.conditions instanceof Array?e.matchConditions(this.conditions,i):console.warn("Conditions should be type of array.")},CLOUD.EnumObjectState={Visible:1,HideByIsolate:2,Transparent:4,TransparentByIsolate:8},CLOUD.ObjectInfo={userData:null,state:CLOUD.EnumObjectState.Visible,material:null},CLOUD.ObjectInfoDict=function(){var e={},t={};this.init=function(i){e=i;for(var n in e)t.hasOwnProperty(n)||(t[n]=Object.keys(e[n]))},this.reinit=function(i){e=i;for(var n in e)t[n]=Object.keys(i[n])},this.clear=function(){e={},t={}},this.getObjectsMap=function(){return e},this.getObjectIds=function(e){return t.hasOwnProperty(e)?t[e]:[]}},CLOUD.ObjectInfoManager=function(){var e=new CLOUD.ObjectInfoDict,t=!1,i=!1,n=!1,r=!1,a=!1,o=new THREE.Box3,s=!1;this.init=function(t){e.init(t)},this.reinit=function(t){e.reinit(t)},this.clearData=function(){e.clear()},this.getObjectsMap=function(){return e.getObjectsMap()},this.calculateVisibleComponentsBbox=function(){o.makeEmpty();var t=e.getObjectsMap();for(var i in t)for(var n=t[i],r=e.getObjectIds(i),a=0,l=r.length;a<l;a++){var c=r[a];if(!this.isHidden(c)){var u=n[c][0].boundingBox;u?(o.expandByPoint(u.min),o.expandByPoint(u.max)):console.warn("Object has no boundingBox, id is "+c)}}s=!1},this.getVisibleComponentsBbox=function(){return(s||o.isEmpty())&&this.calculateVisibleComponentsBbox(),o},this.needUpdateBoxAfterExplode=function(){s=!0},this.arrayToMap=function(e){for(var t={},i=0;i<e.length;i++){var n=e[i];t[n]=n}return t},this.isMatchConditions=function(e,t){for(var i=!0,n=0,r=t.length;n<r;n++){var a=t[n];for(var o in a){if(!(a[o]instanceof Array)&&e[o]!=a[o]){i=!1;break}if(a[o]instanceof Array&&-1==a[o].indexOf(e[o])){i=!1;break}}if(1==i)break;n<t.length-1&&(i=!0)}return i},this.matchConditions=function(t,i){var n=e.getObjectsMap();for(var r in n){for(var a=[],o=[],s=n[r],l=e.getObjectIds(r),c=0,u=l.length;c<u;c++){var h=l[c],d=s[h][0].userData||{};d.elementId=s[h][0].userId;this.isMatchConditions(d,t)?a.push(h):o.push(h)}i&&i(a,!0),i&&i(o,!1)}},this.getMatchIds=function(t){var i=e.getObjectsMap(),n=[];for(var r in i)for(var a=i[r],o=e.getObjectIds(r),s=0,l=o.length;s<l;s++){var c=o[s],u=a[c][0].userData||{};u.elementId=a[c][0].userId;var h=this.isMatchConditions(u,t);1==h&&n.push(c)}return n},this.setVisible=function(t,n,r){var a=function(e){n?e.state=e.state|CLOUD.EnumObjectState.Visible:(i=!0,e.state=e.state&~CLOUD.EnumObjectState.Visible)},o=e.getObjectsMap();for(var s in o){var l=o[s];if(void 0==r||!0===r)for(var c=0,u=t.length;c<u;c++){var h=t[c];if(l.hasOwnProperty(h)){var d=l[h][0];a(d)}}else{for(var f=this.arrayToMap(t),p=e.getObjectIds(s),m=0,g=p.length;m<g;m++){var h=p[m];f.hasOwnProperty(h)||(d=l[h][0],a(d))}f=null}}},this.isVisible=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){return r[t][0].state&CLOUD.EnumObjectState.Visible>0}}},this.clearVisible=function(){var t=e.getObjectsMap();i=!1;for(var n in t)for(var r=t[n],a=e.getObjectIds(n),o=0,s=a.length;o<s;o++){var l=a[o],c=r[l][0];c.state=c.state|CLOUD.EnumObjectState.Visible}},this.hideAll=function(){var t=e.getObjectsMap();i=!0;for(var n in t)for(var r=t[n],a=e.getObjectIds(n),o=0,s=a.length;o<s;o++){var l=a[o],c=r[l][0];c.state=c.state&~CLOUD.EnumObjectState.Visible}},this.setTransparent=function(i,n,a){var o=function(e){n?(e.state=e.state|CLOUD.EnumObjectState.Transparent,t=!0,r=!0):e.state=e.state&~CLOUD.EnumObjectState.Transparent},s=e.getObjectsMap();for(var l in s){var c=s[l];if(void 0==a||!0===a)for(var u=0,h=i.length;u<h;u++){var d=i[u];if(c.hasOwnProperty(d)){var f=c[d][0];o(f)}}else{for(var p=this.arrayToMap(i),m=e.getObjectIds(l),g=0,v=m.length;g<v;g++){var d=m[g];p.hasOwnProperty(d)||(f=c[d][0],o(f))}p=null}}},this.isTransparent=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){var a=r[t][0],o=(a.state&CLOUD.EnumObjectState.Transparent)>0;return o=o||(a.state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.clearTransparent=function(){var t=e.getObjectsMap();r=!1;for(var i in t)for(var n=t[i],a=e.getObjectIds(i),o=0,s=a.length;o<s;o++){var l=a[o],c=n[l][0];c.state=c.state&~CLOUD.EnumObjectState.Transparent}},this.setMaterial=function(i,n,r){var a=e.getObjectsMap();for(var o in a){var s=a[o];if(void 0==r||!0===r)for(var l=0,c=i.length;l<c;l++){var u=i[l];if(s.hasOwnProperty(u)){var h=s[u][0];h.material=n,t=!0}}else{for(var d=this.arrayToMap(i),f=e.getObjectIds(o),p=0,m=f.length;p<m;p++){var u=f[p];d.hasOwnProperty(u)||(h=s[u][0],h.material=n,t=!0)}d=null}}},this.getMaterial=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){return r[t][0].material}}},this.clearMaterial=function(){var t=e.getObjectsMap();for(var i in t){var n=t[i];for(var r in n)n[r][0].material=null}},this.setIsolateHide=function(t,i,r){var a=function(e){i?(n=!0,e.state=e.state|CLOUD.EnumObjectState.HideByIsolate):e.state=e.state&~CLOUD.EnumObjectState.HideByIsolate},o=e.getObjectsMap();for(var s in o){var l=o[s];if(void 0==r||!0===r)for(var c=0,u=t.length;c<u;c++){var h=t[c];if(l.hasOwnProperty(h)){var d=l[h][0];a(d)}}else{for(var f=this.arrayToMap(t),p=e.getObjectIds(s),m=0,g=p.length;m<g;m++){var h=p[m];f.hasOwnProperty(h)||(d=l[h][0],a(d))}f=null}}},this.isIsolateHide=function(t){var i=e.getObjectsMap();for(var n in i){return(i[n][t][0].state&CLOUD.EnumObjectState.HideByIsolate)>0}},this.setIsolateTransparent=function(i,n,r){var o=function(e){n?(e.state=e.state|CLOUD.EnumObjectState.TransparentByIsolate,t=!0,a=!0):e.state=e.state&~CLOUD.EnumObjectState.TransparentByIsolate},s=e.getObjectsMap();for(var l in s){var c=s[l];if(void 0==r||!0===r)for(var u=0,h=i.length;u<h;u++){var d=i[u];if(c.hasOwnProperty(d)){var f=c[d][0];o(f)}}else{for(var p=this.arrayToMap(i),m=e.getObjectIds(l),g=0,v=m.length;g<v;g++){var d=m[g];p.hasOwnProperty(d)||(f=c[d][0],o(f))}p=null}}},this.isIsolateTransparent=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){return(r[t][0].state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.clearIsolateHide=function(){var t=e.getObjectsMap();n=!1;for(var i in t){var r=e.getObjectIds(i);r.length>0&&this.setIsolateHide(r,!1)}},this.clearIsolates=function(){var t=e.getObjectsMap();a=!1,n=!1;for(var i in t){var r=e.getObjectIds(i);r.length>0&&(this.setIsolateHide(r,!1),this.setIsolateTransparent(r,!1))}},this.clearTransparentByIsolate=function(){var t=e.getObjectsMap();a=!1;for(var i in t)for(var n=t[i],r=e.getObjectIds(i),o=0,s=r.length;o<s;o++){var l=r[o],c=n[l][0];c.state=c.state&~CLOUD.EnumObjectState.TransparentByIsolate}},this.isHidden=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){var a=r[t][0],o=0==(a.state&CLOUD.EnumObjectState.Visible);return o=o||(a.state&CLOUD.EnumObjectState.HideByIsolate)>0}}},this.isFrozen=function(t){var i=e.getObjectsMap();for(var n in i){var r=i[n];if(r.hasOwnProperty(t)){var a=r[t][0],o=(a.state&CLOUD.EnumObjectState.Transparent)>0;return o=o||(a.state&CLOUD.EnumObjectState.TransparentByIsolate)>0}}},this.resetAll=function(){var o=e.getObjectsMap();for(var s in o)for(var l=o[s],c=e.getObjectIds(s),u=0,h=c.length;u<h;u++){var d=c[u];l[d][0].state=CLOUD.EnumObjectState.Visible,l[d][0].material=null}t=!1,i=n=!1,r=a=!1},this.hasOverrideMaterial=function(i){var n=e.getObjectsMap();if(void 0==i)return t;for(var r in n){var a=n[r];if(a.hasOwnProperty(i)){return null!=a[i][0].material||this.isTransparent(i)}}},this.hasObjectHidden=function(){return i||n},this.hasObjectCantSelected=function(){return i||r||a},this.hasObjectTransparent=function(){return r||a}},CLOUD.FilterManagerIO=function(e){this.materialSelector=e;var t=function(e){var t=[];for(var i in e)1==e[i]&&t.push(i);return t};this.saveState=function(e){var t=e.getIsolateFilterAction(),i=e.getFilterActionList(),n={isolateAction:t,actions:i,sceneState:e.getSceneState(),version:"1.0"};return JSON.stringify(n)},this.createAction=function(e){var t=e.className,i=null;switch(t){case"IsolateIdsFA":i=new CLOUD.IsolateIdsFA(e.isolateHide),i.ids=e.ids;break;case"VisibleIdsFA":i=new CLOUD.VisibleIdsFA(e.flag,e.isVisible),i.ids=e.ids;break;case"OverrideIdsFA":var n=e.material;if(n){var r={opacity:n.opacity,color:n.color},a=this.materialSelector.getMaterialNameByColor(r);n=this.materialSelector.get(a)}i=new CLOUD.OverrideIdsFA(e.flag,n),i.ids=e.ids;break;case"TransparentIdsFA":i=new CLOUD.TransparentIdsFA(e.flag,e.isOpaque),i.ids=e.ids;break;case"VisibleConditionFA":i=new CLOUD.VisibleConditionFA(e.flag,e.isVisible),i.conditions=e.conditions;break;case"OverrideConditionFA":var n=e.material;if(n){var r={opacity:n.opacity,color:n.color},a=this.materialSelector.getMaterialNameByColor(r);n=this.materialSelector.get(a)}i=new CLOUD.OverrideConditionFA(e.flag,n),i.conditions=e.conditions;break;case"TransparentConditionFA":i=new CLOUD.TransparentConditionFA(e.flag,e.isOpaque),i.conditions=e.conditions;break;case"IsolateConditionFA":i=new CLOUD.IsolateConditionFA(e.isolateHide),i.conditions=e.conditions;break;default:CLOUD.Logger.warn("Warning: Not supported filterAction '"+t+"'")}return i},this.createActionByOldFilter=function(e,i){var n=[];switch(e){case"CONDITION_OVERRIDE":for(var r=[],a=0;a<i.length;a++){var o=i[a];r.push(o.condition)}var s=o.color,l=this.materialSelector.add(s),c=this.materialSelector.get(l),u=new CLOUD.OverrideConditionFA(!0,c);u.conditions=r,n.push(u);break;case"CONDITION_TRANSLUCENT_OTHERS":var u=new CLOUD.TransparentConditionFA(!1,!1);u.conditions=i,n.push(u);break;case"ISOLATE_CONDITION_HIDEEN_OTHERS":var u=new CLOUD.IsolateConditionFA(!0);u.conditions=i,n.push(u);break;case"ISOLATE_CONDITION_TRANSLUCENT_OTHERS":var u=new CLOUD.IsolateConditionFA(!1);u.conditions=i,n.push(u);break;case"ISOLATE_HIDDEN_OTHERS":var u=new CLOUD.IsolateIdsFA(!0);u.ids=t(i),n.push(u);break;case"ISOLATE_TRANSLUCENT_OTHERS":var u=new CLOUD.IsolateIdsFA(!1);u.ids=t(i),n.push(u);break;case"OVERRIDEFILTER":for(var h in i)if(i.hasOwnProperty(h)){var d=[],f=i[h];for(var p in f)d.push(p);var s=this.materialSelector.getMaterialParamsFromName(f[p]),l=this.materialSelector.add(s),c=this.materialSelector.get(l),u=new CLOUD.OverrideIdsFA(!0,c);u.ids=d,n.push(u)}break;case"TRANSLUCENT":var u=new CLOUD.TransparentIdsFA(!0,!1);u.ids=t(i),n.push(u);break;case"TRANSLUCTANT_OTHERS":var u=new CLOUD.TransparentIdsFA(!1,!1);u.ids=t(i),n.push(u);break;case"VISIBLE":var u=new CLOUD.VisibleIdsFA(!0,!0);u.ids=t(i),n.push(u);break;default:CLOUD.Logger.warn("Warning: Not supported filter '"+e+"'")}return n},this.loadState=function(e,t){t.clearFilterActionList(),t.getObjectInfoManager().resetAll();var i=JSON.parse(e);if(i.hasOwnProperty("version"))if("1.0"==i.version){var n=i.isolateAction;if(n){var r=this.createAction(n);t.pushBack(r)}for(var a=i.actions,o=0;o<a.length;o++){var r=this.createAction(a[o]);t.pushBack(r)}}else if("0.4"==i.version){for(var s={},l=t._filterImpl.getBasicFilterList(),o=0,c=l.length;o<c;o++)s[l[o].getName()]=o;for(var u in i)if("sceneState"!==u&&"version"!==u&&s.hasOwnProperty(u)){if("{}"==JSON.stringify(i[u])||"[]"==JSON.stringify(i[u]))continue;for(var h=this.createActionByOldFilter(u,i[u]),o=0;o<h.length;o++)t.pushBack(h[o])}}t.setSceneState(i.sceneState)}},CLOUD.Loader=CLOUD.Loader||{},function(){var e=function(){function e(t){_classCallCheck(this,e),this.databagPath=t.serverUrl+""+t.databagId,this.lightmapPath=t.lightmapDatabagId?t.serverUrl+""+t.lightmapDatabagId:t.lightmapDatabagId}return _createClass(e,[{key:"projectUrl",value:function(){return this.databagPath+"/config.json"}},{key:"sceneUrl",value:function(e){return e=e||0,this.databagPath+"/scene/scene_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"sceneIdUrl",value:function(){return this.databagPath+"/scene/scene_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"userIdUrl",value:function(){return this.databagPath+"/scene/user_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"octreeUrl",value:function(e){return e=e||"o",this.databagPath+"/scene/octree_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"symbolUrl",value:function(){return this.databagPath+"/symbol/symbol"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"mpkUrl",value:function(e){return e=e||0,this.databagPath+"/mpk/mpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"bmpkUrl",value:function(e){return e=e||0,this.databagPath+"/bmpk/bmpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"bmpkIndexUrl",value:function(){return this.databagPath+"/bmpk/index"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"meshIdUrl",value:function(){return this.databagPath+"/mpk/mesh_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"materialUrl",value:function(){return this.databagPath+"/material/material"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"uv2Url",value:function(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.buf":this.databagPath+"/uv2/uvs1-export.buf"}},{key:"uv2MapItemUrl",value:function(){return this.lightmapPath?this.lightmapPath+"/uv2/uvs1-export.json":this.databagPath+"/uv2/uvs1-export.json"}},{key:"lightmapTexUrl",value:function(e){return this.lightmapPath?this.lightmapPath+"/texture/"+e:this.databagPath+"/texture/"+e}},{key:"lightmapProjectUrl",value:function(){return this.lightmapPath?this.lightmapPath+"/config.json":this.lightmapPath}},{key:"materialIdUrl",value:function(){return this.databagPath+"/material/material_id"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"userDataUrl",value:function(){return this.databagPath+"/userdata/userdata"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"cameraUrl",value:function(){return this.databagPath+"/scene/camera"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"textureUrl",value:function(e){return this.databagPath+"/texture/"+e}},{key:"layerUrl",value:function(){return this.databagPath+"/scene/layer"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerKeyUrl",value:function(){return this.databagPath+"/scene/layer_key"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"lineUrl",value:function(){return this.databagPath+"/line/line"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerSceneUrl",value:function(e){return e=e||0,this.databagPath+"/layer/layer_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerSceneCell",value:function(){return this.databagPath+"/layer/layer_cell"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"layerOctree",value:function(){return this.databagPath+"/layer/layer_octree"+CLOUD.GlobalData.ZipResourcePostfix}},{key:"borderLineUrl",value:function(e){return e=e||0,this.databagPath+"/outline/outline_"+e+CLOUD.GlobalData.ZipResourcePostfix}},{key:"mpkBorderLineUrl",value:function(e){return e=e||0,this.databagPath+"/outline/outline_mpk_"+e+CLOUD.GlobalData.ZipResourcePostfix}}]),e}();CLOUD.Loader.Url=e}(),CLOUD.TaskWorker=function(e,t){this.MaxThreadCount=e||8;var i=this;i.todoList={},i.todoCount=0,i.doingCount=0,this.hasTask=function(){return i.todoCount>0},this.addItem=function(e,t){i.todoList[e]=t,i.todoCount++},this.clearTasks=function(){i.todoList={},i.todoCount=0},this.run=function(e,i){function n(i){if(i>=l)r.doingCount<1&&t();else{var o=a[i];e(o,i+c,n)}}var r=this;if(!(r.doingCount>0)){var a=[],o=r.todoList;for(var s in o)o.hasOwnProperty(s)&&a.push(s);r.todoList={},r.todoCount=0;var l=a.length;if(0!==l){i&&a.sort(i);var c=Math.min(this.MaxThreadCount,CLOUD.GlobalData.ConcurrencyRequestCount,l);r.doingCount=l;for(var u=0;u<c;++u)n(u)}}}},CLOUD.TaskWorker2=function(e){this.MaxThreadCount=e||8,this.todoList=[],this.doingCount=0,this.addItem=function(e){void 0!==e&&this.todoList.push(e)},this.run=function(e,t,i){function n(l){l>=a?s.doingCount<1&&(t(s.doingCount,a),i()):(t(s.doingCount,a),e(r[l],l+o,n))}if(!(this.doingCount>0)){if(0===this.todoList.length)return void i();var r=this.todoList,a=r.length;this.todoList=[],this.doingCount=a;for(var o=Math.min(this.MaxThreadCount,CLOUD.GlobalData.ConcurrencyRequestCount,a),s=this,l=0;l<o;++l)n(l)}}},CLOUD.TaskManager=function(){this.worker=new CLOUD.TaskWorker2(8)},CLOUD.TaskManager.prototype={constructor:CLOUD.TaskManager,addTask:function(e){this.worker.addItem(e)},processTasks:function(e,t,i){function n(t,i,n){e(t,function(){--r.doingCount,n(i)})}t=t||function(){},i=i||function(){};var r=this.worker;this.worker.run(n,t,i)}},function(){var e=function e(t,i,n){_classCallCheck(this,e),this.id=t,this.condition=i,this.material=n};CLOUD.MaterialOverrider=e}(),function(){var e=function(){function e(t,i){_classCallCheck(this,e),this.overriders=[],this.overrideData=t,this.materials={},this.materialsByName={},this.textures={},this.defaultColor=i||"#808080",this.loader=new CLOUD.MaterialOverriderLoader(this.defaultColor)}return _createClass(e,[{key:"load",value:function(e,t,i,n,r){i=void 0!=i&&i,(new CLOUD.MaterialOverriderLoader).getMaterialOverriders(this.overriders,e,t,i,n,r)}},{key:"loadByDemand",value:function(e,t,i){this.loader.getMaterialsByDemand(this.materials,this.materialsByName,this.textures,this.overrideData,e,t,i)}},{key:"setDefaultColor",value:function(e){this.defaultColor=e,this.loader.defaultColor=e}},{key:"getOverrideMaterials",value:function(){return this.materials}},{key:"getOverrideMaterialByNodeInfo",value:function(e){var t=this.materials;return t["elementId_"+e.userId]||t["familyId_"+e.userData.familyId]||t["systemTypeId_"+e.userData.systemTypeId]}},{key:"getOverrideMaterialByName",value:function(e){return this.materialsByName[e]}},{key:"updateMaterialsValue",value:function(e,t){var i,n=this.materials;for(var r in n)(i=n[r])&&i[e]&&(i[e]=t,void 0!==i.refreshUniforms&&i.refreshUniforms(),i.needsUpdate=!0)}}]),e}();CLOUD.MaterialOverriderSet=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.loader=new THREE.FileLoader,this.loadTaskCount=0,this.maxLoadTask=0,this.defaultColor=t}return _createClass(e,[{key:"getMaterialOverriders",value:function(e,t,i,n,r,a){var o=this,s=t.overrides;o._getOverridesByData(e,s,i,n,r,a),0==this.maxLoadTask&&r&&r()}},{key:"getMaterialsByDemand",value:function(e,t,i,n,r,a,o){this.maxLoadTask=0,this.loadTaskCount=0;for(var s=[],l=n.overrides,c=n.textureMaterials,u=r.familyIds,h=r.elementIds,d=r.systemTypeIds,f=l.length,p=f-1;p>=0;p--){var m,g=l[p].targetType,v=l[p].target;if("family"==g){if(!u[v])continue;m="familyId_"+v}else if("element"==g){if(!h[v])continue;m="elementId_"+v}else{if("systemType"!=g)continue;if(!d[v])continue;m="systemTypeId_"+v}if(!e[m]){var y=l[p].colorMaterial;if(!y){if(!l[p].textureMaterial)continue;y=this.defaultColor}var E=new CLOUD.CloudStandardMaterial;if(E.pureColor=y,E.color.setStyle(y),E.name=y,l[p].textureMaterial){var x=JSON.parse(l[p].textureMaterial),b=x.materialId,C=c[x.materialId];E.name=C?b+E.name:E.name;var M=t[E.name];if(M){e[m]=M;continue}if(C){var _=JSON.parse(C);if(_.diffuse_color){var w=_.diffuse_color.split(",");E.color.setRGB(parseFloat(w[0]),parseFloat(w[1]),parseFloat(w[2])),E.opacity=parseFloat(w[3])}var L=1==_.transparent;if(E.transparent=L,E.roughness=_.roughness,E.metalness=_.metallic,E.bumpScale=_.enableBump,!s[x.materialId]&&!i[x.materialId]){if(_.diffuse_texture){var T=_.diffuse_texture.texture_file;T&&""!=T?(this.maxLoadTask+=2,s[x.materialId]={diffuse:_.diffuse_texture}):E.textureColor=E.color.getStyle()}if(_.bump_texture){var I=_.bump_texture.texture_file;I&&""!=I&&(this.maxLoadTask+=2,s[x.materialId]?s[x.materialId].bump=_.bump_texture:s[x.materialId]={bump:_.bump_texture})}}}else E.textureColor=y,console.log("Warning: there is no corresponding textureMaterial whose materialId is "+x.materialId)}else{var M=t[E.name];if(M){e[m]=M;continue}E.textureColor=y}E.needsUpdate=!0,E.side=THREE.DoubleSide,e[m]=E,t[E.name]=E}}this._mappingTexturesByDemand(t,i,s,a,o),0==this.maxLoadTask&&a&&a()}},{key:"_getOverridesByData",value:function(e,t,i,n,r,a){for(var o=i.familyIds,s=i.elementIds,l=i.systemTypeIds,c=!1,u=[],h=[],d=0,f=t.length;d<f;d++){var p,m=t[d].targetType,g=t[d].target;if("family"==m){if(!o[g])continue;p=[{familyId:g}]}else if("element"==m){if(!s[g])continue;p=[{elementId:g}]}else{if("systemType"!=consitionType)continue;if(!l[g])continue;p=[{systemTypeId:g}]}c=!0;var v;if(n){var y=t[d].colorMaterial;if(!y)continue;v=new CLOUD.CloudStandardMaterial,v.color.setStyle(y),v.name=t[d].id}else{if(!t[d].textureMaterial)continue;var E=JSON.parse(t[d].textureMaterial);if(!E.diffuse_color)continue;var y=E.diffuse_color.split(","),x=1==E.transparent;v=new CLOUD.CloudStandardMaterial({opacity:parseFloat(y[3]),roughness:E.roughness,metalness:E.metallic,transparent:x,bumpScale:E.enableBump}),v.name=E.id,v.color.setRGB(parseFloat(y[0]),parseFloat(y[1]),parseFloat(y[2]));var b=E.diffuse_texture.texture_file;b&&""!=b&&(this.maxLoadTask+=2,u[d]={diffuse:E.diffuse_texture});var C=E.bump_texture.texture_file;C&&""!=C&&(this.maxLoadTask+=2,u[d]?u[d].bump=E.bump_texture:u[d]={bump:E.bump_texture}),v.needsUpdate=!0}h[d]=v;var M=new CLOUD.MaterialOverrider(t[d].id,p,v);e.push(M)}if(this._mappingTextures(h,u,r,a),!c){console.log("there is no conditions matched"),a&&a()}}},{key:"_mappingTextures",value:function(e,t,i,n){for(var r=0;r<e.length;r++){if(e[r]&&t[r]){if(t[r].diffuse){var a=this._loadTexture(t[r].diffuse,i,n);e[r].map=a}if(t[r].bump){var o=this._loadTexture(t[r].bump,i,n);e[r].bumpMap=o}e[r].needsUpdate=!0}}}},{key:"_mappingTexturesByDemand",value:function(e,t,i,n,r){for(var a in e)if(e.hasOwnProperty(a)){var o=e[a],s=o.name.split("#")[0];if(o&&i[s]){if(!t[s]){if(t[s]=[],i[s].diffuse){var l=this._loadTexture(i[s].diffuse,n,r);l.texturetype="map",t[s].push(l)}if(i[s].bump){var c=this._loadTexture(i[s].bump,n,r);c.texturetype="bumpMap",t[s].push(c)}}e[a].map=t[s][0],t[s].length>1&&(e[a].bumpMap=t[s][1]),e[a].needsUpdate=!0}}}},{key:"_loadTexture",value:function(e,t,i){var n=new THREE.Texture,r=this;return(new TEST.CryptoResourceLoader).loadURL(e.texture_file,function(i){var a=new Blob([i],{type:"jpeg"}),o=r._loadImage(URL.createObjectURL(a),function(){r._onLoadFinished(t)});n.image=o;var s=e.scale.split(","),l=e.offset.split(",");n.repeat.fromArray([parseFloat(s[0]),parseFloat(s[1])]),n.offset.fromArray([parseFloat(l[0]),parseFloat(l[1])]),n.wrapS=r._getTextureWrapping(e.wrap_parameter_s),n.wrapT=r._getTextureWrapping(e.wrap_parameter_t),n.magFilter=r._getTextureFilter(e.filter_mode_mag),n.minFilter=r._getTextureFilter(e.filter_mode_min),n.setRotateAngle(e.rotation),n.needsUpdate=!0,r._onLoadFinished(t)},function(){i&&i()}),n}},{key:"_loadImage",value:function(e,t){var i=new Image;return i.onload=function(){var e=document.createElement("canvas");e.width=CLOUD.MaterialUtil.nextHighestPowerOfTwo(i.width),e.height=CLOUD.MaterialUtil.nextHighestPowerOfTwo(i.height),e.getContext("2d").drawImage(i,0,0,i.width,i.height,0,0,e.width,e.height),t()},i.src=e,i}},{key:"_getTextureFilter",value:function(e){switch(e){
case"NEAREST":return THREE.NearestFilter;case"NEAREST_MIPMAP_NEAREST":return THREE.NearestMipMapNearestFilter;case"NEAREST_MIPMAP_LINEAR":return THREE.NearestMipMapLinearFilter;case"LINEAR":return THREE.LinearFilter;case"LINEAR_MIPMAP_NEAREST":return THREE.LinearMipMapNearestFilter;case"LINEAR_MIPMAP_LINEAR":return THREE.LinearMipMapLinearFilter;default:return THREE.NearestFilter}}},{key:"_getTextureWrapping",value:function(e){switch(e){case"REPEAT":return THREE.RepeatWrapping;case"CLAMP":return THREE.ClampToEdgeWrapping;case"MIRROR":return THREE.MirroredRepeatWrapping;default:return THREE.RepeatWrapping}}},{key:"_onLoadFinished",value:function(e){++this.loadTaskCount>=this.maxLoadTask&&e&&e()}}]),e}();CLOUD.MaterialOverriderLoader=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.loader=new THREE.FileLoader,this.url=new CLOUD.Loader.Url({serverUrl:"",databagId:""}),this.currentTaskCount=0,this.maxTaskCount=0,this.mpkTaskManager=new CLOUD.TaskManager,this.databagId="",this.descriptor=new CLOUD.ModelView.DefaultDescriptor}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.loader=null,this.url=null,this.mpkTaskManager=null,this.descriptor.destroy(),this.descriptor=null}},{key:"load",value:function(e,t){var i=this;this.finishedCallback=t,this.databagId=e,this.url.databagPath=e,this.loader.setResponseType(""),this.loader.load(this.url.projectUrl(),function(e){var t;try{t=JSON.parse(e)}catch(e){return void console.log("Config data exceptions!")}var n=t.metadata,r=n.scenes?1:0;if(0===r)return void console.log("empty scene!");var a=n.mpks||0;if(0===a)return void console.log("empty mpk data!");var o=n.symbol?1:0,s=n.userdata?1:0,l=n.lines||0;i.maxTaskCount+=r,i.maxTaskCount+=o,i.maxTaskCount+=1,i.maxTaskCount+=s,i.maxTaskCount+=l,i.maxTaskCount+=a,i._loadScene(),o&&i._loadSymbol(),i._loadUserId(),s&&i._loadUserData(),l&&i._loadLine(),i._loadMpks(a)})}},{key:"_loadMetadata",value:function(e,t,i){var n=this,e=CLOUD.Utils.getEncodedId(e);this.loader.setResponseType(""),this.loader.load(t,function(t){for(var r=JSON.parse(t),a=r.partialElements,o=0,s=a.length;o<s;o++)n.model.cachePartialElements(e,a[o]);i&&i()},void 0,function(e){i&&i()})}},{key:"_loadScene",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.sceneUrl(0),function(t){e.descriptor.mapSceneReader[0]=new CLOUD.Loader.SceneReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadLine",value:function(){var e=this,t=CLOUD.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.lineUrl(),function(i){for(var n=new CLOUD.Loader.LineReader(i),r=0,a=n.header.lineCount;r<a;++r){var o=n.getPtBuffer(r),s=n.getIdxBuffer(r);if(void 0!=o&&void 0!=s){var l=n.getLineData(r);if(0===l.lineType){for(var c=[],u=1,h=s.length;u<h;u++)c.push(s[u-1]),c.push(s[u]);c.length&&(s=c)}e.model.cacheSegmentBuffer(t,"line-"+l.line_id,{P:o,I:s})}else CLOUD.Logger.log("Error Geometry!")}n=null,e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadSymbol",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.symbolUrl(),function(t){e.descriptor.symbolReader=new CLOUD.Loader.SymbolReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadUserId",value:function(){var e=this;this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.userIdUrl(),function(t){e.descriptor.userIdReader=new CLOUD.Loader.IdReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadUserData",value:function(){var e=this;this.loader.setResponseType(""),this.loader.load(this.url.userDataUrl(),function(t){e.descriptor.userDataReader=new CLOUD.Loader.UserDataReader(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_loadMpks",value:function(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this.loadMpk.bind(this))}},{key:"loadMpk",value:function(e,t){var i=this,n=CLOUD.Utils.getEncodedId(this.databagId);this.loader.setResponseType("arraybuffer"),this.loader.load(this.url.mpkUrl(e),function(e){for(var r=new CLOUD.Loader.MPKReader(e),a=r.header.meshCount,o=new THREE.Matrix4,s=0;s<a;++s){var l=r.getPtBuffer(s),c=r.getIdxBuffer(s);if(void 0!=l&&void 0!=c){var u=r.getNormalBuffer(s),h=r.getMeshData(s),d=r.getUVBuffer(s);0!==h.baseScale&&(l=new Float32Array(l),o.identity(),o.setPosition(new THREE.Vector3(h.baseX,h.baseY,h.baseZ)),o.scale(new THREE.Vector3(h.baseScale,h.baseScale,h.baseScale)),CLOUD.GeomUtil.applyMatrix4ToBuffer(o,l)),i.model.cacheSegmentBuffer(n,h.mesh_id,{P:l,I:c,N:u,UV:d})}else CLOUD.Logger.log("Error Geometry!")}r=null,t(),i._onTaskFinished()},void 0,function(e){i._onTaskFinished()})}},{key:"_onTaskFinished",value:function(){++this.currentTaskCount>=this.maxTaskCount&&(this.prepareData(),this.finishedCallback())}},{key:"prepareData",value:function(){this.descriptor.parseItemData()}}]),e}();CLOUD.SegmentLoader=e}(),THREE.DDSLoader=function(){this._parser=THREE.DDSLoader.parse},THREE.DDSLoader.prototype=Object.create(THREE.CompressedTextureLoader.prototype),THREE.DDSLoader.prototype.constructor=THREE.DDSLoader,THREE.DDSLoader.parse=function(e,t){function i(e){return e.charCodeAt(0)+(e.charCodeAt(1)<<8)+(e.charCodeAt(2)<<16)+(e.charCodeAt(3)<<24)}var n={mipmaps:[],width:0,height:0,format:null,mipmapCount:1},r=i("DXT1"),a=i("DXT3"),o=i("DXT5"),s=i("ETC1"),l=new Int32Array(e,0,31);if(542327876!==l[0])return console.error("THREE.DDSLoader.parse: Invalid magic number in DDS header."),n;if(4&!l[20])return console.error("THREE.DDSLoader.parse: Unsupported format, must contain a FourCC code."),n;var c,u=l[21],h=!1;switch(u){case r:c=8,n.format=THREE.RGB_S3TC_DXT1_Format;break;case a:c=16,n.format=THREE.RGBA_S3TC_DXT3_Format;break;case o:c=16,n.format=THREE.RGBA_S3TC_DXT5_Format;break;case s:c=8,n.format=THREE.RGB_ETC1_Format;break;default:if(!(32===l[22]&&16711680&l[23]&&65280&l[24]&&255&l[25]&&4278190080&l[26]))return console.error("THREE.DDSLoader.parse: Unsupported FourCC code ",function(e){return String.fromCharCode(255&e,e>>8&255,e>>16&255,e>>24&255)}(u)),n;h=!0,c=64,n.format=THREE.RGBAFormat}n.mipmapCount=1,131072&l[2]&&!1!==t&&(n.mipmapCount=Math.max(1,l[7]));var d=l[28];if(n.isCubemap=!!(512&d),n.isCubemap&&(!(1024&d)||!(2048&d)||!(4096&d)||!(8192&d)||!(16384&d)||!(32768&d)))return console.error("THREE.DDSLoader.parse: Incomplete cubemap faces"),n;n.width=l[4],n.height=l[3];for(var f=l[1]+4,p=n.isCubemap?6:1,m=0;m<p;m++)for(var g=n.width,v=n.height,y=0;y<n.mipmapCount;y++){if(h)var E=function(e,t,i,n){for(var r=i*n*4,a=new Uint8Array(e,t,r),o=new Uint8Array(r),s=0,l=0,c=0;c<n;c++)for(var u=0;u<i;u++){var h=a[l];l++;var d=a[l];l++;var f=a[l];l++;var p=a[l];l++,o[s]=f,s++,o[s]=d,s++,o[s]=h,s++,o[s]=p,s++}return o}(e,f,g,v),x=E.length;else var x=Math.max(4,g)/4*Math.max(4,v)/4*c,E=new Uint8Array(e,f,x);var b={data:E,width:g,height:v};n.mipmaps.push(b),f+=x,g=Math.max(g>>1,1),v=Math.max(v>>1,1)}return n},CLOUD.ModelView=CLOUD.ModelView||{},function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.config=null,this.statistics={renderableCount:0,renderableTotal:CLOUD.GlobalData.maxObjectNumInPool,renderableTotalForPool:CLOUD.GlobalData.maxObjectNumInPool,numOfElements:0,numOfTriangles:0,memoeryInfo:null},this.transformInfos={octreeTransformed:!0,boundingBox:null,position:new THREE.Vector3,rotation:new THREE.Quaternion,scale:new THREE.Vector3(1,1,1),transformMatrix:new THREE.Matrix4}}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.config=null,this.statistics=null,this.transformInfos=null}},{key:"load",value:function(e){var t=this,i=this.model,n=i.dataUrl,r=i.fileLoader;r.setResponseType(""),r.load(n.projectUrl(),function(n){var r;try{r=JSON.parse(n)}catch(e){return console.log("Config data exceptions!"),void i.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})}return CLOUD.Utils.checkVersionMatch(CLOUD.Version,r.metadata.version)?0===r.metadata.scenes?(i.setEmptyScene(!0),void i.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_EMPTY_SCENE})):(i.setEmptyScene(!1),t._parse(r),void(e&&e())):void i.dispatchEvent({type:CLOUD.EVENTS.ON_VERSION_NO_MATCH,version:{engine:CLOUD.Version,data:r.metadata.version}})},void 0,function(){console.log("Config load error!"),i.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_INVALID_SCENE})})}},{key:"_parse",value:function(e){this.config=e,this._setMetadata(e),this._toStatistics(e),this._setTransformInfos(e),this._chooseRendering(e),this._setHandler(e)}},{key:"_setMetadata",value:function(e){e.metadata.scenes=e.metadata.scenes?1:0,e.metadata.symbol=e.metadata.symbol?1:0,e.metadata.octree_o=e.metadata.octree_o?1:0,e.metadata.octree_i=e.metadata.octree_i?1:0,e.metadata.userdata=e.metadata.userdata?1:0,e.metadata.userId=1,e.metadata.camera=e.metadata.camera?1:0,e.metadata.material=e.metadata.material||0,e.metadata.material_json=e.metadata.material_json?1:0,e.metadata.lines=CLOUD.Compatibility.isLoadLinesEnabled(e.metadata.version)&&e.metadata.lines?1:0,e.metadata.outline_0=e.metadata.outline_0?1:0,e.metadata.outline_1=e.metadata.outline_1?1:0,e.metadata.outline_mpk=e.metadata.outline_mpk||0,e.metadata.mpk_shared_index=e.metadata.mpk_shared_index||e.metadata.outline_mpk}},{key:"_getDataProvider",value:function(e){if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.MERGED&&void 0!==e.bmpks&&e.bmpks>0)return console.log("data from: merged"),CLOUD.EnumDataProvider.MERGED;if(CLOUD.GlobalData.EnableLoadOnDemand&&e.layers){if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.LAYER_SCENE)return e.layers>1&&CLOUD.Compatibility.isLoadLayerSceneEnabled(e.version)?(console.log("data from: layer scene"),CLOUD.EnumDataProvider.LAYER_SCENE):(console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER);if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.LAYER)return console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER}if(CLOUD.GlobalData.DataProvider===CLOUD.EnumDataProvider.AUTO){if(CLOUD.GlobalData.EnableLoadOnDemand&&e.layers)return e.layers>1&&CLOUD.Compatibility.isLoadLayerSceneEnabled(e.version)?(console.log("data from: layer scene"),CLOUD.EnumDataProvider.LAYER_SCENE):(console.log("data from: layer"),CLOUD.EnumDataProvider.LAYER);if(CLOUD.GlobalData.BatchMergeEnabled&&CLOUD.Compatibility.isLoadBMpkEnabled(e.version)&&void 0!==e.bmpks&&e.bmpks>0)return console.log("data from: merged"),CLOUD.EnumDataProvider.MERGED}return console.log("data from: default"),CLOUD.EnumDataProvider.DEFAULT}},{key:"_chooseRendering",value:function(e){this.model.manager.chooseRendering(this.statistics.memoeryInfo)}},{key:"_setHandler",value:function(e){var t=!(!CLOUD.GlobalData.CanUseWireframeFromData||!e.metadata.outline_0&&!e.metadata.outline_1),i=this._getDataProvider(e.metadata),n=null,r=this.model;if(CLOUD.GlobalData.BatchMergeEnabled)switch(i){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.LayerBatchedHandler(r,t);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.LayerSceneBatchedHandler(r,t);break;case CLOUD.EnumDataProvider.MERGED:n=new CLOUD.MergedDataHandler(r,t);break;default:n=new CLOUD.BatchedHandler(r,t)}else if(CLOUD.GlobalData.OrganizeNodesByCameraView)switch(i){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.LayerIncrementHandler(r);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.LayerSceneIncrementHandler(r);break;case CLOUD.EnumDataProvider.MERGED:n=new CLOUD.MergedDataHandler(r,t);break;default:n=new CLOUD.IncrementHandler(r)}else switch(i){case CLOUD.EnumDataProvider.LAYER:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.FreeLayerIncrementHandler(r);break;case CLOUD.EnumDataProvider.LAYER_SCENE:CLOUD.GlobalData.HasLayerData=!0,CLOUD.GlobalData.LoadMpkOnDemand=!0,n=new CLOUD.FreeLayerSceneIncrementHandler(r);break;case CLOUD.EnumDataProvider.MERGED:n=new CLOUD.MergedDataHandler(r);break;default:n=new CLOUD.FreeIncrementHandler(r)}r._handler=n}},{key:"_setTransformInfos",value:function(e){if(0!==e.view.transform?this.transformInfos.octreeTransformed=!0:this.transformInfos.octreeTransformed=!1,this.transformInfos.boundingBox=CLOUD.Utils.box3FromArray(e.view.bbox),e.view.rotation){var t=new THREE.Euler;t.fromArray(e.view.rotation),this.transformInfos.rotation.setFromEuler(t,!1)}e.view.position&&this.transformInfos.position.fromArray(e.view.position),e.view.scale&&this.transformInfos.scale.fromArray(e.view.scale),this.transformInfos.transformMatrix.compose(this.transformInfos.position,this.transformInfos.rotation,this.transformInfos.scale)}},{key:"_toStatistics",value:function(e){e.count.texture_pixels&&e.count.texture_pixels>CLOUD.GlobalData.MaxTexturePixels&&(CLOUD.GlobalData.EnableTextureLoading=!1),void 0!==e.count&&(void 0!==e.count.mesh_face&&(this.statistics.numOfTriangles+=e.count.mesh_face),this.statistics.renderableTotal=0,this.statistics.renderableTotalForPool=0,void 0!==e.count.geom_box&&void 0!==e.count.geom_pipe&&void 0!==e.count.geom_tube&&void 0!==e.count.mesh?(this.statistics.renderableTotal+=e.count.geom_box,this.statistics.renderableTotal+=e.count.geom_pipe,this.statistics.renderableTotal+=e.count.geom_tube,this.statistics.renderableTotal+=e.count.mesh,this.statistics.renderableTotalForPool+=6*e.count.geom_box,this.statistics.renderableTotalForPool+=3*e.count.geom_pipe,this.statistics.renderableTotalForPool+=e.count.geom_tube,this.statistics.renderableTotalForPool+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom_box,this.statistics.numOfTriangles+=32*e.count.geom_pipe,this.statistics.numOfTriangles+=32*e.count.geom_tube):void 0!==e.count.geom&&void 0!==e.count.mesh&&(this.statistics.renderableTotal+=e.count.geom,this.statistics.renderableTotal+=e.count.mesh,this.statistics.numOfTriangles+=12*e.count.geom,this.statistics.numOfElements=this.statistics.renderableTotal,this.statistics.renderableTotalForPool=this.statistics.renderableTotal),void 0!==e.count.item&&(this.statistics.numOfElements=e.count.item)),this.statistics.memoeryInfo=this._computeApproximateMemoerySize(e)}},{key:"_computeApproximateMemoerySize",value:function(e){var t=0,i=0,n=e.count.mesh_vertex||0,r=e.count.mesh_face||0,a=e.count.geom_box||0,o=e.count.geom_pipe||0,s=e.count.texture_pixels||0;i+=8*n,i+=3*r,i+=0,i+=0,t+=6*n,t+=3*r,t+=0,t+=0;var l=0;if(l+=r,a>0&&(l+=12*a),o>0&&(l+=124*o),l+=0,CLOUD.GlobalData.Instance){a>0&&(i+=192,i+=36,i+=24*a,t+=144,t+=36,t+=18*a),o>0&&(i+=1040,i+=372,i+=24*o,t+=780,t+=372,t+=18*o)}else a>0&&(i+=24*a*8,i+=12*a*3,t+=24*a*6,t+=12*a*3),o>0&&(i+=130*o*8,i+=124*o*3,t+=130*o*6,t+=124*o*3);return CLOUD.GlobalData.EnableTextureLoading&&(i+=4*s,t+=4*s),i*=4,t*=4,i*=1/1048576,t*=1/1048576,i=Math.ceil(i),t=Math.ceil(t),{maxMemoerySize:i,minMemoerySize:t,triangleNumber:l,instanceEnabled:CLOUD.GlobalData.Instance}}},{key:"getMemoeryInfo",value:function(){return this.statistics.memoeryInfo}},{key:"getStatistics",value:function(){return this.statistics}},{key:"getConfig",value:function(){return this.config}},{key:"getTransforms",value:function(){return this.transformInfos}},{key:"setRenderableCount",value:function(e){this.statistics.renderableCount=e}}]),e}();CLOUD.ModelView.ConfigLoader=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.handler=t,this.model=t.model,this.url=t.model.dataUrl,this.fileLoader=t.model.fileLoader,this.descriptor=null,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.loadTextureCount=0,this.maxLoadTextureCount=0,this.textruesLoaded=!1,this.dataLoaded=!1,this.mpkTaskManager=new CLOUD.TaskManager,this.enableCompressedTexture=!1,this.enableSmallTexture=!1,this.startCallback=null,this.progressCallback=null,this.finishCallback=null}return _createClass(e,[{key:"destroy",value:function(){this.mpkTaskManager=null,this.url=null,this.model=null,this.fileLoader=null,this.descriptor=null,this.handler=null,this.startCallback=null,this.progressCallback=null,this.finishCallback=null}},{key:"getDescriptor",value:function(){return this.descriptor}},{key:"setNotifyProgress",value:function(e){this.notifyProgress=e}},{key:"load",value:function(e,t,i){this.startCallback=e,this.progressCallback=t,this.finishCallback=i;var n=this.url.lightmapProjectUrl();if(n){var r=this;this._loadLightmapConfig(n,function(){r.loadData()})}else this.loadData()}},{key:"loadData",value:function(){var e=this,t=this.model,i=t.getConfig().metadata;CLOUD.GlobalData.CanUseCompressedTexture&&i.texture_dds&&(this.enableCompressedTexture=!0),CLOUD.GlobalData.CanUseSmallTexture&&i.texture_small&&(this.enableSmallTexture=!0),CLOUD.Compatibility.isUse32MpkData(i.version)?CLOUD.Compatibility.use32MpkData=!0:CLOUD.Compatibility.use32MpkData=!1;var n=this.getSceneTaskCount(i);e.maxLoadTaskCount=0,e.maxLoadTaskCount+=n,e.maxLoadTaskCount+=i.symbol,e.maxLoadTaskCount+=i.material,e.maxLoadTaskCount+=i.userId,e.maxLoadTaskCount+=i.userdata,e.maxLoadTaskCount+=i.camera,e.maxLoadTaskCount+=i.octree_o,e.maxLoadTaskCount+=i.octree_i,t.lightmap&&(e.maxLoadTaskCount+=2),e.startCallback&&e.startCallback(),i.symbol&&e._loadSymbol(),i.material&&e._loadMaterial(i.material_json),i.userId&&e._loadUserId(),i.userdata&&e._loadUserData(),i.camera&&e._loadCamera(),(i.octree_o||i.octree_i)&&e._loadOctree(i.octree_o,i.octree_i),t.lightmap&&e._loadUV2(),n&&e.loadSceneAndMpks(i)}},{key:"loadSceneAndMpks",value:function(e){}},{key:"getSceneTaskCount",value:function(e){return 0}},{key:"_loadLightmapConfig",value:function(e,t){var i=this.model,n=this.descriptor;this.fileLoader.load(e,function(e){var r;try{r=JSON.parse(e)}catch(e){return void console.log("Lightmap config data exceptions!")}void 0!==r.count.lightmapNum&&r.count.lightmapNum>0&&(i.lightmapNum=r.count.lightmapNum,i.lightmap=!0,n.lightmap=!0,CLOUD.GlobalData.Instance=!1,CLOUD.GlobalData.EnableLightmap=!0),t&&t()})}},{key:"_onTaskFinished",value:function(){var e=this.model;this.loadTaskCount++;var t=this.dealProgressSegment(e,this.loadTaskCount);if(this.notifyProgress){var i={total:this.maxLoadTaskCount,loaded:t};this.progressCallback&&this.progressCallback(i)}this.loadTaskCount>=this.maxLoadTaskCount&&(this.dataLoaded=!0,this.textruesLoaded&&this.finishCallback&&this.finishCallback())}},{key:"_onLoadTexture",value:function(){++this.loadTextureCount>=this.maxLoadTextureCount&&(this.textruesLoaded=!0,this.dataLoaded&&this.finishCallback&&this.finishCallback())}},{key:"_loadScene",value:function(e){var t=this,i=this.model,n=this.url,r=this.fileLoader;r.setResponseType("arraybuffer"),r.load(n.sceneUrl(e),function(i){t._parseScene(i,e),t._onTaskFinished()},void 0,function(e){i.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SCENE_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseScene",value:function(e,t){var i=new CLOUD.Loader.SceneReader(e);this.descriptor.mapSceneReader[t]=i,i=null}},{key:"_loadLine",value:function(){var e=this,t=this.model,i=this.url,n=this.fileLoader;n.setResponseType("arraybuffer"),n.load(i.lineUrl(),function(t){e._parseLine(t),e._onTaskFinished()},void 0,function(i){t.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:i}),e._onTaskFinished()})}},{key:"_parseLine",value:function(e){for(var t=new CLOUD.Loader.LineReader(e),i=0,n=t.header.lineCount;i<n;++i){var r=t.getPtBuffer(i),a=t.getIdxBuffer(i);if(void 0!=r&&void 0!=a){var o=t.getLineData(i);if(0===o.lineType){for(var s=[],l=1,c=a.length;l<c;l++)s.push(a[l-1]),s.push(a[l]);s.length&&(a=s)}this.descriptor.cacheReferencedMeshBufferData("line-"+o.line_id,{P:r,I:a})}else CLOUD.Logger.log("Error Geometry!")}t=null}},{key:"_loadMaterial",value:function(e){var t=this,i=this.model,n=this.url,r=this.fileLoader;e?r.setResponseType(""):r.setResponseType("arraybuffer"),r.load(n.materialUrl(),function(i){t._parseMaterial(i,e),t._onTaskFinished()},void 0,function(e){i.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t.textruesLoaded=!0,t._onTaskFinished()})}},{key:"_parseMaterial",value:function(e,t){t?this._parseMaterialJson(e):this._parseMaterialBinary(e)}},{key:"_parseMaterialBinary",value:function(e){var t,i=this.url,n=this.model.materialManager,r=n.materials,a=n.textures,o=new CLOUD.Loader.MaterialReader(e),s=o.materialCount,l=this,c=[];if(!(s<0)){var u=this.model.manager.scene;for(t=0;t<s;++t){var h={},d=o.getMaterial(t);void 0!==d.color&&(h.color=d.color),void 0!==d.opacity&&(h.opacity=d.opacity,d.opacity<1&&(h.transparent=!0)),void 0!==d.side&&d.side&&(h.side=THREE.DoubleSide),void 0!==d.emissive&&(h.emissive=d.emissive),void 0!==d.environment&&(h.envMapIntensity=d.environment),void 0!==d.roughness&&(h.roughness=d.roughness,h.originRoughness=d.roughness),void 0!==d.metalness&&(h.metalness=d.metalness,h.originMetalness=d.metalness);var f;if(CLOUD.GlobalData.IBL?(h.iblProbe=u.iblProbe,f=new ImageBasedLighting.IBLMaterial(h),f.type="IBL"):f=CLOUD.MaterialUtil.createStandardMaterial(h),f.name=t,r[t]=f,h=null,CLOUD.GlobalData.EnableTextureLoading){var p=d.texture_n,m=null;p>0&&(m=o.getTexture(d.texture_id[0])),m&&c.push({id:t,data:m})}}if(c.length>0){for(s=this.maxLoadTextureCount=c.length,t=0;t<s;t++)this._parseTexture(i,c[t],a);c=null}if(this.model.lightmap){var g=this.model.lightmapNum;for(this.maxLoadTextureCount+=g,t=0;t<g;t++){var v=this._loadTexture(i.textureUrl("lightmap-rgbm"+t+".png"),function(){l._onLoadTexture()},void 0,function(){l._onLoadTexture()});n.lightmaps[t]=v}}0==this.maxLoadTextureCount&&l._onLoadTexture(),o=null}}},{key:"_parseMaterialJson",value:function(e){var t,i=this.url,n=this.model.materialManager,r=n.materials,a=n.textures,o=new CLOUD.Loader.MaterialReaderJson(e),s=o.count,l=this,c=[];if(!(s<0)){var u=this.model.manager.scene;for(t=0;t<s;++t){var h={},d=o.getMaterial(t),f=d.parameters;void 0!==f.color&&(h.color=f.color),void 0!==f.opacity&&(h.opacity=f.opacity,f.opacity<1&&(h.transparent=!0)),void 0!==f.side&&"double"==f.side&&(h.side=THREE.DoubleSide),void 0!==f.emissive&&(h.emissive=f.emissive),void 0!==f.environment&&(h.envMapIntensity=f.environment),void 0!==f.roughness&&(h.roughness=f.roughness,h.originRoughness=f.roughness),void 0!==f.metalness&&(h.metalness=f.metalness,h.originMetalness=f.metalness),void 0!==f.refractionRatio&&(h.refractionRatio=f.refractionRatio),void 0!==f.imageFade&&(h.imageFade=f.imageFade),this.model.lightmap&&(h.lights=!1);var p;if(CLOUD.GlobalData.IBL?(h.iblProbe=u.iblProbe,p=new ImageBasedLighting.IBLMaterial(h),p.type="IBL"):(p=CLOUD.MaterialUtil.createStandardMaterial(h),p.refreshUniforms()),p.name=t,r[t]=p,h=null,CLOUD.GlobalData.EnableTextureLoading){var m=[],g=d.textures;for(var v in g){var y=g[v];"reliefMap"==v&&g.bumpMap||m.push({type:v,data:y})}m.length>0&&c.push({id:t,dataArray:m})}}if(c.length>0){for(s=c.length,t=0;t<s;t++){var m=c[t].dataArray;this.maxLoadTextureCount+=m.length}for(t=0;t<s;t++){for(var E=c[t].id,m=c[t].dataArray,x=[],b=0,C=m.length;b<C;b++)this._parseTextureJson(i,m[b],x);a[E]=x}c=null}if(this.model.lightmap){var M=this.model.lightmapNum;for(this.maxLoadTextureCount+=M,t=0;t<M;t++){var _=this._loadTexture(i.lightmapTexUrl("lightmap-rgbm"+t+".png"),function(){l._onLoadTexture()},void 0,function(){l._onLoadTexture()});n.lightmaps[t]=_}}0==this.maxLoadTextureCount&&l._onLoadTexture(),o=null}}},{key:"_loadTexture",value:function(e,t,i,n){var r,a=THREE.Loader.Handlers.get(e),o=this;return null!==a?r=a.load(e,t):(r=new THREE.Texture,a=new THREE.ImageLoader,a.setCrossOrigin("anonymous"),a.load(e,function(e){r.image=CLOUD.MaterialUtil.ensurePowerOfTwo(e),r.needsUpdate=!0,t&&t(r)},i,function(e){void 0!==n&&n(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})),r}},{key:"_loadCompressedTexture",value:function(e,t,i,n){var r=this,e=e.substring(0,e.lastIndexOf("."))+".dds";return(new THREE.DDSLoader).load(e,t,i,function(e){void 0!==n&&n(e),r.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})}},{key:"_loadTextureByCrypto",value:function(e,t,i,n){var r,a=THREE.Loader.Handlers.get(e),o=this;return null!==a?r=a.load(e,t):(r=new THREE.Texture,a=new TEST.CryptoResourceLoader,a.loadURL(e,function(e){var i=new Blob([e],{type:"jpeg"}),a=new Image;a.onload=function(){r.image=CLOUD.MaterialUtil.ensurePowerOfTwo(a),r.needsUpdate=!0,t&&t(r)},a.onerror=function(e){n&&n(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})},a.src=URL.createObjectURL(i)},function(e){void 0!==n&&n(e),o.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_TEXTURE_ERROR,event:e})})),r}},{key:"_parseTexture",value:function(e,t,i){var n=window.TEST||{},r=t.id,a=t.data,o=a.id+a.file_name_ext;this.enableCompressedTexture&&a.dds?this.textureLoader=this._loadCompressedTexture:this.textureLoader=n.CryptoResourceLoader?this._loadTextureByCrypto:this._loadTexture;var s=this;this.textureLoader(e.textureUrl(o),function(e){e.repeat.fromArray([a.scale_u,a.scale_v]),e.offset.fromArray([a.offset_u,a.offset_v]),e.setRotateAngle&&e.setRotateAngle(a.angle),a.repeat_u&&(e.wrapS=THREE.RepeatWrapping),a.repeat_v&&(e.wrapT=THREE.RepeatWrapping),e&&(i[r]=e),s._onLoadTexture()},void 0,function(){s._onLoadTexture()})}},{key:"_parseTextureJson",value:function(e,t,i){var n=window.TEST||{},r=t.type,a=t.data,o=e.textureUrl(a.sourceFile),s=this.enableSmallTexture&&a.texture_small;if(!s&&this.enableCompressedTexture&&a.dds)this.textureLoader=this._loadCompressedTexture;else if(this.textureLoader=n.CryptoResourceLoader?this._loadTextureByCrypto:this._loadTexture,s){var l=o.lastIndexOf(".");o=o.substring(0,l)+"_s"+o.substring(l)}var c=this;this.textureLoader(o,function(e){e.repeat.fromArray([a.scale[0],a.scale[1]]),e.offset.fromArray([a.offset[0],a.offset[1]]),e.setRotateAngle&&e.setRotateAngle(a.angle),a.repeatU&&(e.wrapS=THREE.RepeatWrapping),a.repeatV&&(e.wrapT=THREE.RepeatWrapping),e.texturetype=r,"reliefMap"==r&&(e.texturetype="bumpMap"),a.dataType&&"NormalMap"==a.dataType&&(e.texturetype="normalMap"),a.alpha&&(e.texturetype="alphaMap"),a.depth&&(e.depth=a.depth),e&&i.push(e),c._onLoadTexture()},void 0,function(){c._onLoadTexture()})}},{key:"_loadUV2",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(t.uv2Url(),function(t){e.uv2Buffer=new Uint16Array(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()}),i.setResponseType(""),i.load(t.uv2MapItemUrl(),function(t){e.uv2MapItem=JSON.parse(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"getUV2ById",value:function(e,t){if(this.uv2MapItem&&t){var i=this.uv2MapItem[e];if(i){var n=i.uv1Scale,r=i.uv1Translation,a=i.uv1ByteOffset/2,o=2*t;if(this.uv2Buffer){for(var s=this.uv2Buffer.slice(a,a+o),l=[],c=0;c<o;c+=2)l.push(n[0]*(s[c]/65535)+r[0]),l.push(n[1]*(s[c+1]/65535)+r[1]);return{lightmapIdx:i.lightmapIdx,uv2:l}}}}}},{key:"_loadSymbol",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(t.symbolUrl(),function(t){e.parseSymbol(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_SYMBOL_ERROR,event:t}),e._onTaskFinished()})}},{key:"parseSymbol",value:function(e){this.descriptor.symbolReader=new CLOUD.Loader.SymbolReader(e)}},{key:"_loadOctree",value:function(e,t){var i=null,n=this.model.configLoader.transformInfos.transformMatrix;this.model.configLoader.transformInfos.octreeTransformed&&(i=new THREE.Matrix4,i.getInverse(n)),e&&this._loadOctreeBy(i,!1),t&&this._loadOctreeBy(i,!0)}},{key:"_loadOctreeBy",value:function(e,t){var i,n=this,r=this.url,a=this.fileLoader;i=t?r.octreeUrl("i"):r.octreeUrl("o"),a.setResponseType("arraybuffer"),a.load(i,function(i){n._parseOctree(i,e,t),n._onTaskFinished()},void 0,function(e){n.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_OCTREEINNER_ERROR,event:e}),n._onTaskFinished()})}},{key:"_parseOctree",value:function(e,t,i){this.descriptor.octreeRootNode[i?"inner":"outer"]=this._getOctreeRootNode(e,t)}},{key:"_getOctreeRootNode",value:function(e,t){function i(e,i){t&&i.boundingBox.applyMatrix4(t),e.boundingBoxWorld=i.boundingBox.clone(),e.min=i.boundingBox.min,e.max=i.boundingBox.max,e.center=i.boundingBox.getCenter(),e.size=i.boundingBox.getSize().lengthSq(),e.childStart=i.child_s,e.childEnd=i.child_e}function n(e,t){e.octType=0,e.center.x<t.center.x&&(e.octType+=1),e.center.y<t.center.y&&(e.octType+=2),e.center.z<t.center.z&&(e.octType+=4)}function r(e,t){for(var a=e.childStart,o=e.childEnd,s=a;s<o;++s){var l=t.getNode(s),c=l.cell_id,u=new CLOUD.Loader.OctreeNode(c,e.depth);i(u,l),e.add(u),n(u,e),u.updateMaxDepth(),r(u,t)}}var a=null,o=new CLOUD.Loader.OctreeReader(e);if(o.getCount()>0){var s=o.getNode(0),l=s.cell_id;a=new CLOUD.Loader.OctreeNode(l,0),i(a,s),r(a,o)}return o=null,a}},{key:"_loadUserId",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(t.userIdUrl(),function(t){e._parseUserId(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseUserId",value:function(e){this.descriptor.userIdReader=new CLOUD.Loader.IdReader(e)}},{key:"_loadUserData",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType(""),i.load(t.userDataUrl(),function(t){e._parseUserData(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERDATA_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseUserData",value:function(e){this.descriptor.userDataReader=new CLOUD.Loader.UserDataReader(e)}},{key:"_loadCamera",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType(""),i.load(t.cameraUrl(),function(t){e._parseCamera(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_CAMERA_ERROR,event:t}),e._onTaskFinished()})}},{key:"_parseCamera",value:function(e){var t=this.model.configLoader.transformInfos.transformMatrix;new CLOUD.Loader.CameraReader(e).parse(this.model,t)}},{key:"_loadMpk",value:function(e,t){var i=this,n=this.fileLoader,r=this.url,a=CLOUD.GlobalData.MpkWorkerUrl;CLOUD.GlobalData.UseMpkWorker?(n.setResponseType("arraybuffer"),n.load(r.mpkUrl(e),function(e){var n=new Worker(a);n.onmessage=function(e){var n=e.data;for(var r in n)n.hasOwnProperty(r)&&i.model.getModelDescriptor().cacheReferencedMeshBufferData(r,n[r]);t(),i._onTaskFinished()},n.postMessage({msg:e})},void 0,function(e){i.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),i._onTaskFinished()})):(n.setResponseType("arraybuffer"),n.load(r.mpkUrl(e),function(n){i._parseMpk(n,e),t(),i._onTaskFinished()},void 0,function(e){i.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),i._onTaskFinished()}))}},{key:"_loadAllMpks",value:function(e){for(var t=0;t<e;++t)this.mpkTaskManager.addTask(t);this.mpkTaskManager.processTasks(this._loadMpk.bind(this))}},{key:"_parseMpk",value:function(e,t){for(var i=new CLOUD.Loader.MPKReader(e),n=new THREE.Matrix4,r=0,a=i.header.meshCount;r<a;++r){var o=i.getPtBuffer(r),s=i.getIdxBuffer(r),l=i.getNormalBuffer(r),c=i.getMeshData(r),u=i.getUVBuffer(r)
;void 0!=o&&void 0!=s?(0!==c.baseScale&&(o=new Float32Array(o),n.identity(),n.setPosition(new THREE.Vector3(c.baseX,c.baseY,c.baseZ)),n.scale(new THREE.Vector3(c.baseScale,c.baseScale,c.baseScale)),CLOUD.GeomUtil.applyMatrix4ToBuffer(n,o)),this.descriptor.cacheReferencedMeshBufferData(c.mesh_id,{P:o,I:s,N:l,UV:u}),this.descriptor.cacheReferencedMeshMpkIds(t,c.mesh_id)):CLOUD.Logger.log("Error Geometry!")}i=null}},{key:"_loadBorderline",value:function(e){var t=this,i=this.url,n=this.fileLoader,r=e?i.borderLineUrl(1):i.borderLineUrl(0);n.setResponseType("arraybuffer"),n.load(r,function(i){t._parseBorderLine(i,e),t._onTaskFinished()},void 0,function(e){t.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MATERIAL_ERROR,event:e}),t._onTaskFinished()})}},{key:"_parseBorderLine",value:function(e,t){for(var i=new CLOUD.Loader.LineReader(e),n=[],r=0,a=i.header.lineCount;r<a;++r){var o=i.getLineData(r);n.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:n}),i=null}},{key:"_isLoadMpkBorderlines",value:function(){var e=this.model.getConfig().metadata;return!(!CLOUD.GlobalData.BorderLineBatched||!e.outline_mpk)}},{key:"getAllBorderlineCount",value:function(){var e=this.model.getConfig().metadata;return this._isLoadMpkBorderlines()?e.outline_mpk:e.outline_0+e.outline_1}},{key:"_loadAllBorderlines",value:function(e){this._isLoadMpkBorderlines()?e.outline_mpk&&this._loadAllMpkBorderLines(e.outline_mpk):(e.outline_0&&this._loadBorderline(!1),e.outline_1&&this._loadBorderline(!0))}},{key:"delayLoadBorderlines",value:function(e){this._isLoadMpkBorderlines()?this._delayLoadMpkBorderlines(e):this._delayLoadTogetherBorderlines(e)}},{key:"_delayLoadMpkBorderlines",value:function(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_mpk,t.outline_mpk&&this._loadAllMpkBorderLines(t.outline_mpk)}},{key:"_delayLoadTogetherBorderlines",value:function(e){var t=this.model.getConfig().metadata;this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=t.outline_0+t.outline_1,t.outline_0&&this._loadBorderline(!1),t.outline_1&&this._loadBorderline(!0)}},{key:"_loadAllMpkBorderLines",value:function(e){this.mpkBorderLineTaskManager||(this.mpkBorderLineTaskManager=new CLOUD.TaskManager);for(var t=0;t<e;++t)this.mpkBorderLineTaskManager.addTask(t);this.mpkBorderLineTaskManager.processTasks(this._loadMpkBorderLine.bind(this))}},{key:"_loadMpkBorderLine",value:function(e,t){var i=this,n=this.fileLoader,r=this.url,a=this.model.getConfig().metadata,o=a.mpk_shared_index,s=e>=o;n.setResponseType("arraybuffer"),n.load(r.mpkBorderLineUrl(e),function(e){i._parseMpkBorderLine(e,s),t(),i._onTaskFinished()},void 0,function(e){i._onTaskFinished()})}},{key:"_parseMpkBorderLine",value:function(e,t){for(var i=new CLOUD.Loader.LineReader(e),n=[],r=0,a=i.header.lineCount;r<a;++r){var o=i.getLineData(r);n.push({meshId:o.line_id,positionStart:o.ptOffset/4,positionCount:3*o.ptCount,indexStart:o.idxOffset/4,indexCount:o.idxCount})}this.descriptor.cacheBorderLine(t,{P:i.ptBuffer,I:i.idxBuffer,IndexInfos:n}),i=null}},{key:"dealProgressSegment",value:function(e,t){return CLOUD.GlobalData.BatchMergeEnabled?t*e.progressPercentage.load:t}}]),e}();CLOUD.ModelView.BaseLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.descriptor=new CLOUD.ModelView.DefaultDescriptor,i}return _inherits(t,e),_createClass(t,[{key:"loadSceneAndMpks",value:function(e){this._loadScene(0),e.lines&&this._loadLine(),e.mpks&&this._loadAllMpks(e.mpks),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=e.scenes;return t+=e.lines,t+=e.mpks,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.DefaultLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.descriptor=new CLOUD.ModelView.MergedDataDescriptor,i}return _inherits(t,e),_createClass(t,[{key:"loadSceneAndMpks",value:function(e){this.url.mpkUrl=this.url.bmpkUrl,this._loadScene(0),this._loadBMpkIndex(),e.lines&&this._loadLine(),e.bmpks&&this._loadAllMpks(e.bmpks),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=2;return t+=e.lines,t+=e.bmpks,CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}},{key:"_loadBMpkIndex",value:function(){var e=this,t=this.url,i=this.fileLoader;i.setResponseType("arraybuffer"),i.load(t.bmpkIndexUrl(),function(t){e._paserBMeshId(t),e._onTaskFinished()},void 0,function(t){e.model.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_USERID_ERROR,event:t}),e._onTaskFinished()})}},{key:"_paserBMeshId",value:function(e){this.descriptor.bmeshIdReader=new CLOUD.Loader.BMeshIdReader(e)}},{key:"_parseMpk",value:function(e,t){for(var i=new CLOUD.Loader.BMPKReader(e),n=[],r=0,a=i.header.meshCount;r<a;++r){var o=i.getMeshData(r);n.push({meshId:o.mesh_id,positionStart:o.vOffset/4,positionCount:3*o.ptCount,indexStart:o.iOffset/4,indexCount:o.idxCount,uvStart:o.tOffset/4,uvCount:2*o.ptCount})}this.descriptor.cacheReferencedMeshBufferData(t,{P:i.vBuffer,I:i.iBuffer,N:i.nBuffer,UV:i.tBuffer,IndexInfos:n}),i=null}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.MergedDataLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i._loadingOnDemand=!1,i}return _inherits(t,e),_createClass(t,[{key:"loadMpkOnDemand",value:function(e,t,i){for(var n=0,r=e.length;n<r;++n)this.mpkTaskManager.addTask(e[n]);var a=this;this.mpkTaskManager.processTasks(this._loadMpk.bind(this),t,function(){a._loadingOnDemand=!1,i&&i()})}},{key:"resetProcessState",value:function(e){this.loadTaskCount=0,this.maxLoadTaskCount=e,this._loadingOnDemand=!0}},{key:"dealProgressSegment",value:function(e,t){return CLOUD.GlobalData.BatchMergeEnabled&&this._loadingOnDemand?t*e.progressPercentage.load:t}},{key:"_loadLayerKey",value:function(){var e=this,t=this.fileLoader,i=this.url,n=this.model,r=this.handler.getLayerProvider();t.setResponseType(""),t.load(i.layerKeyUrl(),function(t){var i=new CLOUD.Loader.LayerKeyReader(t),n=[],a=i.getData();r.cacheLayerKeys(a);for(var o=0,s=i.getCount();o<s;++o){var l=i.getLayerKey(o),c=r.formatLayerIds(l);n.push(c[0])}e._loadLayer(n)},void 0,function(t){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:t}),e._onTaskFinished()})}},{key:"_loadLayer",value:function(e){var t=this,i=this.fileLoader,n=this.url,r=this.model,a=this.handler.getLayerProvider();i.setResponseType("arraybuffer"),i.load(n.layerUrl(),function(i){for(var n=new CLOUD.Loader.LayerReader(i),r=0,o=n.getLayerCount();r<o;++r)if(void 0!==e[r]){for(var s=[],l=n.getLayerData(r),c=n.getMpkList(r),u=0,h=c.length;u<h;++u)s.push(c[u]);a.cacheLayerData(e[r],{layerId:l.layer_id,boundingBox:l.boundingBox,mpkIdxs:s})}t._onTaskFinished()},void 0,function(e){r.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),t._onTaskFinished()})}},{key:"delayLoadResources",value:function(e){var t=this.model.getConfig().metadata;if(0===t.lines)return void(e&&e());this.startCallback=null,this.progressCallback=null,this.finishCallback=e,this.loadTaskCount=0,this.maxLoadTaskCount=0,this.maxLoadTaskCount+=t.lines,t.lines&&this._loadLine()}}]),t}(CLOUD.ModelView.BaseLoader);CLOUD.ModelView.LayerBaseLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.descriptor=new CLOUD.ModelView.LayerDescriptor,i}return _inherits(t,e),_createClass(t,[{key:"loadSceneAndMpks",value:function(e){this._loadScene(0),this._loadLayerKey(),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=2;return CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}}]),t}(CLOUD.ModelView.LayerBaseLoader);CLOUD.ModelView.LayerLoader=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.layerSceneTaskManager=new CLOUD.TaskManager,i.descriptor=new CLOUD.ModelView.LayerSceneDescriptor,i}return _inherits(t,e),_createClass(t,[{key:"loadLayerScenesOnDemand",value:function(e,t,i){for(var n=0,r=e.length;n<r;++n)this.layerSceneTaskManager.addTask(e[n]);this.layerSceneTaskManager.processTasks(this._loadLayerScene.bind(this),t,i)}},{key:"loadSceneAndMpks",value:function(e){this._loadLayerCellIndex(),this._loadLayerOctree(),this._loadLayerKey(),CLOUD.GlobalData.BorderLineDelayLoaded||this._loadAllBorderlines(e)}},{key:"getSceneTaskCount",value:function(e){var t=3;return CLOUD.GlobalData.BorderLineDelayLoaded||(t+=this.getAllBorderlineCount()),t}},{key:"_loadLayerCellIndex",value:function(){var e=this,t=this.fileLoader,i=this.url,n=i.layerSceneCell();t.setResponseType("arraybuffer"),t.load(n,function(t){e._parseLayerCellIndex(t),e._onTaskFinished()},void 0,function(t){e._onTaskFinished()})}},{key:"_parseLayerCellIndex",value:function(e){for(var t=new CLOUD.Loader.LayerIndexReader(e),i=this.descriptor,n=0,r=t.cell_count;n<r;n++)for(var a=t.getCell(n),o=a.itemIndex;o<a.itemCount;o++){var s=t.getLayerIndex(o);i.cacheToCellIdMap(a.cellId,s.layer_id,s.item_index)}}},{key:"_loadLayerOctree",value:function(){var e=this.fileLoader,t=this.url,i=this;e.setResponseType("arraybuffer"),e.load(t.layerOctree(),function(e){i._parseLayerOctree(e),i._onTaskFinished()},void 0,function(e){i._onTaskFinished()})}},{key:"_parseLayerOctree",value:function(e){this.descriptor.octreeRootNode.layer=this._getOctreeRootNode(e)}},{key:"_loadLayerScene",value:function(e,t){var i=this,n=this.model,r=this.fileLoader,a=this.url,o=CLOUD.GlobalData.MpkWorkerUrl;CLOUD.GlobalData.UseMpkWorker?(r.setResponseType("arraybuffer"),r.load(a.layerSceneUrl(e),function(e){var n=new Worker(o);n.onmessage=function(e){var n=e.data;for(var r in n)n.hasOwnProperty(r)&&i.descriptor.cacheReferencedMeshBufferData(r,n[r]);t(),i._onTaskFinished()},n.postMessage({msg:e})},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),i._onTaskFinished()})):(r.setResponseType("arraybuffer"),r.load(a.layerSceneUrl(e),function(n){i._parseScene(n,e),t(),i._onTaskFinished()},void 0,function(e){n.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_MPK_ERROR,event:e}),i._onTaskFinished()}))}}]),t}(CLOUD.ModelView.LayerBaseLoader);CLOUD.ModelView.LayerSceneLoader=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.symbolReader=null,this.userIdReader=null,this.userDataReader=null,this.mapSceneReader={},this.lightmap=!1,this.mapNodeInfoByCategory={},this.mapNodeInfoByUserId={},this.mapNodeInfoByCellId={},this.mapNodeInfoByGeometryId=null,this.referencedMeshCache={},this.cellCount=0,this.borderLines={},this.octreeRootNode={inner:null,outer:null,layer:null}}return _createClass(e,[{key:"destroy",value:function(){this.destroyReader(),this.mapNodeInfoByCategory=null,this.mapNodeInfoByUserId=null,this.mapNodeInfoByCellId=null,this.mapNodeInfoByGeometryId=null,this.referencedMeshCache=null,this.borderLines=null,this.octreeRootNode=null}},{key:"destroyReader",value:function(){this.userIdReader=null,this.userDataReader=null,this.symbolReader=null,this.mapSceneReader=null}},{key:"getSceneReaderMap",value:function(){return this.mapSceneReader}},{key:"isValidScene",value:function(){return!CLOUD.Utils.isEmptyObject(this.getSceneReaderMap())||(CLOUD.Logger.log("model load not started!"),!1)}},{key:"parseItemData",value:function(e){var t=this.getSceneReaderMap();for(var i in t)for(var n=t[i],r=0,a=n.header.cellCount;r<a;++r)for(var o=n.getCellInfo(r),s=o.itemIndex;s<o.itemCount;++s)this._readItemData(n,s,r);e&&e()}},{key:"asyncParseItemData",value:function(e){for(var t=this.getSceneReaderMap(),i=Object.keys(t),n=i.length,r=0,a=this,o=0;o<n;o++){var s=t[i[o]];CLOUD.Utils.asyncProcess(s,s.header.cellCount,100,function(e,t){a._parseItemDataBy(e,t)},function(){++r===n&&e&&e()})}}},{key:"_parseItemDataBy",value:function(e,t){for(var i=e.getCellInfo(t),n=i.itemIndex;n<i.itemCount;++n)this._readItemData(e,n,t)}},{key:"parseItemDataByCellId",value:function(e){var t=this.getSceneReaderMap();for(var i in t)this._parseItemDataBy(t[i],e)}},{key:"_readItemData",value:function(e,t,i){var n=e.getItemInfo(t);void 0!==n&&(n.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL?this._readSymbolInfo(e,i,n):this._readMeshInfo(e,i,n,null))}},{key:"_readSymbolInfo",value:function(e,t,i){var n=this.symbolReader;if(n){var r=n.header.symbolCount,a=i.toData,o=e.getMatrixInfo(i.matrixId).matrix.clone(),s={matrix:o,ItemId:i.ItemId,originalId:i.originalId,userDataId:i.userDataId,materialId:i.materialId};if(a>=0&&a<r)for(var l=n.getSymbolInfo(a),c=l.itemIndex;c<l.itemCount;++c){var u=n.getItemInfo(c);u.type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.SYMBOL&&this._readMeshInfo(n,t,u,s)}o=null,s=null,n=null}}},{key:"_readMeshInfo",value:function(e,t,i,n){var r,a,o;null===n?(r=i.userDataId,a=i.originalId,o=i.materialId):(r=n.userDataId,a=n.originalId,o=n.materialId>-1?n.materialId:i.materialId);var s=null,l=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType;switch(i.type){case l.MESH:s=this._getMeshNodeAttr(e,i,n);break;case l.TUBE:s=this._getMeshNodeAttrOfTube(e,i,n);break;case l.PIPE:s=this._getMeshNodeAttrOfPipe(e,i,n);break;case l.BOX:s=this._getMeshNodeAttrOfBox(e,i,n);break;case l.BOX_M:s=this._getMeshNodeAttrOfBoxM(e,i,n);break;case l.PIPE_M:s=this._getMeshNodeAttrOfPipeM(e,i,n);break;case l.MESH_REF:s=this._getMeshNodeAttrOfMeshRef(e,i,n);break;case l.LINE:s=this._getLineNodeAttr(e,i,n)}if(s){if(s.userId=this.userIdReader?this.userIdReader.getString(a):a,s.userData=this.userDataReader?this.userDataReader.getUserData(r):null,s.name=s.userId,s.type=i.type,s.cellId=t,s.materialId=o,s.state=CLOUD.EnumObjectState.Visible,s.material=null,this.lightmap){var c=i.ItemId;n&&(c=n.ItemId+"_"+i.ItemId),s.itemIdUV2=c}CLOUD.GlobalData.Instance&&this._isRegularShape(s)?s.instanceOrNot=!0:s.instanceOrNot=!1,this._classifyNodeInfo(s),s=null}}},{key:"_getMeshNodeAttrOfPipe",value:function(e,t,i){var n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);var r=t.boundingBox.clone();r.applyMatrix4(n);var a=e.getGeomPipeInfo(t.toData),o=a.startPt,s=a.endPt,l=new THREE.Vector3;l.subVectors(s,o);var c=l.length();l.normalize();var u=a.radius;u<=1&&(u=100);var h=new THREE.Vector3(0,1,0),d=new THREE.Vector3(u,c,u),f=(new THREE.Quaternion).setFromUnitVectors(h,l),p=o.clone().addScaledVector(l,.5*c),m=(new THREE.Matrix4).compose(p,f,d);return n.multiply(m),a=null,{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_pipe",geometryId:"pipe",boundingBox:r,matrix:n}}},{key:"_getMeshNodeAttrOfTube",value:function(e,t,i){var n=this._getMeshNodeAttrOfPipe(e,t,i);return n.nodeId+="_tube",n.geometryId="tube",n}},{key:"_getMeshNodeAttrOfBox",value:function(e,t,i){var n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);var r=t.boundingBox.clone();r.applyMatrix4(n);var a=t.boundingBox,o=a.getSize(),s=a.getCenter(),l=(new THREE.Matrix4).scale(new THREE.Vector3(o.x,o.y,o.z));return l.setPosition(s),n.multiply(l),{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_box",geometryId:"box",boundingBox:r,matrix:n}}},{key:"_getMeshNodeAttrOfBoxM",value:function(e,t,i){var n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);var r=t.boundingBox.clone();return r.applyMatrix4(n),{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_boxM",geometryId:"boxM",boundingBox:r,matrix:n,uvArrayBuffer:e.getGeomBoxUvInfo(t.toData)}}},{key:"_getMeshNodeAttrOfPipeM",value:function(e,t,i){var n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);var r=t.boundingBox.clone();return r.applyMatrix4(n),{nodeId:(i?i.ItemId+"_"+t.ItemId:t.ItemId)+"_pipeM",geometryId:"pipeM",boundingBox:r,matrix:n,uvArrayBuffer:e.getGeomPipeUvInfo(t.toData)}}},{key:"_getMeshNodeAttrOfMeshRef",value:function(e,t,i){var n=e.getMatrixInfo(t.matrixId).matrix.clone();i&&n.multiplyMatrices(i.matrix,n);var r=t.boundingBox.clone();return r.applyMatrix4(n),{nodeId:"refMesh|"+(i?i.ItemId+"_"+t.ItemId:t.ItemId),geometryId:t.toData,boundingBox:r,matrix:n}}},{key:"_getMeshNodeAttr",value:function(e,t,i){var n,r=t.boundingBox.clone();return-1!==t.matrixId?(n=e.getMatrixInfo(t.matrixId).matrix.clone(),i&&n.multiplyMatrices(i.matrix,n),r.applyMatrix4(n)):(n=new THREE.Matrix4,i&&r.applyMatrix4(i.matrix)),{nodeId:i?i.ItemId+"_"+t.ItemId:t.ItemId,geometryId:t.toData,boundingBox:r,matrix:n}}},{key:"_getLineNodeAttr",value:function(e,t,i){var n,r=t.boundingBox.clone();return-1!==t.matrixId?(n=e.getMatrixInfo(t.matrixId).matrix.clone(),i&&n.multiplyMatrices(i.matrix,n),r.applyMatrix4(n)):(n=new THREE.Matrix4,i&&r.applyMatrix4(i.matrix)),{nodeId:i?"line-"+i.ItemId+"-"+t.ItemId:"line-"+t.ItemId,geometryId:"line-"+t.toData,boundingBox:r,matrix:n}}},{key:"_classifyNodeInfo",value:function(e){this._cacheNodeInfoByCellId(e),this._cacheNodeInfoByUserId(e),this._cacheNodeInfoByCategory(e)}},{key:"_cacheNodeInfoByCellId",value:function(e){void 0===this.mapNodeInfoByCellId[e.cellId]&&(this.mapNodeInfoByCellId[e.cellId]=[]),this.mapNodeInfoByCellId[e.cellId].push(e)}},{key:"_cacheNodeInfoByUserId",value:function(e){void 0===this.mapNodeInfoByUserId[e.userId]&&(this.mapNodeInfoByUserId[e.userId]=[]),this.mapNodeInfoByUserId[e.userId].push(e)}},{key:"_cacheNodeInfoByCategory",value:function(e){var t;t=e.instanceOrNot?CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED:CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD,void 0===this.mapNodeInfoByCategory[t]&&(this.mapNodeInfoByCategory[t]={}),void 0===this.mapNodeInfoByCategory[t][e.userId]&&(this.mapNodeInfoByCategory[t][e.userId]=[]),this.mapNodeInfoByCategory[t][e.userId].push(e)}},{key:"_clearNodeInfoCacheWithCellId",value:function(){this.mapNodeInfoByCellId={}}},{key:"_clearNodeInfoCacheWithCategory",value:function(){this.mapNodeInfoByCategory={}}},{key:"_clearNodeInfoCacheWithUserId",value:function(){this.mapNodeInfoByUserId={}}},{key:"clearNodeInfoCache",value:function(){this._clearNodeInfoCacheWithCellId(),this._clearNodeInfoCacheWithUserId(),this._clearNodeInfoCacheWithCategory()}},{key:"getNodeInfosByCellId",value:function(e){return this.mapNodeInfoByCellId[e]}},{key:"getNodeInfosWithCellId",value:function(){return this.mapNodeInfoByCellId}},{key:"getAllNodeInfos",value:function(){return this.mapNodeInfoByUserId}},{key:"getNodeInfosByUserId",value:function(e){return this.mapNodeInfoByUserId[e]}},{key:"getStandardNodeInfos",value:function(){return this.mapNodeInfoByCategory[CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD]}},{key:"getInstancedNodeInfos",value:function(){return this.mapNodeInfoByCategory[CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED]}},{key:"getStandardUserIds",value:function(){return this.getStandardNodeInfos()?Object.keys(this.getStandardNodeInfos()):[]}},{key:"getInstancedUserIds",value:function(){return this.getInstancedNodeInfos()?Object.keys(this.getInstancedNodeInfos()):[]}},{key:"getStandardNodeInfosById",value:function(e){var t=this.getStandardNodeInfos();return t?t[e]:null}},{key:"getInstancedNodeInfosById",value:function(e){var t=this.getInstancedNodeInfos();return t?t[e]:null}},{key:"_getUserIdsByCategory",value:function(e,t){var i,n=[];if(i=t===CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED?this.getInstancedNodeInfos():this.getStandardNodeInfos())for(var r=0,a=e.length;r<a;r++)i[e[r]]&&n.push(e[r]);return n}},{key:"getInstancedUserIdsByCategory",value:function(e){return this._getUserIdsByCategory(e,CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.INSTANCED)}},{key:"getStandardUserIdsByCategory",value:function(e){return this._getUserIdsByCategory(e,CLOUD.ModelView.BaseDescriptor.NodeInfoCategory.STANDARD)}},{key:"_traverseNodeInfosByIds",value:function(e,t,i){for(var n=0,r=t.length;n<r;n++){var a=t[n];i(a,e[a])}}},{key:"traverseStandardNodeInfos",value:function(e,t){var i=this.getStandardNodeInfos();e=e||this.getStandardUserIds(),this._traverseNodeInfosByIds(i,e,t)}},{key:"traverseInstancedNodeInfos",value:function(e,t){var i=this.getInstancedNodeInfos();e=e||this.getInstancedUserIds(),this._traverseNodeInfosByIds(i,e,t)}},{key:"traverseNodeInfosByCell",value:function(e){for(var t=Object.keys(this.mapNodeInfoByCellId),i=0,n=t.length;i<n;i++)for(var r=t[i],a=this.mapNodeInfoByCellId[r],o=0,s=a.length;o<s;o++)e(r,a[o])}},{key:"clearReferencedMeshCache",value:function(){for(var e in this.referencedMeshCache)delete this.referencedMeshCache[e];this.referencedMeshCache=null}},{key:"cacheReferencedMeshBufferData",value:function(e,t){this.referencedMeshCache.bufferData||(this.referencedMeshCache.bufferData={}),this.referencedMeshCache.bufferData[e]=t}},{key:"getReferencedMeshBufferData",value:function(){return this.referencedMeshCache.bufferData}},{key:"getReferencedMeshBufferById",value:function(e){return this.referencedMeshCache&&this.referencedMeshCache.bufferData?this.referencedMeshCache.bufferData[e]:null}},{key:"cacheReferencedMeshMpkIds",value:function(e,t){this.referencedMeshCache.mpkIds||(this.referencedMeshCache.mpkIds={}),this.referencedMeshCache.mpkIds[e]||(this.referencedMeshCache.mpkIds[e]=[]),this.referencedMeshCache.mpkIds[e].push(t)}},{key:"clearReferencedMeshCacheByMpkIdxs",value:function(e,t){if(this.referencedMeshCache.mpkIds)for(var i=0,n=e.length;i<n;i++){var r=e[i],a=this.referencedMeshCache.mpkIds[r];if(a){for(var o=0,s=a.length;o<s;o++)t&&t(a[o]),delete this.referencedMeshCache[a[o]];delete this.referencedMeshCache.mpkIds[r]}}}},{key:"cacheBorderLine",value:function(e,t){var i=e?"shared":"unique";this.borderLines[i]||(this.borderLines[i]=[]),this.borderLines[i].push(t)}},{key:"getSharedBorderLineCache",value:function(){return this.borderLines.shared}},{key:"getUniqueBorderLineCache",value:function(){return this.borderLines.unique}},{key:"_isRegularShape",value:function(e){var t=e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.TUBE||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.PIPE||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.BOX||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.BOX_M||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.PIPE_M;return CLOUD.GlobalData.SharedMeshInstanceEnable&&(t=t||e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF),t}},{key:"getCellCount",value:function(){return this.cellCount}},{key:"getOctreeRootNode",value:function(){return this.octreeRootNode}},{key:"isUseInnerAndOuterOctree",value:function(){return!0}},{key:"isOctreeOuter",value:function(e){var t=this.octreeRootNode.inner||this.octreeRootNode.outer;return!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}},{key:"getOctreeRoots",value:function(e){this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer),this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner)}},{key:"updateOctreeNodeBy",value:function(e,t){function i(e,t){r.copy(e.boundingBoxWorld),r.applyMatrix4(t),e.min.copy(r.min),e.max.copy(r.max),e.center=r.getCenter(),e.size=r.getSize().lengthSq()}function n(e,t){for(var r=0,a=e.childOctants.length;r<a;++r){var o=e.childOctants[r];i(o,t),n(o,t)}}var r=new THREE.Box3;i(e,t),n(e,t)}},{key:"updateOctreeNode",value:function(e){var t=this.getOctreeRootNode();t.outer&&this.updateOctreeNodeBy(t.outer,e),t.inner&&this.updateOctreeNodeBy(t.inner,e)}},{key:"removeFromSceneReaderMap",value:function(e){for(var t=0,i=e.length;t<i;t++)this.mapSceneReader[e[t]]&&delete this.mapSceneReader[e[t]]}},{key:"isUserIdExist",value:function(e){return!!this.getNodeInfosByUserId(e)}},{key:"addToNodeInfoMap",value:function(e){for(var t=0,i=e.length;t<i;t++)this._cacheNodeInfoByUserId(e[t])}},{key:"removeFromNodeInfoMap",value:function(e){for(var t=this.getAllNodeInfos(),i=0,n=e.length;i<n;i++){var r=e[i].userId;t[r]&&delete t[r]}}},{key:"cacheNodeInfosOnGeometryId",value:function(){var e=this.getStandardNodeInfos();this.mapNodeInfoByGeometryId={};for(var t in e)for(var i=e[t],n=0,r=i.length;n<r;n++)i[n].geometryId=this.convertGeometryId(i[n].geometryId),this.mapNodeInfoByGeometryId[i[n].geometryId]||(this.mapNodeInfoByGeometryId[i[n].geometryId]=[]),this.mapNodeInfoByGeometryId[i[n].geometryId].push(i[n])}},{key:"getNodeInfosOnGeometryId",value:function(){return this.mapNodeInfoByGeometryId?this.mapNodeInfoByGeometryId:(this.cacheNodeInfosOnGeometryId(),this.mapNodeInfoByGeometryId)}},{key:"clearNodeInfosWithGeometryId",value:function(){this.mapNodeInfoByGeometryId=null}},{key:"convertGeometryId",value:function(e){return e}}]),e}();e.EnumNodeItemType={SYMBOL:0,MESH:1,TUBE:2,PIPE:3,BOX:4,BOX_M:5,PIPE_M:6,MESH_REF:7,LINE:8},e.NodeInfoCategory={INSTANCED:0,STANDARD:1},CLOUD.ModelView.BaseDescriptor=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.DefaultDescriptor=e}(),function(){var e=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return e.bmeshIdReader=null,e}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.bmeshIdReader=null}},{key:"convertGeometryId",value:function(e){var t=this.bmeshIdReader.getBMeshId(e);return void 0===t&&(t=e),t}}]),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.MergedDataDescriptor=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.LayerDescriptor=e}(),function(){var e=function(e){function t(){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this))}return _inherits(t,e),_createClass(t,[{key:"parseItemData",value:function(){var e=this.getSceneReaderMap();for(var t in e)for(var i=e[t],n=0,r=i.header.itemCount;n<r;++n)this._readItemData(i,n,this.getCellId(t,n));return!0}},{key:"parseItemDataByCellId",value:function(e){var t=this.getSceneReaderMap();for(var i in t){var n=t[i],r=this.getItemIdsBy(e,i);if(r)for(var a=0,o=r.length;a<o;++a){var s=r[a];this._readItemData(n,s,this.getCellId(i,s))}}return!0}},{key:"getLayerIdsByCellId",value:function(e){return this.cellIdMap&&this.cellIdMap[e]?Object.keys(this.cellIdMap[e]):null}},{key:"getItemIdsBy",value:function(e,t){return this.cellIdMap&&this.cellIdMap[e]?this.cellIdMap[e][t]:null}},{key:"cacheToCellIdMap",value:function(e,t,i){this.layerIdMap||(this.layerIdMap={}),this.layerIdMap[t+"&"+i]=e,this.cellIdMap||(this.cellIdMap={}),this.cellIdMap[e]||(this.cellIdMap[e]={}),this.cellIdMap[e][t]||(this.cellIdMap[e][t]=[]),this.cellIdMap[e][t].push(i)}},{key:"getCellId",value:function(e,t){return this.layerIdMap?this.layerIdMap[e+"&"+t]||0:0}},{key:"isOctreeOuter",value:function(e){var t=this.octreeRootNode.layer;return t||(t=this.octreeRootNode.inner||this.octreeRootNode.outer),!(e.x<t.min.x||e.x>t.max.x||e.y<t.min.y||e.y>t.max.y||e.z<t.min.z||e.z>t.max.z)}},{key:"isUseInnerAndOuterOctree",value:function(){return!this.octreeRootNode.layer}},{key:"getOctreeRoots",value:function(e){this.octreeRootNode.layer?e.push(this.octreeRootNode.layer):(this.octreeRootNode.inner&&e.push(this.octreeRootNode.inner),this.octreeRootNode.outer&&e.push(this.octreeRootNode.outer))}},{key:"updateOctreeNode",value:function(e){this.octreeRootNode.layer?this.updateOctreeNodeBy(this.octreeRootNode.layer,e):(this.octreeRootNode.inner&&this.updateOctreeNodeBy(this.octreeRootNode.inner,e),this.octreeRootNode.outer&&this.updateOctreeNodeBy(this.octreeRootNode.outer,e))}}]),t}(CLOUD.ModelView.BaseDescriptor);CLOUD.ModelView.LayerSceneDescriptor=e}(),CLOUD.Loader.IdReader=function(e){var t=new Uint32Array(e,0,2);this.size=t[0],this.count=t[1],this.cache={},this.idBuffer=e.slice(8),t=null},CLOUD.Loader.IdReader.prototype={constructor:CLOUD.Loader.IdReader,getSize:function(){return this.size},getCount:function(){return this.count},getString:function(e){if(void 0!==this.cache[e])return this.cache[e];if(e>=0&&e<this.count){var t=new Uint8Array(this.idBuffer,this.size*e,this.size),i=String.fromCharCode.apply(null,t),n=i.indexOf("\0");return this.cache[e]=-1!==n?i.substring(0,n):i,this.cache[e]}},getIndex:function(e){if(void 0==e)return-1;for(var t=0,i=this.count-1,n=e.length;t<=i;){var r=Math.floor((t+i)/2),a=new Uint8Array(this.idBuffer,this.size*r,n),o=String.fromCharCode.apply(null,a),s=o.indexOf("\0"),l=0;if(0==(l=-1!==s?e.localeCompare(o.substring(0,s)):e.localeCompare(o)))return r;l<0?i=r-1:l>0&&(t=r+1)}return-1}},CLOUD.Loader.UserDataReader=function(e){this.userData=JSON.parse(e),this.count=0;for(var t in this.userData)this.userData.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.userData},this.getUserData=function(e){if(e>=0&&e<this.count)return this.userData[e+""]}},CLOUD.Loader.OctNode=function(e,t){var i=new Uint32Array(e,t,5);this.cell_id=i[0],this.child_s=i[3],this.child_e=i[4];var n=new Float32Array(e,t+20,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5]))},CLOUD.Loader.OctreeReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.data=new Array(this.count);for(var i=0;i<this.count;++i)this.data[i]=new CLOUD.Loader.OctNode(e,4*(1+11*i))},CLOUD.Loader.OctreeReader.prototype={constructor:CLOUD.Loader.OctreeReader,getCount:function(){return this.count},getNode:function(e){if(e>=0&&e<this.count)return this.data[e]}},CLOUD.Loader.Material=function(e,t){var i=new Uint32Array(e,t,8);this.id=i[0],this.type=i[1],this.metal=i[2],this.color=i[3],this.emissive=i[4],this.specular=i[5],this.side=i[6],this.texture_n=i[7],this.texture_id=new Uint32Array(e,t+32,8);var n=new Float32Array(e,t+64,3);this.shininess=n[0],this.opacity=n[1],this.reflectivity=n[2],i=null,n=null},CLOUD.Loader.Texture=function(e,t){var i=new Uint32Array(e,t,4);this.id=i[0],this.type=i[1],this.repeat_u=i[2],this.repeat_v=i[3];var n=new Float32Array(e,t+16,5);this.angle=n[0],this.offset_u=n[1],this.offset_v=n[2],this.scale_u=n[3],this.scale_v=n[4];var r=new Uint8Array(e,t+36,8),a=String.fromCharCode.apply(null,r);this.file_name_ext=a.substring(0,a.indexOf("\0")),i=null,n=null,r=null},CLOUD.Loader.MaterialReader=function(e){var t=new Uint32Array(e,0,4);this.materialCount=t[0],this.materialOffset=t[1],this.textureCount=t[2],this.textureOffset=t[3],this.materialSize=76,this.textureSize=44,this.materialBuffer=e.slice(this.materialOffset,this.materialOffset+this.materialCount*this.materialSize),this.textureBuffer=e.slice(this.textureOffset,this.textureOffset+this.textureCount*this.textureSize),this.material_id=-1,this.texture_id=-1;var i=new ArrayBuffer(this.materialSize);this.material_cur=new CLOUD.Loader.Material(i,0),this.texture_cur=new CLOUD.Loader.Texture(i,0),
t=null,i=null},CLOUD.Loader.MaterialReader.prototype={constructor:CLOUD.Loader.MaterialReader,getMaterial:function(e){if(e>=0&&e<this.materialCount)return new CLOUD.Loader.Material(this.materialBuffer,e*this.materialSize)},getTexture:function(e){if(e>=0&&e<this.textureCount)return new CLOUD.Loader.Texture(this.textureBuffer,e*this.textureSize)},getMaterialInfo:function(e){if(e==this.material_id)return this.material_cur;if(e>=0&&e<this.materialCount){var t=new Uint32Array(this.materialBuffer,e*this.materialSize,8);this.material_cur.id=t[0],this.material_cur.type=t[1],this.material_cur.metal=t[2],this.material_cur.color=t[3],this.material_cur.emissive=t[4],this.material_cur.specular=t[5],this.material_cur.side=t[6],this.material_cur.texture_n=t[7],this.material_cur.texture_id=new Uint32Array(this.materialBuffer,e*this.materialSize+32,8);var i=new Float32Array(this.materialBuffer,e*this.materialSize+64,3);return this.material_cur.shininess=i[0],this.material_cur.opacity=i[1],this.material_cur.reflectivity=i[2],t=null,i=null,this.material_id=e,this.material_cur}},getTextureInfo:function(e){if(e==this.texture_id)return this.texture_cur;if(e>=0&&e<this.textureCount){var t=new Uint32Array(this.textureBuffer,e*this.textureSize,4);this.texture_cur.id=t[0],this.texture_cur.type=t[1],this.texture_cur.repeat_u=t[2],this.texture_cur.repeat_v=t[3];var i=new Float32Array(this.textureBuffer,e*this.textureSize+16,5);this.texture_cur.angle=i[0],this.texture_cur.offset_u=i[1],this.texture_cur.offset_v=i[2],this.texture_cur.scale_u=i[3],this.texture_cur.scale_v=i[4];var n=new Uint8Array(this.textureBuffer,e*this.textureSize+36,8),r=String.fromCharCode.apply(null,n);return this.texture_cur.file_name_ext=r.substring(0,r.indexOf("\0")),t=null,i=null,n=null,this.texture_id=e,this.texture_cur}}},CLOUD.Loader.MaterialReaderJson=function(e){if(this.count=0,this.Data=JSON.parse(e),this.Data.hasOwnProperty("materials")&&(this.materials=this.Data.materials),this.Data.hasOwnProperty("metadata")&&(this.metadata=this.Data.metadata,this.metadata.hasOwnProperty("count")&&(this.count=this.metadata.count)),0===this.count)for(var t in this.materials)this.materials.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getMaterial=function(e){if(e>=0&&e<this.count)return this.materials[e+""]}},CLOUD.Loader.LayerKeyReader=function(e){this.LayerKey=JSON.parse(e),this.count=0;for(var t in this.LayerKey)this.LayerKey.hasOwnProperty(t)&&this.count++;this.getCount=function(){return this.count},this.getData=function(){return this.LayerKey},this.getLayerKey=function(e){if(e>=0&&e<this.count)return this.LayerKey[e+""]}},CLOUD.Loader.LayerHeader=function(e){var t=new Uint32Array(e,0,4);this.layerCount=t[0],this.mpkBufferSize=t[1],this.layerOffset=t[2],this.mpkOffset=t[3];var i=new Float32Array(e,24,4);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},CLOUD.Loader.LayerData=function(e,t){var i=new Int32Array(e,t,3);this.layer_id=i[0],this.layer_mpk_index=i[1],this.layer_mpk_count=i[2];var n=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),i=null,n=null},CLOUD.Loader.LayerReader=function(e){this.header=new CLOUD.Loader.LayerHeader(e),this.DataSize=36,this.dataBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerCount*this.DataSize),this.mpkBuffer=e.slice(this.header.mpkOffset,this.header.mpkOffset+this.header.mpkBufferSize)},CLOUD.Loader.LayerReader.prototype={constructor:CLOUD.Loader.LayerReader,getLayerData:function(e){if(e>=0&&e<this.header.layerCount)return new CLOUD.Loader.LayerData(this.dataBuffer,e*this.DataSize)},getMpkList:function(e){var t=this.getLayerData(e);if(void 0!=t)return new Uint32Array(this.mpkBuffer,4*t.layer_mpk_index,t.layer_mpk_count)},getLayerCount:function(){return this.header.layerCount}},CLOUD.Loader.SymbolHeader=function(e){var t=new Uint32Array(e,0,9);this.blockId=t[0],this.symbolCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.symbolOffset=t[5],this.itemOffset=t[6],this.matrixOffset=t[7],this.geomOffset=t[8];var i=new Float32Array(e,36,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null},CLOUD.Loader.Symbol=function(e,t){var i=new Int32Array(e,t,3);this.symbolId=i[0],this.itemIndex=i[1],this.itemCount=i[2];var n=new Float32Array(e,t+12,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),i=null,n=null},CLOUD.Loader.SymbolReader=function(e){this.header=new CLOUD.Loader.SymbolHeader(e),this.symbolSize=36,this.itemSize=52,this.matrixSize=64,this.geomSize=32,this.maxSize=256,this.boxUvSize=36,this.pipeUvSize=18,this.symbolBuffer=e.slice(this.header.symbolOffset,this.header.symbolOffset+this.header.symbolCount*this.symbolSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.matr_cur_id=-1,this.pt_symb_min=new THREE.Vector3(0,0,0),this.pt_symb_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.symb_cur=new CLOUD.Loader.Symbol(t,0),this.item_cur=new CLOUD.Loader.Item(t,0),this.matr_cur=new CLOUD.Loader.Matrix(t,0),this.pipe_cur=new CLOUD.Loader.GeomPipe(t,0),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},CLOUD.Loader.SymbolReader.prototype={constructor:CLOUD.Loader.SymbolReader,getSymbol:function(e){if(e>=0&&e<this.header.symbolCount)return new CLOUD.Loader.Symbol(this.symbolBuffer,e*this.symbolSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,e*this.matrixSize)},getGeomPipe:function(e){if(e>=0&&index<this.header.geomBuffSize)return new CLOUD.Loader.GeomPipe(this.geomBuffer,e)},getSymbolInfo:function(e){if(e>=0&&e<this.header.symbolCount){var t=new Int32Array(this.symbolBuffer,e*this.symbolSize,3);this.symb_cur.symbolId=t[0],this.symb_cur.itemIndex=t[1],this.symb_cur.itemCount=t[2];var i=new Float32Array(this.symbolBuffer,e*this.symbolSize+12,6);return this.pt_symb_min.set(i[0],i[1],i[2]),this.pt_symb_max.set(i[3],i[4],i[5]),this.symb_cur.boundingBox.set(this.pt_symb_min,this.pt_symb_max),this.symb_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},CLOUD.Loader.MPKHeader=function(e){var t=new Uint32Array(e,0,6);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.bufferSize=t[4],this.bufferOffset=t[5],t=null},CLOUD.Loader.MeshData=function(e,t){var i=new Uint32Array(e,t,5);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.dataOffset=i[3],this.vertexFormat=i[4];var n=new Float32Array(e,t+20,4);this.baseScale=n[0],this.baseX=n[1],this.baseY=n[2],this.baseZ=n[3],i=null,n=null},CLOUD.Loader.MPKReader=function(e){this.header=new CLOUD.Loader.MPKHeader(e),this.meshSize=36,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.geomBuffer=e.slice(this.header.bufferOffset,this.header.bufferOffset+this.header.bufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new CLOUD.Loader.MeshData(t,0)},CLOUD.Loader.MPKReader.prototype={constructor:CLOUD.Loader.MPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new CLOUD.Loader.MeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,5);this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.dataOffset=t[3],this.mesh_cur.vertexFormat=t[4];var i=new Float32Array(this.meshBuffer,e*this.meshSize+20,4);return this.mesh_cur.baseScale=i[0],this.mesh_cur.baseX=i[1],this.mesh_cur.baseY=i[2],this.mesh_cur.baseZ=i[3],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return 0==t.baseScale?new Float32Array(this.geomBuffer,t.dataOffset,3*t.ptCount):new Uint16Array(this.geomBuffer,t.dataOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),CLOUD.Compatibility.use32MpkData?new Uint32Array(this.geomBuffer,i,t.idxCount):t.ptCount>65535?new Uint32Array(this.geomBuffer,i,t.idxCount):new Uint16Array(this.geomBuffer,i,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),CLOUD.Compatibility.use32MpkData?i+=4*t.idxCount:t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),new Float32Array(this.geomBuffer,i,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vertexFormat))return;var i=t.dataOffset;return 0==t.baseScale?i+=3*t.ptCount*4:(i+=3*t.ptCount*2,t.ptCount%2==1&&(i+=2)),CLOUD.Compatibility.use32MpkData?i+=4*t.idxCount:t.ptCount>65535?i+=4*t.idxCount:(i+=2*t.idxCount,t.idxCount%2==1&&(i+=2)),2==(2&this.header.vtFormat)&&(i+=3*t.ptCount*4),new Float32Array(this.geomBuffer,i,2*t.ptCount)}}},CLOUD.Loader.BMPKHeader=function(e){var t=new Uint32Array(e,0,12);this.blockId=t[0],this.vtFormat=t[1],this.meshCount=t[2],this.meshOffset=t[3],this.ptBufferSize=t[4],this.ptBufferOffset=t[5],this.idxBufferSize=t[6],this.idxBufferOffset=t[7],this.norBufferSize=t[8],this.norBufferOffset=t[9],this.uvBufferSize=t[10],this.uvBufferOffset=t[11],t=null},CLOUD.Loader.BMeshData=function(e,t){var i=new Uint32Array(e,t,8);this.mesh_id=i[0],this.ptCount=i[1],this.idxCount=i[2],this.vFormat=i[3],this.vOffset=i[4],this.iOffset=i[5],this.nOffset=i[6],this.tOffset=i[7],i=null},CLOUD.Loader.BMPKReader=function(e){this.header=new CLOUD.Loader.BMPKHeader(e),this.meshSize=32,this.maxSize=256,this.meshBuffer=e.slice(this.header.meshOffset,this.header.meshOffset+this.header.meshCount*this.meshSize),this.vBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.iBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.nBuffer=e.slice(this.header.norBufferOffset,this.header.norBufferOffset+this.header.norBufferSize),this.tBuffer=e.slice(this.header.uvBufferOffset,this.header.uvBufferOffset+this.header.uvBufferSize),this.mesh_cur_id=-1;var t=new ArrayBuffer(this.maxSize);this.mesh_cur=new CLOUD.Loader.BMeshData(t,0)},CLOUD.Loader.BMPKReader.prototype={constructor:CLOUD.Loader.BMPKReader,getMeshData:function(e){if(e>=0&&e<this.header.meshCount)return new CLOUD.Loader.BMeshData(this.meshBuffer,e*this.meshSize)},getMeshInfo:function(e){if(e==this.mesh_cur_id)return this.mesh_cur;if(e>=0&&e<this.header.meshCount){var t=new Uint32Array(this.meshBuffer,e*this.meshSize,8);return this.mesh_cur.mesh_id=t[0],this.mesh_cur.ptCount=t[1],this.mesh_cur.idxCount=t[2],this.mesh_cur.vFormat=t[3],this.mesh_cur.vOffset=t[4],this.mesh_cur.iOffset=t[5],this.mesh_cur.nOffset=t[6],this.mesh_cur.tOffset=t[7],this.mesh_cur_id=e,this.mesh_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.vBuffer,t.vOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Uint32Array(this.iBuffer,t.iOffset,t.idxCount)}},getNormalBuffer:function(e){if(2==(2&this.header.vtFormat)&&e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t)return;return new Float32Array(this.nBuffer,t.nOffset,3*t.ptCount)}},getUVBuffer:function(e){if(e>=0&&e<this.header.meshCount){var t=this.getMeshInfo(e);if(void 0===t||4!=(4&t.vFormat))return;return new Float32Array(this.tBuffer,t.tOffset,2*t.ptCount)}}},CLOUD.Loader.BMeshIdReader=function(e){var t=new Uint32Array(e,0,1);this.count=t[0],this.cache={};for(var i=new Uint32Array(e,4,this.count),n=0;n<this.count;n+=2){var r=i[n];this.cache[r]=i[n+1]}t=null,i=null},CLOUD.Loader.BMeshIdReader.prototype={constructor:CLOUD.Loader.BMeshIdReader,getCount:function(){return this.count},getBMeshId:function(e){return this.cache[e]}},CLOUD.Loader.LineHeader=function(e){var t=new Uint32Array(e,0,7);this.blockId=t[0],this.lineCount=t[1],this.lineOffset=t[2],this.ptBufferSize=t[3],this.ptBufferOffset=t[4],this.idxBufferSize=t[5],this.idxBufferOffset=t[6],t=null},CLOUD.Loader.LineData=function(e,t){var i=new Uint32Array(e,t,6);this.line_id=i[0],this.lineType=i[1],this.ptCount=i[2],this.ptOffset=i[3],this.idxCount=i[4],this.idxOffset=i[5],i=null},CLOUD.Loader.LineReader=function(e){this.header=new CLOUD.Loader.LineHeader(e),this.lineSize=24,this.ptSize=12,this.lineBuffer=e.slice(this.header.lineOffset,this.header.lineOffset+this.header.lineCount*this.lineSize),this.ptBuffer=e.slice(this.header.ptBufferOffset,this.header.ptBufferOffset+this.header.ptBufferSize),this.idxBuffer=e.slice(this.header.idxBufferOffset,this.header.idxBufferOffset+this.header.idxBufferSize),this.line_cur_id=-1;var t=new ArrayBuffer(this.lineSize);this.line_cur=new CLOUD.Loader.LineData(t,0)},CLOUD.Loader.LineReader.prototype={constructor:CLOUD.Loader.LineReader,getLineData:function(e){if(e>=0&&e<this.header.lineCount)return new CLOUD.Loader.LineData(this.lineBuffer,e*this.lineSize)},getLineInfo:function(e){if(e==this.line_cur_id)return this.line_cur;if(e>=0&&e<this.header.lineCount){var t=new Uint32Array(this.lineBuffer,e*this.lineSize,6);return this.line_cur.line_id=t[0],this.line_cur.lineType=t[1],this.line_cur.ptCount=t[2],this.line_cur.ptOffset=t[3],this.line_cur.idxCount=t[4],this.line_cur.idxOffset=t[5],this.line_cur_id=e,this.line_cur}},getPtBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;return new Float32Array(this.ptBuffer,t.ptOffset,3*t.ptCount)}},getIdxBuffer:function(e){if(e>=0&&e<this.header.lineCount){var t=this.getLineInfo(e);if(void 0===t)return;var i=new Uint32Array(this.idxBuffer,t.idxOffset,t.idxCount),n=t.ptOffset/this.ptSize;return i.forEach(function(e,t,i){i[t]-=n}),i}}},CLOUD.Loader.CameraReader=function(e){this.cameras=JSON.parse(e)},CLOUD.Loader.CameraReader.prototype.parse=function(e,t){function i(e,i){i.uuid=e.uuid,void 0!==e.name&&(i.name=e.name);var n=new THREE.Matrix4;if(void 0!==e.matrix)n.fromArray(e.matrix);else{var r=new THREE.Vector3,a=new THREE.Quaternion,o=new THREE.Vector3;if(void 0!==e.position&&r.fromArray(e.position),void 0!==e.rotation){var s=new THREE.Vector3;s.fromArray(e.rotation);var l=new THREE.Euler(s[0]*Math.PI/180,s[1]*Math.PI/180,s[2]*Math.PI/180,"XYZ");a.setFromEuler(l)}void 0!==e.quaternion&&a.fromArray(e.quaternion,0),void 0!==e.scale&&i.scale.fromArray(e.scale),n.compose(r,a,o)}n.multiply(t),n.decompose(i.position,i.quaternion,i.scale)}var n,r,a=this.cameras;if(a.Orthographic){var o=a.Orthographic;for(var s in o)r=o[s],n=new CLOUD.Camera(CLOUD.CAMERATYPE.ORTHOGRAPHIC,r),i(r,n),e.addCamera(n)}if(a.Perspective){var l=a.Perspective;for(var s in l)r=l[s],n=new CLOUD.Camera(CLOUD.CAMERATYPE.PERSPECTIVE,r),void 0!==r.focus&&(n.focus=r.focus),void 0!==r.zoom&&(n.zoom=r.zoom),void 0!==r.filmGauge&&(n.filmGauge=r.filmGauge),void 0!==r.filmOffset&&(n.filmOffset=r.filmOffset),void 0!==r.view&&(n.view=Object.assign({},r.view)),i(r,n),e.addCamera(n)}},CLOUD.Loader.SceneHeader=function(e){var t=new Uint32Array(e,0,11);this.blockId=t[0],this.cellCount=t[1],this.itemCount=t[2],this.matrixCount=t[3],this.geomBuffSize=t[4],this.layerBuffSize=t[5],this.cellOffset=t[6],this.itemOffset=t[7],this.matrixOffset=t[8],this.geomOffset=t[9],this.layerOffset=t[10];var i=new Float32Array(e,44,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(i[0],i[1],i[2]),new THREE.Vector3(i[3],i[4],i[5])),t=null,i=null};CLOUD.Loader.Cell=function(e,t){var i=new Int32Array(e,t,5);this.cellId=i[0],this.depth=i[1],this.itemIndex=i[2],this.itemCount=i[3],this.layerType=i[4],this.layerSize=new Int32Array(e,t+20,8),this.layerOffset=new Int32Array(e,t+52,8);var n=new Float32Array(e,t+84,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),i=null,n=null},CLOUD.Loader.Item=function(e,t){var i=new Int32Array(e,t,7);this.ItemId=i[0],this.originalId=i[1],this.materialId=i[2],this.userDataId=i[3],this.matrixId=i[4],this.type=i[5],this.toData=i[6];var n=new Float32Array(e,t+28,6);this.boundingBox=new THREE.Box3(new THREE.Vector3(n[0],n[1],n[2]),new THREE.Vector3(n[3],n[4],n[5])),i=null,n=null},CLOUD.Loader.Matrix=function(e,t){var i=new Float32Array(e,t,16);this.matrix=(new THREE.Matrix4).fromArray(i),i=null},CLOUD.Loader.GeomPipe=function(e,t){var i=new Float32Array(e,t,8);this.startPt=new THREE.Vector3(i[0],i[1],i[2]),this.endPt=new THREE.Vector3(i[3],i[4],i[5]),this.radius=i[6],this.thickness=i[7],i=null},CLOUD.Loader.SceneReader=function(e){this.header=new CLOUD.Loader.SceneHeader(e),this.cellSize=108,this.itemSize=52,this.matrixSize=64,this.maxSize=1024,this.boxUvSize=36,this.pipeUvSize=18,this.cellBuffer=e.slice(this.header.cellOffset,this.header.cellOffset+this.header.cellCount*this.cellSize),this.itemBuffer=e.slice(this.header.itemOffset,this.header.itemOffset+this.header.itemCount*this.itemSize),this.matrixBuffer=e.slice(this.header.matrixOffset,this.header.matrixOffset+this.header.matrixCount*this.matrixSize),this.geomBuffer=e.slice(this.header.geomOffset,this.header.geomOffset+this.header.geomBuffSize),this.layerBuffer=e.slice(this.header.layerOffset,this.header.layerOffset+this.header.layerBuffSize),this.matr_cur_id=-1,this.pt_cell_min=new THREE.Vector3(0,0,0),this.pt_cell_max=new THREE.Vector3(0,0,0),this.pt_item_min=new THREE.Vector3(0,0,0),this.pt_item_max=new THREE.Vector3(0,0,0);var t=new ArrayBuffer(this.maxSize);this.cell_cur=new CLOUD.Loader.Cell(t,0),this.item_cur=new CLOUD.Loader.Item(t,0),this.matr_cur=new CLOUD.Loader.Matrix(t,0),this.pipe_cur=new CLOUD.Loader.GeomPipe(t,0),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max)},CLOUD.Loader.SceneReader.prototype={constructor:CLOUD.Loader.SceneReader,getCellMpks:function(e){if(e>=0&&e<this.header.cellCount){for(var t=[],i=this.getCellInfo(e),n=i.itemIndex;n<i.itemCount;++n){var r=this.getItemInfo(n);if(1===r.type){var a=this.getMpkID(r.toData);t.push(a)}}for(var o={},s=[],l=0;l<t.length;++l)o[t[l]]||(o[t[l]]=!0,s.push(t[l]));return s}},getCell:function(e){if(e>=0&&e<this.header.cellCount)return new CLOUD.Loader.Cell(this.cellBuffer,e*this.cellSize)},getItem:function(e){if(e>=0&&e<this.header.itemCount)return new CLOUD.Loader.Item(this.itemBuffer,e*this.itemSize)},getMatrix:function(e){if(e>=0&&e<this.header.matrixCount)return new CLOUD.Loader.Matrix(this.matrixBuffer,e*this.matrixSize)},getGeomPipe:function(e){if(e>=0&&e<this.header.geomBuffSize)return new CLOUD.Loader.GeomPipe(this.geomBuffer,e)},getCellInfo:function(e){if(e>=0&&e<this.header.cellCount){var t=new Int32Array(this.cellBuffer,e*this.cellSize,5);this.cell_cur.cellId=t[0],this.cell_cur.depth=t[1],this.cell_cur.itemIndex=t[2],this.cell_cur.itemCount=t[3],this.cell_cur.layerType=t[4],this.cell_cur.layerSize=new Int32Array(this.cellBuffer,e*this.cellSize+20,8),this.cell_cur.layerOffset=new Int32Array(this.cellBuffer,e*this.cellSize+52,8);var i=new Float32Array(this.cellBuffer,e*this.cellSize+84,6);return this.pt_cell_min.set(i[0],i[1],i[2]),this.pt_cell_max.set(i[3],i[4],i[5]),this.cell_cur.boundingBox.set(this.pt_cell_min,this.pt_cell_max),this.cell_cur}},getItemInfo:function(e){if(e>=0&&e<this.header.itemCount){var t=new Int32Array(this.itemBuffer,e*this.itemSize,7);this.item_cur.ItemId=t[0],this.item_cur.originalId=t[1],this.item_cur.materialId=t[2],this.item_cur.userDataId=t[3],this.item_cur.matrixId=t[4],this.item_cur.type=t[5],this.item_cur.toData=t[6];var i=new Float32Array(this.itemBuffer,e*this.itemSize+28,6);return this.pt_item_min.set(i[0],i[1],i[2]),this.pt_item_max.set(i[3],i[4],i[5]),this.item_cur.boundingBox.set(this.pt_item_min,this.pt_item_max),this.item_cur}},getMatrixInfo:function(e){if(e==this.matr_cur_id)return this.matr_cur;if(e>=0&&e<this.header.matrixCount){var t=new Float32Array(this.matrixBuffer,e*this.matrixSize,16);return this.matr_cur.matrix.fromArray(t),this.matr_cur_id=e,this.matr_cur}},getGeomPipeInfo:function(e){if(e>=0&&e<this.header.geomBuffSize){var t=new Float32Array(this.geomBuffer,e,8);return this.pipe_cur.startPt.set(t[0],t[1],t[2]),this.pipe_cur.endPt.set(t[3],t[4],t[5]),this.pipe_cur.radius=t[6],this.pipe_cur.thickness=t[7],this.pipe_cur}},getGeomBoxUvInfo:function(e){if(e>=0&&e+4*this.boxUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.boxUvSize)},getGeomPipeUvInfo:function(e){if(e>=0&&e+4*this.pipeUvSize<=this.header.geomBuffSize)return new Float32Array(this.geomBuffer,e,this.pipeUvSize)},getLayerInfo:function(e,t){if(e>=0&&e+t<=this.header.layerBuffSize){new Uint32Array(this.layerBuffer,e,t);return this.data}},getMpkID:function(e){return parseInt(e/65536)},getMeshIndex:function(e){return parseInt(e%65536)}},CLOUD.Loader.LayerIndex=function(e,t){var i=new Uint32Array(e,t,2);this.layer_id=i[0],this.item_index=i[1]},CLOUD.Loader.LayerIndexReader=function(e){var t=new Uint32Array(e,0,2);this.cell_count=t[0],this.data_count=t[1],this.headerSize=8,this.cellSize=108,this.dataSize=8;var i=this.cell_count*this.cellSize,n=this.data_count*this.dataSize;this.cellBuffer=e.slice(this.headerSize,this.headerSize+i),this.dataBuffer=e.slice(this.headerSize+i,this.headerSize+i+n)},CLOUD.Loader.LayerIndexReader.prototype={constructor:CLOUD.Loader.LayerIndexReader,getCell:function(e){if(e>=0&&e<this.cell_count)return new CLOUD.Loader.Cell(this.cellBuffer,e*this.cellSize)},getLayerIndex:function(e){if(e>=0&&e<this.data_count)return new CLOUD.Loader.LayerIndex(this.dataBuffer,e*this.dataSize)}},function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.conditionsChanged=!0,this.nodeInfosWithLayerKey={},this.cachedLayerData={},this.cacheAttributes=null,this.cacheSpecialtysLevels={},this.mapLayerKeys={},this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.lastUsedLayerData=null,this.mapNeededConditions=null}return _createClass(e,[{key:"destroy",value:function(){this.cachedLayerData=null,this.nodeInfosWithLayerKey=null,this.cacheAttributes=null,this.cacheSpecialtysLevels=null,this.mapLayerKeys=null,this.lastUsedLayerData=null,this.lastUsedMpkIdxsObject=null,this.lastUsedLayerIdsObject=null,this.mapNeededConditions=null}},{key:"clearData",value:function(){}},{key:"loadLayerDataByIdxs",value:function(e,t,i,n){}},{key:"dealLayerDataLoading",value:function(e,t,i,n,r){}},{key:"loadMpkOnDemand",value:function(e,t,i,n,r){var a=e?this.getAllLayerIdxData():this.getUsedLayerIdxData();this.dealLayerDataLoading(this.getLayerIdxInfoByLayerData(a),t,i,n,r)}},{key:"getUsedIdxsInfoFrom",value:function(e,t){var i,n={},r={},a={},o={};if(e&&e.length)for(var s=0,l=e.length;s<l;++s)i=e[s],n[i]=!0;if(t)if(CLOUD.Utils.isEmptyObject(n))a=t;else{for(i in t)n[i]&&(o[i]=!0);if(CLOUD.Utils.isEmptyObject(o))r=n,a=t;else{for(i in t)o[i]||(a[i]=!0);for(i in n)o[i]||(r[i]=!0)}}else CLOUD.Utils.isEmptyObject(n)||(r=n);return{objCurrUsedIdxs:n,addIdxs:Object.keys(r),removeIdxs:Object.keys(a)}}},{key:"getLayerIdxInfoByLayerData",value:function(e){var t,i;e?(t=e.layerIds,i=e.mpkIdxs):(t=null,i=null);var n=this.getUsedIdxsInfoFrom(t,this.lastUsedLayerIdsObject);this.lastUsedLayerIdsObject=n.objCurrUsedIdxs;var r=this.getUsedIdxsInfoFrom(i,this.lastUsedMpkIdxsObject);return this.lastUsedMpkIdxsObject=r.objCurrUsedIdxs,{layerScene:n,mpk:r}}},{key:"getUsedLayerIdxData",value:function(){if(!this.isConditionsChanged()&&this.lastUsedLayerData)return this.lastUsedLayerData;this.setConditionsChanged(!1);var e=this.getConditionsOnDemand();if(!e)return this.lastUsedLayerData=null,null;var t=this.getCachedLayerData(),i=[],n=[],r=[],a=[];for(var o in e)if(t[o]){for(var s=t[o].mpkIdxs,l=0,c=s.length;l<c;++l)r.push(s[l]);i.push(o),n.push(t[o].layerId),a.push(t[o].boundingBox)}return this.lastUsedLayerData={layerIds:n,layerKeys:i,boundingBoxes:a,mpkIdxs:r},this.lastUsedLayerData}},{key:"getAllLayerIdxData",value:function(){this.setConditionsChanged(!1);var e=this.getCachedLayerData();if(!e)return null;var t=[],i=[],n=[],r=[];for(var a in e){for(var o=e[a].mpkIdxs,s=0,l=o.length;s<l;++s)n.push(o[s]);t.push(a),i.push(e[a].layerId),r.push(e[a].boundingBox)}return{layerIds:i,layerKeys:t,boundingBoxes:r,mpkIdxs:n}}},{key:"getUserIdsOnDemand",value:function(){var e={},t=this.nodeInfosWithLayerKey,i=this.getConditionsOnDemand();if(i)for(var n in i){var r=t[n];if(r)for(var a=0,o=r.length;a<o;a++)e[r[a].userId]=!0}else for(var n in t){var r=t[n];if(r)for(var a=0,o=r.length;a<o;a++)e[r[a].userId]=!0}return e}},{key:"cacheLayerData",value:function(e,t){this.cachedLayerData[e]=t}},{key:"getCachedLayerData",value:function(){return this.cachedLayerData}},{key:"clearNodeInfoCacheWithLayerKey",value:function(){this.nodeInfosWithLayerKey={}}},{key:"cacheNodeInfoByLayerKey",value:function(e,t){this.nodeInfosWithLayerKey[e]||(this.nodeInfosWithLayerKey[e]=[]),this.nodeInfosWithLayerKey[e].push(t)}},{key:"cacheNodeInfosWithLayerKey",value:function(){var e=this.model.getModelDescriptor().getAllNodeInfos();for(var t in e)for(var i=e[t],n=0,r=i.length;n<r;n++){var a=i[n],o=this.formatLayerIds(a.userData);this.cacheNodeInfoByLayerKey(o[0],a)}}},{key:"cacheLayerKeys",value:function(e){this.mapLayerKeys=e;var t={},i=this.getLayerKeyAttributes();for(var n in e){var r=e[n],a=r[i[0]],o=r[i[1]];t.hasOwnProperty(a)||(t[a]=[]),t.hasOwnProperty(o)||(t[o]=[]),t[a].push(o),t[o].push(a)}this.cacheSpecialtysLevels=t}},{key:"getLayerKeyAttributes",value:function(){if(this.cacheAttributes)return this.cacheAttributes;var e=[],t=Object.keys(this.mapLayerKeys),i=t[0],n=this.mapLayerKeys[i];for(var r in n)n.hasOwnProperty(r)&&e.push(r);return this.cacheAttributes=e,this.cacheAttributes}},{key:"formatLayerIds",value:function(e){var t=[];if(!e)return t.push("unknown"),t;var i=this.getLayerKeyAttributes(),n=e[i[0]],r=e[i[1]];if(e.hasOwnProperty(i[0])&&e.hasOwnProperty(i[1]))if(n instanceof Array&&r instanceof Array)for(var a=0;a<n.length;a++)for(var o=0;o<r.length;o++){var s=n[a]+"-"+r[o];t.push(s)}else if(n instanceof Array)for(var o=0;o<n.length;o++){var s=n[o]+"-"+r;t.push(s)}else if(r instanceof Array)for(var o=0;o<r.length;o++){var s=n+"-"+r[o];t.push(s)}else{var s=n+"-"+r;t.push(s)}else if(e.hasOwnProperty(i[0]))if(e.hasOwnProperty(i[1]))t.push("unknown"),console.warn("Object has no "+i[0]+" and "+i[1]);else if(n instanceof Array)for(var o=0;o<n.length;o++)for(var l=n[o],c=this.getLevelsOrSpecialtys(l),a=0;a<c.length;a++)s=l+"-"+c[a],t.push(s);else for(var l=n,c=this.getLevelsOrSpecialtys(l),a=0;a<c.length;a++)s=l+"-"+c[a],t.push(s);else if(r instanceof Array)for(var o=0;o<r.length;o++)for(var l=r[o],c=this.getLevelsOrSpecialtys(l),a=0;a<c.length;a++)s=c[a]+"-"+l,t.push(s);else for(var l=r,c=this.getLevelsOrSpecialtys(l),a=0;a<c.length;a++)s=c[a]+"-"+l,t.push(s);return t}},{key:"getLevelsOrSpecialtys",value:function(e){return this.cacheSpecialtysLevels.hasOwnProperty(e)?this.cacheSpecialtysLevels[e]:(console.warn("Attribute "+e+"has no according levels or specialtys."),[])}},{key:"getUnionBoundingBoxOnDemand",value:function(){var e=this.getBoundingBoxesOnDemand();if(e&&e.length>0){for(var t=new THREE.Box3,i=0,n=e.length;i<n;++i)t.union(e[i]);return t}return null}},{key:"getBoundingBoxesOnDemand",value:function(){var e=this.getUsedLayerIdxData();return e?e.boundingBoxes:null}},{key:"setConditionsOnDemandLoad",value:function(e){var t;if(e&&e instanceof Array){t={};for(var i=0,n=e.length;i<n;i++)for(var r=e[i],a=this.formatLayerIds(r),o=0;o<a.length;o++)t.hasOwnProperty(a[o])||(t[a[o]]=!0)}else t=null;this.mapNeededConditions=t,this.setConditionsChanged(!0)}},{key:"setConditionsChanged",value:function(e){this.conditionsChanged=e}},{key:"getConditionsOnDemand",value:function(){return this.mapNeededConditions}},{key:"isConditionsChanged",value:function(){return this.conditionsChanged}}]),e}();CLOUD.LayerBaseProvider=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"loadLayerDataByIdxs",value:function(e,t,i,n){this.model.getLoader().resetProcessState(t.length),this.model.getLoader().loadMpkOnDemand(t,function(e,t){i&&i(t-e,t)},n)}},{key:"dealLayerDataLoading",value:function(e,t,i,n,r){var a=e.mpk;if(0===a.addIdxs.length&&0===a.removeIdxs.length)return void(t&&t(r));var o=!1;a.removeIdxs.length>0&&(o=!0,i&&i(null,a.removeIdxs)),a.addIdxs.length>0?this.loadLayerDataByIdxs(null,a.addIdxs,n,function(){t&&t(r)}):o?t&&t(r):r&&r()}}]),t}(CLOUD.LayerBaseProvider);CLOUD.LayerProvider=e}(),function(){var e=function(e){function t(e){return _classCallCheck(this,t),_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e))}return _inherits(t,e),_createClass(t,[{key:"clearData",value:function(){this.model.getModelDescriptor().clearNodeInfoCache(),this.clearNodeInfoCacheWithLayerKey()}},{key:"loadLayerDataByIdxs",value:function(e,t,i,n){var r=this.model.getLoader(),a=e.length,o=t.length;if(a&&o){var s=a+o;r.resetProcessState(s),r.loadLayerScenesOnDemand(e,function(e,t){i&&i(t-e,s)},function(){r.loadMpkOnDemand(t,function(e,t){i&&i(t-e+a,s)},n)})}else a?(r.resetProcessState(a),r.loadLayerScenesOnDemand(e,function(e,t){i&&i(t-e,t)},n)):o&&(r.resetProcessState(o),r.loadMpkOnDemand(t,function(e,t){i&&i(t-e,t)},n))}},{key:"dealLayerDataLoading",value:function(e,t,i,n,r){var a=e.mpk,o=e.layerScene;if(0===a.addIdxs.length&&0===a.removeIdxs.length&&0===o.addIdxs.length&&0===o.removeIdxs.length)return void(t&&t(r));var s=!1
;(a.removeIdxs.length>0||o.removeIdxs.length>0)&&(s=!0,i&&i(o.removeIdxs,a.removeIdxs)),o.addIdxs.length>0||a.addIdxs.length>0?this.loadLayerDataByIdxs(o.addIdxs,a.addIdxs,n,function(){t&&t(r)}):s?t&&t(r):r&&r()}}]),t}(CLOUD.LayerBaseProvider);CLOUD.LayerSceneProvider=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t,this.defaultManager=null,this.instancedManager=null,this.loader=null,this.loaded=!1,this.dataReady=!1,this.borderlinesLoaded=!1,this.borderlinesGenerated=!1}return _createClass(e,[{key:"destroy",value:function(){this.model=null,this.defaultManager.destroy(),this.defaultManager=null,this.instancedManager.destroy(),this.instancedManager=null}},{key:"load",value:function(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load(function(){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START})},function(e){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:e})},function(){t.prepareData(function(){t.processLoadCompleted(function(){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})})})})}},{key:"processLoadCompleted",value:function(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.updateOctreeNode();var i=t.manager.filter,n=t.manager.getNodeInfos();i.initFilterManager(n),requestAnimationFrame(function(){t.setLoaded(!0),e&&e(),t.updateMeshNodes(),t.applyFilter(),t.debut(t)})}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().parseItemData(function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepareWireframe",value:function(e,t){if(e.isActivateWireframe())if(CLOUD.GlobalData.BorderLineDelayLoaded&&this.loader.getAllBorderlineCount())if(this.borderlinesLoaded)this.borderlinesGenerated&&(this.defaultManager.asyncGenerateWireframe(e),this.instancedManager.generateWireframe(e));else{this.borderlinesLoaded=!0;var i=this;this.loader.delayLoadBorderlines(function(){i.instancedManager.generateWireframe(e),i.defaultManager.asyncGenerateWireframe(e,function(){i.borderlinesGenerated=!0,t&&t()})})}else this.defaultManager.generateWireframe(e),this.instancedManager.generateWireframe(e)}},{key:"prepare",value:function(e){}},{key:"needUpdate",value:function(){return!0}},{key:"updateNodes",value:function(){this.needUpdate()&&(this.defaultManager.updateNodes(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.updateNodes(this.model))}},{key:"isLoaded",value:function(){return this.loaded}},{key:"isDataReady",value:function(){return this.loaded}},{key:"isAllReady",value:function(){return!0}},{key:"isHidden",value:function(){var e=this.model;return!e.visible&&(e.manager.scene.removeObjectGroupByName(e._getWireframeGroupName()),!0)}},{key:"settleData",value:function(e){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"applyFilter",value:function(){this.isLoaded()&&(this.defaultManager.applyFilter(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyFilter(this.model))}},{key:"applySelection",value:function(){this.isLoaded()&&(this.defaultManager.applySelection(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applySelection(this.model))}},{key:"clearSelection",value:function(){this.isLoaded()&&(this.defaultManager.clearSelection(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.clearSelection(this.model))}},{key:"applyHover",value:function(){this.isLoaded()&&(this.defaultManager.applyHover(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyHover(this.model))}},{key:"clearHover",value:function(){this.isLoaded()&&(this.defaultManager.clearHover(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.clearHover(this.model))}},{key:"applyBlink",value:function(){this.isLoaded()&&(this.defaultManager.applyBlink(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyBlink(this.model))}},{key:"clearBlink",value:function(){this.isLoaded()&&(this.defaultManager.clearBlink(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.clearBlink(this.model))}},{key:"applyReplacement",value:function(){this.isLoaded()&&(this.defaultManager.applyReplacement(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.applyReplacement(this.model))}},{key:"getMeshesByUserIds",value:function(e,t){this.isLoaded()&&(this.defaultManager.getMeshesByUserIds(this.model,e,t),CLOUD.GlobalData.Instance&&(this.instancedManager.getMeshesByUserId(this.model,e),this.instancedManager.getMeshesByUserId(this.model,t)))}},{key:"rebuildIndicesforLightmap",value:function(){this.defaultManager.rebuildIndices(this.model)}},{key:"adjustVisibility",value:function(e){this.defaultManager.adjustVisibility(this.model,e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){this.defaultManager.changeVisibilityOfSelectedObjects(this.model,e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){this.defaultManager.changeVisibilityOfNonSelectedObjects(this.model,e)}},{key:"adjustInstanceVisibility",value:function(e){this.instancedManager.adjustVisibility(this.model,e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){this.instancedManager.changeVisibilityOfSelectedObjects(this.model,e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){this.instancedManager.changeVisibilityOfNonSelectedObjects(this.model,e)}},{key:"restoreVisibilityOfObjects",value:function(){this.defaultManager.restoreVisibilityOfObjects(),this.instancedManager.restoreVisibilityOfObjects()}},{key:"getBlinkMaterials",value:function(){var e=[],t=this.model.materialManager.instanceMaterials;for(var i in t)for(var n=t[i],r=0,a=n.length;r<a;r++)e.push(n[r]);return e=e.concat(this.defaultManager.meshManager.getBlinkMaterials())}},{key:"disposeBufferAfterVbo",value:function(){this.isLoaded()&&(this.defaultManager.disposeBufferAfterVbo(),this.instancedManager.disposeBufferAfterVbo())}},{key:"getGeometryBuffersByUserId",value:function(e){if(!this.isLoaded())return[];var t=[];return t=t.concat(this.defaultManager.getGeometryBuffersByUserId(this.model,e)),t=t.concat(this.instancedManager.getGeometryBuffersByUserId(this.model,e))}},{key:"explode",value:function(){this.isLoaded()&&(this.defaultManager.explode(this.model),CLOUD.GlobalData.Instance&&this.instancedManager.explode(this.model))}}]),e}();CLOUD.ModelBaseHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="default",i.compositedManager=new CLOUD.IncrementCompositedManager,i.defaultManager=i.compositedManager.defaultManager,i.instancedManager=i.compositedManager.instancedManager,i.loader=new CLOUD.ModelView.DefaultLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,function(){t.dataReady=!0,t.settleData(e)})}}},{key:"settleData",value:function(e){this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}},{key:"isAllReady",value:function(){return!(!this.isLoaded()||this.isHidden())}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}}]),t}(CLOUD.ModelBaseHandler);CLOUD.IncrementHandler=e}(),function(){var e=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="default",n.defaultManager=new CLOUD.BatchedManager(i),n.instancedManager=new CLOUD.InstancedManager,n.loader=new CLOUD.ModelView.DefaultLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(),!this.model.lightmap||this.model.enableLightmap==CLOUD.GlobalData.EnableLightmap&&this.model.lightmapIntensity==CLOUD.GlobalData.LightmapIntensity&&i==CLOUD.GlobalData.EnableTextureMapping||(this.model.enableLightmap=CLOUD.GlobalData.EnableLightmap,this.model.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}},{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.loader.getDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"createMeshNodes",value:function(e){var t=this,i=this.model,n=this.loader.getDescriptor();this.instancedManager.createMeshNodes(i,n.getInstancedUserIds()),this.defaultManager.asyncCreateMeshNodes(i,n.getStandardUserIds(),function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()})}},{key:"clearCachedData",value:function(){this.loader.getDescriptor().destroyReader(),this.loader.getDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}]),t}(CLOUD.ModelBaseHandler);CLOUD.BatchedHandler=e}(),function(){var e=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="merge_data",n.defaultManager=new CLOUD.BatchedManager(i),n.instancedManager=new CLOUD.InstancedManager,n.loader=new CLOUD.ModelView.MergedDataLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){if(this.isLoaded()&&!this.isHidden()){this.prepareWireframe(this.model,t);var i=this.model.getMaterialManager().lastTextureEnabled;this.model.getMaterialManager()._updateTextureMapping(),!this.model.lightmap||this.model.enableLightmap==CLOUD.GlobalData.EnableLightmap&&this.model.lightmapIntensity==CLOUD.GlobalData.LightmapIntensity&&i==CLOUD.GlobalData.EnableTextureMapping||(this.model.enableLightmap=CLOUD.GlobalData.EnableLightmap,this.model.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,this.rebuildIndicesforLightmap(),this.updateNodes())}}},{key:"settleData",value:function(e){this.model.getModelDescriptor().cacheNodeInfosOnGeometryId(),this.addNodeInfoToOctantMap(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"createMeshNodes",value:function(e){var t=this,i=this.model;this.instancedManager.createMeshNodes(i),this.defaultManager.createMeshNodes(i,function(){i.getMaterialManager()._updateTextureMapping(),t.clearCachedData(i),t.loaded=!0,e&&e()})}},{key:"clearCachedData",value:function(e){e.getModelDescriptor().destroyReader(),e.getModelDescriptor().clearReferencedMeshCache(),this.defaultManager.clearCachedData(),this.instancedManager.clearCachedData()}}]),t}(CLOUD.ModelBaseHandler);CLOUD.MergedDataHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.layerDataLoaded=!1,i.loadedUserIdsObject=null,i.loadedUserIds=null,i.layerProvider=null,i.firstToLoad=!0,i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.loadedUserIdsObject=null,this.loadedUserIds=null,this.layerProvider.destroy(),this.layerProvider=null}},{key:"getLayerProvider",value:function(){return this.layerProvider}},{key:"load",value:function(e){var t=this,i=this.model;this.loader.setNotifyProgress(e),this.loader.load(function(){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START})},function(e){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:e})},function(){t.processLoadCompleted(function(){i.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})})})}},{key:"unload",value:function(e,t){}},{key:"loadMpkOnDemand",value:function(e,t,i,n){var r=this,a=this.model,o=!e,s=function(e){a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:e})};this.firstToLoad?this.loader.delayLoadResources(function(){r.firstToLoad=!1,r.loader.finishCallback=null,r.prepareData(function(){r.loader.progressCallback=s,r.getLayerProvider().setConditionsOnDemandLoad(e),r._loadMpkOnDemand(o,t,i,n)})}):(r.loader.progressCallback=s,r.getLayerProvider().setConditionsOnDemandLoad(e),r._loadMpkOnDemand(o,t,i,n))}},{key:"_loadMpkOnDemand",value:function(e,t,i,n){var r=this,a=this.model;this.layerDataLoaded=!1,t&&t(),a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_START}),this.getLayerProvider().loadMpkOnDemand(e,function(e){r.dealData(e)},function(e,t){r.unload(e,t)},i,function(){r.layerDataLoaded=!0,a.manager.updateFilterManager(),console.log("load finish"),a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE}),a.manager.dispatchEvent({type:CLOUD.EVENTS.ON_DEMAND_LOAD_COMPLETE,data:{boundingBox:a.manager.getLoadOnDemandDirector().getBoundingBoxForUsedComponent()}}),n&&n()})}},{key:"processLoadCompleted",value:function(e){var t=this.model;t.materialManager._updateTextureMapping(),t.materialManager._updateIBL(t),t.loaded=!0,t.updateOctreeNode(),requestAnimationFrame(function(){e&&e(),t.debut(t)})}},{key:"isAllReady",value:function(){return!(!this.isLoaded()||this.isHidden()||!this.isLayerDataLoaded())}},{key:"applyFilter",value:function(){if(this.isLoaded()&&this.isLayerDataLoaded()){var e=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);if(e.length&&this.defaultManager.applyFilter(this.model,e),CLOUD.GlobalData.Instance){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.applyFilter(this.model,t)}}}},{key:"needUpdate",value:function(){return!!this.isLayerDataLoaded()}},{key:"clearData",value:function(){}},{key:"initData",value:function(e){}},{key:"dealMeshNodes",value:function(e){}},{key:"dealData",value:function(e){var t=this;this.clearData(),this.initData(function(){t.model.manager.loadOverrideMaterialsByDemand(function(){t.dealMeshNodes(e)},function(){t.dealMeshNodes(e)})})}},{key:"getLoadedUserIdsObject",value:function(){return this.loadedUserIdsObject}},{key:"isLayerDataLoaded",value:function(){return this.layerDataLoaded}},{key:"clearLoadedState",value:function(){this.layerDataLoaded=!1,this.loadedUserIdsObject=null,this.loadedUserIds=null}}]),t}(CLOUD.ModelBaseHandler);CLOUD.LayerBaseHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.layerProvider=new CLOUD.LayerProvider(e),i}return _inherits(t,e),_createClass(t,[{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.model.getModelDescriptor().destroyReader(),this.loaded=!0,e&&e()}},{key:"clearData",value:function(){this.model.clearNodeGroup(),this.model.clearMeshFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"initData",value:function(e){this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}},{key:"unload",value:function(e,t){var i=this;this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,function(e){i.defaultManager.disposeGeometry(e)})}}]),t}(CLOUD.LayerBaseHandler);CLOUD.LayerHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.compositedManager=new CLOUD.IncrementCompositedManager,i.defaultManager=i.compositedManager.defaultManager,i.instancedManager=i.compositedManager.instancedManager,i.loader=new CLOUD.ModelView.LayerLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.compositedManager.settleData(this.model,function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"dealMeshNodes",value:function(e){e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.LayerHandler);CLOUD.LayerIncrementHandler=e}(),function(){var e=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.defaultManager=new CLOUD.BatchedManager(i),n.instancedManager=new CLOUD.InstancedManager,n.loader=new CLOUD.ModelView.LayerLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}]),t}(CLOUD.LayerHandler);CLOUD.LayerBatchedHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.layerProvider=new CLOUD.LayerSceneProvider(e),i}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){this.dataReady||(this.dataReady=!0,this.settleData(e))}},{key:"settleData",value:function(e){this.loaded=!0,e&&e()}},{key:"clearData",value:function(){this.model.clearNodeGroup(),this.model.removeAllFromOctantMap(),this.model.getModelDescriptor().clearNodeInfosWithGeometryId(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.defaultManager.clearData(),this.instancedManager.clearData(),this.clearLoadedState()}},{key:"initData",value:function(e){this.model.getModelDescriptor().parseItemData(),this.getLayerProvider().cacheNodeInfosWithLayerKey(),this.addNodeInfoToOctantMap(),this.loadedUserIdsObject=this.getLayerProvider().getUserIdsOnDemand(),this.loadedUserIds=Object.keys(this.loadedUserIdsObject),e&&e()}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"unload",value:function(e,t){var i=this;this.model.getModelDescriptor().removeFromSceneReaderMap(e),this.model.getModelDescriptor().clearReferencedMeshCacheByMpkIdxs(t,function(e){i.defaultManager.disposeGeometry(e)})}}]),t}(CLOUD.LayerBaseHandler);CLOUD.LayerSceneHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.compositedManager=new CLOUD.IncrementCompositedManager,i.defaultManager=i.compositedManager.defaultManager,i.instancedManager=i.compositedManager.instancedManager,i.loader=new CLOUD.ModelView.LayerSceneLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){this.compositedManager.destroy(),this.compositedManager=null,_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this)}},{key:"initData",value:function(e){var t=this;this.compositedManager.settleData(this.model,function(){t.getLayerProvider().cacheNodeInfosWithLayerKey(),t.addNodeInfoToOctantMap(),t.loadedUserIdsObject=t.getLayerProvider().getUserIdsOnDemand(),t.loadedUserIds=Object.keys(t.loadedUserIdsObject),e&&e()})}},{key:"prepare",value:function(e){this.isAllReady()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.compositedManager.cullNodes(this.model,e),this.compositedManager.updateNodes(this.model))}},{key:"updateNodes",value:function(){}},{key:"addNodeInfoToOctantMap",value:function(){}},{key:"clearData",value:function(){this.model.removeAllFromOctantMap(),this.getLayerProvider().clearData(),this.model.clearWireframeElementCount(),this.compositedManager.clearData(),this.clearLoadedState()}},{key:"dealMeshNodes",value:function(e){e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.LayerSceneHandler);CLOUD.LayerSceneIncrementHandler=e}(),function(){var e=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return n.tag="layer",n.defaultManager=new CLOUD.BatchedManager(i),n.instancedManager=new CLOUD.InstancedManager,n.loader=new CLOUD.ModelView.LayerSceneLoader(n),n}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e,t){this.isAllReady()&&(this.prepareWireframe(this.model,t),this.model.getMaterialManager()._updateTextureMapping(this.model))}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t);var i=this.model.getModelDescriptor().getStandardUserIdsByCategory(this.loadedUserIds);i.length?this.defaultManager.asyncCreateMeshNodes(this.model,i,e):e&&e()}}]),t}(CLOUD.LayerSceneHandler);CLOUD.LayerSceneBatchedHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="default",i.defaultManager=new CLOUD.FreeIncrementedManager,i.instancedManager=new CLOUD.InstancedManager,i.loader=new CLOUD.ModelView.DefaultLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"prepareData",value:function(e){if(!this.dataReady){var t=this;this.loader.getDescriptor().asyncParseItemData(function(){t.dataReady=!0,t.settleData(e)})}}},{key:"prepare",value:function(e){this.isLoaded()&&!this.isHidden()&&(this.model.getMaterialManager()._updateTextureMapping(),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.prepareWireframe(this.model),this.updateNodes())}},{key:"prepareWireframe",value:function(e,t){e.isActivateWireframe()&&this.instancedManager.generateWireframe(e)}},{key:"settleData",value:function(e){this.addNodeInfoToOctantMap(),this.model.getModelDescriptor().destroyReader(),this.createMeshNodes(e)}},{key:"addNodeInfoToOctantMap",value:function(){var e=this.model.manager,t=this.model.getEncodedDatabagId();this.model.getModelDescriptor().traverseNodeInfosByCell(function(i,n){e.addNodeInfoToOctantMap(t,i,n)})}},{key:"createMeshNodes",value:function(e){var t=this,i=this.model.getModelDescriptor().getInstancedUserIds();if(0===i.length)return t.loaded=!0,void(e&&e());CLOUD.Utils.asyncProcess(i,i.length,500,function(e,i){t.instancedManager.meshManager._createInstanceGeometries(t.model,[e[i]])},function(){t.instancedManager.meshManager._makeInstanceNodes(t.model),t.loaded=!0,e&&e()})}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.ModelBaseHandler);CLOUD.FreeIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.defaultManager=new CLOUD.FreeIncrementedManager,i.instancedManager=new CLOUD.InstancedManager,i.loader=new CLOUD.ModelView.LayerLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.updateNodes())}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.LayerHandler);CLOUD.FreeLayerIncrementHandler=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,e));return i.tag="layer",i.defaultManager=new CLOUD.FreeIncrementedManager,i.instancedManager=new CLOUD.InstancedManager,i.loader=new CLOUD.ModelView.LayerSceneLoader(i),i}return _inherits(t,e),_createClass(t,[{key:"prepare",value:function(e){!this.isHidden()&&this.loaded&&this.layerDataLoaded&&(this.model.getMaterialManager()._updateTextureMapping(this.model),this.model.clearMeshFromOctantMap(),this.instancedManager.addAllInstanceNodeToScene(this.model),this.defaultManager.cullNodes(this.model,e),this.updateNodes())}},{key:"dealMeshNodes",value:function(e){var t=this.model.getModelDescriptor().getInstancedUserIdsByCategory(this.loadedUserIds);t.length&&this.instancedManager.createMeshNodes(this.model,t),e&&e()}},{key:"disposeBufferAfterVbo",value:function(){}}]),t}(CLOUD.LayerSceneHandler);CLOUD.FreeLayerSceneIncrementHandler=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.geometries={}}return _createClass(e,[{key:"destroy",value:function(){this.disposeGeometries(),this.geometries=null}},{key:"disposeGeometries",value:function(){for(var e in this.geometries)this.disposeGeometry(e)}},{key:"disposeGeometry",value:function(e){var t=this.geometries[e];if(t){if(t instanceof Array)for(var i=0,n=t.length;i<n;i++)t[i].dispose();else t.dispose();delete this.geometries[e]}}},{key:"_hasGeometry",value:function(e){return!!this.geometries[e]}},{key:"_cacheGeometry",value:function(e,t){void 0===this.geometries[e]&&(this.geometries[e]=t)}},{key:"getGeometryById",value:function(e){return this.geometries[e]}},{key:"getGeometryByNodeInfo",value:function(e,t){return this._hasGeometry(t.geometryId)?this.getGeometryById(t.geometryId):this._createGeometryByNodeInfo(e,t)}},{key:"_createGeometryByNodeInfo",value:function(e,t){return this._createGeometry(t.type,t.geometryId,e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId))}},{key:"_createGeometry",value:function(e,t,i){if(this._hasGeometry(t))return this.getGeometryById(t);var n=this._createBufferGeometry(e,i);return n?(this._cacheGeometry(t,n),n):null}},{key:"_createBufferGeometry",value:function(e,t){var i=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType,n=null;switch(e){case i.MESH:case i.MESH_REF:if(!t)return null;n=new THREE.BufferGeometry,n.setIndex(new THREE.BufferAttribute(t.I,1)),n.addAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N?n.addAttribute("normal",new THREE.BufferAttribute(t.N,3)):n.computeVertexNormals(),t.UV&&n.addAttribute("uv",new THREE.BufferAttribute(t.UV,2));break;case i.TUBE:case i.PIPE:n=CLOUD.GeomUtil.UnitCylinderInstance;break;case i.BOX:n=CLOUD.GeomUtil.UnitBoxInstance;break;case i.BOX_M:n=CLOUD.GeomUtil.getUnitTextureBox();break;case i.PIPE_M:n=CLOUD.GeomUtil.getUnitTextureCylinder();break;case i.LINE:if(!t)return null;n=new THREE.BufferGeometry,n.setIndex(new THREE.BufferAttribute(t.I,1)),n.addAttribute("position",new THREE.BufferAttribute(t.P,3))}return n}},{key:"createBufferByBufferDataWithUV2",value:function(e,t,i){var n=this.createBufferByBufferData(t,i);if(!n)return null;if(!e.lightmap)return n;var r=[],a=n.index,o=e.getLoader().getUV2ById(t.itemIdUV2,a.length);o&&(t.lightmapIdx=o.lightmapIdx,r=o.uv2);for(var s=n.position,l=n.normal,c=n.uv,u=[],h=[],d=[],f=0;f<a.length;f++){var p=a[f];u.push(s[3*p]),u.push(s[3*p+1]),u.push(s[3*p+2]),l&&(h.push(l[3*p]),h.push(l[3*p+1]),h.push(l[3*p+2])),c&&(d.push(c[2*p]),d.push(c[2*p+1])),a[f]=f}return s=null,l=null,c=null,n.uv2=r,n.position=u,n.normal=h,n.uv=d,n}},{key:"createBufferByBufferData",value:function(e,t){var i,n,r,a,o,s=CLOUD.ModelView.BaseDescriptor.EnumNodeItemType;switch(e.type){case s.MESH:case s.MESH_REF:if(!t||!t.buffer)return null;if(t.isDataView?(n=Uint32Array.from(t.buffer.I),i=Float32Array.from(t.buffer.P),r=Float32Array.from(t.buffer.N),a=t.buffer.UV&&t.buffer.UV.length?Float32Array.from(t.buffer.UV):null):(n=new Uint32Array(t.buffer.I),i=new Float32Array(t.buffer.P),r=new Float32Array(t.buffer.N),a=t.buffer.UV&&t.buffer.UV.byteLength?new Float32Array(t.buffer.UV):null),t.indexInfo){n=n.slice(t.indexInfo.indexStart,t.indexInfo.indexStart+t.indexInfo.indexCount),i=i.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount),r=r.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount),a=a?a.slice(t.indexInfo.uvStart,t.indexInfo.uvStart+t.indexInfo.uvCount):null;var l=t.indexInfo.positionStart/3;n.forEach(function(e,t,i){i[t]-=l})}if(CLOUD.Utils.isMirror(e.matrix.elements))for(var c=0,u=n.length;c<u;c+=3){var h=n[c+1];n[c+1]=n[c+2],n[c+2]=h}break;case s.PIPE:o=CLOUD.GeomUtil.UnitCylinderInstance,n=Uint32Array.from(o.index.array),i=Float32Array.from(o.attributes.position.array),r=Float32Array.from(o.attributes.normal.array),o=null;break;case s.BOX:case s.TUBE:case s.BOX_M:case s.PIPE_M:o=e.type===s.BOX_M||e.type===s.BOX?CLOUD.GeomUtil.getBoxMBuffer(e.uvArrayBuffer):CLOUD.GeomUtil.getPipeMBuffer(e.uvArrayBuffer),n=Uint32Array.from(o.index),i=Float32Array.from(o.vertex),r=Float32Array.from(o.normal),o.uv&&(a=Float32Array.from(o.uv),delete o.uv),o=null;break;case s.LINE:if(!t||!t.buffer)return null;if(t.isDataView?(n=Uint32Array.from(t.buffer.I),i=Float32Array.from(t.buffer.P),r=null,a=null):(n=new Uint32Array(t.buffer.I),i=new Float32Array(t.buffer.P),r=null,a=null),t.indexInfo){n=n.slice(t.indexInfo.indexStart,t.indexInfo.indexStart+t.indexInfo.indexCount),i=i.slice(t.indexInfo.positionStart,t.indexInfo.positionStart+t.indexInfo.positionCount);var l=t.indexInfo.positionStart/3;n.forEach(function(e,t,i){i[t]-=l})}break;default:console.log("error data!")}var d=e.matrix;if(CLOUD.GeomUtil.applyMatrix4ToBuffer(d,i),r){var f=new THREE.Matrix3;f.getNormalMatrix(d),CLOUD.GeomUtil.applyMatrix3ToBuffer(f,r),CLOUD.GeomUtil.normalizeBuffer(r)}return e.uv=!!a,{index:n,position:i,normal:r,uv:a}}}]),e}();CLOUD.MeshManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.defaultWireframeColor={color:new THREE.Color(0,0,0),opacity:.4},this.wireframeMaterial=new THREE.MeshBasicMaterial(this.defaultWireframeColor),!1===CLOUD.GlobalData.TranslucentDepthDisabled&&(this.wireframeMaterial.transparent=!0),this.instanceWireframeMaterial=CLOUD.MaterialUtil.createInstanceMaterial(CLOUD.MaterialUtil.getMaterialParameters(this.wireframeMaterial)),
!1===CLOUD.GlobalData.TranslucentDepthDisabled&&(this.instanceWireframeMaterial.transparent=!0),this.wireframeGeometryMap={}}return _createClass(e,[{key:"destroy",value:function(){this.wireframeMaterial=null,this.instanceWireframeMaterial=null,this.wireframeGeometryMap=null}},{key:"setWireframeColor",value:function(e,t){this.wireframeMaterial.color=e,this.wireframeMaterial.opacity=t,this.wireframeMaterial.transparent=1!=t,this.instanceWireframeMaterial.color=e,this.instanceWireframeMaterial.opacity=t,this.instanceWireframeMaterial.transparent=1!=t}},{key:"getWireframeColor",value:function(){var e=this.wireframeMaterial.color.clone();return e.opacity=this.wireframeMaterial.opacity,e}},{key:"restoreWireframeColor",value:function(){var e=this.defaultWireframeColor;this.setWireframeColor(e.color,e.opacity)}}]),e}();CLOUD.WireframeManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=e,i.occlusionVisibleOctant=[],i.usedNodeInfoMap={},i.lineNodes={},i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.manager=null,this.occlusionVisibleOctant=null,this.usedNodeInfoMap=null,this.lineNodes=null}},{key:"disposeLineNodes",value:function(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}},{key:"clearData",value:function(){this.disposeGeometries(),this.disposeLineNodes(),this.usedNodeInfoMap={},this.occlusionVisibleOctant.length=0}},{key:"updateNode",value:function(e,t,i){var n,r=this,a=e.manager.filter._hasOverrideMaterialFilter(),o=e.selectedMaterial;n=0===i?r._getUsableMaterial(e,t,o,a):r._getUsableMaterial(e,t,null,a),r._isLineSegments(t)?r._dealLineSegments(e,t,n):r._dealMeshes(e,t,n),n=null}},{key:"cullNodes",value:function(e,t,i){var n=this._getUsedNodeInfosByOctantId(t),r=this;if(n||(this.manager.traverseNodeInfoMapByOctantId(t,function(t,i){r._isSatisfied(e,i)&&r._cacheToUsedNodeInfoMap(t,i)}),n=this._getUsedNodeInfosByOctantId(t)),!n)return i;for(var a=0,o=n.length;a<o&&(i=this.collectNodeInfo(e,n[a],i),!this.manager.isFull(e,i));a++);return i}},{key:"_getUsableMaterial",value:function(e,t,i,n){var r=t.materialId,a=t.userId,o=e.materialManager.materials,s=e.manager.sceneState,l=e.manager.filter,c=null,u=s.isSelected(a);1!=u||l._isSelectable(t)||(u=!1),i?(c=l._getOverrideMaterial(t))&&!u||(c=i):n&&(c=l._getOverrideMaterial(t));var h=e.manager.getOverrideMaterialByNodeInfo(t);return c=c||h||o[r]||CLOUD.MaterialUtil.getDefaultStandardMaterial(),CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass&&s.hoverId===a&&!1===u&&(c=s.getHoverMaterial(c)),c}},{key:"collectNodeInfo",value:function(e,t,i){var n=e.manager.filter,r=n._hasHiddenFileIdFilter(),a=n._hasOverrideMaterialFilter(),o=e.manager.sceneState.selectionSet,s=n._hasRenderPromotionFilter(),l=e.manager.getCategoriesFromHighPriority("inner");return e.isReplacedUserId(t.userId)||e.isHiddenUserId(t.userId)?i:r&&n._isHiddenFileId(t)||!1===n._isVisible(t)?i:o[t.userId]||a&&n._hasHighPriorityOverrideMaterial(t)?(this.manager.addToPriorityNodesSet(0,t),++i):s&&n._isRenderPromotion(t)||t.userData&&t.userData.categoryId&&l[t.userData.categoryId]?(this.manager.addToPriorityNodesSet(1,t),++i):(this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,t),i++),i)}},{key:"getMeshesByUserIds",value:function(e,t,i){for(var n=e.pool._pool,r=t.toString(),a=i.toString(),o=0;o<n.length;o++){var s=n[o];if(s.name==r||s.name==a){var l={};l.mesh=s,l.matrix=s.matrix;var c=s.geometry.boundingBox;c||(s.geometry.computeBoundingBox(),c=l.mesh.geometry.boundingBox),l.boundingBox=c,e.minDistanceObjects[s.name].push(l)}}}},{key:"_getUsedGeometry",value:function(e,t){var i;if(!CLOUD.GlobalData.Instance&&t.uvArrayBuffer){var n=t.geometryId+"|"+t.nodeId,i=this.getGeometryById(n);if(i)return i;var r=this._createGeometryByNodeInfo(e,t);r instanceof Array||(r=[r]),i=[];for(var a=new THREE.Matrix3,o=new THREE.Vector3,s=t.uvArrayBuffer,l=0,c=r.length;l<c;l++){var u=new THREE.BufferGeometry;u.setIndex(r[l].index),u.addAttribute("position",r[l].attributes.position),u.addAttribute("normal",r[l].attributes.normal),a.set(s[6*l],s[6*l+2],s[6*l+4],s[6*l+1],s[6*l+3],s[6*l+5],0,0,1);for(var h=[],d=r[l].attributes.uv.array,f=0,p=d.length;f<p;f+=2)o.set(d[f],d[f+1],1),o.applyMatrix3(a),h.push(o.x),h.push(o.y);u.addAttribute("uv",new THREE.Float32BufferAttribute(h,2)),i.push(u)}this._cacheGeometry(n,i)}else i=this.getGeometryByNodeInfo(e,t);return i}},{key:"_dealMeshes",value:function(e,t,i){var n=this._getUsedGeometry(e,t);n instanceof Array||(n=[n]);for(var r=0,a=n.length;r<a;r++){var o=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:n[r],matrix:t.matrix,material:i,isMesh:!0,isLine:!1,isLineSegments:!1,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth});o&&e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,o)}}},{key:"_dealLineSegments",value:function(e,t,i){var n=this.getGeometryByNodeInfo(e,t);if(n){var r=e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:n,matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.octantDepth});r&&e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,r)}}},{key:"_getUsedNodeInfosByOctantId",value:function(e){return this.usedNodeInfoMap[e]}},{key:"_cacheToUsedNodeInfoMap",value:function(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}},{key:"traverseUsedNodeInfoMap",value:function(e,t){for(var i=this.usedNodeInfoMap[e],n=0,r=i.length;n<r;n++)t(e,i[n])}},{key:"_isSatisfied",value:function(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}},{key:"_applyOcclusionTranslucent",value:function(e){if(CLOUD.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,n=this.occlusionVisibleOctant.length;if(n>0)for(var r=e.manager.getFrustumFromOcclusionCamera(),a=0;a<n;++a){var o=this.occlusionVisibleOctant[a].octantId,s=i[o];if(s&&s.length>0)for(var l=0,c=s.length;l<c;l+=2)for(var u=s[l];u<=s[l+1];u++){var h=t[u];CLOUD.CameraUtil.intersectObjectWithFrustum(h,r)&&this._overrideOcclusionMaterial(h)}}}}},{key:"_overrideOcclusionMaterial",value:function(e,t){var i=t.material;if(i&&!1===i.transparent){var n=e.manager.acquireMaterial(),r=n.material;i.color?r.color.copy(i.color):n.resetColor(),r.opacity=CLOUD.GlobalData.OcclusionOpacity,t.material=r,t.material.needsUpdate=!0}}},{key:"_isLineSegments",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getGeometryBuffersByUserId",value:function(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var n=[],r=e.getDatabagId(),a=0,o=i.length;a<o;a++){var s=i[a],l=this.getGeometryByNodeInfo(e,s);if(l)if(l instanceof Array)for(var c=0,u=l.length;c<u;c++)n.push({databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else n.push({databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}return n}}]),t}(CLOUD.MeshManager);CLOUD.IncrementedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.usedNodeInfoMap={}}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this._disposeGeometries(),this.wireframeGeometryMap=null,this.usedNodeInfoMap=null}},{key:"clearData",value:function(){this._disposeGeometries(),this.wireframeGeometryMap={},this.usedNodeInfoMap={}}},{key:"cullNodes",value:function(e,t,i){var n=this,r=this._getUsedNodeInfosByOctantId(t);if(r||(this.manager.traverseNodeInfoMapByOctantId(t,function(t,i){n._isSatisfied(e,i)&&n._cacheToUsedNodeInfoMap(t,i)}),r=this._getUsedNodeInfosByOctantId(t)),!r)return i;for(var a=0,o=r.length;a<o&&(i=this._collectNodeInfo(e,r[a],i),!this.manager.isFull(e,i));a++);return i}},{key:"updateNode",value:function(e,t){for(var i=e.getWireframeMaterial(),n=this._getWireframeGeometryByNodeInfo(e,t),r=0,a=n.length;r<a;r++)e.pool.get({databagId:e.databagId,meshId:t.nodeId,userId:t.userId,geometry:n[r],matrix:t.matrix,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,pickable:!1,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth})}},{key:"_getUsedNodeInfosByOctantId",value:function(e){return this.usedNodeInfoMap[e]}},{key:"_cacheToUsedNodeInfoMap",value:function(e,t){this.usedNodeInfoMap[e]||(this.usedNodeInfoMap[e]=[]),this.usedNodeInfoMap[e].push(t)}},{key:"_collectNodeInfo",value:function(e,t,i){var n=e.manager.filter,r=n._hasHiddenFileIdFilter();return e.isReplacedUserId(t.userId)||e.isHiddenUserId(t.userId)?i:r&&n._isHiddenFileId(t)||!1===n._isVisible(t)?i:(this.manager.isFull(e,i)||(this.manager.addToPriorityNodesSet(2,{nodeInfo:t,wireframe:!0}),i++),i)}},{key:"_getWireframeGeometryByNodeInfo",value:function(e,t){var i=t.geometryId;if(this.wireframeGeometryMap[i])return this.wireframeGeometryMap[i];var n=this.manager.getGeometryByNodeInfo(e,t);n instanceof Array||(n=[n]);for(var r=this.wireframeGeometryMap[i]=[],a=0,o=n.length;a<o;a++){var s=CLOUD.BuildEdge(n[a].attributes.position.array,n[a].index.array),l=new THREE.BufferGeometry;l.setIndex(new THREE.Uint32BufferAttribute(s,1)),l.addAttribute("position",n[a].attributes.position,3),r.push(l)}return this.wireframeGeometryMap[i]}},{key:"_traverseWireframeGeometryMap",value:function(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,n=t.length;i<n;i++){var r=this.wireframeGeometryMap[t[i]];if(r)for(var a=0,o=r.length;a<o;a++)e(r[a])}}},{key:"_disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e){e.dispose()})}},{key:"_isSatisfied",value:function(e,t){if(!this.manager.isNeedWireframing(t.userId))return!1;var i=e.getLoadedUserIdsObject();return!(i&&!i[t.userId])}}]),e}();CLOUD.IncrementedWireframeManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=e,i.instanceGeometryMap={},i.bufferAttributeMap={},i.nodeIdxMapFromUserId={},i.matrixInfoMapFromUserId={},i.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{}},i.selectedMeshes=[],i.nonSelectedMeshes=[],i.selectedObjectIds=[],i.mgIdMapFromOctantId={},i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.cachedInstance=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.mgIdMapFromOctantId=null}},{key:"clearData",value:function(){this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache()}},{key:"clearInstanceCache",value:function(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}},{key:"getBufferAttributesBy",value:function(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,1),n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,1),o=[],s=[],l=[];if(t.muvCol0[e])for(var c=0,u=t.muvCol0[e].length;c<u;c++)o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][c]),2,1)),s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][c]),2,1)),l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][c]),2,1));return this.bufferAttributeMap[e]={attributeMcol0:i,attributeMcol1:n,attributeMcol2:r,attributeMcol3:a,attributeMuvCol0Array:o,attributeMuvCol1Array:s,attributeMuvCol2Array:l},this.bufferAttributeMap[e]}},{key:"resetInstanceMaterial",value:function(){var e=this;this.traverseInstanceGeometryMap(function(t,i){for(var n=0,r=i.length;n<r;++n)e._hasStateAttribute(i[n])&&(i[n].getAttribute("vState").array.fill(CLOUD.EnumInstanceState.NONE),i[n].getAttribute("vState").needsUpdate=!0,i[n].getAttribute("vState2").array.fill(CLOUD.EnumInstanceState.HIDDEN),i[n].getAttribute("vState2").needsUpdate=!0)})}},{key:"clearInstanceStateByUserId",value:function(e){function t(e,t,i,n){for(var r=e.getAttribute("vState").array,a=e.getAttribute("vState2").array,o=0;o<t.length;++o){var s=t[o];r[s]=i,a[s]=n}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var i=this,n=CLOUD.EnumInstanceState.NONE,r=CLOUD.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(e,function(e,a){var o=i.getInstanceGeometries(e);if(o)for(var s=0,l=o.length;s<l;s++)i._hasStateAttribute(o[s])&&t(o[s],a,n,r)})}},{key:"updateInstanceStateByUserId",value:function(e,t,i,n){function r(e,t,i,n,r){for(var a=e.getAttribute("vState").array,o=e.getAttribute("vState2").array,s=e.getAttribute("aColor"),l=s?s.array:null,c=0;c<t.length;++c){var u=t[c];a[u]=i,o[u]=n,null!==l&&null!==r&&(l[4*u]=r[0],l[4*u+1]=r[1],l[4*u+2]=r[2],l[4*u+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,s&&(s.needsUpdate=!0)}var a=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,function(s,l){var c=o.getInstanceGeometries(s);if(c){var u=o.manager.getMaterialIdByMeshId(s),h=o.getUsableMaterialColorParamsBy(e,u,i,n),d=h.rgbaColor,f=i;i===CLOUD.EnumInstanceState.TRANSPARENT&&(f=CLOUD.EnumInstanceState.OVERRIDED),i===CLOUD.EnumInstanceState.SELECTED&&o.cacheSelectedObjectIds(t,s);var p,m,g=a.getInstanceMaterialById(u,e)[0];g.transparent===h.transparent?(p=f,m=CLOUD.EnumInstanceState.HIDDEN):(p=CLOUD.EnumInstanceState.HIDDEN,m=f),f===CLOUD.EnumInstanceState.BLINK&&g.setBlinkColor(e.manager.getBlinkColor());for(var v=0,y=c.length;v<y;v++)o._hasStateAttribute(c[v])&&r(c[v],l,p,m,d)}})}},{key:"getUsableMaterialColorParamsBy",value:function(e,t,i,n){var r,a,o=e.selectedMaterial,s=e.manager.filter._getMaterialByName("scene"),l=e.materialManager,c=e.manager.getOverrideMaterialByName(t),u=c||l.getMaterialById(t);switch(i){case CLOUD.EnumInstanceState.HOVER:n?(r=e.manager.filter._getMaterialByName(n),a=e.manager.sceneState.getHoverColorByMaterial(r)):a=e.manager.sceneState.getHoverColorByMaterial(u);break;case CLOUD.EnumInstanceState.SELECTED:a=CLOUD.MaterialUtil.getColorParamsByMaterial(o);break;case CLOUD.EnumInstanceState.TRANSPARENT:a=CLOUD.MaterialUtil.getColorParamsByMaterial(s);break;case CLOUD.EnumInstanceState.OVERRIDED:case CLOUD.EnumInstanceState.BLINK:n?(r=e.manager.filter._getMaterialByName(n),a=CLOUD.MaterialUtil.getColorParamsByMaterial(r)):a=CLOUD.MaterialUtil.getColorParamsByMaterial(u);break;default:a=CLOUD.MaterialUtil.getColorParamsByMaterial(u)}return a}},{key:"getInstanceGeometries",value:function(e){return this.instanceGeometryMap[e]}},{key:"_cacheInstanceGeometries",value:function(e,t){if(!this.instanceGeometryMap[e]){t instanceof Array||(t=[t]);for(var i=this.instanceGeometryMap[e]=[],n=0,r=t.length;n<r;++n)i[n]=new THREE.InstancedBufferGeometry,i[n].setIndex(t[n].index),i[n].addAttribute("position",t[n].attributes.position),i[n].addAttribute("normal",t[n].attributes.normal),i[n].addAttribute("uv",t[n].attributes.uv)}}},{key:"traverseInstanceGeometryMap",value:function(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}},{key:"traverseInstanceGeometryMapById",value:function(e,t){var i=this.instanceGeometryMap[e];if(i)for(var n=0,r=i.length;n<r;n++)t(i[n],e)}},{key:"disposeInstanceGeometries",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var i=0,n=t.length;i<n;i++)t[i].dispose()})}},{key:"cacheInstanceAttributeStateBy",value:function(e,t,i,n,r){var a=n.materialId,o=n.uvArrayBuffer;i instanceof Array||(i=[i]);var s=i.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[],l.muvCol2[t]=[];for(var c=0;c<s;++c)l.muvCol0[t][c]=[],l.muvCol1[t][c]=[],l.muvCol2[t][c]=[]}var u=r||e.materialManager.getMaterialById(a);l.vColor[t].push(u.color.r,u.color.g,u.color.b,u.opacity),l.vState[t].push(0);var h=n.matrix.elements;if(l.mcol0[t].push(h[0],h[1],h[2]),l.mcol1[t].push(h[4],h[5],h[6]),l.mcol2[t].push(h[8],h[9],h[10]),l.mcol3[t].push(h[12],h[13],h[14]),o)for(var c=0;c<s;++c)l.muvCol0[t][c].push(o[6*c],o[6*c+1]),l.muvCol1[t][c].push(o[6*c+2],o[6*c+3]),l.muvCol2[t][c].push(o[6*c+4],o[6*c+5]);else for(var c=0;c<s;++c)l.muvCol0[t][c].push(1,0),l.muvCol1[t][c].push(0,1),l.muvCol2[t][c].push(0,0);return l.vState[t].length-1}},{key:"_cacheNodeIdxByUserId",value:function(e,t,i){var n=this.nodeIdxMapFromUserId;n[e]||(n[e]={}),n[e][t]||(n[e][t]=[]),n[e][t].push(i)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){var i=this.nodeIdxMapFromUserId[e];for(var n in i)t(n,i[n])}},{key:"traverseNodeIdxMap",value:function(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),n=0,r=i.length;n<r;n++){var a=i[n];if(!t||!t(a)){var o=this.nodeIdxMapFromUserId[a];for(var s in o)e(s,o[s])}}}},{key:"_cacheMatrixInfoByUserId",value:function(e,t,i){var n=this.matrixInfoMapFromUserId;n[e]||(n[e]={}),n[e][t]||(n[e][t]=[]),n[e][t].push(i)}},{key:"traverseMatrixInfoMapByUserId",value:function(e,t){var i=this.matrixInfoMapFromUserId[e];for(var n in i)t(n,i[n])}},{key:"getMeshesByUserId",value:function(e,t){var i=this;this.traverseMatrixInfoMapByUserId(t,function(n,r){for(var a=i.getInstanceNodesById(n),o=0,s=r.length;o<s;o++)for(var l=0,c=a.length;l<c;l++){var u={};if(u.matrix=r[o].matrix,u.mesh=a[l],1===c)u.boundingBox=r[o].boundingBox;else{var h=u.mesh.geometry.boundingBox;h?h=h.clone():(u.mesh.geometry.computeBoundingBox(),h=u.mesh.geometry.boundingBox.clone()),h.applyMatrix4(u.matrix),u.boundingBox=h}e.minDistanceObjects[t].push(u)}})}},{key:"clearSelectedObjectIds",value:function(){}},{key:"cacheSelectedObjectIds",value:function(e,t){}},{key:"adjustVisibility",value:function(e,t){}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"_cacheToMgIdMapFromOctantId",value:function(e,t,i){this.mgIdMapFromOctantId[e]||(this.mgIdMapFromOctantId[e]={}),this.mgIdMapFromOctantId[e][i]||(this.mgIdMapFromOctantId[e][i]={cellId:e,cellDepth:t,mgId:i})}},{key:"traverseMgIdMapByOctantId",value:function(e,t,i){if(this.mgIdMapFromOctantId[e])for(var n=this.mgIdMapFromOctantId[e],r=Object.keys(n),a=0,o=r.length;a<o;a++){var s=n[r[a]];if(i&&i(s.mgId))break;t(e,s)}}},{key:"_createGeometryById",value:function(e){if(this.geometryMap||(this.geometryMap={}),!this.geometryMap[e]){this.geometryMap[e]=!0;for(var t=this.cachedInstance,i=this.getBufferAttributesBy(e),n=this.getInstanceGeometries(e),r=0,a=n.length;r<a;r++){n[r].addAttribute("mcol0",i.attributeMcol0),n[r].addAttribute("mcol1",i.attributeMcol1),n[r].addAttribute("mcol2",i.attributeMcol2),n[r].addAttribute("mcol3",i.attributeMcol3),i.attributeMuvCol0Array.length>0&&(n[r].addAttribute("muvCol0",i.attributeMuvCol0Array[r]),n[r].addAttribute("muvCol1",i.attributeMuvCol1Array[r]),n[r].addAttribute("muvCol2",i.attributeMuvCol2Array[r])),n[r].addAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(t.vColor[e]),4,1)),n[r].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,1)),n[r].addAttribute("vState2",new THREE.InstancedBufferAttribute(new Float32Array(t.vState[e]),1,1));var o=n[r].getAttribute("vState").array,s=n[r].getAttribute("vState2").array;o.fill(CLOUD.EnumInstanceState.NONE),s.fill(CLOUD.EnumInstanceState.HIDDEN);var l=n[r].index;n[r].addGroup(0,l.count,0),n[r].addGroup(0,l.count,1)}}}},{key:"cullNodes",value:function(e,t,i){var n=this;return this.traverseMgIdMapByOctantId(t,function(e,t){n.manager.addToPriorityNodesSet(2,t)},function(t){var r=n.manager.getNodeInfoCountById(t);return i+=r,!!n.manager.isFull(e,i)&&(i-=r,!0)}),i}},{key:"updateNode",value:function(e,t){var i=this.manager.getMaterialIdByMeshId(t.mgId),n=e.materialManager.getInstanceMaterialById(i,e);this._createGeometryById(t.mgId),this.traverseInstanceGeometryMapById(t.mgId,function(i,r){var a=e.pool.get({databagId:e.databagId,meshId:r,geometry:i,material:n,isMesh:!0,isLine:!1,isLineSegments:!1,instanceOrNot:!0,renderOrder:n[0].transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth});a&&e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),r,a)})}},{key:"createInstanceNodeInfo",value:function(e,t,i){var n=this;this.octantIdMap||(this.octantIdMap={}),this.octantIdMap[t]||(this.octantIdMap[t]=!0,this.manager.traverseNodeInfoMapByOctantId(t,function(t,r){var a=n.getGeometryByNodeInfo(e,r),o=e.manager.getOverrideMaterialByNodeInfo(r);o&&(r.materialId=o.name);var s=n.manager.getMeshIdByNodeInfo(r),l=n.cacheInstanceAttributeStateBy(e,s,a,r,o);n._cacheNodeIdxByUserId(r.userId,s,l),n._cacheMatrixInfoByUserId(r.userId,s,{matrix:r.matrix,boundingBox:r.boundingBox}),n._cacheInstanceGeometries(s,a),n._cacheToMgIdMapFromOctantId(t,i,s)}))}},{key:"getCachedInstanceData",value:function(){return this.cachedInstance}},{key:"_hasStateAttribute",value:function(e){return!!e.attributes.vState}},{key:"getGeometryBuffersByUserId",value:function(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var n=[],r=e.getDatabagId(),a=0,o=i.length;a<o;a++){var s=i[a],l=this.getGeometryByNodeInfo(e,s);if(l)if(l instanceof Array)for(var c=0,u=l.length;c<u;c++)n.push({databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else n.push({databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}return n}}]),t}(CLOUD.MeshManager);CLOUD.IncrementInstancedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.wireframeBufferMap={}}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this.disposeGeometries(),this.wireframeGeometryMap=null,this.wireframeBufferMap=null}},{key:"clearData",value:function(){this.disposeGeometries(),this.wireframeGeometryMap={},this.wireframeBufferMap={}}},{key:"disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e){e.dispose()})}},{key:"cullNodes",value:function(e,t,i){var n=this;return this.manager.getMeshManager().traverseMgIdMapByOctantId(t,function(e,t){n.manager.addToPriorityNodesSet(2,{wireframe:!0,nodeInfo:t})},function(t){var r=n.manager.getNodeInfoCountById(t);return i+=r,!!n.manager.isFull(e,i)&&(i-=r,!0)}),i}},{key:"updateNode",value:function(e,t){var i=e.getInstanceWireframeMaterial(),n=e.pool;this._createGeometryById(t.mgId),this._traverseWireframeGeometryMapById(t.mgId,function(r,a){n.get({databagId:e.databagId,meshId:a,geometry:r,material:i,isMesh:!1,isLine:!0,isLineSegments:!0,renderOrder:i.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth})})}},{key:"resetInstanceMaterial",value:function(){var e=CLOUD.EnumInstanceState.NONE,t=this;this._traverseWireframeGeometryMap(function(i){if(t._hasStateAttribute(i)){for(var n=i.getAttribute("vState").array,r=0,a=n.length;r<a;r++)n[r]=e;i.getAttribute("vState").needsUpdate=!0}}),this._updateNoWireframingState()}},{key:"updateInstanceWireframeByUserId",value:function(e,t){if(t===CLOUD.EnumInstanceState.HIDDEN||t===CLOUD.EnumInstanceState.NONE){var i=this;this.manager.traverseNodeIdxMapByUserId(e,function(e,n){i._setInstanceWireframeState(e,n,t)})}}},{key:"_getWireframeBufferById",value:function(e){var t=this.manager.getCombinedKeys(e).geometryId;if(this.wireframeBufferMap[t])return this.wireframeBufferMap[t];var i=this.manager.getMeshManager().getInstanceGeometries(e);if(!i)return[];for(var n=this.wireframeBufferMap[t]=[],r=0,a=i.length;r<a;r++){var o=i[r];n.push({index:CLOUD.BuildEdge(i[r].attributes.position.array,o.index.array),position:o.attributes.position})}return n}},{key:"_traverseWireframeGeometryMap",value:function(e){for(var t=Object.keys(this.wireframeGeometryMap),i=0,n=t.length;i<n;i++)this._traverseWireframeGeometryMapById(t[i],e)}},{key:"_traverseWireframeGeometryMapById",value:function(e,t){var i=this.wireframeGeometryMap[e];if(i)for(var n=0,r=i.length;n<r;n++)t(i[n],e)}},{key:"_createGeometryById",value:function(e){if(!this.wireframeGeometryMap[e])for(var t=this.wireframeGeometryMap[e]=[],i=this.manager.getMeshManager().getBufferAttributesBy(e),n=this.manager.getMeshManager().getCachedInstanceData(),r=this._getWireframeBufferById(e),a=0,o=r.length;a<o;a++){var s=new THREE.InstancedBufferGeometry;s.setIndex(r[a].index),s.addAttribute("position",r[a].position),s.addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[e]),1,1)),s.addAttribute("mcol0",i.attributeMcol0),s.addAttribute("mcol1",i.attributeMcol1),s.addAttribute("mcol2",i.attributeMcol2),s.addAttribute("mcol3",i.attributeMcol3),t.push(s)}}},{key:"_updateNoWireframingState",value:function(){var e=this,t=CLOUD.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap(function(i,n){e._setInstanceWireframeState(i,n,t)},function(t){return e.manager.isNeedWireframing(t)})}},{key:"_setInstanceWireframeState",value:function(e,t,i){var n=this;this._traverseWireframeGeometryMapById(e,function(e){if(n._hasStateAttribute(e)){for(var r=e.getAttribute("vState").array,a=0,o=t.length;a<o;++a)r[t[a]]=i;e.getAttribute("vState").needsUpdate=!0}})}},{key:"adjustVisibility",value:function(e,t){}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"_hasStateAttribute",value:function(e){return!!e.attributes.vState}}]),e}();CLOUD.IncrementInstancedWireframeManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.IncrementInstancedMeshManager(this),this.wireframeManager=new CLOUD.IncrementInstancedWireframeManager(this),this.nodeInfoMapFromOctant={}}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null}},{key:"clearData",value:function(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"traverseInstanceGeometryMap",value:function(e){this.meshManager.traverseInstanceGeometryMap(e)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}},{key:"traverseNodeIdxMap",value:function(e,t){this.meshManager.traverseNodeIdxMap(e,t)}},{key:"getMeshesByUserId",value:function(e,t){this.meshManager.getMeshesByUserId(e,t)}},{key:"_updateInstanceMaterialByUserId",value:function(e,t,i,n){this.meshManager.updateInstanceStateByUserId(e,t,i,n),this.wireframeManager.updateInstanceWireframeByUserId(t,i)}},{key:"_updateInstanceMaterial",value:function(e){CLOUD.Logger.time("update instance material");var t=CLOUD.Model.EnumFilterState;this.clearSelectedObjectIds();for(var i in this.filteredIds){var n=this.filteredIds[i];if(n[t.HIDDEN])this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HIDDEN);else if(n[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(n[t.SELECTED]){this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.SELECTED);continue}if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK);continue}}else{if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK);continue}if(n[t.SELECTED]){this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.SELECTED);continue}}n[t.HOVER]?n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HOVER,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HOVER):n[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.OVERRIDED,n[t.OVERRIDED])}}CLOUD.Logger.timeEnd("update instance material")}},{key:"_resetInstanceMaterial",value:function(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}},{key:"_collectFilteredUserIds",value:function(e,t,i){var n=e.manager.filter,r=n._hasHiddenFileIdFilter(),a=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),s=n._hasTransparentFilter(),l=e.hasReplacedUserId(),c=e.hasHiddenUserId(),u=this.filteredIds={};if(r||a||o||s||l||c)for(var h=CLOUD.Model.EnumFilterState,d=0;d<t.length;++d){var f=t[d],p=i[f];if(p&&p.length){var m=p[0];if(r&&n._isHiddenFileId(m)||a&&!1===n._isVisible(m)||e.isReplacedUserId(f)||e.isHiddenUserId(f))u[f]||(u[f]={}),u[f][h.HIDDEN]=!0;else if(s&&n._isTransparent(m))u[f]||(u[f]={}),u[f][h.TRANSPARENT]=!0;else if(o&&n._hasOverrideMaterial(m)){var g=n._getOverrideMaterial(m),v=null!=g?g.name:"";""!==v&&(u[f]||(u[f]={}),u[f][h.OVERRIDED]=v)}else;}}}},{key:"_collectSelectedUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{},n=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(i[a]||(i[a]={}),i[a][n.SELECTED]=!0,r[a]=!0);this.selectedUserIds=Object.keys(r)}},{key:"_clearSelectedState",value:function(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var n=this.selectedUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][CLOUD.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}},{key:"_collectHoveredUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][CLOUD.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}},{key:"_clearHoveredState",value:function(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][CLOUD.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}},{key:"_collectBlinkedUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{},n=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(i[a]||(i[a]={}),i[a][n.BLINK]=!0,r[a]=!0);this.blinkUserIds=Object.keys(r)}},{key:"_clearBlinkedState",value:function(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var n=this.blinkUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][CLOUD.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}},{key:"applyFilter",value:function(e,t){
if(this.hasNodeInfo(e)){this.updateNodes(e),this._resetInstanceMaterial();var i;i=t||e.getModelDescriptor().getInstancedUserIds();var n=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,n),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,n),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(),n),this._collectHoveredUserIds(e.manager.sceneState.hoverId,n),this._updateInstanceMaterial(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"updateNode",value:function(e,t){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo):this.meshManager.updateNode(e,t)}},{key:"updateNodes",value:function(e){}},{key:"createMeshNodes",value:function(e,t,i){this.meshManager.createMeshNodes(e,t,i)}},{key:"clearCachedData",value:function(){this.meshManager.disposeGeometries()}},{key:"getMeshesByUserIds",value:function(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}},{key:"clearSelectedObjectIds",value:function(){this.meshManager.clearSelectedObjectIds()}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"cullNodes",value:function(e,t,i,n,r){return this.hasOctantId(t)?(this.meshManager.createInstanceNodeInfo(e,t,i),0===n?this.meshManager.cullNodes(e,t,r):1===n?this.wireframeManager.cullNodes(e,t,r):r):r}},{key:"clearNodeInfoMap",value:function(){this.nodeInfoMapFromOctant={}}},{key:"cacheToNodeInfoMap",value:function(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}},{key:"traverseNodeInfoMapByOctantId",value:function(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,n=this.nodeInfoMapFromOctant[e].length;i<n;i++)t(e,this.nodeInfoMapFromOctant[e][i])}},{key:"traverseNodeInfoMap",value:function(e){for(var t=Object.keys(this.nodeInfoMapFromOctant),i=0,n=t.length;i<n;i++)this.traverseNodeInfoMapByOctantId(t[i],e)}},{key:"traverseNodeInfoMapByIds",value:function(e,t){if(!e)return void this.traverseNodeInfoMap(t);for(var i=Object.keys(this.nodeInfoMapFromOctant),n=0,r=i.length;n<r;n++)for(var a=i[n],o=this.nodeInfoMapFromOctant[a],s=0,l=o.length;s<l;s++)e[o[s].userId]&&t(a,o[s])}},{key:"hasNodeInfo",value:function(){return!CLOUD.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}},{key:"hasOctantId",value:function(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}},{key:"addToPriorityNodesSet",value:function(e,t){this.handler.addToPriorityNodesSet(e,t)}},{key:"isFull",value:function(e,t){return this.handler.isFull(e,t)}},{key:"isNeedWireframing",value:function(e){return this.handler.isNeedWireframing(e)}},{key:"getMeshIdByNodeInfo",value:function(e){return CLOUD.Utils.getCombinedKeyString([e.materialId,e.geometryId,e.cellId])}},{key:"getMaterialIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[0]}},{key:"getCombinedKeys",value:function(e){var t=CLOUD.Utils.splitCombinedKeyString(e);return{materialId:t[0],geometryId:t[1],cellId:t[2]}}},{key:"getNodeInfoCountById",value:function(e){var t=this.meshManager.getCachedInstanceData();if(!t.vState[e])return 0;return t.muvCol0&&t.muvCol0[e]&&t.muvCol0[e].length?t.muvCol0[e].length*t.vState[e].length:t.vState[e].length}},{key:"getMeshManager",value:function(){return this.meshManager}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}}]),e}();CLOUD.IncrementInstancedManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.IncrementedMeshManager(this),this.wireframeManager=new CLOUD.IncrementedWireframeManager(this),this.nodeInfoMapFromOctant={},this.handler=null}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this.nodeInfoMapFromOctant=null,this.handler=null}},{key:"clearData",value:function(){this.clearNodeInfoMap(),this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"clearNodeInfoMap",value:function(){this.nodeInfoMapFromOctant={}}},{key:"cacheToNodeInfoMap",value:function(e,t){this.nodeInfoMapFromOctant[e]||(this.nodeInfoMapFromOctant[e]=[]),this.nodeInfoMapFromOctant[e].push(t)}},{key:"traverseNodeInfoMapByOctantId",value:function(e,t){if(this.nodeInfoMapFromOctant[e])for(var i=0,n=this.nodeInfoMapFromOctant[e].length;i<n;i++)t(e,this.nodeInfoMapFromOctant[e][i])}},{key:"hasNodeInfo",value:function(){return!CLOUD.Utils.isEmptyObjectSimple(this.nodeInfoMapFromOctant)}},{key:"hasOctantId",value:function(e){return!(!this.nodeInfoMapFromOctant[e]||!this.nodeInfoMapFromOctant[e].length)}},{key:"cullNodes",value:function(e,t,i,n,r){return this.hasOctantId(t)?0===n?this.meshManager.cullNodes(e,t,r):1===n?this.wireframeManager.cullNodes(e,t,r):r:r}},{key:"updateNode",value:function(e,t,i){t.wireframe?this.wireframeManager.updateNode(e,t.nodeInfo,i):this.meshManager.updateNode(e,t,i)}},{key:"updateNodes",value:function(e){}},{key:"applyFilter",value:function(e,t){}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"applyBlink",value:function(e){}},{key:"clearBlink",value:function(e){}},{key:"applyReplacement",value:function(e){}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getLoader",value:function(e){return e.loader}},{key:"getMeshesByUserIds",value:function(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"addToPriorityNodesSet",value:function(e,t){this.handler.addToPriorityNodesSet(e,t)}},{key:"isFull",value:function(e,t){return this.handler.isFull(e,t)}},{key:"isNeedWireframing",value:function(e){return this.handler.isNeedWireframing(e)}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}}]),e}();CLOUD.IncrementedManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.defaultManager=new CLOUD.IncrementedManager,this.instancedManager=new CLOUD.IncrementInstancedManager,this.defaultManager.handler=this,this.instancedManager.handler=this,this.priorityNodesSet=[[],[],[]],this.octantManager=new CLOUD.OctantManager,this.noNeedWireframingIdMap={}}return _createClass(e,[{key:"destroy",value:function(){this.defaultManager.handler=null,this.instancedManager.handler=null,this.defaultManager=null,this.instancedManager=null,this.clearPriorityNodesSet(),this.priorityNodesSet=null,this.octantManager.destroy(),this.octantManager=null,this.noNeedWireframingIdMap=null}},{key:"clearData",value:function(){this.clearNoNeedWireframingIdMap(),this.defaultManager.clearData(),this.instancedManager.clearData()}},{key:"settleData",value:function(e,t){var i=this.octantManager.getAllOctants(e);i.length>0?this._parseItemDataByOctants(e,i,function(){t&&t()}):t&&t()}},{key:"cullNodes",value:function(e,t){this.clearPriorityNodesSet(),this._collectNoWireframingIds(e);var i=this.octantManager.getVisibleOctants(e,t,!0);if(i.length){var n=0;return e.isOnlyWireframe()?void this._cullNodesByVisibleOctant(e,i,1,n):e.isActivateWireframe()?(n=this._cullNodesByVisibleOctant(e,i,0,n),void this._cullNodesByVisibleOctant(e,i,1,n)):void this._cullNodesByVisibleOctant(e,i,0,n)}}},{key:"_cullNodesByVisibleOctant",value:function(e,t,i,n){for(var r=0,a=t.length;r<a;++r){var o=t[r].octantId,s=t[r].depth;if(n=this.defaultManager.cullNodes(e,o,s,i,n),n=this.instancedManager.cullNodes(e,o,s,i,n),this.isFull(e,n))break}return n}},{key:"updateNodes",value:function(e){var t=this;this.traversePriorityNodesSet(function(i,n){t._isInstanceNode(n)?t.instancedManager.updateNode(e,n):t.defaultManager.updateNode(e,n,i)}),CLOUD.GlobalData.DEBUG&&this.octantManager.showOctreeBox(e)}},{key:"_collectNoWireframingIds",value:function(e){if(!this.wireframingIdCollected){this.wireframingIdCollected=!0;var t=this,i=e.manager.filter;e.getModelDescriptor().traverseNodeInfosByCell(function(e,n){(n.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE||i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(n))&&(t.noNeedWireframingIdMap[n.userId]=!0)})}}},{key:"isNeedWireframing",value:function(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}},{key:"clearNoNeedWireframingIdMap",value:function(){this.wireframingIdCollected=!1,this.noNeedWireframingIdMap={}}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"isFull",value:function(e,t){return!(t<e.getRenderableCount())}},{key:"clearPriorityNodesSet",value:function(){this.priorityNodesSet[0]=[],this.priorityNodesSet[1]=[],this.priorityNodesSet[2]=[]}},{key:"addToPriorityNodesSet",value:function(e,t){e=e<0||e>2?2:e,this.priorityNodesSet[e].push(t)}},{key:"traversePriorityNodesSet",value:function(e){for(var t=this.priorityNodesSet,i=0,n=t.length;i<n;++i)for(var r=t[i],a=0,o=Object.keys(r).length;a<o;++a)e(i,r[a])}},{key:"_parseItemDataByOctants",value:function(e,t,i){function n(o){var s=o;return function(){var o=t[s].octantId,l=t[s].depth;r._parseItemDataByOctantId(e,o,l),s<a-1?requestAnimationFrame(n(s+1)):i&&i()}}var r=this,a=t.length;requestAnimationFrame(n(0))}},{key:"_parseItemDataByOctantId",value:function(e,t,i){e.getModelDescriptor().parseItemDataByCellId(t);var n=e.getModelDescriptor().getNodeInfosByCellId(t);if(n)for(var r,a=0,o=n.length;a<o;a++)r=n[a],r.cellDepth=i,r.instanceOrNot?this.instancedManager.cacheToNodeInfoMap(t,r):this.defaultManager.cacheToNodeInfoMap(t,r),e.manager.addNodeInfoToOctantMap(e.getEncodedDatabagId(),t,r)}},{key:"_isInstanceNode",value:function(e){return!!(e.mgId||e.nodeInfo&&e.nodeInfo.mgId)}}]),e}();CLOUD.IncrementCompositedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=e,i.nodePriority={high:[],medium:[],low:[]},i.visibleOctant=[],i.occlusionVisibleOctant=[],i.usedNodeInfosObject={},i.lineNodes={},i.blinkMaterials=[],i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.manager=null,this.nodePriority=null,this.visibleOctant=null,this.occlusionVisibleOctant=null,this.nodePriority=null,this.lineNodes=null,this.blinkMaterials=null}},{key:"disposeLineNodes",value:function(){for(var e in this.lineNodes){var t=this.lineNodes[e];t.geometry.dispose(),t=null,delete this.lineNodes[e]}}},{key:"clearData",value:function(){this.disposeGeometries(),this.disposeLineNodes(),this._clearNodePriorityData(!0),this._clearUsedNodeInfosObject(),this.visibleOctant.length=0,this.occlusionVisibleOctant.length=0}},{key:"update",value:function(e){var t=this._updateMeshNodes(e);return this._applyOcclusionTranslucent(e),t}},{key:"cullNodes",value:function(e,t){this._clearNodePriorityData(!0),this._adjustLowNodePriorityLength(e);var i=0;i=CLOUD.GlobalData.EnableOctant?this._cullNodesWithOctant(e,t):this._cullNodesWithFull(e),e.prioritizedNodeCount=this._calcPrioritizedNodeCount(e,i)}},{key:"getPriorityNodes",value:function(){return[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low]}},{key:"_cullNodesWithInnerAndOuterOctree",value:function(e,t){var i=0,n=0,r=e.getModelDescriptor().getOctreeRootNode(),a=r.inner,o=r.outer;if(this.manager.getContainsCamera(e)||!o)return this.visibleOctant.length=0,a&&this._frustumCull(e,t,a),o&&this._frustumCull(e,t,o),n=this.visibleOctant.length,n>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,n)),i;o&&(this.visibleOctant.length=0,this._frustumCull(e,t,o),(n=this.visibleOctant.length)>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!1,i,n)));var s=this.manager.getFilter(e);return(Object.keys(this.nodePriority.low).length+this.nodePriority.high.length+this.nodePriority.medium.length<this.manager.getRenderableCount(e)||s._hasRenderPromotionFilter())&&a&&(this.visibleOctant.length=0,this._frustumCull(e,t,a),(n=this.visibleOctant.length)>0&&(this._sortVisibleOctant(e,t),i=this._logicCull(e,!0,!1,i,n))),i}},{key:"_cullNodesWithLayerOctree",value:function(e,t){var i=0;this.visibleOctant.length=0;var n=e.getModelDescriptor().getOctreeRootNode().layer;this._frustumCull(e,t,n);var r=this.visibleOctant.length;return r>0&&(this._sortVisibleOctant(t),i=this._logicCull(e,!0,!0,i,r)),i}},{key:"_cullNodesWithOctant",value:function(e,t){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._cullNodesWithInnerAndOuterOctree(e,t):this._cullNodesWithLayerOctree(e,t)}},{key:"_cullNodesWithFull",value:function(e){var t=e.getModelDescriptor().getCellCount();return 0===t?0:this._logicCullWithFull(e,t)}},{key:"_calcPrioritizedNodeCount",value:function(e,t){var i=t+this.nodePriority.high.length+this.nodePriority.medium.length;return i>this.manager.getRenderableCount(e)&&(i=this.manager.getRenderableCount(e)),i}},{key:"_updateMeshNodes",value:function(e){var t=e.prioritizedNodeCount;if(e.isOnlyWireframe())return 0;if(this._clearLineSegmentsNodeGroup(e),0===t)return 0;var i=[this.nodePriority.high,this.nodePriority.medium,this.nodePriority.low],n=null;i[0].length>0&&(n=e.selectedMaterial);var r=e.manager.filter._hasOverrideMaterialFilter(),a={octantStartIndex:-1,curOctantId:-1};this.blinkMaterials.length=0;for(var o=0,s=0,l=0,c=i.length;l<c;++l)for(var u=i[l],h=0,d=Object.keys(u).length;h<d&&!(o>t);++h){s++;var f,p=u[h];f=0===l?this._getUsableMaterial(e,p,n,r):this._getUsableMaterial(e,p,null,r);var m=!p.instanceOrNot;if(this._isLineSegments(p))this._dealLineSegments(e,p,m,f);else{var g=e.pool.counter;this._dealMeshes(e,p,m,f,a);var v=e.pool.counter-g;o+=v,t+=v-1}f=null}return n=null,i=null,s}},{key:"_getUsableMaterial",value:function(e,t,i,n){var r=t.materialId,a=t.userId,o=e.materialManager.materials,s=e.manager.sceneState,l=e.manager.filter,c=null,u=s.isSelected(a);1!=u||l._isSelectable(t)||(u=!1),i?(c=l._getOverrideMaterial(t))&&!u||(c=i):n&&(c=l._getOverrideMaterial(t));var h=e.manager.getOverrideMaterialByNodeInfo(t);return c=c||h||o[r]||CLOUD.MaterialUtil.getDefaultStandardMaterial(),CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass&&s.hoverId===a&&!1===u&&(c=s.getHoverMaterial(c)),c}},{key:"getMeshesByUserIds",value:function(e,t,i){for(var n=e.pool._pool,r=t.toString(),a=i.toString(),o=0;o<n.length;o++){var s=n[o];if(s.name==r||s.name==a){var l={};l.mesh=s,l.matrix=s.matrix;var c=s.geometry.boundingBox;c||(s.geometry.computeBoundingBox(),c=l.mesh.geometry.boundingBox),l.boundingBox=c,e.minDistanceObjects[s.name].push(l)}}}},{key:"explode",value:function(e){for(var t=e.pool._pool,i=0;i<t.length;i++){var n=t[i],r=e.manager.getExplosionTranslation(n.name);n.translateZ(r.z),n.updateMatrix(),n.updateMatrixWorld()}}},{key:"_getUsedGeometry",value:function(e,t){var i;if(!CLOUD.GlobalData.Instance&&t.uvArrayBuffer){var n=t.geometryId+"|"+t.nodeId,i=this.getGeometryById(n);if(i)return i;var r=this._createGeometryByNodeInfo(e,t);r instanceof Array||(r=[r]),i=[];for(var a=new THREE.Matrix3,o=new THREE.Vector3,s=t.uvArrayBuffer,l=0,c=r.length;l<c;l++){var u=new THREE.BufferGeometry;u.setIndex(r[l].index),u.addAttribute("position",r[l].attributes.position),u.addAttribute("normal",r[l].attributes.normal),a.set(s[6*l],s[6*l+2],s[6*l+4],s[6*l+1],s[6*l+3],s[6*l+5],0,0,1);for(var h=[],d=r[l].attributes.uv.array,f=0,p=d.length;f<p;f+=2)o.set(d[f],d[f+1],1),o.applyMatrix3(a),h.push(o.x),h.push(o.y);u.addAttribute("uv",new THREE.Float32BufferAttribute(h,2)),i.push(u)}this._cacheGeometry(n,i)}else i=this.getGeometryByNodeInfo(e,t);return i}},{key:"_dealMeshes",value:function(e,t,i,n,r){var a=this._getUsedGeometry(e,t),o=e.pool;a instanceof Array||(a=[a]);for(var s=0,l=a.length;s<l;s++){var c=o.get({databagId:e.databagId,nodeId:t.nodeId,userId:t.userId,originalId:t.originalId,userData:t.userData,geometry:a[s],matrix:t.matrix,material:n,renderOrder:n.transparent?0:CLOUD.GlobalData.MaximumDepth-t.cellDepth,visible:i});c&&e.manager.addMeshToOctantMap(e.getEncodedDatabagId(),t.nodeId,c)}}},{key:"_dealLineSegments",value:function(e,t,i,n){var r=this.getGeometryByNodeInfo(e,t);if(r){var a=this._getLineSegmentsNodeGroup(e),o=this.lineNodes[t.nodeId];o||(o=new CLOUD.LineSegmentsEx(r,n),o.databagId=e.databagId,this.lineNodes[t.nodeId]=o),o.material=n,o.visible=i,a.add(o),o.updateMatrixWorld(!0)}}},{key:"_frustumCull",value:function(e,t,i){function n(e,t,i,r,a){var o,c;if(t&&e.depth<i&&(l.set(e.min,e.max),o=t.intersectsBox(l)),o){if(r){var u=l.applyMatrix4(s),h=u.getSize().length(),d=u.getCenter().z;d=d>1e-6?d:1e-6,e.priority=h/d,a.push(e)}else a.push(e);for(var f=0,p=e.childOctants.length;f<p;++f)c=e.childOctants[f],n(c,t,i,r,a)}}var r=e.manager,a=t.getFrustum(),o=CLOUD.GlobalData.OctantDepth,s=t.projScreenMatrix,l=new THREE.Box3;(CLOUD.GlobalData.DEBUG&&r.showOctreeBox(i),n(i,a,o,!0,this.visibleOctant),CLOUD.GlobalData.OcclusionTranslucentEnabled)&&n(i,this.manager.getFrustumFromOcclusionCamera(),o,!1,this.occlusionVisibleOctant);return!0}},{key:"_logicCull",value:function(e,t,i,n,r){var a=e.manager,o=a.filter,s=o._hasHiddenFileIdFilter(),l=o._hasOverrideMaterialFilter(),c=a.sceneState.selectionSet,u=o._hasRenderPromotionFilter(),h=this.nodePriority.high,d=this.nodePriority.medium,f=this.nodePriority.low,p=this.nodePriority.low.length,m=e.getModelDescriptor().getNodeInfosWithCellId(),g=a.getCategoriesFromHighPriority("outer");!0===i&&(g=a.getCategoriesFromHighPriority("inner"));for(var v,y=0,E=0;E<r;++E){var x,b=0;t?(x=this.visibleOctant[E].octantId,b=this.visibleOctant[E].depth):x=E;var C=m[x];if(C){var M=this._getUsedNodeInfosByCellId(x);if(!M){for(v=0,y=C.length;v<y;++v){var _=C[v];_.octantId=x,_.cellDepth=b,this._isSatisfied(e,_)&&this._cacheUsedNodeInfosByCellId(x,_)}M=this._getUsedNodeInfosByCellId(x)}if(M){var w=M.default;for(v=0,y=w.length;v<y;v++){var _=w[v];!function(t,i){if(!e.isReplacedUserId(t.userId)&&!e.isHiddenUserId(t.userId)&&!(s&&o._isHiddenFileId(t)||!1===o._isVisible(t))){if(c.hasOwnProperty(t.userId)||l&&o._hasHighPriorityOverrideMaterial(t))return void h.push(t);var r=!1;if(u&&o._isRenderPromotion(t)&&(r=!0),i){var a=t.userData,m=a?a.categoryId:void 0;m&&i[m]&&(r=!0)}if(r)return void d.push(t);n<p&&(f[n]=t,n++)}}(_,g)}}}}return CLOUD.Logger.timeEnd("collectNodeInfo"),n}},{key:"_clearUsedNodeInfosObject",value:function(){for(var e in this.usedNodeInfosObject)delete this.usedNodeInfosObject[e].default,delete this.usedNodeInfosObject[e].instance,delete this.usedNodeInfosObject[e];this.usedNodeInfosObject={}}},{key:"_getUsedNodeInfosByCellId",value:function(e){return this.usedNodeInfosObject[e]}},{key:"_cacheUsedNodeInfosByCellId",value:function(e,t){this.usedNodeInfosObject[e]||(this.usedNodeInfosObject[e]={},this.usedNodeInfosObject[e].default=[],this.usedNodeInfosObject[e].instance=[]),t.instanceOrNot||this.usedNodeInfosObject[e].default.push(t)}},{key:"_isSatisfied",value:function(e,t){var i=e.getLoadedUserIdsObject();return!i||!!i[t.userId]}},{key:"_logicCullWithFull",value:function(e,t){return this._logicCull(e,!1,!0,0,t)}},{key:"_sortVisibleOctant",value:function(e,t){var i=null;if(this.manager.getContainsCamera(e)&&null!=this.manager.getLoader(e).octreeRootNodeI){var n=new CLOUD.OctantNeighborUtil(t,this.manager.getLoader(e).octreeRootNodeI);i=n.getAncestorAndNeighbors()}this.visibleOctant.sort(function(e,t){if(null!=i){if(void 0!=i[e.octantId])return-1;if(void 0!=i[t.octantId])return 1}return e.priority>t.priority?-1:e.priority<t.priority?1:0})}},{key:"_applyOcclusionTranslucent",value:function(e){if(CLOUD.GlobalData.OcclusionTranslucentEnabled){var t=e.pool.getObjects(),i=e.manager.octantToObjectMap,n=this.occlusionVisibleOctant.length;if(n>0)for(var r=e.manager.getFrustumFromOcclusionCamera(),a=0;a<n;++a){var o=this.occlusionVisibleOctant[a].octantId,s=i[o];if(s&&s.length>0)for(var l=0,c=s.length;l<c;l+=2)for(var u=s[l];u<=s[l+1];u++){var h=t[u];CLOUD.CameraUtil.intersectObjectWithFrustum(h,r)&&this._overrideOcclusionMaterial(h)}}}}},{key:"_overrideOcclusionMaterial",value:function(e,t){var i=t.material;if(i&&!1===i.transparent){var n=e.manager.acquireMaterial(),r=n.material;i.color?r.color.copy(i.color):n.resetColor(),r.opacity=CLOUD.GlobalData.OcclusionOpacity,t.material=r,t.material.needsUpdate=!0}}},{key:"_clearNodePriorityData",value:function(e){var t=this.nodePriority;t.high.length=0,t.medium.length=0,e&&(t.low.length=0)}},{key:"_adjustLowNodePriorityLength",value:function(e){0===this.nodePriority.low.length&&(this.nodePriority.low.length=this.manager.getRenderableCount(e))}},{key:"_clearLineSegmentsNodeGroup",value:function(e){this._getLineSegmentsNodeGroup(e).clear()}},{key:"_getLineSegmentsNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.LINESEGMENTS,{globalSpace:!0})}},{key:"_isLineSegments",value:function(e){return e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE}},{key:"getBlinkMaterials",value:function(){return this.blinkMaterials}},{key:"getGeometryBuffersByUserId",value:function(e,t){var i=e.getModelDescriptor().getStandardNodeInfosById(t);if(!i)return[];for(var n=[],r=e.getDatabagId(),a=0,o=i.length;a<o;a++){var s=i[a],l=this.getGeometryByNodeInfo(e,s);if(l)if(l instanceof Array)for(var c=0,u=l.length;c<u;c++)n.push({databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else n.push({databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}return n}}]),t}(CLOUD.MeshManager);CLOUD.FreeIncrementedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.wireframeLineMeshes={}}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this._clearWireframeLineMeshes(),this.wireframeLineMeshes=null,this._disposeGeometries(),this.wireframeGeometryMap=null}},{key:"clearData",value:function(){this._clearWireframeLineMeshes(),this._disposeGeometries()}},{key:"update",value:function(e,t){if(0===t)return void this._clearWireframeGroupNode(e);this.isActivateWireframe(e)?(this._clearWireframeGroupNode(e),this._generateWireframeNodes(e,t),this._getWireWireframeGroupNode(e).updateMatrixWorld(!0)):this._removeWireframeGroupNode(e)}},{key:"_disposeGeometries",value:function(){for(var e in this.wireframeGeometryMap)this._disposeGeometry(e)}},{key:"_disposeGeometry",value:function(e){var t=this.wireframeGeometryMap[e];if(t){if(t instanceof Array)for(var i=0,n=t.length;i<n;i++)t[i].dispose();else t.dispose();delete this.wireframeGeometryMap[e]}}},{key:"_clearWireframeLineMeshes",value:function(){for(var e in this.wireframeLineMeshes)delete this.wireframeLineMeshes[e];this.wireframeLineMeshes={}}},{key:"_clearWireframeGroupNode",value:function(e){this._getWireWireframeGroupNode(e).clear()}},{key:"_removeWireframeGroupNode",value:function(e){e.manager.scene.removeObjectGroupByName(this._getWireframeGroupName(e))}},{key:"isActivateWireframe",value:function(e){return e.isActivateWireframe()}},{key:"_getWireWireframeGroupNode",value:function(e){return e.manager.scene.getOrCreateObjectGroup(this._getWireframeGroupName(e),{globalSpace:!0})}},{key:"_getWireframeGeometryByNodeInfo",value:function(e,t){return this._getWireframeGeometryById(t.geometryId,this.manager.getGeometryByNodeInfo(e,t))}},{key:"_getWireframeGeometryById",value:function(e,t){if(this.wireframeGeometryMap[e])return this.wireframeGeometryMap[e];var i,n,r=[];if(t instanceof Array)for(var a=0,o=t.length;a<o;a++)n=CLOUD.BuildEdge(t[a].attributes.position.array,t[a].index.array),i=new THREE.BufferGeometry,i.setIndex(new THREE.Uint32BufferAttribute(n,1)),i.addAttribute("position",t[a].attributes.position,3),r.push(i);else n=CLOUD.BuildEdge(t.attributes.position.array,t.index.array),i=new THREE.BufferGeometry,i.setIndex(new THREE.Uint32BufferAttribute(n,1)),i.addAttribute("position",t.attributes.position,3),r.push(i);return this.wireframeGeometryMap[e]=r,this.wireframeGeometryMap[e]}},{key:"_makeWireframeLineMeshes",value:function(e,t,i){var n=this.wireframeLineMeshes[t.nodeId];if(!n){n=this.wireframeLineMeshes[t.nodeId]=[];for(var r=this._getWireframeGeometryByNodeInfo(e,t),a=0,o=r.length;a<o;a++){var s=new THREE.LineSegments(r[a],this._getWireframeMaterial(e));s.name=t.nodeId+"_"+a,s.applyMatrix(t.matrix),n.push(s)}}for(var l=0,c=n.length;l<c;l++)i.add(n[l])}},{key:"_generateWireframeNodes",value:function(e,t){for(var i=this._getWireWireframeGroupNode(e),n=this.manager.getPriorityNodes(),r=0,a=0,o=n.length;a<o;++a)for(var s=n[a],l=0,c=Object.keys(s).length;l<c&&!(++r>t);++l){var u=s[l];e.isReplacedUserId(u.userId)||e.isHiddenUserId(u.userId)||function(e,t){return e.type!==CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE&&((!CLOUD.GlobalData.Instance||"box"!=e.geometryId&&"boxM"!=e.geometryId)&&!(t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(e)))}(u,this._getFilter(e))&&this._makeWireframeLineMeshes(e,u,i)}}},{key:"_getWireframeGroupName",value:function(e){return e._getWireframeGroupName()}},{key:"_getWireframeMaterial",value:function(e){return e.getWireframeMaterial()}},{key:"_getFilter",value:function(e){return e.manager.filter}},{key:"explode",value:function(e){for(var t=new THREE.Matrix4,i=e.getModelDescriptor().getAllNodeInfos(),n=Object.keys(i),r=0,a=n.length;r<a;r++){var o=n[r],s=i[o],l=e.manager.getExplosionTranslation(o);t.makeTranslation(l.x,l.y,l.z);for(var c=0,u=s.length;c<u;c++){var h=this.wireframeLineMeshes[s[c].nodeId];if(h)for(var d=0;d<h.length;d++)h[d].applyMatrix(t)}}}}]),e}();CLOUD.FreeIncrementedWireframeManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.FreeIncrementedMeshManager(this),this.wireframeManager=new CLOUD.FreeIncrementedWireframeManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"cullNodes",value:function(e,t){this.hasNodeInfo(e)&&this.meshManager.cullNodes(e,t)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"updateNodes",value:function(e){if(this.hasNodeInfo(e)){var t=this.meshManager.update(e);this.wireframeManager.update(e,t)}}},{key:"applyFilter",value:function(e,t){}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"applyBlink",value:function(e){}},{key:"clearBlink",value:function(e){}},{key:"applyReplacement",value:function(e){}},{key:"getPriorityNodes",value:function(){return this.meshManager.getPriorityNodes()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getRenderableCount",value:function(e){return e.getRenderableCount()}},{key:"getLoader",value:function(e){return e.getLoader()}},{key:"getContainsCamera",value:function(e){return e.containsCamera}},{key:"getFilter",value:function(e){return e.manager.filter}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"getMeshesByUserIds",value:function(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}},{key:"disposeBufferAfterVbo",value:function(){}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.hasNodeInfo(e)&&(this.meshManager.explode(e),this.wireframeManager.explode(e))}}]),e}();CLOUD.FreeIncrementedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=e,i.instanceGeometryMap={},i.bufferAttributeMap={},i.instanceNodeMap={},i.nodeIdxMapFromUserId={},i.matrixInfoMapFromUserId={},i.cachedInstance={vState:{},vColor:{},mcol0:{},mcol1:{},mcol2:{},mcol3:{},muvCol0:{},muvCol1:{},muvCol2:{}},i.selectedMeshes=[],i.nonSelectedMeshes=[],i.selectedObjectIds=[],i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.cachedInstance=null,this.instanceNodeMap=null,this.bufferAttributeMap=null,this.nodeIdxMapFromUserId=null,this.matrixInfoMapFromUserId=null,this.disposeInstanceGeometries(),this.instanceGeometryMap=null,this.manager=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null}},{key:"clearData",value:function(){this.bufferDestroyed=!1,this.disposeGeometries(),this.disposeInstanceGeometries(),this.clearInstanceCache()}},{key:"clearInstanceCache",value:function(){this.cachedInstance.vState={},this.cachedInstance.vColor={},this.cachedInstance.mcol0={},this.cachedInstance.mcol1={},this.cachedInstance.mcol2={},this.cachedInstance.mcol3={},this.cachedInstance.muvCol0={},this.cachedInstance.muvCol1={},this.cachedInstance.muvCol2={},this.bufferAttributeMap={},this.nodeIdxMapFromUserId={},this.instanceNodeMap={},this.instanceGeometryMap={},this.matrixInfoMapFromUserId={},this.geometries={}}},{key:"updateNodes",value:function(e){var t=this._getNodeGroup(e);e.isOnlyWireframe()?t.visible=!1:t.visible=!0}},{key:"createMeshNodes",value:function(e,t){this._createInstanceGeometries(e,t),this._makeInstanceNodes(e)}},{key:"_createInstanceGeometries",value:function(e,t){var i=this;e.getModelDescriptor().traverseInstancedNodeInfos(t,function(t,n){for(var r=0,a=n.length;r<a;r++){var o=n[r],s=i.getGeometryByNodeInfo(e,o),l=e.manager.getOverrideMaterialByNodeInfo(o);l&&(o.materialId=l.name)
;var c=i.getMeshIdByNodeInfo(o),u=i.cacheInstanceAttributeStateBy(e,c,s,o,l);i.cacheNodeIdxByUserId(o.userId,c,u),i.cacheMatrixInfoByUserId(o.userId,c,{matrix:o.matrix,boundingBox:o.boundingBox}),i.cacheInstanceGeometries(c,s)}})}},{key:"getBufferAttributesBy",value:function(e){if(this.bufferAttributeMap[e])return this.bufferAttributeMap[e];var t=this.cachedInstance,i=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol0[e]),3,1),n=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol1[e]),3,1),r=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol2[e]),3,1),a=new THREE.InstancedBufferAttribute(new Float32Array(t.mcol3[e]),3,1),o=[],s=[],l=[];if(t.muvCol0[e])for(var c=0,u=t.muvCol0[e].length;c<u;c++)o.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol0[e][c]),2,1)),s.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol1[e][c]),2,1)),l.push(new THREE.InstancedBufferAttribute(new Float32Array(t.muvCol2[e][c]),2,1));return this.bufferAttributeMap[e]={attributeMcol0:i,attributeMcol1:n,attributeMcol2:r,attributeMcol3:a,attributeMuvCol0Array:o,attributeMuvCol1Array:s,attributeMuvCol2Array:l},this.bufferAttributeMap[e]}},{key:"_addInstanceNodeToScene",value:function(e,t,i){this._getNodeGroup(e).add(i),i.updateMatrixWorld(!0),e.manager.addMeshToOctantMap(e._encodedDatabagId,t,i)}},{key:"addAllInstanceNodeToScene",value:function(e){this.traverseInstanceNodeMap(null,function(t,i){for(var n=0,r=i.length;n<r;n++)e.manager.addMeshToOctantMap(e._encodedDatabagId,t,i[n])})}},{key:"_makeInstanceNodeById",value:function(e,t,i){var n=this.cachedInstance,r=e.materialManager,a=this.getMaterialIdByMeshId(t),o=this.getBufferAttributesBy(t),s=r.getInstanceMaterialById(a,e);this.instanceNodeMap[t]||(this.instanceNodeMap[t]=[]);for(var l=this.instanceNodeMap[t],c=0,u=i.length;c<u;c++){i[c].addAttribute("mcol0",o.attributeMcol0),i[c].addAttribute("mcol1",o.attributeMcol1),i[c].addAttribute("mcol2",o.attributeMcol2),i[c].addAttribute("mcol3",o.attributeMcol3),o.attributeMuvCol0Array.length>0&&(i[c].addAttribute("muvCol0",o.attributeMuvCol0Array[c]),i[c].addAttribute("muvCol1",o.attributeMuvCol1Array[c]),i[c].addAttribute("muvCol2",o.attributeMuvCol2Array[c])),i[c].addAttribute("aColor",new THREE.InstancedBufferAttribute(new Float32Array(n.vColor[t]),4,1)),i[c].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,1)),i[c].addAttribute("vState2",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[t]),1,1));var h=i[c].getAttribute("vState").array,d=i[c].getAttribute("vState2").array;h.fill(CLOUD.EnumInstanceState.NONE),d.fill(CLOUD.EnumInstanceState.HIDDEN);var f=i[c].index;i[c].addGroup(0,f.count,0),i[c].addGroup(0,f.count,1);var p=new CLOUD.MeshEx(i[c],s);p.alive=!0,p.databagId=e.databagId,p.frustumCulled=!1,l.push(p),this._addInstanceNodeToScene(e,t,p)}}},{key:"_makeInstanceNodes",value:function(e){var t=this;this.traverseInstanceGeometryMap(function(i,n){t._makeInstanceNodeById(e,i,n)})}},{key:"resetInstanceMaterial",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var i=0,n=t.length;i<n;++i)t[i].getAttribute("vState").array.fill(CLOUD.EnumInstanceState.NONE),t[i].getAttribute("vState").needsUpdate=!0,t[i].getAttribute("vState2").array.fill(CLOUD.EnumInstanceState.HIDDEN),t[i].getAttribute("vState2").needsUpdate=!0})}},{key:"clearInstanceStateByUserId",value:function(e){function t(e,t,i,n){for(var r=e.getAttribute("vState").array,a=e.getAttribute("vState2").array,o=0;o<t.length;++o){var s=t[o];r[s]=i,a[s]=n}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0}var i=this,n=CLOUD.EnumInstanceState.NONE,r=CLOUD.EnumInstanceState.HIDDEN;this.traverseNodeIdxMapByUserId(e,function(e,a){var o=i.getInstanceGeometries(e);if(o)for(var s=0,l=o.length;s<l;s++)t(o[s],a,n,r)})}},{key:"updateInstanceStateByUserId",value:function(e,t,i,n){function r(e,t,i,n,r){for(var a=e.getAttribute("vState").array,o=e.getAttribute("vState2").array,s=e.getAttribute("aColor"),l=s?s.array:null,c=0;c<t.length;++c){var u=t[c];a[u]=i,o[u]=n,null!==l&&null!==r&&(l[4*u]=r[0],l[4*u+1]=r[1],l[4*u+2]=r[2],l[4*u+3]=r[3])}e.getAttribute("vState").needsUpdate=!0,e.getAttribute("vState2").needsUpdate=!0,s&&(s.needsUpdate=!0)}var a=e.materialManager,o=this;this.traverseNodeIdxMapByUserId(t,function(s,l){var c=o.getInstanceGeometries(s);if(c){var u=o.getMaterialIdByMeshId(s),h=o.getUsableMaterialColorParamsBy(e,u,i,n),d=h.rgbaColor,f=i;i===CLOUD.EnumInstanceState.TRANSPARENT&&(f=CLOUD.EnumInstanceState.OVERRIDED),i===CLOUD.EnumInstanceState.SELECTED&&o.cacheSelectedObjectIds(t,s);var p,m,g=a.getInstanceMaterialById(u,e)[0];g.transparent===h.transparent?(p=f,m=CLOUD.EnumInstanceState.HIDDEN):(p=CLOUD.EnumInstanceState.HIDDEN,m=f),f===CLOUD.EnumInstanceState.BLINK&&g.setBlinkColor(e.manager.getBlinkColor());for(var v=0,y=c.length;v<y;v++)r(c[v],l,p,m,d)}})}},{key:"getUsableMaterialColorParamsBy",value:function(e,t,i,n){var r,a,o=e.selectedMaterial,s=e.manager.filter._getMaterialByName("scene"),l=e.materialManager,c=e.manager.getOverrideMaterialByName(t),u=c||l.getMaterialById(t);switch(i){case CLOUD.EnumInstanceState.HOVER:n?(r=e.manager.filter._getMaterialByName(n),a=e.manager.sceneState.getHoverColorByMaterial(r)):a=e.manager.sceneState.getHoverColorByMaterial(u);break;case CLOUD.EnumInstanceState.SELECTED:a=CLOUD.MaterialUtil.getColorParamsByMaterial(o);break;case CLOUD.EnumInstanceState.TRANSPARENT:a=CLOUD.MaterialUtil.getColorParamsByMaterial(s);break;case CLOUD.EnumInstanceState.OVERRIDED:case CLOUD.EnumInstanceState.BLINK:n?(r=e.manager.filter._getMaterialByName(n),a=CLOUD.MaterialUtil.getColorParamsByMaterial(r)):a=CLOUD.MaterialUtil.getColorParamsByMaterial(u);break;default:a=CLOUD.MaterialUtil.getColorParamsByMaterial(u)}return a}},{key:"getInstanceNodesById",value:function(e){return this.instanceNodeMap[e]}},{key:"traverseInstanceNodeMap",value:function(e,t){var i=this.instanceNodeMap;e=e||Object.keys(this.instanceNodeMap);for(var n=0,r=e.length;n<r;n++){var a=e[n];t(a,i[a])}}},{key:"getInstanceGeometries",value:function(e){return this.instanceGeometryMap[e]}},{key:"cacheInstanceGeometries",value:function(e,t){if(!this.instanceGeometryMap[e]){var i=this.instanceGeometryMap[e]=[];t instanceof Array||(t=[t]);for(var n=0,r=t.length;n<r;++n)i[n]=new THREE.InstancedBufferGeometry,i[n].setIndex(t[n].index),i[n].addAttribute("position",t[n].attributes.position),i[n].addAttribute("normal",t[n].attributes.normal),i[n].addAttribute("uv",t[n].attributes.uv)}}},{key:"traverseInstanceGeometryMap",value:function(e){var t=this.instanceGeometryMap;for(var i in t)e(i,t[i])}},{key:"disposeInstanceGeometries",value:function(){this.traverseInstanceGeometryMap(function(e,t){for(var i=0,n=t.length;i<n;i++)t[i].dispose()})}},{key:"cacheInstanceAttributeStateBy",value:function(e,t,i,n,r){var a=n.materialId,o=n.uvArrayBuffer;i instanceof Array||(i=[i]);var s=i.length,l=this.cachedInstance;if(!l.vState[t]){l.vState[t]=[],l.vColor[t]=[],l.mcol0[t]=[],l.mcol1[t]=[],l.mcol2[t]=[],l.mcol3[t]=[],l.muvCol0[t]=[],l.muvCol1[t]=[],l.muvCol2[t]=[];for(var c=0;c<s;++c)l.muvCol0[t][c]=[],l.muvCol1[t][c]=[],l.muvCol2[t][c]=[]}var u=r||e.materialManager.getMaterialById(a);l.vColor[t].push(u.color.r,u.color.g,u.color.b,u.opacity),l.vState[t].push(0);var h=n.matrix.elements;if(l.mcol0[t].push(h[0],h[1],h[2]),l.mcol1[t].push(h[4],h[5],h[6]),l.mcol2[t].push(h[8],h[9],h[10]),l.mcol3[t].push(h[12],h[13],h[14]),o)for(var c=0;c<s;++c)l.muvCol0[t][c].push(o[6*c],o[6*c+1]),l.muvCol1[t][c].push(o[6*c+2],o[6*c+3]),l.muvCol2[t][c].push(o[6*c+4],o[6*c+5]);else for(var c=0;c<s;++c)l.muvCol0[t][c].push(1,0),l.muvCol1[t][c].push(0,1),l.muvCol2[t][c].push(0,0);return l.vState[t].length-1}},{key:"cacheNodeIdxByUserId",value:function(e,t,i){var n=this.nodeIdxMapFromUserId;n[e]||(n[e]={}),n[e][t]||(n[e][t]=[]),n[e][t].push(i)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){var i=this.nodeIdxMapFromUserId[e];for(var n in i)t(n,i[n])}},{key:"traverseNodeIdxMap",value:function(e,t){for(var i=Object.keys(this.nodeIdxMapFromUserId),n=0,r=i.length;n<r;n++){var a=i[n],o=this.nodeIdxMapFromUserId[a];if(!t||!t(a))for(var s in o)e(s,o[s])}}},{key:"cacheMatrixInfoByUserId",value:function(e,t,i){var n=this.matrixInfoMapFromUserId;n[e]||(n[e]={}),n[e][t]||(n[e][t]=[]),n[e][t].push(i)}},{key:"traverseMatrixInfoMapByUserId",value:function(e,t){var i=this.matrixInfoMapFromUserId[e];for(var n in i)t(n,i[n])}},{key:"getMeshesByUserId",value:function(e,t){var i=this;this.traverseMatrixInfoMapByUserId(t,function(n,r){for(var a=i.getInstanceNodesById(n),o=0,s=r.length;o<s;o++)for(var l=0,c=a.length;l<c;l++){var u={};if(u.matrix=r[o].matrix,u.mesh=a[l],1===c)u.boundingBox=r[o].boundingBox;else{var h=u.mesh.geometry.boundingBox;h?h=h.clone():(u.mesh.geometry.computeBoundingBox(),h=u.mesh.geometry.boundingBox.clone()),h.applyMatrix4(u.matrix),u.boundingBox=h}e.minDistanceObjects[t].push(u)}})}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY)}},{key:"clearSelectedObjectIds",value:function(){this.selectedObjectIds.length=0}},{key:"cacheSelectedObjectIds",value:function(e,t){this.selectedObjectIds.push({uid:e,mgId:t})}},{key:"adjustVisibility",value:function(e,t){var i=this._getNodeGroup(e),n=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=n}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){var i;if(t){i=this.selectedMeshes;for(var n=0,r=i.length;n<r;n++){var a=i[n].object,o=i[n].indices;if(o){if(o.length){for(var s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,c=0,u=o.length;c<u;c++)o[c].state?s[o[c].idx]=o[c].state:o[c].state2&&(l[o[c].idx]=o[c].state2);a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0}}else a.visible=i[n].visibility}}else{this.selectedMeshes.length=0,i=this.selectedMeshes;for(var h={},n=0,r=this.selectedObjectIds.length;n<r;n++)h[this.selectedObjectIds[n].mgId]=!0;var d=Object.keys(h);this.traverseInstanceNodeMap(d,function(e,t){for(var n=0,r=t.length;n<r;n++){for(var a=t[n],o=[],s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,c=0,u=s.length;c<u;c++)s[c]===CLOUD.EnumInstanceState.SELECTED?(o.push({idx:c,state:s[c]}),s[c]=CLOUD.EnumInstanceState.HIDDEN):l[c]===CLOUD.EnumInstanceState.SELECTED&&(o.push({idx:c,state2:l[c]}),l[c]=CLOUD.EnumInstanceState.HIDDEN);o.length?(a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0,i.push({object:a,indices:o})):(i.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}})}}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){var i;if(t){i=this.nonSelectedMeshes;for(var n=0,r=i.length;n<r;n++){var a=i[n].object,o=i[n].indices;if(o){if(o.length){for(var s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,c=0,u=o.length;c<u;c++)o[c].state?s[o[c].idx]=o[c].state:o[c].state2&&(l[o[c].idx]=o[c].state2);a.geometry.getAttribute("vState").needsUpdate=!0}}else a.visible=i[n].visibility}}else{this.nonSelectedMeshes.length=0,i=this.nonSelectedMeshes;for(var h={},n=0,r=this.selectedObjectIds.length;n<r;n++)h[this.selectedObjectIds[n].mgId]=!0;this.traverseInstanceNodeMap(null,function(e,t){if(h[e])for(var n=0,r=t.length;n<r;n++){for(var a=t[n],o=[],s=a.geometry.getAttribute("vState").array,l=a.geometry.getAttribute("vState2").array,c=0,u=s.length;c<u;c++)s[c]!==CLOUD.EnumInstanceState.SELECTED&&s[c]!==CLOUD.EnumInstanceState.HIDDEN?(o.push({idx:c,state:s[c]}),s[c]=CLOUD.EnumInstanceState.HIDDEN):l[c]!==CLOUD.EnumInstanceState.SELECTED&&l[c]!==CLOUD.EnumInstanceState.HIDDEN&&(o.push({idx:c,state2:l[c]}),l[c]=CLOUD.EnumInstanceState.HIDDEN);o.length?(a.geometry.getAttribute("vState").needsUpdate=!0,a.geometry.getAttribute("vState2").needsUpdate=!0,i.push({object:a,indices:o})):(i.push({object:a,indices:null,visibility:a.visible}),a.visible=!1)}else for(var n=0,r=t.length;n<r;n++){var a=t[n];i.push({object:a,indices:null,visibility:a.visible}),a.visible=!1}})}}},{key:"restoreVisibilityOfObjects",value:function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}},{key:"getMeshIdByNodeInfo",value:function(e){return CLOUD.Utils.getCombinedKeyString([e.materialId,e.geometryId])}},{key:"getMaterialIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[0]}},{key:"disposeBufferAfterVbo",value:function(){if(!this.bufferDestroyed){this.bufferDestroyed=!0;var e=["muvCol0","muvCol1","muvCol2","mcol0","mcol1","mcol2","mcol3"];CLOUD.GlobalData.EnableExplosion&&e.pop(),this.traverseInstanceGeometryMap(function(t,i){for(var n=0,r=i.length;n<r;n++)CLOUD.GeomUtil.disposeBufferFromGeometry(i[n],e)})}}},{key:"getGeometryBuffersByUserId",value:function(e,t){var i=e.getModelDescriptor().getInstancedNodeInfosById(t);if(!i)return[];for(var n=[],r=e.getDatabagId(),a=0,o=i.length;a<o;a++){var s=i[a],l=this.getGeometryByNodeInfo(e,s);if(l instanceof Array)for(var c=0,u=l.length;c<u;c++)n.push({databagId:r,nodeId:s.nodeId,position:l[c].getAttribute("position").array,index:l[c].getIndex().array,matrix:s.matrix});else n.push({databagId:r,nodeId:s.nodeId,position:l.getAttribute("position").array,index:l.getIndex().array,matrix:s.matrix})}return n}},{key:"explode",value:function(e){function t(e,t,i){for(var n=e.getAttribute("mcol3").array,r=0;r<t.length;++r){var a=t[r];n[3*a]+=i.x,n[3*a+1]+=i.y,n[3*a+2]+=i.z}e.getAttribute("mcol3").needsUpdate=!0}var i=this;for(var n in i.nodeIdxMapFromUserId)i.traverseNodeIdxMapByUserId(n,function(r,a){var o=e.manager.getExplosionTranslation(n),s=i.getInstanceGeometries(r);s&&t(s[0],a,o)})}}]),t}(CLOUD.MeshManager);CLOUD.InstancedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.wireframeGeometryMap={},this.noNeedWireframingIdMap={},this.generated=!1}return _createClass(e,[{key:"destroy",value:function(){this.disposeGeometries(),this.wireframeGeometryMap=null,this.noNeedWireframingIdMap=null,this.manager=null}},{key:"clearData",value:function(){this.generated=!1,this.bufferDestroyed=!1,this.disposeGeometries(),this.wireframeGeometryMap={},this.noNeedWireframingIdMap={}}},{key:"disposeGeometries",value:function(){this._traverseWireframeGeometryMap(function(e,t){for(var i=0,n=t.length;i<n;i++)t[i].dispose()})}},{key:"updateNodes",value:function(e){var t;e.isActivateWireframe()?(t=this._getNodeGroup(e),t.updateMatrixWorld(!0),t.visible=!0):this._hasNodeGroup(e)&&(t=this._getNodeGroup(e),t.visible=!1)}},{key:"resetInstanceMaterial",value:function(){var e=CLOUD.EnumInstanceState.NONE;this._traverseWireframeGeometryMap(function(t,i){for(var n=0,r=i.length;n<r;++n){for(var a=i[n].getAttribute("vState").array,o=0,s=a.length;o<s;o++)a[o]=e;i[n].getAttribute("vState").needsUpdate=!0}}),this._updateNoWireframingState()}},{key:"updateInstanceWireframeByUserId",value:function(e,t){if(t===CLOUD.EnumInstanceState.HIDDEN||t===CLOUD.EnumInstanceState.NONE){var i=this;this.manager.traverseNodeIdxMapByUserId(e,function(e,n){i._setInstanceWireframeState(e,n,t)})}}},{key:"_updateNoWireframingState",value:function(){var e=this,t=CLOUD.EnumInstanceState.HIDDEN;this.manager.traverseNodeIdxMap(function(i,n){e._setInstanceWireframeState(i,n,t)},function(t){return e._isNeedWireframing(t)})}},{key:"_setInstanceWireframeState",value:function(e,t,i){var n=this._getWireframeGeometryById(e);if(n)for(var r=0,a=n.length;r<a;++r){for(var o=n[r].getAttribute("vState").array,s=0,l=t.length;s<l;++s){var c=t[s];o[c]=i}n[r].getAttribute("vState").needsUpdate=!0}}},{key:"_generateInstanceWireframe",value:function(e){this._collectNoWireframingIds(e),this._createInstanceWireframeGeometries(),this._makeInstanceWireframe(e),this._updateNoWireframingState()}},{key:"generateWireframe",value:function(e){this.generated||(this._generateInstanceWireframe(e),this.generated=!0)}},{key:"_collectNoWireframingIds",value:function(e){var t=this,i=e.manager.filter;e.getModelDescriptor().traverseInstancedNodeInfos(null,function(e,n){n&&i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(n[0])&&(t.noNeedWireframingIdMap[e]=!0)})}},{key:"_createInstanceWireframeGeometries",value:function(){var e=this,t={};this.manager.traverseInstanceGeometryMap(function(i,n){for(var r=e._getWireframeBufferById(i,n,t),a=e.wireframeGeometryMap[i]=[],o=0,s=r.length;o<s;o++){var l=new THREE.InstancedBufferGeometry;l.setIndex(r[o].index),l.addAttribute("position",r[o].position),a.push(l)}}),t=null}},{key:"_makeInstanceWireframe",value:function(e){var t=this,i=this.manager,n=i.getCachedInstanceData(),r=this._getWireframeMaterial(e);this._traverseWireframeGeometryMap(function(a,o){for(var s=i.getBufferAttributesBy(a),l=0,c=o.length;l<c;l++){o[l].addAttribute("vState",new THREE.InstancedBufferAttribute(new Float32Array(n.vState[a]),1,1)),o[l].addAttribute("mcol0",s.attributeMcol0),o[l].addAttribute("mcol1",s.attributeMcol1),o[l].addAttribute("mcol2",s.attributeMcol2),o[l].addAttribute("mcol3",s.attributeMcol3);var u=new THREE.LineSegments(o[l],r);u.frustumCulled=!1,t._addWireframeNodeToScene(e,u)}})}},{key:"_addWireframeNodeToScene",value:function(e,t){this._getNodeGroup(e).add(t),t.updateMatrixWorld(!0)}},{key:"_isNeedWireframing",value:function(e){return!this.noNeedWireframingIdMap||!this.noNeedWireframingIdMap[e]}},{key:"_getWireframeMaterial",value:function(e){return e.getInstanceWireframeMaterial()}},{key:"_getWireframeBufferById",value:function(e,t,i){var n=this.getGeometryIdByMeshId(e);if(i[n])return i[n];i[n]=[];for(var r=0,a=t.length;r<a;r++){var o=t[r];i[n].push({index:CLOUD.BuildEdge(o.attributes.position.array,o.index.array),position:o.attributes.position})}return i[n]}},{key:"_getWireframeGeometryById",value:function(e){return this.wireframeGeometryMap[e]}},{key:"_traverseWireframeGeometryMap",value:function(e){var t=this.wireframeGeometryMap;for(var i in t)e(i,t[i])}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY)}},{key:"getGeometryIdByMeshId",value:function(e){return CLOUD.Utils.splitCombinedKeyString(e)[1]}},{key:"adjustVisibility",value:function(e,t){if(e.isActivateWireframe()){var i=this._getNodeGroup(e),n=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=n}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){if(this.generated&&!this.bufferDestroyed){this.bufferDestroyed=!0;var e=["mcol0","mcol1","mcol2","mcol3"];CLOUD.GlobalData.EnableExplosion&&e.pop(),this._traverseWireframeGeometryMap(function(t,i){for(var n=0,r=i.length;n<r;n++)CLOUD.GeomUtil.disposeBufferFromGeometry(i[n],e)})}}}]),e}();CLOUD.InstancedWireframeManager=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.meshManager=new CLOUD.InstancedMeshManager(this),this.wireframeManager=new CLOUD.InstancedWireframeManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData()}},{key:"getGeometryByNodeInfo",value:function(e,t){return this.meshManager.getGeometryByNodeInfo(e,t)}},{key:"getInstanceGeometries",value:function(){return this.meshManager.instanceGeometryMap}},{key:"traverseInstanceGeometryMap",value:function(e){this.meshManager.traverseInstanceGeometryMap(e)}},{key:"getCachedInstanceData",value:function(){return this.meshManager.cachedInstance}},{key:"getBufferAttributesBy",value:function(e){return this.meshManager.getBufferAttributesBy(e)}},{key:"traverseNodeIdxMapByUserId",value:function(e,t){this.meshManager.traverseNodeIdxMapByUserId(e,t)}},{key:"traverseNodeIdxMap",value:function(e,t){this.meshManager.traverseNodeIdxMap(e,t)}},{key:"getMeshesByUserId",value:function(e,t){this.meshManager.getMeshesByUserId(e,t)}},{key:"_updateInstanceMaterialByUserId",value:function(e,t,i,n){this.meshManager.updateInstanceStateByUserId(e,t,i,n),this.wireframeManager.updateInstanceWireframeByUserId(t,i)}},{key:"_updateInstanceMaterial",value:function(e){CLOUD.Logger.time("update instance material");var t=CLOUD.Model.EnumFilterState;this.clearSelectedObjectIds();for(var i in this.filteredIds){var n=this.filteredIds[i];if(n[t.HIDDEN])this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HIDDEN);else if(n[t.TRANSPARENT])this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.TRANSPARENT);else{if(e.manager.isSelectPriority()){if(n[t.SELECTED]){this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.SELECTED);continue}if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK);continue}}else{if(n[t.BLINK]){n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.BLINK);continue}if(n[t.SELECTED]){this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.SELECTED);continue}}n[t.HOVER]?n[t.OVERRIDED]?this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HOVER,n[t.OVERRIDED]):this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.HOVER):n[t.OVERRIDED]&&this._updateInstanceMaterialByUserId(e,i,CLOUD.EnumInstanceState.OVERRIDED,n[t.OVERRIDED])}}CLOUD.Logger.timeEnd("update instance material")}},{key:"_resetInstanceMaterial",value:function(){this.meshManager.resetInstanceMaterial(),this.wireframeManager.resetInstanceMaterial()}},{key:"_collectFilteredUserIds",value:function(e,t,i){var n=e.manager.filter,r=n._hasHiddenFileIdFilter(),a=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),s=n._hasTransparentFilter(),l=e.hasReplacedUserId(),c=e.hasHiddenUserId(),u=this.filteredIds={};if(r||a||o||s||l||c)for(var h=CLOUD.Model.EnumFilterState,d=0;d<t.length;++d){var f=t[d],p=i[f];if(p&&p.length){var m=p[0];if(r&&n._isHiddenFileId(m)||a&&!1===n._isVisible(m)||e.isReplacedUserId(f)||e.isHiddenUserId(f))u[f]||(u[f]={}),u[f][h.HIDDEN]=!0;else if(s&&n._isTransparent(m))u[f]||(u[f]={}),u[f][h.TRANSPARENT]=!0;else if(o&&n._hasOverrideMaterial(m)){var g=n._getOverrideMaterial(m),v=null!=g?g.name:"";""!==v&&(u[f]||(u[f]={}),u[f][h.OVERRIDED]=v)}else;}}}},{key:"_collectSelectedUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{},n=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(i[a]||(i[a]={}),i[a][n.SELECTED]=!0,r[a]=!0);this.selectedUserIds=Object.keys(r)}},{key:"_clearSelectedState",value:function(e){if(this.filteredIds&&this.selectedUserIds&&this.selectedUserIds.length){for(var t=0,i=this.selectedUserIds.length;t<i;t++){var n=this.selectedUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][CLOUD.Model.EnumFilterState.SELECTED])}this.selectedUserIds=null}}},{key:"_collectHoveredUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{};this.hoverdUserId=void 0,e&&t[e]&&(i[e]||(i[e]={}),i[e][CLOUD.Model.EnumFilterState.HOVER]=!0,this.hoverdUserId=e)}},{key:"_clearHoveredState",value:function(e){this.filteredIds&&this.hoverdUserId&&this.filteredIds[this.hoverdUserId]&&(this.meshManager.clearInstanceStateByUserId(this.hoverdUserId),delete this.filteredIds[this.hoverdUserId][CLOUD.Model.EnumFilterState.HOVER],this.hoverdUserId=void 0)}},{key:"_collectBlinkedUserIds",value:function(e,t){var i=this.filteredIds=this.filteredIds||{},n=CLOUD.Model.EnumFilterState,r={};for(var a in e)t[a]&&(i[a]||(i[a]={}),i[a][n.BLINK]=!0,r[a]=!0);this.blinkUserIds=Object.keys(r)}},{key:"_clearBlinkedState",value:function(e){if(this.filteredIds&&this.blinkUserIds&&this.blinkUserIds.length){for(var t=0,i=this.blinkUserIds.length;t<i;t++){var n=this.blinkUserIds[t];this.filteredIds[n]&&(this.meshManager.clearInstanceStateByUserId(n),delete this.filteredIds[n][CLOUD.Model.EnumFilterState.BLINK])}this.blinkUserIds=null}}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){this.updateNodes(e),this._resetInstanceMaterial();var i;i=t||e.getModelDescriptor().getInstancedUserIds();var n=e.getModelDescriptor().getInstancedNodeInfos();this._collectFilteredUserIds(e,i,n),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,n),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(),n),this._collectHoveredUserIds(e.manager.sceneState.hoverId,n),this._updateInstanceMaterial(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getInstancedNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._updateInstanceMaterial(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._updateInstanceMaterial(e),this.updateNodes(e)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getInstancedNodeInfos()}},{key:"updateNodes",value:function(e){this.hasNodeInfo(e)&&(this.meshManager.updateNodes(e),this.wireframeManager.updateNodes(e))}},{key:"generateWireframe",value:function(e,t){this.wireframeManager.generateWireframe(e,t)}},{key:"createMeshNodes",value:function(e,t){this.meshManager.createMeshNodes(e,t)}},{key:"clearCachedData",value:function(){this.meshManager.disposeGeometries()}},{key:"getMeshesByUserIds",value:function(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}},{key:"clearSelectedObjectIds",value:function(){this.meshManager.clearSelectedObjectIds()}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"addAllInstanceNodeToScene",value:function(e){this.meshManager.addAllInstanceNodeToScene(e)}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.meshManager.explode(e)}}]),e}();CLOUD.InstancedManager=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.manager=e,i._maxIndiceseNum=0,i._materialList=[],i.mapMaterialIdToMergedNode={},i.selectedMeshes=[],i.nonSelectedMeshes=[],i.selectedObjectIds=[],i.blinkMaterials=[],i.mapDestroyedBufferKey={},i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){_get(t.prototype.__proto__||Object.getPrototypeOf(t.prototype),"destroy",this).call(this),this.clearData(),this.mapMaterialIdToMergedNode=null,this.manager=null,this._materialList=null,this.selectedMeshes=null,this.nonSelectedMeshes=null,this.selectedObjectIds=null,this.blinkMaterials=null,this.mapDestroyedBufferKey=null}},{key:"clearData",value:function(){this.bufferDestroyed=!1,this.clearAllNodeBuffer(),this._disposeMergedGeometries()}},{key:"getMeshesByUserIds",value:function(e,t,i){for(var n in this.mapMaterialIdToMergedNode)for(var r=this.mapMaterialIdToMergedNode[n],a=0,o=r.length;a<o;a++){var s=r[a],l=s.indices;for(var c in l)if(c==t||c==i)for(var u=l[c],h=0,d=u.length;h<d;h++){var f={};f.mesh=s.mesh,f.indexInfo=u[h],f.boundingBox=u[h].boundingBox,e.minDistanceObjects[c].push(f)}}}},{key:"rebuildIndices",value:function(e){this._materialList.length=0;var t=CLOUD.GlobalData.EnableLightmap&&e.lightmap;this.clearSelectedObjectIds();var i,n=this.manager.getFilteredUserIds(),r=this.manager.getSelectedUserIds(),a=this.manager.getHoveredUserIds(),o=this.manager.getBlinkedUserIds(),s=e.manager,l=s.scene,c=l.fillClipPlane,u=c&&CLOUD.GlobalData.ClippingCaps;if(u){c&&(i=c.renderClipPlane);var h={};for(var d in this.mapMaterialIdToMergedNode)for(var f=this.mapMaterialIdToMergedNode[d],p=0,m=f.length;p<m;p++){var g=f[p],v=g.mesh,y=g.indices;for(var E in y){var x=y[E];for(b=0,C=x.length;b<C;b++)"LineSegmentsEx"!=v.type&&v.intersectBoxWithClipPlane(i,x[b])&&(h[E]=!0)}}}for(var d in this.mapMaterialIdToMergedNode){var b,C,p,m,M=this.getPropertyValueByMaterialKey(d),_=M.materialId,w=null,L=null,T=null,I=null,S=null,O=null;r&&r[_]&&(I=r[_]),a&&a[_]&&(S=a[_]),o&&o[_]&&(O=o[_]),n&&n[_]&&(w=n[_][CLOUD.Model.EnumFilterState.HIDDEN],L=n[_][CLOUD.Model.EnumFilterState.OVERRIDED],T=n[_][CLOUD.Model.EnumFilterState.TRANSPARENT]);var f=this.mapMaterialIdToMergedNode[d];for(p=0,m=f.length;p<m;p++){var g=f[p],v=g.mesh,y=g.indices,D=g.geometry;if(D.clearGroups(),D._visible=!0,t)for(var R=e.lightmapNum,A=0;A<R;A++){var U="lightmap|"+A,B=this._materialList.indexOf(U);-1===B&&this._materialList.push(U)}if(I||w||L||S||T||t||u||O){var P=[];for(var E in y)if(y.hasOwnProperty(E)){if(w&&w[E])continue;var x=y[E];if(x&&x.length>0){if(T&&T[E]){for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.TRANSPARENT});continue}if(e.manager.isSelectPriority()){if(I&&I[E]){for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.SELECTED});this.cacheSelectedObjectIds(E,d,p);continue}if(O&&O[E]){if(L&&L[E]){var U="blink|"+L[E],B=this._materialList.indexOf(U);for(-1===B&&(this._materialList.push(U),B=this._materialList.length-1),b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+B});continue}for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.BLINK});continue}}else{if(O&&O[E]){if(L&&L[E]){var U="blink|"+L[E],B=this._materialList.indexOf(U);for(-1===B&&(this._materialList.push(U),B=this._materialList.length-1),b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+B});continue}for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.BLINK});continue}
if(I&&I[E]){for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.SELECTED});this.cacheSelectedObjectIds(E,d,p);continue}}if(S&&S[E]){if(L&&L[E]){var U="hover|"+L[E],B=this._materialList.indexOf(U);for(-1===B&&(this._materialList.push(U),B=this._materialList.length-1),b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+B});continue}for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.HOVER});continue}if(L&&L[E]){var U=L[E],B=this._materialList.indexOf(U);for(-1===B&&(this._materialList.push(U),B=this._materialList.length-1),b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.OVERRIDED+B});continue}if(u&&h[E]){for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:CLOUD.Model.EnumFilterState.CLIPPING});continue}if(t)for(b=0,C=x.length;b<C;b++){var B=this._materialList.indexOf("lightmap|"+x[b].lightmapIdx);P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:void 0==x[b].lightmapIdx?0:CLOUD.Model.EnumFilterState.OVERRIDED+B})}else for(b=0,C=x.length;b<C;b++)P.push({indexStart:x[b].indexStart,indexCount:x[b].indexCount,state:0})}}if(P.length>0)for(P.sort(function(e,t){return e.state===t.state?e.indexStart-t.indexStart:e.state-t.state}),b=0,C=P.length;b<C;b++){var N=P[b].indexStart,k=P[b].indexCount,F=P[b].state;if(0===b)D.addGroup(N,k,F);else{var H=P[b-1].indexStart,G=P[b-1].indexCount,V=P[b-1].state,z=H+G;F===V&&N===z?D.groups[D.groups.length-1].count+=k:D.addGroup(N,k,F)}}else D._visible=!1}}}}},{key:"update",value:function(e){var t,i,n,r,a=e.manager.filter,o=e.materialManager.materials,s=e.selectedMaterial,l=e.manager.sceneState,c=CLOUD.GlobalData.EnableLightmap&&e.lightmap;if(e.isOnlyWireframe())for(var u in this.mapMaterialIdToMergedNode){var h=this.mapMaterialIdToMergedNode[u];for(n=0,r=h.length;n<r;n++){var d=h[n].mesh;d&&(d.visible=!1)}}else{CLOUD.GlobalData.TranslucentDepthDisabled&&(s.transparent?s.depthWrite=!1:s.depthWrite=!0);var f=a._getMaterialByName("scene");CLOUD.GlobalData.TranslucentDepthDisabled&&(f.depthWrite=!1);var p=[];this.blinkMaterials.length=0;var m={};if(!c)for(t=0,i=this._materialList.length;t<i;t++){var g,v=this._materialList[t],y=v.split("|");"hover"===y[0]?(g=a._getMaterialByName(y[1]),g=l.getHoverMaterial(g)):"blink"===y[0]?(g=a._getMaterialByName(y[1]),g=l.getBlinkMaterial(g),m[v]||this.blinkMaterials.push(g)):g=a._getMaterialByName(v),CLOUD.GlobalData.TranslucentDepthDisabled&&(g.transparent?g.depthWrite=!1:g.depthWrite=!0),p[t]=g}for(var u in this.mapMaterialIdToMergedNode){var E=this.getPropertyValueByMaterialKey(u),x=E.materialId,b=e.manager.getOverrideMaterialByName(x),C=b||o[x]||CLOUD.MaterialUtil.getDefaultStandardMaterial();if(c)for(t=0,i=this._materialList.length;t<i;t++){var g,v=this._materialList[t],y=v.split("|");if("lightmap"===y[0])if(CLOUD.GlobalData.IBL)g=C.clone();else{var M=CLOUD.MaterialUtil.getMaterialParameters(C);M.lights=!1,g=CLOUD.MaterialUtil.createStandardMaterial(M),g.lightMap=e.materialManager.lightmaps[y[1]],g.lightMapIntensity=CLOUD.GlobalData.LightmapIntensity}CLOUD.GlobalData.TranslucentDepthDisabled&&(g.transparent?g.depthWrite=!1:g.depthWrite=!0),p[t]=g}CLOUD.GlobalData.TranslucentDepthDisabled&&(C.transparent?C.depthWrite=!1:C.depthWrite=!0);var _=l.getHoverMaterial(o[x]);CLOUD.GlobalData.TranslucentDepthDisabled&&(_.transparent?_.depthWrite=!1:_.depthWrite=!0);var h=this.mapMaterialIdToMergedNode[u];for(n=0,r=h.length;n<r;n++){var w=h[n],L=w.geometry;if(null!==L){var d=w.mesh;if(L._visible){if(L.groups.length>0){var T=m[x];T||(T=m[x]=l.getBlinkMaterial(C),this.blinkMaterials.push(T));var I=[C,s,T,_,f];for(t=0,i=p.length;t<i;t++)I.push(p[t]);d.material=I}else d.material=C;d.visible=!0}else d.visible=!1}}C=null}}}},{key:"explode",value:function(e){for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],n=0,r=i.length;n<r;n++){var a=i[n],o=a.geometry;if(null!==o){var s=a.indices;for(var l in s){var c=e.manager.getExplosionTranslation(l),u=s[l];if(u)for(var h=0,d=u.length;h<d;h++){var f=u[h].positionStart,p=f+u[h].positionCount;!function(e,t,i,n){for(var r=e.getAttribute("position").array,a=t;a<i;a+=3)r[a]+=n.x,r[a+1]+=n.y,r[a+2]+=n.z;e.getAttribute("position").needsUpdate=!0}(o,f,p,c)}}}}}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.GEOMETRY,{globalSpace:!0})}},{key:"_hasNodeGroup",value:function(e){return e._hasNodeGroup(CLOUD.ObjectGroupType.GEOMETRY)}},{key:"_resetMaxIndicesNumberPerBathSegment",value:function(e){CLOUD.GlobalData.SegmentedBatchMergeEnable&&CLOUD.GlobalData.maxIndicesNumberPerBathSegment<this._maxIndiceseNum&&(console.log("adjust maxIndicesNumberPerBathSegment value from "+CLOUD.GlobalData.maxIndicesNumberPerBathSegment+" to "+this._maxIndiceseNum+"!"),CLOUD.GlobalData.maxIndicesNumberPerBathSegment=e)}},{key:"asyncCreateMeshNodes",value:function(e,t,i){var n=this;t&&t.length?this._asyncMergeData(e,t,function(){n._makeMeshNodes(e),i&&i()}):i&&i()}},{key:"_asyncMergeData",value:function(e,t,i){function n(d){var f=d;return function(){var d,p;for(p=f+u>c?c:f+u,d=f;d<p;d++){var m=t[d];if(a._collectMergedNodeInfosById(e,m,h,r),d===p-1)if(p!==c){var g={total:o,loaded:(d/c*l+s)*o};e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),requestAnimationFrame(n(d+1))}else{var g={total:o,loaded:(l+s)*o};e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),a._asyncMergeGeometry(r,e,i)}}}}var r={},a=this,o=e.getLoader().maxLoadTaskCount,s=e.progressPercentage.load,l=e.progressPercentage.collect,c=t.length,u=Math.ceil(c/e.progressFrequency),h=e.getModelDescriptor().getStandardNodeInfos();requestAnimationFrame(n(0))}},{key:"_asyncMergeGeometry",value:function(e,t,i){function n(a){var p=a;return function(){var a,m;for(m=p+d>h?h:p+d,a=p;a<m;a++)if(o._collectMergedGeometriesById(r[a],e,f),a===m-1)if(m!==r.length){var g={total:s,loaded:(a/h*u+l+c)*s};t.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:g}),requestAnimationFrame(n(a+1))}else i()}}var r=[];for(var a in e)r.push(a);if(0===r.length)return void i();this._resetMaxIndicesNumberPerBathSegment(this._maxIndiceseNum);var o=this,s=t.getLoader().maxLoadTaskCount,l=t.progressPercentage.load,c=t.progressPercentage.collect,u=t.progressPercentage.merge,h=r.length,d=Math.ceil(h/t.progressFrequency),f=this.mapMaterialIdToMergedNode;requestAnimationFrame(n(0))}},{key:"_collectMergedNodeInfosById",value:function(e,t,i,n){for(var r=i[t],a=0,o=r.length;a<o;a++){var s=r[a];this._createNodeBuffer(e,s);var l=this._getNodeBufferBy(s.nodeId);if(l){var c=l.index;c&&c.length>this._maxIndiceseNum&&(this._maxIndiceseNum=c.length);var u=this._getMaterialKeyByNodeInfo(s,e);void 0===n[u]&&(n[u]=[]),n[u].push(s)}}}},{key:"_collectMergedGeometriesById",value:function(e,t,i){var n=t[e],r=0,a=0,o=0,s=0,l=0,c=null;void 0===i[e]&&(i[e]=[]);for(var u=[],h=0,d=0,f=n.length;d<f;d++){var p=n[d];c=this._getNodeBufferBy(p.nodeId),c?(a+=c.index.length,r+=c.position.length,c.normal&&(o+=c.normal.length),c.uv&&(s+=c.uv.length),c.uv2&&(l+=c.uv2.length),CLOUD.GlobalData.SegmentedBatchMergeEnable&&a>CLOUD.GlobalData.maxIndicesNumberPerBathSegment?(a-=c.index.length,r-=c.position.length,c.normal&&(o-=c.normal.length),c.uv&&(s-=c.uv.length),c.uv2&&(l-=c.uv2.length),u.push({start:h,end:d,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l}),r=0,a=0,o=0,s=0,l=0,h=d,d-=1):d===f-1&&u.push({start:h,end:f,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l}),c=null):d===f-1&&u.push({start:h,end:f,arrayPositionLength:r,arrayIndexLength:a,arrayNormalLength:o,arrayUVLength:s,arrayUV2Length:l})}for(var m=0,g=u.length;m<g;m++){for(var v=u[m],y=new THREE.BufferGeometry,E={},x=new Float32Array(v.arrayPositionLength),b=new Uint32Array(v.arrayIndexLength),C=new Float32Array(v.arrayNormalLength),M=new Float32Array(v.arrayUVLength),_=new Float32Array(v.arrayUV2Length),w=0,L=0,T=0,I=0,S=0,O=[],d=v.start,f=v.end;d<f;d++){var p=n[d];if(c=this._getNodeBufferBy(p.nodeId)){O.push(p.nodeId);var D=c.index,R=c.position,A=c.normal,U=c.uv,B=c.uv2;x.set(R,w);for(var P=Uint32Array.from(D),N=0,k=P.length;N<k;N++)P[N]+=w/3;b.set(P,L),void 0===E[p.userId]&&(E[p.userId]=[]),E[p.userId].push({userId:p.userId,nodeId:p.nodeId,positionStart:w,positionCount:R.length,indexStart:L,indexCount:D.length,lightmapIdx:p.lightmapIdx,boundingBox:p.boundingBox}),L+=D.length,w+=R.length,A&&(C.set(A,T),T+=A.length),U&&(M.set(U,I),I+=U.length),B&&(_.set(B,S),S+=B.length),D=null,R=null,A=null,U=null,B=null,c=null}}this.clearNodeBufferByNodeIds(O),y._visible=!0,y.setIndex(new THREE.BufferAttribute(b,1)),y.addAttribute("position",new THREE.BufferAttribute(x,3)),T>0&&y.addAttribute("normal",new THREE.BufferAttribute(C,3)),I>0&&y.addAttribute("uv",new THREE.BufferAttribute(M,2)),S>0&&y.addAttribute("uv2",new THREE.BufferAttribute(_,2)),i[e].push({geometry:y,indices:E})}}},{key:"clearAllNodeBuffer",value:function(){this.cachedNodeBuffer&&(this.cachedNodeBuffer=null)}},{key:"clearNodeBufferByNodeIds",value:function(e){if(this.cachedNodeBuffer)for(var t=0,i=e.length;t<i;t++)this.cachedNodeBuffer[e[t]]=null}},{key:"_getNodeBufferByNodeInfo",value:function(e,t){return this.cachedNodeBuffer||this._createNodeBuffer(e,t),this.cachedNodeBuffer[t.nodeId]}},{key:"_getNodeBufferBy",value:function(e){return this.cachedNodeBuffer?this.cachedNodeBuffer[e]:null}},{key:"_createNodeBufferByMpkBufferData",value:function(e,t,i){this.cachedNodeBuffer||(this.cachedNodeBuffer={}),this.cachedNodeBuffer[t.nodeId]||(this.cachedNodeBuffer[t.nodeId]=this.createBufferByBufferDataWithUV2(e,t,i))}},{key:"_createNodeBuffer",value:function(e,t){this._createNodeBufferByMpkBufferData(e,t,{buffer:e.getModelDescriptor().getReferencedMeshBufferById(t.geometryId),isDataView:!0})}},{key:"_createGeometries",value:function(e,t){var i=this,n=e.getModelDescriptor().getNodeInfosOnGeometryId(),r=e.getModelDescriptor().getReferencedMeshBufferData(),a=this._getClassifiedMeshes(n,r);this._dealDataMergedMeshs(e,a,r,n,function(){i._dealDataMergeableMeshs(e,a,r,n,t)})}},{key:"_getClassifiedMeshes",value:function(e,t){var i=[],n=[];for(var r in t){var a=t[r],o=a.IndexInfos,s=void 0;if(o){if(o.length<1)continue;for(var l=0,c=o.length;l<c;l++){var u=e[o[l].meshId];if(u&&u.length){s=o[l].meshId;break}}}else{var u=e[r];u&&u.length&&(s=r)}if(void 0!==s){var u=e[s];u&&u.length&&(u[0].type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE||!u[0].instanceOrNot&&u[0].type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.MESH_REF?i.push(r):n.push(r))}}if(!CLOUD.GlobalData.Instance)for(var r in e)n[r]||i[r]||i.push(r);return{mergeableIdxs:i,mergedIdxs:n}}},{key:"_collectMergeableMeshesByIdxId",value:function(e,t,i,n,r){i[t]&&i[t].IndexInfos?this._collectSharedMeshesByIdxId(e,t,i,n,r):this._collectLineOrIntanceMeshesByIdxId(e,t,i,n,r)}},{key:"_collectLineOrIntanceMeshesByIdxId",value:function(e,t,i,n,r){for(var a=n[t],o=e.getModelDescriptor().getReferencedMeshBufferById(t),s={buffer:o},l=0,c=a.length;l<c;l++){var u=a[l];this._createNodeBufferByMpkBufferData(e,u,s);var h=this._getMaterialKeyByNodeInfo(u);r[h]||(r[h]=[]),r[h].push(u)}}},{key:"_collectSharedMeshesByIdxId",value:function(e,t,i,n,r){for(var a=i[t],o=a.IndexInfos,s=0,l=o.length;s<l;s++){var c=n[o[s].meshId];if(c)for(var u=e.getModelDescriptor().getReferencedMeshBufferById(t),h={buffer:u,indexInfo:o[s]},d=0,f=c.length;d<f;d++){var p=c[d];this._createNodeBufferByMpkBufferData(e,p,h);var m=this._getMaterialKeyByNodeInfo(p);r[m]||(r[m]=[]),r[m].push(p)}}}},{key:"_mergeMergeableMeshes",value:function(e,t,i,n){function r(f){var p=f;return function(){var f,m;for(m=p+d>l?l:p+d,f=p;f<m;f++)o._collectMergedGeometriesById(a[f],t,i),f===m-1&&(m!==l?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:s,loaded:(f/l*h+c+u)*s}}),requestAnimationFrame(r(f+1))):o._makeMeshNodes(e,n))}}var a=Object.keys(t);if(0===a.length)return void this._makeMeshNodes(e,n);var o=this,s=e.getLoader().maxLoadTaskCount,l=a.length,c=e.progressPercentage.load,u=e.progressPercentage.collect,h=e.progressPercentage.merge,d=Math.ceil(l/e.progressFrequency);requestAnimationFrame(r(0))}},{key:"_dealDataMergeableMeshs",value:function(e,t,i,n,r){function a(t){var v=t;return function(){var t,y;for(y=v+g>u?u:v+g,t=v;t<y;t++)o._collectMergeableMeshesByIdxId(e,d[t],i,n,l),t===y-1&&(y!==u?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:f,loaded:((t+c)/h*m+p)*f}}),requestAnimationFrame(a(t+1))):(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:f,loaded:(m+p)*f}}),o._mergeMergeableMeshes(e,l,s,r)))}}if(0===t.mergeableIdxs.length)return void this._makeMeshNodes(e,r);var o=this,s=this.mapMaterialIdToMergedNode,l={},c=t.mergedIdxs.length,u=t.mergeableIdxs.length,h=c+u,d=t.mergeableIdxs,f=e.getLoader().maxLoadTaskCount,p=e.progressPercentage.load,m=e.progressPercentage.collect,g=Math.ceil(u/e.progressFrequency);requestAnimationFrame(a(0))}},{key:"_collectDataMergedMeshesByIdxId",value:function(e,t,i,n,r){var a=t[e],o=a.IndexInfos;if(o&&0!==o.length){var s=!1;a.UV&&(a.UV.byteLength||a.UV.length)&&(s=!0),r.lightmap&&(a=this.getAttributeForLightmapWithDataMerged(a,r,e));for(var l=void 0,c=0,u=o.length;c<u;c++){var h=i[o[c].meshId];if(h&&0!==h.length){r.lightmap&&(o[c].lightmapIdx=a.lightmapIdx,o[c].positionStart=3*o[c].indexStart,o[c].positionCount=3*o[c].indexCount),l=o[c].meshId;for(var d=0,f=h.length;d<f;d++)h[d].uv=s}}if(void 0!==l){var p=i[l][0],m={},g=this._getMaterialKeyByNodeInfo(p);void 0===n[g]&&(n[g]=[]);for(var v=0,y=o.length;v<y;v++)i[o[v].meshId]&&(p=i[o[v].meshId][0],void 0===m[p.userId]&&(m[p.userId]=[]),o[v].userId=p.userId,o[v].nodeId=p.nodeId,o[v].boundingBox=p.boundingBox,m[p.userId].push(o[v]));var E=new THREE.BufferGeometry;E._visible=!0,E.setIndex(new THREE.BufferAttribute(new Uint32Array(a.I),1)),E.addAttribute("position",new THREE.BufferAttribute(new Float32Array(a.P),3)),a.N&&(a.N.byteLength||a.N.length)&&E.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(a.N),3)),s&&E.addAttribute("uv",new THREE.BufferAttribute(new Float32Array(a.UV),2)),a.UV2&&(E.addAttribute("uv2",new THREE.BufferAttribute(new Float32Array(a.UV2),2)),E.lightmapIdx=a.lightmapIdx),n[g].push({geometry:E,indices:m})}}}},{key:"getAttributeForLightmapWithDataMerged",value:function(e,t,i){var n=[],r=new Uint32Array(e.I),a=t.getLoader().getUV2ById("bmpk_"+i,r.length);if(a){var o=a.lightmapIdx;n=a.uv2}for(var s=new Float32Array(e.P),l=new Float32Array(e.N),c=new Float32Array(e.UV),u=[],h=[],d=[],f=0;f<r.length;f++){var p=r[f];u.push(s[3*p]),u.push(s[3*p+1]),u.push(s[3*p+2]),l.length>0&&(h.push(l[3*p]),h.push(l[3*p+1]),h.push(l[3*p+2])),c.length>0&&(d.push(c[2*p]),d.push(c[2*p+1])),r[f]=f}return s=null,l=null,c=null,{I:r,UV2:n,P:u,N:h,UV:d,lightmapIdx:o}}},{key:"_dealDataMergedMeshs",value:function(e,t,i,n,r){function a(t){var m=t;return function(){var t,g;for(g=m+p>c?c:m+p,t=m;t<g;t++)o._collectDataMergedMeshesByIdxId(l[t],i,n,s,e),t===g-1&&(g!==c?(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:h,loaded:(t/u*f+d)*h}}),requestAnimationFrame(a(t+1))):(e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:h,loaded:(t/u*f+d)*h}}),r&&r()))}}if(0===t.mergedIdxs.length)return void(r&&r());var o=this,s=this.mapMaterialIdToMergedNode,l=t.mergedIdxs,c=l.length,u=t.mergedIdxs.length+t.mergeableIdxs.length,h=e.getLoader().maxLoadTaskCount,d=e.progressPercentage.load,f=e.progressPercentage.collect,p=Math.ceil(c/e.progressFrequency);requestAnimationFrame(a(0))}},{key:"_makeMeshNodes",value:function(e,t){var i=e.manager,n=e.databagId,r=e._encodedDatabagId,a=this._getNodeGroup(e),o=this.mapMaterialIdToMergedNode;for(var s in o)for(var l=this.getPropertyValueByMaterialKey(s),c=o[s],u=0,h=c.length;u<h;u++){var d=c[u].geometry,f=c[u].indices,p=null;if("lines"===l.type)p=new CLOUD.LineSegmentsEx(d),p.databagId=n;else{var m={databagId:n};p=new CLOUD.MeshEx(d),p.spawn(m)}p._indicesGroup=f,a.add(p),c[u].mesh=p,i.addMeshToOctantMap(r,s,p),f=null,p=null}a.updateMatrixWorld(!0),e.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_PROGRESS,progress:{total:e.getLoader().maxLoadTaskCount,loaded:e.getLoader().maxLoadTaskCount}}),t&&t()}},{key:"createMeshNodes",value:function(e,t){if(!e.getModelDescriptor().getStandardNodeInfos())return void(t&&t());this._createGeometries(e,t)}},{key:"applySelection",value:function(e){}},{key:"clearSelection",value:function(e){}},{key:"applyHover",value:function(e){}},{key:"clearHover",value:function(e){}},{key:"getMeshNode",value:function(){return this.mapMaterialIdToMergedNode}},{key:"_disposeMergedGeometries",value:function(){for(var e in this.mapMaterialIdToMergedNode){for(var t=this.mapMaterialIdToMergedNode[e],i=0,n=t.length;i<n;i++){t[i].geometry.dispose(),delete t[i].geometry,delete t[i].indices,delete t[i].mesh}delete this.mapMaterialIdToMergedNode[e]}}},{key:"_getMaterialKeyByNodeInfo",value:function(e,t){var i=e.materialId;if(t){var n=t.manager.getOverrideMaterialByNodeInfo(e);n&&(i=n.name,e.materialId=i)}return CLOUD.Utils.getCombinedKeyString([e.materialId,e.uv?"1":"0",e.type===CLOUD.ModelView.BaseDescriptor.EnumNodeItemType.LINE?"lines":"meshes"])}},{key:"getPropertyValueByMaterialKey",value:function(e){var t=CLOUD.Utils.splitCombinedKeyString(e);return{materialId:t[0],uvProp:t[1],type:t[2]}}},{key:"clearSelectedObjectIds",value:function(){this.selectedObjectIds.length=0}},{key:"cacheSelectedObjectIds",value:function(e,t,i){this.selectedObjectIds.push({uid:e,mKey:t,idx:i})}},{key:"adjustVisibility",value:function(e,t){var i=this._getNodeGroup(e),n=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=n}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){if(t)for(var i=0,n=this.selectedMeshes.length;i<n;i++)for(var r=this.selectedMeshes[i].object,a=this.selectedMeshes[i].indices,o=0,s=a.length;o<s;o++){var l=r.geometry.groups[a[o].idx];l.start=a[o].start,l.count=a[o].count}else{this.selectedMeshes.length=0;for(var c={},i=0,n=this.selectedObjectIds.length;i<n;i++)c[this.selectedObjectIds[i].mKey+"&"+this.selectedObjectIds[i].idx]=!0;for(var u=Object.keys(c),i=0,n=u.length;i<n;i++){for(var h=u[i].split("&"),d=h[0],f=h[1],p=this.mapMaterialIdToMergedNode[d][f],r=p.mesh,m=p.geometry,a=[],g=m.groups,o=0,s=g.length;o<s;o++){var l=g[o];l.materialIndex===CLOUD.Model.EnumFilterState.SELECTED&&(a.push({idx:o,start:l.start,count:l.count}),l.start=0,l.count=0)}a.length&&this.selectedMeshes.push({object:r,indices:a})}}}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){if(t)for(var i=0,n=this.nonSelectedMeshes.length;i<n;i++){var r=this.nonSelectedMeshes[i].object,a=this.nonSelectedMeshes[i].indices;if(a)for(var o=0,s=a.length;o<s;o++){var l=r.geometry.groups[a[o].idx];l.start=a[o].start,l.count=a[o].count}else r.visible=this.nonSelectedMeshes[i].visibility}else{this.nonSelectedMeshes.length=0;for(var c={},i=0,n=this.selectedObjectIds.length;i<n;i++){var u=this.selectedObjectIds[i];c[u.mKey]||(c[u.mKey]={}),c[u.mKey][u.idx]=!0}for(var h in this.mapMaterialIdToMergedNode){var d=this.mapMaterialIdToMergedNode[h];if(c[h])for(var o=0,s=d.length;o<s;o++){var r=d[o].mesh;if(c[h][o]){for(var a=[],f=r.geometry.groups,i=0,n=f.length;i<n;i++){var l=f[i];l.materialIndex!==CLOUD.Model.EnumFilterState.SELECTED&&(a.push({idx:i,start:l.start,count:l.count}),l.start=0,l.count=0)}a.length?this.nonSelectedMeshes.push({object:r,indices:a}):(this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1)}else this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1}else for(var i=0,n=d.length;i<n;i++){var r=d[i].mesh;this.nonSelectedMeshes.push({object:r,indices:null,visibility:r.visible}),r.visible=!1}}}}},{key:"restoreVisibilityOfObjects",value:function(){this.selectedMeshes.length=0,this.nonSelectedMeshes.length=0}},{key:"getBlinkMaterials",value:function(){return this.blinkMaterials}},{key:"disposeBufferAfterVbo",value:function(){if(!this.bufferDestroyed){var e=0;for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],n=0,r=i.length;n<r;n++){var a=i[n],o=a.geometry;if(null!==o){e++;var s=t+"-"+n;this.mapDestroyedBufferKey[s]||a.mesh.visible&&(this.mapDestroyedBufferKey[s]=!0,CLOUD.GeomUtil.disposeBufferFromGeometry(o,["normal","uv","uv2"]))}}Object.keys(this.mapDestroyedBufferKey).length===e&&(this.mapDestroyedBufferKey={},this.bufferDestroyed=!0)}}},{key:"_traverseMeshNodeMap",value:function(e){for(var t in this.mapMaterialIdToMergedNode)for(var i=this.mapMaterialIdToMergedNode[t],n=0,r=i.length;n<r;n++)e&&e(t,i[n])}},{key:"getGeometryBuffersByUserId",value:function(e,t){var i=[],n=e.getDatabagId();return this._traverseMeshNodeMap(function(e,r){var a=r.indices[t];if(a)for(var o=r.geometry,s=o.getIndex().array,l=o.getAttribute("position").array,c=0,u=a.length;c<u;c++){var h=a[c],d=h.indexStart,f=h.indexStart+h.indexCount,p=s.slice(d,f);d=h.positionStart,f=h.positionStart+h.positionCount;var m=l.slice(d,f);d/=3,p.forEach(function(e,t,i){i[t]-=d}),i.push({databagId:n,nodeId:h.nodeId,position:m,index:p})}}),i}}]),t}(CLOUD.MeshManager);CLOUD.BatchedMeshManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.generated=!1,this.wireframeLineSegment=null,this.wireframeGeometryMap=null}return _createClass(e,[{key:"destroy",value:function(){this.clearData(),this.manager=null}},{key:"clearData",value:function(){this.generated=!1,this.bufferDestroyed=!1,this.wireframeLineSegment&&(this.wireframeLineSegment._indicesGroup=null,this.wireframeLineSegment=null),this.wireframeGeometryMap=null}},{key:"_createWireframeGeometry",value:function(e,t){if(this.wireframeGeometryMap||(this.wireframeGeometryMap={}),!this.wireframeGeometryMap[t.nodeId]){for(var i=e.attributes.position.array.slice(t.positionStart,t.positionStart+t.positionCount),n=e.getIndex().array.slice(t.indexStart,t.indexStart+t.indexCount),r=0,a=n.length;r<a;r++)n[r]-=t.positionStart/3;var o=CLOUD.BuildEdge(i,n),s=new THREE.BufferGeometry;s.setIndex(new THREE.Uint32BufferAttribute(o,1)),s.addAttribute("position",new THREE.BufferAttribute(Float32Array.from(i),3)),s._userId=t.userId,this.wireframeGeometryMap[t.nodeId]=s}}},{key:"_createWireframeGeometries",value:function(e){var t=e.manager.filter,i=e.getModelDescriptor().getStandardNodeInfos(),n=this.manager.getMeshNode();for(var r in n){if("meshes"===this.manager.getPropertyValueByMaterialKey(r).type)for(var a=n[r],o=0,s=a.length;o<s;o++){var l=a[o],c=l.geometry;if(null!==c){var u=l.indices;for(var h in u)if(function(e){var n=i[e];return!(n&&t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(n[0]))}(h))for(var d=u[h],f=0,p=d.length;f<p;f++)this._createWireframeGeometry(c,d[f])}}}return!0}},{key:"_makeWireframe",value:function(e){var t={},i=e.getWireframeMaterial();for(var n in this.wireframeGeometryMap){var r=this.wireframeGeometryMap[n],a=r._userId,o=new THREE.LineSegments(r,i);o.name=a,o.nodeId=a,t[a]||(t[a]=[]),t[a].push(o),o=null}var s=[];for(var a in t)for(var l=t[a],c=0,u=l.length;c<u;c++)s.push(l[c]);if(s.length>0){var h={},d=CLOUD.GeomUtil.mergeBufferGeometries(s,h);d&&(this.wireframeLineSegment=new THREE.LineSegments(d,e.getWireframeMaterial()),this.wireframeLineSegment._indicesGroup=h)}s=null;for(var a in t)delete t[a];t=null,this.wireframeGeometryMap=null}},{key:"generateWireframe",value:function(e,t){this.generated||(this._createWireframeGeometries(e),this._makeWireframe(e),this.generated=!0,t&&t())}},{key:"update",value:function(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegment){var t=this._getNodeGroup(e);t.clear(),t.add(this.wireframeLineSegment),t.updateMatrixWorld(!0)}}else e._hasNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)}},{key:"rebuildIndices",value:function(e){if(this.needDealWireframeLine(e)){this.wireframeLineSegment.visible=!0;var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;i.clearGroups(),this.wireframeLineSegment.material=e.getWireframeMaterial();var n=this.manager.getHiddenUserIds();if(n&&0!==Object.keys(n).length){var r=[];for(var a in t)if(!n[a]){var o=t[a];if(o&&o.length>0)for(var s=0,l=o.length;s<l;s++)r.push({indexStart:o[s].indexStart,indexCount:o[s].indexCount})}if(0===r.length)return void(this.wireframeLineSegment.visible=!1);for(r.sort(function(e,t){return e.indexStart-t.indexStart}),s=0,l=r.length;s<l;s++){var c=r[s].indexStart,u=r[s].indexCount;if(0===s)i.addGroup(c,u,0);else{c===r[s-1].indexStart+r[s-1].indexCount?i.groups[i.groups.length-1].count+=u:i.addGroup(c,u,0)}}this.wireframeLineSegment.material=[e.getWireframeMaterial()]}}}},{key:"explode",value:function(e){if(this.wireframeLineSegment){var t=this.wireframeLineSegment._indicesGroup,i=this.wireframeLineSegment.geometry;for(var n in t){var r=t[n];if(r)for(var a=e.manager.getExplosionTranslation(n),o=0,s=r.length;o<s;o++){var l=r[o].indexStart,c=l+r[o].indexCount;!function(e,t,i,n){for(var r=e.getAttribute("position").array,a=e.getIndex().array,o={},s=t;s<i;s++){var l=a[s];o[l]||(r[3*l]+=n.x,r[3*l+1]+=n.y,r[3*l+2]+=n.z,o[l]=!0)}e.getAttribute("position").needsUpdate=!0,o=null}(i,l,c,a)}}}}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0})}},{key:"needDealWireframeLine",value:function(e){return!(!e.isActivateWireframe()||!this.wireframeLineSegment)}},{key:"adjustVisibility",value:function(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),n=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=n}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&this.wireframeLineSegment.visible&&(this.bufferDestroyed=!0,CLOUD.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["normal","uv","uv2"]))}}]),e}();CLOUD.BatchedWireframeManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.generated=!1,this.wireframeLineSegments=[]}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this.wireframeLineSegments=null}},{key:"clearData",value:function(){this.generated=!1,this.wireframeLineSegments=[]}},{key:"_needWireframing",value:function(e,t){var i=e.manager.filter,n=e.getModelDescriptor().getStandardNodeInfos();return!(!n||!n[t.userId])&&!(i._hasRenderWithBoardlineFilter()&&!i._isRenderWithBoardline(t))}},{key:"_dealSharedBorderLines",value:function(e){var t=e.getModelDescriptor().getSharedBorderLineCache();if(t){for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),n={},r=e.getWireframeMaterial(),a=0,o=t.length;a<o;a++)for(var s=t[a],l=s.IndexInfos,c=0,u=l.length;c<u;c++){var h=l[c],d=e.getModelDescriptor().convertGeometryId(h.meshId),f=i[d];if(f)for(var p=new Uint32Array(s.I),m=new Float32Array(s.P),g=0,v=f.length;g<v;g++){var y=f[g];if(this._needWireframing(e,y)){var E=m.slice(h.positionStart,h.positionStart+h.positionCount),x=h.positionStart/3,b=p.slice(h.indexStart,h.indexStart+h.indexCount);b.forEach(function(e,t,i){i[t]-=x}),CLOUD.GeomUtil.applyMatrix4ToBuffer(y.matrix,E);var C=new THREE.BufferGeometry;C.setIndex(new THREE.Uint32BufferAttribute(b,1)),C.addAttribute("position",new THREE.BufferAttribute(E,3));var M=new THREE.LineSegments(C,r);M.name=y.userId,M.nodeId=y.userId,n[y.userId]||(n[y.userId]=[]),n[y.userId].push(M)}}}var _=[];for(var w in n)for(var L=n[w],c=0,T=L.length;c<T;c++)_.push(L[c]);if(_.length>0){var I={},S=CLOUD.GeomUtil.mergeBufferGeometries(_,I);if(S){var O=new THREE.LineSegments(S,r);O._indicesGroup=I,this.wireframeLineSegments.push(O)}}}}},{key:"_dealUniqueBorderLines",value:function(e){var t=e.getModelDescriptor().getUniqueBorderLineCache();if(t)for(var i=e.getModelDescriptor().getNodeInfosOnGeometryId(),n={},r=0,a=t.length;r<a;r++){for(var o=t[r],s=o.IndexInfos,l=0,c=s.length;l<c;l++){var u=s[l],h=e.getModelDescriptor().convertGeometryId(u.meshId),d=i[h];if(d)for(var f=0,p=d.length;f<p;f++){var m=d[f];n[m.userId]||(n[m.userId]=[]);var g,v;this._needWireframing(e,m)?(g=u.indexStart,v=u.indexCount):(g=-1,v=0),n[m.userId].push({nodeId:m.nodeId,indexStart:g,indexCount:v})}}var y=new THREE.BufferGeometry;y.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(o.I),1)),y.addAttribute("position",new THREE.BufferAttribute(new Float32Array(o.P),3));var E=new THREE.LineSegments(y,e.getWireframeMaterial());E._indicesGroup=n,this.wireframeLineSegments.push(E)}}},{key:"_createWireframeGeometries",value:function(e){this._dealUniqueBorderLines(e),this._dealSharedBorderLines(e)}},{key:"generateWireframe",value:function(e,t){e.isActivateWireframe()&&(this.generated||(this._createWireframeGeometries(e),this.generated=!0))}},{key:"_asyncDealSharedBorderLines",value:function(e,t){var i=e.getModelDescriptor().getSharedBorderLineCache();if(!i)return void(t&&t());for(var n=e.getModelDescriptor().getNodeInfosOnGeometryId(),r={},a=e.getWireframeMaterial(),o=i.length,s=0,l=this,c=0;c<o;c++){var u=i[c];CLOUD.Utils.asyncProcess(u,u.IndexInfos.length,10,function(t,i){var o=t,s=o.IndexInfos[i],c=e.getModelDescriptor().convertGeometryId(s.meshId),u=n[c];if(u)for(var h=new Uint32Array(o.I),d=new Float32Array(o.P),f=0,p=u.length;f<p;f++){var m=u[f];if(l._needWireframing(e,m)){var g=d.slice(s.positionStart,s.positionStart+s.positionCount),v=s.positionStart/3,y=h.slice(s.indexStart,s.indexStart+s.indexCount);y.forEach(function(e,t,i){i[t]-=v}),CLOUD.GeomUtil.applyMatrix4ToBuffer(m.matrix,g);var E=new THREE.BufferGeometry;E.setIndex(new THREE.Uint32BufferAttribute(y,1)),E.addAttribute("position",new THREE.BufferAttribute(g,3));var x=new THREE.LineSegments(E,a);x.name=m.userId,x.nodeId=m.userId,r[m.userId]||(r[m.userId]=[]),r[m.userId].push(x)}}},function(){if(++s===o){var e=[];for(var i in r)for(var n=r[i],c=0,u=n.length;c<u;c++)e.push(n[c]);if(e.length>0){var h={},d=CLOUD.GeomUtil.mergeBufferGeometries(e,h);if(d){var f=new THREE.LineSegments(d,a);f._indicesGroup=h,l.wireframeLineSegments.push(f)}}t&&t()}})}}},{key:"_asyncDealUniqueBorderLines",value:function(e,t){var i=e.getModelDescriptor().getUniqueBorderLineCache();if(!i)return void(t&&t());for(var n=e.getModelDescriptor().getNodeInfosOnGeometryId(),r={},a=this,o=0,s=i.length,l=0;l<s;l++){var c=i[l];CLOUD.Utils.asyncProcess(c,c.IndexInfos.length,10,function(t,i){var o=t,s=o.IndexInfos[i],l=e.getModelDescriptor().convertGeometryId(s.meshId),c=n[l];if(c)for(var u=0,h=c.length;u<h;u++){var d=c[u];r[d.userId]||(r[d.userId]=[]);var f,p;a._needWireframing(e,d)?(f=s.indexStart,p=s.indexCount):(f=-1,p=0),r[d.userId].push({nodeId:d.nodeId,indexStart:f,indexCount:p})}},function(i){o++;var n=i,l=new THREE.BufferGeometry;l.setIndex(new THREE.Uint32BufferAttribute(new Uint32Array(n.I),1)),l.addAttribute("position",new THREE.BufferAttribute(new Float32Array(n.P),3));var c=new THREE.LineSegments(l,e.getWireframeMaterial());c._indicesGroup=r,a.wireframeLineSegments.push(c),o===s&&t&&t()})}}},{key:"_asyncCreateWireframeGeometries",value:function(e,t){var i=this;this._asyncDealUniqueBorderLines(e,function(){i._asyncDealSharedBorderLines(e,function(){t&&t()})})}},{key:"asyncGenerateWireframe",value:function(e,t){e.isActivateWireframe()&&(this.generated||(this._asyncCreateWireframeGeometries(e,t),this.generated=!0))}},{key:"update",value:function(e){if(this.manager.hasNodeInfo(e))if(e.isActivateWireframe()){if(this.wireframeLineSegments.length){var t=this._getNodeGroup(e);t.clear()
;for(var i=0,n=this.wireframeLineSegments.length;i<n;i++)t.add(this.wireframeLineSegments[i]);t.updateMatrixWorld(!0)}}else e._hasNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)&&e._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME)}},{key:"rebuildIndicesForLineSegment",value:function(e,t){t.visible=!0;var i=t._indicesGroup,n=t.geometry;n.clearGroups(),t.material=e.getWireframeMaterial();var r=this.manager.getHiddenUserIds(),a=[];for(var o in i)if(!r||!r[o]){var s=i[o];if(s&&s.length>0)for(var l=0,c=s.length;l<c;l++)a.push({indexStart:s[l].indexStart,indexCount:s[l].indexCount})}if(0===a.length)return void(t.visible=!1);for(a.sort(function(e,t){return e.indexStart-t.indexStart}),l=0,c=a.length;l<c;l++){var u=a[l].indexStart,h=a[l].indexCount;if(0===l)n.addGroup(u,h,0);else{u===a[l-1].indexStart+a[l-1].indexCount?n.groups[n.groups.length-1].count+=h:n.addGroup(u,h,0)}}t.material=[e.getWireframeMaterial()]}},{key:"rebuildIndices",value:function(e){if(this.needDealWireframeLine(e))for(var t=0,i=this.wireframeLineSegments.length;t<i;t++)this.rebuildIndicesForLineSegment(e,this.wireframeLineSegments[t])}},{key:"_getNodeGroup",value:function(e){return e._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0})}},{key:"needDealWireframeLine",value:function(e){return!!(e.isActivateWireframe()&&this.wireframeLineSegments&&this.wireframeLineSegments.length)}},{key:"adjustVisibility",value:function(e,t){if(this.needDealWireframeLine(e)){var i=this._getNodeGroup(e),n=i.visible;t&&!i.bVisible||(i.visible=t),i.bVisible=n}}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.adjustVisibility(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){}},{key:"disposeBufferAfterVbo",value:function(){this.generated&&!this.bufferDestroyed&&this.wireframeLineSegment&&(this.bufferDestroyed=!0,CLOUD.GeomUtil.disposeBufferFromGeometry(this.wireframeLineSegment.geometry,["position","normal","uv","uv2"]))}},{key:"explode",value:function(e){for(var t=0,i=this.wireframeLineSegments.length;t<i;t++){var n=this.wireframeLineSegments[t],r=n._indicesGroup,a=n.geometry;for(var o in r){var s=r[o];if(s)for(var l=e.manager.getExplosionTranslation(o),c=0,u=s.length;c<u;c++){var h=s[c].indexStart,d=h+s[c].indexCount;!function(e,t,i,n){for(var r=e.getAttribute("position").array,a=e.getIndex().array,o={},s=t;s<i;s++){var l=a[s];o[l]||(r[3*l]+=n.x,r[3*l+1]+=n.y,r[3*l+2]+=n.z,o[l]=!0)}e.getAttribute("position").needsUpdate=!0,o=null}(a,h,d,l)}}}}}]),e}();CLOUD.DataMergedWireframeManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.meshManager=new CLOUD.BatchedMeshManager(this),this.wireframeManager=t?new CLOUD.DataMergedWireframeManager(this):new CLOUD.BatchedWireframeManager(this)}return _createClass(e,[{key:"destroy",value:function(){this.meshManager.destroy(),this.meshManager=null,this.wireframeManager.destroy(),this.wireframeManager=null,this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"updateNodes",value:function(e){this.meshManager.update(e),this.wireframeManager.update(e)}},{key:"generateWireframe",value:function(e,t){this.wireframeManager.generateWireframe(e,t)}},{key:"asyncGenerateWireframe",value:function(e,t){this.wireframeManager.asyncGenerateWireframe(e,t)}},{key:"rebuildIndices",value:function(e){this._rebuildIndices(e)}},{key:"clearData",value:function(){this.meshManager.clearData(),this.wireframeManager.clearData(),this._clearFilteredState(),this._clearSelectedState(),this._clearHoveredState(),this._clearBlinkedState()}},{key:"createMeshNodes",value:function(e,t){this.meshManager.createMeshNodes(e,t)}},{key:"asyncCreateMeshNodes",value:function(e,t,i){this.meshManager.asyncCreateMeshNodes(e,t,i)}},{key:"hasNodeInfo",value:function(e){return!!e.getModelDescriptor().getStandardNodeInfos()}},{key:"disposeGeometry",value:function(e){this.meshManager.disposeGeometry(e)}},{key:"getMeshNode",value:function(){return this.meshManager.getMeshNode()}},{key:"getPropertyValueByMaterialKey",value:function(e){return this.meshManager.getPropertyValueByMaterialKey(e)}},{key:"getFilteredUserIds",value:function(){return this.mapMaterialIdToUserIdsForFilter}},{key:"getSelectedUserIds",value:function(){return this.mapMaterialIdToUserIdsForSelection}},{key:"getHoveredUserIds",value:function(){return this.mapMaterialIdToUserIdsForHover}},{key:"getBlinkedUserIds",value:function(){return this.mapBlinkUserIds}},{key:"getHiddenUserIds",value:function(){return this.hiddenUserIdSetObject}},{key:"applyFilter",value:function(e,t){if(this.hasNodeInfo(e)){var i;i=t||e.getModelDescriptor().getStandardUserIds();var n=e.getModelDescriptor().getStandardNodeInfos();this._collectFilteredUserIds(e,i,n),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,n),this._collectHoveredUserIds(e.manager.sceneState.hoverId,n),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"applySelection",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearSelectedState(e),this._clearHoveredState(e),this._collectSelectedUserIds(e.manager.sceneState.selectionSet,t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearSelection",value:function(e){this._clearSelectedState(e),this.applyHover(e)}},{key:"applyHover",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearHoveredState(e),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearHover",value:function(e){this._clearHoveredState(e),this._rebuildIndices(e),this.updateNodes(e)}},{key:"applyBlink",value:function(e){if(this.hasNodeInfo(e)){var t=e.getModelDescriptor().getStandardNodeInfos();this._clearBlinkedState(e),this._clearHoveredState(e),this._collectBlinkedUserIds(e.manager.sceneState.getBlinkComponentsIdMap(),t),this._collectHoveredUserIds(e.manager.sceneState.hoverId,t),this._rebuildIndices(e),this.updateNodes(e)}}},{key:"clearBlink",value:function(e){this._clearBlinkedState(e),this.applyHover(e)}},{key:"applyReplacement",value:function(e){this._rebuildIndices(e),this.updateNodes(e)}},{key:"_collectFilteredUserIds",value:function(e,t,i){var n=e.manager.filter,r=n._hasHiddenFileIdFilter(),a=n._hasVisibleFilter(),o=n._hasOverrideMaterialFilter(),s=n._hasTransparentFilter(),l=e.hasReplacedUserId(),c=e.hasHiddenUserId(),u=this.mapMaterialIdToUserIdsForFilter={};if(this.hiddenUserIdSetObject={},this.overrideUserIdSetObject={},this.transparentUserIdSetObject={},r||a||o||s||l||c)for(var h=0;h<t.length;++h){var d=t[h],f=i[d];if(f&&f.length)for(var p=0,m=f.length;p<m;p++){var g=f[p];if(r&&n._isHiddenFileId(g)||a&&!1===n._isVisible(g)||e.isReplacedUserId(d)||e.isHiddenUserId(d))void 0===u[g.materialId]&&(u[g.materialId]={}),void 0===u[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]&&(u[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN]={}),u[g.materialId][CLOUD.Model.EnumFilterState.HIDDEN][d]=!0,this.hiddenUserIdSetObject[d]=!0;else if(s&&n._isTransparent(g))void 0===u[g.materialId]&&(u[g.materialId]={}),void 0===u[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]&&(u[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT]={}),u[g.materialId][CLOUD.Model.EnumFilterState.TRANSPARENT][d]=!0,this.transparentUserIdSetObject[d]=!0;else if(o&&n._hasOverrideMaterial(g)){var v=n._getOverrideMaterial(g),y=null!=v?v.name:"";""!==y&&(void 0===u[g.materialId]&&(u[g.materialId]={}),void 0===u[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]&&(u[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED]={}),u[g.materialId][CLOUD.Model.EnumFilterState.OVERRIDED][d]=y,this.overrideUserIdSetObject[d]=y)}else;}}}},{key:"_clearFilteredState",value:function(){this.mapMaterialIdToUserIdsForFilter=null}},{key:"_collectSelectedUserIds",value:function(e,t){var i=this.mapMaterialIdToUserIdsForSelection={};for(var n in e){var r=t[n];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===i[r[a].materialId]&&(i[r[a].materialId]={}),void 0===i[r[a].materialId][n]&&(i[r[a].materialId][n]=!0)}}},{key:"_clearSelectedState",value:function(){this.mapMaterialIdToUserIdsForSelection&&(this.mapMaterialIdToUserIdsForSelection=null)}},{key:"_collectHoveredUserIds",value:function(e,t){var i=this.mapMaterialIdToUserIdsForHover={};if(e&&t[e])for(var n=t[e],r=0,a=n.length;r<a;r++)void 0===i[n[r].materialId]&&(i[n[r].materialId]={}),void 0===i[n[r].materialId][e]&&(i[n[r].materialId][e]=!0)}},{key:"_clearHoveredState",value:function(){this.mapMaterialIdToUserIdsForHover&&(this.mapMaterialIdToUserIdsForHover=null)}},{key:"_collectBlinkedUserIds",value:function(e,t){var i=this.mapBlinkUserIds={};for(var n in e){var r=t[n];if(r&&r.length)for(var a=0,o=r.length;a<o;a++)void 0===i[r[a].materialId]&&(i[r[a].materialId]={}),void 0===i[r[a].materialId][n]&&(i[r[a].materialId][n]=!0)}}},{key:"_clearBlinkedState",value:function(){this.mapBlinkUserIds&&(this.mapBlinkUserIds=null)}},{key:"_rebuildIndices",value:function(e){this.meshManager.rebuildIndices(e),this.wireframeManager.rebuildIndices(e)}},{key:"clearCachedData",value:function(){this.meshManager.clearAllNodeBuffer()}},{key:"getMeshesByUserIds",value:function(e,t,i){this.meshManager.getMeshesByUserIds(e,t,i)}},{key:"adjustVisibility",value:function(e,t){this.meshManager.adjustVisibility(e,t),this.wireframeManager.adjustVisibility(e,t)}},{key:"changeVisibilityOfSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfSelectedObjects(e,t)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e,t){this.meshManager.changeVisibilityOfNonSelectedObjects(e,t),this.wireframeManager.changeVisibilityOfNonSelectedObjects(e,t)}},{key:"restoreVisibilityOfObjects",value:function(){this.meshManager.restoreVisibilityOfObjects(),this.wireframeManager.restoreVisibilityOfObjects()}},{key:"disposeBufferAfterVbo",value:function(){this.meshManager.disposeBufferAfterVbo(),this.wireframeManager.disposeBufferAfterVbo()}},{key:"getGeometryBuffersByUserId",value:function(e,t){return this.meshManager.getGeometryBuffersByUserId(e,t)}},{key:"explode",value:function(e){this.meshManager.explode(e),this.wireframeManager.explode(e)}}]),e}();CLOUD.BatchedManager=e}(),function(){var e=function(){function e(t,i,n,r,a){_classCallCheck(this,e),this.manager=t,this.databagId=i.databagId,this._encodedDatabagId=CLOUD.md5&&"function"==typeof CLOUD.md5?CLOUD.md5(this.databagId):this.databagId,this.debut=a,this.dataUrl=new CLOUD.Loader.Url(i),this.fileLoader=new THREE.FileLoader(new THREE.LoadingManager),this.configLoader=new CLOUD.ModelView.ConfigLoader(this),this.pool=t.getObjectPool(),this.firstOctreeTransform=!0,this.selectedMaterial=this.manager.sceneState.selectionMaterial,this.materialManager=new CLOUD.MaterialManager,this.wireframeManager=new CLOUD.WireframeManager,this.containsCamera=!1,this.loaded=!1,this.visible=!0,this.emptyScene=!1,this.cameraList=[],this.index=n,this.parseCfgFinish=r,this.progressPercentage={load:.4,collect:.5,merge:.1},this.progressFrequency=10,this._rootNodeGroupName=CLOUD.ObjectGroupType.MODEL+"|"+this._encodedDatabagId,this._rootNodeGroup=this.manager.scene.getOrCreateObjectGroup(this._rootNodeGroupName,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0}),this._handler=null,this.lightmap=!1,this.lightmapNum=0,this.enableLightmap=!1,this.lightmapIntensity=CLOUD.GlobalData.LightmapIntensity,this.minDistanceObjects={},this.prioritizedNodeCount=0,this.plugins=[]}return _createClass(e,[{key:"destroy",value:function(){this.selectedMaterial=null,this.cameraList=null,this.occlusionCamera&&(this.occlusionCamera=null),this._removeMeshNodeGroup(),this.removeAllFromOctantMap(),this._handler&&(this._handler.destroy(),this._handler=null),this.wireframeManager.destroy(),this.wireframeManager=null,this.materialManager.disposeMaterials(this),this.materialManager.destroy(),this.materialManager=null,this.pool=null,this.manager=null,this.plugins=null,this.dataUrl=null,this.fileLoader=null,this.configLoader.destroy(),this.configLoader=null}},{key:"_getWireframeGroupName",value:function(){return CLOUD.ObjectGroupType.WIREFRAME+"|"+this._encodedDatabagId}},{key:"load",value:function(e){var t=this;this.configLoader.load(function(){t.parseCfgFinish&&t.parseCfgFinish(),t.manager.updateScene(),t._getHandler().load(e)})}},{key:"setCrossOrigin",value:function(e){this.fileLoader.setCrossOrigin(e)}},{key:"prepare",value:function(e,t){var i=this._getHandler();i&&i.prepare(e,t)}},{key:"dispatchEvent",value:function(e){this.manager.dispatchEvent(e)}},{key:"setLoaded",value:function(e){this.loaded=e}},{key:"isLoaded",value:function(){return!!this._handler&&this.loaded}},{key:"isEmptyScene",value:function(){return this.emptyScene}},{key:"setEmptyScene",value:function(e){this.emptyScene=e}},{key:"isLayerData",value:function(){return!(!this._handler||"layer"!==this._handler.tag)}},{key:"isVisible",value:function(){return this.visible}},{key:"setVisible",value:function(e){this.visible=e}},{key:"calculateCameraModelRelation",value:function(e){this.containsCamera=this.getModelDescriptor().isOctreeOuter(e)}},{key:"addCamera",value:function(e){this.cameraList.push(e)}},{key:"getCameraNameList",value:function(){for(var e=[],t=this.cameraList.length-1;t>=0;t--)e.push(this.cameraList[t].name);return e}},{key:"getCamera",value:function(e){for(var t=this.cameraList.length-1;t>=0;t--)if(this.cameraList[t].name===e)return this.cameraList[t];return null}},{key:"updateOctreeNode",value:function(e){if(e||this.firstOctreeTransform){this.firstOctreeTransform&&(this.firstOctreeTransform=!1);var t=this.manager.scene.getMatrixGlobal();this.getModelDescriptor().updateOctreeNode(t)}}},{key:"isDataReady",value:function(){var e=this._handler;return!!e&&e.isDataReady()}},{key:"updateMeshNodes",value:function(){var e=this._getHandler();e&&e.updateNodes()}},{key:"_getHandler",value:function(){return this._handler}},{key:"getMeshesByUserIds",value:function(e,t){if(e&&t){this.minDistanceObjects[e]=[],this.minDistanceObjects[t]=[];var i=this._getHandler();i&&i.getMeshesByUserIds(e,t)}}},{key:"applyFilter",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyFilter();var i=this._getHandler();i&&i.applyFilter()}},{key:"applySelection",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applySelection();var i=this._getHandler();if(i)return void i.applySelection()}},{key:"clearSelection",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearSelection();var i=this._getHandler();if(i)return void i.clearSelection()}},{key:"applyHover",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].applyHover();var i=this._getHandler();i&&i.applyHover()}},{key:"clearHover",value:function(){for(var e=0,t=this.plugins.length;e<t;e++)this.plugins[e].clearHover();var i=this._getHandler();i&&i.clearHover()}},{key:"applyBlink",value:function(){var e=this._getHandler();e&&e.applyBlink()}},{key:"clearBlink",value:function(){var e=this._getHandler();e&&e.clearBlink()}},{key:"applyReplacement",value:function(){var e=this._getHandler();e&&e.applyReplacement()}},{key:"_removeMeshNodeGroup",value:function(){this._removeNodeGroup(CLOUD.ObjectGroupType.GEOMETRY),this._removeNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY),this._removeNodeGroup(CLOUD.ObjectGroupType.WIREFRAME),this._removeNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY),this._removeSceneGroup(),this._rootNodeGroup=null}},{key:"_getNodeGroup",value:function(e,t){for(var i=this._rootNodeGroup.children,n=0,r=i.length;n<r;n++)if(i[n].name==e)return i[n];var a=new CLOUD.ObjectGroup(e,t);return this._rootNodeGroup.add(a),a.globalSpace&&(a.matrixAutoUpdate=!1,a.updateMatrixWorld(!0)),a}},{key:"_removeNodeGroup",value:function(e){this._rootNodeGroup.removeByName(e)}},{key:"_hasNodeGroup",value:function(e){return this._rootNodeGroup.hasChild(e)}},{key:"_removeSceneGroup",value:function(){this.manager.scene.removeObjectGroupByName(this._rootNodeGroupName),this.manager.scene.removeObjectGroupByName(this._getWireframeGroupName())}},{key:"removeAllFromOctantMap",value:function(){this.manager.removeAllFromOctantMap(this._encodedDatabagId)}},{key:"clearMeshFromOctantMap",value:function(){this.manager.clearMeshFromOctantMap(this._encodedDatabagId)}},{key:"getDatabagId",value:function(){return this.databagId}},{key:"getEncodedDatabagId",value:function(){return this._encodedDatabagId}},{key:"getMaterialManager",value:function(){return this.materialManager}},{key:"clearWireframeElementCount",value:function(){this.wireframeElementCount=void 0}},{key:"getWireframeElementCount",value:function(){if(void 0!==this.wireframeElementCount)return this.wireframeElementCount;var e=this.getModelDescriptor().getAllNodeInfos(),t=this.manager.filter,i=0;for(var n in e){var r=e[n];t._hasRenderWithBoardlineFilter()&&!t._isRenderWithBoardline(r[0])||(i+=r.length)}return this.wireframeElementCount=i,i}},{key:"isActivateWireframe",value:function(){return this.manager.isDrawingBoardlineEnabled()}},{key:"isOnlyWireframe",value:function(){return this.manager.isOnlyWireframe()}},{key:"getLoadedUserIdsObject",value:function(){return this._handler&&this._handler.getLoadedUserIdsObject?this._handler.getLoadedUserIdsObject():null}},{key:"clearNodeGroup",value:function(){var e=this._getNodeGroup(CLOUD.ObjectGroupType.GEOMETRY,{globalSpace:!0});e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.WIREFRAME,{globalSpace:!0}),e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0}),e.clear(),e=this._getNodeGroup(CLOUD.ObjectGroupType.INSTANCEWIREFRAMEGEOMETRY,{globalSpace:!0}),e.clear()}},{key:"getWireframeMaterial",value:function(){return this.wireframeManager.wireframeMaterial}},{key:"getInstanceWireframeMaterial",value:function(){return this.wireframeManager.instanceWireframeMaterial}},{key:"getMaterialByMaterialId",value:function(e){return this.materialManager.materials[e]}},{key:"adjustProgressPercentage",value:function(e,t,i){this.progressPercentage.load=e,this.progressPercentage.collect=t,this.progressPercentage.merge=i}},{key:"setReplacedUserIdMap",value:function(e){CLOUD.Utils.isOwnEmptyObject(e)?this.replacedUserIdMap=null:this.replacedUserIdMap=e}},{key:"hasReplacedUserId",value:function(){return!CLOUD.Utils.isEmptyObject(this.replacedUserIdMap)}},{key:"isReplacedUserId",value:function(e){return this.replacedUserIdMap&&this.replacedUserIdMap[e]}},{key:"registerPlugin",value:function(e){this.plugins.push(e)}},{key:"disposeBufferAfterVbo",value:function(){var e=this._getHandler();e&&e.disposeBufferAfterVbo()}},{key:"isHiddenUserId",value:function(e){return this.manager.isHiddenUserId(e)}},{key:"hasHiddenUserId",value:function(){return this.manager.hasHiddenUserId()}},{key:"getModelDescriptor",value:function(){return this._handler.loader.getDescriptor()}},{key:"getLoader",value:function(){return this._handler.loader}},{key:"getConfig",value:function(){return this.configLoader.getConfig()}},{key:"getTransforms",value:function(){return this.configLoader.getTransforms()}},{key:"getStatistics",value:function(){return this.configLoader.getStatistics()}},{key:"setRenderableCount",value:function(e){this.configLoader.setRenderableCount(e),this._handler&&this._handler.clearPriorityNodesSet&&this._handler.clearPriorityNodesSet(!0)}},{key:"getRenderableCount",value:function(){return this.configLoader.getStatistics().renderableCount}},{key:"getBoundingBoxWorld",value:function(){return this.configLoader.getTransforms().boundingBox}},{key:"explode",value:function(){var e=this._getHandler();e&&e.explode()}}]),e}();e.EnumFilterState={CLIPPING:-2,HIDDEN:-1,NONE:0,SELECTED:1,BLINK:2,HOVER:3,TRANSPARENT:4,OVERRIDED:5},CLOUD.Model=e}(),function(){var e=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return CLOUD.GlobalData.IsMobile&&(CLOUD.GlobalData.maxObjectNumInPool=6e3,CLOUD.GlobalData.maxDrawCacheNum=4e3),i.scene=new CLOUD.Scene,i.filter=e,i.crossOrigin=!0,i.models={},i.materialPool=null,i.occlusionCamera=null,i.containsCamera=!1,i.highPriorityCategories={inner:{},outer:{}},i.octantToObjectMap={},i.sceneState=new CLOUD.SceneStateHelper(i),i.filter.setSceneStateHelper(i.sceneState),i.rotation=new THREE.Quaternion,i.boundingBox=new THREE.Box3,i.IBLMaterial=!1,i.clippingCaps=!1,i.blinkStartTime=null,i.blinkEnabled=!1,i.blinkIntervalTime=600,i.blinkPermited=!1,i.defaultBlinkColor=(new THREE.Color).setHex(3330982),i.defaultBlinkAlpha=1,i.blinkColor=new THREE.Vector4(i.defaultBlinkColor.r,i.defaultBlinkColor.g,i.defaultBlinkColor.b,i.defaultBlinkAlpha),i.selectPriority=!0,i.materialOverrideSet=null,i.plugins=[],i._renderStateChanged=!1,i.explosionExtent=0,i.explosionTranslation={},i.floorInfos=void 0,i.totalHeight=void 0,i.floorExplosionExtent=0,i.floorExplosionList=[],i}return _inherits(t,e),_createClass(t,[{key:"destroy",value:function(){for(var e in this.models)this.models[e].destroy();this.models=null,this.octantToObjectMap=null,this.materialPool&&(this.materialPool.destroy(),this.materialPool=null),this.occlusionCamera&&(this.occlusionCamera=null);for(var t=0,i=this.plugins.length;t<i;t++)this.plugins[t].destroy();this.plugins=null,this.loadOnDemandDirector&&(this.loadOnDemandDirector.destroy(),this.loadOnDemandDirector=null),this.highPriorityCategories=null,this.sceneState=null,this.rotation=null,this.boundingBox=null,this.scene.destroy(),this.scene=null,this.filter=null}},{key:"registerPlugin",value:function(e){this.plugins.push(e)}},{key:"prepareCapScene",value:function(){if(this.capsScene)return void(this.clippingCaps||this.initCapPlane());this.capsScene=new CLOUD.Scene,this.clippingCaps||this.initCapPlane(),this.scene.createCapStencilMaterials()}},{key:"initCapPlane",value:function(){var e=this.scene.getFillClipPlane(),t=e.initCapsPlane();this.capsScene.add(t.lineMesh),this.capsScene.add(t.planeMesh),this.clippingCaps=!0}},{key:"initCapBox",value:function(){var e=this.scene.getClipPlanes(),t=e.initCapsBox();t.material.needsUpdate=!0,t.visible=!0,this.capsScene.add(t),this.clippingCaps=!0}},{key:"_updateOcclusionCamera",value:function(e){var t=e.near,i=e.distanceFromWorldToDrawing(this.getMatrixWorldGlobal(),CLOUD.GlobalData.OcclusionDistanceToCamera);this.occlusionCamera?this.occlusionCamera.copy(e):this.occlusionCamera=e.clone(),this.occlusionCamera.setNearFar(t,i),this.occlusionCamera.updateMVP()}},{key:"_clearMaterialPool",value:function(){this.materialPool&&this.materialPool.clear()}},{key:"acquireMaterial",value:function(){return this.materialPool?this.materialPool.acquire():null}},{key:"getObjectPool",value:function(){return this.scene.getObjectPool()}},{key:"getFrustumFromOcclusionCamera",value:function(){return this.occlusionCamera.getFrustum(!1)}},{key:"getOcclusionCamera",value:function(){return this.occlusionCamera}},{key:"prepareScene",value:function(e,t){var i=this.models;CLOUD.GlobalData.BatchMergeEnabled||(this.clearPool(),this.clearObjectRangeFromOctantMap()),CLOUD.GlobalData.OcclusionTranslucentEnabled&&(null==this.materialPool&&(this.materialPool=new CLOUD.ExpandableObjectPool,this.materialPool.init(CLOUD.MaterialEx,50)),this._clearMaterialPool(),this._updateOcclusionCamera(e));for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];r.isLoaded()&&!r.isEmptyScene()&&r.prepare(e,t)}this.dealStateChanged()}},{key:"clearPool",value:function(){this.scene.getObjectPool().clear()}},{key:"clearObjectRangeFromOctantMap",value:function(){this.octantToObjectMap&&this.octantToObjectMap.pool&&(this.octantToObjectMap.pool={})}},{key:"load",value:function(e,t,i){var n=this.models,r=n[e.databagId];if(void 0!==r)return r.isVisible()||(r.setVisible(!0),r.dispatchEvent({type:CLOUD.EVENTS.ON_LOAD_COMPLETE})),r;var a=0,o=[];for(var s in n)n.hasOwnProperty(s)&&o.push(n[s].index);o.sort();for(var l=0;l<o.length;l++)if(o[l]!==l){a=l;break}return r=new CLOUD.Model(this,e,a,t,i),n[e.databagId]=r,r.load(e.notifyProgress),r}},{key:"unload",value:function(e){var t=this.models[e];return!!t&&(delete this.models[e],t.destroy(),t=null,this.updateScene(),this.updateFilterManager(),this.filter.getObjectInfoManager().calculateVisibleComponentsBbox(),!0)}},{key:"unloadAll",value:function(){for(var e=this.getDataBagIds(),t=0,i=e.length;t<i;++t)this.unload(e[t]);this.clearPool(),this.models={}}},{key:"showModel",value:function(e){var t=this.models[e];return!!t&&(t.setVisible(!0),!0)}},{key:"hideModel",value:function(e){var t=this.models[e];return!!t&&(t.setVisible(!1),!0)}},{key:"getDataBagIds",value:function(){var e=this.models,t=[];for(var i in e)e.hasOwnProperty(i)&&t.push(i);return t}},{key:"updateScene",value:function(){this.updateSceneBoundingBox(),this.updateSceneRootMatrix(),this.updateSceneRenderable(),this.updateOctreeNode()}},{key:"updateSceneBoundingBox",value:function(){var e=this.models,t=this.boundingBox;t.makeEmpty();for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];if(!n.isEmptyScene()){var r=n.getBoundingBoxWorld();r&&(t.isEmpty()?t.copy(r):(t.expandByPoint(r.min),t.expandByPoint(r.max)))}}this.scene.setBoundingBoxWorld(t)}},{key:"updateSceneRootMatrix",value:function(){var e=!1,t=new THREE.Matrix4,i=new THREE.Matrix4,n=new THREE.Quaternion,r=this.models;for(var a in this.models)if(r.hasOwnProperty(a)){var o=r[a];if(!o.isEmptyScene()){n.copy(o.getTransforms().rotation),t.copy(o.getTransforms().transformMatrix),e=o.getTransforms().octreeTransformed;break}}if(this.scene.setTransformMatrixGlobal(t),e)i.copy(t);else{var s=new THREE.Vector3(1,1,1),l=CLOUD.GlobalData.SceneSize,c=this.boundingBox.getSize(),u=Math.max(c.x,c.y,c.z),h=l/u;s.multiplyScalar(h),i.makeRotationFromQuaternion(n),i.scale(s)}this.scene.updateWorldMatrixByMatrix(i)}},{key:"updateSceneRenderable",value:function(){var e=this.models,t=CLOUD.GlobalData.maxObjectNumInPool,i=[],n=0;for(var r in e)if(e.hasOwnProperty(r)){var a=e[r];a.isEmptyScene()||(n+=a.getStatistics().renderableTotalForPool,i.push(r))}for(var o=0,s=0,l=i.length;s<l;++s){var r=i[s],a=e[r],c=Math.floor(a.getStatistics().renderableTotalForPool/n*t);c>a.getStatistics().renderableTotalForPool&&(c=a.getStatistics().renderableTotalForPool),a.setRenderableCount(c),o+=c}this.scene.resizePool(o>t?t:o)}},{key:"updateOctreeNode",value:function(){var e=this.models;for(var t in this.models)if(e.hasOwnProperty(t)){var i=e[t];i.isLoaded()&&!i.isEmptyScene()&&i.updateOctreeNode(!0)}}},{key:"updateMaterials",value:function(){var e=this.models;for(var t in this.models)if(e.hasOwnProperty(t)){var i=e[t];i.isLoaded()&&!i.isEmptyScene()&&i.materialManager.updateMaterials(i)}}},{key:"updateMaterialsValue",value:function(e,t){var i=this.models;for(var n in this.models)if(i.hasOwnProperty(n)){var r=i[n];r.isLoaded()&&!r.isEmptyScene()&&r.materialManager.updateMaterialsValue(r,e,t)}this.materialOverrideSet&&this.materialOverrideSet.updateMaterialsValue(e,t)}},{key:"switchNewStyleMaterial",value:function(e){var t=this.models;for(var i in this.models)if(t.hasOwnProperty(i)){var n=t[i];n.isLoaded()&&!n.isEmptyScene()&&n.materialManager.switchNewStyleMaterial(n,e)}}},{key:"changeAllMaterials",value:function(e){if(this.IBLMaterial!=e){var t=this.models;for(var i in this.models)if(t.hasOwnProperty(i)){var n=t[i];n.isEmptyScene()||n.materialManager.changeAllMaterials(n,e)}this.IBLMaterial=e}}},{key:"setCrossOrigin",value:function(e){this.crossOrigin=e}},{key:"getMatrixWorldGlobal",value:function(){return this.scene.getMatrixWorldGlobal()}},{key:"hasModel",value:function(){var e=this.models;for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if(i.isLoaded())return!0}return!1}},{key:"hasModelDataReady",value:function(){var e=this.models,t=!1;for(var i in e)if(e.hasOwnProperty(i)){t=!0;var n=e[i];if(!n.isDataReady())return!1}return!!t}},{key:"isLayerData",value:function(){var e=this.models;for(var t in e)if(e.hasOwnProperty(t)){var i=e[t];if(i.isLayerData())return!0}return!1}},{key:"getModel",value:function(e){var t=this.models[e];return t&&t.isLoaded()?t:null}},{key:"getFirstModel",value:function(){var e=Object.keys(this.models)[0];return this.models[e]}},{key:"showOctreeBox",value:function(e){if(CLOUD.GlobalData.ShowOctant){var t=this.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.OCTREENODE,{pickable:0,priority:2});if(t.visible=!0,0===t.children.length){var i=new THREE.Box3(e.min,e.max),n=new CLOUD.BBoxNode(i,16711680);t.add(n),n.updateMatrixWorld(!0),function e(i){for(var n=0,r=i.childOctants.length;n<r;n++){var a=i.childOctants[n],o=new THREE.Box3(a.min,a.max),s=255;s<<=5*a.depth;var l=new CLOUD.BBoxNode(o,s);t.add(l),l.updateMatrixWorld(!0),e(a)}}(e)}}else this.scene.removeObjectGroupByName(CLOUD.ObjectGroupType.OCTREENODE)}},{key:"setCategoriesToHighPriority",value:function(e,t){var i=e.length;if(!(i<1))for(var n=this.highPriorityCategories[t]={},r=0;r<i;++r)n[e[r]]=!0}},{key:"getCategoriesFromHighPriority",value:function(e){return this.highPriorityCategories[e]}},{key:"clearCategoriesFromHighPriority",value:function(e){this.highPriorityCategories[e]={}}},{key:"clearAllCategoriesFromHighPriority",value:function(){this.clearCategoriesFromHighPriority("inner"),this.clearCategoriesFromHighPriority("outer")}},{key:"calculateCameraModelRelation",value:function(e){var t=!1,i=this.models;for(var n in i)if(i.hasOwnProperty(n)){var r=i[n];r&&r.isLoaded()&&!r.isEmptyScene()&&(r.calculateCameraModelRelation(e),t=t||r.containsCamera)}this.containsCamera=t}},{key:"getCameraNameList",value:function(){var e=this.models,t=[];for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];n.isEmptyScene()||(t=t.concat(n.getCameraNameList()))}return t}},{key:"getCamera",value:function(e){var t=this.models,i=null;for(var n in t)if(t.hasOwnProperty(n)){var r=t[n];if(!r.isEmptyScene()&&(i=r.getCamera(e)))break}return i}},{key:"getNumOfElements",value:function(){var e=this.models,t=0;for(var i in this.models)if(e.hasOwnProperty(i)){var n=e[i];n.isEmptyScene()||(t+=n.getStatistics().numOfElements)}return t}},{key:"getNumOfRenderables",value:function(){var e=this.models,t=0;for(var i in this.models)if(e.hasOwnProperty(i)){var n=e[i];n.isEmptyScene()||(t+=n.getStatistics().renderableTotal)}return t}},{key:"getNumOfTriangles",value:function(){var e=this.models,t=0;for(var i in this.models)if(e.hasOwnProperty(i)){var n=e[i];n.isEmptyScene()||(t+=n.getStatistics().numOfTriangles)}return t}},{key:"getScene",value:function(){return this.scene}},{key:"getOctreeRoots",value:function(){var e=this.models,t={};for(var i in e)if(e.hasOwnProperty(i)){var n=e[i];if(n.isLoaded()&&!n.isEmptyScene()){var r=n.getEncodedDatabagId();t[r]=[],n.getModelDescriptor().getOctreeRoots(t[r])}}return t}},{key:"addMeshToOctantMap",value:function(e,t,i){var n=this.octantToObjectMap;n[e]||(n[e]={}),n[e].mesh||(n[e].mesh={}),n[e].mesh[t]||(n[e].mesh[t]=[]),n[e].mesh[t].push(i)}},{key:"addNodeInfoToOctantMap",value:function(e,t,i){var n=this.octantToObjectMap;n[e]||(n[e]={}),n[e].info||(n[e].info={}),n[e].info[t]||(n[e].info[t]=[]),n[e].info[t].push(i)}},{key:"removeNodeInfoFromOctantMap",value:function(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].info&&i[e].info[t.cellId])for(var n=i[e].info[t.cellId],r=n.length-1;r>=0;r--)if(t.nodeId===n[r].nodeId){n.splice(r);break}}},{key:"clearNodeInfosFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&t[e].info&&(t[e]=null)}},{key:"removeAllFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&delete t[e]}},{key:"clearMeshFromOctantMap",value:function(e){var t=this.octantToObjectMap;t[e]&&t[e].mesh&&delete t[e].mesh}},{key:"removeMeshFromOctantMap",value:function(e,t){var i=this.octantToObjectMap;if(i[e]&&i[e].mesh&&i[e].info){var n,r=i[e].info[t.cellId];for(n=r.length-1;n>=0;n--)if(t.nodeId===r[n].nodeId){r.splice(n);break}i[e].mesh[t.nodeId]&&delete i[e].mesh[t.nodeId]}}},{
key:"getOctantMap",value:function(){return this.octantToObjectMap}},{key:"applyFilter",value:function(){for(var e in this.models){this.models[e].applyFilter()}for(var t=0,i=this.plugins.length;t<i;t++)this.plugins[t].applyFilter()}},{key:"applySelection",value:function(){this.selectPriority=!0;for(var e in this.models){this.models[e].applySelection()}this.scene.getExtrudeBodyManager().applySelection(this);for(var t=0,i=this.plugins.length;t<i;t++)this.plugins[t].applySelection()}},{key:"clearSelection",value:function(){this.selectPriority=!0;for(var e in this.models){this.models[e].clearSelection()}this.scene.getExtrudeBodyManager().clearSelection();for(var t=0,i=this.plugins.length;t<i;t++)this.plugins[t].clearSelection()}},{key:"applyHover",value:function(){if(CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass)for(var e in this.models){var t=this.models[e];t.applyHover()}this.scene.getExtrudeBodyManager().applyHover(this);for(var i=0,n=this.plugins.length;i<n;i++)this.plugins[i].applyHover()}},{key:"clearHover",value:function(){if(CLOUD.GlobalData.Hover&&!CLOUD.GlobalData.EnableRenderPass)for(var e in this.models){var t=this.models[e];t.clearHover()}this.scene.getExtrudeBodyManager().clearHover();for(var i=0,n=this.plugins.length;i<n;i++)this.plugins[i].clearHover()}},{key:"chooseRendering",value:function(e){if(!this.firstChooseRendering){this.firstChooseRendering=!0,console.log("memoery interval:","["+e.minMemoerySize+","+e.maxMemoerySize+"]");switch(CLOUD.GlobalData.Renderer){case CLOUD.EnumRendererType.FULL:CLOUD.GlobalData.BatchMergeEnabled=!0,CLOUD.GlobalData.IncrementRender=!1;break;case CLOUD.EnumRendererType.INCREMENT:CLOUD.GlobalData.BatchMergeEnabled=!1,CLOUD.GlobalData.IncrementRender=!0;break;default:e.maxMemoerySize<=CLOUD.GlobalData.MaxMemeorySizeToFullRender?(CLOUD.GlobalData.BatchMergeEnabled=!0,CLOUD.GlobalData.IncrementRender=!1):(CLOUD.GlobalData.BatchMergeEnabled=!1,CLOUD.GlobalData.IncrementRender=!0)}}}},{key:"isUserIdExist",value:function(e){var t=!1;for(var i in this.models)if(this.models.hasOwnProperty(i)){var n=this.models[i];if(n.getModelDescriptor().isUserIdExist(e)){t=!0;break}}return t}},{key:"getNodeInfosByUserId",value:function(e){for(var t in this.models)if(this.models.hasOwnProperty(t)){var i=this.models[t].getModelDescriptor().getNodeInfosByUserId(e);if(i)return i}return null}},{key:"getNodeInfos",value:function(){var e={};for(var t in this.models){var i=this.models[t].getModelDescriptor().getAllNodeInfos();i&&(e[t]=i)}for(var n=0,r=this.plugins.length;n<r;n++)this.plugins[n].getAllNodeInfos&&this.plugins[n].getAllNodeInfos(e);return e}},{key:"getMaterialByNodeId",value:function(e,t,i){var n=this.models[e];if(!n)return null;for(var r=n.getModelDescriptor().getNodeInfosByUserId(t),a=-1,o=0,s=r.length;o<s;o++)if(r[o].nodeId===i){a=o;break}return-1!==a?n.getMaterialByMaterialId(r[a].materialId):null}},{key:"getNodeInfoByNodeId",value:function(e,t,i){var n=this.models[e];if(!n)return null;for(var r=n.getModelDescriptor().getNodeInfosByUserId(t),a=-1,o=0,s=r.length;o<s;o++)if(r[o].nodeId===i){a=o;break}return-1!==a?r[a]:null}},{key:"getComponentInfoByUserId",value:function(e){var t=this.getNodeInfosByUserId(e);if(t&&t.length>0){for(var i=new THREE.Box3,n=[],r=0,a=t.length;r<a;r++)i.union(t[r].boundingBox),-1===n.indexOf(t[r].materialId)&&n.push(t[r].materialId);return{userId:e,state:0,materials:n,boundingBox:i,userData:t[0].userData}}return null}},{key:"getBoundingBoxByIds",value:function(e){var t=this.getScene(),i=new THREE.Box3;for(var n in e)if(!this.isHiddenUserId(n)){var r=this.getComponentInfoByUserId(n);if(r)i.union(r.boundingBox);else{var a=t.getExtrudeBodyManager(),o=a.getNode(n);if(o){var s=o.geometry.boundingBox.clone();o.matrix&&s.applyMatrix4(o.matrix),i.union(s)}}}return i}},{key:"createMaterialOverrideSet",value:function(e,t){this.materialOverrideSet=new CLOUD.MaterialOverriderSet(e,t),CLOUD.GlobalData.EnableTextureMapping=!0}},{key:"getMaterialOverrideSet",value:function(){return this.materialOverrideSet}},{key:"getOverrideMaterialByNodeInfo",value:function(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByNodeInfo(e):null}},{key:"getOverrideMaterialByName",value:function(e){return this.materialOverrideSet?this.materialOverrideSet.getOverrideMaterialByName(e):null}},{key:"loadOverrideMaterialsByDemand",value:function(e,t){if(this.materialOverrideSet){var i=this.getConditions();this.materialOverrideSet.loadByDemand(i,e,t)}else t&&t()}},{key:"getConditions",value:function(){var e={},t={},i={};for(var n in this.models){var r=this.models[n].getModelDescriptor().getAllNodeInfos();if(r)for(var n in r)if(r.hasOwnProperty(n))for(var a=0,o=r[n].length;a<o;a++){var s=r[n][a].userData;t[r[n][a].userId]=!0,i[s.systemTypeId]=!0,e[s.familyId]=!0}}return{familyIds:e,elementIds:t,systemTypeIds:i}}},{key:"isHiddenUserId",value:function(e){var t=!1;for(var i in this.models)if(this.models.hasOwnProperty(i)){var i=this.models[i];if(i.isHiddenUserId(e)){t=!0;break}}return t}},{key:"updateMeshNodes",value:function(){if(CLOUD.GlobalData.BatchMergeEnabled)for(var e in this.models)if(this.models.hasOwnProperty(e)){var e=this.models[e];e.updateMeshNodes()}}},{key:"getMinDistanceObjects",value:function(e,t){var i=this;for(var n in this.models)if(this.models.hasOwnProperty(n)){var n=this.models[n];if(n.minDistanceObjects={},n.getMeshesByUserIds(e,t),n.minDistanceObjects[e].length>0&&n.minDistanceObjects[t].length>0)return n.minDistanceObjects;var r,a,o,s,l,c=function(){var c=function(e,t,i){var r={};r.mesh=e;var a=new THREE.Matrix4;i?a.multiplyMatrices(i,e.matrix):a=e.matrix,r.matrix=a;var o=e.geometry.boundingBox;o||(e.geometry.computeBoundingBox(),o=r.mesh.geometry.boundingBox);var s=o.clone().applyMatrix4(a);r.boundingBox=s,n.minDistanceObjects[t].push(r)};if(!(r=i.scene.getObjectGroup("ExternalComponentManager")))return{v:void 0};for(a=r.children,o=0,s=a.length;o<s;o++)l=a[o],l.name!=e&&l.name!=t||(CLOUD.Utils.isGroupObject(l)?l.traverseVisible(function(e){CLOUD.Utils.isMeshObject(e)&&c(e,l.name,l.matrix)}):c(l,l.name));return{v:n.minDistanceObjects}}();if("object"===(void 0===c?"undefined":_typeof(c)))return c.v}return null}},{key:"adjustVisibility",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().adjustVisibility(e)}},{key:"changeVisibilityOfSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().changeVisibilityOfSelectedObjects(e)}},{key:"changeVisibilityOfNonSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().changeVisibilityOfNonSelectedObjects(e)}},{key:"adjustInstanceVisibility",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().adjustInstanceVisibility(e)}},{key:"changeInstanceVisibilityOfSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().changeInstanceVisibilityOfSelectedObjects(e)}},{key:"changeInstanceVisibilityOfNonSelectedObjects",value:function(e){if(CLOUD.GlobalData.BatchMergeEnabled)for(var t in this.models)this.models[t]&&this.models[t]._getHandler().changeInstanceVisibilityOfNonSelectedObjects(e)}},{key:"restoreVisibilityOfObjects",value:function(){if(CLOUD.GlobalData.BatchMergeEnabled)for(var e in this.models)this.models[e]&&this.models[e]._getHandler().restoreVisibilityOfObjects()}},{key:"getBlinkMaterials",value:function(){var e=[];for(var t in this.models)this.models[t]&&this.models[t]._getHandler().getBlinkMaterials&&(e=e.concat(this.models[t]._getHandler().getBlinkMaterials()));return e}},{key:"resetBlinkMaterial",value:function(){for(var e=this.getBlinkMaterials(),t=0,i=e.length;t<i;t++)e[t].resetBlinkUniformValue()}},{key:"updateBlinkMaterial",value:function(){if(null===this.blinkStartTime)return void(this.blinkStartTime=Date.now());if(!(Date.now()-this.blinkStartTime<this.blinkIntervalTime)){this.blinkStartTime=Date.now(),this.indexSwitch=!this.indexSwitch;for(var e=this.indexSwitch?CLOUD.EnumShaderColorState.BLINK:CLOUD.EnumShaderColorState.NONE,t=this.getBlinkMaterials(),i=0,n=t.length;i<n;i++)t[i].updateBlinkUniformValue(e,this.blinkColor)}}},{key:"getBlinkColor",value:function(){return this.blinkColor}},{key:"setBlinkColor",value:function(e,t){if(e){var i=CLOUD.Utils.hexToRgb(e);this.blinkColor.fromArray([i.r,i.g,i.b,t||1])}else this.blinkColor.set(this.defaultBlinkColor.r,this.defaultBlinkColor.g,this.defaultBlinkColor.b,this.defaultBlinkAlpha)}},{key:"setBlinkIntervalTime",value:function(e){this.blinkIntervalTime<=0||(this.blinkIntervalTime=e)}},{key:"enableBlink",value:function(e){this.blinkEnabled=e,e?null===this.blinkStartTime&&(this.blinkStartTime=Date.now()):(this.blinkStartTime=null,this.resetBlinkMaterial()),this.applyBlink()}},{key:"getBlinkEnabled",value:function(){return!this.isBlinkPermited()&&this.blinkEnabled}},{key:"getBlinkComponentsIdMap",value:function(){return this.isBlinkPermited()?null:this.sceneState.getBlinkComponentsIdMap()}},{key:"applyBlink",value:function(){if(!this.isBlinkPermited()){this.selectPriority=!1;for(var e in this.models){this.models[e].applyBlink()}}}},{key:"clearBlink",value:function(){if(!this.isBlinkPermited()){this.selectPriority=!1;for(var e in this.models){this.models[e].clearBlink()}}}},{key:"permitBlink",value:function(e){this.blinkPermited=e}},{key:"isBlinkPermited",value:function(){return this.blinkPermited}},{key:"isSelectPriority",value:function(){return this.selectPriority}},{key:"getSceneState",value:function(){return this.sceneState}},{key:"disposeBufferAfterVbo",value:function(){if(CLOUD.GlobalData.EnableDisposeBufferAfterVbo)for(var e in this.models){var t=this.models[e];t.disposeBufferAfterVbo()}}},{key:"getSourceObjectManager",value:function(){return this.sourceObjectManager||(this.sourceObjectManager=new CLOUD.SourceObjectManager),this.sourceObjectManager}},{key:"isHiddenUserId",value:function(e){return!!this.sourceObjectManager&&this.sourceObjectManager.isHidden(e)}},{key:"hasHiddenUserId",value:function(){return!!this.sourceObjectManager&&this.sourceObjectManager.hasHidden()}},{key:"traverseModels",value:function(e,t){for(var i in this.models){var n=this.models[i];if(t&&t(n))break;e&&e(n)}}},{key:"dealStateChanged",value:function(){this.hasModelDataReady()&&(this.isRenderStateChanged()||this.filter.isStateChanged())&&(this.isRenderStateChanged()&&this.setRenderStateChanged(!1),this.filter.isStateChanged()&&this.filter.diableStateChanged(),this.applyFilter())}},{key:"setRenderStateChanged",value:function(e){this._renderStateChanged=e}},{key:"isRenderStateChanged",value:function(){return this._renderStateChanged}},{key:"hasLoadOnDemandDirector",value:function(){return!!this.loadOnDemandDirector}},{key:"getLoadOnDemandDirector",value:function(){return this.loadOnDemandDirector||(this.loadOnDemandDirector=new CLOUD.LoadOnDemandDirector(this)),this.loadOnDemandDirector}},{key:"checkLayerDataLoading",value:function(){return!!(this.isLayerData()&&this.hasLoadOnDemandDirector()&&this.getLoadOnDemandDirector().isLoading())&&(this.filter.isStateChanged()&&this.filter.diableStateChanged(),!0)}},{key:"updateFilterManager",value:function(){var e=this.getNodeInfos(),t=this.filter;t.clearFilterManager(),t.initFilterManager(e),t.isStateChanged()&&t.diableStateChanged(),this.updateMeshNodes(),this.applyFilter()}},{key:"isDrawingBoardlineEnabled",value:function(){if(!CLOUD.GlobalData.DrawingBoardlineEnabled||CLOUD.GlobalData.DrawingStyle!==CLOUD.DrawingStyle.BOARDLINE&&CLOUD.GlobalData.DrawingStyle!==CLOUD.DrawingStyle.SHADINGWITHLINE)return!1;if(CLOUD.GlobalData.DrawingBoardlineLimit){var e=0;if(this.traverseModels(function(t){t.isLoaded()&&(e+=t.getWireframeElementCount())}),e>CLOUD.GlobalData.DrawingBoardlineLimitThreshold)return!1}return!0}},{key:"isOnlyWireframe",value:function(){return CLOUD.GlobalData.DrawingStyle===CLOUD.DrawingStyle.BOARDLINE}},{key:"getExplosionTranslation",value:function(e){return this.explosionTranslation[e]||new THREE.Vector3}},{key:"getExplosionExtent",value:function(){return this.explosionExtent}},{key:"setExplosionExtent",value:function(e){var t=e-this.explosionExtent;if(0!=t){var i=new THREE.Matrix4,n=new THREE.Box3;for(var r in this.models){var a=this.models[r];if(a){for(var o=a.getBoundingBoxWorld(),s=o.getCenter(),l=this.models[r].getModelDescriptor().getAllNodeInfos(),c=Object.keys(l),u=0,h=c.length;u<h;u++){for(var d=c[u],f=l[d],p=new THREE.Box3,m=0,g=f.length;m<g;m++)f[m].originBox||(f[m].originBox=f[m].boundingBox.clone()),p.union(f[m].originBox);var v=CLOUD.Utils.computeExplodeTranslation(s,p,t);this.explosionTranslation[d]=v,i.makeTranslation(v.x,v.y,v.z);for(var y=0,E=f.length;y<E;y++)f[y].boundingBox.applyMatrix4(i),f[y].matrix.multiplyMatrices(i,f[y].matrix),n.union(f[y].boundingBox)}0==e&&(n=o.clone())}}this.scene.setBoundingBoxWorld(n);for(var a in this.models)this.models[a]&&this.models[a].explode();this.explosionExtent=e,delete this.explosionTranslation,this.explosionTranslation={}}}},{key:"setFloorExplosion",value:function(e,t){if(void 0!=this.floorInfos){delete this.floorExplosionList,this.floorExplosionList=[];var i=!0,n={};if(t){for(var r=0,a=t.length;r<a;r++)n[t[r]]=!0;if(i=!1,0==t.length)return}for(var o={},s=this.floorInfos,l=s.length,c=e*this.totalHeight/(l-1),u=0,h=0;h<l;h++){var d=s[h].name,f=s[h].elevation+u*c,p=f-s[h].explodedHeight;o[d]=new THREE.Vector3(0,0,p),(i||n[s[h].id])&&(u++,this.floorExplosionList.push(s[h].id)),s[h].explodedHeight=f}this.dispatchEvent({type:CLOUD.EVENTS.ON_FLOOR_EXPLOSION,translations:o,floorInfos:s});var m=new THREE.Matrix4,g=new THREE.Box3;for(var v in this.models){var y=this.models[v];if(y)for(var E=this.models[v].getModelDescriptor().getAllNodeInfos(),x=Object.keys(E),b=0,C=x.length;b<C;b++)for(var M=x[b],_=E[M],w=0,L=_.length;w<L;w++){if(0==w){var T=o[_[w].userData.levelName]||new THREE.Vector3;m.makeTranslation(T.x,T.y,T.z),this.explosionTranslation[M]=T}_[w].boundingBox.applyMatrix4(m),_[w].matrix.multiplyMatrices(m,_[w].matrix),g.union(_[w].boundingBox)}}this.scene.setBoundingBoxWorld(g),this.filter.getObjectInfoManager().needUpdateBoxAfterExplode();for(var y in this.models)this.models[y]&&this.models[y].explode();this.floorExplosionExtent=e,delete this.explosionTranslation,this.explosionTranslation={}}}}]),t}(THREE.EventDispatcher);CLOUD.ModelManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.manager=t,this.requestCount=0,this.maxRequestCount=1e5,this.loading=!1,this.delayIntervalTime=300}return _createClass(e,[{key:"destroy",value:function(){this.manager=null,this.currentConditions=null,this.delayLoadTimer&&(clearTimeout(this.delayLoadTimer),this.delayLoadTimer=null)}},{key:"isValidModel",value:function(e){return!(e.isEmptyScene()||!e.isLayerData())}},{key:"loadMpkOnDemandByConditionsWithDelay",value:function(e,t,i,n){var r=this,a=this.delayIntervalTime;!function(){r.delayLoadTimer&&clearTimeout(r.delayLoadTimer),r.delayLoadTimer=setTimeout(function(){r.loadMpkOnDemandByConditions(e,t,i,n)},a)}()}},{key:"loadMpkOnDemandByConditions",value:function(e,t,i,n){function r(e){var o=e,s=a.currentConditions;return function(){a._loadMpkOnDemandByConditions(s,t,i,function(){o!==a.requestCount?requestAnimationFrame(r(a.requestCount)):(a.loading=!1,n&&n(s),s=null)})}}if(this.currentConditions=e,++this.requestCount,this.requestCount>this.maxRequestCount&&(this.requestCount=0),!this.loading){this.loading=!0;var a=this;requestAnimationFrame(r(this.requestCount))}}},{key:"_loadMpkOnDemandByConditions",value:function(e,t,i,n){var r=this;this.manager.traverseModels(function(a){r.isValidModel(a)&&a._getHandler().loadMpkOnDemand(e,t,i,n)})}},{key:"getBoundingBoxOnDemand",value:function(){var e=new THREE.Box3,t=this;return this.manager.traverseModels(function(i){if(t.isValidModel(i)){var n=i._getHandler().getLayerProvider().getUnionBoundingBoxOnDemand();n&&e.union(n)}}),e.isEmpty()?null:e}},{key:"isLoading",value:function(){return this.loading}},{key:"getBoundingBoxForUsedComponent",value:function(){var e=this.manager,t=new THREE.Box3;return e.traverseModels(function(i){var n=i.getLoadedUserIdsObject();n&&t.union(e.getBoundingBoxByIds(n))}),t.isEmpty()?null:t}}]),e}();CLOUD.LoadOnDemandDirector=e}();var BfMaterialManager=function(){function e(){_classCallCheck(this,e),this.instanceMaterials={},this.materials={},this.textures={},this.lightmaps={},this.ensureImagePowerOfTwo=!1}return _createClass(e,[{key:"destroy",value:function(){this.instanceMaterials=null,this.materials=null,this.textures=null,this.lightmaps=null}},{key:"disposeInstanceMaterials",value:function(e){var t=this.instanceMaterials;for(var i in t){var n=t[i];if(n instanceof Array)for(var r=0,a=n.length;r<a;r++)n[r].dispose();else n.dispose()}}},{key:"disposeMaterials",value:function(e){var t;for(var i in this.materials)t=this.materials[i],t.dispose();this.disposeInstanceMaterials(e)}},{key:"updateMaterialsValue",value:function(e,t,i){var n,r=this.materials,a=this.instanceMaterials;for(var o in r)(n=r[o])&&n[t]&&(n[t]=i,void 0!==n.refreshUniforms&&n.refreshUniforms(),n.needsUpdate=!0);for(var o in a)if(n=a[o])if(n instanceof Array)for(var s=0,l=n.length;s<l;s++)n[s][t]&&(n[s][t]=i,void 0!==n[s].refreshUniforms&&n[s].refreshUniforms(),n[s].needsUpdate=!0);else n[t]&&(n[t]=i,void 0!==n.refreshUniforms&&n.refreshUniforms(),n.needsUpdate=!0)}},{key:"_updateTextureMapping",value:function(e){function t(e,t){if(t){if(void 0===t.length)e.map=t;else for(var i=0;i<t.length;i++)n||(t[i]instanceof THREE.CompressedTexture?THREE.Math.isPowerOfTwo(t[i].image.width)&&THREE.Math.isPowerOfTwo(t[i].image.height)||console.log("Warning: THREE.CompressedTexture is not power of two."):t[i].image=CLOUD.MaterialUtil.ensurePowerOfTwo(t[i].image)),"map"==t[i].texturetype?e.map=t[i]:"bumpMap"==t[i].texturetype?(e.bumpMap=t[i],t[i].depth&&(e.bumpScale=t[i].depth)):"specularMap"==t[i].texturetype?e.specularMap=t[i]:"alphaMap"==t[i].texturetype?(e.alphaMap=t[i],e.alphaTest=.01,e.map=t[i],e.transparent=!0):"emissiveMap"==t[i].texturetype?e.emissiveMap=t[i]:"environmentMap"==t[i].texturetype?e.envMap=t[i]:"normalMap"==t[i].texturetype?(e.normalMap=t[i],t[i].depth&&e.normalScale.set(t[i].depth,t[i].depth)):console.warn("This map type is not supported yet:",t[i].texturetype);CLOUD.GlobalData.IBL&&e.refreshUniforms(),e.needsUpdate=!0}else e.textureColor&&e.color.setStyle(e.textureColor),e.needsUpdate=!0}var i=CLOUD.GlobalData.EnableTextureMapping,n=this.ensureImagePowerOfTwo;if(this.lastTextureEnabled!==i){var r=this.textures,a=this.materials;if(e)var o=e.manager.getMaterialOverrideSet(),s=o?o.materialsByName:null,l=o?o.textures:null;var c,u,h=this.instanceMaterials;if(i){for(c in a)if(u=a[c]){var d=r[c];t(u,d)}for(c in h)if(u=h[c]){var d=r[c],f=c.split("#")[0];if(l&&l[f]&&(d=l[f]),u instanceof Array)for(var p=0,m=u.length;p<m;p++)t(u[p],d);else t(u,d)}for(c in s)if(u=s[c]){var f=c.split("#")[0],d=l[f];t(u,d)}this.ensureImagePowerOfTwo=!0}else{if(!o)for(c in a)(u=a[c])&&(u.map=null,u.needsUpdate=!0);for(c in h)if(u=h[c])if(u instanceof Array)for(var p=0,m=u.length;p<m;p++)u[p].pureColor&&(u[p].color.setStyle(u[p].pureColor),u[p].map=null,u[p].needsUpdate=!0),o||(u[p].map=null,u[p].needsUpdate=!0);else u.pureColor&&(u.color.setStyle(u.pureColor),u.map=null,u.needsUpdate=!0),o||(u.map=null,u.needsUpdate=!0);for(c in s)(u=s[c])&&(u.map=null,u.needsUpdate=!0,u.pureColor&&u.color.setStyle(u.pureColor))}this.lastTextureEnabled=i}}},{key:"updateMaterials",value:function(e){var t=this.materials;for(var i in t)if(t.hasOwnProperty(i)){var n=t[i];n.IBLMaps=e.manager.scene.IBLMaps,n.refreshUniforms()}}},{key:"_updateIBL",value:function(e){var t=e.manager.scene;if(CLOUD.GlobalData.IBL&&null!=t.iblProbe&&t.iblProbe.isComputed){this.materialManager.updateMaterials(e);var i=t.IBLcfg,n=Object.keys(i),r=i[n[t.IBLIndex]];for(var a in r)this.materialManager.updateMaterialsValue(e,a,r[a])}}},{key:"changeAllMaterials",value:function(e,t){var i=this.materials;for(var n in i)if(i.hasOwnProperty(n)){var r,a=i[n],o=CLOUD.MaterialUtil.getMaterialParameters(a);t?(delete o.textureColor,delete o.pureColor,delete o.imageFade,o.lights=!0,r=new ImageBasedLighting.IBLMaterial(o),r.type="IBL",r.refreshUniforms()):(delete o.iblProbe,r=CLOUD.MaterialUtil.createStandardMaterial(o),r.roughness=o.originRoughness,r.metalness=o.originMetalness,r.refreshUniforms()),r.name=n,i[n]=r,o=null}}},{key:"switchNewStyleMaterial",value:function(e,t){var i=this.materials;for(var n in i)if(i.hasOwnProperty(n)){var r,a=i[n],o=CLOUD.MaterialUtil.getMaterialParameters(a);r=t?CLOUD.MaterialUtil.createNewStyleMaterial(o):CLOUD.MaterialUtil.createStandardMaterial(o),r.name=n,i[n]=r,o=null}}},{key:"getInstanceMaterialById",value:function(e,t){if(this.instanceMaterials[e])return this.instanceMaterials[e];var i=CLOUD.MaterialUtil.getMaterialParameters(t.manager.getOverrideMaterialByName(e)||this.materials[e]),n=i.transparent,r=CLOUD.MaterialUtil.createInstanceMaterial(i,!0);r.transparent=!1;var a=CLOUD.MaterialUtil.createInstanceMaterial(i,!0);return a.transparent=!0,CLOUD.GlobalData.TranslucentDepthDisabled&&(a.depthWrite=!1),n===r.transparent?(this.instanceMaterials[e]=[r,a],a.defines.INSTANCE_STATE_SECONDARY=""):(this.instanceMaterials[e]=[a,r],r.defines.INSTANCE_STATE_SECONDARY=""),this.instanceMaterials[e]}},{key:"getMaterialById",value:function(e){return this.materials[e]}}]),e}();CLOUD.MaterialManager=BfMaterialManager,function(){var e=function(){function e(){_classCallCheck(this,e),this.visibleOctantList=[]}return _createClass(e,[{key:"destroy",value:function(){this.visibleOctantList=null}},{key:"_getVisibleOctantsWithInnerAndOuterOctree",value:function(e,t,i){this.visibleOctantList.length=0;var n=e.getModelDescriptor().getOctreeRootNode(),r=n.inner,a=n.outer;if(!r&&!a)return[];var o=e.containsCamera,s=null;if(o)r&&(s=new CLOUD.OctantNeighborUtil(t,r).getAncestorAndNeighbors(),this._frustumCull(t,r,i,this.visibleOctantList)),a&&this._frustumCull(t,a,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList,s);else{var l=[],c=[];a&&(this._frustumCull(t,a,!0,l),this._sortOctantList(l,s)),r&&(s=new CLOUD.OctantNeighborUtil(t,r).getAncestorAndNeighbors(),this._frustumCull(t,r,i,c),this._sortOctantList(c,s));var u,h=l.length,d=c.length;for(u=0;u<h;u++)this.visibleOctantList[u]=l[u];for(u=0;u<d;u++)this.visibleOctantList[h+u]=c[u]}return this.visibleOctantList}},{key:"_getVisibleOctantsWithLayerOctree",value:function(e,t,i){this.visibleOctantList.length=0;var n=e.getModelDescriptor().getOctreeRootNode().layer;return this._frustumCull(t,n,i,this.visibleOctantList),this._sortOctantList(this.visibleOctantList),this.visibleOctantList}},{key:"getVisibleOctants",value:function(e,t,i){return e.getModelDescriptor().isUseInnerAndOuterOctree()?this._getVisibleOctantsWithInnerAndOuterOctree(e,t,i):this._getVisibleOctantsWithLayerOctree(e,t,i)}},{key:"_sortOctantList",value:function(e,t){e.sort(function(e,i){if(null!=t){if(void 0!=t[e.octantId])return-1;if(void 0!=t[i.octantId])return 1}return e.priority>i.priority?-1:e.priority<i.priority?1:0})}},{key:"showOctreeBox",value:function(e){if(CLOUD.GlobalData.DEBUG){var t=e.getModelDescriptor().getOctreeRootNode();e.getModelDescriptor().isUseInnerAndOuterOctree()?(t.inner&&e.manager.showOctreeBox(t.inner),t.outer&&e.manager.showOctreeBox(t.outer)):t.layer&&e.manager.showOctreeBox(t.layer)}}},{key:"_frustumCull",value:function(e,t,i,n){function r(e,t,i,n,a){var o;if(t&&e.depth<i&&(l.set(e.min,e.max),o=t.intersectsBox(l)),o){if(n){var u=l.applyMatrix4(s),h=u.getSize().length(),d=u.getCenter().z;d=d>c?d:c,e.priority=h/d,a.push(e)}else a.push(e);for(var f=0,p=e.childOctants.length;f<p;++f){r(e.childOctants[f],t,i,n,a)}}}var a=e.getFrustum(),o=CLOUD.GlobalData.OctantDepth,s=e.projScreenMatrix,l=new THREE.Box3,c=1e-6;r(t,a,o,i,n)}},{key:"_traverseOctants",value:function(e,t){function i(e,t){t.push(e);for(var n=0,r=e.childOctants.length;n<r;++n){i(e.childOctants[n],t)}}i(e,t)}},{key:"getAllOctants",value:function(e){var t=[],i=e.getModelDescriptor().getOctreeRootNode();return e.getModelDescriptor().isUseInnerAndOuterOctree()?(i.inner&&this._traverseOctants(i.inner,t),i.outer&&this._traverseOctants(i.outer,t)):i.layer&&this._traverseOctants(i.layer,t),t}}]),e}();CLOUD.OctantManager=e}(),CLOUD.Loader.OctreeNode=function(e,t){void 0===e&&alert("Invalid Octant Id"),this.octantId=e,this.childOctants=new Array,this.min=null,this.max=null,this.depth=t||0,this.center=null,this.size=-1,this.priority=-1,this.octType=-1},CLOUD.Loader.OctreeNode.prototype.isRoot=function(){return 0==this.depth},CLOUD.Loader.OctreeNode.prototype.add=function(e){e.depth=this.depth+1,this.childOctants.push(e)},CLOUD.Loader.OctreeNode.prototype.updateMaxDepth=function(){this.depth>CLOUD.GlobalData.MaximumDepth&&(CLOUD.GlobalData.MaximumDepth=this.depth)},CLOUD.ClipPlanesTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.CLIP_BY_BOX),this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.onClipBox=!1;for(var t=[],i=0;i<6;++i)t.push(new THREE.Plane);var n=this.scene.getClipPlanes();n.updateClippingParams=function(i){if(0==i.iClipPlane.value)e.renderer.clippingPlanes=Object.freeze([]);else{for(var n=0,r=i.iClipPlane.value;n<r;++n){var a=i.vClipPlane.value[n],o=t[n];o.setComponents(-a.x,-a.y,-a.z,-a.w),o.normalize()}e.renderer.clippingPlanes=t,this.calculateClipBoundingBox(t)}},n.init(),this.selectIndex=null,this.planeDistance=0,this.offsetSpeed=.02,this.toggle=function(e,t){n.enable(e,t)},this.visible=function(e){n.visible=e},this.rotatable=function(e){n.rotatable=e},this.store=function(){return n.store()},this.restore=function(e){n.restore(e)},this.reset=function(){n.reset()},this.pointToScreen=function(e){var t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var n=new THREE.Vector4(e.x,e.y,e.z,1);n.applyMatrix4(i);var r=new THREE.Vector2;r.x=(n.x/n.w+1)/2,r.y=1-(n.y/n.w+1)/2;var a=this.cameraControl.getContainerDimensions();return r.x=r.x*a.width+a.left,r.y=r.y*a.height+a.top,r},this.getPlaneDistanceInScreen=function(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=n.center.clone(),t=n.center.clone();e.x-=n.cubeSize.x,t.x+=n.cubeSize.x;var i=this.pointToScreen(e),r=this.pointToScreen(t);return i.x-r.x}var a=n.center.clone(),o=n.center.clone();o.y-=n.cubeSize.y,a.y+=n.cubeSize.y;var s=this.pointToScreen(o),l=this.pointToScreen(a);return s.y-l.y},this.getPickPoint=function(e,t){var i=this.cameraControl.camera,n=this.cameraControl.getContainerDimensions(),r=e-n.left,a=t-n.top,o=r/n.width*2-1,s=(n.height-a)/n.height*2-1,l=new CLOUD.Raycaster;return l.setFromCamera(new THREE.Vector2(o,s),i),l.ray.intersectPlane(this.plane)},this.getSelectIndex=function(){return n.selectIndex},this._isVisible=function(){return n.visible},this.isRotate=function(){return n.rotatable},this.offset=function(e){var t=Math.floor(this.selectIndex/2);this.selectIndex<=3?n.offset(this.selectIndex,-e*n.cubeSize.getComponent(t)*2):this.selectIndex%2==1?n.offset(this.selectIndex,-e*n.cubeSize.getComponent(t)*2):n.offset(this.selectIndex,e*n.cubeSize.getComponent(t)*2)},this.setSectionBox=function(e,t){var i=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));i.applyMatrix4(this.scene.getMatrixGlobal()),n.setSectionBox(i.min,i.max)},this.calculateOffsetByBox=function(e,t){var i=new THREE.Box3(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z));i.applyMatrix4(this.scene.getMatrixGlobal()),i.setFromCenterAndSize(i.getCenter(),i.getSize().multiplyScalar(this.scene.getExpandScalar())),n.calculateOffsetByBox(i.min,i.max)},this.moveSectionPlane=function(e,t){n.moveSectionPlane(e,t)},this.rotateSectionBox=function(e,t){n.rotateSectionBox(e,t)},this.rotate=function(e,t){2==this.selectIndex||3==this.selectIndex?n.rotX(t/180*Math.PI*.1):n.rotY(e/180*Math.PI*.1)},this.update=function(e){n.update(e)},this.cancelHighLight=function(){n.cancelHighLight()},this.highLight=function(){n.highLight()},this.setProcess=function(e,t){n.setProcess(e,t)},this.getProcess=function(e){return n.getProcess(e)}},CLOUD.ClipPlanesTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.ClipPlanesTool.prototype.constructor=CLOUD.ClipPlanesTool,CLOUD.ClipPlanesTool.prototype.destroy=function(){this.cameraControl=null,this.intersectPoint=null,this.selectIndex=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null},CLOUD.ClipPlanesTool.prototype.onExit=function(){this.toggle(!1,!1)},CLOUD.ClipPlanesTool.prototype.processMouseDown=function(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=this.scene.getClipPlanes(),n=i.hitTest(t),r=this.cameraControl.getIntersectContext(new THREE.Vector2(e.clientX,e.clientY)),a=this.cameraControl.intersector.intersect(r,null,!0);if(null!=a&&a.distance<=n.distance)return CLOUD.EditTool.prototype.processMouseDown(this,e);if(this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex)return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.enablePick=!0,this.clipStartPoint=t.ray.at(n.distance,this.clipStartPoint),!0}return CLOUD.EditTool.prototype.processMouseDown(this,e)},CLOUD.ClipPlanesTool.prototype.processHover=function(e){if(!this.enablePick){var t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY),n=this.scene.getClipPlanes(),r=this.getSelectIndex();null!==r&&this.cancelHighLight();n.hitTest(i);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),!this.onClipBox){this.onClipBox=!0;var a=this.cameraControl.viewer.modelManager;a.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}t=!0}else if(this.onClipBox){this.onClipBox=!1;var a=this.cameraControl.viewer.modelManager;a.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}return this.selectIndex!==r&&(this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0)),t}return CLOUD.EditTool.prototype.processHover(this,e)},CLOUD.ClipPlanesTool.prototype.processMouseUp=function(e){if(e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY),i=this.scene.getClipPlanes();null!==this.getSelectIndex()&&(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0));i.hitTest(t);if(this.selectIndex=this.getSelectIndex(),null!=this.selectIndex){if(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!this.onClipBox){this.onClipBox=!0;var n=this.cameraControl.viewer.modelManager;n.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!0})}}else if(this.onClipBox){this.onClipBox=!1;var n=this.cameraControl.viewer.modelManager;n.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipBox:!1})}if(this.enablePick)return this.planeDistance=0,this.enablePick=!1,!0}return CLOUD.EditTool.prototype.processMouseUp(this,e)},CLOUD.ClipPlanesTool.prototype.processMouseMove=function(e){if(this.enablePick){if(this.isRotate())this.rotate(e.clientX-this.startPt.x,e.clientY-this.startPt.y),this.startPt.set(e.clientX,e.clientY);else{if(!(e.clientX==this.startPt.x&&e.clientY==this.startPt.y)){var t=this.scene.getClipPlanes(),i=t.clipplanes[this.selectIndex],n=this.cameraControl.movePlane(i,e,this.startPt,!0,this.clipStartPoint);null!=n&&t.offset(this.selectIndex,n),this.startPt.set(e.clientX,e.clientY)}}return this.cameraControl.update(!0),!0}return CLOUD.EditTool.prototype.processMouseMove(this,e)},CLOUD.ClipPlanesTool.prototype.processTouchstart=function(e){
if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),this.enablePick)return CLOUD.EditTool.prototype.processTouchstart(this,e);var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);return this.scene.getClipPlanes().hitTest(t),this.selectIndex=this.getSelectIndex(),this.planeDistance=this.getPlaneDistanceInScreen(),null!=this.selectIndex?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.update(),!0):void 0},CLOUD.ClipPlanesTool.prototype.processTouchmove=function(e){if(null!=this.selectIndex){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{var t=0;t=this.selectIndex<2?e.touches[0].clientX-this.startPt.x:e.touches[0].clientY-this.startPt.y,this.offset(t/this.planeDistance),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),this.update(),!0}return CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.ClipPlanesTool.prototype.processTouchend=function(e){return this.selectIndex=null,this.planeDistance=0,this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),this.update(),CLOUD.EditTool.prototype.processTouchend(this,e)},CLOUD.FillClipPlaneTool=function(e){CLOUD.EditTool.call(this,CLOUD.EditToolMode.CLIP_FILL),this.viewer=e,this.scene=e.getScene(),this.enablePick=!1,this.rotX=!0,this.onClipPlane=!1,this.cameraControl=e.cameraControl,this.startPt=new THREE.Vector2,this.modelManager=this.cameraControl.viewer.modelManager;var t=this.scene.getFillClipPlane();t.updateClippingParams=function(t){if(0==t.iClipPlane.value)e.renderer.clippingPlanes=Object.freeze([]);else{var i=[new THREE.Plane],n=t.vClipPlane.value[0],r=i[0];r.setComponents(-n.x,-n.y,-n.z,-n.w),r.normalize(),e.renderer.clippingPlanes=i,this.renderClipPlane=new THREE.Plane,this.renderClipPlane.setComponents(n.x,n.y,n.z,-n.w),this.renderClipPlane.normalize(),this.calculateFillClipBoundingBox(r.coplanarPoint())}},t.init(),this.planeDistance=0,this.offsetSpeed=.02,this.toggle=function(e,i){t.enable(e,i),t.update()},this.visible=function(e){t.visible=e,t.update()},this.rotatable=function(e){t.rotatable=e,t.update()},this.hit=function(){return t.hit},this.pointToScreen=function(e){var t=this.cameraControl.camera,i=new THREE.Matrix4;i.multiplyMatrices(t.projectionMatrix,t.matrixWorldInverse);var n=new THREE.Vector4(e.x,e.y,e.z,1);n.applyMatrix4(i);var r=new THREE.Vector2;r.x=(n.x/n.w+1)/2,r.y=1-(n.y/n.w+1)/2;var a=this.cameraControl.getContainerDimensions();return r.x=r.x*a.width+a.left,r.y=r.y*a.height+a.top,r},this.getPlaneDistanceInScreen=function(){if(null==this.selectIndex)return null;if(this.selectIndex<2){var e=clipPlanes.center.clone(),t=clipPlanes.center.clone();e.x-=clipPlanes.cubeSize.x,t.x+=clipPlanes.cubeSize.x;var i=this.pointToScreen(e),n=this.pointToScreen(t);return i.x-n.x}var r=clipPlanes.center.clone(),a=clipPlanes.center.clone();a.y-=clipPlanes.cubeSize.y,r.y+=clipPlanes.cubeSize.y;var o=this.pointToScreen(a),s=this.pointToScreen(r);return o.y-s.y},this.getPickPoint=function(e,t){var i=this.cameraControl.camera,n=this.cameraControl.getContainerDimensions(),r=e-n.left,a=t-n.top,o=r/n.width*2-1,s=(n.height-a)/n.height*2-1,l=new CLOUD.Raycaster;return l.setFromCamera(new THREE.Vector2(o,s),i),l.ray.intersectPlane(this.plane)},this._isVisible=function(){return t.visible},this.isRotate=function(){return t.rotatable},this.offset=function(e){t.offset(e)},this.setOffset=function(e){t.setOffset(e)},this.rotate=function(e,i){this.rotX?t.rotX(i/180*Math.PI*.1):t.rotY(e/180*Math.PI*.1)},this.rotateAngleOffset=function(e,i){t.rotateAngleOffset(e,i)},this.setRotateAngle=function(e,i){t.setRotateAngle(e,i)},this.getRotateAngle=function(){return t.getRotateAngle()},this.changeNormal=function(e){t.changeNormal(e)},this.update=function(e){t.update(e)},this.cancelHighLight=function(){t.cancelHighLight()},this.highLight=function(){t.highLight()},this.store=function(){return t.store()},this.restore=function(e){t.restore(e)},this.setProcess=function(e){t.setProcess(e)},this.getProcess=function(){return t.getProcess()}},CLOUD.FillClipPlaneTool.prototype=Object.create(CLOUD.EditTool.prototype),CLOUD.FillClipPlaneTool.prototype.constructor=CLOUD.FillClipPlaneTool,CLOUD.FillClipPlaneTool.prototype.destroy=function(){this.cameraControl=null,this.normal=null,this.plane=null,this.pickHelper=null,this.scene=null,this.viewer=null},CLOUD.FillClipPlaneTool.prototype.onExit=function(){this.toggle(!1,!1)},CLOUD.FillClipPlaneTool.prototype.processMouseDown=function(e){if(this.startPt.set(e.clientX,e.clientY),!this.enablePick&&e.button===THREE.MOUSE.LEFT){var t=this.cameraControl.getRaycaster(e.clientX,e.clientY);if(this.scene.getFillClipPlane().hitTest(t),this.hit())return this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!0}return CLOUD.EditTool.prototype.processMouseDown(this,e)},CLOUD.FillClipPlaneTool.prototype.processMouseUp=function(e){this.planeDistance=0;var t=!1;if(this.enablePick&&e.button===THREE.MOUSE.LEFT)if(this.startPt.x==e.clientX&&this.startPt.y==e.clientY)this.pickHelper.click(e);else{var i=e.shiftKey||e.ctrlKey||e.altKey;if(i){this.endPt.set(e.clientX,e.clientY);var n=CLOUD.OPSELECTIONTYPE.Clear;e.ctrlKey?n=CLOUD.OPSELECTIONTYPE.Add:e.altKey&&(n=CLOUD.OPSELECTIONTYPE.Remove);var r=this;this.scene.pickByRect(this.frustum,n,function(){r.pickHelper.notifySelectionChanged(null,0,e)}),this.cameraControl.updateView(!0),t=!0}}var a=this.cameraControl.getRaycaster(e.clientX,e.clientY);return this.scene.getFillClipPlane().hitTest(a),this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane||(this.onClipPlane=!0,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane&&(this.onClipPlane=!1,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}))),t},CLOUD.FillClipPlaneTool.prototype.processMouseMove=function(e){return this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_MOUSE_MOVE,event:e}),CLOUD.EditTool.prototype.processMouseMove(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchstart=function(e){if(this.startPt.set(e.touches[0].clientX,e.touches[0].clientY),!this.enablePick){var t=this.cameraControl.getRaycaster(e.touches[0].clientX,e.touches[0].clientY);this.scene.getFillClipPlane().hitTest(t)}return this.hit()?(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),!0):CLOUD.EditTool.prototype.processTouchstart(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchmove=function(e){if(this.hit()){if(this.isRotate())this.rotate(e.touches[0].clientX-this.startPt.x,e.touches[0].clientY-this.startPt.y),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY);else{var t=0;t=e.touches[0].clientX-this.startPt.x,this.offset(1*t),this.startPt.set(e.touches[0].clientX,e.touches[0].clientY)}return this.cameraControl.update(!0),!0}return CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.FillClipPlaneTool.prototype.processTouchend=function(e){return this.enablePick&&(this.onUpdateUI({visible:!1}),this.startPt.x==e.touches[0].clientX&&this.startPt.y==e.touches[0].clientY&&this.pickHelper.click(e)),this.cameraControl.needUpdateRenderList(!0),this.cancelHighLight(),this.cameraControl.update(!0),CLOUD.EditTool.prototype.processTouchmove(this,e)},CLOUD.FillClipPlaneTool.prototype.processHover=function(e){if(!this.enablePick){var t=!1,i=this.cameraControl.getRaycaster(e.clientX,e.clientY);return this.scene.getFillClipPlane().hitTest(i),this.hit()?(this.onClipPlane||(this.highLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!0,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!0,event:e})),t=!0):this.onClipPlane?(this.cancelHighLight(),this.cameraControl.needUpdateRenderList(!0),this.cameraControl.update(!0),this.onClipPlane=!1,this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e})):this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_CLIP_HOVER,onClipPlane:!1,event:e}),t}return CLOUD.EditTool.prototype.processHover(this,e)},CLOUD.ClipPlanes=function(e,t){CLOUD.ObjectGroup.call(this,CLOUD.ObjectGroupType.CLIPPLANE,{priority:20});var i=[];i.push("clipPlane_right"),i.push("clipPlane_left"),i.push("clipPlane_top"),i.push("clipPlane_bottom"),i.push("clipPlane_front"),i.push("clipPlane_back"),this.cubeSize=e.clone(),this.center=t.clone(),this.visible=!1,this.rotatable=!1,this.selectIndex=null,this.planeOffset=new Array(6),this.planeRotate=[0,0,0],this.observer=null,this.uniforms={iClipPlane:{type:"i",value:0},vClipPlane:{type:"v4v",value:new Array(new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4,new THREE.Vector4)}},this.clipplanes=null,this.calculation=!0,this.boundingBox=new THREE.Box3,this.calculateClipBoundingBox=function(e){this.boundingBox.makeEmpty();for(var t=0;t<e.length;t++){var i=e[t].coplanarPoint();0!=i.x&&(i.x>this.boundingBox.max.x?this.boundingBox.max.x=i.x:i.x<this.boundingBox.min.x&&(this.boundingBox.min.x=i.x)),0!=i.y&&(i.y>this.boundingBox.max.y?this.boundingBox.max.y=i.y:i.y<this.boundingBox.min.y&&(this.boundingBox.min.y=i.y)),0!=i.z&&(i.z>this.boundingBox.max.z?this.boundingBox.max.z=i.z:i.z<this.boundingBox.min.z&&(this.boundingBox.min.z=i.z))}},this.getClipBoundingBox=function(){return this.boundingBox},this.isVisible=function(){return this.visible},this.getPlaneNormal=function(e){var t=new THREE.Vector4,i=Math.floor(e/2),n=e%2;return t.setComponent(i,Math.pow(-1,n)),t.w=.5*-this.cubeSize.getComponent(i),this.planeOffset[e]=0,t},this.planeMaterial=new CLOUD.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new CLOUD.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.initPlaneModel=function(e){var t=Math.floor(e/2),n=e%2,r=0==t?this.cubeSize.z:this.cubeSize.x,a=1==t?this.cubeSize.z:this.cubeSize.y,o=new THREE.PlaneGeometry(r,a),s=new THREE.Mesh(o,this.planeMaterial);s.name=i[e],s.customTag=!0,s.position.setComponent(t,Math.pow(-1,n)*this.cubeSize.getComponent(t)*.5),0==t?s.rotation.y=Math.pow(-1,n)*Math.PI*.5:1==t&&(s.rotation.x=Math.pow(-1,n)*Math.PI*.5),s.renderOrder=90,this.add(s)},this.initCapsBox=function(){var e=new THREE.BoxBufferGeometry(this.cubeSize.x,this.cubeSize.y,this.cubeSize.z);e.groups=null;var t=new CLOUD.PhongLightingMaterial({color:16776960,side:THREE.DoubleSide}),i=new THREE.Mesh(e,t);return i.matrixWorld=this.matrixWorld,i.matrix=this.matrix,i},this.initWireframes=function(){var e=[.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*-this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*-this.cubeSize.z,.5*-this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*-this.cubeSize.y,.5*this.cubeSize.z,.5*this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z,.5*-this.cubeSize.x,.5*this.cubeSize.y,.5*this.cubeSize.z],t=[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],i=[0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,3,7,1,5,2,6],n=new THREE.BufferGeometry,r=new CLOUD.PhongLightingMaterial({color:1170103,lights:!0});n.setIndex(i),n.addAttribute("position",new THREE.Float32BufferAttribute(e,3)),n.addAttribute("color",new THREE.Float32BufferAttribute(t,3)),n.computeBoundingSphere();var a=new THREE.LineSegments(n,r);a.name="Wireframes",a.customTag=!0,this.add(a)},this.updateClippingParams=function(e){},this.enable=function(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?6:0,this.updateClippingParams(this.uniforms)},this.isEnabled=function(){return 0!==this.uniforms.iClipPlane.value};var n=function(e,t,i,n,r,a,o,s,l,c,u){this.enable=e,this.visible=t,this.rotatable=i,this.calculation=n,this.planeOffset=r.slice(0),this.planeRotate=a.slice(0),this.position=o,this.scale=s,this.quaternion=l,this.cubeSize=c,this.center=u};this.store=function(){return new n(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.calculation,this.planeOffset,this.planeRotate,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone())},this.restore=function(e){this.calculation=!0,this.calculationPlanes(e.cubeSize,e.center),this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.calculation=e.calculation;for(var t=0;t<6;++t)this.planeOffset[t]=e.planeOffset[t];for(var t=0;t<3;++t)this.planeRotate[t]=e.planeRotate[t];this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.update()},this.reset=function(){this.calculation=!0;for(var e=0;e<6;++e)this.planeOffset[e]=0;for(var e=0;e<3;++e)this.planeRotate[e]=0;this.position.copy(this.center),this.scale.copy(new THREE.Vector3(1,1,1)),this.quaternion.copy(new THREE.Quaternion),this.update()},this.calculationPlanes=function(e,t){if(this.calculation){this.cubeSize.copy(e),this.center.copy(t);for(var i=this.children.length,n=i-1;n>=0;--n)this.remove(this.children[n]);for(var n=0;n<6;++n)this.uniforms.vClipPlane.value[n]=this.getPlaneNormal(n),this.initPlaneModel(n);this.initWireframes(),this.clipplanes=this.uniforms.vClipPlane.value.slice(0),this.reset()}},this.update=function(){this.updateMatrixWorld();var e=new THREE.Matrix4;e.getInverse(this.matrix),e.transpose();for(var t=0;t<6;++t)this.uniforms.vClipPlane.value[t]=this.clipplanes[t].clone().applyMatrix4(e);this.updateClippingParams(this.uniforms),this.observer&&this.observer()},this.offset=function(e,t){this.calculation=!1;var i=Math.floor(e/2),n=this.cubeSize.getComponent(i);n*=.5,e%2==0&&this.planeOffset[e]+t>0&&(t=-this.planeOffset[e]),e%2==1&&this.planeOffset[e]+t<0&&(t=-this.planeOffset[e]),this.planeOffset[e]+=t;for(var r=new THREE.Vector3,a=0;a<6;++a){var o=this.clipplanes[a].clone(),s=this.planeOffset[a],l=new THREE.Vector3(o.x*s,o.y*s,o.z*s);r.add(l)}var c=1+r.getComponent(i)/this.cubeSize.getComponent(i);if((c=0==c?1e-5:c)>0){this.scale.setComponent(i,c);var u=this.uniforms.vClipPlane.value[e].clone(),h=new THREE.Vector3(u.x,u.y,u.z);h.normalize();var l=t,d=new THREE.Vector3(h.x*l,h.y*l,h.z*l);e%2==1?this.position.sub(d.multiplyScalar(.5)):this.position.add(d.multiplyScalar(.5)),this.update()}else this.planeOffset[e]-=t};var r=new THREE.Quaternion,a=new THREE.Vector3(1,0,0);this.rotX=function(e){this.calculation=!1,r.setFromAxisAngle(a,e),this.quaternion.multiply(r),this.update()};var o=new THREE.Vector3(0,1,0);this.rotY=function(e){this.calculation=!1,r.setFromAxisAngle(o,e),this.quaternion.multiply(r),this.update()},this.setSectionBox=function(e,t){this.calculation=!0;var i=new THREE.Vector3(t.x-e.x,t.y-e.y,t.z-e.z),n=new THREE.Vector3(.5*(e.x+t.x),.5*(e.y+t.y),.5*(e.z+t.z));this.calculationPlanes(i,n)},this.calculateOffsetByBox=function(e,t){var i=t.x-this.center.x-.5*this.cubeSize.x;i<this.planeOffset[0]?(this.moveSectionPlane("left",this.center.x-.5*this.cubeSize.x-e.x),this.moveSectionPlane("right",i)):(this.moveSectionPlane("right",i),this.moveSectionPlane("left",this.center.x-.5*this.cubeSize.x-e.x));var n=t.y-this.center.y-.5*this.cubeSize.y;n<this.planeOffset[2]?(this.moveSectionPlane("bottom",this.center.y-.5*this.cubeSize.y-e.y),this.moveSectionPlane("top",n)):(this.moveSectionPlane("top",n),this.moveSectionPlane("bottom",this.center.y-.5*this.cubeSize.y-e.y));var r=t.z-this.center.z-.5*this.cubeSize.z;r<this.planeOffset[4]?(this.moveSectionPlane("back",this.center.z-.5*this.cubeSize.z-e.z),this.moveSectionPlane("front",r)):(this.moveSectionPlane("front",r),this.moveSectionPlane("back",this.center.z-.5*this.cubeSize.z-e.z))},this.getPlaneIndexByName=function(e){var t=-1;return"right"==e?t=0:"left"==e?t=1:"top"==e?t=2:"bottom"==e?t=3:"front"==e?t=4:"back"==e&&(t=5),t},this.moveSectionPlane=function(e,t){var i=this.getPlaneIndexByName(e);if(-1!=i){i%2!=0&&(t=-t);var n=t-this.planeOffset[i];this.offset(i,n)}},this.setProcess=function(e,t){var i=this.getPlaneIndexByName(e),n=0;if(i<2?n=this.cubeSize.x:i<4?n=this.cubeSize.y:i<6&&(n=this.cubeSize.z),t>1?t=1:t<0&&(t=0),-1!=i){i%2!=1&&(t=-t);var r=t*n-this.planeOffset[i];this.offset(i,r)}},this.getProcess=function(e){var t=this.getPlaneIndexByName(e);-1==t&&console.log("faceName is illegal");var i=0;t<2?i=this.cubeSize.x:t<4?i=this.cubeSize.y:t<6&&(i=this.cubeSize.z);var n=1;t%2!=1&&(n=-1);var r=n*this.planeOffset[t]/i;return r>1?r=1:r<0&&(r=0),r};var s=new THREE.Vector3(0,0,1);this.rotateSectionBox=function(e,t){"x"==e?this.planeRotate[0]=t:"y"==e?this.planeRotate[1]=t:"z"==e&&(this.planeRotate[2]=t),this.calculation=!0;var i=new THREE.Quaternion;i.setFromAxisAngle(a,this.planeRotate[0]);var n=new THREE.Quaternion;n.setFromAxisAngle(o,this.planeRotate[1]);var r=new THREE.Quaternion;r.setFromAxisAngle(s,this.planeRotate[2]);var l=new THREE.Quaternion;l.multiply(i),l.multiply(n),l.multiply(r),this.quaternion.copy(l),this.update()},this.highLight=function(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeHighLightMatrial)},this.cancelHighLight=function(){null!=this.selectIndex&&(this.children[this.selectIndex].material=this.planeMaterial,this.selectIndex=null)}},CLOUD.ClipPlanes.prototype=Object.create(CLOUD.ObjectGroup.prototype),CLOUD.ClipPlanes.prototype.constructor=CLOUD.ClipPlanes,CLOUD.ClipPlanes.prototype.init=function(){this.calculationPlanes(this.cubeSize,this.center)},CLOUD.ClipPlanes.prototype.hitTest=function(e){var t=null,i=null;if(this.raycast(e),null!=this.selectIndex){var n=e.ray,r=new THREE.Plane,a=this.uniforms.vClipPlane.value[this.selectIndex];r.setComponents(a.x,a.y,a.z,a.w),t=n.distanceToPlane(r),i=n.direction.dot(r.normal)<0}return{sign:i,distance:t}},CLOUD.ClipPlanes.prototype.raycast=function(e){if(this.visible){var t=[],i=null;this.selectIndex=null;for(var n=0;n<6;n++)if(this.children[n].raycast(e,t),t.length>0){var r=t.pop();(!i||r.distance<i.distance)&&(i=r,this.selectIndex=n),t=[]}}},CLOUD.FillClipPlane=function(e,t){CLOUD.ObjectGroup.call(this,CLOUD.ObjectGroupType.FILLCLIPPLANE,{priority:20}),this.cubeSize=e.clone(),this.originBoundingBox=(new THREE.Box3).setFromCenterAndSize(t,e),this.boundingBox=this.originBoundingBox.clone(),this.center=t.clone(),this.length=Math.max(this.cubeSize.x,Math.max(this.cubeSize.y,this.cubeSize.z)),this.planeOffset=0,this.normalIndex=3,this.visible=!1,this.rotatable=!1,this.hit=!1,this.clipplane=new THREE.Vector4,this.observer=null,this.renderClipPlane=new THREE.Plane,this.angleA=0,this.angleB=0,this.uniforms={iClipPlane:{value:0},vClipPlane:{value:new Array(new THREE.Vector4)}},this.planeMaterial=new CLOUD.PhongLightingMaterial({color:16777215,opacity:0,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.planeHighLightMatrial=new CLOUD.PhongLightingMaterial({color:1170103,opacity:.1,transparent:!0,side:THREE.DoubleSide,lights:!0}),this.initPlaneModel=function(){for(var e=this.children.length,t=e-1;t>=0;--t)this.remove(this.children[t]);this.planeOffset=0;var i=this.length,n=new THREE.PlaneGeometry(i,i),r=new THREE.Mesh(n,this.planeMaterial);r.name="fillClipPlane",r.customTag=!0,r.renderOrder=90,this.position.copy(this.center),this.clipplane.set(0,0,1,0),this.planeMesh=r,this.add(r)},this.initWireframes=function(){var e=.5*this.length,t=[-e,e,0,e,e,0,-e,-e,0,e,-e,0],i=[0,1,1,3,3,2,2,0],n=new THREE.BufferGeometry,r=new CLOUD.PhongLightingMaterial({color:1170103,lights:!0});n.setIndex(i),n.addAttribute("position",new THREE.Float32BufferAttribute(t,3));var a=new THREE.LineSegments(n,r);a.name="Wireframes",a.customTag=!0,this.wireframeMesh=a,this.add(a)},this.getCoordinate=function(){var e=.5*this.length,t=new THREE.Vector3(-e,e,0);t.applyMatrix4(this.matrix);var i=new THREE.Vector3(e,e,0);i.applyMatrix4(this.matrix);var n=new THREE.Vector3(-e,-e,0);return n.applyMatrix4(this.matrix),{axisX:t.clone().sub(i).normalize(),axisY:t.clone().sub(n).normalize()}},this.initCapsPlane=function(){if(this.capPlane)return this.capPlane;var e=this.length,t=new THREE.PlaneGeometry(e,e),i=new CLOUD.PhongLightingMaterial({color:6380315,side:THREE.DoubleSide}),n=new THREE.Mesh(t,i),r=this.planeMesh;n.matrixWorld=r.matrixWorld,n.matrix=this.matrix;for(var a=.5*this.length,o=[],s=a-5;s>-a;s-=5)o.push(s,a,0),o.push(a,s,0);for(var s=5-a;s<a;s+=5)o.push(-a,s,0),o.push(s,-a,0);var l=new THREE.LineMaterial({color:2236962});l.linewidth=1,l.resolution.set(window.innerWidth,window.innerHeight),l.depthTest=!1;var c=new THREE.LineSegmentsGeometry;c.setPositions(o);var u=new THREE.LineSegments2(c,l);return u.matrix=this.matrix,u.matrixWorld=r.matrixWorld,this.capPlane={planeMesh:n,lineMesh:u},this.capPlane},this.updateClippingParams=function(e){},this.getFillClipBoundingBox=function(){return this.boundingBox},this.calculateFillClipBoundingBox=function(e){this.boundingBox=this.originBoundingBox.clone(),0!=this.clipplane.x?1==this.clipplane.x?this.boundingBox.max.x=e.x:this.boundingBox.min.x=e.x:0!=this.clipplane.y?1==this.clipplane.y?this.boundingBox.max.y=e.y:this.boundingBox.min.y=e.y:0!=this.clipplane.z&&(1==this.clipplane.z?this.boundingBox.max.z=e.z:this.boundingBox.min.z=e.z)},this.enable=function(e,t){this.visible=t,this.uniforms.iClipPlane.value=e?1:0,this.update()},this.isEnabled=function(){return 0!=this.uniforms.iClipPlane.value},this.update=function(){this.updateMatrixWorld();var e=new THREE.Matrix4;e.getInverse(this.matrix),e.transpose(),this.uniforms.vClipPlane.value[0]=this.clipplane.clone().applyMatrix4(e),this.updateClippingParams(this.uniforms),this.observer&&this.observer()},this.getClipPlane=function(){return this.clipplane.clone()},this.offset=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset+=e,Math.abs(this.planeOffset)>.5*t&&(this.planeOffset=this.planeOffset>0?.5*t:.5*-t);var i=this.uniforms.vClipPlane.value[0].clone(),n=new THREE.Vector3(i.x,i.y,i.z);n.normalize();var r=new THREE.Vector3(n.x*this.planeOffset,n.y*this.planeOffset,n.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.setOffset=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),this.planeOffset=e,Math.abs(e)>.5*t&&(this.planeOffset=e>0?.5*t:.5*-t);var i=this.uniforms.vClipPlane.value[0].clone(),n=new THREE.Vector3(i.x,i.y,i.z);n.normalize();var r=new THREE.Vector3(n.x*this.planeOffset,n.y*this.planeOffset,n.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.changeNormal=function(e){this.quaternion.set(0,0,0,1),this.angleA=0,this.angleB=0,this.setNormal(e)},this.setNormal=function(e){var t=this.planeMesh,i=this.wireframeMesh;0==e?(this.clipplane.set(1,0,0,0),t.rotation.set(0,Math.PI/2,0),i.rotation.set(0,Math.PI/2,0)):1==e?(this.clipplane.set(-1,0,0,0),t.rotation.set(0,-Math.PI/2,0),i.rotation.set(0,-Math.PI/2,0)):2==e?(this.clipplane.set(0,0,-1,0),t.rotation.set(Math.PI,0,0),i.rotation.set(Math.PI,0,0)):3==e?(this.clipplane.set(0,0,1,0),t.rotation.set(0,0,0),i.rotation.set(0,0,0)):4==e?(this.clipplane.set(0,1,0,0),t.rotation.set(-Math.PI/2,0,0),i.rotation.set(-Math.PI/2,0,0)):5==e&&(this.clipplane.set(0,-1,0,0),t.rotation.set(Math.PI/2,0,0),i.rotation.set(Math.PI/2,0,0)),this.normalIndex=e,t.updateMatrixWorld(),i.updateMatrixWorld(),this.capPlane&&(this.capPlane.planeMesh.matrixWorld=t.matrixWorld,this.capPlane.lineMesh.matrixWorld=t.matrixWorld),this.update()};var i=new THREE.Quaternion,n=new THREE.Vector3(1,0,0);this.rotX=function(e){i.setFromAxisAngle(n,e),this.quaternion.multiply(i),this.update()};var r=new THREE.Vector3(0,1,0);this.rotY=function(e){i.setFromAxisAngle(r,e),this.quaternion.multiply(i),this.update()};var a=new THREE.Vector3(0,0,1);this.rotateByAxis=function(e,t){i.setFromAxisAngle(e,t),this.quaternion.multiply(i)},this.rotateAngleOffset=function(e,t){var i=this.normalIndex;e=e%360/180*Math.PI,0==i||1==i?("y"==t&&this.rotateByAxis(a,e),"z"==t&&this.rotateByAxis(r,e)):2==i||3==i?("x"==t&&this.rotateByAxis(n,e),"z"==t&&this.rotateByAxis(r,e)):4!=i&&5!=i||("x"==t&&this.rotateByAxis(n,e),"y"==t&&this.rotateByAxis(a,e)),this.update()},this.setRotateAngle=function(e,t){this.quaternion.set(0,0,0,1);var i=this.normalIndex;e=void 0==e?this.angleA:e%360,t=void 0==t?this.angleB:t%360,e=e<0?360+e:e,t=t<0?360+t:t,this.angleA=e,this.angleB=t,e=e/180*Math.PI,t=t/180*Math.PI,0==i||1==i?(e=0==i?-e:e,t=0==i?t:-t,this.rotateByAxis(a,e),this.rotateByAxis(r,t)):2==i||3==i?(this.rotateByAxis(n,e),this.rotateByAxis(r,t)):4!=i&&5!=i||(e=3==i?-e:e,t=3==i?t:-t,this.rotateByAxis(n,e),this.rotateByAxis(a,t)),this.update()},this.getRotateAngle=function(){return{angleA:this.angleA,angleB:this.angleB}},this.highLight=function(){this.planeMesh.material=this.planeHighLightMatrial},this.cancelHighLight=function(){this.planeMesh.material=this.planeMaterial,this.hit=!1};var o=function(e,t,i,n,r,a,o,s,l,c){this.enable=e,this.visible=t,this.rotatable=i,this.planeOffset=n,this.position=r,this.scale=a,this.quaternion=o,this.cubeSize=s,this.center=l,this.normalIndex=c};this.store=function(){return new o(!!this.uniforms.iClipPlane.value,this.visible,this.rotatable,this.planeOffset,this.position.clone(),this.scale.clone(),this.quaternion.clone(),this.cubeSize.clone(),this.center.clone(),this.normalIndex)},this.restore=function(e){this.enable(e.enable,e.visible),this.rotatable=e.rotatable,this.planeOffset=e.planeOffset,this.position.copy(e.position),this.scale.copy(e.scale),this.quaternion._w=e.quaternion._w,this.quaternion._x=e.quaternion._x,this.quaternion._y=e.quaternion._y,this.quaternion._z=e.quaternion._z,this.normalIndex=void 0==e.normalIndex?this.normalIndex:e.normalIndex,this.setNormal(this.normalIndex)},this.setProcess=function(e){var t=0;this.normalIndex<2?t=this.cubeSize.x:this.normalIndex<4?t=this.cubeSize.z:this.normalIndex<6&&(t=this.cubeSize.y),e>1?e=1:e<-1&&(e=-1),this.planeOffset=e*t*.5;var i=this.uniforms.vClipPlane.value[0].clone(),n=new THREE.Vector3(i.x,i.y,i.z);n.normalize();var r=new THREE.Vector3(n.x*this.planeOffset,n.y*this.planeOffset,n.z*this.planeOffset);this.position.copy(this.center).add(r),this.update()},this.restoreRotation=function(){this.quaternion.set(0,0,0,1),this.update()},this.getProcess=function(){var e=0;return this.normalIndex<2?e=this.cubeSize.x:this.normalIndex<4?e=this.cubeSize.z:this.normalIndex<6&&(e=this.cubeSize.y),this.planeOffset/e*2}},CLOUD.FillClipPlane.prototype=Object.create(CLOUD.ObjectGroup.prototype),CLOUD.FillClipPlane.prototype.constructor=CLOUD.FillClipPlane,CLOUD.FillClipPlane.prototype.init=function(){this.initPlaneModel(),this.initWireframes()},CLOUD.FillClipPlane.prototype.hitTest=function(e){if(!this.visible)return void(this.hit=!1);var t=null,i=null;if(this.hit=this.raycast(e),this.hit){var n=e.ray,r=new THREE.Plane,a=this.uniforms.vClipPlane.value[0];r.setComponents(a.x,a.y,a.z,a.w),t=n.distanceToPlane(r),i=n.direction.dot(r.normal)<0}return{sign:i,distance:t}},CLOUD.FillClipPlane.prototype.raycast=function(e,t){var i=[];return this.planeMesh.raycast(e,i),i.length>0},CLOUD.ClipPlaneService=function(e){this.viewer=e},CLOUD.ClipPlaneService.prototype={construtor:CLOUD.ClipPlaneService,destroy:function(){this.viewer=null},update:function(e){var t=this.getEditor();t&&(t.update(e),this.viewer.render())},getEditor:function(){for(var e=this.viewer.editorManager.tools,t=0;t<e.length;t++)if(e[t].getName()==CLOUD.EditToolMode.CLIP_BY_BOX)return e[t];return null},setSectionBox:function(e,t){this.getEditor().setSectionBox(e,t)},toggle:function(e,t){this.getEditor().toggle(e,t)},setVisible:function(e){this.getEditor().visible(e)},setRotatable:function(e){this.getEditor().rotatable(e)},enablePick:function(e){this.getEditor().enablePick=e},saveState:function(){return this.getEditor().store()},loadState:function(e){this.getEditor().restore(e)},reset:function(){this.viewer.getScene().resetClipPlanes()},recalculate:function(){return this.viewer.getFilter().getVisibleComponentsBbox()},setProcess:function(e,t){this.getEditor().setProcess(e,t)},getProcess:function(e){return this.getEditor().getProcess(e)}};var Walkthrough=function(){function e(t){_classCallCheck(this,e),this.name=t||"",this.keyFrameList=[],this.walkthroughTime=5,this.interpolateType=0,this.fps=60,this.parts=100,this.rotateSpeed=Math.PI/this.fps/4,this.parameters={segments:this.walkthroughTime*this.fps*this.parts,closed:!1,curveType:"centripetal",tension:.25},this.modificationId=0,this.mapDeltaAngle={},this.mapDeltaOffset={},this.allocateSegmentList=null}return _createClass(e,[{key:"addKeyFrame",value:function(e){var t=new THREE.Vector3(e.position.x,e.position.y,e.position.z),i=new THREE.Vector3(e.target.x,e.target.y,e.target.z);this.keyFrameList.push({position:t,target:i,id:e.id}),this.modificationId++}},{key:"setKeyFrameList",value:function(e){this.keyFrameList=[];for(var t=0,i=e.length;t<i;t++)this.addKeyFrame(e[t])}},{key:"removeKeyFrame",value:function(e){var t=this.keyFrameList.length;e>=0&&e<t&&(this.keyFrameList.splice(e,1),this.modificationId++)}},{key:"getKeyFrames",value:function(){return this.keyFrameList}},{key:"getKeyFrameCount",value:function(){return this.keyFrameList.length}},{key:"clearFrames",value:function(){this.keyFrameList=[]}},{key:"getJumpCounts",value:function(e){var t=e/(1e3/this.fps)*this.parts;return t=parseInt(t)}},{key:"setWalkthroughTime",value:function(e){this.walkthroughTime=e,this.setSegments(e*this.fps*this.parts)}},{key:"setInterpolateType",value:function(e){this.interpolateType=e,1==e&&this.setSplineTension(0)}},{key:"getInterpolateType",value:function(){return this.interpolateType}},{key:"setName",value:function(e){this.name=e}},{key:"getName",value:function(){return this.name}},{key:"getKeyFramePositions",value:function(){for(var e=[],t=0,i=this.keyFrameList.length;t<i;t++){var n=this.keyFrameList[t];e.push(n.position)}return e}},{key:"getKeyFramePosition",value:function(e){return this.keyFrameList[e].position}},{key:"getKeyFrameDirection",value:function(e){var t=this.keyFrameList[e];return t.target.clone().sub(t.position)}},{key:"getKeyFrameTarget",value:function(e){return this.keyFrameList[e].target}},{key:"allocateSegments",value:function(){for(var e=[],t=0,i=this.keyFrameList.length;t<i-1;t++){var n=this.keyFrameList[t].position,r=this.keyFrameList[t+1].position;e.push(r.clone().sub(n).length())}for(var a=0,o=0,i=e.length;o<i;o++)a+=e[o];for(var s=this.getSegments(),l=0,i=e.length;0!=a&&l<i;l++)e[l]/=a,e[l]*=this.getSegments(),e[l]=Math.floor(e[l]),s-=e[l];for(var c=0;c<s;c++)e[c]>0&&e[c]++;this.allocateSegmentList=e}},{key:"getAllocateSegmentCount",value:function(e){return null==this.allocateSegmentList&&this.allocateSegments(),this.allocateSegmentList[e]}},{key:"getSplineParam",value:function(e,t){null==this.allocateSegmentList&&this.allocateSegments();var i=this.allocateSegmentList.length;return(e+t/this.allocateSegmentList[e])/i}},{key:"getDeltaAngle",value:function(e){return this.mapDeltaAngle[e]}},{key:"calculateDeltaAngle",value:function(){for(var e=this.allocateSegmentList,t=0;t<e.length;t++){var i=this.getKeyFrameDirection(t),n=this.getKeyFrameDirection(t+1),r=i.angleTo(n),a=e[t];if(0==a){var o=Math.floor(r/this.rotateSpeed)*this.parts;e[t]=o,this.mapDeltaAngle[t]=r/o}else this.mapDeltaAngle[t]=r/a}}},{key:"getRotateAxis",value:function(e){
var t=this.getKeyFrameDirection(e),i=this.getKeyFrameDirection(e+1);return t.clone().cross(i.clone()).normalize()}},{key:"getDeltaOffset",value:function(e){return this.mapDeltaOffset[e]}},{key:"calculateDeltaOffset",value:function(){for(var e=this.allocateSegmentList,t=0;t<e.length;t++){var i=this.getKeyFramePositions(),n=i[t],r=i[t+1],a=this.allocateSegmentList[t];this.mapDeltaOffset[t]=0==a?new THREE.Vector3:r.clone().sub(n).divideScalar(a)}}},{key:"setSplineTension",value:function(e){e>=0&&e<=1&&(this.parameters.tension=e,this.modificationId++)}},{key:"setSegments",value:function(e){this.parameters.segments=e,this.modificationId++}},{key:"getSegments",value:function(){return this.parameters.segments}},{key:"setParameters",value:function(e){this.parameters=e,this.modificationId++}},{key:"getParameters",value:function(){return this.parameters}},{key:"setFps",value:function(e){this.fps=e,this.modificationId++}},{key:"getModificationId",value:function(){return this.modificationId}}]),e}();CLOUD.Walkthrough=Walkthrough;var WalkthroughPlayer=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.walkthrough=null,this.bPause=!1,this.bContinue=!1,this.bStop=!1,this.spline=null,this.reqid=0,this.playBinded=this.play.bind(this),this.recordId=-1,this.keyFrameIdx=0,this.count=-1,this.camera=this.viewer.cameraControl.camera,this.pausePlayCallback=null,this.stopPlayCallback=null,this.timeRecorder={last:0,pause:0,deltaTime:0},this.keyFrameCallback=null}return _createClass(e,[{key:"setWalkthrough",value:function(e){this.walkthrough=e,this.bPause=!1,this.recordId=-1,this.spline=null,this.keyFrameIdx=0,this.count=-1}},{key:"updateCamera",value:function(e,t){this.camera.position.add(e),this.camera.target.addVectors(this.camera.position,t)}},{key:"play",value:function(){this.reqid=requestAnimationFrame(this.playBinded),0==this.bContinue?(this.bContinue=!0,this.timeRecorder.deltaTime=this.timeRecorder.pause-this.timeRecorder.last):this.timeRecorder.deltaTime=performance.now()-this.timeRecorder.last,this.timeRecorder.last=performance.now();var e=this.walkthrough.getJumpCounts(this.timeRecorder.deltaTime);if(this.recordId!==this.walkthrough.getModificationId()&&(this.walkthrough.allocateSegments(),this.walkthrough.calculateDeltaOffset(),this.walkthrough.calculateDeltaAngle(),this.recordId=this.walkthrough.getModificationId()),this.bPause)return this.timeRecorder.pause=performance.now(),console.log("Walkthrough pause now,key frame index is "+this.keyFrameIdx),cancelAnimationFrame(this.reqid),this.pausePlayCallback&&this.pausePlayCallback(),this.bPause=!1,void(this.bContinue=!1);var t=this.walkthrough.getKeyFrameCount(),i=this.walkthrough.getAllocateSegmentCount(this.keyFrameIdx);if(0==i)this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=-1;else{if(this.bStop||this.keyFrameIdx==t-1)return this.bStop=!1,this.keyFrameIdx=0,this.count=-1,console.log("Time cost "+(performance.now()-this.timeStart)+"ms."),cancelAnimationFrame(this.reqid),void(this.stopPlayCallback&&this.stopPlayCallback());if(-1==this.count){this.timeStart=performance.now(),0==this.keyFrameIdx&&this.triggerKeyFrameCallback(0);var n=this.walkthrough.getKeyFramePosition(this.keyFrameIdx),r=this.walkthrough.getKeyFrameTarget(this.keyFrameIdx);this.camera.position.copy(n),this.camera.target.copy(r),this.count=0}else if(this.count<i){this.count+e>i&&(e=i-this.count);var a=this.walkthrough.getDeltaOffset(this.keyFrameIdx),o=this.walkthrough.getDeltaAngle(this.keyFrameIdx),s=this.walkthrough.getRotateAxis(this.keyFrameIdx),l=new THREE.Vector3;l.subVectors(this.camera.target.clone(),this.camera.position),0==isNaN(s.length())&&l.applyAxisAngle(s,o*e),this.count+e==i?(this.keyFrameIdx++,this.triggerKeyFrameCallback(this.keyFrameIdx),this.count=0):this.count+=e,this.updateCamera(a.clone().multiplyScalar(e),l)}}this.viewer.render()}},{key:"pause",value:function(){this.bPause=!0}},{key:"stop",value:function(e){this.bStop=e}},{key:"startFrom",value:function(e){for(var t=this.walkthrough,i=t.getKeyFrameCount(),n=t.getKeyFrames(),r=0;r<i;r++)if(n[r].id==e)return this.keyFrameIdx=r,void(this.count=-1)}},{key:"setKeyFrameCallback",value:function(e){this.keyFrameCallback=e}},{key:"triggerKeyFrameCallback",value:function(e){this.keyFrameCallback&&this.keyFrameCallback(e)}},{key:"addPausePlayCallback",value:function(e){this.pausePlayCallback=e}},{key:"addStopPlayCallback",value:function(e){this.stopPlayCallback=e}},{key:"updataSpline",value:function(){var e=this.walkthrough.getKeyFramePositions(),t=this.walkthrough.getParameters();this.spline=new THREE.CatmullRomCurve3(e,t.closed,t.curveType,t.tension)}}]),e}();CLOUD.WalkthroughPlayer=WalkthroughPlayer;var WalkthroughManager=function(){function e(){_classCallCheck(this,e),this.walkthroughList=[]}return _createClass(e,[{key:"clear",value:function(){this.walkthroughList=[]}},{key:"add",value:function(e){this.walkthroughList.push(e)}},{key:"remove",value:function(e){for(var t=0,i=this.walkthroughList.length;t<i;t++){if(this.walkthroughList[t].getName()==e)return void this.walkthroughList.splice(t,1)}}},{key:"save",value:function(){return JSON.stringify(this.walkthroughList)}},{key:"load",value:function(e){this.clear();for(var t=JSON.parse(e),i=0,n=t.length;i<n;i++){var r=new CLOUD.Walkthrough;r.setName(t[i].name),r.setKeyFrameList(t[i].keyFrameList),r.setParameters(t[i].parameters),r.setWalkthroughTime(t[i].walkthroughTime),r.setInterpolateType(t[i].type),r.setFps(t[i].fps),this.add(r)}return this.walkthroughList}}]),e}();CLOUD.WalkthroughManager=WalkthroughManager;var ImageBasedLighting=ImageBasedLighting||{};ImageBasedLighting.brdf_vs=["varying vec2 vUV;","void main() {","\tvUV = uv;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.brdf_fs=["varying vec2 vUV;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float GGX(float NdotV, float alpha)","{","\tfloat alpha2 = pow(alpha, 2.0);","\treturn 2.0 * NdotV / (NdotV + sqrt(alpha2 + (1.0 - alpha2) * NdotV * NdotV));","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\treturn GGX(NdotV, alpha) * GGX(NdotL, alpha);","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness)","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","vec2 IntegrateBRDF(float NdotV, float roughness)","{","\tvec3 N = vec3(0.0, 0.0, 1.0);","\tvec3 V = vec3(sqrt(1.0 - NdotV * NdotV), 0.0, NdotV);","\tvec2 result = vec2(0.0, 0.0);","\tconst int NumSamples = 1024;","\tfor (int i = 0; i < NumSamples; i++)","\t{","\t\tfloat u = float(i) / float(NumSamples);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = 2.0 * dot(V, H) * H - V;","\t\tfloat NdotL = saturate(L.z);","\t\tfloat NdotH = saturate(H.z);","\t\tfloat VdotH = saturate(dot(V, H));","\t\tfloat NdotV = saturate(dot(N, V));","\t\tif (NdotL > 0.0)","\t\t{","\t\t\tfloat G = G_Smith(NdotV, NdotL, roughness);","\t\t\tfloat G_Vis = G * VdotH / (NdotH * NdotV); ","\t\t\tfloat F = pow(1.0 - VdotH, 5.0);","\t\t\tresult.x += (1.0 - F) * G_Vis;","\t\t\tresult.y += F * G_Vis;","\t\t}","\t}","\treturn result / float(NumSamples);","}","void main()","{","\tvec2 brdf = IntegrateBRDF(vUV.x, vUV.y);","\tgl_FragColor = vec4(brdf, 0.0, 1.0);","}"].join("\n"),ImageBasedLighting.BRDFMap=function(e,t){this.texture=null,this.resolution=t||512,this.brdfMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.brdf_vs,fragmentShader:ImageBasedLighting.brdf_fs,uniforms:{HammersleyTable:{value:e}},lights:!1}),this.quad=new THREE.Mesh(new THREE.PlaneBufferGeometry(window.innerWidth,window.innerHeight),this.brdfMaterial),this.quad.position.z=-100},ImageBasedLighting.BRDFMap.prototype.constructor=ImageBasedLighting.BRDFMap,ImageBasedLighting.BRDFMap.prototype.generateMap=function(e){var t=new THREE.Scene;t.add(this.quad);var i=new THREE.OrthographicCamera(window.innerWidth/-2,window.innerWidth/2,window.innerHeight/2,window.innerHeight/-2,-1e4,1e4);i.position.z=100;var n=new THREE.WebGLRenderTarget(this.resolution,this.resolution,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBFormat});e.render(t,i,n,!0),this.texture=n.texture},THREE.HDRCubeTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},THREE.HDRCubeTextureLoader.prototype.load=function(e,t,i,n,r){var a=function(e,t,i,n){var r=e[t+3],a=Math.pow(2,r-128)/255;i[n+0]=e[t+0]*a,i[n+1]=e[t+1]*a,i[n+2]=e[t+2]*a},o=function(){function e(e){t[0]=e;var n=i[0],r=n>>16&32768,a=n>>12&2047,o=n>>23&255;return o<103?r:o>142?(r|=31744,r|=(255==o?0:1)&&8388607&n):o<113?(a|=2048,r|=(a>>114-o)+(a>>113-o&1)):(r|=o-112<<10|a>>1,r+=1&a)}var t=new Float32Array(1),i=new Int32Array(t.buffer);return function(t,i,n,r){var a=t[i+3],o=Math.pow(2,a-128)/255;n[r+0]=e(t[i+0]*o),n[r+1]=e(t[i+1]*o),n[r+2]=e(t[i+2]*o)}}(),s=new THREE.CubeTexture;s.type=e,s.encoding=e===THREE.UnsignedByteType?THREE.RGBEEncoding:THREE.LinearEncoding,s.format=e===THREE.UnsignedByteType?THREE.RGBAFormat:THREE.RGBFormat,s.minFilter=s.encoding===THREE.RGBEEncoding?THREE.NearestFilter:THREE.LinearFilter,s.magFilter=s.encoding===THREE.RGBEEncoding?THREE.NearestFilter:THREE.LinearFilter,s.generateMipmaps=s.encoding!==THREE.RGBEEncoding,s.anisotropy=0;for(var l=this.hdrLoader,c=this.manager,u=0,h=0;h<t.length;h++)!function(i,n,r,h){var d=new THREE.FileLoader(c);d.setResponseType("arraybuffer"),d.load(t[i],function(t){u++;var r=l._parser(t);if(r){if(e===THREE.FloatType){for(var c=r.data.length/4*3,h=new Float32Array(c),d=0;d<c;d++)a(r.data,4*d,h,3*d);r.data=h}else if(e===THREE.HalfFloatType){for(var c=r.data.length/4*3,f=new Uint16Array(c),d=0;d<c;d++)o(r.data,4*d,f,3*d);r.data=f}if(void 0!==r.image)s[i].images=r.image;else if(void 0!==r.data){var p=new THREE.DataTexture(r.data,r.width,r.height);p.format=s.format,p.type=s.type,p.encoding=s.encoding,p.minFilter=s.minFilter,p.magFilter=s.magFilter,p.generateMipmaps=s.generateMipmaps,s.images[i]=p}6===u&&(s.needsUpdate=!0,n&&n(s))}},r,h)}(h,i,n,r);return s},ImageBasedLighting.HDRTextureLoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager,this.hdrLoader=new THREE.RGBELoader},ImageBasedLighting.HDRTextureLoader.prototype.load=function(e,t,i,n){var r=new THREE.DataTexture;return this.hdrLoader.load(e,function(e,i){e.flipY=!0,e.type=THREE.FloatType,e.format=THREE.RGBFormat,e.minFilter=THREE.LinearFilter,e.magFilter=THREE.LinearFilter;for(var n=e.image.width*e.image.height*3,a=new Float32Array(n),o=0;o<n;o++)!function(e,t,i,n){var r=e[t+3],a=Math.pow(2,r-128)/256;i[n+0]=e[t+0]*a,i[n+1]=e[t+1]*a,i[n+2]=e[t+2]*a}(e.image.data,4*o,a,3*o);e.image.data=a,r=e,t&&t(r)},i,n),r},ImageBasedLighting.equirectangular_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.equirectangular_fs=["varying vec3 pos;","uniform sampler2D map;","const float PI = 3.14159265358979;","const float INV_PI = 1.0 / PI;","vec2 sampleSphericalMap(vec3 v)","{","\tvec2 uv = vec2(atan(v.z, v.x), asin(v.y));","\tuv *= vec2(INV_PI * 0.5, INV_PI);","\tuv += 0.5;","\treturn uv;","}","void main() {","\tvec2 uv = sampleSphericalMap(normalize(pos));","\tvec4 color = texture2D(map, uv);","\tgl_FragColor = vec4(color.rgb, 1.0);","}"].join("\n"),ImageBasedLighting.EquirectangularMaterial=function(e){THREE.ShaderMaterial.call(this),this.type="EquirectangularMaterial",this.map=null,this.lights=!1,this.side=THREE.BackSide,this.defines={},this.uniforms=THREE.UniformsUtils.merge([{map:{value:null}}]),this.vertexShader=ImageBasedLighting.equirectangular_vs,this.fragmentShader=ImageBasedLighting.equirectangular_fs,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e)),this.refreshUniforms()},ImageBasedLighting.EquirectangularMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),ImageBasedLighting.EquirectangularMaterial.prototype.constructor=ImageBasedLighting.EquirectangularMaterial,ImageBasedLighting.EquirectangularMaterial.prototype.isShaderMaterial=!0,ImageBasedLighting.EquirectangularMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.map=e.map,this},ImageBasedLighting.EquirectangularMaterial.prototype.refreshUniforms=function(){this.uniforms.map.value=this.map},ImageBasedLighting.HDRToCubeMap=function(e,t,i,n){var r=new THREE.CubeCamera(.1,10,n||512);if(i){var a={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};r.renderTarget=new THREE.WebGLRenderTargetCube(n||512,n||512,a)}var o=new THREE.Scene,s=new EquirectangularMaterial({map:e}),l=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),s);return o.add(l),r.updateCubeMap(t,o),r.renderTarget.texture},ImageBasedLighting.IBLMaps=function(e,t,i){this.environmentMap=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,e&&this.loadMaps(e,t,i)},ImageBasedLighting.IBLMaps.prototype.constructor=ImageBasedLighting.IBLMaps,ImageBasedLighting.IBLMaps.prototype.loadMaps=function(e,t,i){t?this.loadHDRMaps(e,i):this.loadJPGMaps(e,i)},ImageBasedLighting.IBLMaps.prototype.loadHDRMaps=function(e,t){for(var i=this,n=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],r=[],a=0;a<6;++a)r.push(e+"/EnvMap_"+n[a]);var o=new THREE.HDRCubeTextureLoader;o.load(THREE.FloatType,r,function(r){i.environmentMap=r;for(var a=[],s=0;s<6;++s)a.push(e+"/IrradianceMap_"+n[s]);o.load(THREE.FloatType,a,function(r){i.irradianceMap=r;for(var a=[],s=0;s<6;++s)a.push(e+"/PrefilterMap_"+n[s]);o.load(THREE.FloatType,a,function(n){i.prefilterMap=n;var r=new ImageBasedLighting.HDRTextureLoader,a=e+"/brdf.hdr";r.load(a,function(e){i.brdfMap=e,t(i,!0)})})})})},ImageBasedLighting.IBLMaps.prototype.loadJPGMaps=function(e,t){for(var i=this,n=["posx.jpg","negx.jpg","posy.jpg","negy.jpg","posz.jpg","negz.jpg"],r=[],a=0;a<6;++a)r.push(e+"/EnvMap_"+n[a]);var o=new THREE.CubeTextureLoader;o.setCrossOrigin("anonymous"),o.load(r,function(e){i.environmentMap=e,t(i,!1)})},ImageBasedLighting.IBLMaterial=function(e){THREE.MeshStandardMaterial.call(this),this.type="IBLMaterial",this.IBLEnabled=!0,this.debug=0,this.gamma=2.2,this.color=new THREE.Color(16777215),this.roughness=.5,this.metalness=.5,this.originRoughness=.5,this.originMetalness=.5,this.opacity=1,this.aoMap=null,this.IBLMaps=null,this.shift=.18,this.A=.27,this.B=.29,this.C=.052,this.D=.2,this.E=0,this.F=.18,this.scale=.897105,this.emissive=new THREE.Color,this.defines={},this.uniforms=THREE.UniformsUtils.merge([THREE.ShaderLib.standard.uniforms,{IBLEnabled:{value:!0},debug:{value:0},gamma:{value:2.2},albedo:{value:new THREE.Color(16777215)},aoMap:{value:null},irradianceMap:{value:null},prefilterMap:{value:null},brdfMap:{value:null},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105}}]),this.lights=!0,this.vertexShader=ImageBasedLighting.IBLVertexShader,this.fragmentShader=ImageBasedLighting.IBLFragmentShader,this.defaultAttributeValues={color:[1,1,1],uv:[0,0],uv2:[0,0]},void 0!==e&&(void 0!==e.attributes&&console.error("IBLMaterial: attributes should now be defined in THREE.BufferGeometry instead."),this.setValues(e))},ImageBasedLighting.IBLMaterial.prototype=Object.create(THREE.MeshStandardMaterial.prototype),ImageBasedLighting.IBLMaterial.prototype.constructor=ImageBasedLighting.IBLMaterial,ImageBasedLighting.IBLMaterial.prototype.copy=function(e){return THREE.MeshStandardMaterial.prototype.copy.call(this,e),this.IBLEnabled=e.IBLEnabled,this.debug=e.debug,this.gamma=e.gamma,this.color.copy(e.color),this.aoMap=e.aoMap,this.IBLMaps=e.IBLMaps,this.shift=e.shift,this.A=e.A,this.B=e.B,this.C=e.C,this.D=e.D,this.E=e.E,this.F=e.F,this.scale=e.scale,this},ImageBasedLighting.IBLMaterial.prototype.refreshUniforms=function(){this.uniforms.IBLEnabled.value=this.IBLEnabled,this.uniforms.debug.value=this.debug,this.uniforms.gamma.value=this.gamma,this.uniforms.albedo.value.set(this.color),this.uniforms.aoMap.value=this.aoMap,this.IBLMaps&&(this.uniforms.irradianceMap.value=this.IBLMaps.irradianceMap,this.uniforms.prefilterMap.value=this.IBLMaps.prefilterMap,this.uniforms.brdfMap.value=this.IBLMaps.brdfMap),this.uniforms.shift.value=this.shift,this.uniforms.A.value=this.A,this.uniforms.B.value=this.B,this.uniforms.C.value=this.C,this.uniforms.D.value=this.D,this.uniforms.E.value=this.E,this.uniforms.F.value=this.F,this.uniforms.scale.value=this.scale},ImageBasedLighting.IBLProbe=function(e,t,i,n,r,a,o){this.environmentMap=e,this.hammersleyTable=null,this.irradianceMap=null,this.prefilterMap=null,this.brdfMap=null,this.hammersleyUrl=t,this.irradianceResolution=n||32,this.prefilterResolution=r||128,this.brdfResolution=a||512,this.maxMipLevel=o||1,this.isHDR=!1,this.isComputed=!1,this.onSuccess=i,this.loadHammersleyTable()},ImageBasedLighting.IBLProbe.prototype.constructor=ImageBasedLighting.IBLProbe,ImageBasedLighting.IBLProbe.prototype.loadHammersleyTable=function(){var e=this;(new THREE.TextureLoader).load(this.hammersleyUrl,function(t){e.hammersleyTable=t,e.initMap(),e.onSuccess&&e.onSuccess()})},ImageBasedLighting.IBLProbe.prototype.initMap=function(){this.irradianceMap=new ImageBasedLighting.IrradianceMap(this.environmentMap,this.irradianceResolution),this.prefilterMap=new ImageBasedLighting.PrefilterMap(this.environmentMap,this.hammersleyTable,this.prefilterResolution,this.maxMipLevel),this.brdfMap=new ImageBasedLighting.BRDFMap(this.hammersleyTable,this.brdfResolution)},ImageBasedLighting.IBLProbe.prototype.setEnvironmentMap=function(e){this.environmentMap=e,this.irradianceMap.irradianceMaterial.uniforms.environmentMap.value=this.environmentMap,this.prefilterMap.prefilterMaterial.uniforms.environmentMap.value=this.environmentMap},ImageBasedLighting.IBLProbe.prototype.computed=function(e){this.irradianceMap.generateMap(e,this.isHDR),this.prefilterMap.generateMap(e,this.isHDR),this.brdfMap.generateMap(e),this.isComputed=!0},ImageBasedLighting.IBLVertexShader=["uniform vec4 offsetRepeat;","varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;","void main()","{","    vUv = uv * offsetRepeat.zw + offsetRepeat.xy;","    Pos = vec3(modelMatrix * vec4(position, 1.0));","    Normal = normalize(mat3(modelMatrix) * normal);","    mvPosition = vec3(modelViewMatrix * vec4(position, 1.0));","    mvNormal = normalize(normalMatrix * normal);","    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.varying_pars=["varying vec2 vUv;","varying vec3 Normal;","varying vec3 Pos;","varying vec3 mvPosition;","varying vec3 mvNormal;"].join("\n"),ImageBasedLighting.clipping_pars=["#if NUM_CLIPPING_PLANES > 0","    uniform vec4 clippingPlanes[NUM_CLIPPING_PLANES];","#endif"].join("\n"),ImageBasedLighting.maps_pars=["#ifdef USE_MAP","    uniform sampler2D map;","#endif","#ifdef USE_NORMALMAP","    uniform sampler2D normalMap;","    uniform vec2 normalScale;","vec3 perturbNormal2Arb(vec3 pos, vec3 normal)","{","    vec3 q0 = vec3(dFdx(pos.x), dFdx(pos.y), dFdx(pos.z));","    vec3 q1 = vec3(dFdy(pos.x), dFdy(pos.y), dFdy(pos.z));","    vec2 st0 = dFdx(vUv.st);","    vec2 st1 = dFdy(vUv.st);","    vec3 S = normalize(q0 * st1.t - q1 * st0.t);","    vec3 T = normalize(-q0 * st1.s + q1 * st0.s);","    vec3 N = normalize(normal);","    vec3 mapN = texture2D(normalMap, vUv).xyz * 2.0 - 1.0;","    mapN.xy = normalScale * mapN.xy;","    mat3 tsn = mat3(S, T, N);","    return normalize(tsn * mapN);","}","#endif","#ifdef USE_ROUGHNESSMAP","    uniform sampler2D roughnessMap;","#endif","#ifdef USE_METALNESSMAP","    uniform sampler2D metalnessMap;","#endif","#ifdef USE_AOMAP","    uniform sampler2D aoMap;","    uniform float aoMapIntensity;","#endif"].join("\n"),ImageBasedLighting.iblMaps_pars=["uniform samplerCube irradianceMap;","uniform samplerCube prefilterMap;","uniform sampler2D brdfMap;"].join("\n"),ImageBasedLighting.lighting_pars=["uniform vec3 ambientLightColor;","#if NUM_DIR_LIGHTS > 0","struct DirectionalLight","{","    vec3 direction;","    vec3 color;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform DirectionalLight directionalLights[NUM_DIR_LIGHTS];","#endif","#if NUM_POINT_LIGHTS > 0","struct PointLight","{","    vec3 position;","    vec3 color;","    float distance;","    float decay;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform PointLight pointLights[NUM_POINT_LIGHTS];","#endif","#if NUM_SPOT_LIGHTS > 0","struct SpotLight","{","    vec3 position;","    vec3 direction;","    vec3 color;","    float distance;","    float decay;","    float coneCos;","    float penumbraCos;","    int shadow;","    float shadowBias;","    float shadowRadius;","    vec2 shadowMapSize;","};","uniform SpotLight spotLights[NUM_SPOT_LIGHTS];","#endif","float punctualLightIntensityToIrradianceFactor(const in float lightDistance, const in float cutoffDistance, const in float decayExponent)","{","    if(decayExponent > 0.0)","    {","        float distanceFalloff = 1.0 / max(pow(abs(lightDistance), decayExponent), 0.01);","        float maxDistanceCutoffFactor = pow(abs(clamp(1.0 - pow(abs(lightDistance / cutoffDistance), 4.0), 0.0, 1.0)), 2.0);","        return distanceFalloff * maxDistanceCutoffFactor;","    }","    float distanceFalloff = 1.0 / max(pow(abs(lightDistance), 2.0), 0.01);","    return distanceFalloff;","}"].join("\n"),ImageBasedLighting.toneMap_pars=["uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}"].join("\n"),ImageBasedLighting.Uniforms=[ImageBasedLighting.varying_pars,ImageBasedLighting.clipping_pars,"uniform bool IBLEnabled;","uniform int debug;","uniform float gamma;","uniform vec3 albedo;","uniform float metalness;","uniform float roughness;","uniform float opacity;",ImageBasedLighting.maps_pars,ImageBasedLighting.iblMaps_pars,ImageBasedLighting.lighting_pars,ImageBasedLighting.toneMap_pars].join("\n"),ImageBasedLighting.IBLFragmentShader=[ImageBasedLighting.Uniforms,"const float PI = 3.14159265358979;","#include <bumpmap_pars_fragment>","float D_GGX(float NdotH, float roughness)","{","    float alpha = pow(roughness, 2.0);","    float alpha2 = pow(alpha, 2.0);","    return alpha2 / (PI * pow(abs(NdotH * NdotH * (alpha2 - 1.0) + 1.0), 2.0));","}","float GGX_Schlick(float NdotV, float roughness)","{","    float k = (roughness + 1.0) * 0.125;","    return NdotV / (NdotV * (1.0 - k) + k);","}","float G_Smith(float NdotV, float NdotL, float roughness)","{","    return GGX_Schlick(NdotV, roughness) * GGX_Schlick(NdotL, roughness);","}","vec3 F_Schlick(float HdotV, vec3 F0)","{","    return F0 + (vec3(1.0) - F0) * pow((1.0 - HdotV), 5.0);","}","vec3 F_SchlickRoughness(float NdotV, vec3 F0, float roughness)","{","    return F0 + (max(vec3(1.0 - roughness), F0) - F0) * pow(1.0 - NdotV, 5.0);","}","vec3 postProcessing(vec3 color, bool toneMap)","{","    vec3 result = toneMap ? toneMapCanonFilmic(color) : color;","    result = pow(result, vec3(1.0 / gamma));","    return result;","}","void main()","{","#if NUM_CLIPPING_PLANES > 0","    vec3 vViewPosition = -mvPosition;","    for (int i = 0; i < UNION_CLIPPING_PLANES; ++ i)","    {","        vec4 plane = clippingPlanes[ i ];","        if (dot(vViewPosition, plane.xyz) > plane.w) discard;","    }","    #if UNION_CLIPPING_PLANES < NUM_CLIPPING_PLANES","        bool clipped = true;","        for (int i = UNION_CLIPPING_PLANES; i < NUM_CLIPPING_PLANES; ++ i)","        {","            vec4 plane = clippingPlanes[ i ];","            clipped = (dot(vViewPosition, plane.xyz) > plane.w) && clipped;","        }","        if (clipped) discard;","    #endif","#endif","    vec3 baseColor = pow(albedo, vec3(gamma));","#ifdef USE_MAP","    baseColor = pow(texture2D(map, vUv).rgb, vec3(gamma));","#endif","#ifdef DOUBLE_SIDED","    float flipNormal = float(gl_FrontFacing) * 2.0 - 1.0;","#else","    float flipNormal = 1.0;","#endif","    vec3 normal = Normal * flipNormal;","    vec3 vNormal = mvNormal * flipNormal;","#ifdef USE_NORMALMAP","    normal = perturbNormal2Arb(Pos, normal);","    vNormal = perturbNormal2Arb(mvPosition, vNormal);","#endif","#ifdef USE_BUMPMAP","    normal = perturbNormalArb( mvPosition, normal, dHdxy_fwd() );","#endif","    float roughnessFactor = roughness;","#ifdef USE_ROUGHNESSMAP","    roughnessFactor = texture2D(roughnessMap, vUv).r;","#endif","    float metalnessFactor = metalness;","#ifdef USE_METALNESSMAP","    metalnessFactor = texture2D(metalnessMap, vUv).r;","#endif","    float aoFactor = 1.0;","#ifdef USE_AOMAP","    aoFactor = texture2D(aoMap, vUv).r;","#endif","    vec3 N = normal;","    vec3 V = normalize(cameraPosition - Pos);","    vec3 R = reflect(-V, N);","    vec3 F0 = vec3(0.04);","    F0 = mix(F0, baseColor, metalnessFactor);","    vec3 totalLightColor = vec3(0.0);","    vec3 viewVector = normalize(-mvPosition);","    vec3 normalVector = normalize(vNormal);","    float NdotV = max(dot(normalVector, viewVector), 0.0);","    totalLightColor += ambientLightColor * baseColor / PI;","#if NUM_DIR_LIGHTS > 0","    vec3 dirColor = vec3(0.0);","    for (int i = 0; i < NUM_DIR_LIGHTS; ++i)","    {","        DirectionalLight directionalLight = directionalLights[i];","        vec3 dirVector = normalize(directionalLight.direction);","        vec3 halfVector = normalize(dirVector + viewVector);","        float NdotL = max(dot(normalVector, dirVector), 0.0);","        float NdotH = max(dot(normalVector, halfVector), 0.0);","        float HdotV = max(dot(halfVector, viewVector), 0.0);","        vec3 F = F_Schlick(HdotV, F0);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        float D = D_GGX(NdotH, roughnessFactor);","        float G = G_Smith(NdotV, NdotL, roughnessFactor);","        vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","        dirColor += (kD * baseColor / PI + specular) * directionalLight.color * NdotL;","    }","    totalLightColor += dirColor;","#endif","#if NUM_POINT_LIGHTS > 0","    vec3 pointColor  = vec3(0.0);","    for (int i = 0; i < NUM_POINT_LIGHTS; ++i)","    {","        PointLight pointLight = pointLights[i];","        vec3 dirVector = pointLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float NdotL = max(dot(normalVector, dirVector), 0.0);","        float NdotH = max(dot(normalVector, halfVector), 0.0);","        float HdotV = max(dot(halfVector, viewVector), 0.0);","        vec3 F = F_Schlick(HdotV, F0);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        float D = D_GGX(NdotH, roughnessFactor);","        float G = G_Smith(NdotV, NdotL, roughnessFactor);","        vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","        pointColor += (kD * baseColor / PI + specular) * pointLight.color * NdotL * punctualLightIntensityToIrradianceFactor(distance, pointLight.distance, pointLight.decay);","    }","    totalLightColor += pointColor;","#endif","#if NUM_SPOT_LIGHTS > 0","    vec3 spotColor  = vec3(0.0);","    for (int i = 0; i < NUM_SPOT_LIGHTS; ++i)","    {","        SpotLight spotLight = spotLights[i];","        vec3 dirVector = spotLight.position - mvPosition;","        float distance = length(dirVector);","        dirVector = normalize(dirVector);","        vec3 halfVector = normalize(dirVector + viewVector);","        float angleCos = dot(dirVector, spotLight.direction);","        if (angleCos > spotLight.coneCos)","        {","            float spotEffect = smoothstep(spotLight.coneCos, spotLight.penumbraCos, angleCos);","            float NdotL = max(dot(normalVector, dirVector), 0.0);","            float NdotH = max(dot(normalVector, halfVector), 0.0);","            float HdotV = max(dot(halfVector, viewVector), 0.0);","            vec3 F = F_Schlick(HdotV, F0);","            vec3 kS = F;","            vec3 kD = 1.0 - kS;","            kD *= 1.0 - metalnessFactor;","            float D = D_GGX(NdotH, roughnessFactor);","            float G = G_Smith(NdotV, NdotL, roughnessFactor);","            vec3 specular = D * G * F / (4.0 * NdotV * NdotL + 0.001);","            spotColor += (kD * baseColor / PI + specular) * spotLights[i].color * spotEffect * NdotL","                * punctualLightIntensityToIrradianceFactor(distance, spotLight.distance, spotLight.decay);","            totalLightColor += spotColor;","        }","    }","#endif","    if (IBLEnabled)","    {","        vec3 F = F_SchlickRoughness(max(dot(N, V), 0.0), F0, roughnessFactor);","        vec3 kS = F;","        vec3 kD = 1.0 - kS;","        kD *= 1.0 - metalnessFactor;","        vec3 irradiance = textureCube(irradianceMap, N, 0.0).rgb;","        vec3 diffuse = irradiance * baseColor;","        const float MAX_REFLECTION_LOD = 1.0;","        vec3 prefilteredColor = textureCube(prefilterMap, R, roughnessFactor * MAX_REFLECTION_LOD).rgb;","        vec2 brdf = texture2D(brdfMap, vec2(max(dot(N, V), 0.0), roughnessFactor)).rg;","        vec3 specular = prefilteredColor * (F * brdf.x + brdf.y);","        vec3 color = (kD * diffuse + specular + totalLightColor) * aoFactor;","        color = postProcessing(color, true);","        if (debug == 1) ","        {","            baseColor = postProcessing(baseColor, false);","            gl_FragColor = vec4(baseColor, opacity);","        }","        else if (debug == 2)","        {","            irradiance = postProcessing(irradiance, true);","            gl_FragColor = vec4(irradiance, opacity);","        }","        else if (debug == 3)","        {","            prefilteredColor = postProcessing(prefilteredColor, true);","            gl_FragColor = vec4(prefilteredColor, opacity);","        }","        else if (debug == 4)","        {","            diffuse = postProcessing(diffuse, true);","            gl_FragColor = vec4(diffuse, opacity);","        }","        else if (debug == 5)","        {","            specular = postProcessing(specular, true);","            gl_FragColor = vec4(specular, opacity);","        }","        else if (debug == 6)","        {","            gl_FragColor = vec4(brdf, 0.0, opacity);","        }","        else if (debug == 7)","        {","            gl_FragColor = vec4(normal, opacity);","        }","        else","        {","            gl_FragColor = vec4(color, opacity);","        }","    }","    else","    {","        totalLightColor = postProcessing(totalLightColor, true);","        gl_FragColor = vec4(totalLightColor, opacity);","    }","}"].join("\n"),
ImageBasedLighting.cube_vs=["varying vec3 pos;","void main()","{","    pos = position;","    gl_Position = projectionMatrix * mat4(mat3(viewMatrix)) * modelMatrix * vec4(position, 1.0);","    gl_Position = gl_Position.xyww;","}"].join("\n"),ImageBasedLighting.cube_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","uniform bool hdr;","uniform float shift;","uniform float A;","uniform float B;","uniform float C;","uniform float D;","uniform float E;","uniform float F;","uniform float scale;","vec3 toneMapCanonFilmic(vec3 color)","{","    color *= (1.0 / shift);","    return (((color * (A * color + C * B)) / (color * (A * color + B) + D * F))) * (1.0 / scale);","}","void main()","{","    vec3 envColor = textureCube(environmentMap, pos, 0.0).rgb;","    if (hdr)","    {","        envColor = toneMapCanonFilmic(envColor);","        envColor = pow(envColor, vec3(1.0 / 2.2));","    }","    gl_FragColor = vec4(envColor, 1.0);","}"].join("\n"),ImageBasedLighting.irradiance_vs=["varying vec3 pos;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.irradiance_fs=["varying vec3 pos;","uniform samplerCube environmentMap;","const float PI = 3.14159265358979;","vec3 caluIrradiance(vec3 normal, vec3 up, vec3 right)","{","\tvec3 irradiance = vec3(0.0);","\tint count = 0;","\tconst int phiSampleCount = 1024;","\tconst int thetaSampleCount = phiSampleCount / 4;","\tfloat phiDelta = 2.0 * PI / float(phiSampleCount);","\tfloat thetaDelta = 0.5 * PI / float(thetaSampleCount);","\tfor(int i = 0; i < phiSampleCount; ++i)","\t{","\t\tfloat phi = float(i) * phiDelta;","\t\tfor(int j = 0; j < thetaSampleCount; ++j)","\t\t{","\t\t\tfloat theta = float(j) * thetaDelta;","\t\t\tvec3 tangentSample = vec3(sin(theta) * cos(phi), sin(theta) * sin(phi), cos(theta));","\t\t\tvec3 sampleVec = tangentSample.x * right + tangentSample.y * up + tangentSample.z * normal; ","\t\t\tirradiance += textureCube(environmentMap, sampleVec, 0.0).rgb * cos(theta) * sin(theta);","\t\t\t++count;","\t\t}","\t}","\tirradiance = PI * irradiance * (1.0 / float(count));","\treturn irradiance;","}","void main()","{","\tvec3 normal = normalize(pos);","\tvec3 up = vec3(0.0, 1.0, 0.0);","\tvec3 right = cross(up, normal);","\tup = cross(normal, right);","\tvec3 irradiance = caluIrradiance(normal, up, right);","\tgl_FragColor = vec4(irradiance, 1.0);","}"].join("\n"),ImageBasedLighting.IrradianceMap=function(e,t){this.cubeTexture=null,this.resolution=t||32,this.irradianceMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.irradiance_vs,fragmentShader:ImageBasedLighting.irradiance_fs,uniforms:{environmentMap:{value:e}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.irradianceMaterial)},ImageBasedLighting.IrradianceMap.prototype.constructor=ImageBasedLighting.IrradianceMap,ImageBasedLighting.IrradianceMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var n=new THREE.CubeCamera(.1,10,this.resolution);if(t){var r={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};n.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,r)}n.updateCubeMap(e,i),this.cubeTexture=n.renderTarget.texture},ImageBasedLighting.prefilter_vs=["varying vec3 pos;","varying vec3 Normal;","void main() {","\tpos = vec3(modelMatrix * vec4(position, 1.0));","\tNormal = mat3(modelMatrix) * normal;","\tgl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);","}"].join("\n"),ImageBasedLighting.prefilter_fs=["varying vec3 pos;","varying vec3 Normal;","uniform float roughness;","uniform samplerCube environmentMap;","uniform sampler2D HammersleyTable;","const float PI = 3.14159265358979;","float D_GGX(float NdotH, float roughness)","{","\tfloat alpha = pow(roughness, 2.0);","\tfloat alpha2 = pow(alpha, 2.0);","\treturn alpha2 / (PI * pow(NdotH * NdotH * (alpha2 - 1.0) + 1.0, 2.0));","}","vec3 ImportanceSampleGGX(vec2 Xi, vec3 N, float roughness) ","{","\tfloat a = roughness * roughness;","\tfloat Phi = 2.0 * PI * Xi.x; ","\tfloat CosTheta = sqrt((1.0 - Xi.y) / (1.0 + (a * a - 1.0) * Xi.y)); ","\tfloat SinTheta = sqrt(1.0 - CosTheta * CosTheta);","\tvec3 H;","\tH.x = SinTheta * cos(Phi); ","\tH.y = SinTheta * sin(Phi); ","\tH.z = CosTheta;","\tvec3 UpVector = abs(N.z) < 0.999 ? vec3(0.0, 0.0, 1.0) : vec3(1.0, 0.0, 0.0); ","\tvec3 TangentX = normalize(cross(UpVector, N)); ","\tvec3 TangentY = cross(N, TangentX);","\treturn normalize(TangentX * H.x + TangentY * H.y + N * H.z);","}","void main()","{","\tvec3 N = normalize(pos);","\tvec3 R = N;","\tvec3 V = R;","\tconst int sampleCount = 1024;","\tfloat totalWeight = 0.0;","\tvec3 prefilteredColor = vec3(0.0);","\tfor (int i = 0; i < sampleCount; ++i) {","\t\tfloat u = float(i) / float(sampleCount);","\t\tvec2 Xi = vec2(u, texture2D(HammersleyTable, vec2(u)).r);","\t\tvec3 H = ImportanceSampleGGX(Xi, N, roughness);","\t\tvec3 L = normalize(2.0 * dot(V, H) * H - V);","\t\tfloat NdotL = max(dot(N, L), 0.0);","\t\tif(NdotL > 0.0)","\t\t{","\t\t\tfloat NdotH = max(dot(N, H), 0.0);","\t\t\tfloat D = D_GGX(NdotH, roughness);","\t\t\tfloat HdotV = max(dot(H, V), 0.0);","\t\t\tfloat pdf = D * NdotH / (4.0 * HdotV);","\t\t\tfloat resolution = 2048.0; // resolution of source cubemap (per face)","\t\t\tfloat solidAngleTexel= 4.0 * PI / (6.0 * resolution * resolution);","\t\t\tfloat solidAngleSample = 1.0 / (float(sampleCount) * pdf);","\t\t\tfloat mipLevel = roughness == 0.0 ? 0.0 : 0.5 * log2(solidAngleSample / solidAngleTexel);","\t\t\tprefilteredColor += textureCube(environmentMap, L, mipLevel).rgb * NdotL;","\t\t\ttotalWeight += NdotL;","\t\t}","\t}","\tprefilteredColor = prefilteredColor / totalWeight;","\tgl_FragColor = vec4(prefilteredColor, 1.0);","}"].join("\n"),ImageBasedLighting.PrefilterMap=function(e,t,i,n){this.cubeTexture=null,this.resolution=i||128,this.maxMipLevel=n||1,this.prefilterMaterial=new THREE.ShaderMaterial({vertexShader:ImageBasedLighting.prefilter_vs,fragmentShader:ImageBasedLighting.prefilter_fs,uniforms:{roughness:{value:0},environmentMap:{value:e},HammersleyTable:{value:t}},lights:!1,side:THREE.BackSide}),this.cube=new THREE.Mesh(new THREE.BoxBufferGeometry(2,2,2),this.prefilterMaterial)},ImageBasedLighting.PrefilterMap.prototype.constructor=ImageBasedLighting.PrefilterMap,ImageBasedLighting.PrefilterMap.prototype.generateMap=function(e,t){var i=new THREE.Scene;i.add(this.cube);var n=new THREE.CubeCamera(.1,10,this.resolution);if(t){var r={type:THREE.FloatType,format:THREE.RGBFormat,magFilter:THREE.LinearFilter,minFilter:THREE.LinearFilter};n.renderTarget=new THREE.WebGLRenderTargetCube(this.resolution,this.resolution,r)}for(var a=this.maxMipLevel<=1?1:this.maxMipLevel-1,o=0;o<this.maxMipLevel;o++){var s=this.resolution*Math.pow(.5,o);n.renderTarget.width=n.renderTarget.height=s;var l=o/a;this.prefilterMaterial.uniforms.roughness.value=l,n.renderTarget.activeMipMapLevel=o,n.updateCubeMap(e,i)}this.cubeTexture=n.renderTarget.texture},THREE.HDRLoader=THREE.RGBELoader=function(e){this.manager=void 0!==e?e:THREE.DefaultLoadingManager},THREE.RGBELoader.prototype=Object.create(THREE.DataTextureLoader.prototype),THREE.RGBELoader.prototype._parser=function(e){var t=function(e,t){switch(e){case 1:console.error("THREE.RGBELoader Read Error: "+(t||""));break;case 2:console.error("THREE.RGBELoader Write Error: "+(t||""));break;case 3:console.error("THREE.RGBELoader Bad File Format: "+(t||""));break;default:case 4:console.error("THREE.RGBELoader: Error: "+(t||""))}return-1},i=function(e,t,i){t=t||1024;for(var n=e.pos,r=-1,a=0,o="",s=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));0>(r=s.indexOf("\n"))&&a<t&&n<e.byteLength;)o+=s,a+=s.length,n+=128,s+=String.fromCharCode.apply(null,new Uint16Array(e.subarray(n,n+128)));return-1<r&&(!1!==i&&(e.pos+=a+r+1),o+s.slice(0,r))},n=new Uint8Array(e);n.pos=0;var r=function(e){var n,r,a=/^#\?(\S+)$/,o=/^\s*GAMMA\s*=\s*(\d+(\.\d+)?)\s*$/,s=/^\s*EXPOSURE\s*=\s*(\d+(\.\d+)?)\s*$/,l=/^\s*FORMAT=(\S+)\s*$/,c=/^\s*\-Y\s+(\d+)\s+\+X\s+(\d+)\s*$/,u={valid:0,string:"",comments:"",programtype:"RGBE",format:"",gamma:1,exposure:1,width:0,height:0};if(e.pos>=e.byteLength||!(n=i(e)))return t(1,"no header found");if(!(r=n.match(a)))return t(3,"bad initial token");for(u.valid|=1,u.programtype=r[1],u.string+=n+"\n";;){if(!1===(n=i(e)))break;if(u.string+=n+"\n","#"!==n.charAt(0)){if((r=n.match(o))&&(u.gamma=parseFloat(r[1],10)),(r=n.match(s))&&(u.exposure=parseFloat(r[1],10)),(r=n.match(l))&&(u.valid|=2,u.format=r[1]),(r=n.match(c))&&(u.valid|=4,u.height=parseInt(r[1],10),u.width=parseInt(r[2],10)),2&u.valid&&4&u.valid)break}else u.comments+=n+"\n"}return 2&u.valid?4&u.valid?u:t(3,"missing image size specifier"):t(3,"missing format specifier")}(n);if(-1!==r){var a=r.width,o=r.height,s=function(e,i,n){var r,a,o,s,l,c,u,h,d,f,p,m,g,v=i,y=n;if(v<8||v>32767||2!==e[0]||2!==e[1]||128&e[2])return new Uint8Array(e);if(v!==(e[2]<<8|e[3]))return t(3,"wrong scanline width");if(!(r=new Uint8Array(4*i*n))||!r.length)return t(4,"unable to allocate buffer space");for(a=0,o=0,h=4*v,g=new Uint8Array(4),c=new Uint8Array(h);y>0&&o<e.byteLength;){if(o+4>e.byteLength)return t(1);if(g[0]=e[o++],g[1]=e[o++],g[2]=e[o++],g[3]=e[o++],2!=g[0]||2!=g[1]||(g[2]<<8|g[3])!=v)return t(3,"bad rgbe scanline format");for(u=0;u<h&&o<e.byteLength;){if(s=e[o++],m=s>128,m&&(s-=128),0===s||u+s>h)return t(3,"bad scanline data");if(m)for(l=e[o++],d=0;d<s;d++)c[u++]=l;else c.set(e.subarray(o,o+s),u),u+=s,o+=s}for(f=v,d=0;d<f;d++)p=0,r[a]=c[d+p],p+=v,r[a+1]=c[d+p],p+=v,r[a+2]=c[d+p],p+=v,r[a+3]=c[d+p],a+=4;y--}return r}(n.subarray(n.pos),a,o);if(-1!==s)return{width:a,height:o,data:s,header:r.string,gamma:r.gamma,exposure:r.exposure,format:THREE.RGBEFormat,type:THREE.UnsignedByteType}}return null},CLOUD.IBLManager=function(e){this.viewer=e,this.IBLConfig=null,this.isHDR=!0,this.textureLoad=!1;var t=0,i=null,n=null;this.enableIBL=function(e){CLOUD.GlobalData.IBL!==e&&(CLOUD.GlobalData.IBL=e,this.viewer.setRenderStateChanged(!0),e?null!=i?this.initIBLByName(i):this.initIBLByIndex(t):(this.viewer.modelManager.changeAllMaterials(!1),this.removeSkyBox()))},this.loadIBLConfig=function(e){var t=this,i=this.viewer;(new THREE.FileLoader).load(e,function(e){t.IBLConfig=JSON.parse(e),CLOUD.GlobalData.IBL&&t.initIBLByIndex(0)},void 0,function(){i.modelManager.dispatchEvent({type:CLOUD.LOADERROREVENTS.LOAD_ERROR,errorType:CLOUD.LOADERROREVENTS.LOAD_IBLCONFIG_ERROR,event:event})})},this.initIBLByIndex=function(e){if(CLOUD.GlobalData.IBL&&null!=this.IBLConfig){var n=Object.keys(this.IBLConfig);if(n.length>e){var r=this.IBLConfig[n[e]];this.loadIBLMaps(r.url,r.isHDR,!0,r.uniforms),t=e,i=n[e]}}},this.initIBLByName=function(e){if(CLOUD.GlobalData.IBL&&null!=this.IBLConfig&&this.IBLConfig.hasOwnProperty(e)){var t=this.IBLConfig[e];this.loadIBLMaps(t.url,t.isHDR,!0,t.uniforms),i=e}},this.loadIBLMaps=function(e,t,i,n){if(CLOUD.GlobalData.IBL){var r=this,a=this.viewer;a.getScene().IBLMaps.loadMaps(e,t,function(e,t){a.modelManager.changeAllMaterials(!0),a.modelManager.updateMaterials();for(var o in n)"shift"!=o&&a.modelManager.updateMaterialsValue(o,n[o]);i&&r.addSkyBox(t,n),r.textureLoad=!0,a.setRenderStateChanged(!0),a.render()})}},this.loadSkyBox=function(e,t){var i=this,n=this.viewer;n.getScene().IBLMaps.loadMaps(e,t,function(e,t){i.addSkyBox(t),n.render()})},this.addSkyBox=function(e,t){var e=void 0==e?this.isHDR:e;this.isHDR=e;var i=null,n=this.viewer.getScene();if(n.hasObjectGroup(CLOUD.ObjectGroupType.IBLCUBE)){var r=n.getObjectGroup(CLOUD.ObjectGroupType.IBLCUBE);i=r.children[0],i.material.uniforms.environmentMap.value=n.IBLMaps.environmentMap,i.material.uniforms.hdr.value=e}else{i=new THREE.Mesh(new THREE.BoxBufferGeometry(2e3,2e3,2e3),new THREE.ShaderMaterial({uniforms:{environmentMap:{value:n.IBLMaps.environmentMap},hdr:{value:e},shift:{value:.18},A:{value:.27},B:{value:.29},C:{value:.052},D:{value:.2},E:{value:0},F:{value:.18},scale:{value:.897105}},vertexShader:ImageBasedLighting.cube_vs,fragmentShader:ImageBasedLighting.cube_fs,side:THREE.DoubleSide,depthTest:!0,depthWrite:!0,fog:!1})),i.frustumCulled=!1;var r=n.getOrCreateObjectGroup(CLOUD.ObjectGroupType.IBLCUBE,{priority:10});r.add(i)}if(t){var a=i.material;for(var o in t)a.uniforms.hasOwnProperty(o)&&(a.uniforms[o].value=t[o])}},this.removeSkyBox=function(){var e=this.viewer.getScene();e.hasObjectGroup(CLOUD.ObjectGroupType.IBLCUBE)&&(e.removeObjectGroupByName(CLOUD.ObjectGroupType.IBLCUBE),this.viewer.render())},this.setSkyBoxType=function(e){n=e},this.getSkyBoxType=function(){return n}},THREE.LineSegments2=function(e,t){THREE.Mesh.call(this),this.type="LineSegments2",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.LineSegments2.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.LineSegments2,isLineSegments2:!0,computeLineDistances:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(){for(var i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd,a=new Float32Array(2*n.data.count),o=0,s=0,l=n.data.count;o<l;o++,s+=2)e.fromBufferAttribute(n,o),t.fromBufferAttribute(r,o),a[s]=0===s?0:a[s-1],a[s+1]=a[s]+e.distanceTo(t);var c=new THREE.InstancedInterleavedBuffer(a,2,1);return i.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(c,1,0)),i.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(c,1,1)),this}}(),copy:function(e){return this}}),THREE.LineSegmentsGeometry=function(){THREE.InstancedBufferGeometry.call(this),this.type="LineSegmentsGeometry";var e=(new THREE.BufferGeometry,[-1,2,0,1,2,0,-1,1,0,1,1,0,-1,0,0,1,0,0,-1,-1,0,1,-1,0]),t=[0,1,1,1,0,.5,1,.5,0,.5,1,.5,0,0,1,0],i=[0,2,1,2,3,1,2,4,3,4,5,3,4,6,5,6,7,5];this.setIndex(i),this.addAttribute("position",new THREE.Float32BufferAttribute(e,3)),this.addAttribute("uv",new THREE.Float32BufferAttribute(t,2))},THREE.LineSegmentsGeometry.prototype=Object.assign(Object.create(THREE.InstancedBufferGeometry.prototype),{constructor:THREE.LineSegmentsGeometry,isLineSegmentsGeometry:!0,applyMatrix:function(e){var t=this.attributes.instanceStart,i=this.attributes.instanceEnd;return void 0!==t&&(e.applyToBufferAttribute(t),e.applyToBufferAttribute(i),t.data.needsUpdate=!0),null!==this.boundingBox&&this.computeBoundingBox(),null!==this.boundingSphere&&this.computeBoundingSphere(),this},setPositions:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.addAttribute("instanceEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this.computeBoundingBox(),this.computeBoundingSphere(),this},setColors:function(e){var t;e instanceof Float32Array?t=e:Array.isArray(e)&&(t=new Float32Array(e));var i=new THREE.InstancedInterleavedBuffer(t,6,1);return this.addAttribute("instanceColorStart",new THREE.InterleavedBufferAttribute(i,3,0)),this.addAttribute("instanceColorEnd",new THREE.InterleavedBufferAttribute(i,3,3)),this},fromWireframeGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromEdgesGeometry:function(e){return this.setPositions(e.attributes.position.array),this},fromMesh:function(e){return this.fromWireframeGeometry(new THREE.WireframeGeometry(e.geometry)),this},fromLineSegements:function(e){var t=e.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this},computeBoundingBox:function(){var e=new THREE.Box3;return function(){null===this.boundingBox&&(this.boundingBox=new THREE.Box3);var t=this.attributes.instanceStart,i=this.attributes.instanceEnd;void 0!==t&&void 0!==i&&(this.boundingBox.setFromBufferAttribute(t),e.setFromBufferAttribute(i),this.boundingBox.union(e))}}(),computeBoundingSphere:function(){var e=new THREE.Vector3;return function(){null===this.boundingSphere&&(this.boundingSphere=new THREE.Sphere),null===this.boundingBox&&this.computeBoundingBox();var t=this.attributes.instanceStart,i=this.attributes.instanceEnd;if(void 0!==t&&void 0!==i){var n=this.boundingSphere.center;this.boundingBox.getCenter(n);for(var r=0,a=0,o=t.count;a<o;a++)e.fromBufferAttribute(t,a),r=Math.max(r,n.distanceToSquared(e)),e.fromBufferAttribute(i,a),r=Math.max(r,n.distanceToSquared(e));this.boundingSphere.radius=Math.sqrt(r),isNaN(this.boundingSphere.radius)&&console.error("THREE.LineSegmentsGeometry.computeBoundingSphere(): Computed radius is NaN. The instanced position data is likely to have NaN values.",this)}}}(),toJSON:function(){},clone:function(){},copy:function(e){return this}}),THREE.Line2=function(e,t){THREE.LineSegments2.call(this),this.type="Line2",this.geometry=void 0!==e?e:new THREE.LineGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Line2.prototype=Object.assign(Object.create(THREE.LineSegments2.prototype),{constructor:THREE.Line2,isLine2:!0,copy:function(e){return this}}),THREE.LineGeometry=function(){THREE.LineSegmentsGeometry.call(this),this.type="LineGeometry"},THREE.LineGeometry.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.LineGeometry,isLineGeometry:!0,setPositions:function(e){for(var t=e.length-3,i=new Float32Array(2*t),n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return THREE.LineSegmentsGeometry.prototype.setPositions.call(this,i),this},setColors:function(e){for(var t=e.length-3,i=new Float32Array(2*t),n=0;n<t;n+=3)i[2*n]=e[n],i[2*n+1]=e[n+1],i[2*n+2]=e[n+2],i[2*n+3]=e[n+3],i[2*n+4]=e[n+4],i[2*n+5]=e[n+5];return THREE.LineSegmentsGeometry.prototype.setColors.call(this,i),this},fromLine:function(e){var t=e.geometry;return t.isGeometry?this.setPositions(t.vertices):t.isBufferGeometry&&this.setPositions(t.position.array),this},copy:function(e){return this}}),THREE.UniformsLib.line={linewidth:{value:1},resolution:{value:new THREE.Vector2(1,1)},dashScale:{value:1},dashSize:{value:1},gapSize:{value:1}},THREE.ShaderLib.line={uniforms:THREE.UniformsUtils.merge([THREE.UniformsLib.common,THREE.UniformsLib.fog,THREE.UniformsLib.line]),vertexShader:"\n\t\t#include <common>\n\t\t#include <color_pars_vertex>\n\t\t#include <fog_pars_vertex>\n\t\t#include <logdepthbuf_pars_vertex>\n\t\t#include <clipping_planes_pars_vertex>\n\n\t\tuniform float linewidth;\n\t\tuniform vec2 resolution;\n\n\t\tattribute vec3 instanceStart;\n\t\tattribute vec3 instanceEnd;\n\n\t\tattribute vec3 instanceColorStart;\n\t\tattribute vec3 instanceColorEnd;\n\n\t\tvarying vec2 vUv;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashScale;\n\t\t\tattribute float instanceDistanceStart;\n\t\t\tattribute float instanceDistanceEnd;\n\t\t\tvarying float vLineDistance;\n\n\t\t#endif\n\n\t\tvoid trimSegment( const in vec4 start, inout vec4 end ) {\n\n\t\t\t// trim end segment so it terminates between the camera plane and the near plane\n\n\t\t\t// conservative estimate of the near plane\n\t\t\tfloat a = projectionMatrix[ 2 ][ 2 ]; // 3nd entry in 3th column\n\t\t\tfloat b = projectionMatrix[ 3 ][ 2 ]; // 3nd entry in 4th column\n\t\t\tfloat nearEstimate = - 0.5 * b / a;\n\n\t\t\tfloat alpha = ( nearEstimate - start.z ) / ( end.z - start.z );\n\n\t\t\tend.xyz = mix( start.xyz, end.xyz, alpha );\n\n\t\t}\n\n\t\tvoid main() {\n\n\t\t\t#ifdef USE_COLOR\n\n\t\t\t\tvColor.xyz = ( position.y < 0.5 ) ? instanceColorStart : instanceColorEnd;\n\n\t\t\t#endif\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tvLineDistance = ( position.y < 0.5 ) ? dashScale * instanceDistanceStart : dashScale * instanceDistanceEnd;\n\n\t\t\t#endif\n\n\t\t\tfloat aspect = resolution.x / resolution.y;\n\n\t\t\tvUv = uv;\n\n\t\t\t// camera space\n\t\t\tvec4 start = modelViewMatrix * vec4( instanceStart, 1.0 );\n\t\t\tvec4 end = modelViewMatrix * vec4( instanceEnd, 1.0 );\n\n\t\t\t// special case for perspective projection, and segments that terminate either in, or behind, the camera plane\n\t\t\t// clearly the gpu firmware has a way of addressing this issue when projecting into ndc space\n\t\t\t// but we need to perform ndc-space calculations in the shader, so we must address this issue directly\n\t\t\t// perhaps there is a more elegant solution -- WestLangley\n\n\t\t\tbool perspective = ( projectionMatrix[ 2 ][ 3 ] == - 1.0 ); // 4th entry in the 3rd column\n\n\t\t\tif ( perspective ) {\n\n\t\t\t\tif ( start.z < 0.0 && end.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( start, end );\n\n\t\t\t\t} else if ( end.z < 0.0 && start.z >= 0.0 ) {\n\n\t\t\t\t\ttrimSegment( end, start );\n\n\t\t\t\t}\n\n\t\t\t}\n\n\t\t\t// clip space\n\t\t\tvec4 clipStart = projectionMatrix * start;\n\t\t\tvec4 clipEnd = projectionMatrix * end;\n\n\t\t\t// ndc space\n\t\t\tvec2 ndcStart = clipStart.xy / clipStart.w;\n\t\t\tvec2 ndcEnd = clipEnd.xy / clipEnd.w;\n\n\t\t\t// direction\n\t\t\tvec2 dir = ndcEnd - ndcStart;\n\n\t\t\t// account for clip-space aspect ratio\n\t\t\tdir.x *= aspect;\n\t\t\tdir = normalize( dir );\n\n\t\t\t// perpendicular to dir\n\t\t\tvec2 offset = vec2( dir.y, - dir.x );\n\n\t\t\t// undo aspect ratio adjustment\n\t\t\tdir.x /= aspect;\n\t\t\toffset.x /= aspect;\n\n\t\t\t// sign flip\n\t\t\tif ( position.x < 0.0 ) offset *= - 1.0;\n\n\t\t\t// endcaps\n\t\t\tif ( position.y < 0.0 ) {\n\n\t\t\t\toffset += - dir;\n\n\t\t\t} else if ( position.y > 1.0 ) {\n\n\t\t\t\toffset += dir;\n\n\t\t\t}\n\n\t\t\t// adjust for linewidth\n\t\t\toffset *= linewidth;\n\n\t\t\t// adjust for clip-space to screen-space conversion // maybe resolution should be based on viewport ...\n\t\t\toffset /= resolution.y;\n\n\t\t\t// select end\n\t\t\tvec4 clip = ( position.y < 0.5 ) ? clipStart : clipEnd;\n\n\t\t\t// back to clip space\n\t\t\toffset *= clip.w;\n\n\t\t\tclip.xy += offset;\n\n\t\t\tgl_Position = clip;\n\t\t\tvec4 mvPosition = ( position.y < 0.5 ) ? start : end; // this is an approximation\n\t\t\t#include <logdepthbuf_vertex>\n\n\t\t\t#include <worldpos_vertex>\n\t\t\t#include <clipping_planes_vertex>\n\t\t\t#include <fog_vertex>\n\n\t\t}\n\t\t",fragmentShader:"\n\t\tuniform vec3 diffuse;\n\t\tuniform float opacity;\n\n\t\t#ifdef USE_DASH\n\n\t\t\tuniform float dashSize;\n\t\t\tuniform float gapSize;\n\n\t\t#endif\n\n\t\tvarying float vLineDistance;\n\n\t\t#include <common>\n\t\t#include <color_pars_fragment>\n\t\t#include <fog_pars_fragment>\n\t\t#include <logdepthbuf_pars_fragment>\n\t\t#include <clipping_planes_pars_fragment>\n\n\t\tvarying vec2 vUv;\n\n\t\tvoid main() {\n\n\t\t\t#include <clipping_planes_fragment>\n\n\t\t\t#ifdef USE_DASH\n\n\t\t\t\tif ( vUv.y < 0.5 || vUv.y > 0.5 ) discard; // discard endcaps\n\n\t\t\t\tif ( mod( vLineDistance, dashSize + gapSize ) > dashSize ) discard; // todo - FIX\n\n\t\t\t#endif\n\n\t\t\tif ( vUv.y < 0.5 || vUv.y > 0.5 ) {\n\n\t\t\t\tfloat a = vUv.x - 0.5;\n\t\t\t\tfloat b = vUv.y - 0.5;\n\t\t\t\tfloat len2 = a * a + b * b;\n\n\t\t\t\tif ( len2 > 0.25 ) discard;\n\n\t\t\t}\n\n\t\t\tvec4 diffuseColor = vec4( diffuse, opacity );\n\n\t\t\t#include <logdepthbuf_fragment>\n\t\t\t#include <color_fragment>\n\n\t\t\tgl_FragColor = vec4( diffuseColor.rgb, diffuseColor.a );\n\n\t\t\t#include <premultiplied_alpha_fragment>\n\t\t\t#include <tonemapping_fragment>\n\t\t\t#include <encodings_fragment>\n\t\t\t#include <fog_fragment>\n\n\t\t}\n\t\t"},THREE.LineMaterial=function(e){THREE.ShaderMaterial.call(this,{type:"LineMaterial",uniforms:THREE.UniformsUtils.clone(THREE.ShaderLib.line.uniforms),vertexShader:THREE.ShaderLib.line.vertexShader,fragmentShader:THREE.ShaderLib.line.fragmentShader}),this.dashed=!1,Object.defineProperties(this,{color:{enumerable:!0,get:function(){return this.uniforms.diffuse.value},set:function(e){this.uniforms.diffuse.value=e}},linewidth:{enumerable:!0,get:function(){return this.uniforms.linewidth.value},set:function(e){this.uniforms.linewidth.value=e}},dashScale:{enumerable:!0,get:function(){return this.uniforms.dashScale.value},set:function(e){this.uniforms.dashScale.value=e}},dashSize:{enumerable:!0,get:function(){return this.uniforms.dashSize.value},set:function(e){this.uniforms.dashSize.value=e}},gapSize:{enumerable:!0,get:function(){return this.uniforms.gapSize.value},set:function(e){this.uniforms.gapSize.value=e}},resolution:{enumerable:!0,get:function(){return this.uniforms.resolution.value},set:function(e){this.uniforms.resolution.value.copy(e)}}}),this.setValues(e)},THREE.LineMaterial.prototype=Object.create(THREE.ShaderMaterial.prototype),THREE.LineMaterial.prototype.constructor=THREE.LineMaterial,THREE.LineMaterial.prototype.isLineMaterial=!0,THREE.LineMaterial.prototype.copy=function(e){return THREE.ShaderMaterial.prototype.copy.call(this,e),this.color.copy(e.color),this.linewidth=e.linewidth,this.resolution=e.resolution,this},THREE.Wireframe=function(e,t){THREE.Mesh.call(this),this.type="Wireframe",this.geometry=void 0!==e?e:new THREE.LineSegmentsGeometry,this.material=void 0!==t?t:new THREE.LineMaterial({color:16777215*Math.random()})},THREE.Wireframe.prototype=Object.assign(Object.create(THREE.Mesh.prototype),{constructor:THREE.Wireframe,isWireframe:!0,computeLineDistances:function(){var e=new THREE.Vector3,t=new THREE.Vector3;return function(){for(var i=this.geometry,n=i.attributes.instanceStart,r=i.attributes.instanceEnd,a=new Float32Array(2*n.data.count),o=0,s=0,l=n.data.count;o<l;o++,s+=2)e.fromBufferAttribute(n,o),t.fromBufferAttribute(r,o),a[s]=0===s?0:a[s-1],a[s+1]=a[s]+e.distanceTo(t);var c=new THREE.InstancedInterleavedBuffer(a,2,1);return i.addAttribute("instanceDistanceStart",new THREE.InterleavedBufferAttribute(c,1,0)),i.addAttribute("instanceDistanceEnd",new THREE.InterleavedBufferAttribute(c,1,1)),this}}(),copy:function(e){return this}}),THREE.WireframeGeometry2=function(e){THREE.LineSegmentsGeometry.call(this),this.type="WireframeGeometry2",this.fromWireframeGeometry(new THREE.WireframeGeometry(e))},THREE.WireframeGeometry2.prototype=Object.assign(Object.create(THREE.LineSegmentsGeometry.prototype),{constructor:THREE.WireframeGeometry2,isWireframeGeometry2:!0,copy:function(e){return this}}),CLOUD.BBoxNode=function(e,t){var i=new THREE.BufferGeometry;i.addAttribute("position",new THREE.BufferAttribute(new Float32Array(72),3)),THREE.LineSegments.call(this,i,new THREE.LineBasicMaterial({color:t})),void 0!==e&&this.updateBBox(e)},CLOUD.BBoxNode.prototype=Object.create(THREE.LineSegments.prototype),CLOUD.BBoxNode.prototype.constructor=CLOUD.BBoxNode,CLOUD.BBoxNode.prototype.unload=function(){},CLOUD.BBoxNode.prototype.updateBBox=function(e){var t=e.min,i=e.max,n=this.geometry.attributes.position.array;n[0]=i.x,n[1]=i.y,n[2]=i.z,n[3]=t.x,n[4]=i.y,n[5]=i.z,n[6]=t.x,n[7]=i.y,n[8]=i.z,n[9]=t.x,n[10]=t.y,n[11]=i.z,n[12]=t.x,n[13]=t.y,n[14]=i.z,n[15]=i.x,n[16]=t.y,n[17]=i.z,n[18]=i.x,n[19]=t.y,n[20]=i.z,n[21]=i.x,n[22]=i.y,n[23]=i.z,n[24]=i.x,n[25]=i.y,n[26]=t.z,n[27]=t.x,n[28]=i.y,n[29]=t.z,n[30]=t.x,n[31]=i.y,n[32]=t.z,n[33]=t.x,n[34]=t.y,n[35]=t.z,n[36]=t.x,n[37]=t.y,n[38]=t.z,n[39]=i.x,n[40]=t.y,n[41]=t.z,n[42]=i.x,n[43]=t.y,n[44]=t.z,n[45]=i.x,n[46]=i.y,n[47]=t.z,n[48]=i.x,n[49]=i.y,n[50]=i.z,n[51]=i.x,n[52]=i.y,n[53]=t.z,n[54]=t.x,n[55]=i.y,n[56]=i.z,n[57]=t.x,n[58]=i.y,n[59]=t.z,n[60]=t.x,n[61]=t.y,n[62]=i.z,n[63]=t.x,n[64]=t.y,n[65]=t.z,n[66]=i.x,n[67]=t.y,n[68]=i.z,n[69]=i.x,n[70]=t.y,n[71]=t.z,this.geometry.attributes.position.needsUpdate=!0,this.geometry.computeBoundingBox(),this.geometry.computeBoundingSphere(),this.matrixAutoUpdate=!1},CLOUD.Marker3D=function(e){function t(e){for(var t=0,i=e.length,r=function(){++t>=i&&(u.update(),n.render())},a=0;a<i;++a){var o=e[a];void 0===l[o]?l[o]=c.load(o,function(e){e.image=CLOUD.MaterialUtil.ensureQuadrate(e.image),r()},void 0,function(){r()}):r()}}function i(){for(var e in l)l.hasOwnProperty(e)&&delete l[e]}var n=e,r=n.getScene(),a=null,o=!1,s={},l={},c=new THREE.TextureLoader;c.setCrossOrigin("anonymous");var u=this,h={};this.add=function(e){var i,n,r=[];if(e&&e instanceof Array)for(i=0,n=e.length;i<n;++i){var a,o=e[i],l={id:o.id?o.id:THREE.Math.generateUUID(),position:{x:o.position.x,y:o.position.y,z:o.position.z},size:o.size?o.size:32,iconUrl:o.iconUrl?o.iconUrl:null,tooltip:o.tooltip};l.iconUrl?(a=l.iconUrl,r.push(l.iconUrl)):a="16777215",void 0===s[a]&&(s[a]=[]),void 0==h[l.id]&&(h[l.id]=!0),s[a].push(l)}t(r)},this.remove=function(e){if(e){var t=e.iconUrl?e.iconUrl:"16777215";if(void 0!==s[t]){for(var i=!1,n=s[t],r=0,a=n.length;r<a;++r)if(n[r].id===e.id){n.splice(r,1),i=!0;break}i&&this.update()}}},this.removeById=function(e){var t=!1;for(var i in s)if(s.hasOwnProperty(i))for(var n=s[i],r=0,a=n.length;r<a;++r)if(n[r].id===e){n.splice(r,1),t=!0;break}t&&this.update()},this.getItemById=function(e){for(var t in s)if(s.hasOwnProperty(t))for(var i=s[t],n=0,r=i.length;n<r;++n){var a=i[n];if(a.id===e)return{id:a.id,position:{x:a.position.x,y:a.position.y,z:a.position.z},size:a.size,iconUrl:a.iconUrl,tooltip:a.tooltip}}return null},this.getItems=function(){var e=[];for(var t in s)if(s.hasOwnProperty(t))for(var i=s[t],n=0,r=i.length;n<r;++n){var a=i[n];e.push({id:a.id,position:{x:a.position.x,y:a.position.y,z:a.position.z},size:a.size,iconUrl:a.iconUrl,tooltip:a.tooltip})}return e.length>0?e:null},this.clear=function(){a&&a.clear(),i();for(var e in s)s.hasOwnProperty(e)&&delete s[e];this.update()},this.activate=function(){this.clear()},this.deactivate=function(){this.clear(),a&&(r.removeObjectGroup(a),a=null)},this.show=function(){a&&(a.visible=!0),o=!1;for(var e in h)h.hasOwnProperty(e)&&(h[e]=!0);this.update()},this.showByIds=function(e){if(a&&(a.visible=!0),o=!1,e&&e instanceof Array){for(var t=0,i=e.length;t<i;t++)h[e[t]]=!0;this.update()}},this.hide=function(){a&&(a.visible=!1),o=!0;for(var e in h)h.hasOwnProperty(e)&&(h[e]=!1);this.update()},this.hideByIds=function(e){if(e&&e instanceof Array){for(var t=0,i=e.length;t<i;t++)h[e[t]]=!1;this.update()}},this.load=function(e){this.clear(),this.add(e),this.update()},this.update=function(){if(!o){a||(a=r.getOrCreateObjectGroup(CLOUD.ObjectGroupType.MARKER3D,{pickableType:CLOUD.PICKABLETYPE.Marker3d,hoverEnabled:!0,priority:2,globalSpace:!0})),a.clear();for(var e in s)if(s.hasOwnProperty(e)){var t=s[e],i=t.length;if(i<1)continue;for(var n=l[e],c=new Float32Array(3*i),u=new Float32Array(i),d=new THREE.Vector3,f=0,p=[],m=0;m<i;++m){var g=t[m];h[g.id]&&(d.set(g.position.x,g.position.y,g.position.z),d.toArray(c,3*m),u[m]=g.size,p.push(g.id),f<g.size&&(f=g.size))}var v=new THREE.BufferGeometry;v.addAttribute("position",new THREE.BufferAttribute(c,3)),v.addAttribute("attrSize",new THREE.BufferAttribute(u,1));var y=new THREE.PointsMaterial({size:f,sizeAttenuation:!1,positionOffset:!0,sizeAttribute:!0,map:n,depthTest:!0,alphaTest:.001,transparent:!0});y.color.setHex(16777215);var E=new CLOUD.PointsEx(v,y);E.name=e,E.size=f,E.pointIds=p,1==CLOUD.GlobalData.IncrementRender?E.renderOrder=100:E.renderOrder=-1,a.add(E),E.matrixAutoUpdate=!1,E.updateMatrixWorld(!0)}a.updateMatrixWorld(!0)}}};var AreaNode=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.AREANODE,{priority:20}));return e.globalSpace=!0,e.areaInfo=new Array,e.areaGeometries=new Array,e.areaMeshes=new Array,e.areaMaterial=new THREE.LineMaterial({color:1005740}),e.areaMaterial.linewidth=5,e.areaMaterial.depthTest=!1,e}return _inherits(t,e),_createClass(t,[{key:"addAreaInfo",value:function(e){var t=this.areaInfo.length;return this.areaInfo.push(e),this.update(t),t}},{key:"setAreaInfo",value:function(e,t){return void 0!==e&&(this.areaInfo.length>e&&(this.areaInfo[e]=t,this.update(e),!0))}},{key:"setAreaLineColor",value:function(e){this.areaMaterial=new THREE.LineMaterial(e),this.areaMaterial.linewidth=1}},{
key:"removeAreaInfo",value:function(e){if(void 0===e)return!1;if(this.areaMesh&&this.remove(this.areaMesh),this.areaInfo.length>e){this.areaInfo.splice(e,1),this.areaGeometries.splice(e,1);var t=this.areaMeshes[e];return this.remove(t),this.areaMeshes.splice(e,1),!0}return!1}},{key:"update",value:function(e){if(!(void 0===e||this.areaInfo.length<e)){for(var t=this.areaInfo[e].length,i=new Array,n=0;n<t;++n)for(var r=this.areaInfo[e][n],a=0,o=r.length;a<o;++a){var s=r[a];i.push(s.x),i.push(s.y),i.push(s.z)}this.areaMesh&&this.remove(this.areaMesh);var l=new THREE.LineSegmentsGeometry;l.setPositions(i),this.areaMaterial.resolution.set(window.innerWidth,window.innerHeight),this.areaMesh=new THREE.LineSegments2(l,this.areaMaterial),this.areaMesh.renderOrder=100,this.add(this.areaMesh),this.updateMatrixWorld(!0)}}}]),t}(CLOUD.ObjectGroup);CLOUD.AreaNode=AreaNode;var AxisGridManager=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.AXISGRIDMANAGER,{priority:20}));return e.globalSpace=!0,e.materialMap={},e.meshUuidMap={},e.floorHeightMap={},e.gridLineColor="#333333",e.gridBubbleColor="#333333",e.bEnableHover=!0,e.mapAxisTypes={GRIDLINE:1,GRIDBUBBLE:2},e}return _inherits(t,e),_createClass(t,[{key:"getAxisGridState",value:function(){var e={},t=this.meshUuidMap;for(var i in t)if(t.hasOwnProperty(i)){e[i]=[];for(var n in t[i])if(t[i].hasOwnProperty(n)&&0!==Object.keys(t[i][n]).length){var r={};r.id=n,r.height=this.floorHeightMap[i][n],e[i].push(r)}}var a={};return e.hasOwnProperty("default")?a.floorInfos=e.default:a=e,a.gridLineColor=this.gridLineColor,a.gridBubbleColor=this.gridBubbleColor,a}},{key:"addMeshUuidInMap",value:function(e,t,i,n){var r=this.meshUuidMap;r.hasOwnProperty(e)||(r[e]={}),r[e].hasOwnProperty(t)||(r[e][t]={}),r[e][t].hasOwnProperty(i)||(r[e][t][i]={}),r[e][t][i][n]=!0}},{key:"addFloorHeightInMap",value:function(e,t,i){var n=this.floorHeightMap;n.hasOwnProperty(e)||(n[e]={}),n[e].hasOwnProperty(t)||(n[e][t]={}),n[e][t]=i}},{key:"removeFloorHeightInMap",value:function(e,t){var i=this.floorHeightMap;i.hasOwnProperty(e)&&i[e].hasOwnProperty(t)&&delete i[e][t]}},{key:"addLinesNode",value:function(e,t,i,n,r,a){var o=new THREE.BufferGeometry;o.addAttribute("position",new THREE.Float32BufferAttribute(e,3));var s=new THREE.Line(o,t);s.renderOrder=100,s.name=a,this.add(s),this.addMeshUuidInMap(i,n,r,s.uuid),this.updateMatrixWorld(!0)}},{key:"addTrianglesNode",value:function(e,t,i,n,r,a){var o=new THREE.BufferGeometry;o.setIndex(e.indexArray),o.addAttribute("position",new THREE.Float32BufferAttribute(e.vertexArray,3)),o.addAttribute("normal",new THREE.Float32BufferAttribute(e.normalArray,3));var s=new THREE.Mesh(o,t);s.renderOrder=110,s.name=a,this.add(s),this.addMeshUuidInMap(i,n,r,s.uuid),this.updateMatrixWorld(!0)}},{key:"createMaterial",value:function(e,t){return this.materialMap.hasOwnProperty(e)||(this.materialMap[e]={}),this.materialMap[e][t.color]?this.materialMap[e][t.color]:("string"!=typeof t.color&&(t.color="#"+t.color.getHEX()),this.materialMap[e][t.color]=CLOUD.MaterialUtil.createStandardMaterial(t),this.materialMap[e][t.color])}},{key:"loadAxisGridsByHeight",value:function(e,t,i,n,r){var a=this,o=new THREE.FileLoader;this.axisGridHeight=i,void 0!=i&&this.addFloorHeightInMap(t,n,i),o.load(e,function(o){var s=JSON.parse(o);a.gridsJson=s;var l=s.grids.length,c=l;if(l&&l>0)for(var u=0;u<l;u++){if("default"!=n){var h=s.grids[u].floors;if(void 0!=h&&-1==h.indexOf(n.toString())){c--;continue}}a.loadAxisGrid(e,t,u,i,n,function(){0==--c&&r&&r()})}})}},{key:"unloadAxisGridsByFloor",value:function(e,t){var i=this.children,n=this.meshUuidMap;if(n.hasOwnProperty(e)&&n[e].hasOwnProperty(t)){for(var r in n[e][t]){for(var a=n[e][t][r],o=0;o<i.length;){a[i[o].uuid]?i.splice(o,1):o++}delete n[e][t][r]}this.removeFloorHeightInMap(e,t)}}},{key:"loadAxisGrid",value:function(e,t,i,n,r,a){var o=this,s=e.split("/");void 0==n&&(r=s[s.length-1].split(".")[0]);var l=0;(new THREE.FileLoader).load(e,function(e){var s=JSON.parse(e);if(i&&i>=0){if(!(i<s.grids.length))return void console.log("Input grid index is invalid.");l=i}for(var c=s.grids[l].gridLines,u=0;u<c.length;++u){var h=c[u].type;if("Circle"==h){var d=s.radius,f=c[u].circleCenter,p=new THREE.CircleGeometry(d,180),m=new THREE.MeshBasicMaterial({color:16777215,side:THREE.DoubleSide,opacity:.5}),g=new THREE.Mesh(p,m);g.position.set(f[0],f[1],n-.5),g.renderOrder=90,o.addMeshUuidInMap(t,r,l,g.uuid),o.add(g)}var v=c[u].lines,y=c[u].color||o.gridLineColor,E=o.mapAxisTypes.GRIDLINE;"Circle"==h&&(y=o.gridBubbleColor,"string"!=typeof y&&(y="#"+y.getHEX()),E=o.mapAxisTypes.GRIDBUBBLE);var m=o.createMaterial(E,{color:y,side:THREE.DoubleSide}),x=o.prepareLinesBuffer(v,n);o.addLinesNode(x,m,t,r,l,E)}for(var b=s.grids[l].texts,C=0;C<b.length;++C){var e=b[C],M=e.color||o.gridBubbleColor;"string"!=typeof M&&(M="#"+M.getHEX());var E=o.mapAxisTypes.GRIDBUBBLE,m=o.createMaterial(E,{color:M,side:THREE.DoubleSide}),_=o.prepareTrianglesBuffer(e.indexs,e.vertexs,n);o.addTrianglesNode(_,m,t,r,l,E)}a&&a()})}},{key:"prepareLinesBuffer",value:function(e,t){for(var i=[],n=0;n<e.length;++n){var r=e[n];t&&!isNaN(t)&&(r[2]=t,r[5]=t),i.push(r[0],r[1],r[2]),i.push(r[3],r[4],r[5])}return i}},{key:"prepareTrianglesBuffer",value:function(e,t,i){for(var n=[],r=[],a=0;a<t.length;++a){var o=t[a];if(void 0==o||void 0==o[0]||void 0==o[1]||void 0==o[2]){console.log("Contains invalid vertex.");break}i&&!isNaN(i)&&(o[2]=i),n.push(o[0],o[1],o[2]),r.push(0,0,1,0,0,1,0,0,1)}return{indexArray:e,vertexArray:n,normalArray:r}}},{key:"unloadAxisGrid",value:function(e,t,i){var n=this.children,r=this.meshUuidMap;if(r.hasOwnProperty(e)&&r[e].hasOwnProperty(t)&&r[e][t].hasOwnProperty(i)){for(var a=r[e][t][i],o=0;o<n.length;){a[n[o].uuid]?n.splice(o,1):o++}delete r[e][t][i]}}},{key:"unloadAllAxisGrids",value:function(){var e=this.meshUuidMap;for(var t in e)if(e.hasOwnProperty(t))for(var i in e[t])if(e[t].hasOwnProperty(i)){for(var n in e[t][i])e[t][i].hasOwnProperty(n)&&this.unloadAxisGrid(t,i,n);this.removeFloorHeightInMap(t,i)}}},{key:"enableDepthTest",value:function(e){for(var t=this.children,i=0;i<t.length;i++)t[i].material.depthTest=e}},{key:"prepareGridLines",value:function(){this.verticalLines=[],this.horizontalLines=[];var e,t=this.gridsJson.grids,i=this.floorHeightMap.default;for(var n in i)if(i[n]==this.getAxisGridHeight()){e=n;break}for(var r=0;r<t.length;){-1==t[r].floors.indexOf(e)?t.splice(r,1):r++}for(var a=0;a<t.length;a++){var o=t[a].gridLines[0].lines[0];o.name=t[a].name,o[0]==o[3]?this.horizontalLines.push(o):this.verticalLines.push(o)}}},{key:"calculateIntersections",value:function(){this.prepareGridLines(),this.mapIntersectAxisLines={},this.intersections=[];for(var e,t,i,n,r=this.horizontalLines.length,a=this.verticalLines.length,o=0;o<r;o++){var s=this.horizontalLines[o];e=new THREE.Vector2(s[0],s[1]),t=new THREE.Vector2(s[3],s[4]);for(var l=0;l<a;l++){var c=this.verticalLines[l];if(i=new THREE.Vector2(c[0],c[1]),n=new THREE.Vector2(c[3],c[4]),i.y<=Math.max(e.y,t.y)&&i.y>=Math.min(e.y,t.y)&&e.x<=Math.max(i.x,n.x)&&e.x>=Math.min(i.x,n.x)){var u=new THREE.Vector3(e.x,i.y,this.axisGridHeight);u.name=s.name+c.name,this.mapIntersectAxisLines.hasOwnProperty(u.name)||(this.mapIntersectAxisLines[u.name]=[]),this.mapIntersectAxisLines[u.name].push(s),this.mapIntersectAxisLines[u.name].push(c),this.intersections.push(u)}}}}},{key:"getAxisGridHeight",value:function(){return this.axisGridHeight}},{key:"getAxisGridPlane",value:function(){var e=new THREE.Plane,t=this.getAxisGridHeight();return e.setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,t)),e}},{key:"snaping",value:function(e){this.calculateIntersections();for(var t={toIntersection:1/0,toGridLine:1/0},i={toIntersection:new THREE.Vector3,toGridLine:new THREE.Vector3},n=0;n<this.intersections.length;n++){var r=this.intersections[n].clone();r.name=this.intersections[n].name;var a=r.distanceTo(e);a<t.toIntersection&&(t.toIntersection=a,i.toIntersection=r)}for(var o=null,s=0,l=0;l<this.horizontalLines.length;l++){var c=this.horizontalLines[l];e.y>Math.max(c[1],c[4])||e.y<Math.min(c[1],c[4])||(s=Math.abs(c[0]-e.x))<t.toGridLine&&(t.toGridLine=s,o=c,i.toGridLine=new THREE.Vector3(c[0],e.y,this.axisGridHeight))}for(var u=0;u<this.verticalLines.length;u++){var h=this.verticalLines[u];e.x>Math.max(h[0],h[3])||e.x<Math.min(h[0],h[3])||(s=Math.abs(h[1]-e.y))<t.toGridLine&&(t.toGridLine=s,o=h,i.toGridLine=new THREE.Vector3(e.x,h[1],this.axisGridHeight))}var d={};return d.intersectLines=this.mapIntersectAxisLines[i.toIntersection.name],d.gridLine=o,{point:e,height:this.axisGridHeight,snapLines:d,nearestPoint:i,minDistance:t}}},{key:"setGridBubblesColor",value:function(e){this.gridBubbleColor=e;for(var t=this.children,i=0;i<t.length;i++)t[i].name==this.mapAxisTypes.GRIDBUBBLE&&(t[i].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[i].material.opacity=e.alpha)}},{key:"getGridBubblesColor",value:function(){return this.gridBubbleColor}},{key:"setGridLinesColor",value:function(e){this.gridLineColor=e;for(var t=this.children,i=0;i<t.length;i++)t[i].name==this.mapAxisTypes.GRIDLINE&&(t[i].material.color=new THREE.Color(e.red/255,e.green/255,e.blue/255),t[i].material.alpha=e.alpha)}},{key:"getGridLinesColor",value:function(){return this.gridLineColor}},{key:"getElements",value:function(){return this.children}},{key:"setIsEnableHover",value:function(e){this.bEnableHover=e}},{key:"getIsEnableHover",value:function(){return this.bEnableHover}}]),t}(CLOUD.ObjectGroup);CLOUD.AxisGridManager=AxisGridManager;var ExtrudeBodyManager=function(e){function t(){_classCallCheck(this,t);var e=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this,CLOUD.ObjectGroupType.EXTRUDEBODYMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,priority:20}));return e.globalSpace=!0,e.mapColorToNodeId={},e.selectionIds={},e.selectionColor={red:50,green:224,blue:240,alpha:.3},e.selectionEdgeColor={red:50,green:224,blue:240,alpha:1},e}return _inherits(t,e),_createClass(t,[{key:"addNode",value:function(e,t,i,n,r,a){a=void 0==a||a;var o=this.getNode(e);if(o)return o.material=n,this.setColorInMap(o.name,n),void((o=this.getNode("wireframe_"+e))&&(o.material=r,this.setColorInMap(o.name,r)));var s=new Array,l=0;if(t.belong&&"user"==t.belong)s=t.roomBoundary,l=t.offsetZ;else{t.version&&"2.0"==t.version&&(t=t.loops&&t.loops.length>0?t.loops[0]:[]);for(var c=t.length,u=0;u<c;++u)for(var h=t[u],d=h.length,f=0;f<d-1;f++){var p=h[f];s.push(new THREE.Vector2(p.x,p.y)),0==u&&0==f&&(l=p.z)}s.length>0&&s.push(s[0])}var m=new THREE.Shape(s),g={amount:i},v=new THREE.ExtrudeGeometry(m,g);n.depthTest=!a,v.boundingBox||v.computeBoundingBox();var y=new THREE.Mesh(v,n);y.name=e.toString(),y.translateZ(l),this.setColorInMap(y.name,n),this.add(y),this.updateMatrixWorld(!0);for(var E=y.geometry.faces,x=[],u=0,d=E.length;u<d;u++)x.push(E[u].a),x.push(E[u].b),x.push(E[u].c);for(var b=y.geometry.vertices,C=[],u=0,d=b.length;u<d;u++)C.push(b[u].x),C.push(b[u].y),C.push(b[u].z);var M=CLOUD.BuildEdge(C,x,Math.PI/3.5),_=new THREE.BufferGeometry;_.setIndex(new THREE.Uint32BufferAttribute(M,1)),_.addAttribute("position",new THREE.Float32BufferAttribute(C,3)),r.depthTest=!a,r.transparent=!0;var w=new THREE.LineSegments(_,r);w.translateZ(l),w.name="wireframe_"+e,this.setColorInMap(w.name,r),this.add(w),this.updateMatrixWorld(!0)}},{key:"setColorInMap",value:function(e,t){var i={red:255*t.color.r,green:255*t.color.g,blue:255*t.color.b,alpha:t.opacity};this.mapColorToNodeId[e]=i}},{key:"createMaterial",value:function(e){return CLOUD.MaterialUtil.createStandardMaterial(e)}},{key:"setNodeMaterial",value:function(e,t,i){var n=this.getNode(e);if(n){var r=n.material;for(var a in t){var o=a;r.hasOwnProperty(o)&&(r[o]="color"==o?new THREE.Color(t[a]):t[a])}}if(n=this.getNode("wireframe_"+e)){var r=n.material;for(var a in i){var o=a;r.hasOwnProperty(o)&&(r[o]="color"==o?new THREE.Color(i[a]):i[a])}}}},{key:"getNode",value:function(e){for(var t=this.children,i=0,n=t.length;i<n;i++)if(t[i].name==e.toString())return t[i];return null}},{key:"removeNodeById",value:function(e){var t=this.getNode(e);return t&&(delete this.mapColorToNodeId[t.name],this.remove(t)),!!(t=this.getNode("wireframe_"+e))&&(delete this.mapColorToNodeId[t.name],this.remove(t),!0)}},{key:"clearNodes",value:function(){this.clear(),this.mapColorToNodeId={}}},{key:"setNodeVisibleById",value:function(e,t){var i=this.getNode(e);return i&&(i.visible=t),!!(i=this.getNode("wireframe_"+e))&&(i.visible=t,!0)}},{key:"showAllNodes",value:function(){for(var e=this.children,t=0,i=e.length;t<i;t++)e[t].visible=!0}},{key:"hideAllNodes",value:function(){for(var e=this.children,t=0,i=e.length;t<i;t++)e[t].visible=!1}},{key:"setNodeColorById",value:function(e,t){var i=this.getNode(e);if(i){var n=i.material;return n.color=new THREE.Color(t.red/255,t.green/255,t.blue/255),n.opacity=t.alpha,t!=this.selectionColor&&t!=this.selectionEdgeColor&&this.setColorInMap(i.name,n),!0}return!1}},{key:"getNodeColorById",value:function(e){return this.mapColorToNodeId[e]}},{key:"setWireframeColorById",value:function(e,t){return this.setNodeColorById("wireframe_"+e,t)}},{key:"getWireframeColorById",value:function(e){return this.getNodeColorById("wireframe_"+e)}},{key:"applySelection",value:function(e){this.clearSelection();var t=this.selectionIds,i=this.mapColorToNodeId,n=e.sceneState.selectionSet;for(var r in n)i[r]&&(t[r]=!0,this.setNodeColorById(r,this.selectionColor),this.setWireframeColorById(r,this.selectionEdgeColor))}},{key:"clearSelection",value:function(){var e=this.selectionIds,t=this.mapColorToNodeId;if(e){for(var i=this.children,n=0,r=i.length;n<r;n++){var a=i[n],o=t[a.name];a.material.color=new THREE.Color(o.red/255,o.green/255,o.blue/255),a.material.opacity=o.alpha}this.selectionIds={}}}},{key:"applyHover",value:function(e){var t=e.sceneState;if(t.hoverId&&!t.isSelected(t.hoverId)){var i=this.getNode(t.hoverId);if(i){this.hoveredId=t.hoverId;var n=this.mapColorToNodeId[this.hoveredId],r=CLOUD.MaterialUtil.getHoverColorByColor({r:n.red/255,g:n.green/255,b:n.blue/255,a:n.alpha});i.material.color.setRGB(r.r,r.g,r.b),i.material.opacity=r.a}}}},{key:"clearHover",value:function(){var e=this.hoveredId;if(e){if(this.selectionIds[e])return void(this.hoveredId=null);var t=this.getNode(e);if(!t)return void(this.hoveredId=null);var i=this.mapColorToNodeId[e];t.material.color.setRGB(i.red/255,i.green/255,i.blue/255),t.material.opacity=i.alpha,this.hoveredId=null}}}]),t}(CLOUD.ObjectGroup);CLOUD.ExtrudeBodyManager=ExtrudeBodyManager;var AreaInfo=function(){function e(t){_classCallCheck(this,e),this.roomName=t,this.belong="user",this.roomBoundary=null,this.offsetZ=0,this.boundingBox=0}return _createClass(e,[{key:"checkRoomBoundary",value:function(e){function t(e,t,i){return(t.x-e.x)*(i.y-e.y)-(i.x-e.x)*(t.y-e.y)}if(e.length<3)return console.log("Failed to create room boundary, the number of the points must be more than three."),!1;this.offsetZ=e[0][2];var i=new THREE.Box2,n=[];n.push(new THREE.Vector2(e[0][0],e[0][1]));for(var r=1,a=e.length;r<a;r++){if(3!=e[r].length)return console.log("Failed to create room boundary, the format of boundary is not right, please follow [[x1,y1,z1],...]"),!1;if(e[r][0]!=e[r-1][0]||e[r][1]!=e[r-1][1]){var o=new THREE.Vector2(e[r][0],e[r][1]);n.push(o),i.expandByPoint(o)}}var s=n.length;if(s<3)return console.log("Failed to create room boundary, points are collinear."),!1;if(3==s)return 0==t(n[0],n[1],n[2])?(console.log("Failed to create room boundary, points are collinear."),!1):(n.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=n,!0);for(var l,c,u,h,r=0;r<s;r++){l=n[r],c=n[r==s-1?0:r+1];for(var d=r+2;d<s;d++)if((0!=r||d!=s-1)&&(u=n[d],h=n[d==s-1?0:d+1],function(e,i,n,r){return!(t(e,i,n)*t(e,i,r)>0)&&!(t(n,r,e)*t(n,r,i)>0)}(l,c,u,h)))return console.log("Failed to create room boundary, the room boundary is self-intersection."),!1}return n.push(new THREE.Vector2(e[0][0],e[0][1])),this.roomBoundary=n,this.boundingBox=i,!0}}]),e}();CLOUD.AreaInfo=AreaInfo;var CollisionManager=function(){function e(){_classCallCheck(this,e),this.condition=[{categoryId:"-2000011"}],this.distance=15}return _createClass(e,[{key:"setCondition",value:function(e){e instanceof Array&&(this.condition=e)}},{key:"getCondition",value:function(){return this.condition}},{key:"getDistance",value:function(){return this.distance}},{key:"matchConditions",value:function(e){var t=this.condition;if(0==t.length)return!1;for(var i=!0,n=0,r=t.length;n<r;n++){var a=t[n];for(var o in a)if(!e.hasOwnProperty(o)||e[o]!=a[o]){i=!1;break}if(1==i)break;n<t.length-1&&(i=!0)}return i}},{key:"hasCollision",value:function(e,t){if(!e)return!1;var i=this.matchConditions(e),n=t<=this.distance;return!(!i||!n)}}]),e}();CLOUD.CollisionManager=CollisionManager,function(){var e=function(){function e(t){_classCallCheck(this,e),this.model=t.modelManager.getFirstModel(),this.model.registerPlugin(this),this.material=CLOUD.MaterialUtil.getDefaultStandardMaterial(),this.loader=new CLOUD.SegmentLoader(this),this.index=0,this.segmentIdMap={},this.segmentPathMap={},this.segmentIdArray=[],this.elementIdMap={},this.partialElementMap={},this.partialNodeInfoMapFromNodeId={},this.partialNodeIdMapFromSegmentId={},this.partialParentUserIdMapFromSegmentId={},this.partialNodeIdMapFromUserId={},this.geometryIdMapFromDataId={},this.dataBufferMapFromGeometryId={},this.geometryMapFromGeometryId={},this.meshNodeMapFromNodeId={},this.nodeIdMapOctantMap={},this.selectedNodeIdArray=[],this.hoveredNodeIdArray=[]}return _createClass(e,[{key:"destroy",value:function(){this.removeSegmentBufferByDataIds(Object.keys(this.geometryIdMapFromDataId)),this.model=null,this.loader.destroy(),this.loader=null,this.material=null,this.segmentIdMap=null,this.segmentPathMap=null,this.segmentIdArray=null,this.elementIdMap=null,this.partialElementMap=null,this.partialNodeInfoMapFromNodeId=null,this.partialNodeIdMapFromSegmentId=null,this.partialParentUserIdMapFromSegmentId=null,this.partialNodeIdMapFromUserId=null,this.geometryIdMapFromDataId=null,this.dataBufferMapFromGeometryId=null,this.geometryMapFromGeometryId=null,this.meshNodeMapFromNodeId=null,this.nodeIdMapOctantMap=null,this.selectedNodeIdArray=null,this.hoveredNodeIdArray=null,this.segmentIdMapFromPartialElementId&&(this.segmentIdMapFromPartialElementId=null)}},{key:"removeFromSegmentIdMap",value:function(e){for(var t=0,i=e.length;t<i;t++){var n=e[t],r=this.segmentIdMap[n];r&&(delete this.segmentIdMap[n],delete this.segmentPathMap[r][n],CLOUD.Utils.isOwnEmptyObject(this.segmentPathMap[r])&&delete this.segmentPathMap[r])}this.segmentIdArray=Object.keys(this.segmentIdMap)}},{key:"loadSegmentsByPaths",value:function(e,t){function i(e){var a=e;return function(){n.loadSegmentByTaskId(a,function(){a<r-1?requestAnimationFrame(i(a+1)):t&&t()})}}var n=this,r=e.length;requestAnimationFrame(i(0))}},{key:"loadSegmentByTaskId",value:function(e,t){var i=this.addedSegmentPaths[e];if(-1===i||"-1"===i)return void(t&&t());this.loader.load(i,function(){t&&t()})}},{key:"cacheSegmentBuffer",value:function(e,t,i){this.geometryIdMapFromDataId[e]||(this.geometryIdMapFromDataId[e]=[]);var n=e+"|"+t;this.geometryIdMapFromDataId[e].push(n),this.dataBufferMapFromGeometryId[n]=i}},{key:"removeSegmentBufferByDataIds",value:function(e){for(var t=0,i=e.length;t<i;t++){var n=CLOUD.Utils.getEncodedId(e[t]),r=this.geometryIdMapFromDataId[n];if(r){for(var a=0,o=r.length;a<o;a++){var s=r[a];this.disposeGeometryByGeometryId(s),delete this.dataBufferMapFromGeometryId[s]}delete this.geometryIdMapFromDataId[n]}}}},{key:"hasNodeInfoFromPartialNodeInfoMap",value:function(e){return!!this.partialNodeInfoMapFromNodeId[e]}},{key:"classifyNodeInfos",value:function(e){this.partialNodeInfoMapFromNodeId[e.nodeId]=e,this.partialNodeIdMapFromSegmentId[e.segmentId]||(this.partialNodeIdMapFromSegmentId[e.segmentId]=[]),this.partialNodeIdMapFromSegmentId[e.segmentId].push(e.nodeId),this.partialParentUserIdMapFromSegmentId[e.segmentId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]||(this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId]={}),this.partialParentUserIdMapFromSegmentId[e.segmentId][e.parentUserId][e.userId]=!0,this.partialNodeIdMapFromUserId[e.userId]||(this.partialNodeIdMapFromUserId[e.userId]=[]),this.partialNodeIdMapFromUserId[e.userId].push(e.nodeId)}},{key:"getAllPartialSegmentIds",value:function(){return Object.keys(this.partialNodeIdMapFromSegmentId)}},{key:"getNodeIdsBySegmentId",value:function(e){return this.partialNodeIdMapFromSegmentId[e]}},{key:"getNodeInfoByNodeId",value:function(e){return this.partialNodeInfoMapFromNodeId[e]}},{key:"getNodeIdsByUserId",value:function(e){return this.partialNodeIdMapFromUserId[e]}},{key:"getNodeInfosBySegmentId",value:function(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],n=0,r=t.length;n<r;n++){var a=this.getNodeInfoByNodeId(t[n]);a&&i.push(a)}return i}},{key:"getNodeInfosBySegmentIds",value:function(e){var t,i,n=[],r=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),a=r.usedSegmentIds,o=r.notUsedSegmentIds;for(t=0,i=a.length;t<i;t++)n=n.concat(this.getNodeInfosBySegmentId(a[t]));for(t=0,i=o.length;t<i;t++)n=n.concat(this.getNodeInfosBySegmentId(o[t]));return n}},{key:"getMeshNodeByNodeId",value:function(e){var t=this.getNodeInfoByNodeId(e);if(!t)return null;var i=this.getMeshNodeByNodeInfo(t);return i||null}},{key:"getMeshNodeByNodeInfo",value:function(e){if(this.meshNodeMapFromNodeId[e.nodeId])return this.meshNodeMapFromNodeId[e.nodeId];var t=this.getGeometryByGeometryId(e.geometryId);if(!t)return null;var i=this.model.getMaterialByMaterialId(e.materialId)||this.material,n=new CLOUD.MeshEx(t,i);return n.spawn({databagId:this.model.databagId,matrix:e.matrix}),n._nodeId=e.nodeId,n.name=e.userId,n._oriMaterial=i,e.boundingBox||(e.boundingBox=n.computeBoundingBox(),e.matrix&&e.boundingBox.applyMatrix4(e.matrix)),this.meshNodeMapFromNodeId[e.nodeId]=n,this.meshNodeMapFromNodeId[e.nodeId]}},{key:"getMeshNodesWithNotUsedSegment",value:function(e,t){for(var i=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),n=[],r=0,a=t.length;r<a;r++){var o=this.getNodeIdsBySegmentId(t[r]);if(o)for(var s=0,l=o.length;s<l;s++){var c=this.getNodeInfoByNodeId(o[s]);c&&i[c.parentUserId]&&n.push(c)}}return this.getMeshNodesByNodeInfos(n)}},{key:"getMeshNodesByNodeInfos",value:function(e){for(var t=[],i=0,n=e.length;i<n;i++){var r=this.getMeshNodeByNodeInfo(e[i]);r&&t.push(r)}return t}},{key:"getMeshNodesBySegmentId",value:function(e){var t=this.getNodeIdsBySegmentId(e);if(!t)return[];for(var i=[],n=0,r=t.length;n<r;n++){var a=this.getMeshNodeByNodeId(t[n]);a&&i.push(a)}return i}},{key:"getMeshNodesBySegmentIds",value:function(e){for(var t=[],i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),n=i.usedSegmentIds,r=i.notUsedSegmentIds,a=0,o=n.length;a<o;a++)t=t.concat(this.getMeshNodesBySegmentId(n[a]));return t=t.concat(this.getMeshNodesWithNotUsedSegment(n,r))}},{key:"getUserIdsBySegmentId",value:function(e){var t={},i={},n=this.getNodeIdsBySegmentId(e);if(n)for(var r=0,a=n.length;r<a;r++){var o=this.getNodeInfoByNodeId(n[r]);o&&(t[o.userId]=!0,i[o.parentUserId]=!0)}for(var s=this.elementIdMap[e],l=0,c=s.length;l<c;l++)i[s[l]]||(t[s[l]]=!0);return Object.keys(t)}},{key:"getUserIdsBySegmentIds",value:function(e){for(var t=[],i=0,n=e.length;i<n;i++)t=t.concat(this.getUserIdsBySegmentId(e[i]));return t}},{key:"getUserIdMapBySegmentIdAndParentUserId",value:function(e,t){return this.partialParentUserIdMapFromSegmentId[e]?this.partialParentUserIdMapFromSegmentId[e][t]:null}},{key:"getParentUserIdsBySegmentId",value:function(e){return this.partialParentUserIdMapFromSegmentId[e]?Object.keys(this.partialParentUserIdMapFromSegmentId[e]):[]}},{key:"getParentUserIdsBySegmentIds",value:function(e){for(var t=[],i=0,n=e.length;i<n;i++)t=t.concat(this.getParentUserIdsBySegmentId(e[i]));return t}},{key:"hasSegmentIdFromSegmentIdMap",value:function(e){return!!this.segmentIdMap[e]}},{key:"getGeometryByGeometryId",value:function(e){if(this.geometryMapFromGeometryId[e])return this.geometryMapFromGeometryId[e];var t=this.getGeometryDataBuffer(e);if(!t)return null;var i=new THREE.BufferGeometry;return i.setIndex(new THREE.BufferAttribute(t.I,1)),i.addAttribute("position",new THREE.BufferAttribute(t.P,3)),t.N&&i.addAttribute("normal",new THREE.BufferAttribute(t.N,3)),t.UV&&i.addAttribute("uv",new THREE.BufferAttribute(t.UV,2)),this.geometryMapFromGeometryId[e]=i,this.geometryMapFromGeometryId[e]}},{key:"getGeometryDataBuffer",value:function(e){return this.dataBufferMapFromGeometryId[e]}},{key:"disposeGeometryByGeometryId",value:function(e){this.geometryMapFromGeometryId[e]&&(this.geometryMapFromGeometryId[e].dispose(),delete this.geometryMapFromGeometryId[e])}},{key:"getUsedAndNotUsedSegmentIdsBySegmentIds",value:function(e){var t,i,n={};for(t=0,i=e.length;t<i;t++)this.hasSegmentIdFromSegmentIdMap(e[t])&&(n[e[t]]=!0);var r=[],a=this.getAllPartialSegmentIds();for(t=0,i=a.length;t<i;t++)n[a[t]]||r.push(a[t]);return{usedSegmentIds:Object.keys(n),notUsedSegmentIds:r}}},{key:"getNotUsedPartialUserIds",value:function(e,t){for(var i=[],n=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e)),r=CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(t)),a=Object.keys(r),o=[],s=0,l=a.length;s<l;s++){var c=a[s];n[c]&&o.push(c)}for(var u=0,h=o.length;u<h;u++)for(var d=0,f=t.length;d<f;d++){var p=this.getUserIdMapBySegmentIdAndParentUserId(t[d],o[u]);p&&(i=i.concat(Object.keys(p)))}return i}},{key:"updateNodeInfos",value:function(){var e=this,t=this.model;this.traversePartialElements(function(i,n,r){var a=e.getDescriptor().getNodeInfosByUserId(n);if(a)for(var o=0,s=a.length;o<s;o++){var l=a[o];if(!l.finalState&&(l.finalState=!0,l.nodeId=i+"|"+l.nodeId,!e.hasNodeInfoFromPartialNodeInfoMap(l.nodeId))){l.state=CLOUD.EnumObjectState.Visible,l.material=null,l.geometryId=i+"|"+l.geometryId,l.segmentId=""!==r.segmentId?r.segmentId:"unknown",l.parentUserId=r.parentUserId,l.single=!0,l.uv=!1;var c=t.getModelDescriptor().getNodeInfosByUserId(l.parentUserId);l.materialId=c?c[0].materialId:-1,l.cellId=c?c[0].cellId:0,l.userData=l.userData?l.userData:c?c[0].userData:null,e.classifyNodeInfos(l)}}}),this.initFilterManager()}},{key:"getNodeGroup",value:function(){return this.model._getNodeGroup("FlowSegments",{globalSpace:!0})}},{key:"updateMeshNodes",value:function(){this.clearAllMeshNodes();var e=this.segmentIdArray;if(this.applyReplacementBySegmentIds(e),0!==e.length){for(var t=this.getMeshNodesBySegmentIds(e),i=this.getNodeGroup(),n=0,r=t.length;n<r;n++)i.add(t[n]),this.addMeshToOctantMap(t[n]);i.updateMatrixWorld(!0)}}},{key:"addMeshToOctantMap",value:function(e){var t=this.model.manager,i=this.model.getEncodedDatabagId(),n=e._nodeId,r=this.getNodeInfoByNodeId(e._nodeId);t.addNodeInfoToOctantMap(i,r.cellId,r),t.addMeshToOctantMap(i,r.nodeId,e),this.nodeIdMapOctantMap[n]=!0}},{key:"clearMeshNodesFromOctantMap",value:function(){for(var e=this.model.manager,t=this.model.getEncodedDatabagId(),i=Object.keys(this.nodeIdMapOctantMap),n=0,r=i.length;n<r;n++)e.removeMeshFromOctantMap(t,this.getNodeInfoByNodeId(i[n]));this.nodeIdMapOctantMap={}}},{key:"clearAllMeshNodes",value:function(){this.getNodeGroup().clear(),this.clearMeshNodesFromOctantMap()}},{key:"removeFromMeshNodeMap",value:function(e){for(var t=0,i=e.length;t<i;t++){var n=this.getNodeIdsBySegmentId(e[t]);if(n)for(var r=0,a=n.length;r<a;r++){var o=n[r];this.disposeGeometryByGeometryId(this.getNodeInfoByNodeId(o).geometryId),delete this.meshNodeMapFromNodeId[o]}}}},{key:"applyReplacementBySegmentIds",value:function(e){if(!e||!e.length)return this.model.setReplacedUserIdMap(null),this.resetFilterState(),void this.model.applyReplacement();this.model.setReplacedUserIdMap(CLOUD.Utils.arrayToMap(this.getParentUserIdsBySegmentIds(e))),this.model.applyReplacement()}},{key:"restoreComponentsState",value:function(){for(var e=this.getMeshNodesBySegmentIds(this.segmentIdArray),t=0,i=e.length;t<i;t++)e[t].material=e[t]._oriMaterial,e[t].visible=!0}},{key:"restoreMeshNodeMaterialByNodeIds",value:function(e){for(var t=0,i=e.length;t<i;t++){var n=this.getMeshNodeByNodeId(e[t]);n&&(n.material=n._oriMaterial)}}},{key:"updateFilterManager",value:function(){this.model.manager.filter.reinitFilterManager(this.model.manager.getNodeInfos())}},{key:"initFilterManager",value:function(){this.usedNodeInfos=this.getNodeInfosBySegmentIds(this.segmentIdArray),this.model.getModelDescriptor().addToNodeInfoMap(this.usedNodeInfos),this.updateFilterManager()}},{key:"deinitFilterManager",value:function(){this.usedNodeInfos&&this.model.getModelDescriptor().removeFromNodeInfoMap(this.usedNodeInfos),this.updateFilterManager()}},{key:"applyFilter",value:function(){for(var e=this.model.manager.filter,t=e._hasHiddenFileIdFilter(),i=e._hasVisibleFilter(),n=e._hasOverrideMaterialFilter(),r=e._hasTransparentFilter(),a=e._getMaterialByName("scene"),o=this.getMeshNodesBySegmentIds(this.segmentIdArray),s=0,l=o.length;s<l;s++){var c=o[s];c.visible=!0,c.material=c._oriMaterial;var u=this.getNodeInfoByNodeId(c._nodeId);if(t&&e._isHiddenFileId(u)||i&&!1===e._isVisible(u))c.visible=!1;else if(r&&e._isTransparent(u))c.material=a;else if(n&&e._hasOverrideMaterial(u)){var h=e._getOverrideMaterial(u);if(!h||""===h.name)continue;c.material=e._getMaterialByName(h.name)}else;}}},{key:"applySelection",value:function(){var e=this.model.manager.sceneState,t=this.model.selectedMaterial,i=e.getSelection();this.clearSelection();var n=this.selectedNodeIdArray;this.traverseMeshNodeMapByUserIds(i,function(e,i){e.material=t,n.push(i)})}},{key:"clearSelection",value:function(){this.selectedNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.selectedNodeIdArray),this.selectedNodeIdArray.length=0)}},{key:"applyHover",value:function(){var e=this.model.manager,t=e.sceneState;if(t.hoverId&&!t.isSelected(t.hoverId)){this.clearHover();var i=this.model.manager.filter,n=this.hoveredNodeIdArray;this.traverseMeshNodeMapByUserIds([t.hoverId],function(r,a,o){var s=e.getOverrideMaterialByNodeInfo(o)||i._getOverrideMaterial(o)||r._oriMaterial;r.material=t.getHoverMaterial(s),n.push(a)})}}},{key:"clearHover",value:function(){this.hoveredNodeIdArray.length&&(this.restoreMeshNodeMaterialByNodeIds(this.hoveredNodeIdArray),this.hoveredNodeIdArray.length=0)}},{key:"traverseMeshNodeMapByUserIds",value:function(e,t){for(var i=0,n=e.length;i<n;i++){var r=this.getNodeIdsByUserId(e[i]);if(r&&r.length)for(var a=0,o=r.length;a<o;a++){var s=r[a],l=this.getNodeInfoByNodeId(s),c=this.getMeshNodeByNodeInfo(l);c&&t(c,s,l)}}}},{key:"getSegmentIdsByPartialElementId",value:function(e){if(this.segmentIdMapFromPartialElementId)return this.segmentIdMapFromPartialElementId[e];var t=this.segmentIdMapFromPartialElementId={};return this.traversePartialElements(function(e,i,n){t[i]||(t[i]=[]),t[i].push(n.segmentId),t[n.parentUserId]||(t[n.parentUserId]=[]),t[n.parentUserId].push(n.segmentId)}),t[e]}},{key:"cachePartialElements",value:function(e,t){this.partialElementMap[e]||(this.partialElementMap[e]={}),this.partialElementMap[e][t.partialElementId]={userId:t.partialElementId,segmentId:t.segmentId,parentUserId:t.elementId}}},{key:"traversePartialElements",value:function(e){for(var t in this.partialElementMap)for(var i in this.partialElementMap[t])e(t,i,this.partialElementMap[t][i])}},{key:"getSegmentIsolateOption",value:function(){return e.IsolateOption}},{key:"getSegmentMetadata",value:function(e,t,i){this.loader._loadMetadata(e,t,i)}},{key:"resetFilterState",value:function(){var e=this.model.manager.filter;e.showAll(),e.opaqueAll()}},{key:"unloadSegments",value:function(e){this.deinitFilterManager(),this.removeFromSegmentIdMap(e),this.removeFromMeshNodeMap(e),this.updateMeshNodes()}},{key:"loadSegments",
value:function(e,t){if(e instanceof Array&&0!==e.length){this.elementIdMap={};for(var i={},n={},r=0,a=e.length;r<a;r++){var o,s=e[r].id;o=e[r].paths.length?e[r].paths[0].databag:-1,i[s]=o,n[o]||(n[o]={}),n[o][s]=!0,this.elementIdMap[s]=e[r].elementIds||[]}var l=CLOUD.Utils.getDifferentialIdxs(i,this.segmentIdMap);this.segmentIdMap=l.objCurrUsedIdxs,this.segmentIdArray=Object.keys(this.segmentIdMap);var c=CLOUD.Utils.getDifferentialIdxs(n,this.segmentPathMap);this.segmentPathMap=c.objCurrUsedIdxs,this.addedSegmentPaths=c.addIdxs;var u=!1;if(l.removeIdxs.length&&(u=!0,this.removeFromMeshNodeMap(l.removeIdxs)),c.removeIdxs.length&&(u=!0,this.removeSegmentBufferByDataIds(c.removeIdxs)),0===this.addedSegmentPaths.length)return void(u&&this.updateMeshNodes());this.applyReplacementBySegmentIds(null);var h=this;this.loadSegmentsByPaths(this.addedSegmentPaths,function(){h.updateNodeInfos(),h.updateMeshNodes(),t&&t()})}}},{key:"hideComponentsBySegment",value:function(e){var t=this.model.manager.filter,i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),n=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.hideByIds(n)}},{key:"showComponentsBySegment",value:function(e){var t=this.model.manager.filter,i=this.getUsedAndNotUsedSegmentIdsBySegmentIds(e),n=this.getUserIdsBySegmentIds(i.usedSegmentIds);t.showByIds(n)}},{key:"isolateComponentsBySegment",value:function(t,i){var n=this.model.manager.filter,r=this.getUsedAndNotUsedSegmentIdsBySegmentIds(t),a=this.getUserIdsBySegmentIds(r.usedSegmentIds),o=this.getNotUsedPartialUserIds(r.usedSegmentIds,r.notUsedSegmentIds);switch(this.restoreComponentsState(),i){case e.IsolateOption.HIDDEN:n.hideAll(),n.showByIds(a);break;case e.IsolateOption.TRANSLUCENT:n.showByIds(a),o.length&&n.showByIds(o),n.makeTranslucentOthersByIds([]),n.opaqueByIds(a);break;case e.IsolateOption.PARTLYTRANSLUCENT:n.hideAll(),n.showByIds(a),o.length&&(n.showByIds(o),n.makeTranslucentByIds(o))}}},{key:"disable",value:function(){this.getNodeGroup().visible=!1,this.applyReplacementBySegmentIds(null)}},{key:"enable",value:function(){this.getNodeGroup().visible=!0,this.applyReplacementBySegmentIds(this.segmentIdArray)}},{key:"getDescriptor",value:function(){return this.loader.descriptor}}]),e}();e.IsolateOption=CLOUD.Utils.freezeObject({HIDDEN:0,TRANSLUCENT:1,PARTLYTRANSLUCENT:2}),CLOUD.SegmentManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.viewer.modelManager.registerPlugin(this),this.meshes={},this.customSelectMaterials={},this.databagId="ExternalComponent",this.objectIds=null,this.lastFilteredIds=null}return _createClass(e,[{key:"destroy",value:function(){this._removeNodeGroup(),this.viewer=null,this.meshes=null,this.customSelectMaterials=null,this.objectIds=null,this.lastFilteredIds=null}},{key:"addNode",value:function(e,t,i,n){if(this.meshes[e])return void console.log("Warning: name is already exist, please change name ");t instanceof Array||(t=[t]),this.meshes[e]=t,void 0===i&&(i=!1),n&&(this.customSelectMaterials[e]=n);for(var r=0,a=t.length;r<a;r++){var o=t[r];o.name=e,this._getNodeGroup().add(o),o.updateMatrixWorld(!0),i||this._cacheNodeMaterial(o)}this._addToNodeInfoMap({name:e,userId:e,state:CLOUD.EnumObjectState.Visible}),this._updateFilterManager(),this.objectIds=Object.keys(this.meshes)}},{key:"getNodeById",value:function(e){var t=this.meshes[e];return t&&1===t.length?t[0]:t}},{key:"removeNodeById",value:function(e){var t=this.meshes[e];if(t){delete this.meshes[e],this.customSelectMaterials[e]&&delete this.customSelectMaterials[e];for(var i=this._getNodeGroup(),n=0,r=t.length;n<r;n++)i.remove(t[n]);this._removeFromNodeInfoMap(e),this._updateFilterManager(),this.objectIds=Object.keys(this.meshes)}}},{key:"clearNodes",value:function(){this._getNodeGroup().clear(),this._clearNodeInfoMap(),this.meshes={},this.customSelectMaterials={},this.objectIds=null}},{key:"getAllNodes",value:function(){return this.meshes}},{key:"setTransform",value:function(e,t,i,n){var r=this.meshes[e];if(r)for(var a=0,o=r.length;a<o;a++){var s=r[a];t=t||s.position,s.position.x=t.x,s.position.y=t.y,s.position.z=t.z,i=i||s.scale,s.scale.x=i.x,s.scale.y=i.y,s.scale.z=i.z,n=n||s.quaternion,s.setRotationFromQuaternion(n),s.updateMatrixWorld()}}},{key:"getTransform",value:function(e){var t=this.meshes[e];return t?{position:t[0].position,scale:t[0].scale,rotate:t[0].quaternion}:null}},{key:"applyTransform",value:function(e,t,i,n){if(this.meshes[e]){t=t||new THREE.Vector3,i=i||new THREE.Vector3(1,1,1),n=n||new THREE.Quaternion;var r=new THREE.Matrix4;r.compose(t,n,i),this.applyTransformMatrix(e,r)}}},{key:"applyTransformMatrix",value:function(e,t){var i=this.meshes[e];if(i)for(var n=0,r=i.length;n<r;n++){var a=i[n];a._oriMatrix||(a._oriMatrix=a.matrix.clone()),a.matrix.multiplyMatrices(t,a._oriMatrix),a.updateMatrixWorld(!0)}}},{key:"applyFilter",value:function(){this._hasNode()&&(this._collectFilteredIds(),this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}},{key:"applySelection",value:function(){this._hasNode()&&(this._collectSelectedIds(),this._collectHoveredIds(),this._updateNodes())}},{key:"clearSelection",value:function(){this._hasNode()&&(this._clearSelectedIds(),this.applyHover())}},{key:"applyHover",value:function(){this._hasNode()&&(this._collectHoveredIds(),this._updateNodes())}},{key:"clearHover",value:function(){this._hasNode()&&(this._clearHoveredIds(),this._updateNodes())}},{key:"getAllNodeInfos",value:function(e){e[this.databagId]=this.nodeInfoMap}},{key:"_addToNodeInfoMap",value:function(e){this.nodeInfoMap||(this.nodeInfoMap={}),this.nodeInfoMap[e.userId]||(this.nodeInfoMap[e.userId]=[]),this.nodeInfoMap[e.userId].push(e)}},{key:"_removeFromNodeInfoMap",value:function(e){this.nodeInfoMap&&this.nodeInfoMap[e]&&delete this.nodeInfoMap[e]}},{key:"_clearNodeInfoMap",value:function(){this.nodeInfoMap=null}},{key:"_updateFilterManager",value:function(){var e=this.viewer.modelManager;e.filter.reinitFilterManager(e.getNodeInfos())}},{key:"_canBePick",value:function(e){return!!e._oriMaterial}},{key:"_getNodeGroup",value:function(){return this.viewer.modelManager.scene.getOrCreateObjectGroup(CLOUD.ObjectGroupType.EXTERNALCOMPONENTMANAGER,{pickableType:CLOUD.PICKABLETYPE.Geometry,globalSpace:!0})}},{key:"_removeNodeGroup",value:function(){this.viewer.modelManager.scene.removeObjectGroupByName(CLOUD.ObjectGroupType.EXTERNALCOMPONENTMANAGER)}},{key:"_cacheNodeMaterial",value:function(e){CLOUD.Utils.isGroupObject(e)?e.traverse(function(e){if(CLOUD.Utils.isMeshObject(e)&&!e._oriMaterial&&(e._oriMaterial=e.material,!e.geometry.index&&e.geometry.attributes&&e.geometry.attributes.position)){for(var t=[],i=e.geometry.attributes.position.array,n=0,r=i.length/3;n<r;n++)t.push(n);e.geometry.setIndex(new THREE.BufferAttribute(new Uint32Array(t),1))}}):e._oriMaterial||(e._oriMaterial=e.material)}},{key:"_collectFilteredIds",value:function(){var e=this.filteredIds={},t=this.viewer.modelManager.filter,i=t._hasHiddenFileIdFilter(),n=t._hasVisibleFilter(),r=t._hasOverrideMaterialFilter(),a=t._hasTransparentFilter();if(i||n||r||a)for(var o=this.objectIds,s=CLOUD.Model.EnumFilterState,l=0,c=o.length;l<c;l++){var u=o[l],h={name:u};if(n&&!1===t._isVisible(h))e[u]||(e[u]={}),e[u][s.HIDDEN]=!0;else if(a&&t._isTransparent(h))e[u]||(e[u]={}),e[u][s.TRANSPARENT]=!0;else if(r&&t._hasOverrideMaterial(h)){var d=t._getOverrideMaterial(h),f=null!=d?d.name:"";e[u]||(e[u]={}),e[u][s.OVERRIDED]=f}else;}}},{key:"_collectSelectedIds",value:function(){var e=this.filteredIds=this.filteredIds||{},t=CLOUD.Model.EnumFilterState,i=this.viewer.modelManager.sceneState.getSelection(),n={};this._clearSelectedIds();for(var r=0,a=i.length;r<a;r++){var o=i[r];this._hasObjectId(o)&&(e[o]||(e[o]={}),e[o][t.SELECTED]=!0,n[o]=!0)}this.selectedIds=Object.keys(n)}},{key:"_clearSelectedIds",value:function(){if(this.filteredIds&&this.selectedIds&&this.selectedIds.length){for(var e=0,t=this.selectedIds.length;e<t;e++){var i=this.selectedIds[e];this.filteredIds[i]&&delete this.filteredIds[i][CLOUD.Model.EnumFilterState.SELECTED]}this.selectedIds=null}}},{key:"_collectHoveredIds",value:function(){var e=this.viewer.modelManager.sceneState.hoverId;if(e&&this._hasObjectId(e)){var t=this.filteredIds=this.filteredIds||{};this.hoveredId=e,t[e]||(t[e]={}),t[e][CLOUD.Model.EnumFilterState.HOVER]=!0}}},{key:"_clearHoveredIds",value:function(){this.filteredIds&&this.hoveredId&&this.filteredIds[this.hoveredId]&&(delete this.filteredIds[this.hoveredId][CLOUD.Model.EnumFilterState.HOVER],this.hoveredId=void 0)}},{key:"_hasObjectId",value:function(e){return!!this.meshes[e]}},{key:"_hasNode",value:function(){return!(!this.objectIds||!this.objectIds.length)}},{key:"_traverseNodeById",value:function(e,t){if(this._hasObjectId(e))for(var i=this,n=this.meshes[e],r=0,a=n.length;r<a;r++){var o=n[r];CLOUD.Utils.isGroupObject(o)?o.traverseVisible(function(e){CLOUD.Utils.isMeshObject(e)&&i._canBePick(e)&&t&&t(e)}):CLOUD.Utils.isMeshObject(o)&&i._canBePick(o)&&t&&t(o)}}},{key:"_resetNodeMaterial",value:function(){var e=this.lastFilteredIds;if(e&&e.length)for(var t=0,i=e.length;t<i;t++)this._updateNodeVisible(e[t],!0),this._traverseNodeById(e[t],function(e){e.material=e._oriMaterial})}},{key:"_updateNodeVisible",value:function(e,t){for(var i=this.meshes[e],n=0,r=i.length;n<r;n++)i[n].visible=t}},{key:"_updateNodeById",value:function(e,t){if(this._hasObjectId(e)){var i=this.viewer.modelManager.sceneState,n=CLOUD.Model.EnumFilterState,r=this.filteredIds[e];if(r){if(r[n.HIDDEN])return void this._updateNodeVisible(e,!1);if(r[n.TRANSPARENT]){var a=t._getMaterialByName("scene");return void this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=a:e.material=CLOUD.Utils.extendObject(a.clone(),e._oriMaterial)})}if(r[n.SELECTED]){var o=i.selectionMaterial,s=this.customSelectMaterials[e];return void this._traverseNodeById(e,function(e){s?e.material=s:e._oriMaterial.isMeshPhongMaterial?(e.material=i.phongSelectionMaterial,e.material.skinning=e._oriMaterial.skinning):e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=o:e.material=CLOUD.Utils.extendObject(o.clone(),e._oriMaterial)})}if(r[n.HOVER])if(r[n.OVERRIDED]){var a=i.getHoverMaterial(t._getMaterialByName(r[n.OVERRIDED]));this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=a:e.material=CLOUD.Utils.extendObject(a.clone(),e._oriMaterial)})}else this._traverseNodeById(e,function(e){var t=i.getHoverMaterial(e._oriMaterial);e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=t:e.material=CLOUD.Utils.extendObject(t.clone(),e._oriMaterial)});else if(r[n.OVERRIDED]){var l=t._getMaterialByName(r[n.OVERRIDED]);return void this._traverseNodeById(e,function(e){e._oriMaterial instanceof CLOUD.CloudStandardMaterial?e.material=l:e.material=CLOUD.Utils.extendObject(l.clone(),e._oriMaterial)})}}}}},{key:"_updateNodes",value:function(){var e=this.viewer.modelManager.filter;if(this._resetNodeMaterial(),this.filteredIds){for(var t in this.filteredIds)this._updateNodeById(t,e);this.lastFilteredIds=Object.keys(this.filteredIds)}}}]),e}();CLOUD.ExternalComponentManager=e}(),function(){var e=function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.geometryMapFromComponentId={},this.externalObjectMap={},this.defaultMaterial=CLOUD.MaterialUtil.getDefaultStandardMaterial()}return _createClass(e,[{key:"destroy",value:function(){this.viewer=null,this.geometryMapFromComponentId=null,this.externalObjectMap=null,this.defaultMaterial=null}},{key:"clear",value:function(){this.geometryMapFromComponentId={},this.externalObjectMap={},this.cancelAllHidden()}},{key:"cancelHiddenByComponentId",value:function(e){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelHiddenByUserId(e)}},{key:"cancelAllHidden",value:function(){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().cancelAllHidden()}},{key:"convertToExternalObject",value:function(e,t,i){return this.externalObjectMap[e]?(console.warn("warning: the object already exists!"),this.externalObjectMap[e]):(this._hideByUserId(t,i),this.externalObjectMap[e]=this._createMeshNodes(e,t),this.externalObjectMap[e])}},{key:"getExternalObject",value:function(e){return this.externalObjectMap[e]}},{key:"_hideByUserId",value:function(e,t){this.viewer.setRenderStateChanged(!0),this.viewer.modelManager.getSourceObjectManager().hideByUserId(e,t)}},{key:"_getGeometries",value:function(e){var t=this.geometryMapFromComponentId[e];if(t)return t;var i=[];return this.viewer.modelManager.traverseModels(function(t){t._handler&&(i=i.concat(t._handler.getGeometryBuffersByUserId(e)))}),t=this.geometryMapFromComponentId[e]=this._createGeometry(i)}},{key:"_createGeometry",value:function(e){for(var t=[],i=0,n=e.length;i<n;i++){var r=e[i],a=new THREE.BufferGeometry;a.setIndex(new THREE.BufferAttribute(r.index,1)),a.addAttribute("position",new THREE.BufferAttribute(r.position,3)),a.computeVertexNormals(),t.push({info:r,geometry:a})}return t}},{key:"_createMeshNodes",value:function(e,t){for(var i=[],n=this._getGeometries(t),r=0,a=n.length;r<a;r++){var o=n[r].geometry,s=n[r].info,l=this.viewer.modelManager.getMaterialByNodeId(s.databagId,t,s.nodeId)||this.defaultMaterial,c=new THREE.Mesh(o,l);c.matrixAutoUpdate=!1,c.name=e,c._databagId=s.databagId,c._nodeId=s.nodeId,c._oriUserId=t,c._oriMaterial=l,s.matrix&&c.matrix.copy(s.matrix),i.push(c)}return i}}]),e}();CLOUD.ExternalObjectConverter=e}(),function(){var e=function(){function e(){_classCallCheck(this,e),this.hiddenUserIdMap={}}return _createClass(e,[{key:"destroy",value:function(){this.hiddenUserIdMap=null}},{key:"hideByUserId",value:function(e,t){this.hiddenUserIdMap||(this.hiddenUserIdMap={}),this.hiddenUserIdMap[e]=!!t}},{key:"cancelHiddenByUserId",value:function(e){this.hiddenUserIdMap&&delete this.hiddenUserIdMap[e]}},{key:"cancelAllHidden",value:function(){this.hiddenUserIdMap=null}},{key:"isHidden",value:function(e){return!!this.hiddenUserIdMap[e]}},{key:"hasHidden",value:function(){return!CLOUD.Utils.isEmptyObject(this.hiddenUserIdMap)}}]),e}();CLOUD.SourceObjectManager=e}(),CLOUD.Compatibility={convertAnnotationsToV3:function(e,t){function i(e,t,i){var n;n="string"==typeof e?JSON.parse(window.atob(e)):{position:{x:e.position.x,y:e.position.y,z:e.position.z},target:{x:e.target.x,y:e.target.y,z:e.target.z},up:{x:e.up.x,y:e.up.y,z:e.up.z}};var r=new THREE.Vector3(n.position.x,n.position.y,n.position.z),a=new THREE.Vector3(n.target.x,n.target.y,n.target.z),o=new THREE.Vector3(n.up.x,n.up.y,n.up.z),s=new CLOUD.CameraInfo("persp",r,a,o);return s=CLOUD.Camera.drawingToWorld(s,t),s=new CLOUD.CameraInfo("persp",s.position,s.target,s.up),s=CLOUD.Camera.worldToDrawing(s,i),n.position.x=s.position.x,n.position.y=s.position.y,n.position.z=s.position.z,n.target.x=s.target.x,n.target.y=s.target.y,n.target.z=s.target.z,n.up.x=s.up.x,n.up.y=s.up.y,n.up.z=s.up.z,"string"==typeof e&&(n=window.btoa(JSON.stringify(n))),n}var n=JSON.parse(t);if(n.filter){var r=JSON.parse(n.filter);if(r.filter||r.basicIds){var a=e.getScene(),o=a.getTransformMatrixGlobal();(new THREE.Matrix4).getInverse(o);var s=a.getMatrixGlobal();(new THREE.Matrix4).getInverse(s);var l=e.getFilter().getFilterType(),c={};c.state={},r.filter?(r.fileFilter&&(c.state[l.FILE_HIDDEN]=r.fileFilter),r.selectionSet&&(c.state[l.SELECTED]=r.selectionSet),r.filter.visibleIds&&(c.state[l.VISIBLE]=r.filter.visibleIds),r.filter.invisibleIds&&(c.state[l.HIDDEN]=r.filter.invisibleIds),r.filter.conditions&&(c.state[l.CONDITION_HIDDEN_OTHERS]=r.filter.conditions),r.filter.filters&&(c.state[l.USER_HIDDEN]=r.filter.filters),r.frozenSet&&(c.state[l.FROZENFILTER]=r.frozenSet),r.isolateSet&&(c.state[l.ISOLATE_HIDDEN_OTHERS]=r.isolateSet),r.overriderByIds&&(c.state[l.OVERRIDEFILTER]=r.overriderByIds),r.overriderByData&&(c.state[l.USER_OVERRIDE]=r.overriderByData),r.overriderCondition&&(c.state[l.CONDITION_OVERRIDE]=r.overriderCondition),r.isolateCondition&&(c.state[l.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.isolateCondition),c.state.sceneState=r.overriderByScene):r.basicIds&&(r.basicIds[1]&&(c.state[l.FILE_HIDDEN]=r.basicIds[1]),r.basicIds[2]&&(c.state[l.SELECTED]=r.basicIds[2]),r.basicIds[3]&&(c.state[l.VISIBLE]=r.basicIds[3]),r.basicIds[4]&&(c.state[l.HIDDEN]=r.basicIds[4]),r.conditions[0]&&(c.state[l.CONDITION_HIDDEN_OTHERS]=r.conditions[0]),r.userHiddenIds&&(c.state[l.USER_HIDDEN]=r.userHiddenIds),r.frozenIds&&(c.state[l.FROZENFILTER]=r.frozenIds),r.isolateIds&&(c.state[l.ISOLATE_HIDDEN_OTHERS]=r.isolateIds),r.overrideByIds&&(c.state[l.OVERRIDEFILTER]=r.overrideByIds),r.overrideByData&&(c.state[l.USER_OVERRIDE]=r.overrideByData),r.conditions[2]&&(c.state[l.CONDITION_OVERRIDE]=r.conditions[2]),r.isolateConditions&&(r.isolateConditions[0]&&(c.state[l.ISOLATE_CONDITION_HIDDEN]=r.isolateConditions[0]),r.isolateConditions[1]&&(c.state[l.ISOLATE_CONDITION_HIDDEN_OTHERS]=r.isolateConditions[1]),r.isolateConditions[2]&&(c.state[l.ISOLATE_CONDITION_TRANSLUCENT]=r.isolateConditions[2]),r.isolateConditions[3]&&(c.state[l.ISOLATE_CONDITION_TRANSLUCENT_OTHERS]=r.isolateConditions[3])),c.state.sceneState=r.sceneState),r.camera?c.camera=i(r.camera,o,s):c.camera=i(n.camera,o,s),r=c,n.filter=JSON.stringify(r)}}return n},isLoadLinesEnabled:function(e){return!(parseFloat(e)<=.12)},isLoadBMpkEnabled:function(e){return!(parseFloat(e)<.13)},isLoadLayerSceneEnabled:function(e){return!(parseFloat(e)<.15)},isUse32MpkData:function(e){return!(parseFloat(e)<.15)},use32MpkData:!1},CLOUD.Viewer=function(){this.domElement=null,this.camera=null,this.renderer=null,this.countRenderRequest=0,this.maxCountRenderRequest=1e4,this.rendering=!1,this.incrementRenderHandle=0,this.callbacks={},this.tmpBox=new THREE.Box3,this.enableCameraNearFar=!0,this.currentHomeView=CLOUD.EnumStandardView.ISO,this.initialView=CLOUD.EnumStandardView.ISO,this.filter=new CLOUD.FilterManager,this.modelManager=new CLOUD.ModelManager(this.filter),this.editorManager=new CLOUD.EditorManager,this.isRecalculationPlanes=!1,this.calculationPlanesBind=this.calculationPlanes.bind(this),this.addRenderFinishedCallback(this.calculationPlanesBind),this.transitionAnimationState=!0,this.animator=new CLOUD.CameraAnimator,this.animator.setDuration(1e3),this.IBLManager=new CLOUD.IBLManager(this),this.composer=null,this.blinkHandle=0},CLOUD.Viewer.prototype={constructor:CLOUD.Viewer,addCallbacks:function(e,t){var i=this.callbacks[e];i||(i=[],this.callbacks[e]=i),-1===i.indexOf(t)&&i.push(t)},removeCallbacks:function(e,t){var i=this.callbacks[e];if(i){var n=i.indexOf(t);-1!==n&&i.splice(n,1)}},removeAllCallbacks:function(){for(var e in this.callbacks)for(var t=this.callbacks[e],i=0,n=t.length;i<n;i++)t.splice(0,1);for(var e in this.callbacks)delete this.callbacks[e];this.callbacks={}},onCallbacks:function(e){var t=this.callbacks[e];if(t)for(var i=0;i<t.length;i++)t[i]&&t[i]()},addRenderCallback:function(e){this.addCallbacks("render",e)},removeRenderCallback:function(e){this.removeCallbacks("render",e)},onRenderCallback:function(){this.onCallbacks("render")},addRenderFinishedCallback:function(e){this.addCallbacks("renderFinished",e)},removeRenderFinishedCallback:function(e){this.removeCallbacks("renderFinished",e)},onRenderFinishedCallback:function(){this.onCallbacks("renderFinished")},destroy:function(){this.removeAllCallbacks(),this.editorManager.unregisterDomEventListeners(this.domElement),this.renderer&&this.domElement.removeChild(this.renderer.domElement),this.domElement=null,this.renderSettings=null,this.camera=null,this.defaultCamera=null,this.cameraControl.destroy(),this.cameraControl=null,this.editorManager.destroy(),this.modelManager.destroy(),this.incrementRenderHandle>0&&cancelAnimationFrame(this.incrementRenderHandle),this.blinkHandle>0&&cancelAnimationFrame(this.blinkHandle),this.renderer&&this.renderer.destroy&&(this.renderer.destroy(),this.orderedRenderer&&(this.renderer.setRenderer&&this.renderer.setRenderer(null),this.orderedRenderer=null)),this.composer&&(this.composer.destroy(),this.composer=null),this.renderer=null,this.modelManager=null,this.editorManager=null,this.callbacks=null,this.tmpBox=null,this.filter=null,this.calculationPlanesBind=null,this.animator=null,this.IBLManager=null},_setupRenderer:function(){if(!this.renderer){var e=this,t=this.renderSettings;CLOUD.GlobalData.BatchMergeEnabled?(this.renderer=new THREE.WebGLRenderer(t),console.log("renderer: batch merge renderer")):(this.modelManager.permitBlink(!0),this.renderer=new THREE.WebGLRendererByIncrement(t),this.orderedRenderer=new CLOUD.OrderedRenderer,this.renderer.setRenderer(this.orderedRenderer),this.renderer.setRenderTicket(0),console.log("renderer: increment renderer")),this.renderer.domElement.addEventListener("webglcontextlost",function(t){t.preventDefault(),e.incrementRenderHandle>0&&(cancelAnimationFrame(e.incrementRenderHandle),console.log("---------------- webglcontextlost --------------"))},!1);var i=this.domElement.offsetWidth,n=this.domElement.offsetHeight;this.renderer.setClearColor(0,0),this.renderer.setPixelRatio(window.devicePixelRatio||1),this.renderer.setSize(i,n),this.renderer.toneMapping=CLOUD.GlobalData.ToneMapping,this.renderer.gammaFactor=2.2,this.renderer.gammaInput=!0,this.renderer.gammaOutput=!0,this.renderer.domElement.setAttribute("tabindex","0"),this.renderer.domElement.setAttribute("id","cloud-main-canvas"),this.domElement.appendChild(this.renderer.domElement),this.editorManager.registerDomEventListeners(this.domElement),CLOUD.GlobalData.EnableSelectionOutline&&CLOUD.GlobalData.BatchMergeEnabled&&(this.renderer.shadowMap.enabled=!0,this.composer=new CLOUD.RenderEffectComposer(this.renderer),this.composer.init(this.modelManager,this.getScene(),this.camera,i,n))}},init:function(e){console.log("Web3D: "+CLOUD.Version),CLOUD.GlobalData.IsMobile=!this.isDesktop();var t=this,i=CLOUD.GlobalData.maxDrawCacheNum,n={alpha:!0,preserveDrawingBuffer:!0,antialias:!0,maxDrawCacheNum:i,stencil:!0,logarithmicDepthBuffer:!1};CLOUD.GlobalData.EnableLogarithmicDepthBuffer&&(n.logarithmicDepthBuffer=!0);var r;try{r=document.createElement("canvas");var a=r.getContext("webgl",n)||r.getContext("experimental-webgl",n);a||(n.antialias=!1),n.webglContext=a}catch(e){return!1}this.domElement=e,CLOUD.GeomUtil.initializeUnitInstances(),n.canvas=r,this.renderSettings=n;var o=e.offsetWidth,s=e.offsetHeight,l={width:o,height:s,fov:45,near:.1,far:20*CLOUD.GlobalData.SceneSize};return this.camera=this.defaultCamera=new CLOUD.Camera(CLOUD.CAMERATYPE.PERSPECTIVE,l),this.setEditorDefault(),this.cameraControl=this.editorManager.getCameraControl(),this.modelManager.onUpdateViewer=function(){t.render(!0)},!0},render:function(e){var t=this.modelManager,i=this.renderer,n=this.getScene();if(!t.hasModel())return CLOUD.Logger.log("model not loaded!"),void(i&&i.clear(!0,!0,!0));CLOUD.GlobalData.IBL&&0==this.getIBLManager().textureLoad||t.checkLayerDataLoading()||(n.fillClipPlane&&CLOUD.GlobalData.ClippingCaps&&CLOUD.GlobalData.BatchMergeEnabled&&this.setRenderStateChanged(!0),CLOUD.GlobalData.IncrementRender?this.incrementRender(e):this.fullRender(e))},incrementRender:function(e){function t(e,r){var s=e;return function(){a.autoClear=r,i.editorManager.cameraChange?(a.resetIncrementRender(),a.autoClear=!0,i.editorManager.cameraChange=!1):a.autoClear=r,a.render(o,n)||s!==i.countRenderRequest?(i.rendering=!1,s!==i.countRenderRequest?i.render():i.onRenderFinishedCallback()):i.incrementRenderHandle=requestAnimationFrame(t(s,!1))}}var i=this,n=this.camera,r=this.modelManager,a=this.renderer,o=this.getScene();if(++this.countRenderRequest,this.countRenderRequest>this.maxCountRenderRequest&&(this.countRenderRequest=0),!this.rendering){this.rendering=!0,r.calculateCameraModelRelation(n.position),this.calculateNearFar(),this.cameraControl.updateCamera(),o.updateLights(n);var s=this.editorManager.isUpdateRenderList;a.resetIncrementRender(),a.setObjectListUpdateState(s),this.incrementRenderHandle=requestAnimationFrame(t(i.countRenderRequest,!0)),s&&r.prepareScene(n),this.onRenderCallback(),this.cameraControl.setCameraChanging(!1)}},fullRender:function(e){function t(){if(r.calculateCameraModelRelation(n.position),i.calculateNearFar(),i.cameraControl.updateCamera(),o.updateLights(n),r.prepareScene(n,function(){r.setRenderStateChanged(!0),i.render()}),r.getBlinkEnabled()&&r.updateBlinkMaterial(),o.fillClipPlane&&CLOUD.GlobalData.ClippingCaps){r.prepareCapScene(),a.clear(),a.autoClear=!1;var e=a.context,s=a.state;s.buffers.stencil.setTest(!0),s.buffers.stencil.setFunc(e.ALWAYS,1,255),s.buffers.stencil.setOp(e.KEEP,e.KEEP,e.INCR),o.overrideMaterial=o.backMaterial,o.backFrontStencil=!0,a.render(o,n),s.buffers.stencil.setFunc(e.ALWAYS,1,255),s.buffers.stencil.setOp(e.KEEP,e.KEEP,e.DECR),o.overrideMaterial=o.frontMaterial,a.render(o,n),o.backFrontStencil=!1,s.buffers.stencil.setFunc(e.LEQUAL,1,255),s.buffers.stencil.setOp(e.KEEP,e.KEEP,e.KEEP),a.render(r.capsScene,n),s.buffers.stencil.setTest(!1),o.overrideMaterial=null,a.render(o,n)}else i.composer?i.composer.render():a.render(o,n,null,!0);i.onRenderCallback(),i.onRenderFinishedCallback(),i.cameraControl.setCameraChanging(!1),r.getBlinkEnabled()&&(i.blinkHandle=requestAnimationFrame(t)),r.disposeBufferAfterVbo()}var i=this,n=this.camera,r=this.modelManager,a=this.renderer,o=this.getScene();this.blinkHandle>0&&cancelAnimationFrame(this.blinkHandle),t()},resize:function(e,t){this.camera&&this.renderer&&(this.camera.setSize(e,t),this.camera.updateProjectionMatrix(),this.renderer.setSize(e,t),this.composer&&this.composer.setSize(e,t),this.onCallbacks("resize"),this.render())},calculateNearFar:function(){var e=this.getScene(),t=e.getBoundingBoxWorld(),i=this.camera;if(null!=t){var n=this.tmpBox;n.copy(t),n.applyMatrix4(e.getMatrixGlobal());var r,a,o=n.getCenter(),s=i.position,l=s.clone().sub(o),c=l.length(),u=n.getSize().length();if(this.modelManager.containsCamera||!this.enableCameraNearFar)a=u,r=i.isPerspective?.1:-a;else{var h=.5*u;if(a=c+h,i.isPerspective){r=(c*c+.001*c)/16777.216,c<h?r=.1:r+h>c&&(r=c-h)}else r=-a}i.setNearFar(r,a)}},resetSelectionColor:function(e,t){this.modelManager.sceneState.setSelectionColor(e,t)},calculateMinDistance:function(e,t){function i(e,t,i,o,s,l){n.fromBufferAttribute(t,i),r.fromBufferAttribute(t,o),a.fromBufferAttribute(t,s),l&&(n.applyMatrix4(l),r.applyMatrix4(l),a.applyMatrix4(l)),e.push(n),e.push(r),e.push(a)}var n=new THREE.Vector3,r=new THREE.Vector3,a=new THREE.Vector3,o=this.modelManager.getMinDistanceObjects(e,t);if(!o)return-1;var s=[],l={start:null,end:null,minDistance:Number.POSITIVE_INFINITY};for(var c in o)s.push(o[c]);if(s[0].length<1||s[1].length<1)return-1;var u=s[0],h=s[1],d=u.length,f=h.length,p=null,m=Number.POSITIVE_INFINITY;if(d>1||f>1){p={};for(var g=0;g<d;g++)for(var v=u[g],y=0;y<f;y++){var E=h[y],x=function(e,t){for(var i=0,n=0,r=0;r<3;r++){var a=e.min.getComponent(r),o=e.max.getComponent(r),s=t.min.getComponent(r),l=t.max.getComponent(r),c=0;a>l?c=a-l:o<s&&(c=s-o),i+=c*c;var u=Math.max(l,o)-Math.min(a,s);n+=u*u}return{minDis:Math.sqrt(i),maxDis:Math.sqrt(n)}}(v.boundingBox,h[y].boundingBox);m=m<x.maxDis?m:x.maxDis,p[g+"_"+y]=x}}for(var g=0;g<d;g++)for(var v=u[g],y=0;y<f;y++){if(p){var b=p[g+"_"+y].minDis;if(b>m||b>l.minDistance)continue}var E=h[y],C=function(e,t,n){for(var r,a,o,s={start:null,end:null,minDistance:n},l=e.mesh,c=e.indexInfo,u=e.matrix,h=l.geometry,d=h.attributes.position,f=c?c.indexStart:0,p=h.getIndex().array,m=c?c.indexStart+c.indexCount:p.length,g=t.mesh,v=t.indexInfo,y=t.matrix,E=f,x=m;E<x;E+=3){r=p[E],a=p[E+1],o=p[E+2];var b=[];i(b,d,r,a,o,u);var C=CLOUD.Utils.minDistanceBetweenTriToMesh(b,g,v,y);C.minDistance<s.minDistance&&(s.minDistance=C.minDistance,s.start=C.start,s.end=C.end)}return s}(v,E,l.minDistance);if(C.minDistance<l.minDistance&&(l.minDistance=C.minDistance,l.start=C.start,l.end=C.end),0==l.minDistance)return l}return p=null,l},registerDomEventListeners:function(){this.domElement&&this.editorManager.registerDomEventListeners(this.domElement)},unregisterDomEventListeners:function(){this.domElement&&this.editorManager.unregisterDomEventListeners(this.domElement)},registerEventListener:function(e,t){this.modelManager.addEventListener(e,t)},unregisterEventListener:function(e,t){this.modelManager.removeEventListener(e,t)},load:function(e,t,i,n,r){i=i||!0;var a=this;return this.modelManager.load({databagId:e,serverUrl:t,notifyProgress:i,debug:n,lightmapDatabagId:r},function(){a._setupRenderer()},function(e){a.modelManager.updateFilterManager(),a.modelManager.filter.getObjectInfoManager().calculateVisibleComponentsBbox(),console.time("Rendering: "),a.camera.dirty?a.render():(a.goToInitialView(),a.zoomAll()),console.timeEnd("Rendering: ")})},unload:function(e){this.modelManager.unload(e)&&(this.zoomAll(),this.render())},unloadAll:function(){this.modelManager.unloadAll(),this.render()},showModel:function(e){this.modelManager.showModel(e)&&this.render()},hideModel:function(e){this.modelManager.hideModel(e)&&this.render()},showScene:function(e,t){e&&(e.setVisible(t),this.render())},clearAll:function(){this.getScene().clearAll()},restore:function(){this.getFilter().clear(),this.getScene().disableClipPlanes(),this.modelManager.dispatchEvent({type:CLOUD.EVENTS.ON_VIEWER_RESTORED})},getScene:function(){return this.modelManager.scene},getCapsScene:function(){return this.modelManager.capsScene},getEditorManager:function(){return this.editorManager},getUserdataByUserId:function(e){var t=this.modelManager.getNodeInfosByUserId(e);return t&&t instanceof Array?t[0].userData:null},getFilter:function(){return this.filter},getCurrentEditorName:function(){return this.editorManager.getCurrentEditorName()},getCurrentEditor:function(){return this.editorManager.getCurrentEditor()},setEditorMode:function(e){this.editorManager.setEditorMode(this,e)},setEditorDefault:function(){this.setEditorMode(CLOUD.EditorMode.PICK)},setPickMode:function(){console.warn("CLOUD.Viewer.setPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PICK)},setRectPickMode:function(){console.warn("CLOUD.Viewer.setRectPickMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PICK_BY_RECT)},setOrbitMode:function(){console.warn("CLOUD.Viewer.setOrbitMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ORBIT)},setZoomMode:function(){console.warn("CLOUD.Viewer.setZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ZOOM)},setRectZoomMode:function(){console.warn("CLOUD.Viewer.setRectZoomMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.ZOOM_BY_RECT)},setPanMode:function(){console.warn("CLOUD.Viewer.setPanMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.PAN)},setFlyMode:function(){console.warn("CLOUD.Viewer.setFlyMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.FLY)},setMeasureMode:function(){console.warn("CLOUD.Viewer.setMeasureMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.MEASURE)},setClipPlanesMode:function(){console.warn("CLOUD.Viewer.setClipPlanesMode() has been deprecated. Use CLOUD.Viewer.setEditorMode(name) instead."),this.setEditorMode(CLOUD.EditorMode.CLIP_BY_BOX)},getBoundingBoxWorld:function(){return this.getScene().getBoundingBoxWorld()},getBoundingBox:function(){return this.getScene().getBoundingBox()},zoomIn:function(e){void 0===e&&(e=.1),e<0&&(e=0),this.cameraControl.zoom(e)},zoomOut:function(e){void 0===e&&(e=.1),e>0?e*=-1:e=0,this.cameraControl.zoom(e)},zoomAll:function(e,t){var i=this.getScene().getBoundingBox();this._zoomToLocalBBox(i,e,t)},
zoomToBuilding:function(e,t){this.zoomAll(e,t)},zoomToSelection:function(e,t){var i=this.getScene(),n=this.modelManager.sceneState,r=this.getBoundingBoxByIds(n.getSelectionSet());r.isEmpty()&&(r=i.getBoundingBox()),1==this.getTransitionAnimationState()?this.animator.setStandardView(void 0,this,r,e):this._zoomToLocalBBox(r,e,t)},_zoomToLocalBBox:function(e,t,i,n){this.camera.zoomToBBox(e,t,i,n),this.cameraControl.update(!0,!0),this.cameraControl.dirtyCamera(!0)},zoomToBBox:function(e,t,i){var n=new THREE.Box3;e?(n.copy(e),n.applyMatrix4(this.getScene().getMatrixGlobal())):n.copy(this.getScene().getBoundingBox()),1==this.getTransitionAnimationState()?this.animator.setStandardView(void 0,this,n,t):this._zoomToLocalBBox(n,t,i)},zoomToBBoxByDirection:function(e,t,i,n){if(!t)return void this.zoomToBBox(e,i,n);if(t&&e){var r=e.clone(),a=r.getCenter().clone().add(t);r.applyMatrix4(this.getScene().getMatrixGlobal()),a.applyMatrix4(this.getScene().getMatrixGlobal());var o=a.clone().sub(r.getCenter());o.length()>1e-4?(o.normalize(),viewer.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(r,i,n,o)):this._zoomToLocalBBox(r,i,n)}},zoomToBBoxWithOuterBox:function(e,t,i,n){if(!t)return void this.zoomToBBox(e,i,n);if(t&&e){var r=e.clone(),a=t.getCenter();r.applyMatrix4(this.getScene().getMatrixGlobal()),a.applyMatrix4(this.getScene().getMatrixGlobal());var o=a.clone().sub(r.getCenter());o.length()>1e-4?(o.normalize(),this.camera.realUp.copy(THREE.Object3D.DefaultUp),this._zoomToLocalBBox(r,i,n,o)):this._zoomToLocalBBox(r,i,n)}},getObjectsInBox:function(e){var t=new THREE.Box3;return t.copy(e),t.applyMatrix4(this.getScene().getMatrixGlobal()),CLOUD.PickUtil.getObjectsInBox(this.getScene(),t,this.modelManager,this)},setStandardView:function(e,t,i){var n,r=this.camera;if(n=this.getScene().getBoundingBox(),this.transitionAnimationState)this.animator.setStandardView(e,this,n,t,i);else{r.setStandardView(e,n);this.camera.zoomToBBox(n,t);this.cameraControl.update(!0,!0),i&&i()}},getLineSelectRange:function(){return CLOUD.GlobalData.LineSelectRange},setLineSelectRange:function(e){CLOUD.GlobalData.LineSelectRange=e},_setStandardView:function(e,t){var i=this.camera,n=this.getScene().getBoundingBox();i.setStandardView(e,n),i.zoomToBBox(n,t)},setStandardViewWithBox:function(e,t,i,n){if(t?t.applyMatrix4(this.getScene().getMatrixGlobal()):t=this.getScene().getBoundingBox(),this.transitionAnimationState)this.animator.setStandardView(e,this,t,i);else{var r=this.camera;r.setStandardView(e,t),r.zoomToBBox(t,i,n),this.cameraControl.update(!0,!0)}},setTopView:function(e,t,i){this.setStandardViewWithBox(CLOUD.EnumStandardView.ISO,e,t,i)},setInitialViewType:function(e){console.warn("CLOUD.Viewer.setInitialViewType() has been deprecated. Use CLOUD.Viewer.setInitialView() instead."),this.setInitialView(e)},setInitialView:function(e){this.initialView=e,this._setStandardView(e)},goToInitialView:function(e){this.setStandardView(this.initialView,e,null)},setHomeViewType:function(e){console.warn("CLOUD.Viewer.setHomeViewType() has been deprecated. Use CLOUD.Viewer.setHomeView() instead."),this.setHomeView(e)},setHomeView:function(e){this.currentHomeView=e,this._setStandardView(e)},getHomeView:function(){return this.currentHomeView},goToHomeView:function(e){this.setStandardView(this.currentHomeView,e,null)},rotateByAxis:function(e,t){var i=this.cameraControl.calculatePivot(CLOUD.RotatePivotMode.CENTER,null),n=2*Math.PI/60/60*e;if(t&&"x"!=t){if("y"!=t)return void console.warn("Illegal rotation axis for Viewer.rotateByAxis().");this.cameraControl.handleRotation(0,-n,i)}else this.cameraControl.handleRotation(-n,0,i);this.cameraControl.update(!0)},setImageResPath:function(e){CLOUD.GlobalData.TextureResRoot=e},setLightIntensityFactor:function(e){CLOUD.GlobalData.LightIntensityFactor=e},setLimitFrameTime:function(e){CLOUD.GlobalData.IncrementRender&&(e<=0&&(e=30),CLOUD.GlobalData.LimitFrameTime=e)},limitFrameRate:function(e){CLOUD.GlobalData.IncrementRender&&(e<=0&&(e=4),CLOUD.GlobalData.LimitFrameTime=1e3/e)},transformCamera:function(e){return CLOUD.CameraUtil.transformCamera(e,this.modelManager.scene)},getCamera:function(){var e=this.getScene(),t=e.getMatrixGlobal(),i=this.cameraControl.getCamera(),n=this.cameraControl.getCameraName(),r=new CLOUD.CameraInfo(n,i.position,i.target,i.up);r=CLOUD.Camera.drawingToWorld(r,t);var a=new CLOUD.CameraInfo(n,r.position,r.target,r.up,i.fov);return JSON.stringify(a)},setCamera:function(e,t,i){this.camera.dirty=!0;var n=this,r=CLOUD.CameraUtil.parseCameraInfo(e);if(null===r)console.log("Invalid camera info string. Fail to set camera.");else if(this.switchToCamera(r.name)){var a=this.getScene(),o=a.getMatrixGlobal(),s=null;if(s=r.version?CLOUD.Camera.worldToDrawing(r,o):r,this.transitionAnimationState){var l={position:this.camera.position.clone(),target:this.camera.target.clone(),up:this.camera.up.clone()};this.animator.active(l,s,this,function(e){n.cameraControl.update(!0,!0)},i)}else{var c=new THREE.Vector3;c.subVectors(s.target,s.position),this.camera.LookAt(s.target,c,s.up),t&&this.cameraControl.updateCamera(),i&&i()}}},getRenderBufferScreenShot:function(e,t){var i=this.renderer.domElement,n=i.toDataURL("image/png"),r=i.width,a=i.height,o=window.devicePixelRatio||1,s=r/o,l=a/o;if(!s||!l)return t?(t(n),null):n;var c,u,h=0,d=0;if(s>l||r/a<s/l?(c=s,u=a/r*s,d=l/2-u/2):(u=l,c=r/a*l,h=s/2-c/2),t){var f=new Image;return f.onload=function(){var i=document.createElement("canvas"),n=i.getContext("2d");i.width=s,i.height=l,e&&(n.fillStyle=e,n.fillRect(0,0,s,l)),n.drawImage(f,h,d,c,u);var r=i.toDataURL("image/png");t(r)},f.src=n,null}var f=new Image;f.src=n;var p=document.createElement("canvas"),m=p.getContext("2d");return p.width=s,p.height=l,e&&(m.fillStyle=e,m.fillRect(0,0,s,l)),m.drawImage(f,h,d,c,u),p.toDataURL("image/png")},screenShot:function(e,t,i){var n=this,r=function(e,t,i){var r=n.renderer.domElement,a=r.toDataURL("image/png"),o=r.width,s=r.height,l=(window.devicePixelRatio,e),c=t;if(!l||!c)return i?(i(a),null):a;var u,h,d=0,f=0;if(l>c||o/s<l/c?(u=l,h=s/o*l,f=c/2-h/2):(h=c,u=o/s*c,d=l/2-u/2),i){var p=new Image;return p.onload=function(){var e=document.createElement("canvas"),t=e.getContext("2d");e.width=l,e.height=c,t.drawImage(p,d,f,u,h);var n=e.toDataURL("image/png");i(n)},p.src=a,null}}(e,t,i);return this.render(),r},canvas2image:function(e,t){var i,n=this;return t?(this.getRenderBufferScreenShot(e,function(e){t(e),n.render()}),null):(i=this.getRenderBufferScreenShot(e),this.render(),i)},lockAxisZ:function(e){this.cameraControl&&this.cameraControl.lockAxisZ(e)},isLockedAxisZ:function(){return this.cameraControl.isLockedAxisZ()},enableTranslucentByDClick:function(e){CLOUD.GlobalData.EnableDemolishByDClick=e},enableHitDetection:function(e){CLOUD.GlobalData.EnableHitDetection=e},rotateCamera:function(e){this.cameraControl.processRotate(e),this.cameraControl.update()},getActiveCameraInfo:function(){var e={};e.up=new THREE.Vector3,e.dir=new THREE.Vector3;var t=this.camera,i=t.getWorldDirection();return e.up.copy(t.realUp||t.up),e.dir.copy(i),e},calculationPlanes:function(){if(this.isRecalculationPlanes){this.isRecalculationPlanes=!1;var e=this.getScene(),t=this.getBoundingBoxByIds();t.isEmpty()&&(t=e.getBoundingBox()),e.getClipPlanes().calculationPlanes(t.getSize(),t.getCenter()),this.render()}},recalculationPlanes:function(){this.isRecalculationPlanes=!0},setOctantDepth:function(e){CLOUD.GlobalData.OctantDepth=e},resizePool:function(e){CLOUD.GlobalData.maxObjectNumInPool=e,this.modelManager.updateSceneRenderable(),this.render()},setCategoriesToHighPriority:function(e,t){var i=0==t?"inner":"outer";this.modelManager.setCategoriesToHighPriority(e,i)},clearCategoriesFromHighPriority:function(e){var t=0==e?"inner":"outer";this.modelManager.clearCategoriesFromHighPriority(t)},clearAllCategoriesFromHighPriority:function(){this.modelManager.clearAllCategoriesFromHighPriority()},isolate:function(e,t){var i=this.getFilter();switch(t){case"hide":i.setIsolateConditions(e,CLOUD.EnumIsolateState.HIDDEN_OTHERS);break;case"translucent":i.setIsolateConditions(e,CLOUD.EnumIsolateState.TRANSLUCENT_OTHERS);break;default:console.log("no this isolate state : "+t)}},setIsolateMaterial:function(e){this.getFilter().setIsolateMaterial(e)},resetIsolateMaterial:function(){this.getFilter().resetIsolateMaterial()},setOrbitButton:function(e){var t=this.editorManager._getEditorByName(this,CLOUD.EditorMode.ORBIT),i=this.editorManager._getEditorByName(this,CLOUD.EditorMode.PICK),n={};"left"===e?n={ORBIT:THREE.MOUSE.LEFT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.RIGHT}:"right"===e&&(n={ORBIT:THREE.MOUSE.RIGHT,PAN2:THREE.MOUSE.MIDDLE,PAN:THREE.MOUSE.LEFT}),t&&t.updateButtons(n),i&&i.updateButtons(n)},showPickedInformation:function(e){CLOUD.UIHelper.showPickedInformation(e)},setOrbitEnabled:function(e){CLOUD.EditorConfig.NoRotate=!0!==e},getOrbitEnabled:function(){return!CLOUD.EditorConfig.NoRotate},setSelectPadCallback:function(e){var t=this.editorManager.getCurrentEditor();t&&t.selectPad&&(t.selectPad.callback=e)},setDeviceMobile:function(e){CLOUD.GlobalData.IsMobile=e||!1},setPointRotateMode:function(e){CLOUD.EditorConfig.RotatePivotMode=e},worldToDrawing:function(e){if(!this.cameraControl)return console.log("camera is not initialized!!!"),null;var t=this.getScene(),i=t.worldToDrawing(e);return{x:i.x,y:i.y,z:i.z}},drawingToWorld:function(e){if(!this.cameraControl)return console.log("camera is not initialized!!!"),null;var t=this.getScene(),i=t.drawingToWorld(e);return{x:i.x,y:i.y,z:i.z}},worldToCanvas:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),r=this.getScene(),a=r.worldToDrawing(e);return CLOUD.CameraUtil.drawingToCanvas(n,a,i.width,i.height)},canvasToWorld:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),r=this.getScene(),a=CLOUD.CameraUtil.canvasToDrawing(n,e,i.width,i.height),o=r.drawingToWorld(a);return{x:o.x,y:o.y,z:o.z}},worldToClient:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n=t.getCamera(),r=this.getScene(),a=r.worldToDrawing(e),o=CLOUD.CameraUtil.drawingToCanvas(n,a,i.width,i.height);return o?(o.x+=i.left,o.y+=i.top,o):null},worldPointsToClient:function(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),null;var n=i.getContainerDimensions();if(!n)return null;var r=i.getCamera(),a=this.getScene(),o=a.worldToDrawing(e),s=a.worldToDrawing(t),l=CLOUD.CameraUtil.drawingPointsToCanvas(r,o,s,n.width,n.height);return l?(l.start.x+=n.left,l.start.y+=n.top,l.end.x+=n.left,l.end.y+=n.top,l):null},clientToWorld:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),null;var i=t.getContainerDimensions();if(!i)return null;var n={x:e.x,y:e.y,z:e.z};n.x-=i.left,n.y-=i.top;var r=t.getCamera(),a=this.getScene(),n=CLOUD.CameraUtil.canvasToDrawing(r,n,i.width,i.height),o=a.drawingToWorld(n);return{x:o.x,y:o.y,z:o.z}},insideCamera:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene(),n=i.worldToDrawing(e);return t.getFrustum().containsPoint(n)},locateToPointWithParallelEye:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene(),n=i.worldToDrawing(e);t.flyToPointWithParallelEye(n)},locateToPoint:function(e){var t=this.cameraControl;if(!t)return console.log("camera is not initialized!!!"),!1;var i=this.getScene(),n=i.worldToDrawing(e);t.flyToPoint(n)},enableHover:function(e){CLOUD.GlobalData.Hover=e},getObjectsByClientCoordinates:function(e){return new CLOUD.IntersectHelper(this).getObjectsByClientCoordinates(e)},getIBLManager:function(){return this.IBLManager},loadEnvMap:function(e){for(var t=["posx.hdr","negx.hdr","posy.hdr","negy.hdr","posz.hdr","negz.hdr"],i=[],n=0;n<6;++n)i.push("/"+e+"/"+t[n]);var r=this;(new THREE.HDRCubeTextureLoader).load(THREE.FloatType,i,function(e){r.environmentCubeMap=e,r.modelManager.updateMaterialsValue("envMap",e),r.setRenderStateChanged(!0),r.render()})},setEnvMapIntensity:function(e){this.modelManager.updateMaterialsValue("envMapIntensity",e),this.setRenderStateChanged(!0),this.render()},closeEnvMap:function(){this.modelManager.updateMaterialsValue("envMap",null),this.setRenderStateChanged(!0),this.render()},isSupportSSAO:function(){return!CLOUD.GlobalData.IncrementRender},isSSAOEnabled:function(){return CLOUD.GlobalData.SSAO},enableSSAO:function(e){return 0!=this.isSupportSSAO()&&(CLOUD.GlobalData.SSAO==e||(CLOUD.GlobalData.EnableRenderPass=e,CLOUD.GlobalData.SSAO=e,this.setRenderStateChanged(!0),this.render(),!0))},switchNewStyleMaterial:function(e){this.modelManager.switchNewStyleMaterial(e),this.setRenderStateChanged(!0),this.render()},addPlane:function(e,t,i,n){var r=new THREE.Vector3;r.addVectors(new THREE.Vector3(e.x,e.y,e.z),new THREE.Vector3(t.x,t.y,t.z)),r.multiplyScalar(.5);var a=new THREE.PlaneBufferGeometry(t.x-e.x,t.y-e.y),o=new THREE.Mesh(a,new THREE.MeshBasicMaterial({side:THREE.DoubleSide,transparent:!0,depthTest:!0}));o.position.copy(r),o.renderOrder=10,this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.CUSTOMPLANE,{globalSpace:!0}).add(o),o.updateMatrixWorld(!0);var s=this,l=new THREE.TextureLoader;return l.setCrossOrigin("anonymous"),l.load(i,function(e){o.material.map=e,o.material.needsUpdate=!0,s.setRenderStateChanged(!0),n&&n()}),o},removePlane:function(e){var t=this.getScene(),i=t.getObjectGroup(CLOUD.ObjectGroupType.CUSTOMPLANE);i&&i.remove(e)},enableTextureMapping:function(e){CLOUD.GlobalData.EnableTextureMapping=e},enableLightmap:function(e){CLOUD.GlobalData.EnableLightmap!=e&&(CLOUD.GlobalData.EnableLightmap=e)},setLightmapIntensity:function(e){CLOUD.GlobalData.LightmapIntensity!=e&&(CLOUD.GlobalData.LightmapIntensity=e)},setReverseWheelDirection:function(e){CLOUD.EditorConfig.ReverseWheelDirection=!!e},getReverseWheelDirection:function(){return CLOUD.EditorConfig.ReverseWheelDirection},setMovementSpeedRate:function(e){void 0!==e&&(CLOUD.EditorConfig.MovementSpeedRate=e)},getMovementSpeedRate:function(){return CLOUD.EditorConfig.MovementSpeedRate},moveTo:function(e,t,i){var n=this.editorManager.editor;n&&n.moveTo(e,t,i)},rotateTo:function(e){var t=this.editorManager.editor;t&&t.rotateTo(e)},enableOcclusionTranslucent:function(e){CLOUD.GlobalData.OcclusionTranslucentEnabled=!!e},setOcclusionOpacity:function(e){CLOUD.GlobalData.OcclusionOpacity=e},setOcclusionDistanceToCamera:function(e){CLOUD.GlobalData.OcclusionDistanceToCamera=e},fitAndRotateBySelection:function(){this.cameraControl&&this.cameraControl.fitAndRotateBySelection()},setRoamingWalkHeight:function(e,t,i){if(!(e instanceof Array))return void console.log("elevations is not arry");var n=this.cameraControl;if(!n)return console.log("camera is not initialized!!!"),!1;if(t<=0&&(t=1750),void 0===i&&(i=!0),n.setCameraHeight(e,t),i){var r=this.editorManager.getCurrentEditor();r&&r.name===CLOUD.EditorMode.WALK&&r.update&&n.flyOnWorld()}},setRoamingWalkAbsoluteHeight:function(e,t){var i=this.cameraControl;if(!i)return console.log("camera is not initialized!!!"),!1;if(void 0===t&&(t=!0),i.setCameraAbsoluteHeight(e),t){var n=this.editorManager.getCurrentEditor();n&&n.name===CLOUD.EditorMode.WALK&&n.update&&i.flyOnWorld()}},cameraToWorld:function(e){return this.camera?CLOUD.Camera.drawingToWorld(e,this.getScene().getMatrixGlobal()):null},cameraToDrawing:function(e){return this.camera?CLOUD.Camera.worldToDrawing(e,this.getScene().getMatrixGlobal()):null},clearSelection:function(){this.modelManager.sceneState.clearSelection()},addToSelection:function(e){this.modelManager.sceneState.addSelection(e)},removeFromSelection:function(e){this.modelManager.sceneState.removeSelection(e)},setSelection:function(e){this.modelManager.sceneState.setSelection(e)},getSelection:function(){return this.modelManager.sceneState.getSelection()},setSelectionColor:function(e){this.modelManager.sceneState.setSelectionColor(e)},pickByPoint:function(e){var t=this.cameraControl;if(!1===t.enabled)return!1;var i=new THREE.Vector2(e.x,e.y),n=t.getIntersectContext(i),r=t.intersector.pick(n),a=this.getScene();if(r){a.intersectToWorld(r,this);var o={};return o.faceIndex=r.faceIndex,o.meshId=r.userId,o.worldPosition=r.worldPosition,o.worldBoundingBox=r.worldBoundingBox,o}return null},pickByPointWithNormal:function(e){var t=this.getScene(),i=this.cameraControl;if(!1===i.enabled)return null;var n=new THREE.Vector2(e.x,e.y),r=i.getIntersectContext(n),a=i.intersector.pick(r);if(!a)return null;t.intersectToWorld(a,this),a.cx=n.x,a.cy=n.y;var o=[];o.push(a);var s=t.getMatrixGlobal(),l=a.face.normal.clone(),c=a.worldPosition.clone(),u=new THREE.Ray(c,l);u.applyMatrix4(s);var h=i.intersector.getIntersectByRay(r,u);return h&&(t.intersectToWorld(h,this),o.push(h)),o},toDefaultOrthographicCamera:function(e){this.switchToCamera("orth"),(e||void 0===e)&&this.render()},toDefaultPerspectiveCamera:function(e){this.switchToCamera("persp"),(e||void 0===e)&&this.render()},getCameraNameList:function(){return["pesp","orth"].concat(this.modelManager.getCameraNameList())},switchToCamera:function(e){var t=!0;if("persp"===e)this.camera=this.defaultCamera,this.camera.toPerspective();else if("orth"===e)this.camera=this.defaultCamera,this.camera.toOrthographic();else{var i=this.modelManager.getCamera(e);i?this.camera=i:(console.log("Fail to switch because not found camera '"+e+"'"),t=!1)}return t&&this.cameraControl.setCamera(this.camera),t},getNumOfElements:function(){return this.modelManager.getNumOfElements()},getNumOfRenderables:function(){return this.modelManager.getNumOfRenderables()},getNumOfTriangles:function(){return this.modelManager.getNumOfTriangles()},setLightPreset:function(e){CLOUD.GlobalData.LightPreset=e,this.getScene().lightPreset(),this.setRenderStateChanged(!0)},getLightPreset:function(){return CLOUD.GlobalData.LightPreset},setAmbientLightIntensity:function(e){var t=this.getScene().ambientLight;t&&(t.intensity=e,this.setRenderStateChanged(!0))},getAmbientLightIntensity:function(){var e=this.getScene().ambientLight;return e?e.intensity:void 0},setWalkHeightLocked:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&t.setHeightLocked(e)},setWalkLookMousePressed:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&t.setDragLook(e)},setWalkSpeedRate:function(e){var t=this.editorManager.getCurrentEditor();t&&t.name===CLOUD.EditorMode.WALK&&(CLOUD.EditorConfig.WalkSpeedRate=e)},getWalkSpeedRate:function(){return CLOUD.EditorConfig.WalkSpeedRate},setDrawingStyle:function(e){CLOUD.GlobalData.DrawingStyle=e,this.setRenderStateChanged(!0)},getWireframeColor:function(){var e=this.modelManager;for(var t in e.models){return e.models[t].wireframeManager.getWireframeColor()}},setWireframeColor:function(e){var t=this.modelManager;for(var i in t.models)t.models[i].wireframeManager.setWireframeColor(new THREE.Color(e.red,e.green,e.blue),e.alpha);this.setRenderStateChanged(!0)},restoreWireframeColor:function(){var e=this.modelManager;for(var t in e.models)e.models[t].wireframeManager.restoreWireframeColor();this.setRenderStateChanged(!0)},setInstanceMode:function(e){if(!CLOUD.GlobalData.Instance===e){if(CLOUD.GlobalData.Instance=e,e){var t=this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0});t.visible=!0}else{var t=this.getScene().getOrCreateObjectGroup(CLOUD.ObjectGroupType.INSTANCEGEOMETRY,{globalSpace:!0});t.visible=!1}this.setRenderStateChanged(!0)}},setTransitionAnimationState:function(e){this.transitionAnimationState=e},getTransitionAnimationState:function(){return this.transitionAnimationState},clipPoint:function(e){var t=this.renderer.clippingPlanes;if(t&&t.length>0)for(var i=0;i<t.length;++i){var n=t[i],r=n.normal;if(e.dot(r)<-n.constant)return!0}return!1},getExplosionExtent:function(){return this.modelManager.getExplosionExtent()},setExplosionExtent:function(e){CLOUD.GlobalData.EnableExplosion&&this.modelManager.setExplosionExtent(e)},setFloorExplosion:function(e,t){CLOUD.GlobalData.EnableExplosion&&this.modelManager.setFloorExplosion(e,t)},getFloorExplosionExtent:function(){return this.modelManager.floorExplosionExtent},getFloorExplosionList:function(){return this.modelManager.floorExplosionList},setFloorInfos:function(e){if(!this.modelManager.floorInfos){for(var t=0,i=e.length;t<i;t++)e[t].explodedHeight=e[t].elevation;this.modelManager.floorInfos=e;var n=this.modelManager.scene.getBoundingBoxWorld();this.modelManager.totalHeight=n.getSize().z}},setExposureShift:function(e){CLOUD.GlobalData.ToneMapping=1;var t=e>0?-.4*e+.5:-4*e+.5;this.modelManager.updateMaterialsValue("shift",t),this.setRenderStateChanged(!0)},setRenderStateChanged:function(e){this.modelManager&&this.modelManager.setRenderStateChanged(e)},isDesktop:function(){return CLOUD.Utils.isDesktop()},getComponentInfoByUserId:function(e){return this.modelManager.getComponentInfoByUserId(e)},getBoundingBoxByIds:function(e){var t=this.modelManager.getBoundingBoxByIds(e);return t.isEmpty()||t.applyMatrix4(this.getScene().getMatrixGlobal()),t},convertAnnotationsToV3:function(e){return CLOUD.Compatibility.convertAnnotationsToV3(this,e)},loadMpkOnDemand:function(e,t,i){var n=this;this.modelManager.getLoadOnDemandDirector().loadMpkOnDemandByConditionsWithDelay(e,function(){n.renderer&&n.renderer.clear(!0,!0,!0)},t,i)},getBoundingBoxOnDemand:function(){return this.modelManager.hasLoadOnDemandDirector()?this.modelManager.getLoadOnDemandDirector().getBoundingBoxOnDemand():null},setOutlineEdgeColor:function(e){this.composer&&this.composer.setOutlineEdgeColor(e)},createAreaInfo:function(e,t){var i=new CLOUD.AreaInfo(e);return i.checkRoomBoundary(t)?i:null},enableBlinkComponents:function(e){this.modelManager.isBlinkPermited()||(this.modelManager.enableBlink(e),this.render())},setBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.setBlinkComponentsById(e)},addBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.addBlinkComponentsById(e)},clearBlinkComponentsById:function(e){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.clearBlinkComponentsById(e)},clearAllBlinkComponents:function(){this.modelManager.isBlinkPermited()||this.modelManager.sceneState.clearAllBlinkComponents()},getBlinkComponents:function(){return this.modelManager.isBlinkPermited()?null:this.modelManager.sceneState.getBlinkComponents()},setBlinkColor:function(e){this.modelManager.isBlinkPermited()||this.modelManager.setBlinkColor(e.color,e.opacity)},setBlinkIntervalTime:function(e){this.modelManager.isBlinkPermited()||this.modelManager.setBlinkIntervalTime(e)},enableSnap:function(e){this.editorManager.getToolByName("pickByRect").enableSnap(e)},pickToPoint:function(e,t){return this.editorManager.editor.pickHelper.pickToPoint(e,t)}},CLOUD.DomUtil2D={create:function(e,t,i){var n=document.createElement(e);return n.id=t||"",n.style.position="absolute",n.style.width="100%",n.style.top=0,n.style.bottom=0,i&&i.appendChild(n),n},remove:function(e){var t=e.parentNode;t&&t.removeChild(e)},setPosition:function(e,t){e.position=t,e.style.left=t.x+"px",e.style.top=t.y+"px"},setOpacity:function(e,t){"opacity"in e.style?e.style.opacity=t:"filter"in e.style&&CLOUD.DomUtil2D._setOpacityIE(e,t)},_setOpacityIE:function(e,t){var i=!1,n="DXImageTransform.Microsoft.Alpha";try{i=e.filters.item(n)}catch(e){if(1===t)return}t=Math.round(100*t),i?(i.Enabled=100!==t,i.Opacity=t):e.style.filter+=" progid:"+n+"(opacity="+t+")"},splitStr:function(e){return e.trim().split(/\s+/g)},getContainerOffsetToClient:function(e){var t,i=function(e){for(var t=0,i=0;e;)t+=e.offsetTop,i+=e.offsetLeft,e=e.offsetParent;var n=document.body,r=document.documentElement,a=window.pageYOffset||r.scrollTop||n.scrollTop,o=window.pageXOffset||r.scrollLeft||n.scrollLeft;return t-=a,i-=o,{top:t,left:i}},n=function(e){var t=e.getBoundingClientRect(),i=document.body,n=document.documentElement,r=n.clientTop||i.clientTop,a=n.clientLeft||i.clientLeft,o=t.top-r,s=t.left-a;return{top:Math.round(o),left:Math.round(s)}};if(e!=document){var r=function(e){return e.getBoundingClientRect?n(e):i(e)}(e);t={width:e.offsetWidth,height:e.offsetHeight,left:r.left,top:r.top}}else t={width:window.innerWidth,height:window.innerHeight,left:0,top:0};return t},setClassName:function(e,t){var i=document.getElementById(e);i&&(i.className=t)},addClassName:function(e,t){var i,n,r,a,o,s=/\s+/,l=document.getElementById(e);if(l&&(n=l,t&&"string"==typeof t&&(i=t.split(s),1===n.nodeType)))if(n.className||1!==i.length){for(r=" "+n.className+" ",a=0,o=i.length;a<o;++a)r.indexOf(" "+i[a]+" ")<0&&(r+=i[0]+" ");n.className=String.trim(r)}else n.className=t},removeClassName:function(e,t){var i,n,r,a,o,s=/\s+/,l=document.getElementById(e);if(l&&(r=l,t&&"string"==typeof t&&(i=(t||"").split(s),1===r.nodeType&&r.className))){for(n=(" "+r.className+" ").replace(O," "),a=0,o=i.length;a<o;a++)for(;n.indexOf(" "+i[a]+" ")>=0;)n=n.replace(" "+i[a]+" "," ");r.className=t?String.trim(n):""}},showOrHideElement:function(e,t){var i=document.getElementById(e);i&&(i.style.display=t?"":"none")},getStyleString:function(e){var t=[];for(var i in e){var n=e[i];t.push(i),t.push(":"),t.push(n),t.push("; ")}return t.join("")},cloneStyle:function(e){var t={};for(var i in e)t[i]=e[i];return t},removeStyleAttribute:function(e,t){Array.isArray(t)||(t=[t]),t.forEach(function(t){t in e&&delete e[t]})},trimRight:function(e){if(0===e.length)return"";for(var t=e.length-1,i=t;i>=0;--i)if(" "!==e.charAt(i)){t=i;break}return e.substr(0,t+1)},trimLeft:function(e){if(0===e.length)return"";for(var t=0,i=0;i<e.length;++i)if(" "!==e.charAt(i)){t=i;break}return e.substr(t)},matchesSelector:function(e,t){if(e.matches)return e.matches(t);if(e.matchesSelector)return e.matchesSelector(t);if(e.webkitMatchesSelector)return e.webkitMatchesSelector(t);if(e.msMatchesSelector)return e.msMatchesSelector(t);if(e.mozMatchesSelector)return e.mozMatchesSelector(t);if(e.oMatchesSelector)return e.oMatchesSelector(t);if(e.querySelectorAll){for(var i=(e.document||e.ownerDocument).querySelectorAll(t),n=0;i[n]&&i[n]!==element;)n++;return!!i[n]}return!1},toTranslate3d:function(e,t){return"translate3d("+e+"px,"+t+"px,0)"},setCursorStyle:function(e,t){var i;switch(t){case"n":case"s":i="ns-resize";break;case"w":case"e":i="ew-resize";break;case"ne":case"sw":i="nesw-resize";break;case"nw":case"se":i="nwse-resize"}e.style.cursor=i}},function(e){if("object"==("undefined"==typeof exports?"undefined":_typeof(exports))&&"undefined"!=typeof module)module.exports=e();else if("function"==typeof define&&define.amd)define([],e);else{var t;"undefined"!=typeof window?t=window:"undefined"!=typeof global?t=global:"undefined"!=typeof self&&(t=self),t.html2canvas=e()}}(function(){var e;return function e(t,i,n){function r(o,s){if(!i[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};t[o][0].call(u.exports,function(e){var i=t[o][1][e];return r(i||e)},u,u.exports,e,t,i,n)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}({1:[function(t,i,n){(function(t){!function(r){function a(e){throw RangeError(U[e])}function o(e,t){for(var i=e.length;i--;)e[i]=t(e[i]);return e}function s(e,t){return o(e.split(A),t).join(".")}function l(e){for(var t,i,n=[],r=0,a=e.length;r<a;)t=e.charCodeAt(r++),t>=55296&&t<=56319&&r<a?(i=e.charCodeAt(r++),56320==(64512&i)?n.push(((1023&t)<<10)+(1023&i)+65536):(n.push(t),r--)):n.push(t);return n}function c(e){return o(e,function(e){var t="";return e>65535&&(e-=65536,t+=N(e>>>10&1023|55296),e=56320|1023&e),t+=N(e)}).join("")}function u(e){return e-48<10?e-22:e-65<26?e-65:e-97<26?e-97:M}function h(e,t){return e+22+75*(e<26)-((0!=t)<<5)}function d(e,t,i){var n=0;for(e=i?P(e/T):e>>1,e+=P(e/t);e>B*w>>1;n+=M)e=P(e/B);return P(n+(B+1)*e/(e+L))}function f(e){var t,i,n,r,o,s,l,h,f,p,m=[],g=e.length,v=0,y=S,E=I;for(i=e.lastIndexOf(O),i<0&&(i=0),n=0;n<i;++n)e.charCodeAt(n)>=128&&a("not-basic"),m.push(e.charCodeAt(n));for(r=i>0?i+1:0;r<g;){for(o=v,s=1,l=M;r>=g&&a("invalid-input"),h=u(e.charCodeAt(r++)),(h>=M||h>P((C-v)/s))&&a("overflow"),v+=h*s,f=l<=E?_:l>=E+w?w:l-E,!(h<f);l+=M)p=M-f,s>P(C/p)&&a("overflow"),s*=p;t=m.length+1,E=d(v-o,t,0==o),P(v/t)>C-y&&a("overflow"),y+=P(v/t),v%=t,m.splice(v++,0,y)}return c(m)}function p(e){var t,i,n,r,o,s,c,u,f,p,m,g,v,y,E,x=[];for(e=l(e),g=e.length,t=S,i=0,o=I,s=0;s<g;++s)(m=e[s])<128&&x.push(N(m));for(n=r=x.length,r&&x.push(O);n<g;){for(c=C,s=0;s<g;++s)(m=e[s])>=t&&m<c&&(c=m);for(v=n+1,c-t>P((C-i)/v)&&a("overflow"),i+=(c-t)*v,t=c,s=0;s<g;++s)if(m=e[s],m<t&&++i>C&&a("overflow"),m==t){for(u=i,f=M;p=f<=o?_:f>=o+w?w:f-o,!(u<p);f+=M)E=u-p,y=M-p,x.push(N(h(p+E%y,0))),u=P(E/y);x.push(N(h(u,0))),o=d(i,v,n==r),i=0,++n}++i,++t}return x.join("")}function m(e){return s(e,function(e){return D.test(e)?f(e.slice(4).toLowerCase()):e})}function g(e){return s(e,function(e){return R.test(e)?"xn--"+p(e):e})}var v="object"==(void 0===n?"undefined":_typeof(n))&&n,y="object"==(void 0===i?"undefined":_typeof(i))&&i&&i.exports==v&&i,E="object"==(void 0===t?"undefined":_typeof(t))&&t;E.global!==E&&E.window!==E||(r=E);var x,b,C=2147483647,M=36,_=1,w=26,L=38,T=700,I=72,S=128,O="-",D=/^xn--/,R=/[^ -~]/,A=/\x2E|\u3002|\uFF0E|\uFF61/g,U={overflow:"Overflow: input needs wider integers to process","not-basic":"Illegal input >= 0x80 (not a basic code point)","invalid-input":"Invalid input"},B=M-_,P=Math.floor,N=String.fromCharCode;if(x={version:"1.2.4",ucs2:{decode:l,encode:c},decode:f,encode:p,toASCII:g,toUnicode:m},"function"==typeof e&&"object"==_typeof(e.amd)&&e.amd)e("punycode",function(){return x});else if(v&&!v.nodeType)if(y)y.exports=x;else for(b in x)x.hasOwnProperty(b)&&(v[b]=x[b]);else r.punycode=x}(this)}).call(this,"undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{})},{}],2:[function(e,t,i){function n(e,t,i){!e.defaultView||t===e.defaultView.pageXOffset&&i===e.defaultView.pageYOffset||e.defaultView.scrollTo(t,i)}function r(e,t){try{t&&(t.width=e.width,t.height=e.height,t.getContext("2d").putImageData(e.getContext("2d").getImageData(0,0,e.width,e.height),0,0))}catch(t){s("Unable to copy canvas content from",e,t)}}function a(e,t){for(var i=3===e.nodeType?document.createTextNode(e.nodeValue):e.cloneNode(!1),n=e.firstChild;n;)!0!==t&&1===n.nodeType&&"SCRIPT"===n.nodeName||i.appendChild(a(n,t)),n=n.nextSibling;return 1===e.nodeType&&(i._scrollTop=e.scrollTop,i._scrollLeft=e.scrollLeft,"CANVAS"===e.nodeName?r(e,i):"TEXTAREA"!==e.nodeName&&"SELECT"!==e.nodeName||(i.value=e.value)),i}function o(e){if(1===e.nodeType){e.scrollTop=e._scrollTop,e.scrollLeft=e._scrollLeft;for(var t=e.firstChild;t;)o(t),t=t.nextSibling}}var s=e("./log");t.exports=function(e,t,i,r,s,l,c){var u=a(e.documentElement,s.javascriptEnabled),h=t.createElement("iframe");return h.className="html2canvas-container",h.style.visibility="hidden",h.style.position="fixed",h.style.left="-10000px",h.style.top="0px",h.style.border="0",h.width=i,h.height=r,h.scrolling="no",t.body.appendChild(h),new Promise(function(t){var i=h.contentWindow.document;h.contentWindow.onload=h.onload=function(){var e=setInterval(function(){i.body.childNodes.length>0&&(o(i.documentElement),clearInterval(e),"view"===s.type&&(h.contentWindow.scrollTo(l,c),!/(iPad|iPhone|iPod)/g.test(navigator.userAgent)||h.contentWindow.scrollY===c&&h.contentWindow.scrollX===l||(i.documentElement.style.top=-c+"px",i.documentElement.style.left=-l+"px",
i.documentElement.style.position="absolute")),t(h))},50)},i.open(),i.write("<!DOCTYPE html><html></html>"),n(e,l,c),i.replaceChild(i.adoptNode(u),i.documentElement),i.close()})}},{"./log":13}],3:[function(e,t,i){function n(e){this.r=0,this.g=0,this.b=0,this.a=null;this.fromArray(e)||this.namedColor(e)||this.rgb(e)||this.rgba(e)||this.hex6(e)||this.hex3(e)}n.prototype.darken=function(e){var t=1-e;return new n([Math.round(this.r*t),Math.round(this.g*t),Math.round(this.b*t),this.a])},n.prototype.isTransparent=function(){return 0===this.a},n.prototype.isBlack=function(){return 0===this.r&&0===this.g&&0===this.b},n.prototype.fromArray=function(e){return Array.isArray(e)&&(this.r=Math.min(e[0],255),this.g=Math.min(e[1],255),this.b=Math.min(e[2],255),e.length>3&&(this.a=e[3])),Array.isArray(e)};var r=/^#([a-f0-9]{3})$/i;n.prototype.hex3=function(e){var t=null;return null!==(t=e.match(r))&&(this.r=parseInt(t[1][0]+t[1][0],16),this.g=parseInt(t[1][1]+t[1][1],16),this.b=parseInt(t[1][2]+t[1][2],16)),null!==t};var a=/^#([a-f0-9]{6})$/i;n.prototype.hex6=function(e){var t=null;return null!==(t=e.match(a))&&(this.r=parseInt(t[1].substring(0,2),16),this.g=parseInt(t[1].substring(2,4),16),this.b=parseInt(t[1].substring(4,6),16)),null!==t};var o=/^rgb\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*\)$/;n.prototype.rgb=function(e){var t=null;return null!==(t=e.match(o))&&(this.r=Number(t[1]),this.g=Number(t[2]),this.b=Number(t[3])),null!==t};var s=/^rgba\(\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d{1,3})\s*,\s*(\d?\.?\d+)\s*\)$/;n.prototype.rgba=function(e){var t=null;return null!==(t=e.match(s))&&(this.r=Number(t[1]),this.g=Number(t[2]),this.b=Number(t[3]),this.a=Number(t[4])),null!==t},n.prototype.toString=function(){return null!==this.a&&1!==this.a?"rgba("+[this.r,this.g,this.b,this.a].join(",")+")":"rgb("+[this.r,this.g,this.b].join(",")+")"},n.prototype.namedColor=function(e){e=e.toLowerCase();var t=l[e];if(t)this.r=t[0],this.g=t[1],this.b=t[2];else if("transparent"===e)return this.r=this.g=this.b=this.a=0,!0;return!!t},n.prototype.isColor=!0;var l={aliceblue:[240,248,255],antiquewhite:[250,235,215],aqua:[0,255,255],aquamarine:[127,255,212],azure:[240,255,255],beige:[245,245,220],bisque:[255,228,196],black:[0,0,0],blanchedalmond:[255,235,205],blue:[0,0,255],blueviolet:[138,43,226],brown:[165,42,42],burlywood:[222,184,135],cadetblue:[95,158,160],chartreuse:[127,255,0],chocolate:[210,105,30],coral:[255,127,80],cornflowerblue:[100,149,237],cornsilk:[255,248,220],crimson:[220,20,60],cyan:[0,255,255],darkblue:[0,0,139],darkcyan:[0,139,139],darkgoldenrod:[184,134,11],darkgray:[169,169,169],darkgreen:[0,100,0],darkgrey:[169,169,169],darkkhaki:[189,183,107],darkmagenta:[139,0,139],darkolivegreen:[85,107,47],darkorange:[255,140,0],darkorchid:[153,50,204],darkred:[139,0,0],darksalmon:[233,150,122],darkseagreen:[143,188,143],darkslateblue:[72,61,139],darkslategray:[47,79,79],darkslategrey:[47,79,79],darkturquoise:[0,206,209],darkviolet:[148,0,211],deeppink:[255,20,147],deepskyblue:[0,191,255],dimgray:[105,105,105],dimgrey:[105,105,105],dodgerblue:[30,144,255],firebrick:[178,34,34],floralwhite:[255,250,240],forestgreen:[34,139,34],fuchsia:[255,0,255],gainsboro:[220,220,220],ghostwhite:[248,248,255],gold:[255,215,0],goldenrod:[218,165,32],gray:[128,128,128],green:[0,128,0],greenyellow:[173,255,47],grey:[128,128,128],honeydew:[240,255,240],hotpink:[255,105,180],indianred:[205,92,92],indigo:[75,0,130],ivory:[255,255,240],khaki:[240,230,140],lavender:[230,230,250],lavenderblush:[255,240,245],lawngreen:[124,252,0],lemonchiffon:[255,250,205],lightblue:[173,216,230],lightcoral:[240,128,128],lightcyan:[224,255,255],lightgoldenrodyellow:[250,250,210],lightgray:[211,211,211],lightgreen:[144,238,144],lightgrey:[211,211,211],lightpink:[255,182,193],lightsalmon:[255,160,122],lightseagreen:[32,178,170],lightskyblue:[135,206,250],lightslategray:[119,136,153],lightslategrey:[119,136,153],lightsteelblue:[176,196,222],lightyellow:[255,255,224],lime:[0,255,0],limegreen:[50,205,50],linen:[250,240,230],magenta:[255,0,255],maroon:[128,0,0],mediumaquamarine:[102,205,170],mediumblue:[0,0,205],mediumorchid:[186,85,211],mediumpurple:[147,112,219],mediumseagreen:[60,179,113],mediumslateblue:[123,104,238],mediumspringgreen:[0,250,154],mediumturquoise:[72,209,204],mediumvioletred:[199,21,133],midnightblue:[25,25,112],mintcream:[245,255,250],mistyrose:[255,228,225],moccasin:[255,228,181],navajowhite:[255,222,173],navy:[0,0,128],oldlace:[253,245,230],olive:[128,128,0],olivedrab:[107,142,35],orange:[255,165,0],orangered:[255,69,0],orchid:[218,112,214],palegoldenrod:[238,232,170],palegreen:[152,251,152],paleturquoise:[175,238,238],palevioletred:[219,112,147],papayawhip:[255,239,213],peachpuff:[255,218,185],peru:[205,133,63],pink:[255,192,203],plum:[221,160,221],powderblue:[176,224,230],purple:[128,0,128],rebeccapurple:[102,51,153],red:[255,0,0],rosybrown:[188,143,143],royalblue:[65,105,225],saddlebrown:[139,69,19],salmon:[250,128,114],sandybrown:[244,164,96],seagreen:[46,139,87],seashell:[255,245,238],sienna:[160,82,45],silver:[192,192,192],skyblue:[135,206,235],slateblue:[106,90,205],slategray:[112,128,144],slategrey:[112,128,144],snow:[255,250,250],springgreen:[0,255,127],steelblue:[70,130,180],tan:[210,180,140],teal:[0,128,128],thistle:[216,191,216],tomato:[255,99,71],turquoise:[64,224,208],violet:[238,130,238],wheat:[245,222,179],white:[255,255,255],whitesmoke:[245,245,245],yellow:[255,255,0],yellowgreen:[154,205,50]};t.exports=n},{}],4:[function(t,i,n){function r(e,t){var i=M++;if(t=t||{},t.logging&&(v.options.logging=!0,v.options.start=Date.now()),t.async=void 0===t.async||t.async,t.allowTaint=void 0!==t.allowTaint&&t.allowTaint,t.removeContainer=void 0===t.removeContainer||t.removeContainer,t.javascriptEnabled=void 0!==t.javascriptEnabled&&t.javascriptEnabled,t.imageTimeout=void 0===t.imageTimeout?1e4:t.imageTimeout,t.renderer="function"==typeof t.renderer?t.renderer:f,t.strict=!!t.strict,"string"==typeof e){if("string"!=typeof t.proxy)return Promise.reject("Proxy must be used when rendering url");var n=null!=t.width?t.width:window.innerWidth,r=null!=t.height?t.height:window.innerHeight;return x(h(e),t.proxy,document,n,r,t).then(function(e){return o(e.contentWindow.document.documentElement,e,t,n,r)})}var s=(void 0===e?[document.documentElement]:e.length?e:[e])[0];return s.setAttribute(C+i,i),a(s.ownerDocument,t,s.ownerDocument.defaultView.innerWidth,s.ownerDocument.defaultView.innerHeight,i).then(function(e){return"function"==typeof t.onrendered&&(v("options.onrendered is deprecated, html2canvas returns a Promise containing the canvas"),t.onrendered(e)),e})}function a(e,t,i,n,r){return E(e,e,i,n,t,e.defaultView.pageXOffset,e.defaultView.pageYOffset).then(function(a){v("Document cloned");var s=C+r,l="["+s+"='"+r+"']";e.querySelector(l).removeAttribute(s);var c=a.contentWindow,u=c.document.querySelector(l);return("function"==typeof t.onclone?Promise.resolve(t.onclone(c.document)):Promise.resolve(!0)).then(function(){return o(u,a,t,i,n)})})}function o(e,t,i,n,r){var a=t.contentWindow,o=new d(a.document),h=new p(i,o),f=b(e),g="view"===i.type?n:c(a.document),y="view"===i.type?r:u(a.document),E=new i.renderer(g,y,h,i,document);return new m(e,E,o,h,i).ready.then(function(){v("Finished rendering");var n;return n="view"===i.type?l(E.canvas,{width:E.canvas.width,height:E.canvas.height,top:0,left:0,x:0,y:0}):e===a.document.body||e===a.document.documentElement||null!=i.canvas?E.canvas:l(E.canvas,{width:null!=i.width?i.width:f.width,height:null!=i.height?i.height:f.height,top:f.top,left:f.left,x:0,y:0}),s(t,i),n})}function s(e,t){t.removeContainer&&(e.parentNode.removeChild(e),v("Cleaned up container"))}function l(e,t){var i=document.createElement("canvas"),n=Math.min(e.width-1,Math.max(0,t.left)),r=Math.min(e.width,Math.max(1,t.left+t.width)),a=Math.min(e.height-1,Math.max(0,t.top)),o=Math.min(e.height,Math.max(1,t.top+t.height));i.width=t.width,i.height=t.height;var s=r-n,l=o-a;return v("Cropping canvas at:","left:",t.left,"top:",t.top,"width:",s,"height:",l),v("Resulting crop with width",t.width,"and height",t.height,"with x",n,"and y",a),i.getContext("2d").drawImage(e,n,a,s,l,t.x,t.y,s,l),i}function c(e){return Math.max(Math.max(e.body.scrollWidth,e.documentElement.scrollWidth),Math.max(e.body.offsetWidth,e.documentElement.offsetWidth),Math.max(e.body.clientWidth,e.documentElement.clientWidth))}function u(e){return Math.max(Math.max(e.body.scrollHeight,e.documentElement.scrollHeight),Math.max(e.body.offsetHeight,e.documentElement.offsetHeight),Math.max(e.body.clientHeight,e.documentElement.clientHeight))}function h(e){var t=document.createElement("a");return t.href=e,t.href=t.href,t}var d=t("./support"),f=t("./renderers/canvas"),p=t("./imageloader"),m=t("./nodeparser"),g=t("./nodecontainer"),v=t("./log"),y=t("./utils"),E=t("./clone"),x=t("./proxy").loadUrlDocument,b=y.getBounds,C="data-html2canvas-node",M=0;r.CanvasRenderer=f,r.NodeContainer=g,r.log=v,r.utils=y;var _="undefined"==typeof document||"function"!=typeof Object.create||"function"!=typeof document.createElement("canvas").getContext?function(){return Promise.reject("No canvas support")}:r;i.exports=_,"function"==typeof e&&e.amd&&e("html2canvas",[],function(){return _})},{"./clone":2,"./imageloader":11,"./log":13,"./nodecontainer":14,"./nodeparser":15,"./proxy":16,"./renderers/canvas":20,"./support":22,"./utils":26}],5:[function(e,t,i){function n(e){if(this.src=e,r("DummyImageContainer for",e),!this.promise||!this.image){r("Initiating DummyImageContainer"),n.prototype.image=new Image;var t=this.image;n.prototype.promise=new Promise(function(e,i){t.onload=e,t.onerror=i,t.src=a(),!0===t.complete&&e(t)})}}var r=e("./log"),a=e("./utils").smallImage;t.exports=n},{"./log":13,"./utils":26}],6:[function(e,t,i){function n(e,t){var i,n,a=document.createElement("div"),o=document.createElement("img"),s=document.createElement("span");a.style.visibility="hidden",a.style.fontFamily=e,a.style.fontSize=t,a.style.margin=0,a.style.padding=0,document.body.appendChild(a),o.src=r(),o.width=1,o.height=1,o.style.margin=0,o.style.padding=0,o.style.verticalAlign="baseline",s.style.fontFamily=e,s.style.fontSize=t,s.style.margin=0,s.style.padding=0,s.appendChild(document.createTextNode("Hidden Text")),a.appendChild(s),a.appendChild(o),i=o.offsetTop-s.offsetTop+1,a.removeChild(s),a.appendChild(document.createTextNode("Hidden Text")),a.style.lineHeight="normal",o.style.verticalAlign="super",n=o.offsetTop-a.offsetTop+1,document.body.removeChild(a),this.baseline=i,this.lineWidth=1,this.middle=n}var r=e("./utils").smallImage;t.exports=n},{"./utils":26}],7:[function(e,t,i){function n(){this.data={}}var r=e("./font");n.prototype.getMetrics=function(e,t){return void 0===this.data[e+"-"+t]&&(this.data[e+"-"+t]=new r(e,t)),this.data[e+"-"+t]},t.exports=n},{"./font":6}],8:[function(e,t,i){function n(t,i,n){this.image=null,this.src=t;var r=this,o=a(t);this.promise=(i?new Promise(function(e){"about:blank"===t.contentWindow.document.URL||null==t.contentWindow.document.documentElement?t.contentWindow.onload=t.onload=function(){e(t)}:e(t)}):this.proxyLoad(n.proxy,o,n)).then(function(t){return e("./core")(t.contentWindow.document.documentElement,{type:"view",width:t.width,height:t.height,proxy:n.proxy,javascriptEnabled:n.javascriptEnabled,removeContainer:n.removeContainer,allowTaint:n.allowTaint,imageTimeout:n.imageTimeout/2})}).then(function(e){return r.image=e})}var r=e("./utils"),a=r.getBounds,o=e("./proxy").loadUrlDocument;n.prototype.proxyLoad=function(e,t,i){var n=this.src;return o(n.src,e,n.ownerDocument,t.width,t.height,i)},t.exports=n},{"./core":4,"./proxy":16,"./utils":26}],9:[function(e,t,i){function n(e){this.src=e.value,this.colorStops=[],this.type=null,this.x0=.5,this.y0=.5,this.x1=.5,this.y1=.5,this.promise=Promise.resolve(!0)}n.TYPES={LINEAR:1,RADIAL:2},n.REGEXP_COLORSTOP=/^\s*(rgba?\(\s*\d{1,3},\s*\d{1,3},\s*\d{1,3}(?:,\s*[0-9\.]+)?\s*\)|[a-z]{3,20}|#[a-f0-9]{3,6})(?:\s+(\d{1,3}(?:\.\d+)?)(%|px)?)?(?:\s|$)/i,t.exports=n},{}],10:[function(e,t,i){function n(e,t){this.src=e,this.image=new Image;var i=this;this.tainted=null,this.promise=new Promise(function(n,r){i.image.onload=n,i.image.onerror=r,t&&(i.image.crossOrigin="anonymous"),i.image.src=e,!0===i.image.complete&&n(i.image)})}t.exports=n},{}],11:[function(e,t,i){function n(e,t){this.link=null,this.options=e,this.support=t,this.origin=this.getOrigin(window.location.href)}var r=e("./log"),a=e("./imagecontainer"),o=e("./dummyimagecontainer"),s=e("./proxyimagecontainer"),l=e("./framecontainer"),c=e("./svgcontainer"),u=e("./svgnodecontainer"),h=e("./lineargradientcontainer"),d=e("./webkitgradientcontainer"),f=e("./utils").bind;n.prototype.findImages=function(e){var t=[];return e.reduce(function(e,t){switch(t.node.nodeName){case"IMG":return e.concat([{args:[t.node.src],method:"url"}]);case"svg":case"IFRAME":return e.concat([{args:[t.node],method:t.node.nodeName}])}return e},[]).forEach(this.addImage(t,this.loadImage),this),t},n.prototype.findBackgroundImage=function(e,t){return t.parseBackgroundImages().filter(this.hasImageBackground).forEach(this.addImage(e,this.loadImage),this),e},n.prototype.addImage=function(e,t){return function(i){i.args.forEach(function(n){this.imageExists(e,n)||(e.splice(0,0,t.call(this,i)),r("Added image #"+e.length,"string"==typeof n?n.substring(0,100):n))},this)}},n.prototype.hasImageBackground=function(e){return"none"!==e.method},n.prototype.loadImage=function(e){if("url"===e.method){var t=e.args[0];return!this.isSVG(t)||this.support.svg||this.options.allowTaint?t.match(/data:image\/.*;base64,/i)?new a(t.replace(/url\(['"]{0,}|['"]{0,}\)$/gi,""),!1):this.isSameOrigin(t)||!0===this.options.allowTaint||this.isSVG(t)?new a(t,!1):this.support.cors&&!this.options.allowTaint&&this.options.useCORS?new a(t,!0):this.options.proxy?new s(t,this.options.proxy):new o(t):new c(t)}return"linear-gradient"===e.method?new h(e):"gradient"===e.method?new d(e):"svg"===e.method?new u(e.args[0],this.support.svg):"IFRAME"===e.method?new l(e.args[0],this.isSameOrigin(e.args[0].src),this.options):new o(e)},n.prototype.isSVG=function(e){return"svg"===e.substring(e.length-3).toLowerCase()||c.prototype.isInline(e)},n.prototype.imageExists=function(e,t){return e.some(function(e){return e.src===t})},n.prototype.isSameOrigin=function(e){return this.getOrigin(e)===this.origin},n.prototype.getOrigin=function(e){var t=this.link||(this.link=document.createElement("a"));return t.href=e,t.href=t.href,t.protocol+t.hostname+t.port},n.prototype.getPromise=function(e){return this.timeout(e,this.options.imageTimeout).catch(function(){return new o(e.src).promise.then(function(t){e.image=t})})},n.prototype.get=function(e){var t=null;return this.images.some(function(i){return(t=i).src===e})?t:null},n.prototype.fetch=function(e){return this.images=e.reduce(f(this.findBackgroundImage,this),this.findImages(e)),this.images.forEach(function(e,t){e.promise.then(function(){r("Succesfully loaded image #"+(t+1),e)},function(i){r("Failed loading image #"+(t+1),e,i)})}),this.ready=Promise.all(this.images.map(this.getPromise,this)),r("Finished searching images"),this},n.prototype.timeout=function(e,t){var i,n=Promise.race([e.promise,new Promise(function(n,a){i=setTimeout(function(){r("Timed out loading image",e),a(e)},t)})]).then(function(e){return clearTimeout(i),e});return n.catch(function(){clearTimeout(i)}),n},t.exports=n},{"./dummyimagecontainer":5,"./framecontainer":8,"./imagecontainer":10,"./lineargradientcontainer":12,"./log":13,"./proxyimagecontainer":17,"./svgcontainer":23,"./svgnodecontainer":24,"./utils":26,"./webkitgradientcontainer":27}],12:[function(e,t,i){function n(e){r.apply(this,arguments),this.type=r.TYPES.LINEAR;var t=n.REGEXP_DIRECTION.test(e.args[0])||!r.REGEXP_COLORSTOP.test(e.args[0]);t?e.args[0].split(/\s+/).reverse().forEach(function(e,t){switch(e){case"left":this.x0=0,this.x1=1;break;case"top":this.y0=0,this.y1=1;break;case"right":this.x0=1,this.x1=0;break;case"bottom":this.y0=1,this.y1=0;break;case"to":var i=this.y0,n=this.x0;this.y0=this.y1,this.x0=this.x1,this.x1=n,this.y1=i;break;case"center":break;default:var r=.01*parseFloat(e,10);if(isNaN(r))break;0===t?(this.y0=r,this.y1=1-this.y0):(this.x0=r,this.x1=1-this.x0)}},this):(this.y0=0,this.y1=1),this.colorStops=e.args.slice(t?1:0).map(function(e){var t=e.match(r.REGEXP_COLORSTOP),i=+t[2],n=0===i?"%":t[3];return{color:new a(t[1]),stop:"%"===n?i/100:null}}),null===this.colorStops[0].stop&&(this.colorStops[0].stop=0),null===this.colorStops[this.colorStops.length-1].stop&&(this.colorStops[this.colorStops.length-1].stop=1),this.colorStops.forEach(function(e,t){null===e.stop&&this.colorStops.slice(t).some(function(i,n){return null!==i.stop&&(e.stop=(i.stop-this.colorStops[t-1].stop)/(n+1)+this.colorStops[t-1].stop,!0)},this)},this)}var r=e("./gradientcontainer"),a=e("./color");n.prototype=Object.create(r.prototype),n.REGEXP_DIRECTION=/^\s*(?:to|left|right|top|bottom|center|\d{1,3}(?:\.\d+)?%?)(?:\s|$)/i,t.exports=n},{"./color":3,"./gradientcontainer":9}],13:[function(e,t,i){var n=function e(){e.options.logging&&window.console&&window.console.log&&Function.prototype.bind.call(window.console.log,window.console).apply(window.console,[Date.now()-e.options.start+"ms","html2canvas:"].concat([].slice.call(arguments,0)))};n.options={logging:!1},t.exports=n},{}],14:[function(e,t,i){function n(e,t){this.node=e,this.parent=t,this.stack=null,this.bounds=null,this.borders=null,this.clip=[],this.backgroundClip=[],this.offsetBounds=null,this.visible=null,this.computedStyles=null,this.colors={},this.styles={},this.backgroundImages=null,this.transformData=null,this.transformMatrix=null,this.isPseudoElement=!1,this.opacity=null}function r(e){var t=e.options[e.selectedIndex||0];return t?t.text||"":""}function a(e){if(e&&"matrix"===e[1])return e[2].split(",").map(function(e){return parseFloat(e.trim())});if(e&&"matrix3d"===e[1]){var t=e[2].split(",").map(function(e){return parseFloat(e.trim())});return[t[0],t[1],t[4],t[5],t[12],t[13]]}}function o(e){return-1!==e.toString().indexOf("%")}function s(e){return e.replace("px","")}function l(e){return parseFloat(e)}var c=e("./color"),u=e("./utils"),h=u.getBounds,d=u.parseBackgrounds,f=u.offsetBounds;n.prototype.cloneTo=function(e){e.visible=this.visible,e.borders=this.borders,e.bounds=this.bounds,e.clip=this.clip,e.backgroundClip=this.backgroundClip,e.computedStyles=this.computedStyles,e.styles=this.styles,e.backgroundImages=this.backgroundImages,e.opacity=this.opacity},n.prototype.getOpacity=function(){return null===this.opacity?this.opacity=this.cssFloat("opacity"):this.opacity},n.prototype.assignStack=function(e){this.stack=e,e.children.push(this)},n.prototype.isElementVisible=function(){return this.node.nodeType===Node.TEXT_NODE?this.parent.visible:"none"!==this.css("display")&&"hidden"!==this.css("visibility")&&!this.node.hasAttribute("data-html2canvas-ignore")&&("INPUT"!==this.node.nodeName||"hidden"!==this.node.getAttribute("type"))},n.prototype.css=function(e){return this.computedStyles||(this.computedStyles=this.isPseudoElement?this.parent.computedStyle(this.before?":before":":after"):this.computedStyle(null)),this.styles[e]||(this.styles[e]=this.computedStyles[e])},n.prototype.prefixedCss=function(e){var t=["webkit","moz","ms","o"],i=this.css(e);return void 0===i&&t.some(function(t){return void 0!==(i=this.css(t+e.substr(0,1).toUpperCase()+e.substr(1)))},this),void 0===i?null:i},n.prototype.computedStyle=function(e){return this.node.ownerDocument.defaultView.getComputedStyle(this.node,e)},n.prototype.cssInt=function(e){var t=parseInt(this.css(e),10);return isNaN(t)?0:t},n.prototype.color=function(e){return this.colors[e]||(this.colors[e]=new c(this.css(e)))},n.prototype.cssFloat=function(e){var t=parseFloat(this.css(e));return isNaN(t)?0:t},n.prototype.fontWeight=function(){var e=this.css("fontWeight");switch(parseInt(e,10)){case 401:e="bold";break;case 400:e="normal"}return e},n.prototype.parseClip=function(){var e=this.css("clip").match(this.CLIP);return e?{top:parseInt(e[1],10),right:parseInt(e[2],10),bottom:parseInt(e[3],10),left:parseInt(e[4],10)}:null},n.prototype.parseBackgroundImages=function(){return this.backgroundImages||(this.backgroundImages=d(this.css("backgroundImage")))},n.prototype.cssList=function(e,t){var i=(this.css(e)||"").split(",");return i=i[t||0]||i[0]||"auto",i=i.trim().split(" "),1===i.length&&(i=[i[0],o(i[0])?"auto":i[0]]),i},n.prototype.parseBackgroundSize=function(e,t,i){var n,r,a=this.cssList("backgroundSize",i);if(o(a[0]))n=e.width*parseFloat(a[0])/100;else{if(/contain|cover/.test(a[0])){var s=e.width/e.height,l=t.width/t.height;return s<l^"contain"===a[0]?{width:e.height*l,height:e.height}:{width:e.width,height:e.width/l}}n=parseInt(a[0],10)}return r="auto"===a[0]&&"auto"===a[1]?t.height:"auto"===a[1]?n/t.width*t.height:o(a[1])?e.height*parseFloat(a[1])/100:parseInt(a[1],10),"auto"===a[0]&&(n=r/t.height*t.width),{width:n,height:r}},n.prototype.parseBackgroundPosition=function(e,t,i,n){var r,a,s=this.cssList("backgroundPosition",i);return r=o(s[0])?(e.width-(n||t).width)*(parseFloat(s[0])/100):parseInt(s[0],10),a="auto"===s[1]?r/t.width*t.height:o(s[1])?(e.height-(n||t).height)*parseFloat(s[1])/100:parseInt(s[1],10),"auto"===s[0]&&(r=a/t.height*t.width),{left:r,top:a}},n.prototype.parseBackgroundRepeat=function(e){return this.cssList("backgroundRepeat",e)[0]},n.prototype.parseTextShadows=function(){var e=this.css("textShadow"),t=[];if(e&&"none"!==e)for(var i=e.match(this.TEXT_SHADOW_PROPERTY),n=0;i&&n<i.length;n++){var r=i[n].match(this.TEXT_SHADOW_VALUES);t.push({color:new c(r[0]),offsetX:r[1]?parseFloat(r[1].replace("px","")):0,offsetY:r[2]?parseFloat(r[2].replace("px","")):0,blur:r[3]?r[3].replace("px",""):0})}return t},n.prototype.parseTransform=function(){if(!this.transformData)if(this.hasTransform()){var e=this.parseBounds(),t=this.prefixedCss("transformOrigin").split(" ").map(s).map(l);t[0]+=e.left,t[1]+=e.top,this.transformData={origin:t,matrix:this.parseTransformMatrix()}}else this.transformData={origin:[0,0],matrix:[1,0,0,1,0,0]};return this.transformData},n.prototype.parseTransformMatrix=function(){if(!this.transformMatrix){var e=this.prefixedCss("transform"),t=e?a(e.match(this.MATRIX_PROPERTY)):null;this.transformMatrix=t||[1,0,0,1,0,0]}return this.transformMatrix},n.prototype.parseBounds=function(){return this.bounds||(this.bounds=this.hasTransform()?f(this.node):h(this.node))},n.prototype.hasTransform=function(){return"1,0,0,1,0,0"!==this.parseTransformMatrix().join(",")||this.parent&&this.parent.hasTransform()},n.prototype.getValue=function(){var e=this.node.value||"";return"SELECT"===this.node.tagName?e=r(this.node):"password"===this.node.type&&(e=Array(e.length+1).join("â€¢")),0===e.length?this.node.placeholder||"":e},n.prototype.MATRIX_PROPERTY=/(matrix|matrix3d)\((.+)\)/,n.prototype.TEXT_SHADOW_PROPERTY=/((rgba|rgb)\([^\)]+\)(\s-?\d+px){0,})/g,n.prototype.TEXT_SHADOW_VALUES=/(-?\d+px)|(#.+)|(rgb\(.+\))|(rgba\(.+\))/g,n.prototype.CLIP=/^rect\((\d+)px,? (\d+)px,? (\d+)px,? (\d+)px\)$/,t.exports=n},{"./color":3,"./utils":26}],15:[function(e,t,i){function n(e,t,i,n,r){H("Starting NodeParser"),this.renderer=t,this.options=r,this.range=null,this.support=i,this.renderQueue=[],this.stack=new X(!0,1,e.ownerDocument,null);var a=new V(e,null);if(r.background&&t.rectangle(0,0,t.width,t.height,new j(r.background)),e===e.ownerDocument.documentElement){var o=new V(a.color("backgroundColor").isTransparent()?e.ownerDocument.body:e.ownerDocument.documentElement,null);t.rectangle(0,0,t.width,t.height,o.color("backgroundColor"))}a.visibile=a.isElementVisible(),this.createPseudoHideStyles(e.ownerDocument),this.disableAnimations(e.ownerDocument),this.nodes=B([a].concat(this.getChildren(a)).filter(function(e){return e.visible=e.isElementVisible()}).map(this.getPseudoElements,this)),this.fontMetrics=new q,H("Fetched nodes, total:",this.nodes.length),H("Calculate overflow clips"),this.calculateOverflowClips(),H("Start fetching images"),this.images=n.fetch(this.nodes.filter(T)),this.ready=this.images.ready.then(Z(function(){return H("Images loaded, starting parsing"),H("Creating stacking contexts"),this.createStackingContexts(),H("Sorting stacking contexts"),this.sortStackingContexts(this.stack),this.parse(this.stack),H("Render queue created with "+this.renderQueue.length+" items"),new Promise(Z(function(e){r.async?"function"==typeof r.async?r.async.call(this,this.renderQueue,e):this.renderQueue.length>0?(this.renderIndex=0,this.asyncRenderer(this.renderQueue,e)):e():(this.renderQueue.forEach(this.paint,this),e())},this))},this))}function r(e){return e.parent&&e.parent.clip.length}function a(e){return e.replace(/(\-[a-z])/g,function(e){return e.toUpperCase().replace("-","")})}function o(){}function s(e,t,i,n){return e.map(function(r,a){if(r.width>0){var o=t.left,s=t.top,l=t.width,c=t.height-e[2].width;switch(a){case 0:c=e[0].width,r.args=h({c1:[o,s],c2:[o+l,s],c3:[o+l-e[1].width,s+c],c4:[o+e[3].width,s+c]},n[0],n[1],i.topLeftOuter,i.topLeftInner,i.topRightOuter,i.topRightInner);break;case 1:o=t.left+t.width-e[1].width,l=e[1].width,r.args=h({c1:[o+l,s],c2:[o+l,s+c+e[2].width],c3:[o,s+c],c4:[o,s+e[0].width]},n[1],n[2],i.topRightOuter,i.topRightInner,i.bottomRightOuter,i.bottomRightInner);break;case 2:s=s+t.height-e[2].width,c=e[2].width,r.args=h({c1:[o+l,s+c],c2:[o,s+c],c3:[o+e[3].width,s],c4:[o+l-e[3].width,s]},n[2],n[3],i.bottomRightOuter,i.bottomRightInner,i.bottomLeftOuter,i.bottomLeftInner);break;case 3:l=e[3].width,r.args=h({c1:[o,s+c+e[2].width],c2:[o,s],c3:[o+l,s+e[0].width],c4:[o+l,s+c]},n[3],n[0],i.bottomLeftOuter,i.bottomLeftInner,i.topLeftOuter,i.topLeftInner)}}return r})}function l(e,t,i,n){var r=(Math.sqrt(2)-1)/3*4,a=i*r,o=n*r,s=e+i,l=t+n;return{topLeft:u({x:e,y:l},{x:e,y:l-o},{x:s-a,y:t},{x:s,y:t}),topRight:u({x:e,y:t},{x:e+a,y:t},{x:s,y:l-o},{x:s,y:l}),bottomRight:u({x:s,y:t},{x:s,y:t+o},{x:e+a,y:l},{x:e,y:l}),bottomLeft:u({x:s,y:l},{x:s-a,y:l},{x:e,y:t+o},{x:e,y:t})}}function c(e,t,i){var n=e.left,r=e.top,a=e.width,o=e.height,s=t[0][0]<a/2?t[0][0]:a/2,c=t[0][1]<o/2?t[0][1]:o/2,u=t[1][0]<a/2?t[1][0]:a/2,h=t[1][1]<o/2?t[1][1]:o/2,d=t[2][0]<a/2?t[2][0]:a/2,f=t[2][1]<o/2?t[2][1]:o/2,p=t[3][0]<a/2?t[3][0]:a/2,m=t[3][1]<o/2?t[3][1]:o/2,g=a-u,v=o-f,y=a-d,E=o-m;return{topLeftOuter:l(n,r,s,c).topLeft.subdivide(.5),topLeftInner:l(n+i[3].width,r+i[0].width,Math.max(0,s-i[3].width),Math.max(0,c-i[0].width)).topLeft.subdivide(.5),topRightOuter:l(n+g,r,u,h).topRight.subdivide(.5),topRightInner:l(n+Math.min(g,a+i[3].width),r+i[0].width,g>a+i[3].width?0:u-i[3].width,h-i[0].width).topRight.subdivide(.5),bottomRightOuter:l(n+y,r+v,d,f).bottomRight.subdivide(.5),bottomRightInner:l(n+Math.min(y,a-i[3].width),r+Math.min(v,o+i[0].width),Math.max(0,d-i[1].width),f-i[2].width).bottomRight.subdivide(.5),bottomLeftOuter:l(n,r+E,p,m).bottomLeft.subdivide(.5),bottomLeftInner:l(n+i[3].width,r+E,Math.max(0,p-i[3].width),m-i[2].width).bottomLeft.subdivide(.5)}}function u(e,t,i,n){var r=function(e,t,i){return{x:e.x+(t.x-e.x)*i,y:e.y+(t.y-e.y)*i}};return{start:e,startControl:t,endControl:i,end:n,subdivide:function(a){var o=r(e,t,a),s=r(t,i,a),l=r(i,n,a),c=r(o,s,a),h=r(s,l,a),d=r(c,h,a);return[u(e,o,c,d),u(d,h,l,n)]},curveTo:function(e){e.push(["bezierCurve",t.x,t.y,i.x,i.y,n.x,n.y])},curveToReversed:function(n){n.push(["bezierCurve",i.x,i.y,t.x,t.y,e.x,e.y])}}}function h(e,t,i,n,r,a,o){var s=[];return t[0]>0||t[1]>0?(s.push(["line",n[1].start.x,n[1].start.y]),n[1].curveTo(s)):s.push(["line",e.c1[0],e.c1[1]]),i[0]>0||i[1]>0?(s.push(["line",a[0].start.x,a[0].start.y]),a[0].curveTo(s),s.push(["line",o[0].end.x,o[0].end.y]),o[0].curveToReversed(s)):(s.push(["line",e.c2[0],e.c2[1]]),s.push(["line",e.c3[0],e.c3[1]])),t[0]>0||t[1]>0?(s.push(["line",r[1].end.x,r[1].end.y]),r[1].curveToReversed(s)):s.push(["line",e.c4[0],e.c4[1]]),s}function d(e,t,i,n,r,a,o){t[0]>0||t[1]>0?(e.push(["line",n[0].start.x,n[0].start.y]),n[0].curveTo(e),n[1].curveTo(e)):e.push(["line",a,o]),(i[0]>0||i[1]>0)&&e.push(["line",r[0].start.x,r[0].start.y])}function f(e){return e.cssInt("zIndex")<0}function p(e){return e.cssInt("zIndex")>0}function m(e){return 0===e.cssInt("zIndex")}function g(e){return-1!==["inline","inline-block","inline-table"].indexOf(e.css("display"))}function v(e){return e instanceof X}function y(e){return e.node.data.trim().length>0}function E(e){return/^(normal|none|0px)$/.test(e.parent.css("letterSpacing"))}function x(e){return["TopLeft","TopRight","BottomRight","BottomLeft"].map(function(t){var i=e.css("border"+t+"Radius"),n=i.split(" ");return n.length<=1&&(n[1]=n[0]),n.map(R)})}function b(e){return e.nodeType===Node.TEXT_NODE||e.nodeType===Node.ELEMENT_NODE}function C(e){return"auto"!==(-1!==["absolute","relative","fixed"].indexOf(e.css("position"))?e.css("zIndex"):"auto")}function M(e){return"static"!==e.css("position")}function _(e){return"none"!==e.css("float")}function w(e){return-1!==["inline-block","inline-table"].indexOf(e.css("display"))}function L(e){var t=this;return function(){return!e.apply(t,arguments)}}function T(e){return e.node.nodeType===Node.ELEMENT_NODE}function I(e){return!0===e.isPseudoElement}function S(e){return e.node.nodeType===Node.TEXT_NODE}function O(e){return function(t,i){return t.cssInt("zIndex")+e.indexOf(t)/e.length-(i.cssInt("zIndex")+e.indexOf(i)/e.length)}}function D(e){return e.getOpacity()<1}function R(e){return parseInt(e,10)}function A(e){return e.width}function U(e){return e.node.nodeType!==Node.ELEMENT_NODE||-1===["SCRIPT","HEAD","TITLE","OBJECT","BR","OPTION"].indexOf(e.node.nodeName)}function B(e){return[].concat.apply([],e)}function P(e){var t=e.substr(0,1);return t===e.substr(e.length-1)&&t.match(/'|"/)?e.substr(1,e.length-2):e}function N(e){for(var t,i=[],n=0,r=!1;e.length;)k(e[n])===r?(t=e.splice(0,n),t.length&&i.push(G.ucs2.encode(t)),r=!r,n=0):n++,n>=e.length&&(t=e.splice(0,n),t.length&&i.push(G.ucs2.encode(t)));return i}function k(e){return-1!==[32,13,10,9,45].indexOf(e)}function F(e){return/[^\u0000-\u00ff]/.test(e)}var H=e("./log"),G=e("punycode"),V=e("./nodecontainer"),z=e("./textcontainer"),W=e("./pseudoelementcontainer"),q=e("./fontmetrics"),j=e("./color"),X=e("./stackingcontext"),Y=e("./utils"),Z=Y.bind,K=Y.getBounds,Q=Y.parseBackgrounds,J=Y.offsetBounds;n.prototype.calculateOverflowClips=function(){this.nodes.forEach(function(e){if(T(e)){I(e)&&e.appendToDOM(),e.borders=this.parseBorders(e);var t="hidden"===e.css("overflow")?[e.borders.clip]:[],i=e.parseClip();i&&-1!==["absolute","fixed"].indexOf(e.css("position"))&&t.push([["rect",e.bounds.left+i.left,e.bounds.top+i.top,i.right-i.left,i.bottom-i.top]]),e.clip=r(e)?e.parent.clip.concat(t):t,e.backgroundClip="hidden"!==e.css("overflow")?e.clip.concat([e.borders.clip]):e.clip,I(e)&&e.cleanDOM()}else S(e)&&(e.clip=r(e)?e.parent.clip:[]);I(e)||(e.bounds=null)},this)},n.prototype.asyncRenderer=function(e,t,i){i=i||Date.now(),this.paint(e[this.renderIndex++]),e.length===this.renderIndex?t():i+20>Date.now()?this.asyncRenderer(e,t,i):setTimeout(Z(function(){this.asyncRenderer(e,t)},this),0)},n.prototype.createPseudoHideStyles=function(e){this.createStyles(e,"."+W.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+':before { content: "" !important; display: none !important; }.'+W.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER+':after { content: "" !important; display: none !important; }')},n.prototype.disableAnimations=function(e){this.createStyles(e,"* { -webkit-animation: none !important; -moz-animation: none !important; -o-animation: none !important; animation: none !important; -webkit-transition: none !important; -moz-transition: none !important; -o-transition: none !important; transition: none !important;}")},n.prototype.createStyles=function(e,t){var i=e.createElement("style");i.innerHTML=t,e.body.appendChild(i)},n.prototype.getPseudoElements=function(e){var t=[[e]];if(e.node.nodeType===Node.ELEMENT_NODE){var i=this.getPseudoElement(e,":before"),n=this.getPseudoElement(e,":after");i&&t.push(i),
n&&t.push(n)}return B(t)},n.prototype.getPseudoElement=function(e,t){var i=e.computedStyle(t);if(!i||!i.content||"none"===i.content||"-moz-alt-content"===i.content||"none"===i.display)return null;for(var n=P(i.content),r="url"===n.substr(0,3),o=document.createElement(r?"img":"html2canvaspseudoelement"),s=new W(o,e,t),l=i.length-1;l>=0;l--){var c=a(i.item(l));o.style[c]=i[c]}if(o.className=W.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE+" "+W.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER,r)return o.src=Q(n)[0].args[0],[s];var u=document.createTextNode(n);return o.appendChild(u),[s,new z(u,s)]},n.prototype.getChildren=function(e){return B([].filter.call(e.node.childNodes,b).map(function(t){var i=[t.nodeType===Node.TEXT_NODE?new z(t,e):new V(t,e)].filter(U);return t.nodeType===Node.ELEMENT_NODE&&i.length&&"TEXTAREA"!==t.tagName?i[0].isElementVisible()?i.concat(this.getChildren(i[0])):[]:i},this))},n.prototype.newStackingContext=function(e,t){var i=new X(t,e.getOpacity(),e.node,e.parent);e.cloneTo(i),(t?i.getParentStack(this):i.parent.stack).contexts.push(i),e.stack=i},n.prototype.createStackingContexts=function(){this.nodes.forEach(function(e){T(e)&&(this.isRootElement(e)||D(e)||C(e)||this.isBodyWithTransparentRoot(e)||e.hasTransform())?this.newStackingContext(e,!0):T(e)&&(M(e)&&m(e)||w(e)||_(e))?this.newStackingContext(e,!1):e.assignStack(e.parent.stack)},this)},n.prototype.isBodyWithTransparentRoot=function(e){return"BODY"===e.node.nodeName&&e.parent.color("backgroundColor").isTransparent()},n.prototype.isRootElement=function(e){return null===e.parent},n.prototype.sortStackingContexts=function(e){e.contexts.sort(O(e.contexts.slice(0))),e.contexts.forEach(this.sortStackingContexts,this)},n.prototype.parseTextBounds=function(e){return function(t,i,n){if("none"!==e.parent.css("textDecoration").substr(0,4)||0!==t.trim().length){if(this.support.rangeBounds&&!e.parent.hasTransform()){var r=n.slice(0,i).join("").length;return this.getRangeBounds(e.node,r,t.length)}if(e.node&&"string"==typeof e.node.data){var a=e.node.splitText(t.length),o=this.getWrapperBounds(e.node,e.parent.hasTransform());return e.node=a,o}}else this.support.rangeBounds&&!e.parent.hasTransform()||(e.node=e.node.splitText(t.length));return{}}},n.prototype.getWrapperBounds=function(e,t){var i=e.ownerDocument.createElement("html2canvaswrapper"),n=e.parentNode,r=e.cloneNode(!0);i.appendChild(e.cloneNode(!0)),n.replaceChild(i,e);var a=t?J(i):K(i);return n.replaceChild(r,i),a},n.prototype.getRangeBounds=function(e,t,i){var n=this.range||(this.range=e.ownerDocument.createRange());return n.setStart(e,t),n.setEnd(e,t+i),n.getBoundingClientRect()},n.prototype.parse=function(e){var t=e.contexts.filter(f),i=e.children.filter(T),n=i.filter(L(_)),r=n.filter(L(M)).filter(L(g)),a=i.filter(L(M)).filter(_),s=n.filter(L(M)).filter(g),l=e.contexts.concat(n.filter(M)).filter(m),c=e.children.filter(S).filter(y),u=e.contexts.filter(p);t.concat(r).concat(a).concat(s).concat(l).concat(c).concat(u).forEach(function(e){this.renderQueue.push(e),v(e)&&(this.parse(e),this.renderQueue.push(new o))},this)},n.prototype.paint=function(e){try{e instanceof o?this.renderer.ctx.restore():S(e)?(I(e.parent)&&e.parent.appendToDOM(),this.paintText(e),I(e.parent)&&e.parent.cleanDOM()):this.paintNode(e)}catch(e){if(H(e),this.options.strict)throw e}},n.prototype.paintNode=function(e){v(e)&&(this.renderer.setOpacity(e.opacity),this.renderer.ctx.save(),e.hasTransform()&&this.renderer.setTransform(e.parseTransform())),"INPUT"===e.node.nodeName&&"checkbox"===e.node.type?this.paintCheckbox(e):"INPUT"===e.node.nodeName&&"radio"===e.node.type?this.paintRadio(e):this.paintElement(e)},n.prototype.paintElement=function(e){var t=e.parseBounds();this.renderer.clip(e.backgroundClip,function(){this.renderer.renderBackground(e,t,e.borders.borders.map(A))},this),this.renderer.clip(e.clip,function(){this.renderer.renderBorders(e.borders.borders)},this),this.renderer.clip(e.backgroundClip,function(){switch(e.node.nodeName){case"svg":case"IFRAME":var i=this.images.get(e.node);i?this.renderer.renderImage(e,t,e.borders,i):H("Error loading <"+e.node.nodeName+">",e.node);break;case"IMG":var n=this.images.get(e.node.src);n?this.renderer.renderImage(e,t,e.borders,n):H("Error loading <img>",e.node.src);break;case"CANVAS":this.renderer.renderImage(e,t,e.borders,{image:e.node});break;case"SELECT":case"INPUT":case"TEXTAREA":this.paintFormValue(e)}},this)},n.prototype.paintCheckbox=function(e){var t=e.parseBounds(),i=Math.min(t.width,t.height),n={width:i-1,height:i-1,top:t.top,left:t.left},r=[3,3],a=[r,r,r,r],o=[1,1,1,1].map(function(e){return{color:new j("#A5A5A5"),width:e}}),l=c(n,a,o);this.renderer.clip(e.backgroundClip,function(){this.renderer.rectangle(n.left+1,n.top+1,n.width-2,n.height-2,new j("#DEDEDE")),this.renderer.renderBorders(s(o,n,l,a)),e.node.checked&&(this.renderer.font(new j("#424242"),"normal","normal","bold",i-3+"px","arial"),this.renderer.text("âœ”",n.left+i/6,n.top+i-1))},this)},n.prototype.paintRadio=function(e){var t=e.parseBounds(),i=Math.min(t.width,t.height)-2;this.renderer.clip(e.backgroundClip,function(){this.renderer.circleStroke(t.left+1,t.top+1,i,new j("#DEDEDE"),1,new j("#A5A5A5")),e.node.checked&&this.renderer.circle(Math.ceil(t.left+i/4)+1,Math.ceil(t.top+i/4)+1,Math.floor(i/2),new j("#424242"))},this)},n.prototype.paintFormValue=function(e){var t=e.getValue();if(t.length>0){var i=e.node.ownerDocument,n=i.createElement("html2canvaswrapper");["lineHeight","textAlign","fontFamily","fontWeight","fontSize","color","paddingLeft","paddingTop","paddingRight","paddingBottom","width","height","borderLeftStyle","borderTopStyle","borderLeftWidth","borderTopWidth","boxSizing","whiteSpace","wordWrap"].forEach(function(t){try{n.style[t]=e.css(t)}catch(e){H("html2canvas: Parse: Exception caught in renderFormValue: "+e.message)}});var r=e.parseBounds();n.style.position="fixed",n.style.left=r.left+"px",n.style.top=r.top+"px",n.textContent=t,i.body.appendChild(n),this.paintText(new z(n.firstChild,e)),i.body.removeChild(n)}},n.prototype.paintText=function(e){e.applyTextTransform();var t=G.ucs2.decode(e.node.data),i=this.options.letterRendering&&!E(e)||F(e.node.data)?t.map(function(e){return G.ucs2.encode([e])}):N(t),n=e.parent.fontWeight(),r=e.parent.css("fontSize"),a=e.parent.css("fontFamily"),o=e.parent.parseTextShadows();this.renderer.font(e.parent.color("color"),e.parent.css("fontStyle"),e.parent.css("fontVariant"),n,r,a),o.length?this.renderer.fontShadow(o[0].color,o[0].offsetX,o[0].offsetY,o[0].blur):this.renderer.clearShadow(),this.renderer.clip(e.parent.clip,function(){i.map(this.parseTextBounds(e),this).forEach(function(t,n){t&&(this.renderer.text(i[n],t.left,t.bottom),this.renderTextDecoration(e.parent,t,this.fontMetrics.getMetrics(a,r)))},this)},this)},n.prototype.renderTextDecoration=function(e,t,i){switch(e.css("textDecoration").split(" ")[0]){case"underline":this.renderer.rectangle(t.left,Math.round(t.top+i.baseline+i.lineWidth),t.width,1,e.color("color"));break;case"overline":this.renderer.rectangle(t.left,Math.round(t.top),t.width,1,e.color("color"));break;case"line-through":this.renderer.rectangle(t.left,Math.ceil(t.top+i.middle+i.lineWidth),t.width,1,e.color("color"))}};var $={inset:[["darken",.6],["darken",.1],["darken",.1],["darken",.6]]};n.prototype.parseBorders=function(e){var t=e.parseBounds(),i=x(e),n=["Top","Right","Bottom","Left"].map(function(t,i){var n=e.css("border"+t+"Style"),r=e.color("border"+t+"Color");"inset"===n&&r.isBlack()&&(r=new j([255,255,255,r.a]));var a=$[n]?$[n][i]:null;return{width:e.cssInt("border"+t+"Width"),color:a?r[a[0]](a[1]):r,args:null}}),r=c(t,i,n);return{clip:this.parseBackgroundClip(e,r,n,i,t),borders:s(n,t,r,i)}},n.prototype.parseBackgroundClip=function(e,t,i,n,r){var a=e.css("backgroundClip"),o=[];switch(a){case"content-box":case"padding-box":d(o,n[0],n[1],t.topLeftInner,t.topRightInner,r.left+i[3].width,r.top+i[0].width),d(o,n[1],n[2],t.topRightInner,t.bottomRightInner,r.left+r.width-i[1].width,r.top+i[0].width),d(o,n[2],n[3],t.bottomRightInner,t.bottomLeftInner,r.left+r.width-i[1].width,r.top+r.height-i[2].width),d(o,n[3],n[0],t.bottomLeftInner,t.topLeftInner,r.left+i[3].width,r.top+r.height-i[2].width);break;default:d(o,n[0],n[1],t.topLeftOuter,t.topRightOuter,r.left,r.top),d(o,n[1],n[2],t.topRightOuter,t.bottomRightOuter,r.left+r.width,r.top),d(o,n[2],n[3],t.bottomRightOuter,t.bottomLeftOuter,r.left+r.width,r.top+r.height),d(o,n[3],n[0],t.bottomLeftOuter,t.topLeftOuter,r.left,r.top+r.height)}return o},t.exports=n},{"./color":3,"./fontmetrics":7,"./log":13,"./nodecontainer":14,"./pseudoelementcontainer":18,"./stackingcontext":21,"./textcontainer":25,"./utils":26,punycode:1}],16:[function(e,t,i){function n(e,t,i){var n="withCredentials"in new XMLHttpRequest;if(!t)return Promise.reject("No proxy configured");var r=o(n),l=s(t,e,r);return n?u(l):a(i,l,r).then(function(e){return p(e.content)})}function r(e,t,i){var n="crossOrigin"in new Image,r=o(n),l=s(t,e,r);return n?Promise.resolve(l):a(i,l,r).then(function(e){return"data:"+e.type+";base64,"+e.content})}function a(e,t,i){return new Promise(function(n,r){var a=e.createElement("script"),o=function(){delete window.html2canvas.proxy[i],e.body.removeChild(a)};window.html2canvas.proxy[i]=function(e){o(),n(e)},a.src=t,a.onerror=function(e){o(),r(e)},e.body.appendChild(a)})}function o(e){return e?"":"html2canvas_"+Date.now()+"_"+ ++m+"_"+Math.round(1e5*Math.random())}function s(e,t,i){return e+"?url="+encodeURIComponent(t)+(i.length?"&callback=html2canvas.proxy."+i:"")}function l(e){return function(t){var i,n=new DOMParser;try{i=n.parseFromString(t,"text/html")}catch(e){d("DOMParser not supported, falling back to createHTMLDocument"),i=document.implementation.createHTMLDocument("");try{i.open(),i.write(t),i.close()}catch(e){d("createHTMLDocument write not supported, falling back to document.body.innerHTML"),i.body.innerHTML=t}}var r=i.querySelector("base");if(!r||!r.href.host){var a=i.createElement("base");a.href=e,i.head.insertBefore(a,i.head.firstChild)}return i}}function c(e,t,i,r,a,o){return new n(e,t,window.document).then(l(e)).then(function(e){return f(e,i,r,a,o,0,0)})}var u=e("./xhr"),h=e("./utils"),d=e("./log"),f=e("./clone"),p=h.decode64,m=0;i.Proxy=n,i.ProxyURL=r,i.loadUrlDocument=c},{"./clone":2,"./log":13,"./utils":26,"./xhr":28}],17:[function(e,t,i){function n(e,t){var i=document.createElement("a");i.href=e,e=i.href,this.src=e,this.image=new Image;var n=this;this.promise=new Promise(function(i,a){n.image.crossOrigin="Anonymous",n.image.onload=i,n.image.onerror=a,new r(e,t,document).then(function(e){n.image.src=e}).catch(a)})}var r=e("./proxy").ProxyURL;t.exports=n},{"./proxy":16}],18:[function(e,t,i){function n(e,t,i){r.call(this,e,t),this.isPseudoElement=!0,this.before=":before"===i}var r=e("./nodecontainer");n.prototype.cloneTo=function(e){n.prototype.cloneTo.call(this,e),e.isPseudoElement=!0,e.before=this.before},n.prototype=Object.create(r.prototype),n.prototype.appendToDOM=function(){this.before?this.parent.node.insertBefore(this.node,this.parent.node.firstChild):this.parent.node.appendChild(this.node),this.parent.node.className+=" "+this.getHideClass()},n.prototype.cleanDOM=function(){this.node.parentNode.removeChild(this.node),this.parent.node.className=this.parent.node.className.replace(this.getHideClass(),"")},n.prototype.getHideClass=function(){return this["PSEUDO_HIDE_ELEMENT_CLASS_"+(this.before?"BEFORE":"AFTER")]},n.prototype.PSEUDO_HIDE_ELEMENT_CLASS_BEFORE="___html2canvas___pseudoelement_before",n.prototype.PSEUDO_HIDE_ELEMENT_CLASS_AFTER="___html2canvas___pseudoelement_after",t.exports=n},{"./nodecontainer":14}],19:[function(e,t,i){function n(e,t,i,n,r){this.width=e,this.height=t,this.images=i,this.options=n,this.document=r}var r=e("./log");n.prototype.renderImage=function(e,t,i,n){var r=e.cssInt("paddingLeft"),a=e.cssInt("paddingTop"),o=e.cssInt("paddingRight"),s=e.cssInt("paddingBottom"),l=i.borders,c=t.width-(l[1].width+l[3].width+r+o),u=t.height-(l[0].width+l[2].width+a+s);this.drawImage(n,0,0,n.image.width||c,n.image.height||u,t.left+r+l[3].width,t.top+a+l[0].width,c,u)},n.prototype.renderBackground=function(e,t,i){t.height>0&&t.width>0&&(this.renderBackgroundColor(e,t),this.renderBackgroundImage(e,t,i))},n.prototype.renderBackgroundColor=function(e,t){var i=e.color("backgroundColor");i.isTransparent()||this.rectangle(t.left,t.top,t.width,t.height,i)},n.prototype.renderBorders=function(e){e.forEach(this.renderBorder,this)},n.prototype.renderBorder=function(e){e.color.isTransparent()||null===e.args||this.drawShape(e.args,e.color)},n.prototype.renderBackgroundImage=function(e,t,i){e.parseBackgroundImages().reverse().forEach(function(n,a,o){switch(n.method){case"url":var s=this.images.get(n.args[0]);s?this.renderBackgroundRepeating(e,t,s,o.length-(a+1),i):r("Error loading background-image",n.args[0]);break;case"linear-gradient":case"gradient":var l=this.images.get(n.value);l?this.renderBackgroundGradient(l,t,i):r("Error loading background-image",n.args[0]);break;case"none":break;default:r("Unknown background-image type",n.args[0])}},this)},n.prototype.renderBackgroundRepeating=function(e,t,i,n,r){var a=e.parseBackgroundSize(t,i.image,n),o=e.parseBackgroundPosition(t,i.image,n,a);switch(e.parseBackgroundRepeat(n)){case"repeat-x":case"repeat no-repeat":this.backgroundRepeatShape(i,o,a,t,t.left+r[3],t.top+o.top+r[0],99999,a.height,r);break;case"repeat-y":case"no-repeat repeat":this.backgroundRepeatShape(i,o,a,t,t.left+o.left+r[3],t.top+r[0],a.width,99999,r);break;case"no-repeat":this.backgroundRepeatShape(i,o,a,t,t.left+o.left+r[3],t.top+o.top+r[0],a.width,a.height,r);break;default:this.renderBackgroundRepeat(i,o,a,{top:t.top,left:t.left},r[3],r[0])}},t.exports=n},{"./log":13}],20:[function(e,t,i){function n(e,t){a.apply(this,arguments),this.canvas=this.options.canvas||this.document.createElement("canvas"),this.options.canvas||(this.canvas.width=e,this.canvas.height=t),this.ctx=this.canvas.getContext("2d"),this.taintCtx=this.document.createElement("canvas").getContext("2d"),this.ctx.textBaseline="bottom",this.variables={},s("Initialized CanvasRenderer with size",e,"x",t)}function r(e){return e.length>0}var a=e("../renderer"),o=e("../lineargradientcontainer"),s=e("../log");n.prototype=Object.create(a.prototype),n.prototype.setFillStyle=function(e){return this.ctx.fillStyle="object"===(void 0===e?"undefined":_typeof(e))&&e.isColor?e.toString():e,this.ctx},n.prototype.rectangle=function(e,t,i,n,r){this.setFillStyle(r).fillRect(e,t,i,n)},n.prototype.circle=function(e,t,i,n){this.setFillStyle(n),this.ctx.beginPath(),this.ctx.arc(e+i/2,t+i/2,i/2,0,2*Math.PI,!0),this.ctx.closePath(),this.ctx.fill()},n.prototype.circleStroke=function(e,t,i,n,r,a){this.circle(e,t,i,n),this.ctx.strokeStyle=a.toString(),this.ctx.stroke()},n.prototype.drawShape=function(e,t){this.shape(e),this.setFillStyle(t).fill()},n.prototype.taints=function(e){if(null===e.tainted){this.taintCtx.drawImage(e.image,0,0);try{this.taintCtx.getImageData(0,0,1,1),e.tainted=!1}catch(t){this.taintCtx=document.createElement("canvas").getContext("2d"),e.tainted=!0}}return e.tainted},n.prototype.drawImage=function(e,t,i,n,r,a,o,s,l){this.taints(e)&&!this.options.allowTaint||this.ctx.drawImage(e.image,t,i,n,r,a,o,s,l)},n.prototype.clip=function(e,t,i){this.ctx.save(),e.filter(r).forEach(function(e){this.shape(e).clip()},this),t.call(i),this.ctx.restore()},n.prototype.shape=function(e){return this.ctx.beginPath(),e.forEach(function(e,t){"rect"===e[0]?this.ctx.rect.apply(this.ctx,e.slice(1)):this.ctx[0===t?"moveTo":e[0]+"To"].apply(this.ctx,e.slice(1))},this),this.ctx.closePath(),this.ctx},n.prototype.font=function(e,t,i,n,r,a){this.setFillStyle(e).font=[t,i,n,r,a].join(" ").split(",")[0]},n.prototype.fontShadow=function(e,t,i,n){this.setVariable("shadowColor",e.toString()).setVariable("shadowOffsetY",t).setVariable("shadowOffsetX",i).setVariable("shadowBlur",n)},n.prototype.clearShadow=function(){this.setVariable("shadowColor","rgba(0,0,0,0)")},n.prototype.setOpacity=function(e){this.ctx.globalAlpha=e},n.prototype.setTransform=function(e){this.ctx.translate(e.origin[0],e.origin[1]),this.ctx.transform.apply(this.ctx,e.matrix),this.ctx.translate(-e.origin[0],-e.origin[1])},n.prototype.setVariable=function(e,t){return this.variables[e]!==t&&(this.variables[e]=this.ctx[e]=t),this},n.prototype.text=function(e,t,i){this.ctx.fillText(e,t,i)},n.prototype.backgroundRepeatShape=function(e,t,i,n,r,a,o,s,l){var c=[["line",Math.round(r),Math.round(a)],["line",Math.round(r+o),Math.round(a)],["line",Math.round(r+o),Math.round(s+a)],["line",Math.round(r),Math.round(s+a)]];this.clip([c],function(){this.renderBackgroundRepeat(e,t,i,n,l[3],l[0])},this)},n.prototype.renderBackgroundRepeat=function(e,t,i,n,r,a){var o=Math.round(n.left+t.left+r),s=Math.round(n.top+t.top+a);this.setFillStyle(this.ctx.createPattern(this.resizeImage(e,i),"repeat")),this.ctx.translate(o,s),this.ctx.fill(),this.ctx.translate(-o,-s)},n.prototype.renderBackgroundGradient=function(e,t){if(e instanceof o){var i=this.ctx.createLinearGradient(t.left+t.width*e.x0,t.top+t.height*e.y0,t.left+t.width*e.x1,t.top+t.height*e.y1);e.colorStops.forEach(function(e){i.addColorStop(e.stop,e.color.toString())}),this.rectangle(t.left,t.top,t.width,t.height,i)}},n.prototype.resizeImage=function(e,t){var i=e.image;if(i.width===t.width&&i.height===t.height)return i;var n,r=document.createElement("canvas");return r.width=t.width,r.height=t.height,n=r.getContext("2d"),n.drawImage(i,0,0,i.width,i.height,0,0,t.width,t.height),r},t.exports=n},{"../lineargradientcontainer":12,"../log":13,"../renderer":19}],21:[function(e,t,i){function n(e,t,i,n){r.call(this,i,n),this.ownStacking=e,this.contexts=[],this.children=[],this.opacity=(this.parent?this.parent.stack.opacity:1)*t}var r=e("./nodecontainer");n.prototype=Object.create(r.prototype),n.prototype.getParentStack=function(e){var t=this.parent?this.parent.stack:null;return t?t.ownStacking?t:t.getParentStack(e):e.stack},t.exports=n},{"./nodecontainer":14}],22:[function(e,t,i){function n(e){this.rangeBounds=this.testRangeBounds(e),this.cors=this.testCORS(),this.svg=this.testSVG()}n.prototype.testRangeBounds=function(e){var t,i,n,r,a=!1;return e.createRange&&(t=e.createRange(),t.getBoundingClientRect&&(i=e.createElement("boundtest"),i.style.height="123px",i.style.display="block",e.body.appendChild(i),t.selectNode(i),n=t.getBoundingClientRect(),r=n.height,123===r&&(a=!0),e.body.removeChild(i))),a},n.prototype.testCORS=function(){return void 0!==(new Image).crossOrigin},n.prototype.testSVG=function(){var e=new Image,t=document.createElement("canvas"),i=t.getContext("2d");e.src="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg'></svg>";try{i.drawImage(e,0,0),t.toDataURL()}catch(e){return!1}return!0},t.exports=n},{}],23:[function(e,t,i){function n(e){this.src=e,this.image=null;var t=this;this.promise=this.hasFabric().then(function(){return t.isInline(e)?Promise.resolve(t.inlineFormatting(e)):r(e)}).then(function(e){return new Promise(function(i){window.html2canvas.svg.fabric.loadSVGFromString(e,t.createCanvas.call(t,i))})})}var r=e("./xhr"),a=e("./utils").decode64;n.prototype.hasFabric=function(){return window.html2canvas.svg&&window.html2canvas.svg.fabric?Promise.resolve():Promise.reject(new Error("html2canvas.svg.js is not loaded, cannot render svg"))},n.prototype.inlineFormatting=function(e){return/^data:image\/svg\+xml;base64,/.test(e)?this.decode64(this.removeContentType(e)):this.removeContentType(e)},n.prototype.removeContentType=function(e){return e.replace(/^data:image\/svg\+xml(;base64)?,/,"")},n.prototype.isInline=function(e){return/^data:image\/svg\+xml/i.test(e)},n.prototype.createCanvas=function(e){var t=this;return function(i,n){var r=new window.html2canvas.svg.fabric.StaticCanvas("c");t.image=r.lowerCanvasEl,r.setWidth(n.width).setHeight(n.height).add(window.html2canvas.svg.fabric.util.groupSVGElements(i,n)).renderAll(),e(r.lowerCanvasEl)}},n.prototype.decode64=function(e){return"function"==typeof window.atob?window.atob(e):a(e)},t.exports=n},{"./utils":26,"./xhr":28}],24:[function(e,t,i){function n(e,t){this.src=e,this.image=null;var i=this;this.promise=t?new Promise(function(t,n){i.image=new Image,i.image.onload=t,i.image.onerror=n,i.image.src="data:image/svg+xml,"+(new XMLSerializer).serializeToString(e),!0===i.image.complete&&t(i.image)}):this.hasFabric().then(function(){return new Promise(function(t){window.html2canvas.svg.fabric.parseSVGDocument(e,i.createCanvas.call(i,t))})})}var r=e("./svgcontainer");n.prototype=Object.create(r.prototype),t.exports=n},{"./svgcontainer":23}],25:[function(e,t,i){function n(e,t){a.call(this,e,t)}function r(e,t,i){if(e.length>0)return t+i.toUpperCase()}var a=e("./nodecontainer");n.prototype=Object.create(a.prototype),n.prototype.applyTextTransform=function(){this.node.data=this.transform(this.parent.css("textTransform"))},n.prototype.transform=function(e){var t=this.node.data;switch(e){case"lowercase":return t.toLowerCase();case"capitalize":return t.replace(/(^|\s|:|-|\(|\))([a-z])/g,r);case"uppercase":return t.toUpperCase();default:return t}},t.exports=n},{"./nodecontainer":14}],26:[function(e,t,i){i.smallImage=function(){return"data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7"},i.bind=function(e,t){return function(){return e.apply(t,arguments)}},i.decode64=function(e){var t,i,n,r,a,o,s,l,c="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",u=e.length,h="";for(t=0;t<u;t+=4)i=c.indexOf(e[t]),n=c.indexOf(e[t+1]),r=c.indexOf(e[t+2]),a=c.indexOf(e[t+3]),o=i<<2|n>>4,s=(15&n)<<4|r>>2,l=(3&r)<<6|a,h+=64===r?String.fromCharCode(o):64===a||-1===a?String.fromCharCode(o,s):String.fromCharCode(o,s,l);return h},i.getBounds=function(e){if(e.getBoundingClientRect){var t=e.getBoundingClientRect(),i=null==e.offsetWidth?t.width:e.offsetWidth;return{top:t.top,bottom:t.bottom||t.top+t.height,right:t.left+i,left:t.left,width:i,height:null==e.offsetHeight?t.height:e.offsetHeight}}return{}},i.offsetBounds=function(e){var t=e.offsetParent?i.offsetBounds(e.offsetParent):{top:0,left:0};return{top:e.offsetTop+t.top,bottom:e.offsetTop+e.offsetHeight+t.top,right:e.offsetLeft+t.left+e.offsetWidth,left:e.offsetLeft+t.left,width:e.offsetWidth,height:e.offsetHeight}},i.parseBackgrounds=function(e){var t,i,n,r,a,o,s,l=" \r\n\t",c=[],u=0,h=0,d=function(){t&&('"'===i.substr(0,1)&&(i=i.substr(1,i.length-2)),i&&s.push(i),"-"===t.substr(0,1)&&(r=t.indexOf("-",1)+1)>0&&(n=t.substr(0,r),t=t.substr(r)),c.push({prefix:n,method:t.toLowerCase(),value:a,args:s,image:null})),s=[],t=n=i=a=""};return s=[],t=n=i=a="",e.split("").forEach(function(e){if(!(0===u&&l.indexOf(e)>-1)){switch(e){case'"':o?o===e&&(o=null):o=e;break;case"(":if(o)break;if(0===u)return u=1,void(a+=e);h++;break;case")":if(o)break;if(1===u){if(0===h)return u=0,a+=e,void d();h--}break;case",":if(o)break;if(0===u)return void d();if(1===u&&0===h&&!t.match(/^url$/i))return s.push(i),i="",void(a+=e)}a+=e,0===u?t+=e:i+=e}}),d(),c}},{}],27:[function(e,t,i){function n(e){r.apply(this,arguments),this.type="linear"===e.args[0]?r.TYPES.LINEAR:r.TYPES.RADIAL}var r=e("./gradientcontainer");n.prototype=Object.create(r.prototype),t.exports=n},{"./gradientcontainer":9}],28:[function(e,t,i){function n(e){return new Promise(function(t,i){var n=new XMLHttpRequest;n.open("GET",e),n.onload=function(){200===n.status?t(n.responseText):i(new Error(n.statusText))},n.onerror=function(){i(new Error("Network Error"))},n.send()})}t.exports=n},{}]},{},[4])(4)}),CLOUD.Extensions=CLOUD.Extensions||{},CLOUD.Extensions.Utils=CLOUD.Extensions.Utils||{},CLOUD.Extensions.Utils.Geometric={isInsideBounds:function(e,t,i){return e>=i.x&&e<=i.x+i.width&&t>=i.y&&t<=i.y+i.height},getAngleBetweenPoints:function(e,t){return Math.atan2(t.y-e.y,t.x-e.x)},isEqualBetweenPoints:function(e,t,i){i=i||1e-4;var n=e.x-t.x,r=e.y-t.y;return!(Math.sqrt(n*n+r*r)>i)}},CLOUD.Extensions=CLOUD.Extensions||{},CLOUD.Extensions.Utils=CLOUD.Extensions.Utils||{},CLOUD.Extensions.Utils.Shape2D={createSvgElement:function(e){var t=document.createElementNS("http://www.w3.org/2000/svg",e);return t.setAttribute("pointer-events","inherit"),t},getRGBAString:function(e,t){return t<=0?"none":["rgba("+parseInt("0x"+e.substr(1,2)),",",parseInt("0x"+e.substr(3,2)),",",parseInt("0x"+e.substr(5,2)),",",t,")"].join("")},makeFlag:function(){var e=this.createSvgElement("path");return e.setAttribute("d","M0 0 L0 -20 L15 -13 L4 -6.87 L4 0Z"),e},makeBubble:function(){var e=this.createSvgElement("path");return e.setAttribute("d","m0.0035,-19.88544c-3.838253,0 -6.95,2.581968 -6.95,5.766754c0,3.185555 6.95,13.933247 6.95,13.933247s6.95,-10.747692 6.95,-13.933247c0,-3.184786 -3.11082,-5.766754 -6.95,-5.766754z"),e},makeCommon:function(e,t){var i=this.createSvgElement("image");return i.href.baseVal=e,i.setAttribute("height",t.height.toString()+"px"),i.setAttribute("width",t.width.toString()+"px"),i}},CLOUD.CustomizedDwgMapping={drawingToModel:function(e,t,i){var n=i[1],r=CLOUD.CustomizedDwgMapping.getScale(i,t),a=e.clone().sub(n);a.x*=r.scaleX,a.y*=r.scaleY;var o=t.min,s=new THREE.Vector3;return s.x=o.x+a.x,s.y=o.y+a.y,s},getScale:function(e,t){var i=e[1].clone().sub(e[0]),n=e[2].clone().sub(e[0]),r={x:n.length(),y:i.length()},a=t.max.sub(t.min);n=a.x,i=a.y;var o={x:Math.abs(n),y:Math.abs(i)};return{scaleX:o.x/r.x,scaleY:o.y/r.y}}},CLOUD.MarkerUtil={viewer:void 0,setOptions:function(e,t){e.hasOwnProperty("options")||(e.options={});for(var i in t)e.options[i]=t[i];return e.options},transformPosition:function(e){if(void 0===CLOUD.MarkerUtil.viewer)throw new Error("please set the viewer for transformPosition.");var t=CLOUD.DomUtil2D.getContainerOffsetToClient(document.getElementById("viewport")),i=CLOUD.MarkerUtil.viewer.getScene(),n=CLOUD.MarkerUtil.viewer.cameraControl.camera,r=i.getMatrixGlobal(),a=new THREE.Vector3(e.x,e.y,e.z);return a.applyMatrix4(r),a.project(n),a.x=Math.round(.5*(a.x+1)*t.width),a.y=Math.round(-.5*(a.y-1)*t.height),{x:a.x,y:a.y}},panes:{},createPane:function(e,t){var i=e?e.replace("Pane","")+"-pane":"",n=CLOUD.DomUtil2D.create("div",i,t||CLOUD.MarkerUtil.mainPane?CLOUD.MarkerUtil.mainPane:document.getElementById("viewport"));return e&&(CLOUD.MarkerUtil.panes[e]=n),n},getPane:function(e,t){return void 0===e&&(e="markerPane"),CLOUD.MarkerUtil.panes.hasOwnProperty(e)?CLOUD.MarkerUtil.panes[e]:CLOUD.MarkerUtil.createPane(e,t)}},CLOUD.CustomizedLevelMapping={initialize:function(e,t,i,n){this.levelHeight=t,this.locatingPoints=i,this.imagePixelSize=n;var r=e.getScene(),a=r.getMatrixGlobal(),o=new THREE.Matrix4;o.getInverse(a);var s=new THREE.Plane;s.setFromNormalAndCoplanarPoint(new THREE.Vector3(0,0,1),new THREE.Vector3(0,0,t)),s.applyMatrix4(a);for(var l=e.cameraControl.getContainerDimensions(),c=[],u=0;u<i.length;++u){var h=i[u],d=e.cameraControl.getRaycaster(h.x+l.left,h.y+l.top),f=d.ray.intersectPlane(s);f.applyMatrix4(o),c.push(f)}var p=c[0],m=c[1].sub(c[0]),g=c[2].sub(c[0]),v={x:m.length(),y:g.length()};return m.normalize(),g.normalize(),{dirX:m,dirY:g,origin:p,scaleX:v.x/n.x,scaleY:v.y/n.y}},toWorldPoint:function(e,t,i){var n=new THREE.Vector3(e.dirX.x,e.dirX.y,e.dirX.z);n.multiplyScalar(t*e.scaleX);var r=new THREE.Vector3(e.dirY.x,e.dirY.y,e.dirY.z);r.multiplyScalar(i*e.scaleY);var a=new THREE.Vector3(e.origin.x,e.origin.y,e.origin.z);return a.add(n).add(r),a},toImagePixelPoint:function(e,t,i,n){var r=new THREE.Vector3(t,i,n);r.sub(e.origin);var a=r.clone().projectOnVector(e.dirX),o=r.clone().projectOnVector(e.dirY);return{x:a.length()/e.scaleX,y:o.length()/e.scaleY}},toCameraPosition:function(e,t){var i=e.getScene(),n=i.getMatrixGlobal(),r=new THREE.Matrix4;r.getInverse(n);var a=new THREE.Vector3(t.x,t.y,t.z);a.applyMatrix4(n);var o=e.camera,s=o.position.clone().sub(o.target);return a.add(s),a.applyMatrix4(r),a},moveCamera:function(e,t,i){var n=i||1700,r=new THREE.Vector3(t.x,t.y,t.z+n),a=e.getScene(),o=a.getMatrixGlobal();r.applyMatrix4(o),e.cameraControl.flyToPointWithParallelEye(r)}};var NaviAlgorithm=function(){function e(){_classCallCheck(this,e),this._isNormalizeMousePoint=!1}return _createClass(e,[{key:"cross",value:function(e,t,i,n){return(t.x-e.x)*(n.y-i.y)-(t.y-e.y)*(n.x-i.x)}},{key:"getArea",value:function(e,t,i){return this.cross(e,t,e,i)}},{key:"getAbsArea",value:function(e,t,i){return Math.abs(this.getArea(e,t,i))}},{key:"getInterPoint",value:function(e,t,i,n){var r=this.getAbsArea(e,t,i),a=this.getAbsArea(e,t,n);return new THREE.Vector2((n.x*r+i.x*a)/(r+a),(n.y*r+i.y*a)/(r+a))}},{key:"isAngleGreaterThanPi",value:function(e,t,i){var n=new THREE.Vector3;return n.crossVectors(e,t),!(n.dot(i)>=0)}},{key:"normalizedPointToScreen",value:function(e,t){e.x=e.x*t.width,e.y=-e.y*t.height}},{key:"screenToNormalizedPoint",value:function(e,t){e.x=e.x/t.width,e.y=-e.y/t.height}},{key:"normalizedPointToWorld",value:function(e,t){var i=t.getSize();e.x=.5*(e.x+1)*i.x+t.min.x,e.y=.5*(e.y+1)*i.y+t.min.y}},{key:"worldToNormalizedPoint",value:function(e,t){var i=t.getSize();e.x=(e.x-t.min.x)/i.x*2-1,e.y=(e.y-t.min.y)/i.y*2-1}},{key:"toWorldPoint",value:function(e,t,i,n){e.x<0&&(e.x=0),e.x>t&&(e.x=t),e.y<0&&(e.y=0),e.y>i&&(e.y=i),e.x=e.x/t*2-1,e.y=-e.y/i*2+1,this.normalizedPointToWorld(e,n)}},{key:"getCuttingBox",value:function(e,t,i){var n=i._mapContainer,r=i._floorPlaneBox;if(!n)return null;if(!r)return null;var a=CLOUD.DomUtil2D.getContainerOffsetToClient(n);if(0===a.width||0===a.height)return null;var o=new THREE.Vector2;o.x=e.x-a.left,o.y=e.y-a.top;var s=new THREE.Vector2;return s.x=t.x-a.left,s.y=t.y-a.top,this.getCuttingBoxOnCanvas(o,s,i)}},{key:"getCuttingBoxOnCanvas",value:function(e,t,i){var n=i._mapContainer,r=i._floorPlaneBox;if(!n)return null;if(!r)return null;var a=r.min.z,o=r.max.z,s=new THREE.Box3,l=new THREE.Vector2(e.x,e.y),c=new THREE.Vector2(t.x,t.y);this.toWorldPoint(l,i.width,i.height,i.naviData.getAxisGridBox2D()),this.toWorldPoint(c,i.width,i.height,i.naviData.getAxisGridBox2D());var u=[];return u.push(new THREE.Vector3(l.x,l.y,a)),u.push(new THREE.Vector3(l.x,l.y,o)),u.push(new THREE.Vector3(l.x,c.y,a)),u.push(new THREE.Vector3(l.x,c.y,o)),u.push(new THREE.Vector3(c.x,c.y,a)),u.push(new THREE.Vector3(c.x,c.y,o)),u.push(new THREE.Vector3(c.x,l.y,a)),u.push(new THREE.Vector3(c.x,l.y,o)),s.setFromPoints(u),{min:{x:s.min.x,y:s.min.y,z:s.min.z},max:{x:s.max.x,y:s.max.y,z:s.max.z}}}},{key:"canvasPointToClient",value:function(e,t){var i=t._mapContainer;if(!i||!t._floorPlaneBox)return null;var n=CLOUD.DomUtil2D.getContainerOffsetToClient(i);if(0===n.width||0===n.height)return null;var r=new THREE.Vector2;return r.x=e.x+n.left,r.y=e.y+n.top,r}},{key:"getMainSceneMatrix",value:function(e){return e.getScene().getMatrixGlobal()}},{key:"transformWorldPoint",value:function(e,t){var i=this.getMainSceneMatrix(e);t.applyMatrix4(i)}},{key:"expandBbox",value:function(e,t){var i=e.getCenter(),n=e.getSize(),r=new THREE.Vector2,a=t,o=n.x/n.y,s=n.x,l=n.y;o>a?l=s/a:o<a&&(s=l*a),r.set(s,l),e.setFromCenterAndSize(i,r)}},{key:"containsPointInMainScene",value:function(e,t){var i=e.getScene().getBoundingBoxWorld();return!!i&&i.containsPoint(t)}},{key:"isMouseOverCanvas",value:function(e,t){var i=e._mapContainer;if(this._isNormalizeMousePoint=!1,i){var n=CLOUD.DomUtil2D.getContainerOffsetToClient(i),r=new THREE.Vector2;if(r.x=t.x-n.left,r.y=t.y-n.top,0===n.width||0===n.height)return!1;if(r.x>0&&r.x<e.width&&r.y>0&&r.y<e.height)return e.normalizedMouse.x=r.x/e.width*2-1,e.normalizedMouse.y=-r.y/e.height*2+1,this._isNormalizeMousePoint=!0,!0}return!1}},{key:"flyToPointWithParallelEye",value:function(e,t){e.cameraControl.flyToPointWithParallelEye(t)}},{key:"getIntersectionToMinDistance",value:function(e,t){if(e.length<1)return null;for(var i=0,n=0,r=0,a=e.length;r<a;r++){var o=e[r];if(o.intersectionPoint){var s=new THREE.Vector2(o.intersectionPoint.x,o.intersectionPoint.y),l=s.distanceToSquared(t);0==i?i=l:i>l&&(i=l,n=r)}}return e[n]}},{key:"imageCoord2WordCoord",value:function(e,t){
t.x>0&&t.x<e.width&&t.y>0&&t.y<this.height&&(e.normalizedMouse.x=t.x/e.width*2-1,e.normalizedMouse.y=-t.y/this.height*2+1),this._isNormalizeMousePoint=!0;var i=new THREE.Vector3,n=e.normalizedMouse.clone();this.normalizedPointToWorld(n,e.naviData.getAxisGridBox2D());var r=e.normalizedMouse.clone();this.normalizedPointToScreen(r,{width:e._svgHalfWidth,height:e._svgHalfHeight});var a=this.getIntersectionToMinDistance(e.naviData.getAxisGridIntersectionPoints(),r);if(a&&a.intersectionPoint){var o=new THREE.Vector2(a.intersectionPoint.x,a.intersectionPoint.y);if(r.sub(o).lengthSq()<e._circleNodeRadius*e._circleNodeRadius){var s=o.clone(),l={width:e._svgHalfWidth,height:e._svgHalfHeight},c=e.naviData.getAxisGridBox2D();this.screenToNormalizedPoint(s,l),this.normalizedPointToWorld(s,c),i.set(s.x,s.y,e._cameraProjectedPosZ)}else i.set(n.x,n.y,e._cameraProjectedPosZ)}else i.set(n.x,n.y,e._cameraProjectedPosZ);return i}},{key:"getAxisGridInfoByNormalizedPoint",value:function(e,t){var i=t.clone(),n=e.naviData.getAxisGridBox2D();this.normalizedPointToWorld(i,n);var r=t.clone(),a={width:e._svgHalfWidth,height:e._svgHalfHeight};this.normalizedPointToScreen(r,a);var o=this.getIntersectionToMinDistance(e.naviData.getAxisGridIntersectionPoints(),r);if(o&&o.intersectionPoint){var s=new THREE.Vector2(o.intersectionPoint.x,o.intersectionPoint.y);this.screenToNormalizedPoint(s,a),this.normalizedPointToWorld(s,n);var l=Math.round(i.x-s.x),c=Math.round(i.y-s.y);return{position:i,abcName:o.abcName,numeralName:o.numeralName,offsetX:l,offsetY:c}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}}},{key:"getAxisGridInfoByPoint",value:function(e,t){var i=this.getMainSceneMatrix(),n=new THREE.Matrix4;n.getInverse(i);var r=t.clone();r.applyMatrix4(n);var a=r.clone(),o={width:e._svgHalfWidth,height:e._svgHalfHeight},s=e.naviData.getAxisGridBox2D();this.worldToNormalizedPoint(a,s),this.normalizedPointToScreen(a,o);var l=this.getIntersectionToMinDistance(e.naviData.getAxisGridIntersectionPoints(),a);if(l&&l.intersectionPoint){var c=new THREE.Vector2(l.intersectionPoint.x,l.intersectionPoint.y);this.screenToNormalizedPoint(c,o),this.normalizedPointToWorld(c,s);var u=Math.round(r.x-c.x),h=Math.round(r.y-c.y);return{position:r,abcName:l.abcName,numeralName:l.numeralName,offsetX:u,offsetY:h}}return{position:new THREE.Vector3,abcName:"",numeralName:"",offsetX:"",offsetY:""}}}]),e}();CLOUD.NaviAlgorithm=NaviAlgorithm;var NaviData=function(){function e(){_classCallCheck(this,e),this.axisGridData=null,this.floorPlanesData={},this.floorPlaneId=null,this.axisGridBox2D=new THREE.Box2,this.isShowAxisGrid=!1,this.axisGridIntersectionPoints=[],this.axisGridElements=[],this.floorPlaneUrl=null,this.elevationsInOrder=[],this.mapLevelIdElevation={},this.glodonColor="#11DAB7"}return _createClass(e,[{key:"getGlodonColor",value:function(){return this.glodonColor}},{key:"getFloorPlaneUrl",value:function(){return this.floorPlanesData[this.floorPlaneId].path}},{key:"hasFloorPlaneUrl",value:function(){return null!=this.floorPlanesData[this.floorPlaneId].path}},{key:"hasFloorPlaneBbox",value:function(){return null!=this.floorPlanesData[this.floorPlaneId].boundingBox}},{key:"getAxisGridIntersectionPoints",value:function(){return this.axisGridIntersectionPoints}},{key:"addAxisGridIntersectionPoint",value:function(e){this.axisGridIntersectionPoints.push(e)}},{key:"clearAxisGridIntersectionPoints",value:function(){this.axisGridIntersectionPoints=[]}},{key:"getAxisGridElements",value:function(){return this.axisGridElements}},{key:"addAxisGridElement",value:function(e){this.axisGridElements.push(e)}},{key:"clearAxisGridElement",value:function(){this.axisGridElements=[]}},{key:"setAxisGridData",value:function(e){this.axisGridData=e}},{key:"setFloorPlaneId",value:function(e){this.floorPlaneId=e}},{key:"getFloorPlaneId",value:function(){return this.floorPlaneId}},{key:"getFloorPlaneName",value:function(){if(this.floorPlaneId){var e=this.floorPlanesData[this.floorPlaneId];return e?e.name:null}}},{key:"setAllFloorPlaneData",value:function(e){this.floorPlanesData={};for(var t=0;e instanceof Array&&t<e.length;t++){var i=e[t];this.floorPlanesData[i.id]=i}}},{key:"getLevelIdByElevation",value:function(e){for(var t in this.mapLevelIdElevation)if(this.mapLevelIdElevation[t]==e)return t}},{key:"updateFloorPlane",value:function(e){var t=this.getElevationsInOrder(),i=this.mapLevelIdElevation[this.floorPlaneId],n=t.find(function(t){return t>e}),r=t.slice().reverse(),a=r.find(function(t){return t<e});if(void 0==a){var o=this.getLevelIdByElevation(n);return this.setFloorPlaneId(o),!0}if(void 0==n){var o=this.getLevelIdByElevation(a);return this.setFloorPlaneId(o),!0}if(i>=a&&i<n)return!1;var o=this.getLevelIdByElevation(a);return this.setFloorPlaneId(o),!0}},{key:"getAxisGridData",value:function(){return this.axisGridData}},{key:"getGrids",value:function(){if(this.axisGridData)return this.axisGridData.Grids}},{key:"getLevels",value:function(){if(this.axisGridData)return this.axisGridData.Levels}},{key:"createElevationsInOrder",value:function(){for(var e=[],t=this.getLevels(),i=0;i<t.length;i++){var n=t[i];n.hasOwnProperty("elevation")&&(e.push(n.elevation),this.mapLevelIdElevation[n.id]=n.elevation)}e.sort(function(e,t){return e-t}),this.elevationsInOrder=e}},{key:"getElevationsInOrder",value:function(){return 0==this.elevationsInOrder.length&&this.createElevationsInOrder(),this.elevationsInOrder}},{key:"getFloorPlaneData",value:function(){return this.floorPlanesData[this.floorPlaneId]}},{key:"calculateAxisGridBox",value:function(e,t,i){this.axisGridBox2D.makeEmpty();for(var n=this.getGrids(),r=0,a=n.length;r<a;r++){var o=n[r],s=o.start||o.Start,l=o.end||o.End,c=new THREE.Vector2(s.X,s.Y),u=new THREE.Vector2(l.X,l.Y);this.axisGridBox2D.expandByPoint(c),this.axisGridBox2D.expandByPoint(u)}var h=this.axisGridBox2D.getCenter(),d=this.axisGridBox2D.getSize(),f=new THREE.Vector2,p=e/t,m=d.x/d.y,g=d.x,v=d.y;m>p?(this.isShowAxisGrid&&(g=d.x*e/(e-4*(i+4))),v=g/p):m<p&&(this.isShowAxisGrid&&(v=d.y*t/(t-4*(i+4))),g=v*p),f.set(g,v),this.axisGridBox2D.setFromCenterAndSize(h,f)}},{key:"getAxisGridBox2D",value:function(){if(0==this.axisGridBox2D.getSize().length()){var e=this.floorPlanesData[this.floorPlaneId].BoundingBox;return(new THREE.Box2).set(new THREE.Vector2(e.Min.X,e.Min.Y),new THREE.Vector2(e.Max.X,e.Max.Y))}return this.axisGridBox2D}},{key:"setAxisGridState",value:function(e){this.isShowAxisGrid=!!e}},{key:"getAxisGridState",value:function(){return this.isShowAxisGrid}},{key:"getIntersectionByAxisGridNumber",value:function(e,t,i){for(var n=null,r=0,a=this.axisGridIntersectionPoints.length;r<a;r++){var o=this.axisGridIntersectionPoints[r].abcName.toLowerCase(),s=this.axisGridIntersectionPoints[r].numeralName;if(o===e.toLowerCase()&&s===t){n=this.axisGridIntersectionPoints[r];break}}return n}}]),e}();CLOUD.NaviData=NaviData;var NaviUI=function(){function e(t,i){_classCallCheck(this,e),this.mp=t,this.naviAlgorithm=i,this._materialGrid=new THREE.LineBasicMaterial({color:10066329,linewidth:.5}),this._xmlns="http://www.w3.org/2000/svg",this._quality=1,this._svgTextPool=[],this._axisGridNumberInterval=3,this._tipNodeColor="#000",this._tipNodeBackgroundColor="#fff",this._axisGridNumberFontSize=8,this._tipNode=null,this._enableShowCamera=!0,this._cameraNode=null,this._cameraArrowNode=null,this._cameraCircleNode=null,this._circleNode=null,this._highlightHorizLineNode=null,this._highlightVerticalLineNode=null,this.elevationsInOrder=[],this._epsilon=1e-5,this._lastCameraWorldPosition=null,this._isChangeView=!1,this._axisGridExpandSize=100,this._clipBox2D=new THREE.Box2,this._elemBox2D=new THREE.Box2,this._clearColor=new THREE.Color,this._clearAlpha=1,this.offsetForPlane=235,this._svgLinePool=[],this._svgImagePool=[],this._svgCirclePool=[],this._pathCount=0,this._textCount=0,this._imageCount=0,this._circleCount=0,this._lineCount=0,this._svg=null,this._svgGroupForAxisGrid=null,this._svgWidth=0,this._svgHeight=0,this._axisGridNumberCircleRadius=10,this._isLoadedAxisGrid=!1,this._isLoadedFloorPlane=!1,this.autoClear=!0,this.initialized=!1,this.axisGirds=null,this._defaultClearColor=3355443,this.visible=!0,this._floorPlaneUrl=null,this.domContainer=null}return _createClass(e,[{key:"loadStyleString",value:function(e){var t=document.createElement("style");t.type="text/css";try{t.appendChild(document.createTextNode(e))}catch(i){t.styleSheet.cssText=e}document.getElementsByTagName("head")[0].appendChild(t)}},{key:"getImageNode",value:function(e){return null==this._svgImagePool[e]?(this._svgImagePool[e]=document.createElementNS(this._xmlns,"image"),this._svgImagePool[e]):this._svgImagePool[e]}},{key:"getCircleNode",value:function(e){return null==this._svgCirclePool[e]?(this._svgCirclePool[e]=document.createElementNS(this._xmlns,"circle"),0==this._quality&&this._svgCirclePool[e].setAttribute("shape-rendering","crispEdges"),this._svgCirclePool[e]):this._svgCirclePool[e]}},{key:"getTextNode",value:function(e){return null==this._svgTextPool[e]?(this._svgTextPool[e]=document.createElementNS(this._xmlns,"text"),0==this._quality&&this._svgTextPool[e].setAttribute("shape-rendering","crispEdges"),this._svgTextPool[e]):this._svgTextPool[e]}},{key:"getLineNode",value:function(e){return null==this._svgLinePool[e]?(this._svgLinePool[e]=document.createElementNS(this._xmlns,"line"),0==this._quality&&this._svgLinePool[e].setAttribute("shape-rendering","crispEdges"),this._svgLinePool[e]):this._svgLinePool[e]}},{key:"renderLine",value:function(e,t,i){var n=this.getLineNode(this._lineCount++);n.setAttribute("x1",e.x),n.setAttribute("y1",e.y),n.setAttribute("x2",t.x),n.setAttribute("y2",t.y),i instanceof THREE.LineBasicMaterial&&(n.setAttribute("style","fill: none; stroke: "+i.color.getStyle()+"; stroke-width: "+i.linewidth+"; stroke-opacity: "+i.opacity+"; stroke-linecap: "+i.linecap+"; stroke-linejoin: "+i.linejoin),this._svgGroupForAxisGrid.appendChild(n))}},{key:"renderCircle",value:function(e,t,i){if("NaN"!=e.toString()&&"NaN"!=t.toString()){var n=this.getCircleNode(this._circleCount++);n.setAttribute("r",this._axisGridNumberCircleRadius+""),n.setAttribute("transform","translate("+e+","+t+")"),i instanceof THREE.LineBasicMaterial&&(n.setAttribute("style","fill: none; stroke: "+i.color.getStyle()+"; stroke-width: 1"),this._svgGroupForAxisGrid.appendChild(n))}}},{key:"renderText",value:function(e,t,i,n){if("NaN"!=e.toString()&&"NaN"!=t.toString()){var r=this.getTextNode(this._textCount++);n instanceof THREE.LineBasicMaterial&&(r.setAttribute("style","font-size:"+this._axisGridNumberFontSize+"px; fill: none; stroke: "+n.color.getStyle()+"; stroke-width: 1"),this._svgGroupForAxisGrid.appendChild(r)),r.innerHTML=i,r.textContent=i;var a=r.getBoundingClientRect(),o=e-.5*a.width,s=t+.25*a.height;r.setAttribute("transform","translate("+o+","+s+")")}}},{key:"renderFloorPlan",value:function(){if(this._isLoadedFloorPlane){var e=this.getImageNode(0);this._svg.appendChild(e)}}},{key:"renderHighlightNode",value:function(){this._circleNode&&this._svg.appendChild(this._circleNode),this._highlightHorizLineNode&&this._svg.appendChild(this._highlightHorizLineNode),this._highlightVerticalLineNode&&this._svg.appendChild(this._highlightVerticalLineNode)}},{key:"setContainerElementStyle",value:function(e,t){var i={position:"absolute",display:"block",left:"20px",bottom:"20px",outline:"#0000FF dotted thin"};t=t||i;for(var n in t)e.style[n]=t[n]}},{key:"remove",value:function(){this.mp._mapContainer&&this.mp._mapContainer.parentNode&&this.mp._mapContainer.parentNode.removeChild(this.mp._mapContainer)}},{key:"append",value:function(){this.mp._mapContainer&&!this.mp._mapContainer.parentNode&&(this.domContainer.appendChild(this.mp._mapContainer),this.render())}},{key:"createElevationsInOrder",value:function(){var e=this.mp.naviData.getAxisGridData(),t=e?e.Levels:null;this.elevationsInOrder=[];for(var i in t)void 0!=t[i].elevation&&this.elevationsInOrder.push(t[i].elevation);var n=function(e,t){return e-t};this.elevationsInOrder.sort(n)}},{key:"renderAxisGrid",value:function(){var e=this.mp.naviData.getAxisGridElements();this._svg.appendChild(this._svgGroupForAxisGrid);for(var t=0,i=e.length;t<i;t++)for(var n=e[t],r=0,a=n.length;r<a;r++){var o=n[r],s=o.v1.clone(),l=o.v2.clone(),c=o.material;if(this._elemBox2D.makeEmpty(),this._elemBox2D.setFromPoints([s,l]),!0===this._clipBox2D.intersectsBox(this._elemBox2D)&&(this.renderLine(s,l,c),r%this._axisGridNumberInterval==0)){var u=new THREE.Vector2;u.subVectors(l,s).normalize().multiplyScalar(this._axisGridNumberCircleRadius);var h=s.clone().sub(u),d=l.clone().add(u);this.renderCircle(h.x,h.y,c),this.renderCircle(d.x,d.y,c),this.renderText(h.x,h.y,o.name,c),this.renderText(d.x,d.y,o.name,c)}}}},{key:"initTipNode",value:function(){if(!this._tipNode){var e=".cloud-tip:after { box-sizing: border-box;display: inline;font-size: 10px;width: 100%;line-height: 1;color: "+this._tipNodeBackgroundColor+";content: '\\25BC';position: absolute;text-align: center;margin: -4px 0 0 0;top: 100%;left: 0;}";this.loadStyleString(e),this._tipNode=document.createElement("div"),this._tipNode.className="",this._tipNode.style.position="absolute",this._tipNode.style.display="block",this._tipNode.style.background=this._tipNodeBackgroundColor,this._tipNode.style.color=this._tipNodeColor,this._tipNode.style.padding="0 8px 0 8px",this._tipNode.style.borderRadius="2px",this._tipNode.style.fontSize="8px",this.mp._mapContainer.appendChild(this._tipNode)}this._tipNode.style.opacity=0,this._circleNode||(this._circleNode=document.createElementNS(this._xmlns,"circle"),this._circleNode.setAttribute("r",this.mp._circleNodeRadius+""),this._circleNode.setAttribute("fill",this.mp.naviData.getGlodonColor())),this._circleNode.style.opacity=0,this._highlightHorizLineNode||(this._highlightHorizLineNode=document.createElementNS(this._xmlns,"line"),this._highlightHorizLineNode.setAttribute("style","stroke:"+this.mp.naviData.getGlodonColor()+";stroke-width:"+this._highlightLineWidth)),this._highlightHorizLineNode.style.opacity=0,this._highlightVerticalLineNode||(this._highlightVerticalLineNode=document.createElementNS(this._xmlns,"line"),this._highlightVerticalLineNode.setAttribute("style","stroke:"+this.mp.naviData.getGlodonColor()+";stroke-width:"+this._highlightLineWidth)),this._highlightVerticalLineNode.style.opacity=0}},{key:"createTip",value:function(){this.initTipNode(),this.showTip()}},{key:"showTip",value:function(){this._tipNode&&(this._tipNode.className="cloud-tip",this._tipNode.style.opacity=1),this._circleNode&&(this._circleNode.style.opacity=1),this._highlightHorizLineNode&&(this._highlightHorizLineNode.style.opacity=1),this._highlightVerticalLineNode&&(this._highlightVerticalLineNode.style.opacity=1)}},{key:"hideTip",value:function(){this._tipNode&&(this._tipNode.className="",this._tipNode.style.opacity=0),this._circleNode&&(this._circleNode.style.opacity=0),this._highlightHorizLineNode&&(this._highlightHorizLineNode.style.opacity=0),this._highlightVerticalLineNode&&(this._highlightVerticalLineNode.style.opacity=0)}},{key:"destroyTip",value:function(){this._tipNode&&(this.mp._mapContainer.removeChild(this._tipNode),this._tipNode=null),this._circleNode&&this._circleNode.parentNode&&(this._svg.removeChild(this._circleNode),this._circleNode=null),this._highlightHorizLineNode&&this._highlightHorizLineNode.parentNode&&(this._svg.removeChild(this._highlightHorizLineNode),this._highlightHorizLineNode=null),this._highlightVerticalLineNode&&this._highlightVerticalLineNode.parentNode&&(this._svg.removeChild(this._highlightVerticalLineNode),this._highlightVerticalLineNode=null)}},{key:"setHighlightNode",value:function(e){this._circleNode.setAttribute("transform","translate("+e.intersectionPoint.x+","+e.intersectionPoint.y+")"),this._tipNode.innerHTML=e.numeralName+"-"+e.abcName;var t=this._tipNode.getBoundingClientRect();this._tipNode.style.left=this.mp._svgHalfWidth+e.intersectionPoint.x-.5*t.width+"px",this._tipNode.style.top=this.mp._svgHalfHeight+e.intersectionPoint.y-t.height-12+"px",this._highlightHorizLineNode.setAttribute("x1",e.horizLine[0].x),this._highlightHorizLineNode.setAttribute("y1",e.horizLine[0].y),this._highlightHorizLineNode.setAttribute("x2",e.horizLine[1].x),this._highlightHorizLineNode.setAttribute("y2",e.horizLine[1].y),this._highlightVerticalLineNode.setAttribute("x1",e.verticalLine[0].x),this._highlightVerticalLineNode.setAttribute("y1",e.verticalLine[0].y),this._highlightVerticalLineNode.setAttribute("x2",e.verticalLine[1].x),this._highlightVerticalLineNode.setAttribute("y2",e.verticalLine[1].y)}},{key:"clear",value:function(){for(this._pathCount=0,this._lineCount=0,this._textCount=0,this._imageCount=0,this._circleCount=0;this._svg.childNodes.length>0;){for(;this._svg.childNodes[0]>0;)this._svg.childNodes[0].removeChild(this._svg.childNodes[0].childNodes[0]);this._svg.removeChild(this._svg.childNodes[0])}this._svg.style.backgroundColor="rgba("+(255*this._clearColor.r|0)+","+(255*this._clearColor.g|0)+","+(255*this._clearColor.b|0)+","+this._clearAlpha+")",this._svg.style.position="absolute",this.mp._svgRect.style.backgroundColor="rgba("+(255*this._clearColor.r|0)+","+(255*this._clearColor.g|0)+","+(255*this._clearColor.b|0)+","+this._clearAlpha+")",this.mp._svgRect.style.position="absolute"}},{key:"setSize",value:function(e,t){this.mp._mapContainer&&(this.mp.width=e,this.mp.height=t,this.mp._mapContainer.style.width=e+"px",this.mp._mapContainer.style.height=t+"px",this._svgWidth=e,this._svgHeight=t,this.mp._svgHalfWidth=this._svgWidth/2,this.mp._svgHalfHeight=this._svgHeight/2,this._svg.setAttribute("viewBox",-this.mp._svgHalfWidth+" "+-this.mp._svgHalfHeight+" "+this._svgWidth+" "+this._svgHeight),this._svg.setAttribute("width",this._svgWidth),this._svg.setAttribute("height",this._svgHeight),this.mp._svgRect.setAttribute("viewBox",-this.mp._svgHalfWidth+" "+-this.mp._svgHalfHeight+" "+this._svgWidth+" "+this._svgHeight),this.mp._svgRect.setAttribute("width",this._svgWidth),this.mp._svgRect.setAttribute("height",this._svgHeight),this._clipBox2D.min.set(-this.mp._svgHalfWidth,-this.mp._svgHalfHeight),this._clipBox2D.max.set(this.mp._svgHalfWidth,this.mp._svgHalfHeight))}},{key:"setClearColor",value:function(e,t){this._clearColor.set(e),this._clearAlpha=void 0!==t?t:1}},{key:"initCanvasContainer",value:function(e,t){this.domContainer=e,this.mp._mapContainer||(this.mp._mapContainer=document.createElement("div"),this.setContainerElementStyle(this.mp._mapContainer,t),e.appendChild(this.mp._mapContainer),this.mp._mapContainer.appendChild(this._svg),this.mp._mapContainer.appendChild(this.mp._svgRect))}},{key:"initCameraNode",value:function(){if(!this._cameraNode){this._cameraNode=document.createElementNS(this._xmlns,"g"),this._cameraNode.setAttribute("fill",this.mp.naviData.getGlodonColor()),this._cameraNode.setAttribute("stroke","#cbd7e1"),this._cameraNode.setAttribute("stroke-width","1"),this._cameraNode.setAttribute("stroke-linejoin","round");var e=document.createElementNS(this._xmlns,"circle");e.setAttribute("r","6"),this._cameraCircleNode=e;var t=document.createElementNS(this._xmlns,"path");t.setAttribute("d","M 7 6 Q 10 0, 7 -6 L 19 0 Z"),this._cameraArrowNode=t,this._cameraNode.appendChild(e),this._cameraNode.appendChild(t)}this._cameraNode.setAttribute("opacity","0.0")}},{key:"addDomEventListeners",value:function(){this.mp._mapContainer&&(this.mp._mapContainer.addEventListener("contextmenu",this.mp.onContextMenuBinded,!1),this.mp._mapContainer.addEventListener("mousedown",this.mp.onMouseDownBinded,!1),this.mp._mapContainer.addEventListener("mousemove",this.mp.onMouseMoveBinded,!1)),document.addEventListener("mouseup",this.mp.onMouseUpBinded,!1)}},{key:"removeDomEventListeners",value:function(){this.mp._mapContainer&&(this.mp._mapContainer.removeEventListener("contextmenu",this.mp.onContextMenuBinded,!1),this.mp._mapContainer.removeEventListener("mousedown",this.mp.onMouseDownBinded,!1),this.mp._mapContainer.removeEventListener("mousemove",this.mp.onMouseMoveBinded,!1)),document.removeEventListener("mouseup",this.mp.onMouseUpBinded,!1)}},{key:"addDomEventListener",value:function(e,t,i){this.mp._mapContainer&&this.mp._mapContainer.addEventListener(e,t,i)}},{key:"removeDomEventListener",value:function(e,t,i){this.mp._mapContainer&&this.mp._mapContainer.removeEventListener(e,t,i)}},{key:"checkFloorPlaneBox",value:function(){this.mp._floorPlaneBox||(this.mp._floorPlaneBox=this.mp.viewer.getBoundingBoxWorld(),this.mp._cameraProjectedPosZ=.5*(this.mp._floorPlaneBox.min.z+this.mp._floorPlaneBox.max.z),this.mp._floorPlaneMinZ=this.mp._floorPlaneBox.min.z)}},{key:"calculateEdgePositionCameraOutBounds",value:function(e,t){var i=this.mp.naviData.getAxisGridBox2D(),n=function(e,t){for(var i=!1,n=0,r=e.length;n<r;n++)if(CLOUD.Extensions.Utils.Geometric.isEqualBetweenPoints(t,e[n],this._epsilon)){i=!0;break}return i},r=i.clone();if(r.min.x-=.5,r.min.y-=.5,r.max.x+=.5,r.max.y+=.5,!r.containsPoint(e)){var a=[],o=new THREE.Vector3(e.x,e.y,0),s=new THREE.Ray(o,t),l=new THREE.Vector3(i.min.x,i.min.y,0),c=new THREE.Vector3(-1,0,0),u=new THREE.Plane;u.setFromNormalAndCoplanarPoint(c,l);var h=s.intersectPlane(u);if(h&&r.containsPoint(h)&&a.push(h),l.set(i.max.x,i.max.y,0),c.set(-1,0,0),u.setFromNormalAndCoplanarPoint(c,l),h=s.intersectPlane(u),h&&r.containsPoint(h)&&a.push(h),l.set(i.min.x,i.min.y,0),c.set(0,1,0),u.setFromNormalAndCoplanarPoint(c,l),h=s.intersectPlane(u),h&&r.containsPoint(h)&&(n(h,a)||a.push(h)),l.set(i.max.x,i.max.y,0),c.set(0,1,0),u.setFromNormalAndCoplanarPoint(c,l),h=s.intersectPlane(u),h&&r.containsPoint(h)&&(n(h,a)||a.push(h)),2!=a.length)return null;var d=a[0],f=a[1],p=f.clone().sub(d).normalize();return CLOUD.Extensions.Utils.Geometric.isEqualBetweenPoints(p,t,this._epsilon)?a[0]:a[1]}return null}},{key:"calculateCameraPosition",value:function(){this.checkFloorPlaneBox();var e=this.mp.viewer.camera,t=this.mp.viewer.cameraControl;if(e&&t){var i=e.position,n=e.target,r=this.naviAlgorithm.getMainSceneMatrix(this.mp.viewer),a=new THREE.Matrix4;a.getInverse(r);var o=this.mp._floorPlaneBox.getCenter(),s=new THREE.Vector3(this.mp._floorPlaneBox.min.x,this.mp._floorPlaneBox.min.y,o.z).applyMatrix4(r),l=new THREE.Vector3(this.mp._floorPlaneBox.min.x,this.mp._floorPlaneBox.max.y,o.z).applyMatrix4(r),c=new THREE.Vector3(this.mp._floorPlaneBox.max.x,this.mp._floorPlaneBox.min.y,o.z).applyMatrix4(r),u=new THREE.Plane;u.setFromCoplanarPoints(s,l,c);var h=u.projectPoint(i);h.applyMatrix4(a);var d=u.projectPoint(n);d.applyMatrix4(a);var f=d.clone().sub(h);f.z=0,f.normalize();var p=i.clone();p.applyMatrix4(a);var m=p.clone(),g={width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight},v=this.mp.naviData.getAxisGridBox2D();if(this.naviAlgorithm.worldToNormalizedPoint(m,v),this.naviAlgorithm.normalizedPointToScreen(m,g),this._cameraNode.setAttribute("opacity","1.0"),f.length()<this._epsilon)this._cameraArrowNode.setAttribute("opacity","0.0"),this._cameraNode.setAttribute("transform","translate("+m.x+","+m.y+")");else{var y=new THREE.Vector3(0,0,1),E=new THREE.Vector3(1,0,0),x=this.naviAlgorithm.isAngleGreaterThanPi(E,f,y),b=THREE.Math.radToDeg(E.angleTo(f));x||(b*=-1);var C=this.calculateEdgePositionCameraOutBounds(h,f);if(C){var M=new THREE.Vector2(C.x,C.y),g={width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight},v=this.mp.naviData.getAxisGridBox2D();this.naviAlgorithm.worldToNormalizedPoint(M,v),this.naviAlgorithm.normalizedPointToScreen(M,g),this._cameraArrowNode.setAttribute("opacity","1.0"),this._cameraCircleNode.setAttribute("opacity","0.0"),this._cameraNode.setAttribute("transform","translate("+M.x+","+M.y+") rotate("+b+")")}else this._cameraArrowNode.setAttribute("opacity","1.0"),this._cameraCircleNode.setAttribute("opacity","1.0"),this._cameraNode.setAttribute("transform","translate("+m.x+","+m.y+") rotate("+b+")")}this.setCallbackCameraInfo(p,m),this._lastCameraWorldPosition=p.clone();return{worldPosition:p,projectedWorldPosition:new THREE.Vector3(h.x,h.y,this.mp._cameraProjectedPosZ),screenPosition:m}}}},{key:"render",value:function(){this.autoClear&&this.clear(),this.visible&&(this.renderFloorPlan(),this.mp.naviData.getAxisGridState()&&(this.renderAxisGrid(),this.renderHighlightNode()),this.calculateCameraPosition(),this._enableShowCamera&&this._svg.appendChild(this._cameraNode))}},{key:"getIntersectionByNormalizedPoint",value:function(e){for(var t=null,i=this.mp._circleNodeRadius*this.mp._circleNodeRadius,n=this.mp.naviData.getAxisGridIntersectionPoints(),r=0,a=n.length;r<a;r++){var o=n[r].intersectionPoint;if(o){var s=new THREE.Vector2(e.x,e.y);this.naviAlgorithm.normalizedPointToScreen(s,{width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight});if(o.distanceToSquared(s)<i){t=n[r];break}}}return t}},{key:"highlightedNode",value:function(e,t,i){var n=this.mp.naviData;if(this.mp._hasHighlightInterPoint=!1,e&&t){var r;if(i){var a=this.mp.normalizedMouse.clone();this.naviAlgorithm.normalizedPointToScreen(a,{width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight}),r=this.naviAlgorithm.getIntersectionToMinDistance(n.getAxisGridIntersectionPoints(),a)}else r=this.getIntersectionByNormalizedPoint(this.mp.normalizedMouse);if(r?(this.mp._hasHighlightInterPoint=!0,this.createTip(),this.setHighlightNode(r)):this.destroyTip(),this.render(),this.mp.callbackClickOnAxisGrid){var o=this.naviAlgorithm.getAxisGridInfoByNormalizedPoint(this.mp,this.mp.normalizedMouse);this.mp.callbackClickOnAxisGrid(o)}}else this.destroyTip(),this.render()}},{key:"adjustAxisGrid",value:function(e,t){if(this.axisGirdNotExsist)return null;var i=new THREE.Box2,n=[],r=new THREE.Box2(new THREE.Vector2(t[0],t[1]),new THREE.Vector2(t[2],t[3])),a=[],o=[],s=0,l=0,c=e.length;for(s=0;s<c;s++){var u=e[s],h=u.start||u.Start,d=u.end||u.End,f=new THREE.Vector2(h.X,h.Y),p=new THREE.Vector2(d.X,d.Y),m=p.clone().sub(f).normalize();Math.abs(m.x)>=Math.abs(m.y)?a.push({v1:f,v2:p}):o.push({v1:f,v2:p})}var g,v,y,E,x,b,C=a.length,M=o.length;for(s=0;s<C;s++)for(g=a[s],y=g.v1.clone(),E=g.v2.clone(),l=0;l<M;l++){v=o[l],x=v.v1.clone(),b=v.v2.clone();var _=naviAlgorithm.getInterPoint(y,E,x,b);i.expandByPoint(_)}for(i.union(r),i.expandByScalar(this._axisGridExpandSize),s=0;s<c;s++){var u=e[s],w=u.name||u.Name,h=u.start||u.Start,d=u.end||u.End,f=new THREE.Vector2(h.X,h.Y),p=new THREE.Vector2(d.X,d.Y),m=p.clone().sub(f).normalize();Math.abs(m.x)>=Math.abs(m.y)?(f.x=i.max.x,p.x=i.min.x,n.push({name:w,start:{X:f.x,Y:f.y},end:{X:p.x,Y:p.y}})):(f.y=i.min.y,p.y=i.max.y,n.push({name:w,start:{X:f.x,Y:f.y},end:{X:p.x,Y:p.y}}))}return n}},{key:"initFloorPlane",value:function(){var e=new THREE.Box2(new THREE.Vector2(this.mp._floorPlaneBox.min.x,this.mp._floorPlaneBox.min.y),new THREE.Vector2(this.mp._floorPlaneBox.max.x,this.mp._floorPlaneBox.max.y)),t=this.mp.naviData.getAxisGridBox2D(),i=this._svgWidth/this._svgHeight,n=t.getSize();n.x/n.y!=i&&(this.naviAlgorithm.expandBbox(t,i),n=t.getSize());var r=t.getCenter(),a=e.getSize(),o=e.getCenter(),s=this._svgWidth/n.x,l=a.x*s,c=a.y*s,u=o.clone().sub(r);u.x*=s,u.y*=-s,t.containsBox(e)||console.warn("the bounding-box of axis-grid is not contains the bounding-box of floor-plane!");var h=this.getImageNode(0);h.href.baseVal=this._floorPlaneUrl,h.setAttribute("id","Floor-"+this._imageCount),h.setAttribute("preserveAspectRatio","none"),h.setAttribute("width",l+""),h.setAttribute("height",c+""),h.setAttribute("x",-.5*l+""),h.setAttribute("y",-.5*c+""),h.setAttribute("transform","translate("+u.x+","+u.y+")")}},{key:"generateAxisGrid",value:function(e){void 0==e&&(e=!0);var t=this.mp.naviData.getAxisGridData();if(t.hasOwnProperty("Grids")){t.Grids.length<1&&(console.warn("axis grid data not exist."),this.axisGirdNotExsist=!0),this._isLoadedAxisGrid=!0;var i,n=t.mapMaxBox;i=e&&n?this.adjustAxisGrid(t.Grids,n):t.Grids,this.axisGirds=i,!this.axisGirdNotExsist&&this.initAxisGird(i),!this.axisGirdNotExsist&&this._isLoadedFloorPlane?(console.log("re-initialize floor plane!!!"),this.initFloorPlane(),this._isChangeView?this.mp.fly():this.render()):this.render()}}},{key:"generateFloorPlane",value:function(e){void 0===e&&(e=!1),this._isChangeView=e;var t=this.mp.naviData.getFloorPlaneData(),i=this.mp.naviData.getAxisGridData();if(t){var n=t.Path||t.path,r=t.BoundingBox||t.boundingBox,a=t.Elevation||t.elevation;if(!n||!r)return void console.warn("floor-plan data is error!");this._floorPlaneUrl=n;var o=t.name||t.Name,s=r.Min.Z,l=r.Max.Z,c=i?i.Levels:null;for(var u in c)if(c[u].name==o){s=c[u].elevation,s-=this.offsetForPlane;break}this.createElevationsInOrder();for(var h=0;h<this.elevationsInOrder.length;h++)if(this.elevationsInOrder[h]>s+this.offsetForPlane){l=this.elevationsInOrder[h],l-=this.offsetForPlane;break}this.mp._floorPlaneBox=new THREE.Box3(new THREE.Vector3(r.Min.X,r.Min.Y,s),new THREE.Vector3(r.Max.X,r.Max.Y,l)),this.mp._cameraProjectedPosZ=s+1750,this.mp._floorPlaneMinZ=a||s,this._isLoadedFloorPlane=!0,this._isLoadedAxisGrid||console.warn("axis-grid is not initialized!"),this.initFloorPlane(),this._isChangeView?this.mp.fly():this.render()}}},{key:"calculateAxisGridIntersection",value:function(e){var t=this.mp.naviData;t.clearAxisGridElement(),t.clearAxisGridIntersectionPoints();var i=[],n=[],r=0,a=0,o=e.length;for(r=0;r<o;r++){var s=e[r],l=s.name||s.Name,c=s.start||s.Start,u=s.end||s.End,h=new THREE.Vector2(c.X,c.Y),d=new THREE.Vector2(u.X,u.Y),f={width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight},p=t.getAxisGridBox2D();this.naviAlgorithm.worldToNormalizedPoint(h,p),this.naviAlgorithm.normalizedPointToScreen(h,f),this.naviAlgorithm.worldToNormalizedPoint(d,p),this.naviAlgorithm.normalizedPointToScreen(d,f);var m=d.clone().sub(h).normalize();Math.abs(m.x)>=Math.abs(m.y)?i.push({name:l,v1:h,v2:d,material:this._materialGrid}):n.push({name:l,v1:h,v2:d,material:this._materialGrid})}t.addAxisGridElement(i),t.addAxisGridElement(n);var g,v,y,E,x,b,C,M,_=i.length,w=n.length;for(r=0;r<_;r++)for(g=i[r],E=g.name,x=g.v1.clone(),b=g.v2.clone(),a=0;a<w;a++){v=n[a],y=v.name,C=v.v1.clone(),M=v.v2.clone();var L=!1;C.x<=Math.max(x.x,b.x)&&C.x>=Math.min(x.x,b.x)&&x.y<=Math.max(C.y,M.y)&&x.y>=Math.min(C.y,M.y)&&(L=!0);var T=null;L&&(T=this.naviAlgorithm.getInterPoint(x,b,C,M)),t.addAxisGridIntersectionPoint({intersectionPoint:T,horizLine:[x.clone(),b.clone()],verticalLine:[C.clone(),M.clone()],abcName:E,numeralName:y})}}},{key:"highlightedNodeByClientPoint",value:function(e,t){var i=new THREE.Vector2(e,t),n=this.naviAlgorithm.isMouseOverCanvas(this.mp,i);return this.highlightedNode(n,this.mp.naviData.getAxisGridState(),!1),!0}},{key:"locateByClientPoint",value:function(e,t){var i=this.mp.naviData,n=new THREE.Vector2(e,t),r=this.naviAlgorithm.isMouseOverCanvas(this.mp,n),a=this._isLoadedAxisGrid||this._isLoadedFloorPlane;if(!this.mp._enableFlyByClick)return this.highlightedNode(r,i.getAxisGridState(),!0),!1;if(r&&a){var o=new THREE.Vector3,s=this.mp.normalizedMouse.clone();this.naviAlgorithm.normalizedPointToWorld(s,i.getAxisGridBox2D());var l=this.mp.normalizedMouse.clone();this.naviAlgorithm.normalizedPointToScreen(l,{width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight});var c=this.naviAlgorithm.getIntersectionToMinDistance(i.getAxisGridIntersectionPoints(),l);if(c&&c.intersectionPoint){var u=new THREE.Vector2(c.intersectionPoint.x,c.intersectionPoint.y);if(l.sub(u).lengthSq()<this.mp._circleNodeRadius*this.mp._circleNodeRadius){var h=u.clone(),d={width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight},f=i.getAxisGridBox2D();this.naviAlgorithm.screenToNormalizedPoint(h,d),this.naviAlgorithm.normalizedPointToWorld(h,f),o.set(h.x,h.y,this.mp._cameraProjectedPosZ)}else o.set(s.x,s.y,this.mp._cameraProjectedPosZ)}else o.set(s.x,s.y,this.mp._cameraProjectedPosZ);var p=o.clone();"default"==this.mp.mapClickMode?(this.mp.callbackMapClick&&this.mp.callbackMapClick(p),this.naviAlgorithm.transformWorldPoint(this.mp.viewer,o),
this.naviAlgorithm.flyToPointWithParallelEye(this.mp.viewer,o)):"static"==this.mp.mapClickMode&&this.mp.callbackMapClick&&this.mp.callbackMapClick(p)}return!0}},{key:"setCallbackCameraInfo",value:function(e,t){var i=this.mp.naviData,n=!0;if(this._lastCameraWorldPosition&&(n=0!==e.distanceToSquared(this._lastCameraWorldPosition)),this.mp.callbackCameraChanged&&n){var r=e.clone(),a=this.naviAlgorithm.getIntersectionToMinDistance(i.getAxisGridIntersectionPoints(),t);if(a&&a.intersectionPoint){var o=new THREE.Vector2(a.intersectionPoint.x,a.intersectionPoint.y),s={width:this.mp._svgHalfWidth,height:this.mp._svgHalfHeight},l=i.getAxisGridBox2D();this.naviAlgorithm.screenToNormalizedPoint(o,s),this.naviAlgorithm.normalizedPointToWorld(o,l);var c=Math.round(e.x-o.x),u=Math.round(e.y-o.y),h=Math.round(e.z-this.mp._floorPlaneMinZ),d="X("+a.numeralName+","+c+")",f="Y("+a.abcName+","+u+")",p=!0,m=e.clone();m.setZ(this.mp._cameraProjectedPosZ),this.naviAlgorithm.containsPointInMainScene(this.mp.viewer,m)||(p=!1,d="",f="");var g={position:r,isInScene:p,axis:{abcName:a.abcName,numeralName:a.numeralName,offsetX:c,offsetY:u,offsetZ:h,infoX:d,infoY:f}};this.mp.callbackCameraChanged(g)}else{var g={position:r,isInScene:!1,axis:{abcName:"",numeralName:"",offsetX:"",offsetY:"",offsetZ:"",infoX:"",infoY:""}};this.mp.callbackCameraChanged(g)}}}},{key:"highlightNodeByAxisGridNumber",value:function(e,t){var i=this.mp.naviData.getIntersectionByAxisGridNumber(e,t,this.mp);i?(this.setHighlightNode(i),this.createTip()):this.destroyTip(),this.render()}},{key:"initAxisGird",value:function(e){this.mp.naviData.calculateAxisGridBox(this._svgWidth,this._svgHeight,this._axisGridNumberCircleRadius),this.calculateAxisGridIntersection(e)}},{key:"showAxisGird",value:function(){this._isLoadedAxisGrid&&(this.mp.naviData.setAxisGridState(!0),this.resizeClientAxisGrid(),this._svgGroupForAxisGrid.style.display="",this.mp._hasHighlightInterPoint&&this.createTip(),this.render())}},{key:"hideAxisGird",value:function(){this._isLoadedAxisGrid&&(this.mp.naviData.setAxisGridState(!1),this.resizeClientAxisGrid(),this._svgGroupForAxisGrid.style.display="none",this.destroyTip(),this.render())}},{key:"resizeClientAxisGrid",value:function(){var e=this.axisGirds||this.mp.naviData.getGrids();this.initAxisGird(e),this._isLoadedFloorPlane&&this.initFloorPlane()}},{key:"init",value:function(e,t,i,n,r){if(t=t||320,i=i||240,r=r||0,this._svg||(this._svg=document.createElementNS(this._xmlns,"svg"),this.mp._svgRect=document.createElementNS(this._xmlns,"svg"),this._svgGroupForAxisGrid=document.createElementNS(this._xmlns,"g")),this.initCanvasContainer(e,n),this.initTipNode(),this.initCameraNode(),this.setSize(t,i),this.setClearColor(this._defaultClearColor,r),this.clear(),this.addDomEventListeners(),this.mp._hasHighlightInterPoint=!1,this.mp.callbackClickOnAxisGrid){var a={position:"",abcName:"",numeralName:"",offsetX:"",offsetY:""};this.mp.callbackClickOnAxisGrid(a)}this.initialized=!0}},{key:"uninit",value:function(){this.initialized&&(this.initialized=!1,this.removeDomEventListeners(),this.clear(),this._svg.parentNode&&this._svg.parentNode.removeChild(this._svg),this.remove(),this.mp._mapContainer=null,this._svg=null,this._svgGroupForAxisGrid=null,this.domContainer=null,this.mp.callbackCameraChanged=null,this.mp.callbackClickOnAxisGrid=null,this.axisGirds=null)}},{key:"resize",value:function(e,t){this.mp._mapContainer&&(this.setSize(e,t),this._isLoadedAxisGrid&&this.resizeClientAxisGrid(),this.initFloorPlane(),this.mp.naviData.getAxisGridState()?this._svgGroupForAxisGrid.style.display="":this._svgGroupForAxisGrid.style.display="none",this.destroyTip(),this.render())}}]),e}();CLOUD.NaviUI=NaviUI;var NaviAction=function(){function e(t){_classCallCheck(this,e),this.mp=t,this.svgRect=null,this.rectForMinimapId="RectForMinimap",this.bEditMode=!1,this.bMouseDown=!1,this.rectangle=[],this.currentGripId=-1,this.lastHighlightGripId=-1,this.bFirstMouseClick=!0,this.lastMousePoint=new THREE.Vector2}return _createClass(e,[{key:"getMouseClickState",value:function(){return this.bFirstMouseClick}},{key:"setMouseClickState",value:function(e){this.bFirstMouseClick=!!e}},{key:"getCurrentGripId",value:function(){return this.currentGripId}},{key:"setCurrentGripId",value:function(e){this.currentGripId=e}},{key:"getRectangleInfo",value:function(){var e=Math.abs(this.rectangle[2]-this.rectangle[0]),t=Math.abs(this.rectangle[3]-this.rectangle[1]);return{x:this.rectangle[0],y:this.rectangle[1],width:e,height:t}}},{key:"setLastMousePoint",value:function(e,t){this.lastMousePoint.x=e,this.lastMousePoint.y=t}},{key:"equalWithLastPoint",value:function(e,t){return this.lastMousePoint.x===e&&this.lastMousePoint.y===t}},{key:"getRectangle",value:function(){return this.rectangle}},{key:"addPointToRectangle",value:function(e,t){"number"==typeof e&&this.rectangle.push(e),"number"==typeof t&&this.rectangle.push(t)}},{key:"pointsCount",value:function(){return this.rectangle.length/2}},{key:"pointValidation",value:function(e,t){e<this.rectangle[0]?(this.rectangle.push(this.rectangle[0]),this.rectangle[0]=e):this.rectangle.push(e),t<this.rectangle[1]?(this.rectangle.push(this.rectangle[1]),this.rectangle[1]=t):this.rectangle.push(t)}},{key:"getMouseState",value:function(){return this.bMouseDown}},{key:"setMouseState",value:function(e){this.bMouseDown=!!e}},{key:"getEditMode",value:function(){return this.bEditMode}},{key:"setEditMode",value:function(e){this.bEditMode=!!e}},{key:"createSvgRect",value:function(e){if(this.mp.naviData.getAxisGridState()){this.svgRect||(this.svgRect=CLOUD.Extensions.Utils.Shape2D.createSvgElement("rect"),this.svgRect.setAttribute("id",this.rectForMinimapId),this.svgRect.setAttribute("stroke-width",2),this.svgRect.style.position="absolute",this.svgRect.style.fillOpacity="0.4",this.svgRect.style.fill=this.mp.naviData.getGlodonColor(),this.svgRect.style.display="block",this.svgRect.style.stroke=this.mp.naviData.getGlodonColor(),this.svgRect.style.strokeWidth="2");var t=Math.abs(e.x-this.rectangle[0]),i=Math.abs(e.y-this.rectangle[1]),n=this.mp._svgRect,r=n.clientWidth,a=n.clientHeight;this.mp.transformRect=["translate(",e.x-r/2,",",e.y-a/2,") ","rotate(",0,") "].join(""),this.svgRect.setAttribute("transform",this.mp.transformRect),this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",i+""),n.appendChild(this.svgRect)}}},{key:"updateSvgRect",value:function(e){if(this.mp.naviData.getAxisGridState()){var t=Math.abs(e.x-this.rectangle[0]),i=Math.abs(e.y-this.rectangle[1]),n={x:this.rectangle[0],y:this.rectangle[1]};if(e.x<n.x||e.y<n.y){e.x<n.x&&(n.x=e.x),e.y<n.y&&(n.y=e.y);var r=["translate(",n.x-this.mp._svgRect.clientWidth/2,",",n.y-this.mp._svgRect.clientHeight/2,") ","rotate(",0,") "].join("");this.svgRect.setAttribute("transform",r)}this.svgRect.setAttribute("width",t+""),this.svgRect.setAttribute("height",i+"")}}},{key:"resetSvgRect",value:function(){if(this.mp.naviData.getAxisGridState()){var e=Math.abs(this.rectangle[0]-this.rectangle[2]),t=Math.abs(this.rectangle[1]-this.rectangle[3]);this.svgRect.setAttribute("width",e+""),this.svgRect.setAttribute("height",t+"");var i=this.mp._svgRect,n=i.clientWidth,r=i.clientHeight;this.mp.transformRect=["translate(",this.rectangle[0]-n/2,",",this.rectangle[1]-r/2,") ","rotate(",0,") "].join(""),this.svgRect.setAttribute("transform",this.mp.transformRect)}}},{key:"clearRectangle",value:function(){this.rectangle=[]}},{key:"adjustRectangle",value:function(e,t,i){if(t[0]>=i[0])switch(e){case 0:case 1:case 2:t[0]=i[0];break;case 4:case 5:case 6:i[0]=t[0]}if(t[1]>=i[1])switch(e){case 2:case 3:case 4:i[1]=t[1];break;case 6:case 7:case 0:t[1]=i[1]}return t.concat(i)}},{key:"gripDragging",value:function(e,t){var i=this.rectangle,n=t.x-e.x,r=t.y-e.y,a=[i[0],i[1]],o=[i[2],i[3]];switch(this.currentGripId){case 0:a[0]+=n,a[1]+=r;break;case 1:a[0]+=n;break;case 2:a[0]+=n,o[1]+=r;break;case 3:o[1]+=r;break;case 4:o[0]+=n,o[1]+=r;break;case 5:o[0]+=n;break;case 6:a[1]+=r,o[0]+=n;break;case 7:a[1]+=r;break;default:console.log("default grip id."+this.currentGripId)}o[0]=o[0]>this.mp.width?this.mp.width:o[0],o[1]=o[1]>this.mp.height?this.mp.height:o[1],this.rectangle=this.adjustRectangle(this.currentGripId,a,o)}},{key:"hightlightGrip",value:function(e){if(this.mp.naviData.getAxisGridState()){var t={x:e.offsetX,y:e.offsetY},i=this.hitGrips(t,this.rectangle);if(i!=this.lastHighlightGripId&&this.currentGripId<0&&this.lastHighlightGripId>=0){var n=document.getElementById(this.rectForMinimapId+"-"+this.lastHighlightGripId);n.style.stroke=this.mp.naviData.getGlodonColor()}if(this.currentGripId>=0||i>=0){this.currentGripId>=0&&(i=this.currentGripId);var n=document.getElementById(this.rectForMinimapId+"-"+i);n.style.stroke="#f5a623",this.currentGripId<0&&(this.lastHighlightGripId=i)}}}},{key:"drawGrips",value:function(){if(this.mp.naviData.getAxisGridState())for(var e=this.getGrips(this.rectangle),t=0;t<e.length;t+=2){var i=this.createGrip(t/2,this.mp.naviData.getGlodonColor());this.currentGripId==t/2&&(i=this.createGrip(t/2,"#f5a623")),this.mp._svgRect.appendChild(i)}}},{key:"createGrip",value:function(e,t){var i=this.getGrips(),n=this.rectForMinimapId+"-"+e,r=document.getElementById(n);r&&r.parentNode.removeChild(r);var a=CLOUD.Extensions.Utils.Shape2D.createSvgElement("circle"),o=this.mp._svgRect.clientWidth,s=this.mp._svgRect.clientHeight,l=["translate(",i[2*e]-o/2,",",i[2*e+1]-s/2,") ","rotate(",0,") "].join("");return a.setAttribute("id",n),a.setAttribute("transform",l),a.setAttribute("r",3),a.style.position="absolute",a.style.display="block",a.style.fill="#ffffff",a.style.stroke=t||"#4784cb",a.style.strokeWidth="1",a}},{key:"removeGrips",value:function(){for(var e=0;e<8;e++){var t=document.getElementById(this.rectForMinimapId+"-"+e);t&&t.parentNode.removeChild(t)}}},{key:"removeSvgRect",value:function(){var e=document.getElementById(this.rectForMinimapId);e&&e.parentNode.removeChild(e)}},{key:"destroyAll",value:function(){this.removeGrips(),this.removeSvgRect(),this.clearRectangle()}},{key:"getGrips",value:function(){var e={x:this.rectangle[0],y:this.rectangle[1]},t={x:this.rectangle[2],y:this.rectangle[3]},i={x:(e.x+t.x)/2,y:(e.y+t.y)/2},n=[];return n.push(e.x,e.y),n.push(e.x,i.y),n.push(e.x,t.y),n.push(i.x,t.y),n.push(t.x,t.y),n.push(t.x,i.y),n.push(t.x,e.y),n.push(i.x,e.y),n}},{key:"hitGrips",value:function(e){for(var t=this.getGrips(),i=0;i<t.length;i+=2){var n=[t[i],t[i+1]];if(this.isPointInCircle(e,n,6))return i/2}return-1}},{key:"isPointInCircle",value:function(e,t,i){var n=e.x-t[0],r=e.y-t[1];return Math.sqrt(n*n+r*r)<=i}}]),e}();CLOUD.NaviAction=NaviAction,CLOUD.MiniMap=function(e){this.viewer=e,this.sceneMatrixInverse=null,this.width=0,this.height=0,this.callbackCameraChanged=null,this.callbackMapClick=null,this.miniMapCallbacks={},this.mapClickMode="default",this.callbackClickOnAxisGrid=null,this.miniMapCallbackHandler={};var t=this;this._mapContainer=null,this.normalizedMouse=new THREE.Vector2,this._svgHalfWidth=0,this._svgHalfHeight=0,this._enableFlyByClick=!0,this._circleNodeRadius=3,this._hasHighlightInterPoint=!1,this._floorPlaneMinZ=0,this._cameraProjectedPosZ=0,this._floorPlaneBox=null,this.naviData=new CLOUD.NaviData;var i=new CLOUD.NaviAlgorithm,n=new CLOUD.NaviUI(this,i),r=new CLOUD.NaviAction(this),a=function(i){var n=i.cameraPosition;if(!t.sceneMatrixInverse){var r=e.getScene().getMatrixGlobal();t.sceneMatrixInverse=(new THREE.Matrix4).getInverse(r)}var a=n.clone().applyMatrix4(t.sceneMatrixInverse);if(t.naviData.getAxisGridBox2D().containsPoint(new THREE.Vector2(a.x,a.y))&&t.naviData.updateFloorPlane(a.z)){t.generateFloorPlane(!1);var o=t.getFloorPlaneName();o&&(t.miniMapCallbackHandler.onCallbacks("FloorPlaneChanged",o),console.log("Current floor plane is "+o))}};this.getFloorPlaneName=function(){return this.naviData.getFloorPlaneName()},this.setAxisGridData=function(e){this.naviData.setAxisGridData(e)},this.setAllFloorPlaneData=function(e){this.naviData.setAllFloorPlaneData(e)},this.setFloorPlaneId=function(e){this.naviData.setFloorPlaneId(e)},this.enableMouseEvent=function(e){this._enableFlyByClick=e},this.isEnableMouseEvent=function(){return t._enableFlyByClick},this.getCuttingBox=function(e,t){return i.getCuttingBox(e,t,this)},this.getCuttingBoxOnCanvas=function(e,t){return i.getCuttingBoxOnCanvas(e,t,this)},this.highlightedNodeByClientPoint=function(e,t){return n.highlightedNodeByClientPoint(e,t)},this.locateByClientPoint=function(e,t){return n.locateByClientPoint(e,t)},this.addDomEventListener=function(e,t,i){n.addDomEventListener(e,t,i)},this.removeDomEventListener=function(e,t,i){n.removeDomEventListener(e,t,i)},this.getBoundingBoxIsolate=function(){var e=r.getRectangle(),t={x:e[0],y:e[1]},n={x:e[2],y:e[3]};return t=i.canvasPointToClient(t,this),n=i.canvasPointToClient(n,this),i.getCuttingBox(t,n,this)},this.onMouseDown=function(e){if(r.setMouseState(!0),r.setLastMousePoint(e.clientX,e.clientY),0==r.pointsCount()){var t={x:e.offsetX,y:e.offsetY};r.addPointToRectangle(e.offsetX,e.offsetY),r.createSvgRect(t)}if(2==r.pointsCount()){var i={x:e.offsetX,y:e.offsetY};r.hitGrips(i)>=0&&r.setEditMode(!0)}this.naviData.getAxisGridState()&&this.miniMapCallbackHandler.onCallbacks("MouseDown")},this.onMouseMove=function(e){if(2==r.pointsCount()&&r.hightlightGrip(e),r.getEditMode()||r.getMouseState()?r.getEditMode()&&n.destroyTip():n.highlightedNodeByClientPoint(e.clientX,e.clientY,!1),r.getMouseState()){if(r.pointsCount()<2&&r.updateSvgRect({x:e.offsetX,y:e.offsetY}),r.getEditMode()){var t={x:e.offsetX,y:e.offsetY},i=r.hitGrips(t);if(r.getMouseClickState())return this.firstPos=t,r.setMouseClickState(!1),void(i>=0&&r.setCurrentGripId(i));var a=t;r.getCurrentGripId()>=0&&(r.gripDragging(this.firstPos,a),r.resetSvgRect(),r.removeGrips(),r.drawGrips()),this.firstPos=a}this.naviData.getAxisGridState()&&this.miniMapCallbackHandler.onCallbacks("MouseMove")}},this.onMouseUp=function(e){if(r.getMouseState()){if(r.setMouseState(!1),r.setMouseClickState(!0),r.setCurrentGripId(-1),r.equalWithLastPoint(e.clientX,e.clientY))return n.locateByClientPoint(e.clientX,e.clientY),void(1==r.pointsCount()&&r.clearRectangle());if(1==r.pointsCount()){var t=e.offsetX>this.width?this.width:e.offsetX,i=e.offsetY>this.height?this.height:e.offsetY;r.pointValidation(t,i),r.drawGrips()}r.setEditMode(!1),this.naviData.getAxisGridState()&&this.miniMapCallbackHandler.onCallbacks("MouseUp",r.getRectangleInfo())}},this.destroyAll=function(){r.destroyAll()},this.getMiniMapCallbackHandler=function(){return this.miniMapCallbackHandler},this.miniMapCallbackHandler={miniMapCallbacks:{},addCallbacks:function(e,t){var i=this.miniMapCallbacks[e];i||(i=[],this.miniMapCallbacks[e]=i),-1===i.indexOf(t)&&i.push(t)},removeCallbacks:function(e,t){var i=this.miniMapCallbacks[e];if(i){var n=i.indexOf(t);-1!==n&&i.splice(n,1)}},onCallbacks:function(e,t){var i=this.miniMapCallbacks[e];if(i)for(var n=0;n<i.length;n++)i[n]&&i[n](t)},addMouseDownCallback:function(e){this.addCallbacks("MouseDown",e)},addMouseMoveCallback:function(e){this.addCallbacks("MouseMove",e)},addMouseUpCallback:function(e){this.addCallbacks("MouseUp",e)},removeMouseDownCallback:function(e){this.removeCallbacks("MouseDown",e)},removeMouseMoveCallback:function(e){this.removeCallbacks("MouseMove",e)},removeMouseUpCallback:function(e){this.removeCallbacks("MouseUp",e)}},this.onContextMenu=function(e){e.preventDefault()},this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onContextMenuBinded=this.onContextMenu.bind(this),this.init=function(e,t,i,r,o){n.init(e,t,i,r,o),this.viewer.registerEventListener(CLOUD.EVENTS.ON_CAMERA_HEIGHT_CHANGED,a)},this.uninit=function(){n.uninit(),this.viewer.unregisterEventListener(CLOUD.EVENTS.ON_CAMERA_HEIGHT_CHANGED,a)},this.remove=function(){n.remove()},this.append=function(){n.append()},this.generateAxisGrid=function(e){n.generateAxisGrid(e)},this.initAxisGird=function(e){n.initAxisGird(e)},this.setPlaneChangedCallback=function(e){this.callbackPlaneChanged=e},this.generateFloorPlane=function(e){if(n.generateFloorPlane(e),this.callbackPlaneChanged){var t=this.getFloorPlaneName();this.callbackPlaneChanged(t)}},this.getMapContainer=function(){return this._mapContainer},this.resizeClientAxisGrid=function(){n.resizeClientAxisGrid()},this.showAxisGird=function(){n.showAxisGird()},this.hideAxisGird=function(){n.hideAxisGird()},this.render=function(){n.render()},this.highlightNodeByAxisGridNumber=function(e,t){n.highlightNodeByAxisGridNumber(e,t)},this.getAxisGridInfoByPoint=function(e){i.getAxisGridInfoByPoint(this,e)},this.fly=function(){var e=n.calculateCameraPosition(),t=e.projectedWorldPosition.clone();i.transformWorldPoint(this.viewer,t),i.flyToPointWithParallelEye(this.viewer,t)},this.flyByAxisGridNumber=function(e,r){var a=this.naviData.getIntersectionByAxisGridNumber(e,r,this);if(a){n.checkFloorPlaneBox();var o=new THREE.Vector3(a.intersectionPoint.x,a.intersectionPoint.y,t._cameraProjectedPosZ),s={width:t._svgHalfWidth,height:t._svgHalfHeight},l=this.naviData.getAxisGridBox2D();return i.screenToNormalizedPoint(o,s),i.normalizedPointToWorld(o,l),i.transformWorldPoint(this.viewer,o),i.flyToPointWithParallelEye(this.viewer,o),!0}return!1},this.getAxisGridBox2D=function(){return this.naviData.getAxisGridBox2D()},this.setCameraChangedCallback=function(e){this.callbackCameraChanged=e},this.setMapClickCallback=function(e){this.callbackMapClick=e},this.setMapClickMode=function(e){this.mapClickMode=e},this.setClickOnAxisGridCallback=function(e){this.callbackClickOnAxisGrid=e},this.setMinimapResizeCallback=function(e){this.callbackMinimapResize=e},this.resize=function(e,t){n.resize(e,t),this.callbackMinimapResize&&this.callbackMinimapResize({width:e,height:t})}};var ViewAdapter=function(){function e(){_classCallCheck(this,e),this.domContainer=null,this.cameraControl=null,this.scene=null,this.name=""}return _createClass(e,[{key:"getName",value:function(){return this.name}},{key:"setDomContainer",value:function(e){this.domContainer=e}},{key:"getDomContainer",value:function(){return this.domContainer}},{key:"worldToClient",value:function(e){}},{key:"clientToWorld",value:function(e){var t=this.getDomContainerBounds(),i=this.cameraControl.camera,n=new THREE.Vector3;n.x=e.x/t.width*2-1,n.y=-e.y/t.height*2+1,n.z=0,n.unproject(i);var r=this.getInverseSceneMatrix();return n.applyMatrix4(r),n}},{key:"getSceneMatrix",value:function(){return this.scene.getMatrixGlobal()}},{key:"getInverseSceneMatrix",value:function(){var e=this.getSceneMatrix(),t=new THREE.Matrix4;return t.getInverse(e),t}},{key:"clientToViewport",value:function(e){var t=this.getDomContainerBounds(),i=new THREE.Vector3;return i.x=e.x/t.width*2-1,i.y=-e.y/t.height*2+1,i.z=0,i}},{key:"getDomContainerBounds",value:function(e){return CLOUD.DomUtil2D.getContainerOffsetToClient(e||this.domContainer)}}]),e}();CLOUD.ViewAdapter=ViewAdapter;var View2dAdapter=function(e){function t(e,i){_classCallCheck(this,t);var n=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return n.name="VIEW2D",n.minimap=e,n.domContainer=e.getMapContainer(),n.cameraControl=i.cameraControl,n.scene=i.getScene(),n.initialDomSize=n.getDomContainerBounds(),n.naviAlgorithm=new CLOUD.NaviAlgorithm,n}return _inherits(t,e),_createClass(t,[{key:"getInitialDomSize",value:function(){return this.initialDomSize}},{key:"getMinimap",value:function(){return this.minimap}},{key:"worldToClient",value:function(e){var t=new THREE.Vector3(e.x,e.y,e.z),i=this.minimap.getAxisGridBox2D();this.naviAlgorithm.worldToNormalizedPoint(t,i);var n=this.getDomContainerBounds(),r={width:n.width/2,height:n.height/2};return this.naviAlgorithm.normalizedPointToScreen(t,r),t.x+=r.width,t.y+=r.height,t}}]),t}(CLOUD.ViewAdapter);CLOUD.View2dAdapter=View2dAdapter;var View3dAdapter=function(e){function t(e){_classCallCheck(this,t);var i=_possibleConstructorReturn(this,(t.__proto__||Object.getPrototypeOf(t)).call(this));return i.name="VIEW3D",i.domContainer=e.domElement,i.cameraControl=e.cameraControl,i.scene=e.getScene(),i}return _inherits(t,e),_createClass(t,[{key:"worldToClient",value:function(e){var t=this.getDomContainerBounds(),i=this.cameraControl.camera,n=this.getSceneMatrix(),r=new THREE.Vector3(e.x,e.y,e.z);return r.applyMatrix4(n),r.project(i),Math.abs(r.z)>1?null:(r.x=Math.round(.5*(r.x+1)*t.width),r.y=Math.round(-.5*(r.y-1)*t.height),r.z=0,r)}}]),t}(CLOUD.ViewAdapter);CLOUD.View3dAdapter=View3dAdapter,CLOUD.Extensions.Marker=function(e,t){this.id=e,this.editor=t,this.position=new THREE.Vector3,this.boundingBox=new THREE.Box3,this.shape=null,this.style=CLOUD.Extensions.Marker.getDefaultStyle(),this.selected=!1,this.highlighted=!1,this.highlightColor="#000088",this.isDisableInteractions=!1,this.ratioW=1,this.ratioH=1,this.keys={BACKSPACE:8,ALT:18,ESC:27,LEFT:37,UP:38,RIGHT:39,BOTTOM:40,DELETE:46,ZERO:48,A:65,D:68,E:69,Q:81,S:83,W:87,PLUS:187,SUB:189},this.onMouseDownBinded=this.onMouseDown.bind(this),this.onKeyUpBinded=this.onKeyUp.bind(this)},CLOUD.Extensions.Marker.prototype={constructor:CLOUD.Extensions.Marker,addDomEventListeners:function(){this.shape.addEventListener("mousedown",this.onMouseDownBinded,!0),this.shape.addEventListener("touchstart",this.onMouseDownBinded,!0),window.addEventListener("keyup",this.onKeyUpBinded)},removeDomEventListeners:function(){this.shape.removeEventListener("mousedown",this.onMouseDownBinded,!0),this.shape.removeEventListener("touchstart",this.onMouseDownBinded,!0),window.removeEventListener("keyup",this.onKeyUpBinded)},onMouseDown:function(e){e.preventDefault(),e.stopPropagation(),this.select()},onKeyUp:function(e){switch(e.keyCode){case this.keys.DELETE:this.editor.deselectMarker(),this.delete()}},createShape:function(){},destroy:function(){this.removeDomEventListeners(),this.deselect(),this.setParent(null)},set:function(e,t,i,n){this.userId=e,this.position.set(t.x,t.y,t.z),this.boundingBox=i&&i.clone(),n&&(this.style=CLOUD.DomUtil2D.cloneStyle(n)),this.update()},setRatio:function(e,t){this.ratioW=e,this.ratioH=t},setParent:function(e){var t=this.shape;t&&(t.parentNode&&t.parentNode.removeChild(t),e&&e.appendChild(t))},setStyle:function(e){this.style=CLOUD.DomUtil2D.cloneStyle(e),this.update()},select:function(){this.selected||(this.selected=!0,this.highlight(!0)),this.editor.selectMarker(this)},deselect:function(){this.highlight(!1),this.selected=!1},highlight:function(e){this.isDisableInteractions||(this.highlighted=e,this.update())},disableInteractions:function(e){this.isDisableInteractions=e},delete:function(){this.editor.deleteMarker(this)},getClientPosition:function(){return this.editor.getAdapter().worldToClient(this.position)},getBoundingBox:function(){return this.boundingBox},toNewObject:function(){return{id:this.id,userId:this.userId,shapeType:this.shapeType,cx:this.cx,cy:this.cy,position:this.position?this.position.clone():null,boundingBox:this.boundingBox?this.boundingBox.clone():null}},show:function(){this.shape.style.display="block"},hide:function(){this.shape.style.display="none"},update:function(){var e=this.style["stroke-width"],t=this.highlighted?this.highlightColor:this.style["stroke-color"],i=this.style["stroke-opacity"],n=this.style["fill-color"],r=this.style["fill-opacity"],a=this.getClientPosition();if(!a)return void(this.shape.style.display="none");var o=a.x,s=a.y;if(2==this.shapeType)var l=["translate(",o-.5*this.pictureSize.width,",",s-.5*this.pictureSize.height,") "].join("");else var l=["translate(",o,",",s,") "].join("");this.cx=o,this.cy=s,this.shape.setAttribute("transform",l),this.shape.setAttribute("stroke-width",e),this.shape.setAttribute("stroke",t),this.shape.setAttribute("stroke-opacity",i),this.shape.setAttribute("fill",n),this.shape.setAttribute("fill-opacity",r)}},CLOUD.Extensions.Marker.shapeTypes={BUBBLE:0,FLAG:1,COMMON:2},CLOUD.Extensions.Marker.getDefaultStyle=function(){var e={};return e["stroke-width"]=2,e["stroke-color"]="#fffaff",e["stroke-opacity"]=1,e["fill-color"]="#ff2129",e["fill-opacity"]=1,e},CLOUD.Extensions.MarkerBubble=function(e,t){CLOUD.Extensions.Marker.call(this,e,t),this.shapeType=CLOUD.Extensions.Marker.shapeTypes.BUBBLE,this.createShape(),this.addDomEventListeners()},CLOUD.Extensions.MarkerBubble.prototype=Object.create(CLOUD.Extensions.Marker.prototype),CLOUD.Extensions.MarkerBubble.prototype.constructor=CLOUD.Extensions.MarkerBubble,CLOUD.Extensions.MarkerBubble.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeBubble()},CLOUD.Extensions.MarkerFlag=function(e,t){CLOUD.Extensions.Marker.call(this,e,t),this.shapeType=CLOUD.Extensions.Marker.shapeTypes.FLAG,this.createShape(),this.addDomEventListeners()},CLOUD.Extensions.MarkerFlag.prototype=Object.create(CLOUD.Extensions.Marker.prototype),CLOUD.Extensions.MarkerFlag.prototype.constructor=CLOUD.Extensions.MarkerFlag,CLOUD.Extensions.MarkerFlag.prototype.createShape=function(){this.shape=CLOUD.Extensions.Utils.Shape2D.makeFlag()},CLOUD.Extensions.MarkerCommon=function(e,t,i,n){CLOUD.Extensions.Marker.call(this,e,t),this.shapeType=CLOUD.Extensions.Marker.shapeTypes.COMMON,this.pictureSize=n||{width:20,height:20},this.createShape(i),this.addDomEventListeners()},CLOUD.Extensions.MarkerCommon.prototype=Object.create(CLOUD.Extensions.Marker.prototype),CLOUD.Extensions.MarkerCommon.prototype.constructor=CLOUD.Extensions.MarkerCommon,CLOUD.Extensions.MarkerCommon.prototype.createShape=function(e){this.shape=CLOUD.Extensions.Utils.Shape2D.makeCommon(e,this.pictureSize)},CLOUD.Extensions.MarkerCommon.prototype.reset=function(){var e=this.pictureSize.width*this.ratioW,t=this.pictureSize.height*this.ratioH;this.shape.setAttribute("width",e.toString()+"px"),this.shape.setAttribute("height",t.toString()+"px")},CLOUD.Extensions.MarkerEditor=function(e){this.adapter=e,this.markers=[],this.mapGroupMarkers={},this.groups=null,this.selectedMarker=null,this.flagColors={red:"#ff2129",green:"#85af03",yellow:"#fe9829"},this.bubbleColors={red:"#f92a24",green:"#86b507",gray:"#ff9326"},this.nextMarkerId=0,this.initialized=!1,this.markerClickCallback=null},CLOUD.Extensions.MarkerEditor.prototype.getAdapter=function(){return this.adapter},CLOUD.Extensions.MarkerEditor.prototype.updateDomContainer=function(){var e=this.adapter.getDomContainer();this.adapter.setDomContainer(e)},CLOUD.Extensions.MarkerEditor.prototype.getMarkers=function(){return this.markers},CLOUD.Extensions.MarkerEditor.prototype.getMarkersByGroupName=function(e){return this.mapGroupMarkers.hasOwnProperty(e)?this.mapGroupMarkers[e]:[]},CLOUD.Extensions.MarkerEditor.prototype.addMarkerToGroup=function(e,t){this.mapGroupMarkers.hasOwnProperty(t)||(this.mapGroupMarkers[t]=[]),this.mapGroupMarkers[t].push(e)},CLOUD.Extensions.MarkerEditor.prototype.setMarkerGroups=function(e){this.groups=e},CLOUD.Extensions.MarkerEditor.prototype.removeMarkerInGroup=function(e,t){for(var i=this.mapGroupMarkers[t],n=0,r=i.length;n<r;n++)if(i[n].userId==e)return i.splice(n,1),void this.updateByGroup()},CLOUD.Extensions.MarkerEditor.prototype.removeMarker=function(e){for(var t=this.markers,i=0,n=t.length;i<n;i++)if(t[i].userId==e)return t[i].destroy(),void t.splice(i,1)},CLOUD.Extensions.MarkerEditor.prototype.clearMarkers=function(){this.unloadMarkers(!0),this.markers=[],this.mapGroupMarkers={}},CLOUD.Extensions.MarkerEditor.prototype.setVisible=function(e,t){var i=this.mapGroupMarkers;for(var n in i){var r=i[n];if(r instanceof Array){var a=r.getObjectByAttribute("id",e);a&&(!0===t?a.show():a.hide())}}},CLOUD.Extensions.MarkerEditor.prototype.updateByGroup=function(e){var t=e||this.groupName;this.unloadMarkers();var i=this.mapGroupMarkers[t];if(i instanceof Array)for(var n=0,r=i.length;n<r;n++)i[n]&&i[n].setParent(this.svgGroup)},CLOUD.Extensions.MarkerEditor.prototype.resize=function(e){var t=this.adapter.getInitialDomSize(),i=this.mapGroupMarkers[this.groupName];if(i instanceof Array){for(var n=0,r=i.length;n<r;n++){var a=i[n],o=e.width/t.width,s=e.height/t.height;a.setRatio(o,s),a.reset(),a.update()}e.width==t.width&&e.height==t.height||(t=e),this.svg.setAttribute("width",e.width+""),this.svg.setAttribute("height",e.height+"")}},CLOUD.Extensions.MarkerEditor.prototype.setGroupName=function(e){this.groupName=e},CLOUD.Extensions.MarkerEditor.prototype.updateGroupName=function(){var e=this.adapter.getMinimap();e&&(this.groupName=e.getFloorPlaneName())},CLOUD.Extensions.MarkerEditor.prototype.onResize=function(){if(this.svg){var e=this.adapter.getDomContainerBounds();this.svg.setAttribute("width",e.width+""),this.svg.setAttribute("height",e.height+""),this.updateMarkers()}},CLOUD.Extensions.MarkerEditor.prototype.init=function(){if(!this.svg){var e=this.adapter.getDomContainerBounds(),t=e.width,i=e.height;this.svg=CLOUD.Extensions.Utils.Shape2D.createSvgElement("svg"),this.svg.style.position="absolute",this.svg.style.display="block",this.svg.style.position="absolute",this.svg.style.display="block",this.svg.style.left="0",this.svg.style.top="0",this.svg.setAttribute("width",t+""),this.svg.setAttribute("height",i+"");this.adapter.getDomContainer().appendChild(this.svg),this.svgGroup=CLOUD.Extensions.Utils.Shape2D.createSvgElement("g"),this.svg.insertBefore(this.svgGroup,this.svg.firstChild)}this.initialized=!0},CLOUD.Extensions.MarkerEditor.prototype.uninit=function(){this.initialized=!1,this.svg&&(this.unloadMarkers(),this.svgGroup&&this.svgGroup.parentNode&&this.svgGroup.parentNode.removeChild(this.svgGroup),this.svg.parentNode&&this.svg.parentNode.removeChild(this.svg),this.svgGroup=null,this.svg=null,this.markerClickCallback=null)},CLOUD.Extensions.MarkerEditor.prototype.isInitialized=function(){return this.initialized},CLOUD.Extensions.MarkerEditor.prototype.generateMarkerId=function(){return++this.nextMarkerId,this.nextMarkerId.toString(10)},CLOUD.Extensions.MarkerEditor.prototype.clear=function(e){var t=this.markers;if(1==e)for(;t.length;){var i=t[0];this.deleteMarker(i)}var n=this.svgGroup;if(n&&n.childNodes.length>0)for(;n.childNodes.length;)n.removeChild(n.childNodes[0])},CLOUD.Extensions.MarkerEditor.prototype.addMarker=function(e){if("VIEW3D"==this.adapter.getName()&&e.setParent(this.svgGroup),this.markers.push(e),this.groups)for(var t=0,i=this.groups.length;t<i;t++)this.addMarkerToGroup(e,this.groups[t]);this.groupName&&this.updateByGroup(this.groupName)},CLOUD.Extensions.MarkerEditor.prototype.deleteMarker=function(e){if(e){this.removeMarker(e.userId);var t=this.mapGroupMarkers;for(var i in t)this.removeMarkerInGroup(e.userId,i);t&&this.updateByGroup()}},CLOUD.Extensions.MarkerEditor.prototype.selectMarker=function(e){if(!0===this.isDisableInteractions)return void(this.markerClickCallback&&this.markerClickCallback(e.toNewObject()));this.selectedMarker!==e?(this.deselectMarker(),this.selectedMarker=e):this.deselectMarker(),this.markerClickCallback&&(this.selectedMarker?this.markerClickCallback(this.selectedMarker.toNewObject()):this.markerClickCallback(null))},CLOUD.Extensions.MarkerEditor.prototype.deselectMarker=function(){this.selectedMarker&&(this.selectedMarker.deselect(),this.selectedMarker=null)},CLOUD.Extensions.MarkerEditor.prototype.enableSVGPaint=function(e){e?this.svg&&this.svg.setAttribute("pointer-events","painted"):this.svg&&this.svg.setAttribute("pointer-events","none")},CLOUD.Extensions.MarkerEditor.prototype.getMarkerColor=function(e,t){var i=this.bubbleColors.red;switch(e<0&&e>1&&(e=0),t>2&&(t-=3),t<0&&t>2&&(t=0),t){case 0:i=0===e?this.bubbleColors.red:this.flagColors.red;break;case 1:i=0===e?this.bubbleColors.green:this.flagColors.green;break;case 2:i=0===e?this.bubbleColors.gray:this.flagColors.yellow}return i},CLOUD.Extensions.MarkerEditor.prototype.createMarkerByIntersect=function(e,t,i,n){var r=e.id||this.generateMarkerId(),a=e.userId,o=e.worldPosition||e.object.point,s=e.worldBoundingBox||e.object&&e.object.boundingBox,l={size:n,id:r,userId:a,position:o,boundingBox:s,shapeType:t,state:i}
;this.createMarker(l)},CLOUD.Extensions.MarkerEditor.prototype.createMarker=function(e){if(e){var t=CLOUD.Extensions.Marker.getDefaultStyle();t["fill-color"]=this.getMarkerColor(e.shapeType,e.state);var i,n=e.id||this.generateMarkerId(),r=CLOUD.Extensions.Marker.shapeTypes;switch(e.shapeType){case r.BUBBLE:i=new CLOUD.Extensions.MarkerBubble(n,this);break;case r.COMMON:i=new CLOUD.Extensions.MarkerCommon(n,this,e.state,e.size);break;case r.FLAG:default:i=new CLOUD.Extensions.MarkerFlag(n,this)}this.isDisableInteractions&&i.disableInteractions(!0),i.set(e.userId,e.position,e.boundingBox,t),this.addMarker(i)}},CLOUD.Extensions.MarkerEditor.prototype.disableInteractions=function(e){this.isDisableInteractions=e},CLOUD.Extensions.MarkerEditor.prototype.getMarkersBoundingBox=function(){if(this.markers.length<1)return null;for(var e=new THREE.Box3,t=0,i=this.markers.length;t<i;t++){var n=this.markers[t];n.getBoundingBox()&&e.union(n.getBoundingBox())}return e},CLOUD.Extensions.MarkerEditor.prototype.getMarkerInfoList=function(){for(var e=[],t=0,i=this.markers.length;t<i;t++){var n=this.markers[t],r=n.userId+"_"+t,a={id:n.id||r,userId:n.userId,shapeType:n.shapeType,position:n.position,boundingBox:n.boundingBox,state:n.state};e.push(a)}return e},CLOUD.Extensions.MarkerEditor.prototype.loadMarkers=function(e){this.clear();for(var t=0,i=e.length;t<i;t++){var n=e[t],r=n.userId+"_"+t,a=n.id||r,o=n.userId,s=n.shapeType,l=n.state,c=n.position,u=new THREE.Box3;u.max.x=n.boundingBox.max.x,u.max.y=n.boundingBox.max.y,u.max.z=n.boundingBox.max.z,u.min.x=n.boundingBox.min.x,u.min.y=n.boundingBox.min.y,u.min.z=n.boundingBox.min.z;var h={id:a,userId:o,position:c,boundingBox:u,shapeType:s,state:l};this.createMarker(h)}},CLOUD.Extensions.MarkerEditor.prototype.loadMarkersFromIntersect=function(e,t,i){this.clear(),this.createMarkerByIntersect(e,t,i)},CLOUD.Extensions.MarkerEditor.prototype.unloadMarkers=function(e){this.clear(e)},CLOUD.Extensions.MarkerEditor.prototype.updateMarkers=function(){for(var e=0,t=this.markers.length;e<t;e++){this.markers[e].update()}},CLOUD.Extensions.MarkerEditor.prototype.getMarker=function(e){for(var t=this.markers,i=t.length,n=0;n<i;++n)if(t[n].userId==e)return t[n];return null},CLOUD.Extensions.MarkerEditor.prototype.getMarkerByUserId=function(e){for(var t=this.markers,i=t.length,n=0;n<i;++n)if(t[n].userId==e)return t[n];return null},CLOUD.Extensions.MarkerEditor.prototype.setMarkerClickCallback=function(e){this.markerClickCallback=e},CLOUD.Extensions.Icon=function(e,t,i,n,r,a){this.options={iconUrl:e,iconSize:t||[40,40],iconAnchor:i||[20,20],shadowUrl:n,shadowSize:r||[41,41],shadowAnchor:a||[20,20]}},CLOUD.Extensions.Icon.prototype={constructor:CLOUD.Extensions.Icon,initialize:function(e){CLOUD.MarkerUtil.setOptions(this,e)},createIcon:function(e){return this._createIcon("icon",e)},createShadow:function(e){return this._createIcon("shadow",e)},_createIcon:function(e,t){var i=this._getIconUrl(e);if(!i){if("icon"===e)throw new Error("iconUrl not set in Icon options, please set the iconUrl.");return null}var n=this._createImg(i,t&&"IMG"===t.tagName?t:null);return this._setIconStyles(n,e),n},_setIconStyles:function(e,t){var i=this.options,n=i[t+"Size"];"number"==typeof n&&(n=[n,n]);var r=n,a="shadow"===t&&i.shadowAnchor||i.iconAnchor||r&&[r[0]/2,r[1]/2];e.style.position="absolute",a&&(e.style.marginLeft=-a[0]+"px",e.style.marginTop=-a[1]+"px"),r&&(e.style.width=r[0]+"px",e.style.height=r[1]+"px")},_createImg:function(e,t){return t=t||document.createElement("img"),t.src=e,t},_getIconUrl:function(e){return this.options[e+"Url"]}},CLOUD.Extensions.NumIcon=function(e,t,i,n,r){this.options={iconSize:e||[40,40],iconAnchor:t||[20,20],fontSize:i||e[1]/2,fontColor:"white",fontWeight:"normal",opacity:r||.8,textAlign:"center",textShadow:"0 1px rgba(0, 0, 0, 0.2)",background:n||"#e23442",border:"1px solid #911f28",borderRadius:"11px",backgroundImage:"-webkit-linear-gradient(top, #e8616c, #dd202f)"}},CLOUD.Extensions.NumIcon.prototype={constructor:CLOUD.Extensions.NumIcon,initialize:function(e){CLOUD.MarkerUtil.setOptions(this,e)},createIcon:function(e){return this._createIcon(e)},_createIcon:function(e){var t=this._createSpan(e&&"SPAN"===e.tagName?e:null);return this._setIconStyles(t),t},_setIconStyles:function(e){var t=this.options;e.style.width=t.iconSize[0].toString()+"px",e.style.height=e.style.lineHeight=t.iconSize[1].toString()+"px";var i=t.iconSize,n=t.iconAnchor||i&&[i[0]/2,i[1]/2];n&&(e.style.marginLeft=-n[0]+"px",e.style.marginTop=-n[1]+"px"),e.style.fontSize=t.fontSize.toString()+"px",e.style.color=t.fontColor,e.style.fontWeight=t.fontWeight,e.style.opacity=t.opacity,e.style.textAlign=t.textAlign,e.style.textShadow=t.textShadow,e.style.background=t.background,e.style.border=t.border,e.style.borderRadius=t.borderRadius,e.style.backgroundImage=t.backgroundImage},_createSpan:function(e){return e=e||document.createElement("span"),e.style.position="absolute",e}},CLOUD.Extensions.MarkerEx=function(e){this.options={icon:e,title:"",zIndexOffset:0,opacity:1,riseOnHover:!0,riseOffset:250,pane:"markerPane"},this.position={},this.uuid="",this.clickCallback=null,this.mouseDownFun=this.onMouseDown.bind(this),this.mouseUpFun=this.onMouseUp.bind(this),this.mouseOverFun=this.onMouseOver.bind(this),this.mouseOutFun=this.onMouseOut.bind(this),this.touchEndFun=this.onTouchEnd.bind(this)},CLOUD.Extensions.MarkerEx.prototype={constructor:CLOUD.Extensions.MarkerEx,initialize:function(e,t){CLOUD.MarkerUtil.setOptions(this,t),this.position.x=e.x,this.position.y=e.y,this.position.z=e.z},onAdd:function(){this._initIcon(),this.update()},onRemove:function(){this._removeIcon(),this._removeShadow()},setZIndexOffset:function(e){return this.options.zIndexOffset=e,this.update()},setIcon:function(e){return this.options.icon=e,this._initIcon(),this.update(),this},getElement:function(){return this._icon},getPos:function(){return this._pos},update:function(){if(this._icon){var e=CLOUD.MarkerUtil.transformPosition(this.position);this._setPos(e)}return this},display:function(e){this._icon&&(this._icon.style.display=e?"":"none")},onMouseDown:function(e){e.preventDefault(),e.stopPropagation(),this.event=e},onMouseUp:function(e){e.preventDefault(),e.stopPropagation(),this.event.clientX==e.clientX&&this.event.clientY==e.clientY&&null!=this.clickCallback&&this.clickCallback(e,this)},onTouchEnd:function(e){e.preventDefault(),e.stopPropagation(),this.event.pageX==e.pageX&&this.event.pageY==e.pageY&&null!=this.clickCallback&&this.clickCallback(this.event,this)},onMouseOver:function(e){this._bringToFront(),this.setOpacity(.5*this.options.opacity)},onMouseOut:function(e){this._resetZIndex(),this.setOpacity(2*this.options.opacity)},setClickCallback:function(e){this._icon&&(this.clickCallback=e)},_initIcon:function(){var e=this.options,t=e.icon.createIcon(this._icon),i=!1;t!==this._icon&&(this._icon&&this._removeIcon(),i=!0),this._icon=t,e.riseOnHover&&(this._icon.addEventListener("mouseover",this.mouseOverFun),this._icon.addEventListener("mouseout",this.mouseOutFun));var n=e.icon.createShadow(this._shadow),r=!1;n!==this._shadow&&(this._removeShadow(),r=!0),this._shadow=n,e.opacity<1&&this._updateOpacity(),void 0==CLOUD.MarkerUtil.mainPane&&(CLOUD.MarkerUtil.mainPane=CLOUD.MarkerUtil.createPane("main")),i&&CLOUD.MarkerUtil.getPane(this.options.pane,CLOUD.MarkerUtil.mainPane).appendChild(this._icon),n&&r&&CLOUD.MarkerUtil.getPane("shadowPane",CLOUD.MarkerUtil.mainPane).appendChild(this._shadow),this._icon.addEventListener("mousedown",this.mouseDownFun,!1),this._icon.addEventListener("mouseup",this.mouseUpFun,!1),this._icon.addEventListener("touchstart",this.mouseDownFun,!1),this._icon.addEventListener("touchend",this.touchEndFun,!1)},_removeIcon:function(){this._icon&&(this.options.riseOnHover&&(this._icon.removeEventListener("mouseover",this.mouseOverFun),this._icon.removeEventListener("mouseout",this.mouseOutFun)),this._icon.removeEventListener("mousedown",this.mouseDownFun,!1),this._icon.removeEventListener("mouseup",this.mouseUpFun,!1),this._icon.removeEventListener("touchstart",this.mouseDownFun,!1),this._icon.removeEventListener("touchend",this.touchEndFun,!1),CLOUD.DomUtil2D.remove(this._icon),this._icon=null)},_removeShadow:function(){this._shadow&&CLOUD.DomUtil2D.remove(this._shadow),this._shadow=null},_setPos:function(e){this._pos=e,CLOUD.DomUtil2D.setPosition(this._icon,e),this._shadow&&CLOUD.DomUtil2D.setPosition(this._shadow,e),this._zIndex=e.y+this.options.zIndexOffset,this._resetZIndex()},_updateZIndex:function(e){this._icon.style.zIndex=this._zIndex+e},setOpacity:function(e){return this.options.opacity=e,this._icon&&this._updateOpacity(),this},_updateOpacity:function(){var e=this.options.opacity;CLOUD.DomUtil2D.setOpacity(this._icon,e),this._shadow&&CLOUD.DomUtil2D.setOpacity(this._shadow,e)},_bringToFront:function(){this._updateZIndex(this.options.riseOffset)},_resetZIndex:function(){this._updateZIndex(0)}},CLOUD.Extensions.Layer=function(){CLOUD.Extensions.MarkerEx.call(this),this.markerList=[]},CLOUD.Extensions.Layer.prototype=Object.create(CLOUD.Extensions.MarkerEx.prototype),CLOUD.Extensions.Layer.prototype.constructor=CLOUD.Extensions.Layer,CLOUD.Extensions.Layer.prototype.addMarker=function(e){if(this.markerList.push(e),1!=this.markerList.length)this.addPosition(e.position),this.update();else{var e=this.markerList[0];this.initialize(e.position,e.options),this.onAdd()}this._icon.title=this.markerList.length.toString()},CLOUD.Extensions.Layer.prototype.addLayer=function(e){this.markerList=this.markerList.concat(e.markerList),this.markerList.length!=e.markerList.length?(this.addPosition(e.position),this.update()):(this.initialize(e.position,e.options),this.onAdd()),this._icon.title=this.markerList.length.toString()},CLOUD.Extensions.Layer.prototype.addPosition=function(e){this.position.x+=e.x,this.position.y+=e.y,this.position.z+=e.z,this.position.x*=.5,this.position.y*=.5,this.position.z*=.5},CLOUD.Extensions.Layer.prototype.getPos=function(){return this._pos=CLOUD.MarkerUtil.transformPosition(this.position),this._pos},CLOUD.Extensions.NumLayer=function(e,t){this.options={numIcon:new CLOUD.Extensions.NumIcon(e,t),pane:"markerPane"},this.markerList=[],this.position={},this.clickCallback=null,this.mouseDownFun=this.onMouseDown.bind(this),this.mouseUpFun=this.onMouseUp.bind(this),this.touchEndFun=this.onTouchEnd.bind(this)},CLOUD.Extensions.NumLayer.prototype.constructor=CLOUD.Extensions.NumLayer,CLOUD.Extensions.NumLayer.prototype.initialize=function(e,t){CLOUD.MarkerUtil.setOptions(this,t),this.position.x=e.x,this.position.y=e.y,this.position.z=e.z},CLOUD.Extensions.NumLayer.prototype.addMarker=function(e){this.markerList.push(e),1!=this.markerList.length?this.addPosition(e.position):(this.position.x=e.position.x,this.position.y=e.position.y,this.position.z=e.position.z)},CLOUD.Extensions.NumLayer.prototype.addLayer=function(e){this.markerList=this.markerList.concat(e.markerList),this.markerList.length!=e.markerList.length?this.addPosition(e.position):(this.position.x=e.position.x,this.position.y=e.position.y,this.position.z=e.position.z)},CLOUD.Extensions.NumLayer.prototype.onAdd=function(){1==this.markerList.length?this.markerList[0].display(!0):(this._initIcon(),this.update())},CLOUD.Extensions.NumLayer.prototype.onRemove=function(){this._removeIcon()},CLOUD.Extensions.NumLayer.prototype.addPosition=function(e){this.position.x+=e.x,this.position.y+=e.y,this.position.z+=e.z,this.position.x*=.5,this.position.y*=.5,this.position.z*=.5},CLOUD.Extensions.NumLayer.prototype.getElement=function(){return this._icon},CLOUD.Extensions.NumLayer.prototype.getPos=function(){return this._icon?(this._pos=CLOUD.MarkerUtil.transformPosition(this.position),this._pos):this.markerList[0].getPos()},CLOUD.Extensions.NumLayer.prototype.update=function(){if(this._icon){var e=CLOUD.MarkerUtil.transformPosition(this.position);this._setPos(e),this._icon.textContent=this.markerList.length.toString()}return this},CLOUD.Extensions.NumLayer.prototype.onMouseDown=function(e){e.preventDefault(),e.stopPropagation(),this.event=e},CLOUD.Extensions.NumLayer.prototype.onMouseUp=function(e){e.preventDefault(),e.stopPropagation(),this.event.clientX==e.clientX&&this.event.clientY==e.clientY&&null!=this.clickCallback&&this.clickCallback(e,this)},CLOUD.Extensions.NumLayer.prototype.onTouchEnd=function(e){e.preventDefault(),e.stopPropagation(),this.event.pageX==e.pageX&&this.event.pageY==e.pageY&&null!=this.clickCallback&&this.clickCallback(this.event,this)},CLOUD.Extensions.NumLayer.prototype.setClickCallback=function(e){this._icon&&(this.clickCallback=e)},CLOUD.Extensions.NumLayer.prototype._initIcon=function(){if(!this._icon){var e=this.options;this._icon=e.numIcon.createIcon(this._icon),void 0==CLOUD.MarkerUtil.mainPane&&(CLOUD.MarkerUtil.mainPane=CLOUD.MarkerUtil.createPane("main")),CLOUD.MarkerUtil.getPane(e.pane,CLOUD.MarkerUtil.mainPane).appendChild(this._icon),this._icon.addEventListener("mousedown",this.mouseDownFun,!1),this._icon.addEventListener("mouseup",this.mouseUpFun,!1),this._icon.addEventListener("touchstart",this.mouseDownFun,!1),this._icon.addEventListener("touchend",this.touchEndFun,!1)}},CLOUD.Extensions.NumLayer.prototype._removeIcon=function(){this._icon&&(this._icon.removeEventListener("mousedown",this.mouseDownFun,!1),this._icon.removeEventListener("mouseup",this.mouseUpFun,!1),this._icon.removeEventListener("touchstart",this.mouseDownFun,!1),this._icon.removeEventListener("touchend",this.touchEndFun,!1),CLOUD.DomUtil2D.remove(this._icon),this._icon=null)},CLOUD.Extensions.NumLayer.prototype._setPos=function(e){this._icon&&(this._pos=e,CLOUD.DomUtil2D.setPosition(this._icon,e))},CLOUD.Extensions.MarkerManager=function(e){this.viewer=e,CLOUD.MarkerUtil.viewer=e,this.markerList={},this.markerResultList={},this.iconList={},this.numLayerOptions={iconSize:[40,40],iconAnchor:[20,20]},this.viewer.addRenderCallback(this.update.bind(this)),this.markerClusterDistance=25,this.zoomFactor=10,this.zoomToLayerFun=this.zoomToLayer.bind(this),this.markerClickCallback=null,this.layerClickCallback=null},CLOUD.Extensions.MarkerManager.prototype={constructor:CLOUD.Extensions.MarkerManager,createIcon:function(e,t,i,n,r,a,o){var s=new CLOUD.Extensions.Icon(t,i,n,r,a,o);s.name=e,this.iconList[e]=s},setNumLayerIcon:function(e,t){this.numLayerOptions.iconSize=e,this.numLayerOptions.iconAnchor=t},addMarker:function(e,t,i,n){var r=new CLOUD.Extensions.MarkerEx(this.iconList[e]);void 0===n&&(n="Default"),this.markerList.hasOwnProperty(n)||(this.markerList[n]=[]),this.markerList[n].push(r),r.uuid=i,r.initialize(t),r.onAdd(),null!=this.markerClickCallback&&r.setClickCallback(this.markerClickCallback)},removeMarker:function(e){for(var t in this.markerList)for(var i=this.markerList[t],n=i.length,r=0;r<n;++r)if(e===i[r].uuid)return this.markerList[t].splice(r,1),this.update(),!0;return!1},getMarkerByUserId:function(e){for(var t in this.markerList)for(var i=this.markerList[t],n=i.length,r=0;r<n;++r)if(e===i[r].uuid)return i[r];return null},getMarkerInfoList:function(){var e={};for(var t in this.iconList)e[t]=this.iconList[t].options;var i={};for(var t in this.markerList){i[t]=[];for(var n=this.markerList[t],r=n.length,a=0;a<r;++a){var o=n[a];i[t][a]={iconName:o.options.icon.name,uuid:o.uuid,position:o.position}}}return JSON.stringify({icons:e,numLayerOptions:this.numLayerOptions,markers:i})},loadMarkers:function(e){this.clearAll();var t=JSON.parse(e),i=t.icons;for(var n in i){var r=new CLOUD.Extensions.Icon;r.initialize(i[n]),this.iconList[n]=r}this.numLayerOptions=t.numLayerOptions;var a=t.markers;for(var n in a)for(var o=a[n],s=o.length,l=0;l<s;++l){var c=o[l];this.addMarker(c.iconName,c.position,c.uuid,n)}this.update()},setMarkerClickCallback:function(e){this.markerClickCallback=e},setLayerClickCallback:function(e){this.layerClickCallback=e},clearMarkers:function(){for(var e in this.markerList){for(var t=this.markerList[e],i=t.length,n=0;n<i;++n)t[n].onRemove();this.markerList[e]=[]}this.update()},clearAll:function(){this.clearMarkers(),this.iconList={}},update:function(){for(var e in this.markerList)this.updateMarkerCluster(e);this.updateLayerCluster();for(var e in this.markerResultList)for(var t=this.markerResultList[e],i=t.length,n=0;n<i;++n){var r=t[n];1==r.markerList.length?(r.onRemove(),r.markerList[0].display(!0)):(r.onAdd(),r.setClickCallback(this.zoomToLayerFun))}},updateMarkerCluster:function(e){if(void 0===e&&(e="Default"),this.markerList.hasOwnProperty(e)){this.clearMarkerResult(e);for(var t=this.markerList[e],i=this.markerResultList[e],n=t.length,r=0;r<n;++r){var a=t[r];a.update();var o=this.findNearbyCluster(a,e);null==o&&(o=new CLOUD.Extensions.NumLayer(this.numLayerOptions.iconSize,this.numLayerOptions.iconAnchor),i.push(o)),o.addMarker(a),a.display(!1)}}},updateLayerCluster:function(){for(var e in this.markerResultList){var t=this.markerResultList[e];this.markerResultList[e]=[];for(var i=0;i<t.length;++i){var n=t[i],r=this.findNearbyCluster(n,e);null==r&&(r=new CLOUD.Extensions.NumLayer(this.numLayerOptions.iconSize,this.numLayerOptions.iconAnchor),this.markerResultList[e].push(r)),r.addLayer(n),n.onRemove()}}},findNearbyCluster:function(e,t){for(var i=e.getPos(),n=this.markerResultList[t],r=n.length,a=0;a<r;++a){var o=n[a],s=o.getPos(),l={x:s.x-i.x,y:s.y-i.y};if(Math.sqrt(l.x*l.x+l.y*l.y)<this.markerClusterDistance)return o}return null},clearMarkerResult:function(e){if(void 0===e&&(e="Default"),!this.markerResultList.hasOwnProperty(e))return void(this.markerResultList[e]=[]);for(var t=this.markerResultList[e],i=t.length,n=0;n<i;++n)t[n].onRemove();this.markerResultList[e]=[]},zoomToLayer:function(e,t){for(var i=this.viewer,n=t.markerList.length,r=new THREE.Box3,a=0;a<n;++a)r.expandByPoint(t.markerList[a].position);var o=r.getCenter();o.applyMatrix4(i.getScene().getMatrixGlobal());var s=i.camera,l=i.camera.position.clone(),c=new THREE.Vector3;c.subVectors(o,l),c.multiplyScalar(1/this.zoomFactor);for(var a=0;a<this.zoomFactor;++a){s.position.addVectors(s.position,c),s.target.addVectors(s.target,c),s.updateMVP(),t.markerList[0].update();var u=t.markerList[0].getPos();t.markerList[1].update();var h=t.markerList[1].getPos(),d={x:u.x-h.x,y:u.y-h.y};if(Math.sqrt(d.x*d.x+d.y*d.y)>this.markerClusterDistance){i.render();break}}null!=this.layerClickCallback&&this.layerClickCallback(e,t)},getScreenSnapshot:function(e){var t=this.viewer,i=CLOUD.MarkerUtil.mainPane;html2canvas(i,{onrendered:function(i){var n=i.toDataURL("image/png");t.getRenderBufferScreenShot(void 0,function(t){var i=document.createElement("canvas"),r=i.getContext("2d"),a=CLOUD.DomUtil2D.getContainerOffsetToClient(document.getElementById("viewport"));i.width=a.width,i.height=a.height;var o=new Image;o.src=t,o.onload=function(){r.drawImage(o,0,0);var t=new Image;t.src=n,t.onload=function(){r.drawImage(t,0,0);var n=i.toDataURL("image/png");i=r=null,e(n)}}})}})}},CLOUD.Extensions.MiniMapHelper=function(e){this.viewer=e,this.miniMaps={},this.defaultMiniMap=null},CLOUD.Extensions.MiniMapHelper.prototype={constructor:CLOUD.Extensions.MiniMapHelper,destroy:function(){this.destroyAllMiniMap(),this.viewer=null,this.miniMaps={},this.defaultMiniMap=null},createMiniMap:function(e,t,i,n,r,a,o){var s=this.miniMaps[e];return s||(s=this.miniMaps[e]=new CLOUD.MiniMap(this.viewer),s.setCameraChangedCallback(a),s.setClickOnAxisGridCallback(o)),t=t||this.viewer.domElement,t&&s.init(t,i,n,r),this.defaultMiniMap||(this.defaultMiniMap=this.miniMaps[e]),this.miniMaps[e]},destroyMiniMap:function(e){var t=this.miniMaps[e];t&&(t.uninit(),this.defaultMiniMap===t&&(this.defaultMiniMap=null),delete this.miniMaps[e])},destroyAllMiniMap:function(){for(var e in this.miniMaps)this.destroyMiniMap(e)},removeMiniMap:function(e){var t=this.miniMaps[e];t&&t.remove()},appendMiniMap:function(e){var t=this.miniMaps[e];t&&t.append()},getMiniMaps:function(){return this.miniMaps},getMiniMap:function(e){return this.miniMaps[e]},renderMiniMap:function(){for(var e in this.miniMaps){var t=this.miniMaps[e];t&&t.render()}},setPlaneChangedCallback:function(e){this.defaultMiniMap.setPlaneChangedCallback(e)},setMinimapResizeCallback:function(e){this.defaultMiniMap.setMinimapResizeCallback(e)},getMapContainer:function(){return this.defaultMiniMap.getMapContainer()},getFloorPlaneName:function(){return this.defaultMiniMap.getFloorPlaneName()},setAllFloorPlaneData:function(e,t){var i=this.miniMaps[e];i&&i.setAllFloorPlaneData(t)},setFloorPlaneId:function(e,t){var i=this.miniMaps[e];i&&i.setFloorPlaneId(t)},generateFloorPlane:function(e,t){var i=this.miniMaps[e];i&&i.generateFloorPlane(t)},setAxisGridData:function(e,t,i){var n=this.miniMaps[e];n&&n.setAxisGridData(t)},getAxisGridBox2D:function(){return this.defaultMiniMap.getAxisGridBox2D()},generateAxisGrid:function(e){var t=this.miniMaps[e];t&&t.generateAxisGrid()},showAxisGrid:function(e,t){var i=this.miniMaps[e];i&&(t?i.showAxisGird():i.hideAxisGird())},enableAxisGridEvent:function(e,t){var i=this.miniMaps[e];i&&i.enableMouseEvent(t)},enableMiniMapCameraNode:function(e,t){var i=this.miniMaps[e];i&&i.enableCameraNode(t)},flyBypAxisGridNumber:function(e,t,i){return console.warn("CLOUD.Extensions.MiniMapHelper.flyBypAxisGridNumber() has been deprecated. Use CLOUD.Extensions.MiniMapHelper.flyByAxisGridNumber() instead."),this.flyByAxisGridNumber(e,t,i)},flyByAxisGridNumber:function(e,t,i){var n=this.miniMaps[e];return!!n&&n.flyByAxisGridNumber(t,i)},getAxisGridInfoByPoint:function(e){var t=this.defaultMiniMap,i=null;return t&&(i=t.getAxisGridInfoByPoint(e)),i},getAxisGridInfoByIntersect:function(e){var t=this.defaultMiniMap;t&&(e.axisGridInfo=t.getAxisGridInfoByPoint(e.point))},resize:function(e,t,i){var n=this.miniMaps[e];n&&n.resize(t,i)},getCuttingBox:function(e,t,i){var n=this.miniMaps[e];return n?n.getCuttingBox(t,i):null},getCuttingBoxOnCanvas:function(e,t,i){var n=this.miniMaps[e];return n?n.getCuttingBoxOnCanvas(t,i):null},highlightedNodeByClientPoint:function(e,t){var i=this.miniMaps[e];return!!i&&i.highlightedNodeByClientPoint(t.x,t.y)},locateByClientPoint:function(e,t){var i=this.miniMaps[e];return!!i&&i.locateByClientPoint(t.x,t.y)},addDomEventListeners:function(e,t,i,n){var r=this.miniMaps[e];r&&(r.addDomEventListener("mousedown",t,!1),r.addDomEventListener("mousemove",i,!1),r.addDomEventListener("mouseup",n,!1))},removeDomEventListeners:function(e,t,i,n){var r=this.miniMaps[e];r&&(r.removeDomEventListener("mousedown",t,!1),r.removeDomEventListener("mousemove",i,!1),r.removeDomEventListener("mouseup",n,!1))}},CLOUD.Extensions.MarkerHelper=function(e){this.viewer=e,this.markerClickCallback=null},CLOUD.Extensions.MarkerHelper.prototype={constructor:CLOUD.Extensions.MarkerHelper,destroy:function(){this.uninitMarkerEditor(),this.markerEditor=null,this.markerClickCallback=null,this.viewer=null},initMarkerEditor:function(){var e=this.viewer;this.markerEditor||(this.markerEditor=new CLOUD.Extensions.MarkerEditor(e)),this.markerEditor.isInitialized()||this.markerEditor.init(),this.markerClickCallback&&this.markerEditor.setMarkerClickCallback(this.markerClickCallback)},setDomContainer:function(e){this.markerEditor.setDomContainer(e)},uninitMarkerEditor:function(){this.markerEditor&&this.markerEditor.isInitialized()&&this.markerEditor.uninit()},zoomToSelectedMarkers:function(){if(this.markerEditor){var e=this.markerEditor.getMarkersBoundingBox();e.isEmpty()||this.viewer.zoomToBBox(e,.05),this.markerEditor.updateMarkers()}},loadMarkers:function(e){e?(this.initMarkerEditor(),this.markerEditor.loadMarkers(e)):this.uninitMarkerEditor()},loadMarkerFromIntersect:function(e,t,i){e&&(this.initMarkerEditor(),this.markerEditor.createMarkerByIntersect(e,t,i))},loadMarkerFromPosition:function(e,t,i,n,r,a){if(e&&t){var o={worldPosition:e,userId:t,worldBoundingBox:new THREE.Box3(i,n)};this.initMarkerEditor(),this.markerEditor.createMarkerByIntersect(o,r,a)}},loadMarkersFromIntersect:function(e,t,i){e?(this.initMarkerEditor(),this.markerEditor.loadMarkersFromIntersect(e,t,i)):this.uninitMarkerEditor()},getMarkerInfoList:function(){return this.markerEditor?this.markerEditor.getMarkerInfoList():null},resizeMarkers:function(){if(this.markerEditor)return this.markerEditor.onResize()},renderMarkers:function(){if(this.markerEditor)return this.markerEditor.updateMarkers()},getMarkersBoundingBox:function(){if(this.markerEditor)return this.markerEditor.getMarkersBoundingBox()},hideMarkerByUserId:function(e){if(this.markerEditor){this.markerEditor.getMarkerByUserId(e).shape.style.display="none"}},hideAllMarker:function(){this.markerEditor&&(this.markerEditor.svg.style.display="none")},showMarkerByUserId:function(e){if(this.markerEditor){this.markerEditor.getMarkerByUserId(e).shape.style.display=""}},showAllMarker:function(){this.markerEditor&&(this.markerEditor.svg.style.display="")},selectMarkerByUserId:function(e){if(this.markerEditor){var t=this.markerEditor.getMarkerByUserId(e);t.highlight(!0),this.markerEditor.selectMarker(t)}},deleteMarkerByUserId:function(e){if(this.markerEditor){var t=this.markerEditor.getMarkerByUserId(e);this.markerEditor.deleteMarker(t)}},deleteSelectMarker:function(){this.markerEditor&&this.markerEditor.selectedMarker&&this.markerEditor.deleteMarker(this.markerEditor.selectedMarker)},setMarkerClickCallback:function(e){this.markerClickCallback=e}},CLOUD.Extensions.DwgHelper=function(e){this.dwgContainer=null,this.annotationContainer=null,this.defaultStyle={"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"","font-weight":""},this.isDblClickCloseCloud=!0,this.options=e},CLOUD.Extensions.DwgHelper.prototype={constructor:CLOUD.Extensions.DwgHelper,destroy:function(){this.uninitAnnotation(),this.editor=null,this.dwgContainer=null,this.annotationContainer=null,this.options=null},setDomContainer:function(e,t){this.dwgContainer=e,this.annotationContainer=t||e},initAnnotation:function(e,t){var i=this,n=this.annotationContainer,r=this.options;if(this.editor?this.editor.setDomContainer(n):this.editor=new CLOUD.Extensions.AnnotationEditor2D(n,r),this.editor.enableDblClickCloseCloud(this.isDblClickCloseCloud),!this.editor.isInitialized()){var a={beginEditCallback:e,endEditCallback:t,changeEditorModeCallback:function(){i.uninitAnnotation()}};this.editor.init(a),this.editor.setSvgZIndex(),a=null}},uninitAnnotation:function(){this.editor&&this.editor.isInitialized()&&this.editor.uninit()},setAnnotationBackgroundColor:function(e,t){this.editor&&this.editor.setBackgroundColor(e,t)},editAnnotationBegin:function(e,t,i){this.initAnnotation(t,i),e&&this.editor.setAbsoluteBasePoint(e),this.editor.editBegin()},editAnnotationEnd:function(){this.editor&&this.editor.editEnd()},setAnnotationType:function(e){this.editor&&this.editor.setAnnotationType(e)},setAnnotationStyle:function(e,t){if(this.editor){for(var i in e)i in this.defaultStyle&&(this.defaultStyle[i]=e[i]);this.editor.setAnnotationStyle(this.defaultStyle,t)}},loadAnnotations:function(e,t,i,n){e?(this.initAnnotation(i,n),t&&this.editor.setAbsoluteBasePoint(t),this.editor.loadAnnotations(e)):this.uninitAnnotation()},getAnnotationInfoList:function(){return this.editor?this.editor.getAnnotationInfoList():null},resizeAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onResize()},clearAnnotations:function(){this.editor&&this.editor.isInitialized()&&this.editor.onCameraChange()},enableDblClickCloseCloud:function(e){this.isDblClickCloseCloud=e},captureAnnotationsScreenSnapshot:function(e){var t=this,i=this.editor&&this.editor.isInitialized(),n=this.dwgContainer;if(!n||!i)return void e(null);html2canvas(n,{logging:!0,onrendered:function(i){var n=i.toDataURL("image/png");t.editor.getScreenSnapshot(n,e)}})},canvas2image:function(e){this.captureAnnotationsScreenSnapshot(e)},setAbsoluteBasePoint:function(e){this.initAnnotation(),e&&this.editor.setAbsoluteBasePoint(e)},setScreenBasePoint:function(e){this.initAnnotation(),e&&this.editor.setScreenBasePoint(e)},setZoomFactor:function(e,t){t=t||e,this.initAnnotation(),this.editor.setZoomFactor(e,t)},setTextFromPopupBox:function(e){this.editor&&this.editor.setTextFromPopupBox(e)},unsetTextFromPopupBox:function(){this.editor&&this.editor.unsetTextFromPopupBox()}},function(){function e(t,i,n){function r(o,s){if(!i[o]){if(!t[o]){var l="function"==typeof require&&require;if(!s&&l)return l(o,!0);if(a)return a(o,!0);var c=new Error("Cannot find module '"+o+"'");throw c.code="MODULE_NOT_FOUND",c}var u=i[o]={exports:{}};t[o][0].call(u.exports,function(e){return r(t[o][1][e]||e)},u,u.exports,e,t,i,n)}return i[o].exports}for(var a="function"==typeof require&&require,o=0;o<n.length;o++)r(n[o]);return r}return e}()({1:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=e("./BimCubeData"),r=e("./BimCubeView"),a=e("./BimCubeEditor"),o=function(){function e(e,t,i){this.callback=i,this.functionsUnexecuted=[];var o=this;e.offsetWidth,e.offsetHeight;this.bimCubeData=new n.BimCubeData(t,function(){o.bimCubeView=new r.BimCubeView(e,o.bimCubeData),o.bimCubeEditor=new a.BimCubeEditor(e,o.bimCubeData,o.bimCubeView),o.callback&&o.callback(),o.applyFunctionsUnexecuted()})}return e.prototype.applyFunctionsUnexecuted=function(){for(var e=this.functionsUnexecuted,t=0;t<e.length;t++){switch(e[t]){case"show":this.show();break;case"hide":this.hide()}}this.functionsUnexecuted=[]},e.prototype.switchCameraType=function(e){this.bimCubeView.switchCameraType(e)},e.prototype.addEventListener=function(e,t){this.bimCubeEditor.addEventListener(e,t)},e.prototype.show=function(){if(!this.bimCubeView)return void this.functionsUnexecuted.push("show");var e=this.bimCubeData.getScene();this.bimCubeView.setActiveScene(e),this.bimCubeView.render()},e.prototype.hide=function(){if(!this.bimCubeView)return void this.functionsUnexecuted.push("hide");var e=new THREE.Scene;this.bimCubeView.setActiveScene(e),this.bimCubeView.render()},e.prototype.update=function(e){this.bimCubeView.render(e)},e}();i.BimCube=o,window.BimCube=o},{"./BimCubeData":2,"./BimCubeEditor":3,"./BimCubeView":4}],2:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=e("./CubeEdge"),r=e("./CubeCorner"),a=e("./CubeFace"),o=function(){function e(e,t){this.languageType=e,this.initialize(),this.scene=new THREE.Scene,this.callback=t,this.buildEdges(),this.buildCorners(),this.buildFaces()}return e.prototype.initialize=function(){this.enumViewMode={2673:"Top",4015:"Bottom","0231":"Front",5764:"Back",1375:"Right",4620:"Left",3:"RoofSouthEast",2:"RoofSouthWest",7:"RoofNorthEast",6:"RoofNorthWest",1:"BottomSouthEast",0:"BottomSouthWest",4:"BottomNorthWest",5:"BottomNorthEast",32:"RoofFront",76:"RoofBack",37:"RoofRight",26:"RoofLeft","01":"BottomFront",45:"BottomBack",15:"BottomRight","04":"BottomLeft",13:"SouthEast",20:"SouthWest",57:"NorthEast",64:"NorthWest"},this.length=100,this.vertices=[],this.vertexIds=[],this.edgeIds=[],this.edgeIndices=[],this.faceIds=[],this.faceIndices=[],this.componentList=[],this.texturesLoaded=0;var e=this.length;this.vertices.push(new THREE.Vector3(-e/2,-e/2,e/2)),this.vertices.push(new THREE.Vector3(e/2,-e/2,e/2)),this.vertices.push(new THREE.Vector3(-e/2,e/2,e/2)),this.vertices.push(new THREE.Vector3(e/2,e/2,e/2)),this.vertices.push(new THREE.Vector3(-e/2,-e/2,-e/2)),this.vertices.push(new THREE.Vector3(e/2,-e/2,-e/2)),this.vertices.push(new THREE.Vector3(-e/2,e/2,-e/2)),this.vertices.push(new THREE.Vector3(e/2,e/2,-e/2));for(var t=0;t<8;t++)this.vertexIds.push(t+"");this.edgeIndices.push([0,1],[1,3],[3,2],[2,0]),this.edgeIndices.push([0,4],[1,5],[2,6],[3,7]),this.edgeIndices.push([4,5],[5,7],[7,6],[6,4]);for(var t=0;t<12;t++){var i=this.edgeIndices[t];this.edgeIds.push(i[0]+""+i[1])}this.faceIndices.push([0,2,3,1]),this.faceIndices.push([4,0,1,5]),this.faceIndices.push([4,6,2,0]),this.faceIndices.push([2,6,7,3]),this.faceIndices.push([1,3,7,5]),this.faceIndices.push([5,7,6,4]);for(var t=0;t<6;t++){
var n=this.faceIndices[t];this.faceIds.push(n[0]+""+n[1]+n[2]+n[3])}},e.prototype.buildFaces=function(){for(var e=this.vertices,t=this.faceIndices,i=this.faceIds,n=this,r=0;r<6;r++)!function(r){var o=window.bimfaceStaticHost+"/textures/"+n.languageType+"/"+n.enumViewMode[i[r]]+".png",s=new THREE.TextureLoader;s.setCrossOrigin("anonymous");var l=n;s.load(o,function(n){var o=new a.CubeFace(e,t[r],i[r],n);l.componentList.push(o),l.scene.add(o.getMesh()),l.scene.add(o.getWireframe()),l.scene.add(o.getHighlightMesh()),6==++l.texturesLoaded&&l.callback&&l.callback()})}(r)},e.prototype.buildEdges=function(){for(var e=this.vertices,t=this.edgeIndices,i=this.edgeIds,r=0;r<12;r++){var a=new n.CubeEdge(e,t[r],i[r]);this.componentList.push(a),this.scene.add(a.getMesh()),this.scene.add(a.getWireframe()),this.scene.add(a.getHighlightWireframeMesh())}},e.prototype.buildCorners=function(){for(var e=this.vertices,t=this.vertexIds,i=0;i<8;i++){var n=new r.CubeCorner(e[i],t[i]);this.componentList.push(n),this.scene.add(n.getMesh()),this.scene.add(n.getWireframe()),this.scene.add(n.getCornerFace()),this.scene.add(n.getCornerWireframe())}},e.prototype.getComponent=function(e){for(var t=0;t<this.componentList.length;t++){var i=this.componentList[t];if(i.getId()==e)return i}return null},e.prototype.transparentCorners=function(){},e.prototype.opaqueCorners=function(){},e.prototype.getScene=function(){return this.scene},e.prototype.getMeshes=function(){for(var e=[],t=this.scene.children,i=0;i<t.length;i++){var n=t[i];"Mesh"===n.type&&!0!==n.isHighlightMesh&&e.push(n)}return e},e}();i.BimCubeData=o},{"./CubeCorner":6,"./CubeEdge":7,"./CubeFace":8}],3:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=e("./EventManager"),r=function(){function e(e,t,i){this.eventManager=new n.EventManager,this.container=e,this.bimCubeData=t,this.bimCubeView=i,this.initialize()}return e.prototype.initialize=function(){this.onMouseDownBinded=this.onMouseDown.bind(this),this.onMouseUpBinded=this.onMouseUp.bind(this),this.onMouseMoveBinded=this.onMouseMove.bind(this);var e=this.container;e.addEventListener("mousemove",this.onMouseMoveBinded,!1),e.addEventListener("mousedown",this.onMouseDownBinded,!1),this.raycaster=new THREE.Raycaster,this.lastHoverComponentId=null,this.bMouseDown=!1,this.mouseDownPos=null,this.doubleClickFlag=!1},e.prototype.onMouseDown=function(e){this.bMouseDown=!0,this.mouseDownPos=new THREE.Vector2(e.offsetX,e.offsetY),window.addEventListener("mouseup",this.onMouseUpBinded,!1)},e.prototype.onMouseMove=function(e){if(!this.bMouseDown){var t={x:e.offsetX,y:e.offsetY},i=this.canvasToNormalized(t),n=this.hitTest(i),r=this.lastHoverComponentId;if(n){if(n!=this.lastHoverComponentId){var a=this.bimCubeData.getComponent(n);a.highlight(),this.bimCubeView.render(),this.lastHoverComponentId=n}}else this.lastHoverComponentId=null;if(r&&n!=r){var a=this.bimCubeData.getComponent(r);a.cancelHighlight(),this.bimCubeView.render()}}},e.prototype.onMouseUp=function(e){if(window.removeEventListener("mouseup",this.onMouseUpBinded),0!=this.bMouseDown){var t=this;if(0!=this.doubleClickFlag)return void(this.bMouseDown=!1);this.doubleClickFlag=!0,setTimeout(function(){t.doubleClickFlag=!1},1e3),this.bMouseDown=!1;var i=new THREE.Vector2(e.offsetX,e.offsetY);if(i.x==this.mouseDownPos.x&&i.y==this.mouseDownPos.y){var r={x:e.offsetX,y:e.offsetY},a=this.canvasToNormalized(r),o=this.hitTest(a);if(o){if(this.lastHoverComponentId){this.bimCubeData.getComponent(this.lastHoverComponentId).cancelHighlight(),this.lastHoverComponentId=null,this.bimCubeView.render()}var s=n.EventManager.enumTypes,l={type:s.ON_COMPONENT_CLICK,componentId:o,viewType:this.bimCubeData.enumViewMode[o]};this.eventManager.dispatchEvent(l)}}}},e.prototype.canvasToNormalized=function(e){var t=this.container.offsetWidth,i=this.container.offsetHeight,n={x:0,y:0};return n.x=e.x/t*2-1,n.y=-e.y/i*2+1,n},e.prototype.hitTest=function(e){var t=this.bimCubeView.getActiveCamera();this.raycaster.setFromCamera(e,t);var i=this.bimCubeData.getMeshes(),n=this.raycaster.intersectObjects(i,!0);if(0!=n.length){var r=n[0].object.componentId;if(n.length>=2){var a=n[1].object.componentId;4==r.length&&2==a.length&&n[1].distance<n[0].distance+5&&(r=a)}return r}},e.prototype.addEventListener=function(e,t){this.eventManager.addEventListener(e,t)},e}();i.BimCubeEditor=r},{"./EventManager":9}],4:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(e,t){this.container=e,this.bimCubeData=t,this.activeCamera=new THREE.OrthographicCamera(-110,110,110,-110,-110,110),this.activeScene,this.initialize()}return e.prototype.initialize=function(){this.renderer=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),this.container.appendChild(this.renderer.domElement);var e=this.container.offsetWidth,t=this.container.offsetHeight;this.renderer.setSize(e,t)},e.prototype.switchCameraType=function(e){},e.prototype.getActiveCamera=function(){return this.activeCamera},e.prototype.setActiveScene=function(e){this.activeScene=e},e.prototype.render=function(e){e&&(this.activeCamera.up.copy(e.up),this.activeCamera.lookAt(e.dir),this.activeCamera.updateMatrixWorld());var t=this.activeScene||this.bimCubeData.getScene();this.renderer.autoClear=!0,this.renderer.render(t,this.activeCamera)},e.enumTypes={PERSPECTIVE:1e3,ORTHOGRAPHIC:1001},e}();i.BimCubeView=n},{}],5:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(){this.faceDefaultColor=14936556,this.wireframeDefaultColor=13421772,this.faceHighlightColor=12255212,this.wireframeHighlightColor=3330982}return e.prototype.createMesh=function(e){var t=new THREE.Geometry;t.vertices=e;for(var i=e.length-2,n=1;n<=i;n++){var r=new THREE.Face3(0,n,n+1);t.faces.push(r)}var a=new THREE.MeshBasicMaterial({color:this.faceDefaultColor,side:THREE.DoubleSide}),o=new THREE.Mesh(t,a);return o.componentId=this.componentId,o},e.prototype.createWireframe=function(e){for(var t=new THREE.LineGeometry,i=[],n=0;n<e.length;n++){var r=e[n];i.push(r.x,r.y,r.z)}t.setPositions(i);var a=new THREE.LineMaterial({color:this.wireframeDefaultColor,linewidth:1});a.resolution.set(160,160);var o=new THREE.Line2(t,a);return o.componentId=this.componentId,o},e.prototype.getMesh=function(){return this.mesh},e.prototype.getWireframe=function(){return this.wireframeMesh},e.prototype.transparent=function(e){e.material&&(e.material.transparent=!0,e.material.opacity=0)},e.prototype.opaque=function(e){e.material&&(e.material.transparent=!1,e.material.opacity=1)},e.prototype.getId=function(){return this.componentId},e}();i.CubeComponent=n},{}],6:[function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(i,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,i){var n=e.call(this)||this;return n.length=20,n.vertex=t,n.cornerFace=null,n.cornerWireframe=null,n.componentId=i,n.cornerVertices=null,n.build(),n}return n(t,e),t.prototype.build=function(){var e=[],t=this.vertex.clone(),i=t.clone().multiplyScalar(-1);e.push(t);var n=this.vertex.clone(),r=i.x>0?this.length:-this.length;n.x+=r,e.push(n);var a=this.vertex.clone(),o=i.y>0?this.length:-this.length;a.y+=o,e.push(a);var s=this.vertex.clone(),l=i.z>0?this.length:-this.length;s.z+=l,e.push(s),this.cornerVertices=e,this.mesh=this.createMesh([n,a,s]),this.wireframeMesh=this.createWireframe([n,a,s,n]),this.buildCornerFace(),this.buildCornerWireframe()},t.prototype.highlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor),this.wireframeMesh.renderOrder=100,this.mesh.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.color.setHex(this.faceHighlightColor),this.cornerFace.material.transparent=!0,this.cornerFace.material.opacity=.5,this.cornerWireframe.material.color.setHex(this.wireframeHighlightColor),this.cornerWireframe.visible=!0},t.prototype.cancelHighlight=function(){this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor),this.wireframeMesh.renderOrder=0,this.mesh.material.color.setHex(this.faceDefaultColor),this.transparent(this.cornerFace),this.cornerWireframe.visible=!1},t.prototype.buildCornerFace=function(){if(!this.cornerFace){var e=this.cornerVertices;e.push(e[1]),this.cornerFace=this.createMesh(e),this.transparent(this.cornerFace)}},t.prototype.getCornerFace=function(){return this.cornerFace},t.prototype.getCornerWireframe=function(){return this.cornerWireframe},t.prototype.buildCornerWireframe=function(){if(!this.cornerWireframe){for(var e=[],t=1;t<this.cornerVertices.length;t++){var i=this.cornerVertices[0],n=this.cornerVertices[t];e.push(i,n)}this.cornerWireframe=this.createWireframe(e),this.cornerWireframe.visible=!1}},t}(r.CubeComponent);i.CubeCorner=a},{"./CubeComponent":5}],7:[function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(i,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,i,n){var r=e.call(this)||this;return r.highlightWidth=3,r.width=15,r.vertices=t,r.indices=i,r.componentId=n,r.highlightWireframeMesh=null,r.testWireframe=null,r.build(),r}return n(t,e),t.prototype.build=function(){var e=this.indices[0],t=this.indices[1],i=this.vertices[e],n=this.vertices[t],r=i.clone().add(n).multiplyScalar(.5),a=r.clone().multiplyScalar(-1),o=a.clone().normalize(),s=[],l=n.clone().sub(i).normalize(),c=i.clone().add(l.clone().multiplyScalar(20)),u=i.clone().add(l.clone().multiplyScalar(80)),h=[];if(0!==a.x){var d=a.x>0?this.width:-this.width;h.push((new THREE.Vector3).setX(d).add(o))}if(0!==a.y){var f=a.y>0?this.width:-this.width;h.push((new THREE.Vector3).setY(f).add(o))}if(0!==a.z){var p=a.z>0?this.width:-this.width;h.push((new THREE.Vector3).setZ(p).add(o))}2===h.length&&(s.push(c.clone().add(o)),s.push(c.clone().add(h[0])),s.push(u.clone().add(h[0])),s.push(u.clone().add(o)),s.push(u.clone().add(h[1])),s.push(c.clone().add(h[1]))),this.mesh=this.createMesh(s),this.transparent(this.mesh),this.wireframeMesh=this.createWireframe([c,u]),this.highlightWireframeMesh=this.createHighlightWireframe([c.sub(o),u.sub(o)])},t.prototype.createHighlightWireframe=function(e){for(var t=[],i=0;i<e.length;i++){var n=e[i];t.push(n.x,n.y,n.z)}var r=new THREE.LineGeometry;r.setPositions(t);var a=new THREE.LineMaterial({color:this.wireframeHighlightColor,linewidth:this.highlightWidth,dashed:!1});a.resolution.set(160,160);var o=new THREE.Line2(r,a);return o.computeLineDistances(),o.scale.set(1,1,1),o.visible=!1,o.renderOrder=100,o},t.prototype.getTestWireframe=function(){return this.testWireframe},t.prototype.getHighlightWireframeMesh=function(){return this.highlightWireframeMesh},t.prototype.highlight=function(){this.highlightWireframeMesh.visible=!0,this.highlightWireframeMesh.renderOrder=100},t.prototype.cancelHighlight=function(){this.highlightWireframeMesh.visible=!1},t}(r.CubeComponent);i.CubeEdge=a},{"./CubeComponent":5}],8:[function(e,t,i){var n=this&&this.__extends||function(){var e=function(t,i){return(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var i in t)t.hasOwnProperty(i)&&(e[i]=t[i])})(t,i)};return function(t,i){function n(){this.constructor=t}e(t,i),t.prototype=null===i?Object.create(i):(n.prototype=i.prototype,new n)}}();Object.defineProperty(i,"__esModule",{value:!0});var r=e("./CubeComponent"),a=function(e){function t(t,i,n,r){var a=e.call(this)||this;return a.length=60,a.vertices=t,a.indices=i,a.componentId=n,a.vertexUvs=null,a.texture=r,a.highlightMesh=null,a.wireframeMesh=null,a.vertexUvs=[],a.vertexUvs.push(new THREE.Vector2(0,.2)),a.vertexUvs.push(new THREE.Vector2(0,.8)),a.vertexUvs.push(new THREE.Vector2(.2,1)),a.vertexUvs.push(new THREE.Vector2(.8,1)),a.vertexUvs.push(new THREE.Vector2(1,.8)),a.vertexUvs.push(new THREE.Vector2(1,.2)),a.vertexUvs.push(new THREE.Vector2(.8,0)),a.vertexUvs.push(new THREE.Vector2(.2,0)),a.build(),a}return n(t,e),t.prototype.build=function(){for(var e=[],t=null,i=null,n=0,r=this.indices.length;n<r;n++){var a=this.indices[n],o=this.indices[n+1];t=this.vertices[a],i=this.vertices[o],n===r-1&&(i=this.vertices[this.indices[0]]);var s=i.clone().sub(t).normalize(),l=t.clone().add(i).multiplyScalar(.5);e.push(l.clone().sub(s.clone().multiplyScalar(this.length/2))),e.push(l.clone().add(s.clone().multiplyScalar(this.length/2)))}this.createTexturedMesh(e);for(var c=new THREE.Box3,u=0;u<this.indices.length;u++){var h=this.indices[u];c.expandByPoint(this.vertices[h])}for(var d=c.getCenter().normalize(),f=[],p=0;p<e.length;p++){var m=e[p];f.push(m.clone().add(d))}this.highlightMesh=this.createMesh(f),this.highlightMesh.visible=!1,this.highlightMesh.isHighlightMesh=!0,f.push(f[0]),this.wireframeMesh=this.createWireframe(f)},t.prototype.highlight=function(){this.highlightMesh.visible=!0,this.highlightMesh.material.color.setHex(this.faceHighlightColor),this.highlightMesh.material.transparent=!0,this.highlightMesh.material.opacity=.5,this.wireframeMesh.material.color.setHex(this.wireframeHighlightColor)},t.prototype.cancelHighlight=function(){this.highlightMesh.visible=!1,this.wireframeMesh.material.color.setHex(this.wireframeDefaultColor)},t.prototype.createTexturedMesh=function(e){var t=new THREE.Geometry;t.vertices=e;for(var i=e.length-2,n=1;n<=i;n++){var r=new THREE.Face3(0,n,n+1);t.faces.push(r)}for(var a=new THREE.MeshBasicMaterial({map:this.texture,side:THREE.DoubleSide,transparent:!1}),o=this.vertexUvs,s=0;s<t.faces.length;s++){var r=t.faces[s];t.faceVertexUvs[0].push([o[r.a],o[r.b],o[r.c]])}t.uvsNeedUpdate=!0,this.mesh=new THREE.Mesh(t,a),this.mesh.componentId=this.componentId},t.prototype.getHighlightMesh=function(){return this.highlightMesh},t.prototype.buildVertexUvs=function(e){for(var t=[],i=(new THREE.Box3).setFromPoints(e),n=i.min,r=i.getSize(),a=0==r.x?"x":0==r.y?"y":"z",o=0;o<e.length;o++){var s=e[o],l=(r.x+r.y+r.z)/2,c=s.clone().sub(n).multiplyScalar(1/l),u=new THREE.Vector2(c.x,c.y);"x"==a?u=new THREE.Vector2(c.y,c.z):"y"==a&&(u=new THREE.Vector2(c.x,c.z)),t.push(u)}return t},t}(r.CubeComponent);i.CubeFace=a},{"./CubeComponent":5}],9:[function(e,t,i){Object.defineProperty(i,"__esModule",{value:!0});var n=function(){function e(){this.eventDispatcher=new THREE.EventDispatcher}return e.prototype.addEventListener=function(e,t){this.eventDispatcher.addEventListener(e,t)},e.prototype.hasEventListener=function(e){this.eventDispatcher.hasEventListener(e)},e.prototype.removeEventListener=function(e,t){this.eventDispatcher.removeEventListener(e,t)},e.prototype.dispatchEvent=function(e){this.eventDispatcher.dispatchEvent(e)},e.enumTypes={ON_COMPONENT_HOVER:1e3,ON_COMPONENT_CLICK:1001},e}();i.EventManager=n},{}]},{},[1]),CLOUD.Plugins=CLOUD.Plugins||{},CLOUD.Plugins.ViewHouse="2017.5.11",CLOUD.Plugins.Font=CLOUD.Plugins.Font||{},CLOUD.Plugins.Font.helvetiker_regular={glyphs:{"Î¿":{x_min:0,x_max:712,ha:815,o:"m 356 -25 q 96 88 192 -25 q 0 368 0 201 q 92 642 0 533 q 356 761 192 761 q 617 644 517 761 q 712 368 712 533 q 619 91 712 201 q 356 -25 520 -25 m 356 85 q 527 175 465 85 q 583 369 583 255 q 528 562 583 484 q 356 651 466 651 q 189 560 250 651 q 135 369 135 481 q 187 177 135 257 q 356 85 250 85 "},S:{x_min:0,x_max:788,ha:890,o:"m 788 291 q 662 54 788 144 q 397 -26 550 -26 q 116 68 226 -26 q 0 337 0 168 l 131 337 q 200 152 131 220 q 384 85 269 85 q 557 129 479 85 q 650 270 650 183 q 490 429 650 379 q 194 513 341 470 q 33 739 33 584 q 142 964 33 881 q 388 1041 242 1041 q 644 957 543 1041 q 756 716 756 867 l 625 716 q 561 874 625 816 q 395 933 497 933 q 243 891 309 933 q 164 759 164 841 q 325 609 164 656 q 625 526 475 568 q 788 291 788 454 "},"Â¦":{x_min:343,x_max:449,ha:792,o:"m 449 462 l 343 462 l 343 986 l 449 986 l 449 462 m 449 -242 l 343 -242 l 343 280 l 449 280 l 449 -242 "},"/":{x_min:183.25,x_max:608.328125,ha:792,o:"m 608 1041 l 266 -129 l 183 -129 l 520 1041 l 608 1041 "},"Î¤":{x_min:-.4375,x_max:777.453125,ha:839,o:"m 777 893 l 458 893 l 458 0 l 319 0 l 319 892 l 0 892 l 0 1013 l 777 1013 l 777 893 "},y:{x_min:0,x_max:684.78125,ha:771,o:"m 684 738 l 388 -83 q 311 -216 356 -167 q 173 -279 252 -279 q 97 -266 133 -279 l 97 -149 q 132 -155 109 -151 q 168 -160 155 -160 q 240 -114 213 -160 q 274 -26 248 -98 l 0 738 l 137 737 l 341 139 l 548 737 l 684 738 "},"Î ":{x_min:0,x_max:803,ha:917,o:"m 803 0 l 667 0 l 667 886 l 140 886 l 140 0 l 0 0 l 0 1012 l 803 1012 l 803 0 "},"Î":{x_min:-111,x_max:339,ha:361,o:"m 339 800 l 229 800 l 229 925 l 339 925 l 339 800 m -1 800 l -111 800 l -111 925 l -1 925 l -1 800 m 284 3 q 233 -10 258 -5 q 182 -15 207 -15 q 85 26 119 -15 q 42 200 42 79 l 42 737 l 167 737 l 168 215 q 172 141 168 157 q 226 101 183 101 q 248 103 239 101 q 284 112 257 104 l 284 3 m 302 1040 l 113 819 l 30 819 l 165 1040 l 302 1040 "},g:{x_min:0,x_max:686,ha:838,o:"m 686 34 q 586 -213 686 -121 q 331 -306 487 -306 q 131 -252 216 -306 q 31 -84 31 -190 l 155 -84 q 228 -174 166 -138 q 345 -207 284 -207 q 514 -109 454 -207 q 564 89 564 -27 q 461 6 521 36 q 335 -23 401 -23 q 88 100 184 -23 q 0 370 0 215 q 87 634 0 522 q 330 758 183 758 q 457 728 398 758 q 564 644 515 699 l 564 737 l 686 737 l 686 34 m 582 367 q 529 560 582 481 q 358 652 468 652 q 189 561 250 652 q 135 369 135 482 q 189 176 135 255 q 361 85 251 85 q 529 176 468 85 q 582 367 582 255 "},"Â²":{x_min:0,x_max:442,ha:539,o:"m 442 383 l 0 383 q 91 566 0 492 q 260 668 176 617 q 354 798 354 727 q 315 875 354 845 q 227 905 277 905 q 136 869 173 905 q 99 761 99 833 l 14 761 q 82 922 14 864 q 232 974 141 974 q 379 926 316 974 q 442 797 442 878 q 351 635 442 704 q 183 539 321 611 q 92 455 92 491 l 442 455 l 442 383 "},"â€“":{x_min:0,x_max:705.5625,ha:803,o:"m 705 334 l 0 334 l 0 410 l 705 410 l 705 334 "},"Îš":{x_min:0,x_max:819.5625,ha:893,o:"m 819 0 l 650 0 l 294 509 l 139 356 l 139 0 l 0 0 l 0 1013 l 139 1013 l 139 526 l 626 1013 l 809 1013 l 395 600 l 819 0 "},"Æ’":{x_min:-46.265625,x_max:392,ha:513,o:"m 392 651 l 259 651 l 79 -279 l -46 -278 l 134 651 l 14 651 l 14 751 l 135 751 q 151 948 135 900 q 304 1041 185 1041 q 334 1040 319 1041 q 392 1034 348 1039 l 392 922 q 337 931 360 931 q 271 883 287 931 q 260 793 260 853 l 260 751 l 392 751 l 392 651 "},e:{x_min:0,x_max:714,ha:813,o:"m 714 326 l 140 326 q 200 157 140 227 q 359 87 260 87 q 488 130 431 87 q 561 245 545 174 l 697 245 q 577 48 670 123 q 358 -26 484 -26 q 97 85 195 -26 q 0 363 0 197 q 94 642 0 529 q 358 765 195 765 q 626 627 529 765 q 714 326 714 503 m 576 429 q 507 583 564 522 q 355 650 445 650 q 206 583 266 650 q 140 429 152 522 l 576 429 "},"ÏŒ":{x_min:0,x_max:712,ha:815,o:"m 356 -25 q 94 91 194 -25 q 0 368 0 202 q 92 642 0 533 q 356 761 192 761 q 617 644 517 761 q 712 368 712 533 q 619 91 712 201 q 356 -25 520 -25 m 356 85 q 527 175 465 85 q 583 369 583 255 q 528 562 583 484 q 356 651 466 651 q 189 560 250 651 q 135 369 135 481 q 187 177 135 257 q 356 85 250 85 m 576 1040 l 387 819 l 303 819 l 438 1040 l 576 1040 "},J:{x_min:0,x_max:588,ha:699,o:"m 588 279 q 287 -26 588 -26 q 58 73 126 -26 q 0 327 0 158 l 133 327 q 160 172 133 227 q 288 96 198 96 q 426 171 391 96 q 449 336 449 219 l 449 1013 l 588 1013 l 588 279 "},"Â»":{x_min:-1,x_max:503,ha:601,o:"m 503 302 l 280 136 l 281 256 l 429 373 l 281 486 l 280 608 l 503 440 l 503 302 m 221 302 l 0 136 l 0 255 l 145 372 l 0 486 l -1 608 l 221 440 l 221 302 "},"Â©":{x_min:-3,x_max:1008,ha:1106,o:"m 502 -7 q 123 151 263 -7 q -3 501 -3 294 q 123 851 -3 706 q 502 1011 263 1011 q 881 851 739 1011 q 1008 501 1008 708 q 883 151 1008 292 q 502 -7 744 -7 m 502 60 q 830 197 709 60 q 940 501 940 322 q 831 805 940 681 q 502 944 709 944 q 174 805 296 944 q 65 501 65 680 q 173 197 65 320 q 502 60 294 60 m 741 394 q 661 246 731 302 q 496 190 591 190 q 294 285 369 190 q 228 497 228 370 q 295 714 228 625 q 499 813 370 813 q 656 762 588 813 q 733 625 724 711 l 634 625 q 589 704 629 673 q 498 735 550 735 q 377 666 421 735 q 334 504 334 597 q 374 340 334 408 q 490 272 415 272 q 589 304 549 272 q 638 394 628 337 l 741 394 "},"ÏŽ":{x_min:0,x_max:922,ha:1030,o:"m 687 1040 l 498 819 l 415 819 l 549 1040 l 687 1040 m 922 339 q 856 97 922 203 q 650 -26 780 -26 q 538 9 587 -26 q 461 103 489 44 q 387 12 436 46 q 277 -22 339 -22 q 69 97 147 -22 q 0 338 0 202 q 45 551 0 444 q 161 737 84 643 l 302 737 q 175 552 219 647 q 124 336 124 446 q 155 179 124 248 q 275 88 197 88 q 375 163 341 88 q 400 294 400 219 l 400 572 l 524 572 l 524 294 q 561 135 524 192 q 643 88 591 88 q 762 182 719 88 q 797 341 797 257 q 745 555 797 450 q 619 737 705 637 l 760 737 q 874 551 835 640 q 922 339 922 444 "},"^":{x_min:193.0625,x_max:598.609375,ha:792,o:"m 598 772 l 515 772 l 395 931 l 277 772 l 193 772 l 326 1013 l 462 1013 l 598 772 "},"Â«":{x_min:0,x_max:507.203125,ha:604,o:"m 506 136 l 284 302 l 284 440 l 506 608 l 507 485 l 360 371 l 506 255 l 506 136 m 222 136 l 0 302 l 0 440 l 222 608 l 221 486 l 73 373 l 222 256 l 222 136 "},D:{x_min:0,x_max:828,ha:935,o:"m 389 1013 q 714 867 593 1013 q 828 521 828 729 q 712 161 828 309 q 382 0 587 0 l 0 0 l 0 1013 l 389 1013 m 376 124 q 607 247 523 124 q 681 510 681 355 q 607 771 681 662 q 376 896 522 896 l 139 896 l 139 124 l 376 124 "},"âˆ™":{x_min:0,x_max:142,ha:239,o:"m 142 585 l 0 585 l 0 738 l 142 738 l 142 585 "},"Ã¿":{x_min:0,x_max:47,ha:125,o:"m 47 3 q 37 -7 47 -7 q 28 0 30 -7 q 39 -4 32 -4 q 45 3 45 -1 l 37 0 q 28 9 28 0 q 39 19 28 19 l 47 16 l 47 19 l 47 3 m 37 1 q 44 8 44 1 q 37 16 44 16 q 30 8 30 16 q 37 1 30 1 m 26 1 l 23 22 l 14 0 l 3 22 l 3 3 l 0 25 l 13 1 l 22 25 l 26 1 "},w:{x_min:0,x_max:1009.71875,ha:1100,o:"m 1009 738 l 783 0 l 658 0 l 501 567 l 345 0 l 222 0 l 0 738 l 130 738 l 284 174 l 432 737 l 576 738 l 721 173 l 881 737 l 1009 738 "},$:{x_min:0,x_max:700,ha:793,o:"m 664 717 l 542 717 q 490 825 531 785 q 381 872 450 865 l 381 551 q 620 446 540 522 q 700 241 700 370 q 618 45 700 116 q 381 -25 536 -25 l 381 -152 l 307 -152 l 307 -25 q 81 62 162 -25 q 0 297 0 149 l 124 297 q 169 146 124 204 q 307 81 215 89 l 307 441 q 80 536 148 469 q 13 725 13 603 q 96 910 13 839 q 307 982 180 982 l 307 1077 l 381 1077 l 381 982 q 574 917 494 982 q 664 717 664 845 m 307 565 l 307 872 q 187 831 233 872 q 142 724 142 791 q 180 618 142 656 q 307 565 218 580 m 381 76 q 562 237 562 96 q 517 361 562 313 q 381 423 472 409 l 381 76 "},"\\":{x_min:-.015625,x_max:425.0625,ha:522,o:"m 425 -129 l 337 -129 l 0 1041 l 83 1041 l 425 -129 "},"Âµ":{x_min:0,x_max:697.21875,ha:747,o:"m 697 -4 q 629 -14 658 -14 q 498 97 513 -14 q 422 9 470 41 q 313 -23 374 -23 q 207 4 258 -23 q 119 81 156 32 l 119 -278 l 0 -278 l 0 738 l 124 738 l 124 343 q 165 173 124 246 q 308 83 216 83 q 452 178 402 83 q 493 359 493 255 l 493 738 l 617 738 l 617 214 q 623 136 617 160 q 673 92 637 92 q 697 96 684 92 l 697 -4 "},"Î™":{x_min:42,x_max:181,ha:297,o:"m 181 0 l 42 0 l 42 1013 l 181 1013 l 181 0 "},"ÎŽ":{x_min:0,x_max:1144.5,ha:1214,o:"m 1144 1012 l 807 416 l 807 0 l 667 0 l 667 416 l 325 1012 l 465 1012 l 736 533 l 1004 1012 l 1144 1012 m 277 1040 l 83 799 l 0 799 l 140 1040 l 277 1040 "},"â€™":{x_min:0,x_max:139,ha:236,o:"m 139 851 q 102 737 139 784 q 0 669 65 690 l 0 734 q 59 787 42 741 q 72 873 72 821 l 0 873 l 0 1013 l 139 1013 l 139 851 "},"Î":{x_min:0,x_max:801,ha:915,o:"m 801 0 l 651 0 l 131 822 l 131 0 l 0 0 l 0 1013 l 151 1013 l 670 191 l 670 1013 l 801 1013 l 801 0 "},"-":{x_min:8.71875,x_max:350.390625,ha:478,o:"m 350 317 l 8 317 l 8 428 l 350 428 l 350 317 "},Q:{x_min:0,x_max:968,ha:1072,o:"m 954 5 l 887 -79 l 744 35 q 622 -11 687 2 q 483 -26 556 -26 q 127 130 262 -26 q 0 504 0 279 q 127 880 0 728 q 484 1041 262 1041 q 841 884 708 1041 q 968 507 968 735 q 933 293 968 398 q 832 104 899 188 l 954 5 m 723 191 q 802 330 777 248 q 828 499 828 412 q 744 790 828 673 q 483 922 650 922 q 228 791 322 922 q 142 505 142 673 q 227 221 142 337 q 487 91 323 91 q 632 123 566 91 l 520 215 l 587 301 l 723 191 "},"Ï‚":{x_min:1,x_max:676.28125,ha:740,o:"m 676 460 l 551 460 q 498 595 542 546 q 365 651 448 651 q 199 578 263 651 q 136 401 136 505 q 266 178 136 241 q 508 106 387 142 q 640 -50 640 62 q 625 -158 640 -105 q 583 -278 611 -211 l 465 -278 q 498 -182 490 -211 q 515 -80 515 -126 q 381 12 515 -15 q 134 91 197 51 q 1 388 1 179 q 100 651 1 542 q 354 761 199 761 q 587 680 498 761 q 676 460 676 599 "},M:{x_min:0,x_max:954,ha:1067,o:"m 954 0 l 819 0 l 819 869 l 537 0 l 405 0 l 128 866 l 128 0 l 0 0 l 0 1013 l 200 1013 l 472 160 l 757 1013 l 954 1013 l 954 0 "},"Î¨":{x_min:0,x_max:1006,ha:1094,o:"m 1006 678 q 914 319 1006 429 q 571 200 814 200 l 571 0 l 433 0 l 433 200 q 92 319 194 200 q 0 678 0 429 l 0 1013 l 139 1013 l 139 679 q 191 417 139 492 q 433 326 255 326 l 433 1013 l 571 1013 l 571 326 l 580 326 q 813 423 747 326 q 868 679 868 502 l 868 1013 l 1006 1013 l 1006 678 "},C:{x_min:0,x_max:886,ha:944,o:"m 886 379 q 760 87 886 201 q 455 -26 634 -26 q 112 136 236 -26 q 0 509 0 283 q 118 882 0 737 q 469 1041 245 1041 q 748 955 630 1041 q 879 708 879 859 l 745 708 q 649 862 724 805 q 473 920 573 920 q 219 791 312 920 q 136 509 136 675 q 217 229 136 344 q 470 99 311 99 q 672 179 591 99 q 753 379 753 259 l 886 379 "},"!":{x_min:0,x_max:138,ha:236,o:"m 138 684 q 116 409 138 629 q 105 244 105 299 l 33 244 q 16 465 33 313 q 0 684 0 616 l 0 1013 l 138 1013 l 138 684 m 138 0 l 0 0 l 0 151 l 138 151 l 138 0 "},"{":{x_min:0,x_max:480.5625,ha:578,o:"m 480 -286 q 237 -213 303 -286 q 187 -45 187 -159 q 194 48 187 -15 q 201 141 201 112 q 164 264 201 225 q 0 314 118 314 l 0 417 q 164 471 119 417 q 201 605 201 514 q 199 665 201 644 q 193 772 193 769 q 241 941 193 887 q 480 1015 308 1015 l 480 915 q 336 866 375 915 q 306 742 306 828 q 310 662 306 717 q 314 577 314 606 q 288 452 314 500 q 176 365 256 391 q 289 275 257 337 q 314 143 314 226 q 313 84 314 107 q 310 -11 310 -5 q 339 -131 310 -94 q 480 -182 377 -182 l 480 -286 "},X:{x_min:-.015625,x_max:854.15625,ha:940,o:"m 854 0 l 683 0 l 423 409 l 166 0 l 0 0 l 347 519 l 18 1013 l 186 1013 l 428 637 l 675 1013 l 836 1013 l 504 520 l 854 0 "},"#":{x_min:0,x_max:963.890625,ha:1061,o:"m 963 690 l 927 590 l 719 590 l 655 410 l 876 410 l 840 310 l 618 310 l 508 -3 l 393 -2 l 506 309 l 329 310 l 215 -2 l 102 -3 l 212 310 l 0 310 l 36 410 l 248 409 l 312 590 l 86 590 l 120 690 l 347 690 l 459 1006 l 573 1006 l 462 690 l 640 690 l 751 1006 l 865 1006 l 754 690 l 963 690 m 606 590 l 425 590 l 362 410 l 543 410 l 606 590 "},"Î¹":{x_min:42,x_max:284,ha:361,o:"m 284 3 q 233 -10 258 -5 q 182 -15 207 -15 q 85 26 119 -15 q 42 200 42 79 l 42 738 l 167 738 l 168 215 q 172 141 168 157 q 226 101 183 101 q 248 103 239 101 q 284 112 257 104 l 284 3 "},"Î†":{x_min:0,x_max:906.953125,ha:982,o:"m 283 1040 l 88 799 l 5 799 l 145 1040 l 283 1040 m 906 0 l 756 0 l 650 303 l 251 303 l 143 0 l 0 0 l 376 1012 l 529 1012 l 906 0 m 609 421 l 452 866 l 293 421 l 609 421 "},")":{x_min:0,x_max:318,ha:415,o:"m 318 365 q 257 25 318 191 q 87 -290 197 -141 l 0 -290 q 140 21 93 -128 q 193 360 193 189 q 141 704 193 537 q 0 1024 97 850 l 87 1024 q 257 706 197 871 q 318 365 318 542 "},"Îµ":{x_min:0,x_max:634.71875,ha:714,o:"m 634 234 q 527 38 634 110 q 300 -25 433 -25 q 98 29 183 -25 q 0 204 0 93 q 37 314 0 265 q 128 390 67 353 q 56 460 82 419 q 26 555 26 505 q 114 712 26 654 q 295 763 191 763 q 499 700 416 763 q 589 515 589 631 l 478 515 q 419 618 464 580 q 307 657 374 657 q 207 630 253 657 q 151 547 151 598 q 238 445 151 469 q 389 434 280 434 l 389 331 l 349 331 q 206 315 255 331 q 125 210 125 287 q 183 107 125 145 q 302 76 233 76 q 436 117 379 76 q 509 234 493 159 l 634 234 "},"Î”":{x_min:0,x_max:952.78125,ha:1028,o:"m 952 0 l 0 0 l 400 1013 l 551 1013 l 952 0 m 762 124 l 476 867 l 187 124 l 762 124 "},"}":{x_min:0,x_max:481,ha:578,o:"m 481 314 q 318 262 364 314 q 282 136 282 222 q 284 65 282 97 q 293 -58 293 -48 q 241 -217 293 -166 q 0 -286 174 -286 l 0 -182 q 143 -130 105 -182 q 171 -2 171 -93 q 168 81 171 22 q 165 144 165 140 q 188 275 165 229 q 306 365 220 339 q 191 455 224 391 q 165 588 165 505 q 168 681 165 624 q 171 742 171 737 q 141 865 171 827 q 0 915 102 915 l 0 1015 q 243 942 176 1015 q 293 773 293 888 q 287 675 293 741 q 282 590 282 608 q 318 466 282 505 q 481 417 364 417 l 481 314 "},"â€°":{x_min:-3,x_max:1672,ha:1821,o:"m 846 0 q 664 76 732 0 q 603 244 603 145 q 662 412 603 344 q 846 489 729 489 q 1027 412 959 489 q 1089 244 1089 343 q 1029 76 1089 144 q 846 0 962 0 m 845 103 q 945 143 910 103 q 981 243 981 184 q 947 340 981 301 q 845 385 910 385 q 745 342 782 385 q 709 243 709 300 q 742 147 709 186 q 845 103 781 103 m 888 986 l 284 -25 l 199 -25 l 803 986 l 888 986 m 241 468 q 58 545 126 468 q -3 715 -3 615 q 56 881 -3 813 q 238 958 124 958 q 421 881 353 958 q 483 712 483 813 q 423 544 483 612 q 241 468 356 468 m 241 855 q 137 811 175 855 q 100 710 100 768 q 136 612 100 653 q 240 572 172 572 q 344 614 306 572 q 382 713 382 656 q 347 810 382 771 q 241 855 308 855 m 1428 0 q 1246 76 1314 0 q 1185 244 1185 145 q 1244 412 1185 344 q 1428 489 1311 489 q 1610 412 1542 489 q 1672 244 1672 343 q 1612 76 1672 144 q 1428 0 1545 0 m 1427 103 q 1528 143 1492 103 q 1564 243 1564 184 q 1530 340 1564 301 q 1427 385 1492 385 q 1327 342 1364 385 q 1291 243 1291 300 q 1324 147 1291 186 q 1427 103 1363 103 "},a:{x_min:0,x_max:698.609375,ha:794,o:"m 698 0 q 661 -12 679 -7 q 615 -17 643 -17 q 536 12 564 -17 q 500 96 508 41 q 384 6 456 37 q 236 -25 312 -25 q 65 31 130 -25 q 0 194 0 88 q 118 390 0 334 q 328 435 180 420 q 488 483 476 451 q 495 523 495 504 q 442 619 495 584 q 325 654 389 654 q 209 617 257 654 q 152 513 161 580 l 33 513 q 123 705 33 633 q 332 772 207 772 q 528 712 448 772 q 617 531 617 645 l 617 163 q 624 108 617 126 q 664 90 632 90 l 698 94 l 698 0 m 491 262 l 491 372 q 272 329 350 347 q 128 201 128 294 q 166 113 128 144 q 264 83 205 83 q 414 130 346 83 q 491 262 491 183 "},"â€”":{x_min:0,x_max:941.671875,ha:1039,o:"m 941 334 l 0 334 l 0 410 l 941 410 l 941 334 "},"=":{x_min:8.71875,x_max:780.953125,ha:792,o:"m 780 510 l 8 510 l 8 606 l 780 606 l 780 510 m 780 235 l 8 235 l 8 332 l 780 332 l 780 235 "},N:{x_min:0,x_max:801,ha:914,o:"m 801 0 l 651 0 l 131 823 l 131 0 l 0 0 l 0 1013 l 151 1013 l 670 193 l 670 1013 l 801 1013 l 801 0 "},"Ï":{x_min:0,x_max:712,ha:797,o:"m 712 369 q 620 94 712 207 q 362 -26 521 -26 q 230 2 292 -26 q 119 83 167 30 l 119 -278 l 0 -278 l 0 362 q 91 643 0 531 q 355 764 190 764 q 617 647 517 764 q 712 369 712 536 m 583 366 q 530 559 583 480 q 359 651 469 651 q 190 562 252 651 q 135 370 135 483 q 189 176 135 257 q 359 85 250 85 q 528 175 466 85 q 583 366 583 254 "},2:{x_min:59,x_max:731,ha:792,o:"m 731 0 l 59 0 q 197 314 59 188 q 457 487 199 315 q 598 691 598 580 q 543 819 598 772 q 411 867 488 867 q 272 811 328 867 q 209 630 209 747 l 81 630 q 182 901 81 805 q 408 986 271 986 q 629 909 536 986 q 731 694 731 826 q 613 449 731 541 q 378 316 495 383 q 201 122 235 234 l 731 122 l 731 0 "},"Â¯":{x_min:0,x_max:941.671875,ha:938,o:"m 941 1033 l 0 1033 l 0 1109 l 941 1109 l 941 1033 "},Z:{x_min:0,x_max:779,ha:849,o:"m 779 0 l 0 0 l 0 113 l 621 896 l 40 896 l 40 1013 l 779 1013 l 778 887 l 171 124 l 779 124 l 779 0 "},u:{x_min:0,x_max:617,ha:729,o:"m 617 0 l 499 0 l 499 110 q 391 10 460 45 q 246 -25 322 -25 q 61 58 127 -25 q 0 258 0 136 l 0 738 l 125 738 l 125 284 q 156 148 125 202 q 273 82 197 82 q 433 165 369 82 q 493 340 493 243 l 493 738 l 617 738 l 617 0 "},k:{x_min:0,x_max:612.484375,ha:697,o:"m 612 738 l 338 465 l 608 0 l 469 0 l 251 382 l 121 251 l 121 0 l 0 0 l 0 1013 l 121 1013 l 121 402 l 456 738 l 612 738 "},"Î—":{x_min:0,x_max:803,ha:917,
o:"m 803 0 l 667 0 l 667 475 l 140 475 l 140 0 l 0 0 l 0 1013 l 140 1013 l 140 599 l 667 599 l 667 1013 l 803 1013 l 803 0 "},"Î‘":{x_min:0,x_max:906.953125,ha:985,o:"m 906 0 l 756 0 l 650 303 l 251 303 l 143 0 l 0 0 l 376 1013 l 529 1013 l 906 0 m 609 421 l 452 866 l 293 421 l 609 421 "},s:{x_min:0,x_max:604,ha:697,o:"m 604 217 q 501 36 604 104 q 292 -23 411 -23 q 86 43 166 -23 q 0 238 0 114 l 121 237 q 175 122 121 164 q 300 85 223 85 q 415 112 363 85 q 479 207 479 147 q 361 309 479 276 q 140 372 141 370 q 21 544 21 426 q 111 708 21 647 q 298 761 190 761 q 492 705 413 761 q 583 531 583 643 l 462 531 q 412 625 462 594 q 298 657 363 657 q 199 636 242 657 q 143 558 143 608 q 262 454 143 486 q 484 394 479 397 q 604 217 604 341 "},B:{x_min:0,x_max:778,ha:876,o:"m 580 546 q 724 469 670 535 q 778 311 778 403 q 673 83 778 171 q 432 0 575 0 l 0 0 l 0 1013 l 411 1013 q 629 957 541 1013 q 732 768 732 892 q 691 633 732 693 q 580 546 650 572 m 393 899 l 139 899 l 139 588 l 379 588 q 521 624 462 588 q 592 744 592 667 q 531 859 592 819 q 393 899 471 899 m 419 124 q 566 169 504 124 q 635 303 635 219 q 559 436 635 389 q 402 477 494 477 l 139 477 l 139 124 l 419 124 "},"â€¦":{x_min:0,x_max:614,ha:708,o:"m 142 0 l 0 0 l 0 151 l 142 151 l 142 0 m 378 0 l 236 0 l 236 151 l 378 151 l 378 0 m 614 0 l 472 0 l 472 151 l 614 151 l 614 0 "},"?":{x_min:0,x_max:607,ha:704,o:"m 607 777 q 543 599 607 674 q 422 474 482 537 q 357 272 357 391 l 236 272 q 297 487 236 395 q 411 619 298 490 q 474 762 474 691 q 422 885 474 838 q 301 933 371 933 q 179 880 228 933 q 124 706 124 819 l 0 706 q 94 963 0 872 q 302 1044 177 1044 q 511 973 423 1044 q 607 777 607 895 m 370 0 l 230 0 l 230 151 l 370 151 l 370 0 "},H:{x_min:0,x_max:803,ha:915,o:"m 803 0 l 667 0 l 667 475 l 140 475 l 140 0 l 0 0 l 0 1013 l 140 1013 l 140 599 l 667 599 l 667 1013 l 803 1013 l 803 0 "},"Î½":{x_min:0,x_max:675,ha:761,o:"m 675 738 l 404 0 l 272 0 l 0 738 l 133 738 l 340 147 l 541 738 l 675 738 "},c:{x_min:1,x_max:701.390625,ha:775,o:"m 701 264 q 584 53 681 133 q 353 -26 487 -26 q 91 91 188 -26 q 1 370 1 201 q 92 645 1 537 q 353 761 190 761 q 572 688 479 761 q 690 493 666 615 l 556 493 q 487 606 545 562 q 356 650 428 650 q 186 563 246 650 q 134 372 134 487 q 188 179 134 258 q 359 88 250 88 q 492 136 437 88 q 566 264 548 185 l 701 264 "},"Â¶":{x_min:0,x_max:566.671875,ha:678,o:"m 21 892 l 52 892 l 98 761 l 145 892 l 176 892 l 178 741 l 157 741 l 157 867 l 108 741 l 88 741 l 40 871 l 40 741 l 21 741 l 21 892 m 308 854 l 308 731 q 252 691 308 691 q 227 691 240 691 q 207 696 213 695 l 207 712 l 253 706 q 288 733 288 706 l 288 763 q 244 741 279 741 q 193 797 193 741 q 261 860 193 860 q 287 860 273 860 q 308 854 302 855 m 288 842 l 263 843 q 213 796 213 843 q 248 756 213 756 q 288 796 288 756 l 288 842 m 566 988 l 502 988 l 502 -1 l 439 -1 l 439 988 l 317 988 l 317 -1 l 252 -1 l 252 602 q 81 653 155 602 q 0 805 0 711 q 101 989 0 918 q 309 1053 194 1053 l 566 1053 l 566 988 "},"Î²":{x_min:0,x_max:660,ha:745,o:"m 471 550 q 610 450 561 522 q 660 280 660 378 q 578 64 660 151 q 367 -22 497 -22 q 239 5 299 -22 q 126 82 178 32 l 126 -278 l 0 -278 l 0 593 q 54 903 0 801 q 318 1042 127 1042 q 519 964 436 1042 q 603 771 603 887 q 567 644 603 701 q 471 550 532 586 m 337 79 q 476 138 418 79 q 535 279 535 198 q 427 437 535 386 q 226 477 344 477 l 226 583 q 398 620 329 583 q 486 762 486 668 q 435 884 486 833 q 312 935 384 935 q 169 861 219 935 q 126 698 126 797 l 126 362 q 170 169 126 242 q 337 79 224 79 "},"Îœ":{x_min:0,x_max:954,ha:1068,o:"m 954 0 l 819 0 l 819 868 l 537 0 l 405 0 l 128 865 l 128 0 l 0 0 l 0 1013 l 199 1013 l 472 158 l 758 1013 l 954 1013 l 954 0 "},"ÎŒ":{x_min:.109375,x_max:1120,ha:1217,o:"m 1120 505 q 994 132 1120 282 q 642 -29 861 -29 q 290 130 422 -29 q 167 505 167 280 q 294 883 167 730 q 650 1046 430 1046 q 999 882 868 1046 q 1120 505 1120 730 m 977 504 q 896 784 977 669 q 644 915 804 915 q 391 785 484 915 q 307 504 307 669 q 391 224 307 339 q 644 95 486 95 q 894 224 803 95 q 977 504 977 339 m 277 1040 l 83 799 l 0 799 l 140 1040 l 277 1040 "},"Î‰":{x_min:0,x_max:1158,ha:1275,o:"m 1158 0 l 1022 0 l 1022 475 l 496 475 l 496 0 l 356 0 l 356 1012 l 496 1012 l 496 599 l 1022 599 l 1022 1012 l 1158 1012 l 1158 0 m 277 1040 l 83 799 l 0 799 l 140 1040 l 277 1040 "},"â€¢":{x_min:0,x_max:663.890625,ha:775,o:"m 663 529 q 566 293 663 391 q 331 196 469 196 q 97 294 194 196 q 0 529 0 393 q 96 763 0 665 q 331 861 193 861 q 566 763 469 861 q 663 529 663 665 "},"Â¥":{x_min:.1875,x_max:819.546875,ha:886,o:"m 563 561 l 697 561 l 696 487 l 520 487 l 482 416 l 482 380 l 697 380 l 695 308 l 482 308 l 482 0 l 342 0 l 342 308 l 125 308 l 125 380 l 342 380 l 342 417 l 303 487 l 125 487 l 125 561 l 258 561 l 0 1013 l 140 1013 l 411 533 l 679 1013 l 819 1013 l 563 561 "},"(":{x_min:0,x_max:318.0625,ha:415,o:"m 318 -290 l 230 -290 q 61 23 122 -142 q 0 365 0 190 q 62 712 0 540 q 230 1024 119 869 l 318 1024 q 175 705 219 853 q 125 360 125 542 q 176 22 125 187 q 318 -290 223 -127 "},U:{x_min:0,x_max:796,ha:904,o:"m 796 393 q 681 93 796 212 q 386 -25 566 -25 q 101 95 208 -25 q 0 393 0 211 l 0 1013 l 138 1013 l 138 391 q 204 191 138 270 q 394 107 276 107 q 586 191 512 107 q 656 391 656 270 l 656 1013 l 796 1013 l 796 393 "},"Î³":{x_min:.5,x_max:744.953125,ha:822,o:"m 744 737 l 463 54 l 463 -278 l 338 -278 l 338 54 l 154 495 q 104 597 124 569 q 13 651 67 651 l 0 651 l 0 751 l 39 753 q 168 711 121 753 q 242 594 207 676 l 403 208 l 617 737 l 744 737 "},"Î±":{x_min:0,x_max:765.5625,ha:809,o:"m 765 -4 q 698 -14 726 -14 q 564 97 586 -14 q 466 7 525 40 q 337 -26 407 -26 q 88 98 186 -26 q 0 369 0 212 q 88 637 0 525 q 337 760 184 760 q 465 728 407 760 q 563 637 524 696 l 563 739 l 685 739 l 685 222 q 693 141 685 168 q 748 94 708 94 q 765 96 760 94 l 765 -4 m 584 371 q 531 562 584 485 q 360 653 470 653 q 192 566 254 653 q 135 379 135 489 q 186 181 135 261 q 358 84 247 84 q 528 176 465 84 q 584 371 584 260 "},F:{x_min:0,x_max:683.328125,ha:717,o:"m 683 888 l 140 888 l 140 583 l 613 583 l 613 458 l 140 458 l 140 0 l 0 0 l 0 1013 l 683 1013 l 683 888 "},"Â­":{x_min:0,x_max:705.5625,ha:803,o:"m 705 334 l 0 334 l 0 410 l 705 410 l 705 334 "},":":{x_min:0,x_max:142,ha:239,o:"m 142 585 l 0 585 l 0 738 l 142 738 l 142 585 m 142 0 l 0 0 l 0 151 l 142 151 l 142 0 "},"Î§":{x_min:0,x_max:854.171875,ha:935,o:"m 854 0 l 683 0 l 423 409 l 166 0 l 0 0 l 347 519 l 18 1013 l 186 1013 l 427 637 l 675 1013 l 836 1013 l 504 521 l 854 0 "},"*":{x_min:116,x_max:674,ha:792,o:"m 674 768 l 475 713 l 610 544 l 517 477 l 394 652 l 272 478 l 178 544 l 314 713 l 116 766 l 153 876 l 341 812 l 342 1013 l 446 1013 l 446 811 l 635 874 l 674 768 "},"â€ ":{x_min:0,x_max:777,ha:835,o:"m 458 804 l 777 804 l 777 683 l 458 683 l 458 0 l 319 0 l 319 681 l 0 683 l 0 804 l 319 804 l 319 1015 l 458 1013 l 458 804 "},"Â°":{x_min:0,x_max:347,ha:444,o:"m 173 802 q 43 856 91 802 q 0 977 0 905 q 45 1101 0 1049 q 173 1153 90 1153 q 303 1098 255 1153 q 347 977 347 1049 q 303 856 347 905 q 173 802 256 802 m 173 884 q 238 910 214 884 q 262 973 262 937 q 239 1038 262 1012 q 173 1064 217 1064 q 108 1037 132 1064 q 85 973 85 1010 q 108 910 85 937 q 173 884 132 884 "},V:{x_min:0,x_max:862.71875,ha:940,o:"m 862 1013 l 505 0 l 361 0 l 0 1013 l 143 1013 l 434 165 l 718 1012 l 862 1013 "},"Îž":{x_min:0,x_max:734.71875,ha:763,o:"m 723 889 l 9 889 l 9 1013 l 723 1013 l 723 889 m 673 463 l 61 463 l 61 589 l 673 589 l 673 463 m 734 0 l 0 0 l 0 124 l 734 124 l 734 0 "},"Â ":{x_min:0,x_max:0,ha:853},"Î«":{x_min:.328125,x_max:819.515625,ha:889,o:"m 588 1046 l 460 1046 l 460 1189 l 588 1189 l 588 1046 m 360 1046 l 232 1046 l 232 1189 l 360 1189 l 360 1046 m 819 1012 l 482 416 l 482 0 l 342 0 l 342 416 l 0 1012 l 140 1012 l 411 533 l 679 1012 l 819 1012 "},0:{x_min:73,x_max:715,ha:792,o:"m 394 -29 q 153 129 242 -29 q 73 479 73 272 q 152 829 73 687 q 394 989 241 989 q 634 829 545 989 q 715 479 715 684 q 635 129 715 270 q 394 -29 546 -29 m 394 89 q 546 211 489 89 q 598 479 598 322 q 548 748 598 640 q 394 871 491 871 q 241 748 298 871 q 190 479 190 637 q 239 211 190 319 q 394 89 296 89 "},"â€":{x_min:0,x_max:347,ha:454,o:"m 139 851 q 102 737 139 784 q 0 669 65 690 l 0 734 q 59 787 42 741 q 72 873 72 821 l 0 873 l 0 1013 l 139 1013 l 139 851 m 347 851 q 310 737 347 784 q 208 669 273 690 l 208 734 q 267 787 250 741 q 280 873 280 821 l 208 873 l 208 1013 l 347 1013 l 347 851 "},"@":{x_min:0,x_max:1260,ha:1357,o:"m 1098 -45 q 877 -160 1001 -117 q 633 -203 752 -203 q 155 -29 327 -203 q 0 360 0 127 q 176 802 0 616 q 687 1008 372 1008 q 1123 854 969 1008 q 1260 517 1260 718 q 1155 216 1260 341 q 868 82 1044 82 q 772 106 801 82 q 737 202 737 135 q 647 113 700 144 q 527 82 594 82 q 367 147 420 82 q 314 312 314 212 q 401 565 314 452 q 639 690 498 690 q 810 588 760 690 l 849 668 l 938 668 q 877 441 900 532 q 833 226 833 268 q 853 182 833 198 q 902 167 873 167 q 1088 272 1012 167 q 1159 512 1159 372 q 1051 793 1159 681 q 687 925 925 925 q 248 747 415 925 q 97 361 97 586 q 226 26 97 159 q 627 -122 370 -122 q 856 -87 737 -122 q 1061 8 976 -53 l 1098 -45 m 786 488 q 738 580 777 545 q 643 615 700 615 q 483 517 548 615 q 425 322 425 430 q 457 203 425 250 q 552 156 490 156 q 722 273 665 156 q 786 488 738 309 "},"ÎŠ":{x_min:0,x_max:499,ha:613,o:"m 277 1040 l 83 799 l 0 799 l 140 1040 l 277 1040 m 499 0 l 360 0 l 360 1012 l 499 1012 l 499 0 "},i:{x_min:14,x_max:136,ha:275,o:"m 136 873 l 14 873 l 14 1013 l 136 1013 l 136 873 m 136 0 l 14 0 l 14 737 l 136 737 l 136 0 "},"Î’":{x_min:0,x_max:778,ha:877,o:"m 580 545 q 724 468 671 534 q 778 310 778 402 q 673 83 778 170 q 432 0 575 0 l 0 0 l 0 1013 l 411 1013 q 629 957 541 1013 q 732 768 732 891 q 691 632 732 692 q 580 545 650 571 m 393 899 l 139 899 l 139 587 l 379 587 q 521 623 462 587 q 592 744 592 666 q 531 859 592 819 q 393 899 471 899 m 419 124 q 566 169 504 124 q 635 302 635 219 q 559 435 635 388 q 402 476 494 476 l 139 476 l 139 124 l 419 124 "},"Ï…":{x_min:0,x_max:617,ha:725,o:"m 617 352 q 540 94 617 199 q 308 -24 455 -24 q 76 94 161 -24 q 0 352 0 199 l 0 739 l 126 739 l 126 355 q 169 185 126 257 q 312 98 220 98 q 451 185 402 98 q 492 355 492 257 l 492 739 l 617 739 l 617 352 "},"]":{x_min:0,x_max:275,ha:372,o:"m 275 -281 l 0 -281 l 0 -187 l 151 -187 l 151 920 l 0 920 l 0 1013 l 275 1013 l 275 -281 "},m:{x_min:0,x_max:1019,ha:1128,o:"m 1019 0 l 897 0 l 897 454 q 860 591 897 536 q 739 660 816 660 q 613 586 659 660 q 573 436 573 522 l 573 0 l 447 0 l 447 455 q 412 591 447 535 q 294 657 372 657 q 165 586 213 657 q 122 437 122 521 l 122 0 l 0 0 l 0 738 l 117 738 l 117 640 q 202 730 150 697 q 316 763 254 763 q 437 730 381 763 q 525 642 494 697 q 621 731 559 700 q 753 763 682 763 q 943 694 867 763 q 1019 512 1019 625 l 1019 0 "},"Ï‡":{x_min:8.328125,x_max:780.5625,ha:815,o:"m 780 -278 q 715 -294 747 -294 q 616 -257 663 -294 q 548 -175 576 -227 l 379 133 l 143 -277 l 9 -277 l 313 254 l 163 522 q 127 586 131 580 q 36 640 91 640 q 8 637 27 640 l 8 752 l 52 757 q 162 719 113 757 q 236 627 200 690 l 383 372 l 594 737 l 726 737 l 448 250 l 625 -69 q 670 -153 647 -110 q 743 -188 695 -188 q 780 -184 759 -188 l 780 -278 "},8:{x_min:55,x_max:736,ha:792,o:"m 571 527 q 694 424 652 491 q 736 280 736 358 q 648 71 736 158 q 395 -26 551 -26 q 142 69 238 -26 q 55 279 55 157 q 96 425 55 359 q 220 527 138 491 q 120 615 153 562 q 88 726 88 668 q 171 904 88 827 q 395 986 261 986 q 618 905 529 986 q 702 727 702 830 q 670 616 702 667 q 571 527 638 565 m 394 565 q 519 610 475 565 q 563 717 563 655 q 521 823 563 781 q 392 872 474 872 q 265 824 312 872 q 224 720 224 783 q 265 613 224 656 q 394 565 312 565 m 395 91 q 545 150 488 91 q 597 280 597 204 q 546 408 597 355 q 395 465 492 465 q 244 408 299 465 q 194 280 194 356 q 244 150 194 203 q 395 91 299 91 "},"Î¯":{x_min:42,x_max:326.71875,ha:361,o:"m 284 3 q 233 -10 258 -5 q 182 -15 207 -15 q 85 26 119 -15 q 42 200 42 79 l 42 737 l 167 737 l 168 215 q 172 141 168 157 q 226 101 183 101 q 248 102 239 101 q 284 112 257 104 l 284 3 m 326 1040 l 137 819 l 54 819 l 189 1040 l 326 1040 "},"Î–":{x_min:0,x_max:779.171875,ha:850,o:"m 779 0 l 0 0 l 0 113 l 620 896 l 40 896 l 40 1013 l 779 1013 l 779 887 l 170 124 l 779 124 l 779 0 "},R:{x_min:0,x_max:781.953125,ha:907,o:"m 781 0 l 623 0 q 587 242 590 52 q 407 433 585 433 l 138 433 l 138 0 l 0 0 l 0 1013 l 396 1013 q 636 946 539 1013 q 749 731 749 868 q 711 597 749 659 q 608 502 674 534 q 718 370 696 474 q 729 207 722 352 q 781 26 736 62 l 781 0 m 373 551 q 533 594 465 551 q 614 731 614 645 q 532 859 614 815 q 373 896 465 896 l 138 896 l 138 551 l 373 551 "},o:{x_min:0,x_max:713,ha:821,o:"m 357 -25 q 94 91 194 -25 q 0 368 0 202 q 93 642 0 533 q 357 761 193 761 q 618 644 518 761 q 713 368 713 533 q 619 91 713 201 q 357 -25 521 -25 m 357 85 q 528 175 465 85 q 584 369 584 255 q 529 562 584 484 q 357 651 467 651 q 189 560 250 651 q 135 369 135 481 q 187 177 135 257 q 357 85 250 85 "},5:{x_min:54.171875,x_max:738,ha:792,o:"m 738 314 q 626 60 738 153 q 382 -23 526 -23 q 155 47 248 -23 q 54 256 54 125 l 183 256 q 259 132 204 174 q 382 91 314 91 q 533 149 471 91 q 602 314 602 213 q 538 469 602 411 q 386 528 475 528 q 284 506 332 528 q 197 439 237 484 l 81 439 l 159 958 l 684 958 l 684 840 l 254 840 l 214 579 q 306 627 258 612 q 407 643 354 643 q 636 552 540 643 q 738 314 738 457 "},7:{x_min:58.71875,x_max:730.953125,ha:792,o:"m 730 839 q 469 448 560 641 q 335 0 378 255 l 192 0 q 328 441 235 252 q 593 830 421 630 l 58 830 l 58 958 l 730 958 l 730 839 "},K:{x_min:0,x_max:819.46875,ha:906,o:"m 819 0 l 649 0 l 294 509 l 139 355 l 139 0 l 0 0 l 0 1013 l 139 1013 l 139 526 l 626 1013 l 809 1013 l 395 600 l 819 0 "},",":{x_min:0,x_max:142,ha:239,o:"m 142 -12 q 105 -132 142 -82 q 0 -205 68 -182 l 0 -138 q 57 -82 40 -124 q 70 0 70 -51 l 0 0 l 0 151 l 142 151 l 142 -12 "},d:{x_min:0,x_max:683,ha:796,o:"m 683 0 l 564 0 l 564 93 q 456 6 516 38 q 327 -25 395 -25 q 87 100 181 -25 q 0 365 0 215 q 90 639 0 525 q 343 763 187 763 q 564 647 486 763 l 564 1013 l 683 1013 l 683 0 m 582 373 q 529 562 582 484 q 361 653 468 653 q 190 561 253 653 q 135 365 135 479 q 189 175 135 254 q 358 85 251 85 q 529 178 468 85 q 582 373 582 258 "},"Â¨":{x_min:-109,x_max:247,ha:232,o:"m 247 1046 l 119 1046 l 119 1189 l 247 1189 l 247 1046 m 19 1046 l -109 1046 l -109 1189 l 19 1189 l 19 1046 "},E:{x_min:0,x_max:736.109375,ha:789,o:"m 736 0 l 0 0 l 0 1013 l 725 1013 l 725 889 l 139 889 l 139 585 l 677 585 l 677 467 l 139 467 l 139 125 l 736 125 l 736 0 "},Y:{x_min:0,x_max:820,ha:886,o:"m 820 1013 l 482 416 l 482 0 l 342 0 l 342 416 l 0 1013 l 140 1013 l 411 534 l 679 1012 l 820 1013 "},'"':{x_min:0,x_max:299,ha:396,o:"m 299 606 l 203 606 l 203 988 l 299 988 l 299 606 m 96 606 l 0 606 l 0 988 l 96 988 l 96 606 "},"â€¹":{x_min:17.984375,x_max:773.609375,ha:792,o:"m 773 40 l 18 376 l 17 465 l 773 799 l 773 692 l 159 420 l 773 149 l 773 40 "},"â€ž":{x_min:0,x_max:364,ha:467,o:"m 141 -12 q 104 -132 141 -82 q 0 -205 67 -182 l 0 -138 q 56 -82 40 -124 q 69 0 69 -51 l 0 0 l 0 151 l 141 151 l 141 -12 m 364 -12 q 327 -132 364 -82 q 222 -205 290 -182 l 222 -138 q 279 -82 262 -124 q 292 0 292 -51 l 222 0 l 222 151 l 364 151 l 364 -12 "},"Î´":{x_min:1,x_max:710,ha:810,o:"m 710 360 q 616 87 710 196 q 356 -28 518 -28 q 99 82 197 -28 q 1 356 1 192 q 100 606 1 509 q 355 703 199 703 q 180 829 288 754 q 70 903 124 866 l 70 1012 l 643 1012 l 643 901 l 258 901 q 462 763 422 794 q 636 592 577 677 q 710 360 710 485 m 584 365 q 552 501 584 447 q 451 602 521 555 q 372 611 411 611 q 197 541 258 611 q 136 355 136 472 q 190 171 136 245 q 358 85 252 85 q 528 173 465 85 q 584 365 584 252 "},"Î­":{x_min:0,x_max:634.71875,ha:714,o:"m 634 234 q 527 38 634 110 q 300 -25 433 -25 q 98 29 183 -25 q 0 204 0 93 q 37 313 0 265 q 128 390 67 352 q 56 459 82 419 q 26 555 26 505 q 114 712 26 654 q 295 763 191 763 q 499 700 416 763 q 589 515 589 631 l 478 515 q 419 618 464 580 q 307 657 374 657 q 207 630 253 657 q 151 547 151 598 q 238 445 151 469 q 389 434 280 434 l 389 331 l 349 331 q 206 315 255 331 q 125 210 125 287 q 183 107 125 145 q 302 76 233 76 q 436 117 379 76 q 509 234 493 159 l 634 234 m 520 1040 l 331 819 l 248 819 l 383 1040 l 520 1040 "},"Ï‰":{x_min:0,x_max:922,ha:1031,o:"m 922 339 q 856 97 922 203 q 650 -26 780 -26 q 538 9 587 -26 q 461 103 489 44 q 387 12 436 46 q 277 -22 339 -22 q 69 97 147 -22 q 0 339 0 203 q 45 551 0 444 q 161 738 84 643 l 302 738 q 175 553 219 647 q 124 336 124 446 q 155 179 124 249 q 275 88 197 88 q 375 163 341 88 q 400 294 400 219 l 400 572 l 524 572 l 524 294 q 561 135 524 192 q 643 88 591 88 q 762 182 719 88 q 797 342 797 257 q 745 556 797 450 q 619 738 705 638 l 760 738 q 874 551 835 640 q 922 339 922 444 "},"Â´":{x_min:0,x_max:96,ha:251,o:"m 96 606 l 0 606 l 0 988 l 96 988 l 96 606 "},"Â±":{x_min:11,x_max:781,ha:792,o:"m 781 490 l 446 490 l 446 255 l 349 255 l 349 490 l 11 490 l 11 586 l 349 586 l 349 819 l 446 819 l 446 586 l 781 586 l 781 490 m 781 21 l 11 21 l 11 115 l 781 115 l 781 21 "},"|":{x_min:343,x_max:449,ha:792,o:"m 449 462 l 343 462 l 343 986 l 449 986 l 449 462 m 449 -242 l 343 -242 l 343 280 l 449 280 l 449 -242 "},"Ï‹":{x_min:0,x_max:617,ha:725,o:"m 482 800 l 372 800 l 372 925 l 482 925 l 482 800 m 239 800 l 129 800 l 129 925 l 239 925 l 239 800 m 617 352 q 540 93 617 199 q 308 -24 455 -24 q 76 93 161 -24 q 0 352 0 199 l 0 738 l 126 738 l 126 354 q 169 185 126 257 q 312 98 220 98 q 451 185 402 98 q 492 354 492 257 l 492 738 l 617 738 l 617 352 "},"Â§":{x_min:0,x_max:593,ha:690,o:"m 593 425 q 554 312 593 369 q 467 233 516 254 q 537 83 537 172 q 459 -74 537 -12 q 288 -133 387 -133 q 115 -69 184 -133 q 47 96 47 -6 l 166 96 q 199 7 166 40 q 288 -26 232 -26 q 371 -5 332 -26 q 420 60 420 21 q 311 201 420 139 q 108 309 210 255 q 0 490 0 383 q 33 602 0 551 q 124 687 66 654 q 75 743 93 712 q 58 812 58 773 q 133 984 58 920 q 300 1043 201 1043 q 458 987 394 1043 q 529 814 529 925 l 411 814 q 370 908 404 877 q 289 939 336 939 q 213 911 246 939 q 180 841 180 883 q 286 720 180 779 q 484 612 480 615 q 593 425 593 534 m 467 409 q 355 544 467 473 q 196 630 228 612 q 146 587 162 609 q 124 525 124 558 q 239 387 124 462 q 398 298 369 315 q 448 345 429 316 q 467 409 467 375 "},b:{x_min:0,x_max:685,ha:783,o:"m 685 372 q 597 99 685 213 q 347 -25 501 -25 q 219 5 277 -25 q 121 93 161 36 l 121 0 l 0 0 l 0 1013 l 121 1013 l 121 634 q 214 723 157 692 q 341 754 272 754 q 591 637 493 754 q 685 372 685 526 m 554 356 q 499 550 554 470 q 328 644 437 644 q 162 556 223 644 q 108 369 108 478 q 160 176 108 256 q 330 83 221 83 q 498 169 435 83 q 554 356 554 245 "},q:{x_min:0,x_max:683,ha:876,o:"m 683 -278 l 564 -278 l 564 97 q 474 8 533 39 q 345 -23 415 -23 q 91 93 188 -23 q 0 364 0 203 q 87 635 0 522 q 337 760 184 760 q 466 727 408 760 q 564 637 523 695 l 564 737 l 683 737 l 683 -278 m 582 375 q 527 564 582 488 q 358 652 466 652 q 190 565 253 652 q 135 377 135 488 q 189 179 135 261 q 361 84 251 84 q 530 179 469 84 q 582 375 582 260 "},"Î©":{x_min:-.171875,x_max:969.5625,ha:1068,o:"m 969 0 l 555 0 l 555 123 q 744 308 675 194 q 814 558 814 423 q 726 812 814 709 q 484 922 633 922 q 244 820 334 922 q 154 567 154 719 q 223 316 154 433 q 412 123 292 199 l 412 0 l 0 0 l 0 124 l 217 124 q 68 327 122 210 q 15 572 15 444 q 144 911 15 781 q 484 1041 274 1041 q 822 909 691 1041 q 953 569 953 777 q 899 326 953 443 q 750 124 846 210 l 969 124 l 969 0 "},"Ï":{x_min:0,x_max:617,ha:725,o:"m 617 352 q 540 93 617 199 q 308 -24 455 -24 q 76 93 161 -24 q 0 352 0 199 l 0 738 l 126 738 l 126 354 q 169 185 126 257 q 312 98 220 98 q 451 185 402 98 q 492 354 492 257 l 492 738 l 617 738 l 617 352 m 535 1040 l 346 819 l 262 819 l 397 1040 l 535 1040 "},z:{x_min:-.015625,x_max:613.890625,ha:697,o:"m 613 0 l 0 0 l 0 100 l 433 630 l 20 630 l 20 738 l 594 738 l 593 636 l 163 110 l 613 110 l 613 0 "},"â„¢":{x_min:0,x_max:894,ha:1e3,o:"m 389 951 l 229 951 l 229 503 l 160 503 l 160 951 l 0 951 l 0 1011 l 389 1011 l 389 951 m 894 503 l 827 503 l 827 939 l 685 503 l 620 503 l 481 937 l 481 503 l 417 503 l 417 1011 l 517 1011 l 653 580 l 796 1010 l 894 1011 l 894 503 "},"Î®":{x_min:.78125,x_max:697,ha:810,o:"m 697 -278 l 572 -278 l 572 454 q 540 587 572 536 q 425 650 501 650 q 271 579 337 650 q 206 420 206 509 l 206 0 l 81 0 l 81 489 q 73 588 81 562 q 0 644 56 644 l 0 741 q 68 755 38 755 q 158 721 124 755 q 200 630 193 687 q 297 726 234 692 q 434 761 359 761 q 620 692 544 761 q 697 516 697 624 l 697 -278 m 479 1040 l 290 819 l 207 819 l 341 1040 l 479 1040 "},"Î˜":{x_min:0,x_max:960,ha:1056,o:"m 960 507 q 833 129 960 280 q 476 -32 698 -32 q 123 129 255 -32 q 0 507 0 280 q 123 883 0 732 q 476 1045 255 1045 q 832 883 696 1045 q 960 507 960 732 m 817 500 q 733 789 817 669 q 476 924 639 924 q 223 792 317 924 q 142 507 142 675 q 222 222 142 339 q 476 89 315 89 q 730 218 636 89 q 817 500 817 334 m 716 449 l 243 449 l 243 571 l 716 571 l 716 449 "},"Â®":{x_min:-3,x_max:1008,ha:1106,o:"m 503 532 q 614 562 566 532 q 672 658 672 598 q 614 747 672 716 q 503 772 569 772 l 338 772 l 338 532 l 503 532 m 502 -7 q 123 151 263 -7 q -3 501 -3 294 q 123 851 -3 706 q 502 1011 263 1011 q 881 851 739 1011 q 1008 501 1008 708 q 883 151 1008 292 q 502 -7 744 -7 m 502 60 q 830 197 709 60 q 940 501 940 322 q 831 805 940 681 q 502 944 709 944 q 174 805 296 944 q 65 501 65 680 q 173 197 65 320 q 502 60 294 60 m 788 146 l 678 146 q 653 316 655 183 q 527 449 652 449 l 338 449 l 338 146 l 241 146 l 241 854 l 518 854 q 688 808 621 854 q 766 658 766 755 q 739 563 766 607 q 668 497 713 519 q 751 331 747 472 q 788 164 756 190 l 788 146 "},"~":{x_min:0,x_max:833,ha:931,o:"m 833 958 q 778 753 833 831 q 594 665 716 665 q 402 761 502 665 q 240 857 302 857 q 131 795 166 857 q 104 665 104 745 l 0 665 q 54 867 0 789 q 237 958 116 958 q 429 861 331 958 q 594 765 527 765 q 704 827 670 765 q 729 958 729 874 l 833 958 "},"Î•":{x_min:0,x_max:736.21875,ha:778,o:"m 736 0 l 0 0 l 0 1013 l 725 1013 l 725 889 l 139 889 l 139 585 l 677 585 l 677 467 l 139 467 l 139 125 l 736 125 l 736 0 "},"Â³":{x_min:0,x_max:450,ha:547,o:"m 450 552 q 379 413 450 464 q 220 366 313 366 q 69 414 130 366 q 0 567 0 470 l 85 567 q 126 470 85 504 q 225 437 168 437 q 320 467 280 437 q 360 552 360 498 q 318 632 360 608 q 213 657 276 657 q 195 657 203 657 q 176 657 181 657 l 176 722 q 279 733 249 722 q 334 815 334 752 q 300 881 334 856 q 220 907 267 907 q 133 875 169 907 q 97 781 97 844 l 15 781 q 78 926 15 875 q 220 972 135 972 q 364 930 303 972 q 426 817 426 888 q 344 697 426 733 q 421 642 392 681 q 450 552 450 603 "},"[":{x_min:0,x_max:273.609375,ha:371,o:"m 273 -281 l 0 -281 l 0 1013 l 273 1013 l 273 920 l 124 920 l 124 -187 l 273 -187 l 273 -281 "},L:{x_min:0,x_max:645.828125,ha:696,o:"m 645 0 l 0 0 l 0 1013 l 140 1013 l 140 126 l 645 126 l 645 0 "},"Ïƒ":{x_min:0,x_max:803.390625,ha:894,o:"m 803 628 l 633 628 q 713 368 713 512 q 618 93 713 204 q 357 -25 518 -25 q 94 91 194 -25 q 0 368 0 201 q 94 644 0 533 q 356 761 194 761 q 481 750 398 761 q 608 739 564 739 l 803 739 l 803 628 m 360 85 q 529 180 467 85 q 584 374 584 262 q 527 566 584 490 q 352 651 463 651 q 187 559 247 651 q 135 368 135 478 q 189 175 135 254 q 360 85 251 85 "},"Î¶":{x_min:0,x_max:573,ha:642,o:"m 573 -40 q 553 -162 573 -97 q 510 -278 543 -193 l 400 -278 q 441 -187 428 -219 q 462 -90 462 -132 q 378 -14 462 -14 q 108 45 197 -14 q 0 290 0 117 q 108 631 0 462 q 353 901 194 767 l 55 901 l 55 1012 l 561 1012 l 561 924 q 261 669 382 831 q 128 301 128 489 q 243 117 128 149 q 458 98 350 108 q 573 -40 573 80 "},"Î¸":{x_min:0,x_max:674,ha:778,o:"m 674 496 q 601 160 674 304 q 336 -26 508 -26 q 73 153 165 -26 q 0 485 0 296 q 72 840 0 683 q 343 1045 166 1045 q 605 844 516 1045 q 674 496 674 692 m 546 579 q 498 798 546 691 q 336 935 437 935 q 178 798 237 935 q 126 579 137 701 l 546 579 m 546 475 l 126 475 q 170 233 126 348 q 338 80 230 80 q 504 233 447 80 q 546 475 546 346 "},"ÎŸ":{x_min:0,x_max:958,ha:1054,o:"m 485 1042 q 834 883 703 1042 q 958 511 958 735 q 834 136 958 287 q 481 -26 701 -26 q 126 130 261 -26 q 0 504 0 279 q 127 880 0 729 q 485 1042 263 1042 m 480 98 q 731 225 638 98 q 815 504 815 340 q 733 783 815 670 q 480 913 640 913 q 226 785 321 913 q 142 504 142 671 q 226 224 142 339 q 480 98 319 98 "},"Î“":{x_min:0,x_max:705.28125,ha:749,o:"m 705 886 l 140 886 l 140 0 l 0 0 l 0 1012 l 705 1012 l 705 886 "}," ":{x_min:0,x_max:0,ha:375},"%":{x_min:-3,x_max:1089,ha:1186,o:"m 845 0 q 663 76 731 0 q 602 244 602 145 q 661 412 602 344 q 845 489 728 489 q 1027 412 959 489 q 1089 244 1089 343 q 1029 76 1089 144 q 845 0 962 0 m 844 103 q 945 143 909 103 q 981 243 981 184 q 947 340 981 301 q 844 385 909 385 q 744 342 781 385 q 708 243 708 300 q 741 147 708 186 q 844 103 780 103 m 888 986 l 284 -25 l 199 -25 l 803 986 l 888 986 m 241 468 q 58 545 126 468 q -3 715 -3 615 q 56 881 -3 813 q 238 958 124 958 q 421 881 353 958 q 483 712 483 813 q 423 544 483 612 q 241 468 356 468 m 241 855 q 137 811 175 855 q 100 710 100 768 q 136 612 100 653 q 240 572 172 572 q 344 614 306 572 q 382 713 382 656 q 347 810 382 771 q 241 855 308 855 "},P:{x_min:0,x_max:726,ha:806,o:"m 424 1013 q 640 931 555 1013 q 726 719 726 850 q 637 506 726 587 q 413 426 548 426 l 140 426 l 140 0 l 0 0 l 0 1013 l 424 1013 m 379 889 l 140 889 l 140 548 l 372 548 q 522 589 459 548 q 593 720 593 637 q 528 845 593 801 q 379 889 463 889 "},"Îˆ":{x_min:0,x_max:1078.21875,ha:1118,o:"m 1078 0 l 342 0 l 342 1013 l 1067 1013 l 1067 889 l 481 889 l 481 585 l 1019 585 l 1019 467 l 481 467 l 481 125 l 1078 125 l 1078 0 m 277 1040 l 83 799 l 0 799 l 140 1040 l 277 1040 "},"Î":{x_min:.125,x_max:1136.546875,ha:1235,o:"m 1136 0 l 722 0 l 722 123 q 911 309 842 194 q 981 558 981 423 q 893 813 981 710 q 651 923 800 923 q 411 821 501 923 q 321 568 321 720 q 390 316 321 433 q 579 123 459 200 l 579 0 l 166 0 l 166 124 l 384 124 q 235 327 289 210 q 182 572 182 444 q 311 912 182 782 q 651 1042 441 1042 q 989 910 858 1042 q 1120 569 1120 778 q 1066 326 1120 443 q 917 124 1013 210 l 1136 124 l 1136 0 m 277 1040 l 83 800 l 0 800 l 140 1041 l 277 1040 "},_:{x_min:0,x_max:705.5625,ha:803,o:"m 705 -334 l 0 -334 l 0 -234 l 705 -234 l 705 -334 "},"Îª":{x_min:-110,x_max:246,ha:275,o:"m 246 1046 l 118 1046 l 118 1189 l 246 1189 l 246 1046 m 18 1046 l -110 1046 l -110 1189 l 18 1189 l 18 1046 m 136 0 l 0 0 l 0 1012 l 136 1012 l 136 0 "},"+":{x_min:23,x_max:768,ha:792,o:"m 768 372 l 444 372 l 444 0 l 347 0 l 347 372 l 23 372 l 23 468 l 347 468 l 347 840 l 444 840 l 444 468 l 768 468 l 768 372 "},"Â½":{x_min:0,x_max:1050,ha:1149,o:"m 1050 0 l 625 0 q 712 178 625 108 q 878 277 722 187 q 967 385 967 328 q 932 456 967 429 q 850 484 897 484 q 759 450 798 484 q 721 352 721 416 l 640 352 q 706 502 640 448 q 851 551 766 551 q 987 509 931 551 q 1050 385 1050 462 q 976 251 1050 301 q 829 179 902 215 q 717 68 740 133 l 1050 68 l 1050 0 m 834 985 l 215 -28 l 130 -28 l 750 984 l 834 985 m 224 422 l 142 422 l 142 811 l 0 811 l 0 867 q 104 889 62 867 q 164 973 157 916 l 224 973 l 224 422 "},"Î¡":{x_min:0,x_max:720,ha:783,o:"m 424 1013 q 637 933 554 1013 q 720 723 720 853 q 633 508 720 591 q 413 426 546 426 l 140 426 l 140 0 l 0 0 l 0 1013 l 424 1013 m 378 889 l 140 889 l 140 548 l 371 548 q 521 589 458 548 q 592 720 592 637 q 527 845 592 801 q 378 889 463 889 "},"'":{x_min:0,x_max:139,ha:236,o:"m 139 851 q 102 737 139 784 q 0 669 65 690 l 0 734 q 59 787 42 741 q 72 873 72 821 l 0 873 l 0 1013 l 139 1013 l 139 851 "},"Âª":{x_min:0,x_max:350,ha:397,o:"m 350 625 q 307 616 328 616 q 266 631 281 616 q 247 673 251 645 q 190 628 225 644 q 116 613 156 613 q 32 641 64 613 q 0 722 0 669 q 72 826 0 800 q 247 866 159 846 l 247 887 q 220 934 247 916 q 162 953 194 953 q 104 934 129 953 q 76 882 80 915 l 16 882 q 60 976 16 941 q 166 1011 104 1011 q 266 979 224 1011 q 308 891 308 948 l 308 706 q 311 679 308 688 q 331 670 315 670 l 350 672 l 350 625 m 247 757 l 247 811 q 136 790 175 798 q 64 726 64 773 q 83 682 64 697 q 132 667 103 667 q 207 690 174 667 q 247 757 247 718 "},"Î…":{x_min:0,x_max:450,ha:553,o:"m 450 800 l 340 800 l 340 925 l 450 925 l 450 800 m 406 1040 l 212 800 l 129 800 l 269 1040 l 406 1040 m 110 800 l 0 800 l 0 925 l 110 925 l 110 800 "},T:{x_min:0,x_max:777,ha:835,o:"m 777 894 l 458 894 l 458 0 l 319 0 l 319 894 l 0 894 l 0 1013 l 777 1013 l 777 894 "},"Î¦":{x_min:0,x_max:915,ha:997,o:"m 527 0 l 389 0 l 389 122 q 110 231 220 122 q 0 509 0 340 q 110 785 0 677 q 389 893 220 893 l 389 1013 l 527 1013 l 527 893 q 804 786 693 893 q 915 509 915 679 q 805 231 915 341 q 527 122 696 122 l 527 0 m 527 226 q 712 310 641 226 q 779 507 779 389 q 712 705 779 627 q 527 787 641 787 l 527 226 m 389 226 l 389 787 q 205 698 275 775 q 136 505 136 620 q 206 308 136 391 q 389 226 276 226 "},"â‹":{x_min:0,x_max:0,ha:694},j:{x_min:-77.78125,x_max:167,ha:349,o:"m 167 871 l 42 871 l 42 1013 l 167 1013 l 167 871 m 167 -80 q 121 -231 167 -184 q -26 -278 76 -278 l -77 -278 l -77 -164 l -41 -164 q 26 -143 11 -164 q 42 -65 42 -122 l 42 737 l 167 737 l 167 -80 "},"Î£":{x_min:0,x_max:756.953125,ha:819,o:"m 756 0 l 0 0 l 0 107 l 395 523 l 22 904 l 22 1013 l 745 1013 l 745 889 l 209 889 l 566 523 l 187 125 l 756 125 l 756 0 "},1:{x_min:215.671875,x_max:574,ha:792,o:"m 574 0 l 442 0 l 442 697 l 215 697 l 215 796 q 386 833 330 796 q 475 986 447 875 l 574 986 l 574 0 "},"â€º":{x_min:18.0625,x_max:774,ha:792,o:"m 774 376 l 18 40 l 18 149 l 631 421 l 18 692 l 18 799 l 774 465 l 774 376 "},"<":{x_min:17.984375,x_max:773.609375,ha:792,o:"m 773 40 l 18 376 l 17 465 l 773 799 l 773 692 l 159 420 l 773 149 l 773 40 "},"Â£":{x_min:0,x_max:704.484375,ha:801,o:"m 704 41 q 623 -10 664 5 q 543 -26 583 -26 q 359 15 501 -26 q 243 36 288 36 q 158 23 197 36 q 73 -21 119 10 l 6 76 q 125 195 90 150 q 175 331 175 262 q 147 443 175 383 l 0 443 l 0 512 l 108 512 q 43 734 43 623 q 120 929 43 854 q 358 1010 204 1010 q 579 936 487 1010 q 678 729 678 857 l 678 684 l 552 684 q 504 838 552 780 q 362 896 457 896 q 216 852 263 896 q 176 747 176 815 q 199 627 176 697 q 248 512 217 574 l 468 512 l 468 443 l 279 443 q 297 356 297 398 q 230 194 297 279 q 153 107 211 170 q 227 133 190 125 q 293 142 264 142 q 410 119 339 142 q 516 96 482 96 q 579 105 550 96 q 648 142 608 115 l 704 41 "},t:{x_min:0,x_max:367,ha:458,o:"m 367 0 q 312 -5 339 -2 q 262 -8 284 -8 q 145 28 183 -8 q 108 143 108 64 l 108 638 l 0 638 l 0 738 l 108 738 l 108 944 l 232 944 l 232 738 l 367 738 l 367 638 l 232 638 l 232 185 q 248 121 232 140 q 307 102 264 102 q 345 104 330 102 q 367 107 360 107 l 367 0 "},"Â¬":{x_min:0,x_max:706,ha:803,o:"m 706 411 l 706 158 l 630 158 l 630 335 l 0 335 l 0 411 l 706 411 "},"Î»":{x_min:0,x_max:750,ha:803,o:"m 750 -7 q 679 -15 716 -15 q 538 59 591 -15 q 466 214 512 97 l 336 551 l 126 0 l 0 0 l 270 705 q 223 837 247 770 q 116 899 190 899 q 90 898 100 899 l 90 1004 q 152 1011 125 1011 q 298 938 244 1011 q 373 783 326 901 l 605 192 q 649 115 629 136 q 716 95 669 95 l 736 95 q 750 97 745 97 l 750 -7 "},W:{x_min:0,x_max:1263.890625,ha:1351,o:"m 1263 1013 l 995 0 l 859 0 l 627 837 l 405 0 l 265 0 l 0 1013 l 136 1013 l 342 202 l 556 1013 l 701 1013 l 921 207 l 1133 1012 l 1263 1013 "},">":{x_min:18.0625,x_max:774,ha:792,o:"m 774 376 l 18 40 l 18 149 l 631 421 l 18 692 l 18 799 l 774 465 l 774 376 "},v:{x_min:0,x_max:675.15625,ha:761,o:"m 675 738 l 404 0 l 272 0 l 0 738 l 133 737 l 340 147 l 541 737 l 675 738 "},"Ï„":{x_min:.28125,x_max:644.5,ha:703,o:"m 644 628 l 382 628 l 382 179 q 388 120 382 137 q 436 91 401 91 q 474 94 447 91 q 504 97 501 97 l 504 0 q 454 -9 482 -5 q 401 -14 426 -14 q 278 67 308 -14 q 260 233 260 118 l 260 628 l 0 628 l 0 739 l 644 739 l 644 628 "},"Î¾":{x_min:0,x_max:624.9375,ha:699,o:"m 624 -37 q 608 -153 624 -96 q 563 -278 593 -211 l 454 -278 q 491 -183 486 -200 q 511 -83 511 -126 q 484 -23 511 -44 q 370 1 452 1 q 323 0 354 1 q 283 -1 293 -1 q 84 76 169 -1 q 0 266 0 154 q 56 431 0 358 q 197 538 108 498 q 94 613 134 562 q 54 730 54 665 q 77 823 54 780 q 143 901 101 867 l 27 901 l 27 1012 l 576 1012 l 576 901 l 380 901 q 244 863 303 901 q 178 745 178 820 q 312 600 178 636 q 532 582 380 582 l 532 479 q 276 455 361 479 q 118 281 118 410 q 165 173 118 217 q 274 120 208 133 q 494 101 384 110 q 624 -37 624 76 "},"&":{x_min:-3,x_max:894.25,ha:992,
o:"m 894 0 l 725 0 l 624 123 q 471 0 553 40 q 306 -41 390 -41 q 168 -7 231 -41 q 62 92 105 26 q 14 187 31 139 q -3 276 -3 235 q 55 433 -3 358 q 248 581 114 508 q 170 689 196 640 q 137 817 137 751 q 214 985 137 922 q 384 1041 284 1041 q 548 988 483 1041 q 622 824 622 928 q 563 666 622 739 q 431 556 516 608 l 621 326 q 649 407 639 361 q 663 493 653 426 l 781 493 q 703 229 781 352 l 894 0 m 504 818 q 468 908 504 877 q 384 940 433 940 q 293 907 331 940 q 255 818 255 875 q 289 714 255 767 q 363 628 313 678 q 477 729 446 682 q 504 818 504 771 m 556 209 l 314 499 q 179 395 223 449 q 135 283 135 341 q 146 222 135 253 q 183 158 158 192 q 333 80 241 80 q 556 209 448 80 "},"Î›":{x_min:0,x_max:862.5,ha:942,o:"m 862 0 l 719 0 l 426 847 l 143 0 l 0 0 l 356 1013 l 501 1013 l 862 0 "},I:{x_min:41,x_max:180,ha:293,o:"m 180 0 l 41 0 l 41 1013 l 180 1013 l 180 0 "},G:{x_min:0,x_max:921,ha:1011,o:"m 921 0 l 832 0 l 801 136 q 655 15 741 58 q 470 -28 568 -28 q 126 133 259 -28 q 0 499 0 284 q 125 881 0 731 q 486 1043 259 1043 q 763 957 647 1043 q 905 709 890 864 l 772 709 q 668 866 747 807 q 486 926 589 926 q 228 795 322 926 q 142 507 142 677 q 228 224 142 342 q 483 94 323 94 q 712 195 625 94 q 796 435 796 291 l 477 435 l 477 549 l 921 549 l 921 0 "},"Î°":{x_min:0,x_max:617,ha:725,o:"m 524 800 l 414 800 l 414 925 l 524 925 l 524 800 m 183 800 l 73 800 l 73 925 l 183 925 l 183 800 m 617 352 q 540 93 617 199 q 308 -24 455 -24 q 76 93 161 -24 q 0 352 0 199 l 0 738 l 126 738 l 126 354 q 169 185 126 257 q 312 98 220 98 q 451 185 402 98 q 492 354 492 257 l 492 738 l 617 738 l 617 352 m 489 1040 l 300 819 l 216 819 l 351 1040 l 489 1040 "},"`":{x_min:0,x_max:138.890625,ha:236,o:"m 138 699 l 0 699 l 0 861 q 36 974 0 929 q 138 1041 72 1020 l 138 977 q 82 931 95 969 q 69 839 69 893 l 138 839 l 138 699 "},"Â·":{x_min:0,x_max:142,ha:239,o:"m 142 585 l 0 585 l 0 738 l 142 738 l 142 585 "},"Î¥":{x_min:.328125,x_max:819.515625,ha:889,o:"m 819 1013 l 482 416 l 482 0 l 342 0 l 342 416 l 0 1013 l 140 1013 l 411 533 l 679 1013 l 819 1013 "},r:{x_min:0,x_max:355.5625,ha:432,o:"m 355 621 l 343 621 q 179 569 236 621 q 122 411 122 518 l 122 0 l 0 0 l 0 737 l 117 737 l 117 604 q 204 719 146 686 q 355 753 262 753 l 355 621 "},x:{x_min:0,x_max:675,ha:764,o:"m 675 0 l 525 0 l 331 286 l 144 0 l 0 0 l 256 379 l 12 738 l 157 737 l 336 473 l 516 738 l 661 738 l 412 380 l 675 0 "},"Î¼":{x_min:0,x_max:696.609375,ha:747,o:"m 696 -4 q 628 -14 657 -14 q 498 97 513 -14 q 422 8 470 41 q 313 -24 374 -24 q 207 3 258 -24 q 120 80 157 31 l 120 -278 l 0 -278 l 0 738 l 124 738 l 124 343 q 165 172 124 246 q 308 82 216 82 q 451 177 402 82 q 492 358 492 254 l 492 738 l 616 738 l 616 214 q 623 136 616 160 q 673 92 636 92 q 696 95 684 92 l 696 -4 "},h:{x_min:0,x_max:615,ha:724,o:"m 615 472 l 615 0 l 490 0 l 490 454 q 456 590 490 535 q 338 654 416 654 q 186 588 251 654 q 122 436 122 522 l 122 0 l 0 0 l 0 1013 l 122 1013 l 122 633 q 218 727 149 694 q 362 760 287 760 q 552 676 484 760 q 615 472 615 600 "},".":{x_min:0,x_max:142,ha:239,o:"m 142 0 l 0 0 l 0 151 l 142 151 l 142 0 "},"Ï†":{x_min:-2,x_max:878,ha:974,o:"m 496 -279 l 378 -279 l 378 -17 q 101 88 204 -17 q -2 367 -2 194 q 68 626 -2 510 q 283 758 151 758 l 283 646 q 167 537 209 626 q 133 373 133 462 q 192 177 133 254 q 378 93 259 93 l 378 758 q 445 764 426 763 q 476 765 464 765 q 765 659 653 765 q 878 377 878 553 q 771 96 878 209 q 496 -17 665 -17 l 496 -279 m 496 93 l 514 93 q 687 183 623 93 q 746 380 746 265 q 691 569 746 491 q 522 658 629 658 l 496 656 l 496 93 "},";":{x_min:0,x_max:142,ha:239,o:"m 142 585 l 0 585 l 0 738 l 142 738 l 142 585 m 142 -12 q 105 -132 142 -82 q 0 -206 68 -182 l 0 -138 q 58 -82 43 -123 q 68 0 68 -56 l 0 0 l 0 151 l 142 151 l 142 -12 "},f:{x_min:0,x_max:378,ha:472,o:"m 378 638 l 246 638 l 246 0 l 121 0 l 121 638 l 0 638 l 0 738 l 121 738 q 137 935 121 887 q 290 1028 171 1028 q 320 1027 305 1028 q 378 1021 334 1026 l 378 908 q 323 918 346 918 q 257 870 273 918 q 246 780 246 840 l 246 738 l 378 738 l 378 638 "},"â€œ":{x_min:1,x_max:348.21875,ha:454,o:"m 140 670 l 1 670 l 1 830 q 37 943 1 897 q 140 1011 74 990 l 140 947 q 82 900 97 940 q 68 810 68 861 l 140 810 l 140 670 m 348 670 l 209 670 l 209 830 q 245 943 209 897 q 348 1011 282 990 l 348 947 q 290 900 305 940 q 276 810 276 861 l 348 810 l 348 670 "},A:{x_min:.03125,x_max:906.953125,ha:1008,o:"m 906 0 l 756 0 l 648 303 l 251 303 l 142 0 l 0 0 l 376 1013 l 529 1013 l 906 0 m 610 421 l 452 867 l 293 421 l 610 421 "},6:{x_min:53,x_max:739,ha:792,o:"m 739 312 q 633 62 739 162 q 400 -31 534 -31 q 162 78 257 -31 q 53 439 53 206 q 178 859 53 712 q 441 986 284 986 q 643 912 559 986 q 732 713 732 833 l 601 713 q 544 830 594 786 q 426 875 494 875 q 268 793 331 875 q 193 517 193 697 q 301 597 240 570 q 427 624 362 624 q 643 540 552 624 q 739 312 739 451 m 603 298 q 540 461 603 400 q 404 516 484 516 q 268 461 323 516 q 207 300 207 401 q 269 137 207 198 q 405 83 325 83 q 541 137 486 83 q 603 298 603 197 "},"â€˜":{x_min:1,x_max:139.890625,ha:236,o:"m 139 670 l 1 670 l 1 830 q 37 943 1 897 q 139 1011 74 990 l 139 947 q 82 900 97 940 q 68 810 68 861 l 139 810 l 139 670 "},"ÏŠ":{x_min:-70,x_max:283,ha:361,o:"m 283 800 l 173 800 l 173 925 l 283 925 l 283 800 m 40 800 l -70 800 l -70 925 l 40 925 l 40 800 m 283 3 q 232 -10 257 -5 q 181 -15 206 -15 q 84 26 118 -15 q 41 200 41 79 l 41 737 l 166 737 l 167 215 q 171 141 167 157 q 225 101 182 101 q 247 103 238 101 q 283 112 256 104 l 283 3 "},"Ï€":{x_min:-.21875,x_max:773.21875,ha:857,o:"m 773 -7 l 707 -11 q 575 40 607 -11 q 552 174 552 77 l 552 226 l 552 626 l 222 626 l 222 0 l 97 0 l 97 626 l 0 626 l 0 737 l 773 737 l 773 626 l 676 626 l 676 171 q 695 103 676 117 q 773 90 714 90 l 773 -7 "},"Î¬":{x_min:0,x_max:765.5625,ha:809,o:"m 765 -4 q 698 -14 726 -14 q 564 97 586 -14 q 466 7 525 40 q 337 -26 407 -26 q 88 98 186 -26 q 0 369 0 212 q 88 637 0 525 q 337 760 184 760 q 465 727 407 760 q 563 637 524 695 l 563 738 l 685 738 l 685 222 q 693 141 685 168 q 748 94 708 94 q 765 95 760 94 l 765 -4 m 584 371 q 531 562 584 485 q 360 653 470 653 q 192 566 254 653 q 135 379 135 489 q 186 181 135 261 q 358 84 247 84 q 528 176 465 84 q 584 371 584 260 m 604 1040 l 415 819 l 332 819 l 466 1040 l 604 1040 "},O:{x_min:0,x_max:958,ha:1057,o:"m 485 1041 q 834 882 702 1041 q 958 512 958 734 q 834 136 958 287 q 481 -26 702 -26 q 126 130 261 -26 q 0 504 0 279 q 127 880 0 728 q 485 1041 263 1041 m 480 98 q 731 225 638 98 q 815 504 815 340 q 733 783 815 669 q 480 912 640 912 q 226 784 321 912 q 142 504 142 670 q 226 224 142 339 q 480 98 319 98 "},n:{x_min:0,x_max:615,ha:724,o:"m 615 463 l 615 0 l 490 0 l 490 454 q 453 592 490 537 q 331 656 410 656 q 178 585 240 656 q 117 421 117 514 l 117 0 l 0 0 l 0 738 l 117 738 l 117 630 q 218 728 150 693 q 359 764 286 764 q 552 675 484 764 q 615 463 615 593 "},3:{x_min:54,x_max:737,ha:792,o:"m 737 284 q 635 55 737 141 q 399 -25 541 -25 q 156 52 248 -25 q 54 308 54 140 l 185 308 q 245 147 185 202 q 395 96 302 96 q 539 140 484 96 q 602 280 602 190 q 510 429 602 390 q 324 454 451 454 l 324 565 q 487 584 441 565 q 565 719 565 617 q 515 835 565 791 q 395 879 466 879 q 255 824 307 879 q 203 661 203 769 l 78 661 q 166 909 78 822 q 387 992 250 992 q 603 921 513 992 q 701 723 701 844 q 669 607 701 656 q 578 524 637 558 q 696 434 655 499 q 737 284 737 369 "},9:{x_min:53,x_max:739,ha:792,o:"m 739 524 q 619 94 739 241 q 362 -32 516 -32 q 150 47 242 -32 q 59 244 59 126 l 191 244 q 246 129 191 176 q 373 82 301 82 q 526 161 466 82 q 597 440 597 255 q 363 334 501 334 q 130 432 216 334 q 53 650 53 521 q 134 880 53 786 q 383 986 226 986 q 659 841 566 986 q 739 524 739 719 m 388 449 q 535 514 480 449 q 585 658 585 573 q 535 805 585 744 q 388 873 480 873 q 242 809 294 873 q 191 658 191 745 q 239 514 191 572 q 388 449 292 449 "},l:{x_min:41,x_max:166,ha:279,o:"m 166 0 l 41 0 l 41 1013 l 166 1013 l 166 0 "},"Â¤":{x_min:40.09375,x_max:728.796875,ha:825,o:"m 728 304 l 649 224 l 512 363 q 383 331 458 331 q 256 363 310 331 l 119 224 l 40 304 l 177 441 q 150 553 150 493 q 184 673 150 621 l 40 818 l 119 898 l 267 749 q 321 766 291 759 q 384 773 351 773 q 447 766 417 773 q 501 749 477 759 l 649 898 l 728 818 l 585 675 q 612 618 604 648 q 621 553 621 587 q 591 441 621 491 l 728 304 m 384 682 q 280 643 318 682 q 243 551 243 604 q 279 461 243 499 q 383 423 316 423 q 487 461 449 423 q 525 553 525 500 q 490 641 525 605 q 384 682 451 682 "},"Îº":{x_min:0,x_max:632.328125,ha:679,o:"m 632 0 l 482 0 l 225 384 l 124 288 l 124 0 l 0 0 l 0 738 l 124 738 l 124 446 l 433 738 l 596 738 l 312 466 l 632 0 "},4:{x_min:48,x_max:742.453125,ha:792,o:"m 742 243 l 602 243 l 602 0 l 476 0 l 476 243 l 48 243 l 48 368 l 476 958 l 602 958 l 602 354 l 742 354 l 742 243 m 476 354 l 476 792 l 162 354 l 476 354 "},p:{x_min:0,x_max:685,ha:786,o:"m 685 364 q 598 96 685 205 q 350 -23 504 -23 q 121 89 205 -23 l 121 -278 l 0 -278 l 0 738 l 121 738 l 121 633 q 220 726 159 691 q 351 761 280 761 q 598 636 504 761 q 685 364 685 522 m 557 371 q 501 560 557 481 q 330 651 437 651 q 162 559 223 651 q 108 366 108 479 q 162 177 108 254 q 333 87 224 87 q 502 178 441 87 q 557 371 557 258 "},"â€¡":{x_min:0,x_max:777,ha:835,o:"m 458 238 l 458 0 l 319 0 l 319 238 l 0 238 l 0 360 l 319 360 l 319 681 l 0 683 l 0 804 l 319 804 l 319 1015 l 458 1013 l 458 804 l 777 804 l 777 683 l 458 683 l 458 360 l 777 360 l 777 238 l 458 238 "},"Ïˆ":{x_min:0,x_max:808,ha:907,o:"m 465 -278 l 341 -278 l 341 -15 q 87 102 180 -15 q 0 378 0 210 l 0 739 l 133 739 l 133 379 q 182 195 133 275 q 341 98 242 98 l 341 922 l 465 922 l 465 98 q 623 195 563 98 q 675 382 675 278 l 675 742 l 808 742 l 808 381 q 720 104 808 213 q 466 -13 627 -13 l 465 -278 "},"Î·":{x_min:.78125,x_max:697,ha:810,o:"m 697 -278 l 572 -278 l 572 454 q 540 587 572 536 q 425 650 501 650 q 271 579 337 650 q 206 420 206 509 l 206 0 l 81 0 l 81 489 q 73 588 81 562 q 0 644 56 644 l 0 741 q 68 755 38 755 q 158 720 124 755 q 200 630 193 686 q 297 726 234 692 q 434 761 359 761 q 620 692 544 761 q 697 516 697 624 l 697 -278 "}},cssFontWeight:"normal",ascender:1189,underlinePosition:-100,cssFontStyle:"normal",boundingBox:{yMin:-334,xMin:-111,yMax:1189,xMax:1672},resolution:1e3,original_font_information:{postscript_name:"Helvetiker-Regular",version_string:"Version 1.00 2004 initial release",vendor_url:"http://www.magenta.gr/",full_font_name:"Helvetiker",font_family_name:"Helvetiker",copyright:"Copyright (c) Îœagenta ltd, 2004",description:"",trademark:"",designer:"",designer_url:"",unique_font_identifier:"Îœagenta ltd:Helvetiker:22-10-104",license_url:"http://www.ellak.gr/fonts/MgOpen/license.html",license_description:'Copyright (c) 2004 by MAGENTA Ltd. All Rights Reserved.\r\n\r\nPermission is hereby granted, free of charge, to any person obtaining a copy of the fonts accompanying this license ("Fonts") and associated documentation files (the "Font Software"), to reproduce and distribute the Font Software, including without limitation the rights to use, copy, merge, publish, distribute, and/or sell copies of the Font Software, and to permit persons to whom the Font Software is furnished to do so, subject to the following conditions: \r\n\r\nThe above copyright and this permission notice shall be included in all copies of one or more of the Font Software typefaces.\r\n\r\nThe Font Software may be modified, altered, or added to, and in particular the designs of glyphs or characters in the Fonts may be modified and additional glyphs or characters may be added to the Fonts, only if the fonts are renamed to names not containing the word "MgOpen", or if the modifications are accepted for inclusion in the Font Software itself by the each appointed Administrator.\r\n\r\nThis License becomes null and void to the extent applicable to Fonts or Font Software that has been modified and is distributed under the "MgOpen" name.\r\n\r\nThe Font Software may be sold as part of a larger software package but no copy of one or more of the Font Software typefaces may be sold by itself. \r\n\r\nTHE FONT SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO ANY WARRANTIES OF MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT OF COPYRIGHT, PATENT, TRADEMARK, OR OTHER RIGHT. IN NO EVENT SHALL MAGENTA OR PERSONS OR BODIES IN CHARGE OF ADMINISTRATION AND MAINTENANCE OF THE FONT SOFTWARE BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER LIABILITY, INCLUDING ANY GENERAL, SPECIAL, INDIRECT, INCIDENTAL, OR CONSEQUENTIAL DAMAGES, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM, OUT OF THE USE OR INABILITY TO USE THE FONT SOFTWARE OR FROM OTHER DEALINGS IN THE FONT SOFTWARE.',manufacturer_name:"Îœagenta ltd",font_sub_family_name:"Regular"},descender:-334,familyName:"Helvetiker",lineHeight:1522,underlineThickness:50},CLOUD.ViewHouse=function(e,t){var i=this;this.viewer=e,this.preRotationHandle=t,this.mouseButtons={LEFT:THREE.MOUSE.LEFT,RIGHT:THREE.MOUSE.RIGHT},this.visible=!0,this.isAnimationFinish=!0,this.pickedColor=11653612,this.width=0,this.height=0,this.isDisable=!1;var n,r=CLOUD.Plugins.Font.helvetiker_regular,a={Home:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44},o={Compass:"compass",Home:"home",BottomFloor:"Bottom_Floor",BottomSouth:"Bottom_South",BottomNorth:"Bottom_North",BottomEast:"Bottom_East",BottomWest:"Bottom_West",BottomSouthEast:"Bottom_SouthEast",BottomSouthWest:"Bottom_SouthWest",BottomNorthWest:"Bottom_NorthWest",BottomNorthEast:"Bottom_NorthEast",MiddleSouth:"Middle_South",MiddleNorth:"Middle_North",MiddleEast:"Middle_East",MiddleWest:"Middle_West",MiddleSouthEast:"Middle_SouthEast",MiddleSouthWest:"Middle_SouthWest",MiddleNorthWest:"Middle_NorthWest",MiddleNorthEast:"Middle_NorthEast",MiddleDoor:"Middle_Door",MiddleRightWindow:"Middle_RightWindow",MiddleLeftWindow:"Middle_LeftWindow",RoofCenter:"Roof_Center",RoofSouth:"Roof_South",RoofNorth:"Roof_North",RoofEast:"Roof_East",RoofWest:"Roof_West",RoofEaves:"Roof_Eaves",RoofSouthEast:"Roof_SouthEast",RoofSouthWest:"Roof_SouthWest",RoofNorthWest:"Roof_NorthWest",RoofNorthEast:"Roof_NorthEast",ControlPointNorth:"ControlPoint_North",ControlPointSouth:"ControlPoint_South",ControlPointEast:"ControlPoint_East",ControlPointWest:"ControlPoint_West",ControlRingNorthEast:"ControlRing_NorthEast",ControlRingSouthWest:"ControlRing_SouthWest",ControlRingNorthWest:"ControlRing_NorthWest",ControlRingSouthEast:"ControlRing_SouthEast"},s=new THREE.Scene,l=new THREE.OrthographicCamera(-110,110,110,-110,-110,110),c=new THREE.Raycaster,u=new THREE.Scene,h=l.clone(),d=new THREE.Raycaster,f=new THREE.Group,p=new THREE.Group,m=new THREE.Group,g=new THREE.Group,v=new THREE.Group,y=new THREE.Group,E=new THREE.Vector3,x=new THREE.Vector3,b=null,C=null,M=null,_=null,w=null,L=null,T=null,I=null,S=null,O=null,D=null,R=null,A=0,U=null,B=null,P=null,N=null,k=null,F=null,H=null,G=null,V=null,z=!0,W=!1,q=!1,j=!1,X=!0,Y=new THREE.Vector2,Z=new THREE.Vector2,K=new THREE.Vector2,Q=new THREE.Vector2,J=!1,$="",ee=null,te=0,ie=-1,ne=!1,re=function(e,t,i,n,r){for(var a=t.length,o=new Float32Array(3*a),s=0;s<a;++s)o[3*s]=t[s].x,o[3*s+1]=t[s].y,o[3*s+2]=t[s].z;var l=new THREE.BufferGeometry;l.setIndex(new THREE.BufferAttribute(new Uint16Array(i),1)),l.addAttribute("position",new THREE.BufferAttribute(o,3));var c=new THREE.LineBasicMaterial({color:n,linewidth:r}),u=new THREE.Line(l,c);e.add(u)},ae=function(e,t,i){e===o.MiddleDoor&&(b=t,C=i),e===o.MiddleSouth&&(M=t,_=i),e===o.MiddleLeftWindow&&(w=t,L=i),e===o.MiddleRightWindow&&(T=t,I=i),e===o.MiddleWest&&(S=t,O=i),e===o.MiddleEast&&(D=t,R=i)},oe=function(e,t,i,n,r){for(var a,o,s=new THREE.Geometry,l=0,c=t.length;l<c;)a=new THREE.Vector3,a=t[l++],s.vertices.push(a);for(l=0,c=i.length;l<c;)o=new THREE.Face3,o.a=i[l++],o.b=i[l++],o.c=i[l++],s.faces.push(o);var u=new THREE.MeshBasicMaterial({color:n}),h=new THREE.Mesh(s,u);h.name=r,ae(r,h,n),e.add(h)},se=function(){te=40;var e=[];e.push(new THREE.Vector3(-27,-47.01,-40)),e.push(new THREE.Vector3(27,-47.01,-40)),e.push(new THREE.Vector3(27,-47.01,-34)),e.push(new THREE.Vector3(-27,-47.01,-34)),e.push(new THREE.Vector3(-27,-35.01,-40)),e.push(new THREE.Vector3(27,-35.01,-40)),e.push(new THREE.Vector3(27,-35.01,-34)),e.push(new THREE.Vector3(-27,-35.01,-34)),e.push(new THREE.Vector3(-21,-41.01,-34)),e.push(new THREE.Vector3(21,-41.01,-34)),e.push(new THREE.Vector3(21,-41.01,-28)),e.push(new THREE.Vector3(-21,-41.01,-28)),e.push(new THREE.Vector3(-21,-35.01,-34)),e.push(new THREE.Vector3(21,-35.01,-34)),e.push(new THREE.Vector3(21,-35.01,-28)),e.push(new THREE.Vector3(-21,-35.01,-28));var t=[4,5,6,6,7,4,5,1,2,2,6,5,0,4,7,7,3,0,7,6,2,2,3,7,0,1,5,5,4,0,12,13,14,14,15,12,13,9,10,10,14,13,8,12,15,15,11,8,15,14,10,10,11,15,8,9,13,13,12,8],i=[];i.push(new THREE.Vector3(42.5,-35,-40)),i.push(new THREE.Vector3(33.5,-35,-40)),i.push(new THREE.Vector3(33.5,-35,-31)),i.push(new THREE.Vector3(42.5,-35,-31)),i.push(new THREE.Vector3(42.5,-26,-31)),i.push(new THREE.Vector3(42.5,-26,-40)),i.push(new THREE.Vector3(33.5,-26,-40));var n=[0,3,2,2,1,0,3,0,5,5,4,3,0,1,6,6,5,0],r=[];r.push(new THREE.Vector3(42.5,26,-40)),r.push(new THREE.Vector3(42.5,26,-31)),r.push(new THREE.Vector3(42.5,-26,-31)),r.push(new THREE.Vector3(42.5,-26,-40)),r.push(new THREE.Vector3(33.5,-26,-40)),r.push(new THREE.Vector3(33.5,26,-40));var a=[0,1,2,2,3,0,3,4,5,5,0,3],s=[];s.push(new THREE.Vector3(42.5,35,-40)),s.push(new THREE.Vector3(33.5,35,-40)),s.push(new THREE.Vector3(33.5,35,-31)),s.push(new THREE.Vector3(42.5,35,-31)),s.push(new THREE.Vector3(42.5,26,-31)),s.push(new THREE.Vector3(42.5,26,-40)),s.push(new THREE.Vector3(33.5,26,-40));var l=[0,1,2,2,3,0,3,4,5,5,0,3,0,5,6,6,1,0],c=[];c.push(new THREE.Vector3(-33.5,35,-40)),c.push(new THREE.Vector3(-33.5,35,-31)),c.push(new THREE.Vector3(33.5,35,-31)),c.push(new THREE.Vector3(33.5,35,-40)),c.push(new THREE.Vector3(33.5,26,-40)),c.push(new THREE.Vector3(-33.5,26,-40));var u=[0,1,2,2,3,0,3,4,5,5,0,3],h=[];h.push(new THREE.Vector3(-42.5,35,-40)),h.push(new THREE.Vector3(-33.5,35,-40)),h.push(new THREE.Vector3(-33.5,35,-31)),h.push(new THREE.Vector3(-42.5,35,-31)),h.push(new THREE.Vector3(-42.5,26,-31)),h.push(new THREE.Vector3(-42.5,26,-40)),h.push(new THREE.Vector3(-33.5,26,-40));var d=[0,3,2,2,1,0,3,0,5,5,4,3,0,1,6,6,5,0],f=[];f.push(new THREE.Vector3(-42.5,26,-40)),f.push(new THREE.Vector3(-42.5,26,-31)),f.push(new THREE.Vector3(-42.5,-26,-31)),f.push(new THREE.Vector3(-42.5,-26,-40)),f.push(new THREE.Vector3(-33.5,-26,-40)),f.push(new THREE.Vector3(-33.5,26,-40));var p=[0,3,2,2,1,0,3,0,5,5,4,3],g=[];g.push(new THREE.Vector3(-42.5,-35,-40)),g.push(new THREE.Vector3(-33.5,-35,-40)),g.push(new THREE.Vector3(-33.5,-35,-31)),g.push(new THREE.Vector3(-42.5,-35,-31)),g.push(new THREE.Vector3(-42.5,-26,-31)),g.push(new THREE.Vector3(-42.5,-26,-40)),g.push(new THREE.Vector3(-33.5,-26,-40));var v=[0,1,2,2,3,0,3,4,5,5,0,3,0,5,6,6,1,0],y=[];y.push(new THREE.Vector3(-33.5,-35,-40)),y.push(new THREE.Vector3(-33.5,26,-40)),y.push(new THREE.Vector3(33.5,26,-40)),y.push(new THREE.Vector3(33.5,-35,-40));var E=[0,1,2,2,3,0],x=[];x.push(new THREE.Vector3(-33.5,-35,-40)),x.push(new THREE.Vector3(33.5,-35,-40)),x.push(new THREE.Vector3(33.5,-35,10)),x.push(new THREE.Vector3(-33.5,-35,10));var b=[0,1,2,2,3,0],C=[];C.push(new THREE.Vector3(33.5,-35,-31)),C.push(new THREE.Vector3(33.5,-35,10)),C.push(new THREE.Vector3(42.5,-35,10)),C.push(new THREE.Vector3(42.5,-35,-31)),C.push(new THREE.Vector3(42.5,-26,-31)),C.push(new THREE.Vector3(42.5,-26,10));var M=[0,3,2,2,1,0,3,4,5,5,2,3],_=[];_.push(new THREE.Vector3(42.5,-26,-31)),_.push(new THREE.Vector3(42.5,26,-31)),_.push(new THREE.Vector3(42.5,26,10)),_.push(new THREE.Vector3(42.5,-26,10));var w=[0,1,2,2,3,0],L=[];L.push(new THREE.Vector3(33.5,35,-31)),L.push(new THREE.Vector3(33.5,35,10)),L.push(new THREE.Vector3(42.5,35,10)),L.push(new THREE.Vector3(42.5,35,-31)),L.push(new THREE.Vector3(42.5,26,-31)),L.push(new THREE.Vector3(42.5,26,10));var T=[0,1,2,2,3,0,3,2,5,5,4,3],I=[];I.push(new THREE.Vector3(-33.5,35,-31)),I.push(new THREE.Vector3(33.5,35,-31)),I.push(new THREE.Vector3(33.5,35,10)),I.push(new THREE.Vector3(-33.5,35,10));var S=[0,3,2,2,1,0],O=[];O.push(new THREE.Vector3(-33.5,35,-31)),O.push(new THREE.Vector3(-33.5,35,10)),O.push(new THREE.Vector3(-42.5,35,10)),O.push(new THREE.Vector3(-42.5,35,-31)),O.push(new THREE.Vector3(-42.5,26,-31)),O.push(new THREE.Vector3(-42.5,26,10));var D=[0,3,2,2,1,0,3,4,5,5,2,3],R=[];R.push(new THREE.Vector3(-42.5,-26,-31)),R.push(new THREE.Vector3(-42.5,26,-31)),R.push(new THREE.Vector3(-42.5,26,10)),R.push(new THREE.Vector3(-42.5,-26,10));var A=[0,3,2,2,1,0],U=[];U.push(new THREE.Vector3(-33.5,-35,-31)),U.push(new THREE.Vector3(-33.5,-35,10)),U.push(new THREE.Vector3(-42.5,-35,10)),U.push(new THREE.Vector3(-42.5,-35,-31)),U.push(new THREE.Vector3(-42.5,-26,-31)),U.push(new THREE.Vector3(-42.5,-26,10));var B=[0,1,2,2,3,0,3,2,5,5,4,3],P=[];P.push(new THREE.Vector3(-15,-35.01,-28)),P.push(new THREE.Vector3(15,-35.01,-28)),P.push(new THREE.Vector3(15,-35.01,0)),P.push(new THREE.Vector3(-15,-35.01,0));var N=[0,1,2,2,3,0],k=[];k.push(new THREE.Vector3(42.51,-12.5,-25)),k.push(new THREE.Vector3(42.51,12.5,-25)),k.push(new THREE.Vector3(42.51,12.5,0)),k.push(new THREE.Vector3(42.51,-12.5,0));var F=[0,1,2,2,3,0],H=[];H.push(new THREE.Vector3(-42.51,-12.5,-25)),H.push(new THREE.Vector3(-42.51,12.5,-25)),H.push(new THREE.Vector3(-42.51,12.5,0)),H.push(new THREE.Vector3(-42.51,-12.5,0));var G=[0,3,2,2,1,0],V=[];V.push(new THREE.Vector3(-41,-40,10)),V.push(new THREE.Vector3(41,-40,10)),V.push(new THREE.Vector3(18,-21,40)),V.push(new THREE.Vector3(-18,-21,40)),V.push(new THREE.Vector3(-18,-12,40)),V.push(new THREE.Vector3(18,-12,40));var z=[0,1,2,0,2,3,4,3,2,4,2,5],W=[];W.push(new THREE.Vector3(27,-21,40)),W.push(new THREE.Vector3(27,-12,40)),W.push(new THREE.Vector3(18,-12,40)),W.push(new THREE.Vector3(18,-21,40)),W.push(new THREE.Vector3(41,-40,10)),W.push(new THREE.Vector3(50,-40,10)),W.push(new THREE.Vector3(50,-31,10));var q=[0,1,2,2,3,0,3,4,5,5,0,3,0,5,6,6,1,0],j=[];j.push(new THREE.Vector3(50,-31,10)),j.push(new THREE.Vector3(50,31,10)),j.push(new THREE.Vector3(27,12,40)),j.push(new THREE.Vector3(27,-12,40)),j.push(new THREE.Vector3(18,-12,40)),j.push(new THREE.Vector3(18,12,40));var X=[0,1,2,0,2,3,4,3,2,4,2,5],Y=[];Y.push(new THREE.Vector3(27,21,40)),Y.push(new THREE.Vector3(27,12,40)),Y.push(new THREE.Vector3(18,12,40)),Y.push(new THREE.Vector3(18,21,40)),Y.push(new THREE.Vector3(41,40,10)),Y.push(new THREE.Vector3(50,40,10)),Y.push(new THREE.Vector3(50,31,10));var Z=[0,3,2,2,1,0,3,0,5,5,4,3,0,1,6,6,5,0],K=[];K.push(new THREE.Vector3(41,40,10)),K.push(new THREE.Vector3(-41,40,10)),K.push(new THREE.Vector3(-18,21,40)),K.push(new THREE.Vector3(18,21,40)),K.push(new THREE.Vector3(18,12,40)),K.push(new THREE.Vector3(-18,12,40));var Q=[0,1,2,0,2,3,4,3,2,4,2,5],J=[];J.push(new THREE.Vector3(-27,21,40)),J.push(new THREE.Vector3(-27,12,40)),J.push(new THREE.Vector3(-18,12,40)),J.push(new THREE.Vector3(-18,21,40)),J.push(new THREE.Vector3(-41,40,10)),J.push(new THREE.Vector3(-50,40,10)),J.push(new THREE.Vector3(-50,31,10));var $=[0,1,2,2,3,0,3,4,5,5,0,3,0,5,6,6,1,0],ee=[];ee.push(new THREE.Vector3(-50,31,10)),ee.push(new THREE.Vector3(-50,-31,10)),ee.push(new THREE.Vector3(-27,-12,40)),ee.push(new THREE.Vector3(-27,12,40)),ee.push(new THREE.Vector3(-18,12,40)),ee.push(new THREE.Vector3(-18,-12,40));var ie=[0,1,2,0,2,3,4,3,2,4,2,5],ne=[];ne.push(new THREE.Vector3(-27,-21,40)),ne.push(new THREE.Vector3(-27,-12,40)),ne.push(new THREE.Vector3(-18,-12,40)),ne.push(new THREE.Vector3(-18,-21,40)),ne.push(new THREE.Vector3(-41,-40,10)),ne.push(new THREE.Vector3(-50,-40,10)),ne.push(new THREE.Vector3(-50,-31,10));var ae=[0,3,2,2,1,0,3,0,5,5,4,3,0,1,6,6,5,0],se=[];se.push(new THREE.Vector3(18,-12,40)),se.push(new THREE.Vector3(-18,-12,40)),se.push(new THREE.Vector3(-18,12,40)),se.push(new THREE.Vector3(18,12,40));var le=[0,2,1,0,3,2],ce=[];ce.push(new THREE.Vector3(50,40,10)),ce.push(new THREE.Vector3(-50,40,10)),ce.push(new THREE.Vector3(-50,-40,10)),ce.push(new THREE.Vector3(50,-40,10)),ce.push(new THREE.Vector3(42.5,35,10)),ce.push(new THREE.Vector3(-42.5,35,10)),ce.push(new THREE.Vector3(-42.5,-35,10)),ce.push(new THREE.Vector3(42.5,-35,10));for(var ue=[0,4,5,5,1,0,1,5,6,6,2,1,2,6,7,7,3,2,3,7,4,4,0,3],he=[e,i,r,s,c,h,f,g,y,x,C,_,L,I,O,R,U,P,k,H,V,W,j,Y,K,J,ee,ne,se,ce],de=[t,n,a,l,u,d,p,v,E,b,M,w,T,S,D,A,B,N,F,G,z,q,X,Z,Q,$,ie,ae,le,ue],fe=[o.BottomSouth,o.BottomSouthEast,o.BottomEast,o.BottomNorthEast,o.BottomNorth,o.BottomNorthWest,o.BottomWest,o.BottomSouthWest,o.BottomFloor,o.MiddleSouth,o.MiddleSouthEast,o.MiddleEast,o.MiddleNorthEast,o.MiddleNorth,o.MiddleNorthWest,o.MiddleWest,o.MiddleSouthWest,o.MiddleDoor,o.MiddleRightWindow,o.MiddleLeftWindow,o.RoofSouth,o.RoofSouthEast,o.RoofEast,o.RoofNorthEast,o.RoofNorth,o.RoofNorthWest,o.RoofWest,o.RoofSouthWest,o.RoofCenter,o.RoofEaves],pe=[10069173,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,15198188,10069173,10069173,10069173,10069173,10069173,10069173,10069173,10069173,10069173,10069173,10069173,15198188,15198188],me=0;me<he.length;++me)oe(m,he[me],de[me],pe[me],fe[me]);var ge=[];ge.push(new THREE.Vector3(-42.5,-35,-40)),ge.push(new THREE.Vector3(42.5,-35,-40)),ge.push(new THREE.Vector3(42.5,35,-40)),ge.push(new THREE.Vector3(-42.5,35,-40)),ge.push(new THREE.Vector3(-42.5,-35,10)),ge.push(new THREE.Vector3(42.5,-35,10)),ge.push(new THREE.Vector3(42.5,35,10)),ge.push(new THREE.Vector3(-42.5,35,10)),ge.push(new THREE.Vector3(-50,-40,10)),ge.push(new THREE.Vector3(50,-40,10)),ge.push(new THREE.Vector3(50,40,10)),ge.push(new THREE.Vector3(-50,40,10)),ge.push(new THREE.Vector3(-27,-21,40)),ge.push(new THREE.Vector3(27,-21,40)),ge.push(new THREE.Vector3(27,21,40)),ge.push(new THREE.Vector3(-27,21,40)),ge.push(new THREE.Vector3(-27,-47.01,-40)),ge.push(new THREE.Vector3(27,-47.01,-40)),ge.push(new THREE.Vector3(27,-47.01,-34)),ge.push(new THREE.Vector3(-27,-47.01,-34)),ge.push(new THREE.Vector3(-27,-35.01,-40)),ge.push(new THREE.Vector3(27,-35.01,-40)),ge.push(new THREE.Vector3(27,-35.01,-34)),ge.push(new THREE.Vector3(-27,-35.01,-34)),ge.push(new THREE.Vector3(-21,-41.01,-34)),ge.push(new THREE.Vector3(21,-41.01,-34)),ge.push(new THREE.Vector3(21,-41.01,-28)),ge.push(new THREE.Vector3(-21,-41.01,-28)),ge.push(new THREE.Vector3(-21,-35.01,-31)),ge.push(new THREE.Vector3(21,-35.01,-31)),ge.push(new THREE.Vector3(21,-35.01,-28)),ge.push(new THREE.Vector3(-21,-35.01,-28)),ge.push(new THREE.Vector3(-15,-35.01,-28)),ge.push(new THREE.Vector3(15,-35.01,-28)),ge.push(new THREE.Vector3(15,-35.01,0)),ge.push(new THREE.Vector3(-15,-35.01,0)),ge.push(new THREE.Vector3(-42.51,-12.5,-25)),ge.push(new THREE.Vector3(-42.51,12.5,-25)),ge.push(new THREE.Vector3(-42.51,12.5,0)),ge.push(new THREE.Vector3(-42.51,-12.5,0)),ge.push(new THREE.Vector3(42.51,-12.5,-25)),ge.push(new THREE.Vector3(42.51,12.5,-25)),ge.push(new THREE.Vector3(42.51,12.5,0)),ge.push(new THREE.Vector3(42.51,-12.5,0));for(var ve=[[0,1,2,3,0],[4,5,6,7,4],[0,4],[1,5],[3,7],[2,6],[8,9,10,11,8],[12,13,14,15,12],[8,12],[9,13],[10,14],[11,15],[16,17,18,19,16],[20,21,22,23,20],[16,20],[17,21],[18,22],[19,23],[24,25,26,27,24],[28,29,30,31,28],[24,28],[25,29],[26,30],[27,31],[32,33,34,35,32],[36,37,38,39,36],[40,41,42,43,40]],ye=0;ye<ve.length;++ye)re(m,ge,ve[ye],7895160,5)},le=function(){var e=new THREE.MeshBasicMaterial({color:14408667,side:THREE.DoubleSide}),t=new THREE.MeshBasicMaterial({color:10439242,side:THREE.DoubleSide,depthTest:!1}),i=new THREE.MeshBasicMaterial({color:16711680,overdraw:0,side:THREE.DoubleSide,depthTest:!1}),n=new THREE.Shape;n.moveTo(30,0),n.lineTo(0,15),n.lineTo(0,-15),n.lineTo(30,0);var a=new THREE.ShapeGeometry(n),s=new THREE.Mesh(a,e);s.translateX(80);var l=new THREE.Mesh(a,e);l.rotateZ(Math.PI),l.translateX(80);var c=new THREE.Mesh(a,t);c.rotateZ(Math.PI/2),c.translateX(80);var u=new THREE.Mesh(a,e);u.rotateZ(-Math.PI/2),u.translateX(80),f.add(s),f.add(l),f.add(c),f.add(u);var h=new THREE.Font(r),d={size:12,height:1,curveSegments:2,font:h},p=new THREE.TextGeometry("N",d),m=new THREE.TextGeometry("S",d),g=new THREE.TextGeometry("E",d),v=new THREE.TextGeometry("W",d);p.computeBoundingBox(),m.computeBoundingBox(),g.computeBoundingBox(),v.computeBoundingBox();var y,E,x,b,C;y=-.5*(p.boundingBox.max.x-p.boundingBox.min.x),E=new THREE.Mesh(p,i),E.translateX(y),E.translateY(82),y=-.5*(m.boundingBox.max.x-m.boundingBox.min.x),x=new THREE.Mesh(m,i),x.rotateZ(Math.PI),x.translateX(y),x.translateY(82),y=-.5*(g.boundingBox.max.x-g.boundingBox.min.x),b=new THREE.Mesh(g,i),b.rotateZ(-Math.PI/2),b.translateX(y),b.translateY(82),y=-.5*(g.boundingBox.max.x-g.boundingBox.min.x),C=new THREE.Mesh(v,i),C.rotateZ(Math.PI/2),C.translateX(y),C.translateY(82),f.add(E),f.add(x),f.add(b),f.add(C);var M=new THREE.RingGeometry(65,82,32,5,0,2*Math.PI),_=new THREE.Mesh(M,e);_.name=o.Compass,f.add(_)},ce=function(){var e={color:10069173,side:THREE.DoubleSide},t={color:10069173,side:THREE.DoubleSide},i=Math.asin(10/75),n=Math.PI/2-2*i,r=new THREE.RingGeometry(73.5,76.5,32,5,i,n),a=new THREE.Mesh(r,new THREE.MeshBasicMaterial(e));a.name=o.ControlRingNorthEast,p.add(a);var a=new THREE.Mesh(r,new THREE.MeshBasicMaterial(e));a.name=o.ControlRingNorthWest,a.rotateZ(Math.PI/2),p.add(a);var a=new THREE.Mesh(r,new THREE.MeshBasicMaterial(e));a.name=o.ControlRingSouthWest,a.rotateZ(Math.PI),p.add(a);var a=new THREE.Mesh(r,new THREE.MeshBasicMaterial(e));a.name=o.ControlRingSouthEast,a.rotateZ(-Math.PI/2),p.add(a);var s=new THREE.Shape;s.moveTo(10,0),s.absarc(0,0,10,0,2*Math.PI,!1);var l=new THREE.ShapeGeometry(s),a=new THREE.Mesh(l,new THREE.MeshBasicMaterial(t));a.name=o.ControlPointNorth,a.rotateZ(Math.PI/2),a.translateX(75),p.add(a);var a=new THREE.Mesh(l,new THREE.MeshBasicMaterial(t));a.name=o.ControlPointSouth,a.rotateZ(-Math.PI/2),a.translateX(75),p.add(a);var a=new THREE.Mesh(l,new THREE.MeshBasicMaterial(t));a.name=o.ControlPointEast,a.translateX(75),p.add(a);var a=new THREE.Mesh(l,new THREE.MeshBasicMaterial(t));a.name=o.ControlPointWest,a.translateX(-75),p.add(a)},ue=function(){var e=[];e.push(new THREE.Vector3(0,30,0)),e.push(new THREE.Vector3(-15,15,0)),e.push(new THREE.Vector3(-12,15,0)),e.push(new THREE.Vector3(-12,0,0)),e.push(new THREE.Vector3(-4,0,0)),e.push(new THREE.Vector3(-4,13,0)),e.push(new THREE.Vector3(4,13,0)),e.push(new THREE.Vector3(4,0,0)),e.push(new THREE.Vector3(12,0,0)),e.push(new THREE.Vector3(12,15,0)),e.push(new THREE.Vector3(15,15,0)),e.push(new THREE.Vector3(0,30,0));for(var t=new THREE.Geometry,i=0;i<e.length;++i)t.vertices.push(e[i].multiplyScalar(1));var n=new THREE.Line(t,new THREE.LineBasicMaterial({color:7895160,linewidth:5}));n.position.x=-95,n.position.y=80,g.add(n);var r=new THREE.Shape;r.moveTo(e[0].x,e[0].y);for(var a=1;a<e.length;++a)r.lineTo(e[a].x,e[a].y);var t=new THREE.ShapeGeometry(r),n=new THREE.Mesh(t,new THREE.MeshBasicMaterial({color:15198188,side:THREE.DoubleSide}));n.position.x=-95,n.position.y=80,n.name=o.Home,g.add(n)},he=function(){var e={color:11653612,side:THREE.DoubleSide},t={color:489172,linewidth:5},i=Math.asin(10/75),n=Math.PI/2-2*i,r=new THREE.RingGeometry(75-10/3,75+10/3,32,5,i,n);A=75,U=new THREE.Mesh(r,new THREE.MeshBasicMaterial(e)),U.translateZ(.01),y.add(U),B=new THREE.Quaternion,B.copy(U.quaternion),P=new THREE.Vector3,P.copy(U.position);var a=new THREE.Shape;a.moveTo(10,0),
a.absarc(0,0,10,0,2*Math.PI,!1);var o=new THREE.ShapeGeometry(a);N=new THREE.Mesh(o,new THREE.MeshBasicMaterial(e)),N.translateZ(.01),y.add(N),k=new THREE.Quaternion,k.copy(N.quaternion),F=new THREE.Vector3,F.copy(N.position);for(var s=[new THREE.Vector3(20*.707/4,20*.707/2,0),new THREE.Vector3(-20*.707/4,0,0),new THREE.Vector3(20*.707/4,-20*.707/2,0)],o=new THREE.Geometry,l=0;l<s.length;++l)o.vertices.push(s[l]);H=new THREE.Line(o,new THREE.LineBasicMaterial(t)),H.translateZ(.015),y.add(H),G=new THREE.Quaternion,G.copy(H.quaternion),V=new THREE.Vector3,V.copy(H.position),U.visible=!1,N.visible=!1,H.visible=!1},de=function(e){var t=self.container;if(void 0!==t){var n=CLOUD.DomUtil2D.getContainerOffsetToClient(t),r=new THREE.Vector2;if(r.x=e.x-n.left,r.y=e.y-n.top,r.x>0&&r.x<i.width&&r.y>0&&r.y<i.height)return Q.x=r.x/i.width*2-1,Q.y=-r.y/i.height*2+1,!0}return!1},fe=function(e){W=e,g.visible=!!e},pe=function(e){if(X=e,e){for(var t=m.children,i=0;i<t.length;i++)t[i].material.transparent=!0,t[i].material.opacity=.6;for(var n=p.children,i=0;i<n.length;i++)n[i].material.transparent=!0,n[i].material.opacity=.6;for(var r=f.children,i=0;i<r.length;i++)r[i].material.transparent=!0,r[i].material.opacity=.6;for(var a=g.children,i=0;i<a.length;i++)a[i].material.transparent=!0,a[i].material.opacity=.6}else{for(var t=m.children,i=0;i<t.length;i++)t[i].material.transparent=!1,t[i].material.opacity=1;for(var n=p.children,i=0;i<n.length;i++)n[i].material.transparent=!1,n[i].material.opacity=1;for(var r=f.children,i=0;i<r.length;i++)r[i].material.transparent=!1,r[i].material.opacity=1;for(var a=g.children,i=0;i<a.length;i++)a[i].material.transparent=!1,a[i].material.opacity=1}},me=function(e){var t=-1,i=!1;switch(Q.x*Q.y>0&&(i=!0),e){case o.Home:t=a.Home;break;case o.RoofCenter:t=ie===a.RoofFront||ie===a.RoofSouthEast||ie===a.RoofSouthWest?a.Top:ie===a.RoofRight?a.TopTurnRight:ie===a.RoofBack||ie===a.RoofNorthEast||ie===a.RoofNorthWest?a.TopTurnBack:ie===a.RoofLeft?a.TopTurnLeft:ie===a.TopTurnRight?a.TopTurnRight:ie===a.TopTurnBack?a.TopTurnBack:ie===a.TopTurnLeft?a.TopTurnLeft:a.Top;break;case o.BottomFloor:t=ie===a.BottomFront||ie===a.BottomSouthEast||ie===a.BottomSouthWest?a.Bottom:ie===a.BottomRight?a.BottomTurnLeft:ie===a.BottomBack||ie===a.BottomNorthEast||ie===a.BottomNorthWest?a.BottomTurnBack:ie===a.BottomLeft?a.BottomTurnRight:ie===a.BottomTurnRight?a.BottomTurnRight:ie===a.BottomTurnBack?a.BottomTurnBack:ie===a.BottomTurnLeft?a.BottomTurnLeft:a.Bottom;break;case o.BottomSouth:t=a.BottomFront;break;case o.BottomNorth:t=a.BottomBack;break;case o.BottomEast:t=a.BottomRight;break;case o.BottomWest:t=a.BottomLeft;break;case o.BottomSouthEast:t=a.BottomSouthEast;break;case o.BottomSouthWest:t=a.BottomSouthWest;break;case o.BottomNorthWest:t=a.BottomNorthWest;break;case o.BottomNorthEast:t=a.BottomNorthEast;break;case o.MiddleSouth:case o.MiddleDoor:t=a.Front;break;case o.MiddleNorth:t=a.Back;break;case o.MiddleRightWindow:case o.MiddleEast:t=a.Right;break;case o.MiddleWest:case o.MiddleLeftWindow:t=a.Left;break;case o.MiddleSouthEast:t=a.SouthEast;break;case o.MiddleSouthWest:t=a.SouthWest;break;case o.MiddleNorthWest:t=a.NorthWest;break;case o.MiddleNorthEast:t=a.NorthEast;break;case o.RoofSouth:t=a.RoofFront;break;case o.RoofNorth:t=a.RoofBack;break;case o.RoofEast:t=a.RoofRight;break;case o.RoofWest:t=a.RoofLeft;break;case o.RoofSouthEast:t=a.RoofSouthEast;break;case o.RoofSouthWest:t=a.RoofSouthWest;break;case o.RoofNorthWest:t=a.RoofNorthWest;break;case o.RoofNorthEast:t=a.RoofNorthEast;break;case o.ControlPointNorth:t=ie===a.Front?a.Top:ie===a.Top?a.Back:ie===a.Back?a.TopTurnBack:ie===a.TopTurnBack?a.Front:ie===a.Right?a.TopTurnRight:ie===a.TopTurnRight?a.Left:ie===a.Left?a.TopTurnLeft:ie===a.TopTurnLeft?a.Right:ie===a.BackTurnRight?a.Left:ie===a.BackTurnLeft?a.Right:ie===a.BackTurnTop?a.Back:ie===a.RightTurnFront?a.Back:ie===a.RightTurnBack?a.Front:ie===a.RightTurnTop?a.Bottom:ie===a.LeftTurnFront?a.Back:ie===a.LeftTurnBack?a.Front:ie===a.LeftTurnTop?a.Bottom:ie===a.BottomTurnRight?a.Left:ie===a.BottomTurnLeft?a.Right:ie===a.BottomTurnBack?a.Back:ie===a.FrontTurnRight?a.Left:ie===a.FrontTurnLeft?a.Right:ie===a.FrontTurnTop?a.Bottom:a.Top;break;case o.ControlPointSouth:t=ie===a.Front?a.Bottom:ie===a.Bottom?a.Back:ie===a.Back?a.BottomTurnBack:ie===a.BottomTurnBack?a.Front:ie===a.Right?a.BottomTurnRight:ie===a.BottomTurnRight?a.Left:ie===a.Left?a.BottomTurnLeft:ie===a.BottomTurnLeft?a.Right:ie===a.FrontTurnRight?a.Right:ie===a.FrontTurnLeft?a.Left:ie===a.FrontTurnTop?a.Top:ie===a.RightTurnFront?a.Front:ie===a.RightTurnBack?a.Back:ie===a.RightTurnTop?a.Top:ie===a.BackTurnRight?a.Right:ie===a.BackTurnLeft?a.Left:ie===a.BackTurnTop?a.Top:ie===a.LeftTurnFront?a.Front:ie===a.LeftTurnBack?a.Back:ie===a.LeftTurnTop?a.Top:ie===a.Top?a.Front:ie===a.TopTurnRight?a.Right:ie===a.TopTurnBack?a.Back:ie===a.TopTurnLeft?a.Left:a.Bottom;break;case o.ControlPointEast:t=ie===a.Front?a.Right:ie===a.Right?a.Back:ie===a.Back?a.Left:ie===a.Left?a.Front:ie===a.Top?a.Right:ie===a.TopTurnRight?a.Back:ie===a.TopTurnBack?a.Left:ie===a.TopTurnLeft?a.Front:ie===a.Bottom?a.Right:ie===a.BottomTurnRight?a.Front:ie===a.BottomTurnBack?a.Left:ie===a.BottomTurnLeft?a.Back:ie===a.FrontTurnRight?a.Top:ie===a.FrontTurnLeft?a.Bottom:ie===a.FrontTurnTop?a.Left:ie===a.RightTurnFront?a.Back:ie===a.RightTurnBack?a.Top:ie===a.RightTurnTop?a.Front:ie===a.BackTurnRight?a.Top:ie===a.BackTurnLeft?a.Bottom:ie===a.BackTurnTop?a.Left:ie===a.LeftTurnFront?a.Top:ie===a.LeftTurnBack?a.Bottom:ie===a.LeftTurnTop?a.Back:a.Right;break;case o.ControlPointWest:t=ie===a.Front?a.Left:ie===a.Left?a.Back:ie===a.Back?a.Right:ie===a.Right?a.Front:ie===a.Front?a.Left:ie===a.Top?a.Left:ie===a.TopTurnRight?a.Front:ie===a.TopTurnBack?a.Right:ie===a.TopTurnLeft?a.Back:ie===a.Bottom?a.Left:ie===a.BottomTurnRight?a.Back:ie===a.BottomTurnBack?a.Right:ie===a.BottomTurnLeft?a.Front:ie===a.FrontTurnRight?a.Bottom:ie===a.FrontTurnLeft?a.Top:ie===a.FrontTurnTop?a.Right:ie===a.RightTurnFront?a.Top:ie===a.RightTurnBack?a.Bottom:ie===a.RightTurnTop?a.Back:ie===a.BackTurnRight?a.Top:ie===a.BackTurnLeft?a.Bottom:ie===a.BackTurnTop?a.Right:ie===a.LeftTurnFront?a.Bottom:ie===a.LeftTurnBack?a.Top:ie===a.LeftTurnTop?a.Front:a.Left;break;case o.ControlRingNorthEast:case o.ControlRingSouthWest:case o.ControlRingNorthWest:case o.ControlRingSouthEast:t=i?ie===a.Front?a.FrontTurnRight:ie===a.FrontTurnRight?a.FrontTurnTop:ie===a.FrontTurnTop?a.FrontTurnLeft:ie===a.FrontTurnLeft?a.Front:ie===a.Right?a.RightTurnBack:ie===a.RightTurnBack?a.RightTurnTop:ie===a.RightTurnTop?a.RightTurnFront:ie===a.RightTurnFront?a.Right:ie===a.Back?a.BackTurnRight:ie===a.BackTurnRight?a.BackTurnTop:ie===a.BackTurnTop?a.BackTurnLeft:ie===a.BackTurnLeft?a.Back:ie===a.Left?a.LeftTurnFront:ie===a.LeftTurnFront?a.LeftTurnTop:ie===a.LeftTurnTop?a.LeftTurnBack:ie===a.LeftTurnBack?a.Left:ie===a.Top?a.TopTurnRight:ie===a.TopTurnRight?a.TopTurnBack:ie===a.TopTurnBack?a.TopTurnLeft:ie===a.TopTurnLeft?a.Top:ie===a.Bottom?a.BottomTurnRight:ie===a.BottomTurnRight?a.BottomTurnBack:ie===a.BottomTurnBack?a.BottomTurnLeft:ie===a.BottomTurnLeft?a.Bottom:a.FrontTurnRight:ie===a.Front?a.FrontTurnLeft:ie===a.FrontTurnLeft?a.FrontTurnTop:ie===a.FrontTurnTop?a.FrontTurnRight:ie===a.FrontTurnRight?a.Front:ie===a.Right?a.RightTurnFront:ie===a.RightTurnFront?a.RightTurnTop:ie===a.RightTurnTop?a.RightTurnBack:ie===a.RightTurnBack?a.Right:ie===a.Back?a.BackTurnLeft:ie===a.BackTurnLeft?a.BackTurnTop:ie===a.BackTurnTop?a.BackTurnRight:ie===a.BackTurnRight?a.Back:ie===a.Left?a.LeftTurnBack:ie===a.LeftTurnBack?a.LeftTurnTop:ie===a.LeftTurnTop?a.LeftTurnFront:ie===a.LeftTurnFront?a.Left:ie===a.Top?a.TopTurnLeft:ie===a.TopTurnLeft?a.TopTurnBack:ie===a.TopTurnBack?a.TopTurnRight:ie===a.TopTurnRight?a.Top:ie===a.Bottom?a.BottomTurnLeft:ie===a.BottomTurnLeft?a.BottomTurnBack:ie===a.BottomTurnBack?a.BottomTurnRight:ie===a.BottomTurnRight?a.Bottom:a.FrontTurnLeft}ie=t},ge=function(e,t){if(t){var n=!1;switch(Q.x*Q.y>0&&(n=!0),e===o.MiddleDoor?M.material.color.setHex(i.pickedColor):e!==o.MiddleSouth&&M.material.color.setHex(_),e===o.MiddleSouth?b.material.color.setHex(i.pickedColor):e!==o.MiddleDoor&&b.material.color.setHex(C),e===o.MiddleWest?w.material.color.setHex(i.pickedColor):e!==o.MiddleLeftWindow&&w.material.color.setHex(L),e===o.MiddleLeftWindow?S.material.color.setHex(i.pickedColor):e!==o.MiddleWest&&S.material.color.setHex(O),e===o.MiddleEast?T.material.color.setHex(i.pickedColor):e!==o.MiddleRightWindow&&T.material.color.setHex(I),e===o.MiddleRightWindow?D.material.color.setHex(i.pickedColor):e!==o.MiddleEast&&D.material.color.setHex(R),e){case o.ControlRingNorthEast:U.visible=!0,U.quaternion.copy(B),U.position.copy(P),N.visible=!0,N.quaternion.copy(k),N.position.copy(F),N.rotateZ(Math.PI/4),N.translateX(A),H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(Math.PI/4),H.translateX(A),n?H.rotateZ(Math.PI/2):H.rotateZ(-Math.PI/2);break;case o.ControlRingNorthWest:U.visible=!0,U.quaternion.copy(B),U.position.copy(P),U.rotateZ(Math.PI/2),N.visible=!0,N.quaternion.copy(k),N.position.copy(F),N.rotateZ(3*Math.PI/4),N.translateX(A),H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(3*Math.PI/4),H.translateX(A),n?H.rotateZ(Math.PI/2):H.rotateZ(-Math.PI/2);break;case o.ControlRingSouthWest:U.visible=!0,U.quaternion.copy(B),U.position.copy(P),U.rotateZ(Math.PI),N.visible=!0,N.quaternion.copy(k),N.position.copy(F),N.rotateZ(3*-Math.PI/4),N.translateX(A),H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(3*-Math.PI/4),H.translateX(A),n?H.rotateZ(Math.PI/2):H.rotateZ(-Math.PI/2);break;case o.ControlRingSouthEast:U.visible=!0,U.quaternion.copy(B),U.position.copy(P),U.rotateZ(-Math.PI/2),N.visible=!0,N.quaternion.copy(k),N.position.copy(F),N.rotateZ(-Math.PI/4),N.translateX(A),H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(-Math.PI/4),H.translateX(A),n?H.rotateZ(Math.PI/2):H.rotateZ(-Math.PI/2);break;case o.ControlPointNorth:U.visible=!1,N.visible=!1,H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(Math.PI/2),H.translateX(A);break;case o.ControlPointSouth:U.visible=!1,N.visible=!1,H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(-Math.PI/2),H.translateX(A);break;case o.ControlPointEast:U.visible=!1,N.visible=!1,H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.translateX(A);break;case o.ControlPointWest:U.visible=!1,N.visible=!1,H.visible=!0,H.quaternion.copy(G),H.position.copy(V),H.rotateZ(Math.PI),H.translateX(A);break;default:U.visible=!1,N.visible=!1,H.visible=!1}}else U.visible&&(U.visible=!1),N.visible&&(N.visible=!1),H.visible&&(H.visible=!1)},ve=function(e){ee!=e&&(ee&&ee.material.color.setHex(ee.currentHex),ee=e,ee.currentHex=ee.material.color.getHex(),""!==ee.name&&ee.material.color.setHex(i.pickedColor),ge(ee.name,!0))},ye=function(){ee&&ee.material.color.setHex(ee.currentHex),ge("",!1),ee=null},Ee=function(){d.setFromCamera(Q,h);var e=d.intersectObjects(v.children,!0);if(e.length>0)ve(e[0].object);else{c.setFromCamera(Q,l);var t=c.intersectObjects(s.children,!0);t.length>0?ve(t[0].object):ye()}},xe=function(e,t,i){return e>t?e-t<=i:t-e<=i},be=function(e){var t=e.clone();return t.normalize(),!xe(t.y,0,1e-4)},Ce=function(e){var t=e.clone();return t.normalize(),!!(xe(t.x,0,1e-4)&&xe(t.y,0,1e-4)||xe(t.x,0,1e-4)&&xe(t.z,0,1e-4)||xe(t.y,0,1e-4)&&xe(t.z,0,1e-4))},Me=function(e){var t=e.clone();return t.normalize(),!!(xe(t.x,0,1e-4)&&xe(t.y,1,1e-4)&&xe(t.z,0,1e-4))},_e=function(e,t){var i=e.clone();i.normalize();var n=t.clone();if(n.normalize(),xe(i.x,0,1e-4)&&xe(i.y,-1,1e-4)&&xe(i.z,0,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,-1,1e-4))return a.Top;if(xe(n.x,-1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.TopTurnRight;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,1,1e-4))return a.TopTurnBack;if(xe(n.x,1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.TopTurnLeft}if(xe(i.x,0,1e-4)&&xe(i.y,1,1e-4)&&xe(i.z,0,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,1,1e-4))return a.Bottom;if(xe(n.x,-1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.BottomTurnRight;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,-1,1e-4))return a.BottomTurnBack;if(xe(n.x,1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.Bottom}if(xe(i.x,0,1e-4)&&xe(i.y,0,1e-4)&&xe(i.z,-1,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,1,1e-4)&&xe(n.z,0,1e-4))return a.Front;if(xe(n.x,0,1e-4)&&xe(n.y,-1,1e-4)&&xe(n.z,0,1e-4))return a.FrontTurnTop;if(xe(n.x,1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.FrontTurnLeft;if(xe(n.x,-1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.FrontTurnRight}if(xe(i.x,0,1e-4)&&xe(i.y,0,1e-4)&&xe(i.z,1,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,1,1e-4)&&xe(n.z,0,1e-4))return a.Back;if(xe(n.x,0,1e-4)&&xe(n.y,-1,1e-4)&&xe(n.z,0,1e-4))return a.BackTurnTop;if(xe(n.x,-1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.BackTurnLeft;if(xe(n.x,1,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,0,1e-4))return a.BackTurnRight}if(xe(i.x,-1,1e-4)&&xe(i.y,0,1e-4)&&xe(i.z,0,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,1,1e-4)&&xe(n.z,0,1e-4))return a.Right;if(xe(n.x,0,1e-4)&&xe(n.y,-1,1e-4)&&xe(n.z,0,1e-4))return a.RightTurnTop;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,-1,1e-4))return a.RightTurnFront;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,1,1e-4))return a.RightTurnBack}if(xe(i.x,1,1e-4)&&xe(i.y,0,1e-4)&&xe(i.z,0,1e-4)){if(xe(n.x,0,1e-4)&&xe(n.y,1,1e-4)&&xe(n.z,0,1e-4))return a.Left;if(xe(n.x,0,1e-4)&&xe(n.y,-1,1e-4)&&xe(n.z,0,1e-4))return a.LeftTurnTop;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,-1,1e-4))return a.LeftTurnFront;if(xe(n.x,0,1e-4)&&xe(n.y,0,1e-4)&&xe(n.z,1,1e-4))return a.LeftTurnBack}return-1};this.init=function(e){n=new THREE.WebGLRenderer({antialias:!0,alpha:!0,preserveDrawingBuffer:!0}),self.container=e,e.appendChild(n.domElement),this.resize(e.offsetWidth,e.offsetHeight,this.viewer.isMobile),this.addDomEventListeners()},this.uninit=function(){this.removeDomEventListeners(),self.container.innerHTML=""},this.enable=function(){n&&!n.domElement.parentNode&&(self.container.appendChild(n.domElement),this.addDomEventListeners())},this.disable=function(){n&&n.domElement.parentNode&&(this.removeDomEventListeners(),self.container.innerHTML="")},this.enableCompass=function(e){z=e},this.addDomEventListeners=function(){n.domElement&&(n.domElement.addEventListener("contextmenu",this.onMouseContextMenuBinded,!1),n.domElement.addEventListener("mousedown",this.onMouseDownBinded,!1),n.domElement.addEventListener("mouseover",this.onMouseOverBinded,!1),n.domElement.addEventListener("mouseout",this.onMouseOutBinded,!1))},this.removeDomEventListeners=function(){n.domElement&&(n.domElement.removeEventListener("contextmenu",this.onMouseContextMenuBinded),n.domElement.removeEventListener("mousedown",this.onMouseDownBinded),n.domElement.removeEventListener("mouseover",this.onMouseOverBinded),n.domElement.removeEventListener("mouseout",this.onMouseOutBinded))},this.clearHighlightState=function(){var e=!1;J&&(ye(),J=!1,e=!0),!1===X&&(pe(!0),e=!0),W&&(fe(!1),e=!0),e&&this.render()},this.mouseContextMenu=function(e){e.preventDefault()},this.mouseDown=function(e){e.preventDefault(),e.stopPropagation();var t=new THREE.Vector2(e.clientX,e.clientY),n=de(t);if(n&&e.button===i.mouseButtons.LEFT&&(q=!1,ee)){ee.name===o.Compass&&(q=!0,Y.set(t.x,t.y))}return window.addEventListener("mouseup",this.onMouseUpBinded,!1),n},this.mouseMove=function(e){e.stopPropagation();var t=!1,i=new THREE.Vector2(e.clientX,e.clientY),n=de(i);if(q)Z.set(i.x,i.y),K.subVectors(Z,Y),this.preRotationHandle&&!this.preRotationHandle()||(this.viewer.rotateCamera(K),Y.copy(Z));else if(n){if(X&&(pe(!1),t=!0),!1===W&&(fe(!0),t=!0),Ee(),ee){if(""!==ee.name){var r=ee.name;r===o.MiddleDoor?r=o.MiddleSouth:r===o.MiddleLeftWindow?r=o.MiddleWest:r===o.MiddleRightWindow&&(r=o.MiddleEast),$!==r&&($=r,J=!0,t=!0)}}else""!==$&&($="",J=!1,t=!0);t&&this.render(),ne=!0}else ne&&(ne=!1,this.clearHighlightState());return n},this.mouseUp=function(e){e.stopPropagation();var t=new THREE.Vector2(e.clientX,e.clientY),n=de(t);return q?(q=!1,Z.set(t.x,t.y),K.subVectors(Z,Y),this.preRotationHandle&&!this.preRotationHandle()||(this.viewer.rotateCamera(K),Y.copy(Z)),!n&&j&&(j=!1,window.removeEventListener("mousemove",this.onMouseMoveBinded),this.clearHighlightState())):n&&e.button===i.mouseButtons.LEFT&&ee&&(ie=-1,this.preRotationHandle&&!this.preRotationHandle()||me(ee.name),-1!==ie&&void 0!==ie&&null!==ie&&this.viewer.setStandardView(ie,null,function(){i.render()})),window.removeEventListener("mouseup",this.onMouseUpBinded),n},this.mouseOver=function(e){e.preventDefault(),e.stopPropagation(),j||(j=!0,window.addEventListener("mousemove",this.onMouseMoveBinded,!1))},this.mouseOut=function(e){e.preventDefault(),e.stopPropagation(),!q&&j&&(j=!1,window.removeEventListener("mousemove",this.onMouseMoveBinded),this.clearHighlightState())},this.render=function(){if(this.visible&&!this.isDisable&&n){var e=this.viewer.getActiveCameraInfo(),t=e.dir;l.up.copy(e.up),l.lookAt(e.dir),l.updateMatrixWorld(),-1===ie&&(ie=_e(t,l.up)),Ce(t)?p.visible=!0:p.visible=!1,this.isAnimationFinish||(p.visible=!1),!1===p.visible&&(U.visible=!1,N.visible=!1,H.visible=!1),p.position.copy(E),y.position.copy(x),p.visible&&Me(t)&&(p.translateZ(te+1),y.translateZ(te+1)),z&&be(t)?f.visible=!0:f.visible=!1,n.autoClear=!0,n.render(s,l),n.autoClear=!1,n.render(u,h),n.autoClear=!0}},this.resize=function(e,t){this.width=e,this.height=t,n.setSize(e,t)},this.onMouseDownBinded=this.mouseDown.bind(this),this.onMouseMoveBinded=this.mouseMove.bind(this),this.onMouseUpBinded=this.mouseUp.bind(this),this.onMouseOverBinded=this.mouseOver.bind(this),this.onMouseOutBinded=this.mouseOut.bind(this),this.onMouseContextMenuBinded=this.mouseContextMenu.bind(this),function(){le(),se(),ce(),ue(),he(),f.translateZ(-te),s.add(f),s.add(m);var e=new THREE.Euler(-Math.PI/2,0,0,THREE.Euler.DefaultOrder);s.rotation.copy(e),v.add(g),v.add(p),p.translateZ(30),u.add(v),u.add(y)}(),pe(!0),fe(!1)},function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Authentication"),t=function(){return{APIHost:hostConfig.APIHost,viewToken:null}};e.AuthenticationConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Authentication"),t=(Glodon.Web,Glodon.Web.Lang.Utility.HttpRequest),i=function(e){this.config=e};i.prototype.authenticate=function(e,i){var n=this,r=n.config;t.ajax({url:r.APIHost+"/inside/databag?viewToken="+r.viewToken,success:function(t){var a=JSON.parse(t);"success"==a.code?(a.data.viewToken=r.viewToken,n.data=a.data,e&&e(a.data)):i&&i(a)},failure:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=JSON.parse(e);i&&i(t)})})},e.AuthenticationManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=function(){return{APIHost:hostConfig.APIHost,resourceHost:hostConfig.resourceHost,viewToken:null,modelId:null,modelType:"singleModel",dataEnvType:hostConfig.dataEnvType||"BIMFACE"}};e.MetaDataManagerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=Glodon.Web.Lang.Utility.HttpRequest.promiseJSONRequest,i=Glodon.Web.Lang.Utility.HttpRequest.ajax,n={getAreas:function(e){var i=e.relativeUrl+"/data/spaces.json";return t(i)},getModelTree:function(e){if("singleModel"==e.modelType)var i=e.relativeUrl+"/data/tree.json";else var i=e.relativeUrl+"/data/specialtyTree.json";return t(i)},getObjectData:function(e,t){return new Promise(function(i,n){if(t._objectData)i(t._objectData);else{var r=new Glodon.Bimface.Data.ObjectPropertyManager(e.relativeUrl+"/property");r.load(function(){t._objectData=r,i(t._objectData)})}})},getMaterialProperty:function(e,i){var n=i.split(".");if("singleModel"==e.modelType)var r=e.relativeUrl+"/metadata/materialmap.json";else var r=e.relativeUrl+"/metadata/"+n[0]+"/materialmap.json";return t(r,"noCode")},getMaterialPropertyItem:function(e,i,n){var r=i.split("."),a="singleModel"==e.modelType?e.relativeUrl+"/metadata/materials/"+n+".json":e.relativeUrl+"/metadata/"+r[0]+"/materials/"+n+".json";return t(a,"noCode")},getAreaProperty:function(e,i){var n=e.split("_");if("singleModel"==i.modelType)var r=i.relativeUrl+"/metadata/areas.json";else var r=i.relativeUrl+"/metadata/"+n[0]+"/areas.json";return t(r,"noCode")},getRoomProperty:function(e,i){var n=e.split("_");if("singleModel"==i.modelType)var r=i.relativeUrl+"/metadata/rooms.json";else var r=i.relativeUrl+"/metadata/"+n[0]+"/rooms.json";return t(r,"noCode")},getFiles:function(e){var i=e.relativeUrl+"/data/files.json";return t(i)},getDrawingsheets:function(e,i){if("singleModel"==e.modelType)var n=e.relativeUrl+"/metadata/drawings.json";else var n=e.relativeUrl+"/data/"+i+"/drawingsheets.json";return t(n,"noCode")},getLevels:function(e){if("singleModel"==e.modelType)var i=e.relativeUrl+"/metadata/levels.json";else var i=e.relativeUrl+"/metadata/levels.json";return t(i,"noCode")},getMapInfo:function(e){var t=this,n=(t._opt,{}),r=[];t._helper;return i({url:e.relativeUrl+"/metadata/grids.json",async:!1,success:function(e){for(var t=JSON.parse(e),i=[],r=0,a=t.grids.length;r<a;r++){var o=t.grids[r];o.start.X=o.start.x,o.start.Y=o.start.y,o.start.Z=o.start.z,o.end.X=o.end.x,o.end.Y=o.end.y,o.end.Z=o.end.z,i.push(o)}n.Grids=i}}),i({async:!1,url:e.relativeUrl+"/metadata/levels.json",success:function(e){n.Levels=JSON.parse(e).levels}}),i({async:!1,url:e.relativeUrl+"/resource/v3/maps/output.json",dataType:"text",success:function(t){var i=JSON.parse(t);for(var n in i){var a=i[n];void 0==a.id&&(a.id=n),a.path=e.relativeUrl+"/resource/v3/maps/"+a.id+".png",a.name=n,r.push(a)}}}),{axisGrid:n,floors:r}},getAllDrawingsheets:function(e){var i=e.relativeUrl+"/metadata/drawings.json";return t(i,"noCode")},decodeElementId:function(e,t){if(/^[0-9]*\.*[0-9]*$/.test(t))return Promise.resolve(t);var i=t.split("."),n=i[0];return this.getFiles(e).then(function(e){var t=!0,r=!1,a=void 0;try{for(var o,s=e[Symbol.iterator]();!(t=(o=s.next()).done);t=!0){var l=o.value,c=!0,u=!1,h=void 0;try{for(var d,f=l.linkedBy[Symbol.iterator]();!(c=(d=f.next()).done);c=!0){if(d.value==n)return l.fileId+"."+i[1]}}catch(e){u=!0,h=e}finally{try{!c&&f.return&&f.return()}finally{if(u)throw h}}}}catch(e){r=!0,a=e}finally{try{!t&&s.return&&s.return()}finally{if(r)throw a}}}).then(function(e){return e})},getCategoryVisibility:function(e){var i=e.relativeUrl+"/metadata/categoryVisibility.json";return t(i,"noCode")},getSegmentGroups:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentGroups?view_token="+e.viewToken;return t(i,"noCode")},getSegmentFromGroups:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentGroups/"+i+"/segments?view_token="+e.viewToken;return t(n,"noCode")},getSegmentTree:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentTree?view_token="+e.viewToken;return t(i,"noCode")},getSegmentById:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segments/"+i+"?view_token="+e.viewToken;return t(n,"noCode")},getSegmentElementIds:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segments/"+i+"/elementIds?view_token="+e.viewToken;return t(n,"noCode")},getPartialElementsMetadata:function(e,i){var n=e.relativeUrlWithoutDatabagId+"/"+i+"/metadata/partial_elements_metadata.json";return t(n,"noCode")},getPartialElementsMetadataFile:function(e,t){return e.relativeUrlWithoutDatabagId+"/"+t+"/metadata/partial_elements_metadata.json"},getDatabagResource:function(e,t){return e.relativeUrlWithoutDatabagId+"/"+t+"/resource/v3/model"},getModelGroup:function(e,i){var n=e.relativeUrlWithoutDatabagId+"/"+i+"/metadata/collectionTree.json";return t(n,"noCode")}};e.OfflineDataProdiver=n}(),function(){function e(e){this._config=e}var t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data.OfflineDataProdiver");e.prototype={getComponentProperty:function(e,t,n){var r=this;if(!e)return console.warn("elementId must not be empty!."),void(n&&n());var a=null;i.getObjectData(this._config,this).then(function(t){return a=t,i.decodeElementId(r._config,e)}).then(function(e){var i=a.getBoundingBox(e),n=a.getElementProperties(e),r={},o=!0,s=!1,l=void 0;try{for(var c,u=n[0].items[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var h=c.value;r[h.key]=h.value}}catch(e){s=!0,l=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw l}}t({boundingBox:i,elementId:r.ID,familyGuid:"",guid:r.GUID,name:r.familyType,properties:n})})},getMaterialProperty:function(e,t,n){var r=this;i.decodeElementId(r._config,e).then(function(e){i.getMaterialProperty(r._config,e).then(function(a){var o=e.split(".");o="singleModel"==r._config.modelType?o[0]:o[1];var s=[];if(a[o]){var l=!0,c=!1,u=void 0;try{for(var h,d=a[o][Symbol.iterator]();!(l=(h=d.next()).done);l=!0){var f=h.value;s.push(i.getMaterialPropertyItem(r._config,e,f))}}catch(e){c=!0,u=e}finally{try{!l&&d.return&&d.return()}finally{if(c)throw u}}Promise.all(s).then(function(e){t&&t(e)})}else n&&n(a)})})},getAreas:function(e,t){i.getAreas(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getModelTree:function(e,t){var n=this;i.getModelTree(n._config).then(function(t){e&&e(t,n._config.modelType)}).catch(function(e){t&&t(e)})},getRoomProperty:function(e,t,n){var r=this;i.getRoomProperty(e,this._config).then(function(n){var a="singleModel"==r._config.modelType?e:e.split("_")[1],o=!0,s=!1,l=void 0;try{for(var c,u=n[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var h=c.value;if(h.id==a)return void i.getObjectData(r._config,r).then(function(i){e="singleModel"==r._config.modelType?e:e.split("_")[0]+"."+e.split("_")[1];var n=i.getElementProperties(e);n.splice(0,1),h.properties=n,t&&t(h)})}}catch(e){s=!0,l=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw l}}})},getAreaProperty:function(e,t,n){var r=this;i.getAreaProperty(e,this._config).then(function(n){var a="singleModel"==r._config.modelType?e:e.split("_")[1],o=!0,s=!1,l=void 0;try{for(var c,u=n.areas[Symbol.iterator]();!(o=(c=u.next()).done);o=!0){var h=c.value;h.id==a&&i.getObjectData(r._config,r).then(function(i){e="singleModel"==r._config.modelType?e:e.split("_")[0]+"."+e.split("_")[1];var n=i.getElementProperties(e);n.splice(0,1),h.properties=n,t&&t(h)})}}catch(e){s=!0,l=e}finally{try{!o&&u.return&&u.return()}finally{if(s)throw l}}})},getModelGroup:function(e,t){i.getModelGroup(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getFiles:function(e,t){i.getFiles(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getLinkGraph:function(e,t){i.getFiles(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getDrawingsheets:function(e,t,n,r){var a=this;i.getDrawingsheets(this._config,e).then(function(e){n&&n(e,a._config.modelType,a._config.dataEnvType)})},getFloors:function(e,t){var n=this;i.getLevels(this._config).then(function(t){var i=!0,r=!1,a=void 0;try{for(var o,s=t.levels[Symbol.iterator]();!(i=(o=s.next()).done);i=!0){var l=o.value;l.miniMap=n._config.databagId+"/resource/v3/maps/"+l.name+".png"}}catch(e){r=!0,a=e}finally{try{!i&&s.return&&s.return()}finally{if(r)throw a}}e&&e(t.levels)})},getElementByConditions:function(e,t,n){var r=this;i.getObjectData(this._config,r).then(function(i){n&&n(i.getElementByConditions(e,t,r._config))})},getMapInfo:function(e){var t=i.getMapInfo(this._config);e&&e(t)},getAllDrawingsheets:function(e,t,n,r){var a=this;i.getAllDrawingsheets(this._config).then(function(e){n&&n(e,a._config.modelType)}).catch(function(e){n&&n({drawingList:[]},a._config.modelType)})},getCategoryVisibility:function(e,t){i.getCategoryVisibility(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getSegmentGroups:function(e,t){i.getSegmentGroups(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getSegmentFromGroups:function(e,t,n){i.getSegmentFromGroups(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getSegmentTree:function(e,t){i.getSegmentTree(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getSegmentById:function(e,t,n){i.getSegmentById(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getSegmentElementIds:function(e,t,n){i.getSegmentElementIds(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getPartialElementsMetadata:function(e,t,n){i.getPartialElementsMetadata(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getPartialElementsMetadataFile:function(e){return i.getPartialElementsMetadataFile(this._config,e)},getDatabagResource:function(e){return i.getDatabagResource(this._config,e)}},t.OfflineDataManager=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=Glodon.Web.Lang.Utility.HttpRequest.promiseJSONRequest,i=Glodon.Web.Lang.Utility.HttpRequest.ajax,n={getModelTree:function(e){if("singleModel"==e.modelType)var i=e.APIHost+"/data/v2/files/"+e.modelId+"/tree?v=2.0&view_token="+e.viewToken;else var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/tree?view_token="+e.viewToken+"&treeType=specialty";return t(i)},getDrawingList:function(e){function i(i,n){var r=e.APIHost+"/data/v2/files/"+i+"/drawingsheets?elementId="+n+"&view_token="+e.viewToken;return t(r)}function n(i,n,r){var a=e.APIHost+"/data/v2/integrations/"+i+"/drawingsheets?fileIdHash="+n+"&elementId="+r+"&view_token="+e.viewToken;return t(a)}var e=e;return{fromSingleModel:i,fromIntegrateModel:n}},getAreas:function(e){if("singleModel"==e.modelType)var i=e.APIHost+"/data/v2/files/"+e.modelId+"/floors?includeRoom=true&includeArea=true&view_token="+e.viewToken;else var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/floors?includeRoom=true&includeArea=true&view_token="+e.viewToken;return t(i)},getRoomProperty:function(e,i){if("singleModel"==i.modelType)var n=i.APIHost+"/data/v2/files/"+i.modelId+"/rooms/"+e+"?view_token="+i.viewToken;else var n=i.APIHost+"/data/v2/integrations/"+i.modelId+"/rooms/"+e+"?view_token="+i.viewToken;return t(n)},getAreaProperty:function(e,i){if("singleModel"==i.modelType)var n=i.APIHost+"/data/v2/files/"+i.modelId+"/areas/"+e+"?view_token="+i.viewToken;else var n=i.APIHost+"/data/v2/integrations/"+i.modelId+"/areas/"+e+"?view_token="+i.viewToken;return t(n)},getObjectData:function(e,i){if("singleModel"==e.modelType)var n=e.APIHost+"/data/v2/files/"+e.modelId+"/elements/"+i+"?view_token="+e.viewToken;else{var r=i.split(".");if(1==r.length)var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/elements/"+i+"?view_token="+e.viewToken;else var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/files/"+r[0]+"/elements/"+r[1]+"?view_token="+e.viewToken}return t(n)},getEditedObjectData:function(e,i){if("singleModel"==e.modelType)var n=e.APIHost+"/data/v2/files/"+e.modelId+"/elements/"+i+"?includeOverrides=true&view_token="+e.viewToken;else{var r=i.split(".");if(1==r.length)var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/elements/"+i+"?includeOverrides=true&view_token="+e.viewToken;else var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/files/"+r[0]+"/elements/"+r[1]+"?includeOverrides=true&view_token="+e.viewToken}return t(n)},getFiles:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/files?includeDrawingSheet=true&view_token="+e.viewToken;return t(i)},getMaterialOverride:function(e,i,n){i=void 0==i?n.viewToken:i,e=void 0==e?n.modelId:e;var r=n.APIHost+"/data/v2/materialoverridesets/"+e+"?materialFormat=FULL_INSTANCE_JSON&sort=true&view_token="+i+"&compact=true";return t(r)},getLinkGraph:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/linkGraph?view_token="+e.viewToken;return t(i)},getMaterialProperty:function(e,i){if(!i)return void(failure&&failure({}));var n=i.split(".")
;if("singleModel"==e.modelType)var r=e.APIHost+"/data/v2/files/"+e.modelId+"/elements/"+n[0]+"/materials?view_token="+e.viewToken;else var r=e.APIHost+"/data/v2/integrations/"+e.modelId+"/files/"+n[0]+"/elements/"+n[1]+"/materials?view_token="+e.viewToken;return t(r)},getDrawingsheets:function(e,i){var n=e.APIHost+"/data/v2/files/"+i+"/drawingsheets?fileId="+i+"&view_token="+e.viewToken;return t(n)},getAllDrawingsheets:function(e,i){var n=e.resourceHost+"/"+(e.integrateDrawings&&e.integrateDrawings.databagId||e.databagId)+"/metadata/drawings.json";return t(n,"noCode")},getLinksJson:function(e,i){var n=e.resourceHost+"/"+e.databagId+"/metadata/links.json";return t(n,"noCode")},getFloors:function(e){if("singleModel"==e.modelType)var i=e.APIHost+"/data/v2/files/"+e.modelId+"/floors?view_token="+e.viewToken;else var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/floors?view_token="+e.viewToken;return t(i)},getElementByConditions:function(e,i,n){var r="";for(var a in n)r+="&"+a+"="+n[a];if("singleModel"==e.modelType)var o=e.APIHost+"/data/element/id?fileId="+i+r+"&view_token="+e.viewToken;else var o=e.APIHost+"/data/v2/integrations/"+i+"/elementIds?view_token="+e.viewToken+r;return t(o)},getMapInfo:function(e){var t=this,n=(t._opt,{}),r=[];t._helper;return i({url:e.resourceHost+"/"+e.databagId+"/metadata/grids.json",async:!1,success:function(e){for(var t=JSON.parse(e),i=[],r=0,a=t.grids.length;r<a;r++){var o=t.grids[r];o.start.X=o.start.x,o.start.Y=o.start.y,o.start.Z=o.start.z,o.end.X=o.end.x,o.end.Y=o.end.y,o.end.Z=o.end.z,i.push(o)}n.Grids=i}}),i({async:!1,url:e.resourceHost+"/"+e.databagId+"/metadata/levels.json",success:function(e){n.Levels=JSON.parse(e).levels}}),i({async:!1,url:e.resourceHost+"/"+e.databagId+"/resource/model/maps/output.json",dataType:"text",success:function(t){var i=JSON.parse(t);for(var n in i){var a=i[n];void 0==a.id&&(a.id=n),a.path=e.resourceHost+"/"+e.databagId+"/resource/model/maps/"+a.id+".png",a.name=n,r.push(a)}}}),{axisGrid:n,floors:r}},getCategoryVisibility:function(e){var i=e.resourceHost+"/"+e.databagId+"/metadata/categoryVisibility.json";return t(i,"noCode")},getScheduleList:function(e){var i=e.resourceHost+"/"+e.databagId+"/metadata/schedule.json";return t(i,"noCode")},getScheduleById:function(e,i){var n=i.resourceHost+"/"+i.databagId+"/metadata/schedule/"+e+".txt";return t(n,"noCode")},getSegmentGroups:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentGroups?view_token="+e.viewToken;return t(i,"noCode")},getSegmentFromGroups:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentGroups/"+i+"/segments?view_token="+e.viewToken;return t(n,"noCode")},getSegmentTree:function(e){var i=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segmentTree?view_token="+e.viewToken;return t(i,"noCode")},getSegmentById:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segments/"+i+"?view_token="+e.viewToken;return t(n,"noCode")},getSegmentElementIds:function(e,i){var n=e.APIHost+"/data/v2/integrations/"+e.modelId+"/segments/"+i+"/elementIds?view_token="+e.viewToken;return t(n,"noCode")},getPartialElementsMetadata:function(e,i){var n=e.resourceHost+"/"+i+"/metadata/partial_elements_metadata.json";return t(n,"noCode")},getPartialElementsMetadataFile:function(e,t){return e.resourceHost+"/"+t+"/metadata/partial_elements_metadata.json"},getDatabagResource:function(e,t){return e.resourceHost+"/"+t+"/resource/v3/model"},getModelGroup:function(e,i){var n=e.resourceHost+"/"+e.databagId+"/metadata/collectionTree.json";return t(n,"noCode")}};e.OnlineDataProdiver=n}(),function(){function e(e){this._config=e}var t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data.OnlineDataProdiver");e.prototype={getComponentProperty:function(e,t,n){if(!e)return console.warn("elementId must not be empty!."),void(n&&n());i.getObjectData(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getComponentOverriddenProperty:function(e,t,n){if(!e)return console.warn("elementId must not be empty!."),void(n&&n());i.getEditedObjectData(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getMaterialProperty:function(e,t,n){i.getMaterialProperty(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getModelTree:function(e,t){var n=this;i.getModelTree(n._config).then(function(t){e&&e(t,n._config.modelType)}).catch(function(e){t&&t(e)})},getAreas:function(e,t){i.getAreas(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getRoomProperty:function(e,t,n){i.getRoomProperty(e,this._config).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getDrawingList:function(e,t,n,r){var a=this._config.modelType;if("integrateModel"==a){var o=t.split(".")[0],s=t.split(".")[1];i.getDrawingList(this._config).fromIntegrateModel(e,o,s).then(function(e){n&&n(e)}).catch(function(e){r&&r(e)})}else"singleModel"==a&&i.getDrawingList(this._config).fromSingleModel(e,t).then(function(e){n&&n(e)}).catch(function(e){r&&r(e)})},getModelGroup:function(e,t){i.getModelGroup(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getAreaProperty:function(e,t,n){i.getAreaProperty(e,this._config).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getFiles:function(e,t){i.getFiles(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getMaterialOverride:function(e,t,n,r){i.getMaterialOverride(e,t,this._config).then(function(e){n&&n(e)}).catch(function(e){r&&r(e)})},getLinkGraph:function(e,t){i.getLinkGraph(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getDrawingsheets:function(e,t,n,r){var a=this;e=e||a._config.modelId,i.getDrawingsheets(this._config,e).then(function(e){n&&n(e,a._config.modelType)}).catch(function(e){r&&r(e)})},getAllDrawingsheets:function(e,t,n,r){var a=this;e=e||a._config.modelId,i.getAllDrawingsheets(this._config,e).then(function(e){n&&n(e,a._config.modelType)}).catch(function(e){r&&r(e)})},getLinksJson:function(e,t,n,r){var a=this;e=e||a._config.modelId,i.getLinksJson(this._config,e).then(function(e){n&&n(e,a._config.modelType)}).catch(function(e){r&&r(e)})},getFloors:function(e,t){i.getFloors(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getElementByConditions:function(e,t,n,r){i.getElementByConditions(this._config,e,t).then(function(e){n&&n(e)}).catch(function(e){r&&r(e)})},getMapInfo:function(e){var t=i.getMapInfo(this._config);e&&e(t)},getCategoryVisibility:function(e,t){i.getCategoryVisibility(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getScheduleList:function(e,t){i.getScheduleList(this._config).then(function(t){e&&e(t.scheduleList)}).catch(function(e){t&&t(e)})},getScheduleById:function(e,t,n){i.getScheduleById(e,this._config).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getSegmentGroups:function(e,t){i.getSegmentGroups(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getSegmentFromGroups:function(e,t,n){i.getSegmentFromGroups(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getSegmentTree:function(e,t){i.getSegmentTree(this._config).then(function(t){e&&e(t)}).catch(function(e){t&&t(e)})},getSegmentById:function(e,t,n){i.getSegmentById(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getSegmentElementIds:function(e,t,n){i.getSegmentElementIds(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getPartialElementsMetadata:function(e,t,n){i.getPartialElementsMetadata(this._config,e).then(function(e){t&&t(e)}).catch(function(e){n&&n(e)})},getPartialElementsMetadataFile:function(e){return i.getPartialElementsMetadataFile(this._config,e)},getDatabagResource:function(e){return i.getDatabagResource(this._config,e)}},t.OnlineDataManager=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=(Glodon.Web.Lang.Utility.HttpRequest,function(t){if(this._config=t,this._objectData=null,"Local"==t.dataEnvType?this.dataManager=new e.OfflineDataManager(t):this.dataManager=new e.OnlineDataManager(t),!t.viewToken)return!1});t.prototype={getComponentProperty:function(e,t,i){this.dataManager.getComponentProperty(e,t,i)},getComponentOverriddenProperty:function(e,t,i){this.dataManager.getComponentOverriddenProperty(e,t,i)},getDrawingList:function(e,t,i,n){this.dataManager.getDrawingList(e,t,i,n)},getModelTree:function(e,t){this.dataManager.getModelTree(e,t)},getModeTree:function(e,t){console.warn("This function is deprecated. Please use getModelTree instead."),this.getModelTree(e,t)},getFloors:function(e,t){this.dataManager.getFloors(e,t)},getAreas:function(e,t){this.dataManager.getAreas(e,t)},getAreaProperty:function(e,t,i){this.dataManager.getAreaProperty(e,t,i)},getModelGroup:function(e,t){this.dataManager.getModelGroup(e,t)},getMaterialProperty:function(e,t,i){this.dataManager.getMaterialProperty(e,t,i)},getRoomProperty:function(e,t,i){this.dataManager.getRoomProperty(e,t,i)},getFiles:function(e,t){this.dataManager.getFiles(e,t)},getMaterialOverride:function(e,t,i,n){this.dataManager.getMaterialOverride(e,t,i,n)},getLinkGraph:function(e,t){this.dataManager.getLinkGraph(e,t)},getDrawingsheets:function(e,t,i,n){this.dataManager.getDrawingsheets(e,t,i,n)},getElementByConditions:function(e,t,i,n){this.dataManager.getElementByConditions(e,t,i,n)},getAllDrawingsheets:function(e,t,i,n){this.dataManager.getAllDrawingsheets(e,t,i,n)},getLinksJson:function(e,t,i,n){this.dataManager.getLinksJson(e,t,i,n)},getMapInfo:function(e){this.dataManager.getMapInfo(e)},getCategoryVisibility:function(e,t){this.dataManager.getCategoryVisibility(e,t)},getScheduleList:function(e,t){this.dataManager.getScheduleList(e,t)},getScheduleById:function(e,t,i){this.dataManager.getScheduleById(e,t,i)},getSegmentGroups:function(e,t){this.dataManager.getSegmentGroups(e,t)},getSegmentFromGroups:function(e,t,i){this.dataManager.getSegmentFromGroups(e,t,i)},getSegmentTree:function(e,t){this.dataManager.getSegmentTree(e,t)},getSegmentById:function(e,t,i){this.dataManager.getSegmentById(e,t,i)},getSegmentElementIds:function(e,t,i){this.dataManager.getSegmentElementIds(e,t,i)},getPartialElementsMetadata:function(e,t,i){this.dataManager.getPartialElementsMetadata(e,t,i)},getPartialElementsMetadataFile:function(e){return this.dataManager.getPartialElementsMetadataFile(e)},getDatabagResource:function(e){return this.dataManager.getDatabagResource(e)}},e.MetaDataManager=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=function(){return{resourceHost:hostConfig.resourceHost,databagId:null}};e.FamilyDataManagerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=Glodon.Web.Lang.Utility.HttpRequest,i=function(e){if(!e.databagId)return!1;this.__config=e};i.prototype.getFamilyTypes=function(e,i){var n=this.__config,r=void 0;r="Local"==n.dataEnvType?"./"+n.databagId+"/metadata/floorTree.json":n.resourceHost+"/"+n.databagId+"/metadata/familyInfo.json",t.ajax({url:r,success:function(t){for(var t=JSON.parse(t),i=t.Types||t.types,n=0,r=i.length;n<r;n++)i[n].id=i[n].Id||i[n].id,i[n].name=i[n].Name||i[n].name,delete i[n].Id,delete i[n].Name;e&&e(i)},failure:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=JSON.parse(e);i&&i(t)})})},e.FamilyDataManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=function(){return{resourceHost:hostConfig.staticHost}};e.IBLManagerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=Glodon.Web.Lang.Utility.HttpRequest,i=function(e){this.__config=e};i.prototype.getIBLConfig=function(e,i){var n=this.__config,r=void 0;if("Local"==n.dataEnvType)return!1;r=n.resourceHost+"/resources/IBL/IBLConfig.json",t.ajax({url:r,success:function(t){var i=JSON.parse(t);e&&e(i)},failure:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=JSON.parse(e);i&&i(t)})})},e.IBLManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=(Glodon.Web.Lang.Utility.HttpRequest,t||{});t.version=1,t.EnumObjectTableIndex={OTI_OBJECTS_VALUES:0,OTI_PROPERTY_SCHEMAS:1,OTI_ELEMENT_PROPERTIES:2,OTI_FAMILY_PROPERTIES:3,OTI_FAMILIES:4,OTI_ELEMENTS:5,OTI_BOUNDING_BOX:6,OTI_ELEMENTS_CLASS:7};var i=function(e){this.url=e,this.objectsDB=[]};i.prototype={load:function(e){for(var t=this,i=["Values.json.gz","Schemas.json.gz","ElementProperties.json.gz","FamilyTypeProperties.json.gz","Families.json.gz","Elements.json.gz","BoundingBox.json.gz","ElementsClass.json.gz"],n=i.length,r=0,a=i.length;r<a;++r)!function(r){(new THREE.FileLoader).load(t.url+"/"+i[r],function(i){t.objectsDB[r]=JSON.parse(i),0==(n-=1)&&e()})}(r)},getFamilyTypeProperties:function(e){var i=this.objectsDB[t.EnumObjectTableIndex.OTI_FAMILIES],n=i[e];if(void 0===n)return null;for(var r=this.objectsDB[t.EnumObjectTableIndex.OTI_OBJECTS_VALUES],a=this.objectsDB[t.EnumObjectTableIndex.OTI_FAMILY_PROPERTIES],o=this.objectsDB[t.EnumObjectTableIndex.OTI_PROPERTY_SCHEMAS],s=0,l=0,c=0,u={},h=[],d=0,f=0,p=n[2],m=n[1];f<p;++f){s=2*(m+f),l=4*a[s],c=a[s+1],d=o[l];var g=u[d];void 0===g&&(g=[],u[d]=g,h.push(d)),g.push({key:r[o[l+1]],unit:r[o[l+3]],valueType:o[l+2],value:r[c]})}for(var v=[],f=0,y=h.length;f<y;++f)d=h[f],v.push({group:r[d],items:u[d]});return v},getElementProperties:function(e){if(null==e)return null;var i=this.objectsDB[t.EnumObjectTableIndex.OTI_ELEMENTS],n=i[e];if(void 0===n)return null;for(var r=this.objectsDB[t.EnumObjectTableIndex.OTI_OBJECTS_VALUES],a=this.objectsDB[t.EnumObjectTableIndex.OTI_ELEMENT_PROPERTIES],o=this.objectsDB[t.EnumObjectTableIndex.OTI_PROPERTY_SCHEMAS],s=0,l=0,c=0,u={},h=[],d=0,f=0,p=n[2],m=n[1];f<p;++f){s=2*(m+f),l=4*a[s],c=a[s+1],d=o[l];var g=u[d];void 0===g&&(g=[],u[d]=g,h.push(d)),g.push({key:r[o[l+1]],unit:r[o[l+3]],valueType:o[l+2],value:r[c]})}for(var v=[],f=0,y=h.length;f<y;++f)d=h[f],v.push({group:r[d],items:u[d]});var E=this.getFamilyTypeProperties(n[3]);if(!E)return v;var x={},b=[];v=E.concat(v);var C=!0,M=!1,_=void 0;try{for(var w,L=v[Symbol.iterator]();!(C=(w=L.next()).done);C=!0){var T=w.value;if(x[T.group]){var I=[].concat.apply(x[T.group].items,T.items),S=[],O=!0,D=!1,R=void 0;try{for(var A,U=I[Symbol.iterator]();!(O=(A=U.next()).done);O=!0){var B=A.value,P=!0,N=!0,k=!1,F=void 0;try{for(var H,G=S[Symbol.iterator]();!(N=(H=G.next()).done);N=!0){var V=H.value;B.key==V.key&&(P=!1)}}catch(e){k=!0,F=e}finally{try{!N&&G.return&&G.return()}finally{if(k)throw F}}P&&S.push(B)}}catch(e){D=!0,R=e}finally{try{!O&&U.return&&U.return()}finally{if(D)throw R}}x[T.group]={group:x[T.group].group,items:S}}else x[T.group]=T}}catch(e){M=!0,_=e}finally{try{!C&&L.return&&L.return()}finally{if(M)throw _}}for(var T in x)"åŸºæœ¬å±žæ€§"==x[T].group?b.unshift(x[T]):b.push(x[T]);return b},getElementByConditions:function(e,i,n){var r=this.objectsDB[t.EnumObjectTableIndex.OTI_ELEMENTS_CLASS],a=Object.keys(i),o=[],s=[],l={},c={min:{x:null,y:null,z:null},max:{x:null,y:null,z:null}},u=[],h=!0,d=!1,f=void 0;try{for(var p,m=a[Symbol.iterator]();!(h=(p=m.next()).done);h=!0){var g=p.value;u.push({typeIndex:this._getGroupsKey(g,i[g],r),typeValue:i[g]})}}catch(e){d=!0,f=e}finally{try{!h&&m.return&&m.return()}finally{if(d)throw f}}for(var v=0;v<r.groups.length;v+=3){var y=!0,E=!0,x=!1,b=void 0;try{for(var C,M=u[Symbol.iterator]();!(E=(C=M.next()).done);E=!0){var _=C.value,w=r.groups[v][_.typeIndex];if(r.values[w]!=_.typeValue){y=!1;break}}}catch(e){x=!0,b=e}finally{try{!E&&M.return&&M.return()}finally{if(x)throw b}}if(y)if("singleModel"==n.modelType)o=o.concat(r.groups[v+1][""]);else{var L=r.groups[v+1],T=r.groups[v+2];for(var I in L){var S=!0,O=!1,D=void 0;try{for(var R,A=L[I][Symbol.iterator]();!(S=(R=A.next()).done);S=!0){var U=R.value;s.push({fileId:I,elementId:U})}}catch(e){O=!0,D=e}finally{try{!S&&A.return&&A.return()}finally{if(O)throw D}}}(c.min.x>T[0]||null==c.min.x)&&(c.min.x=T[0]),(c.min.y>T[1]||null==c.min.y)&&(c.min.y=T[1]),(c.min.z>T[2]||null==c.min.z)&&(c.min.z=T[2]),(c.max.x<T[3]||null==c.max.x)&&(c.max.x=T[3]),(c.max.y<T[4]||null==c.max.y)&&(c.max.y=T[4]),(c.max.z<T[5]||null==c.max.z)&&(c.max.z=T[5])}}return"singleModel"==n.modelType?o:0==s.length?[]:(l.elements=s,l.boundingBox=c,l)},_getGroupsKey:function(e,t,i){for(var n=0,r=0;r<i.keys.length;r++)if(i.keys[r]==e){n=r;break}return n},getBoundingBox:function(e){if(null==e)return null;var i=this.objectsDB[t.EnumObjectTableIndex.OTI_BOUNDING_BOX],n="";try{n={min:{x:i[e][0],y:i[e][1],z:i[e][2]},max:{x:i[e][3],y:i[e][4],z:i[e][5]}}}catch(e){console.log("no boundingBox Data"),n=""}return n}},e.ObjectPropertyManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=function(){return{APIHost:hostConfig.APIHost,resourceHost:hostConfig.resourceHost,viewToken:null,modelId:null,modelType:"singleModel",dataEnvType:hostConfig.dataEnvType||"BIMFACE"}};e.FileManagerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=Glodon.Web.Lang.Utility.HttpRequest,i=function(e){this.__config=e};i.prototype.getViewToken=function(e,i,n){var r=this.__config,a=void 0;return"singleModel"!=r.modelType&&("Local"==r.dataEnvType?void(i&&i()):(a=r.APIHost+"/data/v2/integrations/"+r.modelId+"/files/"+e+"/viewToken?view_token="+r.viewToken,void t.ajax({url:a,type:"post",success:function(e){var t=JSON.parse(e);i&&i(t.data)},failure:function(e){function t(t){return e.apply(this,arguments)}return t.toString=function(){return e.toString()},t}(function(e){var t=JSON.parse(e);n&&n(t)})})))},e.FileManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Data"),t=(Glodon.Web.Lang.Utility.HttpRequest,null),i={getInstance:function(){return null==t&&(t={},t.sendingPeriod=6e4,t.requestList=[],t.isEnabled=!0,t.modelType="",t.modelId="",t.send=function(e,i){t.isEnabled&&this.requestList.push(e+"."+i)},setInterval(function(){if(t.isEnabled){var e=t.requestList,i=e.length;if(i>0){var n=e.slice(0,i);t._send(n),e.splice(0,i)}}},t.sendingPeriod),t._send=function(e){var t="https://api.bimface.com/inside/track?ModelType="+this.modelType+"&ModelId="+this.modelId,i={FunctionNames:e},n={"Content-Type":"application/json"};fetch(t,{method:"PUT",mode:"cors",body:JSON.stringify(i),headers:n,cache:"default"}).then(function(e){})},t.setIsEnabled=function(e){t.isEnabled=!0===e},t.getIsEnabled=function(){return t.isEnabled}),t}};e.StatisticsDataManager=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),t=(Object.freeze({TranslucentOthers:"",HideOthers:""}),function(){var e=new Glodon.Web.Lang.EventManager;this.getEventManager=function(){return e}});t.prototype.init=function(){},t.prototype.addView=function(e){var t=this,i=Glodon.Bimface.Authentication.AuthenticationManager,n=(t._opt,new Glodon.Bimface.Authentication.AuthenticationConfig);n.viewToken=e,n.APIHost=this._opt.APIHost,(this.authenticate=new i(n)).authenticate(function(e){"bimView"==e.renderType&&(e.renderType="3DView"),t.loadViewCore(e)},function(e){var i=Glodon.Bimface.Viewer.Viewer3DEvent;t.getEventManager().fireEvent(i.Error,e)})},t.prototype.loadViewCore=function(){},t.prototype.addEventListener=function(e,t){this.getEventManager().addEvent(e,t)},t.prototype.removeEventListener=function(e,t){this.getEventManager().removeEvent(e,t)},t.prototype.enableFullScreen=function(e){var t=this._opt.domElement,i=this;e?Glodon.Web.Lang.Utility.FullScreen.fullScreen(t):Glodon.Web.Lang.Utility.FullScreen.exitFullScreen(),setTimeout(function(){i.resize()},200)},e.Viewer=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),t=function(){return{domElement:null,unit:512,currentScale:1,position:new Glodon.Web.Geometry.Point3d(0,0,0),delay:100,navigationMode:"Pan"}};e.ImageRenderConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom")),i=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),Glodon.Bimface.Viewer.Viewer2DEvent,function(e){var i=new Glodon.Web.Lang.EventManager,n=e.domElement,r=t.create("div","bf-image"),a=t.create("div","bf-image-scene"),o=t.create("div","bf-image-view");this._eventManager=i,a.appendChild(o),r.appendChild(a),n.appendChild(r),this._scene={width:n.offsetWidth,height:n.offsetHeight},this._navigationMode=e.navigationMode,this._domElement=n,this._imageView=o,this._imageScene=a,this._container=r,this._position=e.position,this._maxLevel=1,this._currentScale=e.currentScale,this._currentLevel=this.scaleToLevel(e.currentScale),this._opt=e,this._zooming,this._moving,this.bindEvent(),this.bindMobileEvent()});i.prototype={addEventListener:function(e,t){this._eventManager.addEvent(e,t)},removeEventListener:function(e,t){this._eventManager.removeEvent(e,t)},getDomElement:function(){return this._container},bindEvent:function(){var e,t,i,n,r=this,a=this._container,o=!1;a.addEventListener("mousedown",function(i){i.preventDefault();var a=r._navigationMode;o=!0,e=r.getScale(),n=(new Date).getTime(),t=r.getClientPosition(i),"RectZoom"==a&&r.drawRect(t)}),a.addEventListener("mousemove",function(n){if(n.preventDefault(),!o||window.hasDragBoxPanel)return!1;var a=r._navigationMode;i=r.getClientPosition(n);var s={x:i.x-t.x,y:i.y-t.y};if("Pan"==a)r.move(s),t=i;else if("Zoom"==a){var l=i.y-t.y;Math.abs(l)>10&&r.setScale(e+l/200+e/10,t)}else r.drawRect(t,s)}),document.addEventListener("mouseup",function(e){if(e.preventDefault(),"RectZoom"==r._navigationMode){var a=r._scene,s=r.getScale();i=r.getClientPosition(e);var l,c={x:i.x-t.x,y:i.y-t.y},u={x:(i.x+t.x)/2,y:(i.y+t.y)/2};l=a.width/a.height>c.x/c.y?a.height/c.y:a.width/c.x,r.setScale(l*s,u),r._imageScene.removeChild(r._rect),r._rect=null}else if((new Date).getTime()-n<300){var h=r.getClientPosition(e),d=r.clientToWorld(h);r._eventManager.fireEvent("Clicked",{worldPosition:d,clientPosition:h})}o=!1,t=i=s=null}),a.addEventListener("mousewheel",function(e){e.preventDefault();var t=e.wheelDelta&&(e.wheelDelta>0?1:-1)||e.detail&&(e.detail>0?-1:1),i=r.getScale(),n=i+t*i/20,a=(r._container.getBoundingClientRect(),r.getClientPosition(e));r.setScale(n,a)}),a.addEventListener("DOMMouseScroll",function(e){e.preventDefault();var t=e.wheelDelta&&(e.wheelDelta>0?1:-1)||e.detail&&(e.detail>0?-1:1),i=r.getScale(),n=i+t*i/20,a=(r._container.getBoundingClientRect(),r.getClientPosition(e));r.setScale(n,a)})},bindMobileEvent:function(){var e,t,i,n,r,a=this,o=a._container;window.addEventListener("resize",function(){a.resize()}),o.addEventListener("touchstart",function(i){i.preventDefault();var i=a.getMobileEvent(i);i.isMulti?(e=a.getScale(),n=i.distance,t=i.point[0]):t=i.point}),o.addEventListener("touchend",function(a){e=t=i=n=r=null}),o.addEventListener("touchmove",function(i){var i=a.getMobileEvent(i);if(i.isMulti){r=i.distance;var o=e*r/n;a.setScale(o)}else{var s=i.point,l={x:s.x-t.x,y:s.y-t.y};a.move(l),t=s}})},getMobileEvent:function(e){for(var e=e.originalEvent||e,t=[],i=null,n=0,r=e.touches.length;n<r;n++)i=e.touches[n],t.push({x:i.pageX,y:i.pageY});return t.length<=1?{isMulti:!1,point:t[0]}:{isMulti:!0,distance:Math.sqrt(Math.pow(t[1].x-t[0].x,2)+Math.pow(t[1].y-t[0].y,2)),point:t}},load:function(e){this._maxLevel=e.file.Attributes.DwgLevel,this._maxScale=Math.pow(2,this._maxLevel-1),this._item=e,this._imageView.innerHTML="",this.setBackgroundImage(e.file.Path+"/L1/Model_0_0."+e.file.Attributes.DwgExt),this.showImagesLevel(this._currentLevel),this.fit()},addModel:function(e){this._maxScale=e.maxScale,this.showImages(e.images),this.fit()},showImagesLevel:function(e){var t=this,i=Math.pow(2,e-1),n=this._item,r=[];t._currentLevel=e;for(var a=0;a<i;a++)for(var o=0;o<i;o++){var s=n.file.Path+"/L"+e+"/Model_"+a+"_"+o+"."+n.file.Attributes.DwgExt;r.push({row:a,col:o,src:s,level:e})}t.showImages(r)},fit:function(){var e=this,t=e._opt.unit,i=e._scene,n={x:(t-i.width)/2,y:(t-i.height)/2};e.setScale(1),e.setPosition(n)},resize:function(){var e=this._domElement;this._scene={width:e.offsetWidth,height:e.offsetHeight}},showImages:function(e){if(!e||0==e.length)return!1;this._currentImages=e,this.updateImages()},resizeImages:function(e){var t=this,i=t._opt,n=t._imageView.querySelectorAll(".bf-image-item"),r=n.length;t._backgroundImage&&(t._backgroundImage.style.width=i.unit*e+"px",t._backgroundImage.style.height=i.unit*e+"px",e<t._currentScale&&(t._backgroundImage.style.display="block"));for(var a=0;a<r;a++){var o=n[a],s=o.getAttribute("col"),l=o.getAttribute("row"),c=o.getAttribute("level"),u=e/Math.pow(2,c-1);"image"==o.nodeName?o.width>o.height?o.style.width=t._opt.unit*u+"px":o.style.height=t._opt.unit*u+"px":(o.style.width=t._opt.unit*u+"px",o.style.height=t._opt.unit*u+"px"),o.style.left=s*t._opt.unit*u+"px",o.style.top=l*t._opt.unit*u+"px"}},setBackgroundImage:function(e){var i=t.create("img","bf-image-background"),n=this._imageView,r=this._opt,a=this._currentScale;i.src=e.replace(/[#+? ]/g,function(e){return escape(e)}),i.style.left=0,i.style.top=0,i.style.width=r.unit*a+"px",i.style.height=r.unit*a+"px",n.appendChild(i),this._backgroundImage=i},updateImages:function(){for(var e=this,i=e._opt,n=e._currentLevel,r=this._currentScale/Math.pow(2,n-1),a=e._imageView,o=a.querySelectorAll(".bf-image-item"),s=e._currentImages,l=e.getShowImages(s),c=l.length,u=0,h=function(t){if(u++,c==u&&o){for(var i=0;i<o.length;i++)try{a.removeChild(o[i])}catch(e){}e._backgroundImage&&(e._backgroundImage.style.display="none")}a.appendChild(t.item.domElement),e.render()},d=0;d<c;d++){var f=l[d];!function(e){var n=t.create("img","bf-image-item");e.domElement=n,e.type="image",e.src=e.src.replace(/[#+? ]/g,function(e){return escape(e)}),n.src=e.src,n.setAttribute("col",e.col),n.setAttribute("row",e.row),n.setAttribute("level",e.level),n.onload=function(){n.style.left=e.col*i.unit*r+"px",n.style.top=e.row*i.unit*r+"px",this.width>this.height?this.style.width=i.unit*r+"px":this.style.height=i.unit*r+"px",e.width=this.width,e.height=this.height,h({code:"success",item:e})},n.onabort=n.onerror=function(){var n=t.create("div","bf-image-item");n.setAttribute("col",e.col),n.setAttribute("row",e.row),n.setAttribute("level",e.level),n.style.left=e.col*i.unit*r+"px",n.style.top=e.row*i.unit*r+"px",n.style.width=i.unit*r+"px",n.style.height=i.unit*r+"px",e.domElement=n,e.type="default",h({code:"error",item:e})}}(f)}},getImages:function(){return this._currentImages},setScale:function(e,t){var i,n=this,r=n._container,a=n._opt;if(e>n._maxScale?e=n._maxScale:e<1&&(e=1),e==this._currentScale)return!1;t||(t={x:r.offsetWidth/2,y:r.offsetHeight/2}),i=n.clientToWorld(t),n.resizeImages(e),this._currentScale=e;var o=n.worldToClient(i),s={x:o.x-t.x,y:o.y-t.y},l=n.clientToWorld(s);n.setWorldPosition(l),n._zooming&&clearTimeout(n._zooming);var c=n.scaleToLevel(e);n._zooming=setTimeout(function(){c!=n._currentLevel?n.showImagesLevel(c):n.updateImages()},a.delay),n._eventManager.fireEvent("Zooming",e),n.render()},getScale:function(){return this._currentScale},getCurrentLevel:function(){return this._currentLevel},setPosition:function(e){var t=this,i=this._imageScene,n=i.querySelector(".bf-image-view");n.style.left=-e.x+"px",n.style.top=-e.y+"px",this._position=e,clearTimeout(t._update),t._update=setTimeout(function(){t.updateImages(),t._eventManager.fireEvent("Moved",e),t.render()},t._opt.delay)},setWorldPosition:function(e){this.setPosition({x:e.x/this._maxScale*this._currentScale,y:e.y/this._maxScale*this._currentScale})},getWorldPosition:function(){return this.clientToWorld({x:0,y:0})},clientToWorld:function(e){var t=this._position,i={x:t.x+e.x,y:t.y+e.y};return{x:i.x/this._currentScale*this._maxScale,y:i.y/this._currentScale*this._maxScale}},worldToClient:function(e){var t=this._position,i={x:e.x*this._currentScale/this._maxScale,y:e.y*this._currentScale/this._maxScale};return{x:i.x-t.x,y:i.y-t.y}},move:function(e){console.log("move");var t=this,i=t._position,n={x:i.x-e.x,y:i.y-e.y};t.setPosition(n),t._eventManager.fireEvent("Moving",n),t.render()},getShowImages:function(e){for(var t=this._opt.unit,i=this._position,n=this._currentScale,r=this._currentLevel,a=this._scene,o=n/Math.pow(2,r-1),s=[],l=0,c=e.length;l<c;l++){var u=e[l];(1+u.col)*t*o>i.x&&(1+u.row)*t*o>i.y&&u.col*t*o<i.x+a.width&&u.row*t*o<i.y+a.height&&s.push(u)}return s},scaleToLevel:function(e){var t=this._maxLevel,i=Math.ceil(Math.log(e)/Math.log(2))+1;return i>=t&&(i=t),i},isInViewFrustum:function(e){var t=this._scene,i=this.worldToClient(e);return i.x>0&&i.x<t.width&&i.y>0&&i.y<t.height},setNavigationMode:function(e){this._navigationMode=e},createSnapshotAsync:function(e,i){var n=this,r=t.create("canvas","bf-canvas"),a=r.getContext("2d"),o=n._scene,s=n.getScale(),l=n.getCurrentLevel(),c=n._position,u=n.getShowImages(n._currentImages),h=u.length,d=n._opt.unit,f=s/Math.pow(2,l-1),p=function(){if(0==--h){var e=r.toDataURL("image/png");i&&i(e)}};r.setAttribute("width",o.width),r.setAttribute("height",o.height),a.rect(0,0,o.width,o.height),e instanceof Glodon.Web.Graphics.Color?a.fillStyle=e.getRGBA():a.fillStyle="#000",a.fillRect(0,0,o.width,o.height);for(var m=0;m<h;m++)!function(e){new Glodon.Web.Graphics.Utility.ImageContainer(e.src).then(function(t){e.isLoad=!0,a.drawImage(t,e.col*d*f-c.x,e.row*d*f-c.y,d*f,d*f),p()},function(t){e.isLoad=!0,p()})}(u[m])},drawRect:function(e,i){this._rect&&i?(this._rect.style.width=i.x+"px",this._rect.style.height=i.y+"px"):(this._rect=t.create("div","bf-image-rect"),this._rect.style.left=e.x+"px",this._rect.style.top=e.y+"px",this._imageScene.appendChild(this._rect))},getClientPosition:function(e){var t=this,i=t._domElement.getBoundingClientRect();return{x:e.clientX-i.left,y:e.clientY-i.top}},render:function(){this._eventManager.fireEvent("Render")}},e.ImageRender=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),t=function(){return{domElement:null,resourceHost:hostConfig.resourceHost,APIHost:hostConfig.APIHost}};e.Viewer2DConfig=t}(),function(){var e=Object.freeze({Loaded:"Loaded",MouseClicked:"MouseClicked",Rendered:"Rendered",ViewChanged:"ViewChanged",ViewMoving:"ViewMoving",ViewMoved:"ViewMoved",ViewZooming:"ViewZooming",ViewZoomed:"ViewZoomed",DrawingMeasure:"DrawingMeasure",Error:"Error"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").Viewer2DEvent=e}(),function(){var e=Object.freeze({Pan:"Pan",RectZoom:"RectZoom",Zoom:"Zoom"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").NavigationMode2D=e}(),function(){var e="Glodon.Bimface.Viewer.Viewer2D",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),n=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),r=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest")),a=Glodon.Bimface.Viewer.Viewer2DEvent,o=function(e){i.Viewer.call(this);var t=e.domElement;this._opt=e,this._scaleLevel=1,this.screenWidth=t.offsetWidth,this.screenHeight=t.offsetHeight,this._viewLoaded=!1;var n=new Glodon.Bimface.Viewer.ImageRenderConfig;n.domElement=t,this._imageRender=new Glodon.Bimface.Viewer.ImageRender(n),this.getDomElement=function(){return this._imageRender.getDomElement()},this.hookImageRender()};n.Type.inheritPrototype(o,i.Viewer),o.prototype=Object.assign({},i.Viewer.prototype,{hookImageRender:function(){
var e=this,t=this._imageRender,i=Glodon.Bimface.Viewer.Viewer2DEvent,n=this.getEventManager();t.addEventListener("Zooming",function(e){n.fireEvent(i.ViewZooming,e)}),t.addEventListener("Moving",function(e){n.fireEvent(i.ViewMoving,e)}),t.addEventListener("Moved",function(t){e.render()}),t.addEventListener("Render",function(t){e.render()}),t.addEventListener("Clicked",function(t){t.worldPosition.x=t.worldPosition.x/e._scaleLevel,t.worldPosition.y=t.worldPosition.y/e._scaleLevel,n.fireEvent(i.MouseClicked,t)})},load:function(e){0==this._viewLoaded&&(this._viewLoaded=!0,this.addView(e))},showImage:function(e,t){var i=this,n=this._imageRender,r=new Image,t=t;r.src=e,r.onload=function(){var r=this.width>this.height?this.width:this.height;t=t||r/512,i._scaleLevel=512*t/r,n.addModel({maxScale:t,images:[{row:0,col:0,src:e}]})}},loadViewCore:function(e){var t=this,i=t._opt,n=e.databagId;t._data=e,r.ajax({async:!1,url:i.resourceHost+"/"+e.databagId+"/manifest.json",success:function(e){var r=JSON.parse(e);if(r.Views){for(var o=[],s=0,l=r.Views.length;s<l;s++){var c=r.Views[s],u=c.Representations.getObjectByAttribute("MIME","image/tiles");u.Path=i.resourceHost+"/"+n+"/"+u.Path,o.push({name:c.Name,id:c.ID,file:u})}t._views=o,t.showViewById(o[0].id),t.getEventManager().fireEvent(a.Loaded,t),Glodon.Web.Lang.Utility.MouseMotion.setCursor(t)}}})},showViewById:function(i){if(t.send(e,"showViewById"),this._currentViewId!=i){var n=this._views,r=n.getObjectByAttribute("id",i),o=this._imageRender;r&&r!=this._currenItem&&(this._currenItem=r,this._currentViewId=i,o.load(r),this.getEventManager().fireEvent(a.ViewChanged,i))}},getCurrentViewId:function(){return this._currentViewId},home:function(){this._imageRender.fit()},setNavigationMode:function(i){t.send(e,"setNavigationMode"),this._imageRender.setNavigationMode(i)},rectZoom:function(){this._opt.enableZoomRect=!0,this._imageRender.setNavigationMode(Glodon.Bimface.Viewer.NavigationMode2D.RectZoom)},zoomIn:function(){var e=this._imageRender.getScale();this._imageRender.setScale(1.6*e)},zoomOut:function(){var e=this._imageRender.getScale();this._imageRender.setScale(e/1.6)},getWorldPosition:function(){var e=this._imageRender.getWorldPosition();return this.imageToWorld(e)},getViews:function(){return this._views},resize:function(){this._imageRender.resize()},worldToClient:function(e){var t=this.worldToImage(e);return this._imageRender.worldToClient(t)},clientToWorld:function(e){var t=this._imageRender.clientToWorld(e);return this.imageToWorld(t)},isInViewFrustum:function(e){var t=this.worldToImage(e);return this._imageRender.isInViewFrustum(t)},getMaxLevel:function(){return this._imageRender.getMaxLevel()},getCurrentLevel:function(){return this._imageRender.getCurrentLevel()},getZoomScale:function(){return this._imageRender.getScale()},getCurrentState:function(){var e=this,t=e._imageRender,i=t._position;return{viewTop:i.x,viewLeft:i.y,level:t.getCurrentLevel(),zoomScale:t.getScale(),viewId:e._currentViewId}},setState:function(e){var t=this,i=t._imageRender;t._currentViewId!=e.viewId&&t.showViewById(e.viewId),i.setScale(e.zoomScale),i.setPosition({x:e.viewTop,y:e.viewLeft})},createSnapshotAsync:function(i,n){t.send(e,"createSnapshotAsync"),this._imageRender.createSnapshotAsync(i,n)},worldToImage:function(e){return{x:e.x*this._scaleLevel,y:e.y*this._scaleLevel}},imageToWorld:function(e){return{x:e.x/this._scaleLevel,y:e.y/this._scaleLevel}},render:function(){var e=Glodon.Bimface.Viewer.Viewer2DEvent;this.getEventManager().fireEvent(e.Rendered)}}),i.Viewer2D=o}();var categoryIds=["-2001350","-2001180","-2001160","-2001340","-2001260","-2000180","-2000011","-2000035","-2000170","-2000171","-2000340","-2000100","-2000126","-2000032","-2000120","-2001120","-2000014","-2000996","-2001354","-2001300","-2001330","-2001336","-2001320","-2001327","-2009030","-2001220","-2000023","-2000038","-2000946"];!function(){var e=Object.freeze({ViewAdded:"ViewAdded",ViewLoading:"ViewLoading",Rendered:"Rendered",ComponentsSelectionChanged:"ComponentsSelectionChanged",ComponentsHoverChanged:"ComponentsHoverChanged",SelectionChanged:"SelectionChanged",MouseClicked:"MouseClicked",MouseDragged:"MouseDragged",MouseDoubleClicked:"MouseDoubleClicked",ContextMenu:"ContextMenu",RectSelection:"RectSelection",Error:"Error",AddView:"AddView",RemoveView:"RemoveView",FamilyTypeChanged:"FamilyTypeChanged",MissingDrawingElement:"MissingDrawingElement",ToolbarHomeClick:"ToolbarHomeClick",DemandLoaded:"DemandLoaded",ButtonOnToolbarClicked:"ButtonOnToolbarClicked",AxisGridHover:"AxisGridHover",FloorExplosion:"FloorExplosion",Hover:"Hover"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").Viewer3DEvent=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),t=Glodon.Web.Lang.Utility.ClientHelper.getIsDesktop(),i=function(e){var i=Glodon.Bimface.Viewer.OrbitButton,n=Glodon.Bimface.Viewer.ViewOption,r={domElement:null,APIHost:hostConfig.APIHost,resourceHost:hostConfig.resourceHost,initialViewOption:n.Home,homeViewOption:n.Home,enableViewHouse:!0,enableReplaceMaterial:!1,enableExplosion:!1,loadOnDemand:!0,minimumFPS:15,enableOrbit:!0,orbitButton:i.Left,suffix:".gz",loading:!0,MaxMemeorySizeToFullRender:t?1500:500,enableToggleContextMenuDisplay:!0,enableHover:!1,enableBorderLine:null,borderLineVisibility:null,exposure:0,backgroundColor:[{color:new Glodon.Web.Graphics.Color(246,250,255,1),stop:"10%"},{color:new Glodon.Web.Graphics.Color(214,224,235,1),stop:"70%"}],enableIBLBackground:!1,enableSkyBox:!1,enableLogarithmicDepthBuffer:!1,loadIBLScene:{IBLSceneOption:"",withBackground:!1}};return Object.assign({},r,e)};e.Viewer3DConfig=i}(),function(){var e=Object.freeze({HideOthers:"HideOthers",MakeOthersTranslucent:"MakeOthersTranslucent"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").IsolateOption=e}(),function(){var e=Object.freeze({Home:"Home",Top:"Top",Bottom:"Bottom",North:"North",South:"South",West:"West",East:"East",SouthEast:"SouthEast",SouthWest:"SouthWest",NorthEast:"NorthEast",NorthWest:"NorthWest"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").ViewOption=e}(),function(){var e=Object.freeze({Red:"Red",Yellow:"Yellow",Green:"Green",Blue:"Blue",Black:"Black"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").ColorOption=e}(),function(){var e=Object.freeze({Fly:"Fly",Orbit:"Orbit",Select:"Select",Zoom:"Zoom",OrbitWithModelCenter:"OrbitWithModelCenter",PickWithRect:"PickWithRect",ZoomWithRect:"ZoomWithRect",Walk:"Walk"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").NavigationMode3D=e}(),function(){var e=Object.freeze({Translucent:"Translucent",Opaque:"Opaque"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").OpacityOption=e}(),function(){var e=Object.freeze({Left:"Left",Right:"Right"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").OrbitButton=e}(),function(){var e=Object.freeze({X:"X",Y:"Y",Z:"Z"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").AxisOption=e}(),function(){var e=Object.freeze({Default:"Default",Rotate:"Rotate"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").SectionBoxMode=e}(),function(){var e=Object.freeze({Up:"Up",Down:"Down",Left:"Left",Right:"Right"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").Direction=e}(),function(){var e=Object.freeze({Gray:"Gray",HarborSunRise:"HarborSunRise",ParkingLot:"ParkingLot",RiverSide:"RiverSide",Sunrise:"Sunrise",SunsetGrass:"SunsetGrass"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").IBLSceneOption=e}(),function(){var e=Object.freeze({Phong:"Phong",IBL:"IBL"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer").LightingMode=e}(),function(){var e="Glodon.Bimface.Viewer.Viewer3D",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Viewer"),n=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),r=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),a=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),o="Please call enableSectionBox before using this method.",s=Glodon.Web.Lang.Utility.ClientHelper.getIsDesktop(),l=function(e){i.Viewer.call(this);var t=this;this._beforeInitialize(e),this._opt=e,this._opt.skyBoxType="CloudySky",this._opt.floorExplosion=!1,this._colorOverridedMap={},this._colorOverridedList=[],this._modelData={},this._modelNum=0;var n=new CLOUD.Viewer;this.customedHomeview=null,this.defaultHomeview=null,this.bViewHouseIsLoaded=e.enableViewHouse,CLOUD.GlobalData.EnableLoadOnDemand=!0===e.loadOnDemand,CLOUD.GlobalData.Instance=!e.enableReplaceMaterial,CLOUD.GlobalData.EnableExplosion=e.enableExplosion,CLOUD.GlobalData.EnableLogarithmicDepthBuffer=e.enableLogarithmicDepthBuffer,CLOUD.GlobalData.BorderLineDelayLoaded=!1===e.enableBorderLine;var a=r.create("div","bf-view");e.domElement.appendChild(a),n.init(a),this.view={},this.snap=null,n.setDeviceMobile&&n.setDeviceMobile(!s),this.getViewer=function(){return n},this.getDomElement=function(){return a},this.hookCloudViewerEvents(),this._config(e),this.setBackgroundColors(e.backgroundColor),window.addEventListener("resize",function(){t.resize()}),s?(this.setNavigationMode(Glodon.Bimface.Viewer.NavigationMode3D.PickWithRect),console.log("client: desktop")):console.log("client: mobile")};n.Type.inheritPrototype(l,i.Viewer),l.prototype=Object.assign({},i.Viewer.prototype,{hookCloudViewerEvents:function(){var e=this,t=e._opt,i=this.getViewer(),n=this.getEventManager(),a=Glodon.Bimface.Viewer.Viewer3DEvent,o=r.create("div","bf-loading"),l=r.create("div","bf-loading-gif"),c=r.create("div","bf-loading-progress"),u=!1,h=0,d=r.create("div","bf-rect-selcetion"),f=null,p={component:"Component",room:"Room",axisGrids:"AxisGrids"},m=function(e){var t=null;if(e.intersectInfo){if(t={objectId:e.intersectInfo.selectedObjectId,fileId:null,elementId:e.intersectInfo.selectedObjectId,boundingBox:e.intersectInfo.worldBoundingBox,screenPosition:{x:e.event.clientX,y:e.event.clientY},worldPosition:e.intersectInfo.worldPosition,clientPosition:e.canvasPos,eventType:"Hover",objectType:e.intersectInfo.isRoom?p.room:p.component},e.intersectInfo.selectedObjectId&&"string"==typeof e.intersectInfo.selectedObjectId){var i=e.intersectInfo.selectedObjectId.split(".");i.length>1&&(t.elementId=i[1],t.fileId=i[0])}}else f=null,t={screenPosition:{x:e.event.clientX,y:e.event.clientY},clientPosition:e.canvasPos,eventType:"Hover"};n.fireEvent(a.ComponentsHoverChanged,t),t.objectId&&f!=t.objectId&&(n.fireEvent(a.Hover,t),f=t.objectId)},g=function(t){var i=null,r=null,o={LEFT:1,RIGHT:2};r=t.event.button==o.RIGHT?"RightClick":t.doubleClick?"DoubleClick":"Click";var s=t.doubleClick?2:1;if(t.intersectInfo&&t.intersectInfo.objectType==CLOUD.PICKABLETYPE.Marker3d)return!1;if(t.intersectInfo){if(i={objectId:t.intersectInfo.selectedObjectId,fileId:null,elementId:t.intersectInfo.selectedObjectId,boundingBox:t.intersectInfo.worldBoundingBox,click:s,screenPosition:{x:t.event.clientX,y:t.event.clientY},worldPosition:t.intersectInfo.worldPosition,clientPosition:t.canvasPos,eventType:r},t.intersectInfo.selectedObjectId&&"string"==typeof t.intersectInfo.selectedObjectId){var l=t.intersectInfo.selectedObjectId.split(".");l.length>1&&(i.elementId=l[1],i.fileId=l[0])}}else i={click:s,screenPosition:{x:t.event.clientX,y:t.event.clientY},clientPosition:t.canvasPos,eventType:r};if(t.event.altKey&&console.log(i),t.doubleClick)e.zoomToSelectedComponents(),n.fireEvent(a.MouseDoubleClicked,i),n.fireEvent(a.ComponentsSelectionChanged,i);else if(t.event.button===THREE.MOUSE.LEFT){n.fireEvent(a.ComponentsSelectionChanged,i);var c=e.getViewer().pickToPoint(i.clientPosition,5);if(null!=e.snap&&null!=c){var u=e.sceneToWorld(c.pickPoint),h=e.worldToClient(u),d={type:null,worldPosition:u,clientPosition:{x:h.x,y:h.y}};i.snapPoint=d}n.fireEvent(a.MouseClicked,i)}else{var f=t.event.target.getBoundingClientRect();if(e._opt.enableToggleContextMenuDisplay){var p={width:f.width,height:f.height};i.containerBox=p,n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.ContextMenu,i)}n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.MouseClicked,i)}},v=function(e){e.visible?(d.setCss({left:e.left+"px",top:e.top+"px",width:e.width+"px",height:e.height+"px",background:"rgba(136,136,136,0.2)",border:"solid #888888 1px"}),t.domElement.firstElementChild.appendChild(d),u=!0):(u&&(t.domElement.firstElementChild.removeChild(d),u=!1,n.fireEvent(a.RectSelection,{end:!0})),n.fireEvent(a.RectSelection,e))};CLOUD.GlobalData.EnableDemolishByDClick=!0,c.innerText="0%",o.appendChild(l),o.appendChild(c),i.registerEventListener(CLOUD.EVENTS.ON_LOAD_START,function(){t.loading&&(h++,t.domElement.appendChild(o))}),i.registerEventListener(CLOUD.EVENTS.ON_AXIS_GRID_HOVER,function(e){n.fireEvent(a.AxisGridHover,e)}),i.registerEventListener(CLOUD.EVENTS.ON_FLOOR_EXPLOSION,function(t){n.fireEvent(a.FloorExplosion,t),e.floorData=t}),i.registerEventListener(CLOUD.EVENTS.ON_LOAD_COMPLETE,function(){var r=e._opt,l={Home:0,Top:1,Bottom:2,North:3,South:4,West:5,East:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10};if(t.enableViewHouse&&e.showViewHouse(),h--,t.loading&&0==h&&(c.innerText="0%",t.domElement.removeChild(o)),r.borderLineVisibility)e.setBorderLine(r.borderLineVisibility);else if("rvt-translate"==e._data.workerType)e.setRvtBorderLine();else if("rvt-integrate"==e._data.workerType){var u=e._data.config?e._data.config.fileType:null;u&&"rvt"!=u||e.setRvtBorderLine()}var d=e.getInformation();null===t.enableBorderLine||void 0===t.enableBorderLine?d.elements>8e4&&d.triangles>2e7?(e.setBorderLineEnabled(!1),e.setMinimumFPS(30)):(e.setBorderLineEnabled(!0),e.setMinimumFPS(8)):e.setBorderLineEnabled(t.enableBorderLine),e.setExposureShift(t.exposure),!s&&d.triangles>5e6&&(CLOUD.GlobalData.maxObjectNumInPool=2e3),s||e.setBorderLineEnabled(!1),i.setInitialView(l[r.initialViewOption]),i.setHomeView(l[r.homeViewOption]),e.defaultHomeview=e.getCameraStatus(),r.enableIBLBackground&&r.loadIBLScene.IBLSceneOption&&e.loadIBLScene(r.loadIBLScene.IBLSceneOption,r.loadIBLScene.withBackground),i.enableTextureMapping(!0),n.fireEvent(a.ViewAdded,e),Glodon.Web.Lang.Utility.MouseMotion.setCursor(e)}),i.registerEventListener(CLOUD.EVENTS.ON_LOAD_PROGRESS,function(e){var t=e.progress,i=Math.round(t.loaded/t.total*100);t.progress=i,c.innerText=i+"%",n.fireEvent(a.ViewLoading,t)}),i.registerEventListener(CLOUD.EVENTS.ON_LOAD_EMPTY_SCENE,function(){h--,t.loading&&0==h&&t.domElement.removeChild(o),n.fireEvent(a.Error,{code:"EmptyData",message:"this view is empty."})}),i.registerEventListener(CLOUD.EVENTS.ON_EDITOR_UPDATEUI,function(e){v(e.data)}),i.registerEventListener(CLOUD.EVENTS.ON_CLICK_PICK,function(e){g(e)}),i.registerEventListener(CLOUD.EVENTS.ON_HOVER_PICK,function(e){m(e)}),i.registerEventListener(CLOUD.EVENTS.ON_SELECTION_CHANGED,function(e){n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.SelectionChanged,e.selectionList)}),i.addCallbacks("render",function(){n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.Rendered)}),i.registerEventListener(CLOUD.EVENTS.ON_DEMAND_LOAD_COMPLETE,function(e){n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.DemandLoaded,e.data)}),i.registerEventListener(CLOUD.EVENTS.ON_MOUSE_DRAGGED,function(e){n.fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.MouseDragged,e)}),i.registerEventListener(CLOUD.EVENTS.ON_HOVER_SNAP,function(t){e.snap.snapByPoint(t)}),e.addEventListener(a.ButtonOnToolbarClicked,function(t){"Measure"==t.id&&t.isChecked&&null!=e.snap&&e.enableSnap(!1)})},isolateComponentsById:function(i,n){t.send(e,"isolateComponentsById"),this.getViewer().getFilter().addToIsolateList(i,n)},isolateComponentsByObjectData:function(i,n){t.send(e,"isolateComponentsByObjectData");var r=this,a=r.getViewer(),o=a.getFilter(),s={MakeOthersTranslucent:3,HideOthers:1};o.clearAllIsolateConditions(),i&&o.setIsolateConditions(i,s[n])},isolateByBox:function(e,t){var i=this.getViewer();this.clearIsolation(),this.render();var n=i.getObjectsInBox(e);this.isolateComponentsById(n,t)},clearIsolation:function(){this.getViewer().getFilter().clearIsolation()},showComponentsById:function(i){t.send(e,"showComponentsById"),this.getViewer().getFilter().showByIds(i)},showComponents:function(e){this.showComponentsById(e)},showComponentsByObjectData:function(i,n,r){t.send(e,"showComponentsByObjectData"),this.getViewer().getFilter().showByConditions(i)},hideComponentsById:function(i){t.send(e,"hideComponentsById"),this.getViewer().getFilter().hideByIds(i)},hideComponents:function(e){this.hideComponentsById(e)},hideComponentsByObjectData:function(i){t.send(e,"hideComponentsByObjectData"),this.getViewer().getFilter().hideByConditions(i)},showAllComponents:function(i,n){t.send(e,"showAllComponents");var r=this.getViewer();CLOUD.GlobalData.LoadMpkOnDemand?r.loadMpkOnDemand(null,i,function(e){r.getFilter().showAll(),r.render(),n&&n()}):r.getFilter().showAll()},hideAllComponents:function(){t.send(e,"hideAllComponents"),this.getViewer().getFilter().hideAll()},showExclusiveComponentsByObjectData:function(i,n,r){function a(e){if("all"==e)s.showAll();else if(e instanceof Array&&0==e.length)s.hideAll();else{if(!(e instanceof Array))return void console.warn("Parameter conditions is invalid.");s.showScene(),s.hideOthersByConditions(e),s.showByConditions(e)}}t.send(e,"showExclusiveComponentsByObjectData");var o=this.getViewer(),s=o.getFilter();CLOUD.GlobalData.LoadMpkOnDemand?o.loadMpkOnDemand(i,n,function(e){a(e),o.render(),r&&r()}):a(i)},transparentComponentsById:function(i){t.send(e,"transparentComponentsById"),this.getViewer().getFilter().makeTranslucentByIds(i)},transparentComponentsByObjectData:function(i){t.send(e,"transparentComponentsByObjectData"),this.getViewer().getFilter().makeTranslucentByConditions(i)},transparentAllComponents:function(){t.send(e,"transparentAllComponents"),this.getViewer().getFilter().makeTranslucentOthersByIds([])},opaqueComponentsById:function(i){t.send(e,"opaqueComponentsById"),this.getViewer().getFilter().opaqueByIds(i)},opaqueComponentsByObjectData:function(i){t.send(e,"opaqueComponentsByObjectData"),this.getViewer().getFilter().opaqueByConditions(i)},opaqueAllComponents:function(){t.send(e,"opaqueAllComponents");var i=this.getViewer().getFilter();i.opaqueAll(),i.opaqueByIds([])},setIsolatedComponentColor:function(i){t.send(e,"setIsolatedComponentColor");var n=this.getViewer().getFilter(),r={color:parseInt(i.getHEX(),16),opacity:i.getAlpha()};n.setFrozonMaterial(r)},restoreIsolatedComponentColor:function(){t.send(e,"restoreIsolatedComponentColor"),this.getViewer().getFilter().setFrozonMaterial({color:void 0,opacity:void 0})},getIsolatedComponentColor:function(){var e=this.getViewer().getFilter(),t=e._filterImpl.getFrozonMaterial(),i=t.color,n=t.opacity;return new Glodon.Web.Graphics.Color(255*i.r,255*i.g,255*i.b,n)},setComponentsOpacity:function(i,n){t.send(e,"setComponentsOpacity");this.getViewer().getFilter();"Translucent"==n?this.transparentComponentsById(i):"Opaque"==n&&this.opaqueComponentsById(i)},addSelectedComponentsById:function(i){t.send(e,"addSelectedComponentsById"),this.getViewer().addToSelection(i)},setSelectedComponentsById:function(i){t.send(e,"setSelectedComponentsById"),this.getViewer().setSelection(i)},getObjectDataById:function(e){return this.getViewer().getUserdataByUserId(e)},getSelectedComponents:function(){return this.getViewer().getSelection()},removeSelectedId:function(i){t.send(e,"removeSelectedId"),this.getViewer().removeFromSelection(i)},setCollisionByCondition:function(e){this.getViewer().cameraControl.collisionManager.setCondition(e)},getCollisionByCondition:function(){return this.getViewer().cameraControl.collisionManager.getCondition()},clearSelectedComponents:function(){this.getViewer().clearSelection()},enableBlinkComponents:function(e){this.getViewer().enableBlinkComponents(e)},addBlinkComponentsById:function(e){this.getViewer().addBlinkComponentsById(e)},setBlinkComponentsById:function(e){this.getViewer().setBlinkComponentsById(e)},getBlinkComponents:function(){return this.getViewer().getBlinkComponents()},clearBlinkComponentsById:function(e){this.getViewer().clearBlinkComponentsById(e)},clearAllBlinkComponents:function(){this.getViewer().clearAllBlinkComponents()},setBlinkColor:function(e){var t={color:parseInt(e.getHEX(),16),opacity:e.getAlpha()};this.getViewer().setBlinkColor(t)},setBlinkIntervalTime:function(e){this.getViewer().setBlinkIntervalTime(e)},overrideComponentsColorById:function(i,n){t.send(e,"overrideComponentsColorById");var r=this.getViewer().getFilter(),a={color:parseInt(n.getHEX(),16),opacity:n.getAlpha()};r.addToOverrideListByColor(i,a)},applyMaterialOverrideSet:function(e,t,i,n,r){var a=this.getViewer(),o=function(){for(var e=l.overriders,t=a.getFilter(),i=0,r=e.length;i<r;i++){var o=e[i].material,s=e[i].condition;o&&t.addToOverrideListByMaterial(s,o)}a.render(),n&&n()},s=function(){r&&r()},l=new CLOUD.MaterialOverriderSet,c=function(e){if(e){var t=a.modelManager.getConditions();l.load(e,t,i,o,s)}},u=function(e){e="loading materialOverrideSet error:"+e,r&&r(e)},h=this._getMetaDataManager();h.getMaterialOverride(e,t,c,u)},overrideComponentsColorByObjectData:function(i,n){t.send(e,"overrideComponentsColorByObjectData");var r=this.getViewer().getFilter(),a={color:parseInt(n.getHEX(),16),opacity:n.getAlpha()};console.log(a),r.addToOverrideListByConditions(i,a)},restoreComponentsColorById:function(i){t.send(e,"restoreComponentsColorById"),this.getViewer().getFilter().addToOverrideListByColor(i,null)},restoreComponentsColorByObjectData:function(i){t.send(e,"restoreComponentsColorByObjectData"),this.getViewer().getFilter().addToOverrideListByConditions(i,null)},clearOverrideColorComponents:function(){this.getViewer().getFilter().clearAllOverrideList()},restoreDefault:function(){t.send(e,"restoreDefault"),this.clearAllRooms(),this.clearIsolation(),this.clearSelectedComponents(),this.showAllComponents(),this.opaqueAllComponents()},restoreAllDefault:function(){t.send(e,"restoreAllDefault"),this.clearOverrideColorComponents(),this.restoreDefault()},zoomIn:function(){this.getViewer().zoomIn()},recordCustomedHomeview:function(e){this.customedHomeview=e},getCustomedHomeview:function(){return this.customedHomeview},getDefaultHomeview:function(){if(this._opt.floorExplosion){var e=this.getViewer();e.setHomeView(e.getHomeView()),this.defaultHomeview=this.getCameraStatus()}return this.defaultHomeview},getViewHouseIsLoaded:function(){return this.bViewHouseIsLoaded},zoomOut:function(){this.getViewer().zoomOut()},setCameraAnimation:function(i){t.send(e,"setCameraAnimation"),this.getViewer().setTransitionAnimationState(i)},getCameraAnimation:function(){return this.getViewer().getTransitionAnimationState()},toggleContextMenuDisplay:function(i){t.send(e,"toggleContextMenuDisplay"),this._opt.enableToggleContextMenuDisplay=void 0!==i?i:!this._opt.enableToggleContextMenuDisplay},render:function(){this.getViewer().render()},enableOrbit:function(i){t.send(e,"enableOrbit"),CLOUD.EditorConfig.NoRotate=void 0!=i&&!i},setMinimumFPS:function(i){if(t.send(e,"setMinimumFPS"),"number"!=typeof i)return!1;i=i>60?60:i<4?4:i,this.getViewer().limitFrameRate(i)},setFlySpeedRate:function(i){if(t.send(e,"setFlySpeedRate"),void 0==i&&(i=1),"number"!=typeof i)return!1;i=i>25?25:i<=0?0:i,this.getViewer().setWalkSpeedRate(2*i)},enableGravity:function(i){t.send(e,"enableGravity"),CLOUD.GlobalData.WalkingWithGravity=!!i},enableHitDetection:function(i){t.send(e,"enableHitDetection"),this.getViewer().enableHitDetection(i)},exitWalk:function(){t.send(e,"exitWalk");var i=document.querySelector(".gld-bf-firstperson.bf-checked");i&&i.click()},setView:function(i){t.send(e,"setView");var n=CLOUD.EnumStandardView,r={Home:n.ISO,Top:n.Top,Bottom:n.Bottom,North:n.Back,South:n.Front,West:n.Left,East:n.Right,SouthEast:n.SouthEast,SouthWest:n.SouthWest,NorthEast:n.NorthEast,NorthWest:n.NorthWest};this.exitWalk(),this.getViewer().setStandardView(r[i])},zoomToSelectedComponents:function(i){t.send(e,"zoomToSelectedComponents"),i=i||1,this.getViewer().zoomToSelection(i)},zoomToBoundingBox:function(i){if(t.send(e,"zoomToBoundingBox"),i&&i.min&&i.max){var n=[[i.min.x,i.min.y,i.min.z],[i.max.x,i.max.y,i.max.z]];this.getViewer().zoomToBBox(CLOUD.Utils.computeBBox(n),.5)}},setNavigationMode:function(i){t.send(e,"setNavigationMode");var n=this.getViewer();switch(i){case"Fly":n.setEditorMode(CLOUD.EditorMode.FLY);break;case"Orbit":n.setEditorMode(CLOUD.EditorMode.ORBIT);break;case"Zoom":n.setEditorMode(CLOUD.EditorMode.ZOOM);break;case"OrbitWithModelCenter":n.setEditorMode(CLOUD.EditorMode.PICK),n.setPointRotateMode(CLOUD.RotatePivotMode.CENTER);break;case"Select":n.setPointRotateMode(CLOUD.RotatePivotMode.SELECTION),n.setEditorMode(CLOUD.EditorMode.PICK);break;case"PickWithRect":n.setPointRotateMode(CLOUD.RotatePivotMode.SELECTION),n.setEditorMode(CLOUD.EditorMode.PICK),this.enablePickRect(!0),this.enableZoomRect(!1);break;case"ZoomWithRect":this.enableZoomRect(!0),this.enablePickRect(!1);break;case"Walk":n.setEditorMode(CLOUD.EditorMode.WALK),this.enablePickRect(!1),this.enableZoomRect(!1)}},enableZoomRect:function(i){t.send(e,"enableZoomRect");var n=this.getViewer();this._opt.enableZoomRect=i,i?n.editorManager.enableTool(n,CLOUD.EditToolMode.ZOOM_BY_RECT):n.editorManager.disableTool(CLOUD.EditToolMode.ZOOM_BY_RECT)},enablePickRect:function(e){var t=this.getViewer();e?t.editorManager.enableTool(t,CLOUD.EditToolMode.PICK_BY_RECT):t.editorManager.disableTool(CLOUD.EditToolMode.PICK_BY_RECT)},setOrbitButton:function(i){t.send(e,"setOrbitButton");var n={Left:"left",Right:"right"};this._opt.orbitButton=i,this.getViewer().setOrbitButton(n[i])},setUseLeftHandedInput:function(i){t.send(e,"setUseLeftHandedInput"),this._opt.leftHandedMouseSetup=i,this.getViewer().setOrbitButton(i&&"left"||"right")},getUseLeftHandedInput:function(){return void 0===this._opt.leftHandedMouseSetup||this._opt.leftHandedMouseSetup},setReverseWheelDirection:function(i){t.send(e,"setReverseWheelDirection"),this.getViewer().setReverseWheelDirection(i)},enableHover:function(i){t.send(e,"enableHover"),this._opt.enableHover=i,this.getViewer().enableHover(i)},getCameraStatus:function(){return JSON.parse(this.getViewer().getCamera())},setCameraStatus:function(i,n){t.send(e,"setCameraStatus"),"object"==(void 0===i?"undefined":_typeof(i))&&(i=JSON.stringify(i)),this.getViewer().setCamera(i,!1,n)},setCameraType:function(e,t){var i=this.getViewer(),n=i.camera;"PerspectiveCamera"==e?(void 0==t?t=45:t<10?t=10:t>120&&(t=120),n.setFov(t),i.switchToCamera("persp")):"OrthographicCamera"==e&&i.switchToCamera("orth")},highlightComponentsById:function(e,t,i){if(!i)return!1;var n=this.getViewer().getFilter(),r={Red:"red",Orange:"beforeEdit",Yellow:"yellow",Green:"green",Blue:"blue",Black:"black"};n.setOverriderByUserIds(i,e,r[t])},highlightComponentsByObjectData:function(e,t){for(var i=this.getViewer().getFilter(),n={Red:"red",Orange:"beforeEdit",Yellow:"yellow",Green:"green",Blue:"blue",Black:"black "},r=[],a=0,o=e.length;a<o;a++)r.push({condition:e[a],material:n[t]});i.setConditionOverrider(r)},loadViewCore:function(e){if(e&&e.renderVersion!=e.renderVersion)return console.log("this model can not be added."),!1;var t=Glodon.Bimface.Data.StatisticsDataManager.getInstance();t.modelType=e.modelType,t.modelId=e.modelId;var i,n=this,r=n.getViewer(),a=n._opt,o=a.databagResource||"/"+e.databagId+"/resource/v3/model";e.bake&&"success"==e.bake.status&&(i="/"+e.bake.databagId+"/resource/baking"),r.load(o,a.resourceHost,null,null,i),n._modelData[e.viewToken]=e,n._modelData[e.viewToken].databagResource=o,n._modelNum++,n._data||(n._data=e,n._modelData[e.viewToken].isDefault=!0),n._opt.enableSkyBox&&this.setSkyBoxType(n._opt.skyBoxType),n.getEventManager().fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.AddView,n._modelNum)},loadMaterialOverrideSet:function(e,t,i,n,r){var a=this.getViewer(),o=a.modelManager,s=function(e){e&&(o.createMaterialOverrideSet(e,r),i&&i())},l=function(e){e="loading materialOverrideSet error:"+e,n&&n(e)};this._getMetaDataManager().getMaterialOverride(e,t,s,l)},changeMaterialOverrideSetMode:function(e){var t=this.getViewer();t.enableTextureMapping(!e),t.render()},addModel:function(e){if(this._data&&this._data.renderVersion!=e.renderVersion)return console.log("this model can not be added."),!1;var t=Glodon.Bimface.Data.StatisticsDataManager.getInstance();t.modelType=e.modelType,t.modelId=e.modelId,e.viewToken=e.viewToken||e.databagId;var i,n=this,r=n.getViewer(),a=n._opt;e.path?(i=Glodon.Web.Lang.Utility.ClientHelper.formatURL(e.path+"/"+e.databagId+"/resource/v3/model"),r.load(i,"")):(i=Glodon.Web.Lang.Utility.ClientHelper.formatURL("/"+e.databagId+"/resource/v3/model"),r.load(i,a.resourceHost)),n._modelData[e.viewToken]=e,n._modelData[e.viewToken].databagResource=i,n._modelNum++,n._data||(n._data=e,n._modelData[e.viewToken].isDefault=!0),n.getEventManager().fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.AddView,n._modelNum)},removeView:function(i){t.send(e,"removeView");var n=this,r=this.getViewer(),a=this._modelData[i];if(a){var o=this._modelData[i].databagResource;a.isDefault&&n._modelNum>1||(r.unload(o),n._modelNum--,delete this._modelData[i],0==n._modelNum&&(delete n._data,delete n._MetaDataManager),this.getEventManager().fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.RemoveView,n._modelNum))}},showView:function(i){t.send(e,"showView");var n=this.getViewer(),r=n.modelManager.models,a=this._modelData[i].databagResource;a&&r[a]&&n.showScene(r[a],!0)},hideView:function(i){t.send(e,"hideView");var n=this.getViewer(),r=n.modelManager.models,a=this._modelData[i].databagResource;a&&r[a]&&n.showScene(r[a],!1)},worldToScene:function(e){return this.getViewer().worldToDrawing(e)},sceneToWorld:function(e){return this.getViewer().drawingToWorld(e)},resize:function(e,t){var i=this._opt.domElement,n=e||i.clientWidth,r=t||i.clientHeight;this.getViewer().resize(n,r)},setBackgroundColor:function(i,n){if(t.send(e,"setBackgroundColor"),n)this.setBackgroundColors([{color:i,stop:"0%"},{color:n,stop:"100%"}],"180deg");else{var r=Glodon.Web.Graphics.Color,a={Black:new r(0,0,0,1),Blue:new r(0,0,189,1),Green:new r(0,255,0,1),Red:new r(255,0,0,1),Yellow:new r(250,189,5,1)},o=this._opt.domElement;"string"==typeof i&&(i=a[i]),this._opt.backgroundColor=[i],o.style.background=i.getRGBA()}},setBackgroundColors:function(e,t){var i=this._opt.domElement,t=t||"0deg",n=[];if(e&&e.length>0){1==e.length&&this.setBackgroundColor(e[0].color||e[0]),this.backgroundColor=e;for(var r=0;r<e.length;r++){var a=e[r].color.getRGBA()+" "+e[r].stop;n.push(a)}var o=t+", "+n.join(",");i.style.background="linear-gradient("+o+")"}},getCurrentState:function(){var e,t,i=this.getViewer().getFilter().saveState(),n=this.getCameraStatus(),r=this.getSelectedComponents(),a=this.getCurrentAxisGridsState();return this._sectionBox&&(e=this._sectionBox.getState()),this._sectionPlane&&(t=this._sectionPlane.getState()),{state:JSON.parse(i),camera:n,selection:r,axisGrid:a,sectionBoxState:e,sectionPlaneState:t}},setState:function(i){t.send(e,"setState"),"string"==typeof i&&(i=JSON.parse(i));var n=this.getViewer();if(this.setSelectedComponentsById(i.selection),n.getFilter().loadState(JSON.stringify(i.state)),i.axisGrid&&this.setAxisGridsState(i.axisGrid),i.sectionBoxState){var r;if(this._sectionBox)r=this._sectionBox;else{var a=new Glodon.Bimface.Plugins.Section.SectionBoxConfig;a.viewer=this,a.id="SectionBox",r=new Glodon.Bimface.Plugins.Section.SectionBox(a)}r.setState(i.sectionBoxState)}else this._sectionBox&&(this._sectionBox.hideBox(),this._sectionBox.exit());if(i.sectionPlaneState){var o;if(this._sectionPlane)o=this._sectionPlane;else{var a=new Glodon.Bimface.Plugins.Section.SectionPlaneConfig;a.viewer=this,
a.id="SectionPlane",o=new Glodon.Bimface.Plugins.Section.SectionPlane(a)}o.setState(i.sectionPlaneState)}else this._sectionPlane&&(this._sectionPlane.hidePlane(),this._sectionPlane.exit());var s=this;this.setCameraStatus(i.camera,function(){0==s.getCameraAnimation()&&s.render()})},createSnapshot:function(e){return console.warn("This function is deprecated. Please use createSnapshotAsync instead."),this.getViewer().canvas2image(e)},createSnapshotAsync:function(i,n){t.send(e,"createSnapshotAsync");var r=this;r.getViewer().getRenderBufferScreenShot(i.getRGBA(),function(e){n&&n(e),r.render()})},section:function(){console.log("This function is deprecated. Please use enableSectionBox instead.")},enableSectionBox:function(){var e=this,t=this.getViewer();t.editorManager.enableTool(t,CLOUD.EditToolMode.CLIP_BY_BOX),e._sectionTool=new CLOUD.ClipPlaneService(t),e._sectionTool.toggle(!0,!0),e._sectionTool.setVisible(!0),e._isSection=!0,this.render()},disableSectionBox:function(){var e=this;this.getViewer().editorManager.disableTool(CLOUD.EditToolMode.CLIP_BY_BOX),e._isSection=!1,this.render()},resetSectionBox:function(){if(!this._isSection)return void console.log(o);this.showSectionBox(),this.setSectionBoxMode(),this._sectionTool.reset("Rotate")},setSectionBoxMode:function(e){if(!this._isSection)return void console.log(o);"Rotate"==e?this._sectionTool.setRotatable(!0):this._sectionTool.setRotatable(!1)},showSectionBox:function(){if(!this._isSection)return void console.log(o);this._sectionTool.setVisible(!0),this.render()},hideSectionBox:function(){if(!this._isSection)return void console.log(o);this._sectionTool.setVisible(!1),this.render()},setSectionBox:function(e){var t=this.getViewer(),i=t.getScene().getClipPlanes(),n=t.worldToDrawing(e.min),r=t.worldToDrawing(e.max);this.enableSectionBox(),i.setSectionBox(n,r),this.hideSectionBox()},getSectionBoxState:function(){return this._isSection?this._sectionTool.saveState():void console.log(o)},setSectionBoxState:function(e){if(!this._isSection)return void console.log(o);this._sectionTool.loadState(e)},getFamilyTypes:function(e){var t=this,i=t._data;if(i.isSupportFamilyTypeList){var n=new Glodon.Bimface.Data.FamilyDataManagerConfig;n.databagId=i.databagId,n.resourceHost=t._opt.resourceHost;new Glodon.Bimface.Data.FamilyDataManager(n).getFamilyTypes(function(t){e&&e(t)})}},showFamilyTypeById:function(i){t.send(e,"showFamilyTypeById");var n=Glodon.Bimface.Viewer.IsolateOption;this.isolateComponentsByObjectData([{typeId:i}],n.HideOthers),this.getEventManager().fireEvent(Glodon.Bimface.Viewer.Viewer3DEvent.FamilyTypeChanged,i)},getModelTree:function(i){t.send(e,"getModelTree"),this._getMetaDataManager().getModelTree(i)},getScheduleList:function(i){t.send(e,"getScheduleList"),this._getMetaDataManager().getScheduleList(i)},getScheduleById:function(i,n){t.send(e,"getScheduleById"),this._getMetaDataManager().getScheduleById(i,n)},getElementByConditions:function(e,t,i){this._getMetaDataManager().getElementByConditions(e,t,i)},getModeTree:function(e){console.warn("This function is deprecated. Please use getModelTree instead."),this.getModelTree(e)},getFloors:function(e){this._getMetaDataManager().getFloors(e)},createAreaInfo:function(e,t){return console.log("This method is obsolete, please use createBoundary(points) instead."),this.createBoundary(t)},createBoundary:function(i){return t.send(e,"createBoundary"),this.getViewer().createAreaInfo("",i)},getAreas:function(i){t.send(e,"getAreas"),this._getMetaDataManager().getAreas(i)},getComponentProperty:function(i,n,r){t.send(e,"getComponentProperty"),this._getMetaDataManager().getComponentProperty(i,n,r)},getComponentOverriddenProperty:function(i,n,r){t.send(e,"getComponentOverriddenProperty"),this._getMetaDataManager().getComponentOverriddenProperty(i,n,r)},getModelGroup:function(e){this._getMetaDataManager().getModelGroup(e)},getAreaProperty:function(e,t){this._getMetaDataManager().getAreaProperty(e,t)},getMaterialProperty:function(i,n,r){t.send(e,"getMaterialProperty"),this._getMetaDataManager().getMaterialProperty(i,n,r)},getRoomProperty:function(e,t){this._getMetaDataManager().getRoomProperty(e,t)},getFiles:function(e){this._getMetaDataManager().getFiles(e)},getLinkGraph:function(e){this._getMetaDataManager().getLinkGraph(e)},getDrawingsheets:function(e){this._getMetaDataManager().getDrawingsheets("","",e)},getAllDrawingsheets:function(i){t.send(e,"getAllDrawingsheets"),this._getMetaDataManager().getAllDrawingsheets("","",i)},getLinksJson:function(e){this._getMetaDataManager().getLinksJson("","",e)},getMapInfo:function(e){this._getMetaDataManager().getMapInfo(e)},showViewHouse:function(){t.send(e,"showViewHouse");var i=this;if(i._viewHouse)i._viewHouse.enableViewHouse(!0);else{this.bViewHouseIsLoaded=!0;var n=i._opt,r=Glodon.Bimface.Plugins.ViewHouseConfig();r.domElement=n.domElement,r.viewer=i,i._viewHouse=new Glodon.Bimface.Plugins.ViewHouse(r)}},hideViewHouse:function(){t.send(e,"hideViewHouse"),this._viewHouse&&this._viewHouse.enableViewHouse(!1)},startAutoRotate:function(i){function n(){a.rotateByAxis(i,"x"),a.render(),r._animationFrameHandle=requestAnimationFrame(n)}t.send(e,"startAutoRotate");var r=this,a=this.getViewer();if(0==i)return void r.stopAutoRotate();r._animationFrameHandle&&r.stopAutoRotate(),n()},stopAutoRotate:function(){t.send(e,"stopAutoRotate"),this._animationFrameHandle&&cancelAnimationFrame(this._animationFrameHandle)},disableComponentsSelectionById:function(e){console.log("the method deprecated.")},enableComponentsSelectionById:function(e){console.log("the method deprecated.")},isIsolate:function(){return this.getViewer().getFilter().isIsolate()},isFiltering:function(){return this.getViewer().getFilter().isFiltering()},worldToClient:function(e){return this.getViewer().worldToCanvas(e)},clientToWorld:function(e){return this.getViewer().canvasToWorld(e)},pickByPoint:function(e){var t=this.getViewer(),i=t.pickByPoint(e);if(i)return{objectId:i.meshId,boundingBox:i.worldBoundingBox,worldPosition:i.worldPosition,clientPosition:i.clientPosition}},hitTest:function(e){return console.warn("This function is deprecated. Please use pickByPoint instead."),this.pickByPoint(callback)},isInViewFrustum:function(e){return this.getViewer().insideCamera(e)},lockAxis:function(e){if("Z"!=e)return void console.warn("The API supports AxisOption.Z only for now.");this.getViewer().lockAxisZ(!0)},unlockAxis:function(e){if("Z"!=e)return void console.warn("The API supports AxisOption.Z only for now.");this.getViewer().lockAxisZ(!1)},enableMouseHoverHighlight:function(){this.getViewer().enableHover(!0)},disableMouseHoverHighlight:function(){this.getViewer().enableHover(!1)},setOverallLightIntensity:function(e){this.getViewer().setLightIntensityFactor(e)},getOverallLightIntensity:function(e){return CLOUD.GlobalData.LightIntensityFactor},moveTo:function(e){var t=CLOUD.MoveDirection,t={Up:CLOUD.MoveDirection.UP,Down:CLOUD.MoveDirection.DOWN,Left:CLOUD.MoveDirection.LEFT,Right:CLOUD.MoveDirection.RIGHT,Forward:CLOUD.MoveDirection.FORWARD,Back:CLOUD.MoveDirection.BACK};this.getViewer().moveTo(t[e])},getInformation:function(){t.send(e,"getInformation");var i=this.getViewer();return{elements:i.getNumOfElements(),renderables:i.getNumOfRenderables(),triangles:i.getNumOfTriangles()}},getComponentsByClientCoordinates:function(e){var t=this.getViewer().getObjectsByClientCoordinates(e);t.sort(function(e,t){return e.distance-t.distance});for(var i=[],n=0;n<t.length;n++){var r=t[n],a=r.userId||r.object.name;-1==i.indexOf(a)&&i.push(a)}return i},setBorderLineEnabled:function(i){t.send(e,"setBorderLineEnabled");var n=this.getViewer();this._opt.enableBorderLine=i,i?n.setDrawingStyle(CLOUD.DrawingStyle.SHADINGWITHLINE):n.setDrawingStyle(CLOUD.DrawingStyle.SHADING)},setLightingMode:function(i){t.send(e,"setLightingMode");var n=this.getViewer().IBLManager;i==Glodon.Bimface.Viewer.LightingMode.IBL?this._opt.enableIBLBackground=!0:(this._opt.enableIBLBackground=!1,n.enableIBL(!1))},loadIBLScene:function(i,n){t.send(e,"loadIBLScene");var r=this,a=this.getViewer().IBLManager,o=this._data,s=o.dataEnvType==BimfaceEnvOption.Local?o.dataPath:hostConfig.staticHost;this._opt.enableIBLBackground&&(a.enableIBL(!0),this._getIBLConfig(function(e){var t=e;t[i]&&(r._opt.loadIBLScene=i,t[i].url=t[i].url.replace(hostConfig.staticHost,""),a.loadIBLMaps(s+"/"+t[i].url,t[i].isHDR,n,t[i].uniforms),n&&a.setSkyBoxType(i))}))},enableIBLBackground:function(i){t.send(e,"enableIBLBackground");var n=this.getViewer().IBLManager;if(i&&this._opt.enableIBLBackground){var r=this._opt.loadIBLScene;if(r==n.getSkyBoxType())n.addSkyBox(!0);else{var a="resources/IBL/Pics/"+this._opt.loadIBLScene,o=this._data,s=o.dataEnvType==BimfaceEnvOption.Local?o.dataPath:hostConfig.staticHost;n.loadSkyBox(s+"/"+a,!0),n.setSkyBoxType(r)}this._opt.IBLSkyBox=!0}else this._opt.IBLSkyBox=!1,n.removeSkyBox()},enableSkyBox:function(e){if(this._opt.enableSkyBox=e,!this._opt.IBLSkyBox){var t=this.getViewer().IBLManager;e?this.setSkyBoxType(this._opt.skyBoxType):this._opt.skyBoxType==t.getSkyBoxType()&&t.removeSkyBox()}},setSkyBoxType:function(e){if("CloudySky"!=e)return void console.log("Warning::there is no skyboxType named"+e);if(this._opt.enableSkyBox){this._opt.skyBoxType=e;var t=this.getViewer().IBLManager,i="resources/SkyBox/Pics/"+this._opt.skyBoxType,n=this._data,r=n.dataEnvType==BimfaceEnvOption.Local?n.dataPath:hostConfig.staticHost;t.loadSkyBox(r+"/"+i,!1),t.setSkyBoxType(this._opt.skyBoxType)}},getSkyBoxType:function(){return this._opt.skyBoxType},getViewToken:function(e,t){this._getFileManager().getViewToken(e,t)},resizePool:function(e){this.getViewer().resizePool(e)},_getMetaDataManager:function(){if(this._MetaDataManager)return this._MetaDataManager;var e=new Glodon.Bimface.Data.MetaDataManagerConfig,t=this._data;return t.integrateDrawings&&"success"==t.integrateDrawings.status&&(e.integrateDrawings=t.integrateDrawings),e.APIHost=this._opt.APIHost,e.viewToken=t.viewToken,e.databagId=t.databagId,e.modelId=t.modelId,e.modelType=t.modelType,e.dataEnvType=t.dataEnvType||e.dataEnvType,t.path?(e.relativeUrlWithoutDatabagId=Glodon.Web.Lang.Utility.ClientHelper.formatURL(t.path),e.relativeUrl=Glodon.Web.Lang.Utility.ClientHelper.formatURL(t.path+e.databagId)):(e.relativeUrlWithoutDatabagId=Glodon.Web.Lang.Utility.ClientHelper.formatURL(""+e.resourceHost),e.relativeUrl=Glodon.Web.Lang.Utility.ClientHelper.formatURL(e.resourceHost+"/"+e.databagId)),this._MetaDataManager=new Glodon.Bimface.Data.MetaDataManager(e),this._MetaDataManager},_getFileManager:function(){if(this._FileManager)return this._FileManager;var e=new Glodon.Bimface.Data.FileManagerConfig,t=this._data;return e.APIHost=this._opt.APIHost,e.viewToken=t.viewToken,e.databagId=t.databagId,e.modelId=t.modelId,e.modelType=t.modelType,e.dataEnvType=t.dataEnvType,this._FileManager=new Glodon.Bimface.Data.FileManager(e),this._FileManager},setArea:function(e,t,i){console.log("This method is obsolete, please use createRoom(boundary, height, id) instead."),this.createRoom(e,t,i)},createRoom:function(i,n,r){t.send(e,"createRoom"),this.getViewer().getScene().getExtrudeBodyManager().clearNodes(),this.addArea(i,n,r)},createRoomByOffset:function(i,n,r){if(t.send(e,"createRoomByOffset"),n&&n.length>=2)var a=n[0],o=n[1]-n[0];if(i="string"==typeof i?i=JSON.parse(i):i,i.loops&&i.loops.length>0)for(var s=i.loops[0],l=s.length,c=0;c<l;++c)for(var u=s[c],h=u.length,d=0;d<h;++d)s[c][d].z+=a;else i.offsetZ+=a;this.getViewer().getScene().getExtrudeBodyManager().clearNodes(),this.addArea(i,o,r)},clearArea:function(){console.log("This method is obsolete, please use clearAllRooms() instead."),this.clearAllRooms()},clearAllRooms:function(){t.send(e,"clearAllRooms"),this.getViewer().getScene().getExtrudeBodyManager().clearNodes()},addArea:function(i,n,r,a,o){t.send(e,"addArea");var r=r||Glodon.Web.Lang.Utility.UUID.createUUID(),a=a||new Glodon.Web.Graphics.Color(50,138,240,.3),o=o||new Glodon.Web.Graphics.Color(50,138,240,1),s=this.getViewer(),l=s.getScene().getExtrudeBodyManager(),c=l.createMaterial({color:parseInt(a.getHEX(),16),transparent:!0,opacity:a.getAlpha()}),u=l.createMaterial({color:parseInt(o.getHEX(),16),opacity:o.getAlpha()});return"string"==typeof i&&(i=JSON.parse(i)),l.addNode(r,i,n,c,u),r},showAreasById:function(e){console.log("This method is obsolete, please use showRoomsById(roomIds) instead."),this.showRoomsById(e)},showRoomsById:function(i){t.send(e,"showRoomsById");var n=this.getViewer(),r=n.getScene().getExtrudeBodyManager();if(i&&i.length>0)for(var a=0;a<i.length;a++)r.setNodeVisibleById(i[a],!0)},hideAreasById:function(e){console.log("This method is obsolete, please use hideRoomsById(roomIds) instead."),this.hideRoomsById(e)},hideRoomsById:function(i){t.send(e,"hideRoomsById");var n=this.getViewer(),r=n.getScene().getExtrudeBodyManager();if(i&&i.length>0)for(var a=0;a<i.length;a++)r.setNodeVisibleById(i[a],!1)},showAllAreas:function(){console.log("This method is obsolete, please use showAllRooms() instead."),this.showAllRooms()},showAllRooms:function(){t.send(e,"showAllRooms"),this.getViewer().getScene().getExtrudeBodyManager().showAllNodes()},hideAllAreas:function(){console.log("This method is obsolete, please use hideAllRooms() instead."),this.hideAllRooms()},hideAllRooms:function(){t.send(e,"hideAllRooms"),this.getViewer().getScene().getExtrudeBodyManager().hideAllNodes()},setAreasColorById:function(e,t){console.log("This method is obsolete, please use setRoomsColorById(roomIds, color) instead."),this.setRoomsColorById(e,t)},setRoomsColorById:function(i,n){t.send(e,"setRoomsColorById");var r=this.getViewer(),a=r.getScene().getExtrudeBodyManager();if(i&&i.length>0)for(var o=0;o<i.length;o++)a.setNodeColorById(i[o],n)},getAreaColorById:function(e){return console.log("This method is obsolete, please use getRoomColorById(roomId) instead."),this.getRoomColorById(e)},getRoomColorById:function(e){var t=this.getViewer(),i=t.getScene().getExtrudeBodyManager(),n=i.getNodeColorById(e);return new Glodon.Web.Graphics.Color(n.red,n.green,n.blue,n.alpha)},setAreasFrameColorById:function(e,t){console.log("This method is obsolete, please use setRoomsFrameColorById(roomIds, color) instead."),this.setRoomsFrameColorById(e,t)},setRoomsFrameColorById:function(i,n){t.send(e,"setRoomsFrameColorById");var r=this.getViewer(),a=r.getScene().getExtrudeBodyManager();if(i&&i.length>0)for(var o=0;o<i.length;o++)a.setWireframeColorById(i[o],n)},getAreaFrameColorById:function(e){return console.log("This method is obsolete, please use getRoomFrameColorById(roomId) instead."),this.getRoomFrameColorById(e)},getRoomFrameColorById:function(e){var t=this.getViewer(),i=t.getScene().getExtrudeBodyManager(),n=i.getWireframeColorById(e);return new Glodon.Web.Graphics.Color(n.red,n.green,n.blue,n.alpha)},clearAreasById:function(e){console.log("This method is obsolete, please use clearRoomsById(objectIds) instead."),this.clearRoomsById(e)},clearRoomsById:function(i){t.send(e,"clearRoomsById");var n=this.getViewer(),r=n.getScene().getExtrudeBodyManager();if(i&&i.length>0)for(var a=0;a<i.length;a++)r.removeNodeById(i[a])},getLineSelectRange:function(){return this.getViewer().getLineSelectRange()},setLineSelectRange:function(e){this.getViewer().setLineSelectRange(e)},getExternalComponentManager:function(){return this.externalComponentManager||(this.externalComponentManager=new CLOUD.ExternalComponentManager(this.getViewer())),this.externalComponentManager},addExternalObject:function(i,n,r,a){t.send(e,"addExternalObject");var i=i||Glodon.Web.Lang.Utility.UUID.createUUID();this.getExternalComponentManager().addNode(i,n,r,a),this.getViewer().render()},addExternalObjects:function(i,n,r){t.send(e,"addExternalObjects");for(var a=this.getExternalComponentManager(),o=0;o<i.length;o++){var s=Glodon.Web.Lang.Utility.UUID.createUUID();a.addNode(s,i[o],n,r)}this.getViewer().render()},removeExternalObjectByName:function(i){t.send(e,"removeExternalObjectByName"),this.getExternalComponentManager().removeNodeById(i),this.getViewer().render()},clearExternalObjects:function(){t.send(e,"clearExternalObjects"),this.getExternalComponentManager().clearNodes(),this.getViewer().render()},getExternalObjectByName:function(i){return t.send(e,"getExternalObjectByName"),this.getExternalComponentManager().getNodeById(i)},getAllExternalObjects:function(){return t.send(e,"getAllExternalObjects"),Object.values(this.getExternalComponentManager().getAllNodes())},getDrawingListbyId:function(i,n,r){function a(e){401==e?console.log("Unauthorized."):403==e?console.log("Forbidden."):404==e&&console.log("Not Found.")}t.send(e,"getDrawingListbyId"),this._getMetaDataManager().getDrawingList(i,n,r,a)},getWireframeColor:function(){return this.getViewer().getWireframeColor()},setWireframeColor:function(i){return t.send(e,"setWireframeColor"),this.getViewer().setWireframeColor(i)},restoreWireframeColor:function(){t.send(e,"restoreWireframeColor"),this.getViewer().restoreWireframeColor()},setExposureShift:function(i){t.send(e,"setExposureShift");var n=this.getViewer();i>1&&(i=1),i<-1&&(i=-1),this._opt.exposure=i,n.setExposureShift(i)},isSupportSSAO:function(){return this.getViewer().isSupportSSAO()},enableSSAO:function(i){return t.send(e,"enableSSAO"),this.getViewer().enableSSAO(i)},_getIBLConfig:function(e){var t=this,i=t._data;if(t._IBLConfig)e&&e(t._IBLConfig);else{var n=new Glodon.Bimface.Data.IBLManagerConfig;i.dataEnvType==BimfaceEnvOption.Local&&(n.resourceHost=i.dataPath);new Glodon.Bimface.Data.IBLManager(n).getIBLConfig(function(i){t._IBLConfig=i,e&&e(i)})}},_beforeInitialize:function(e){CLOUD.GlobalData.LimitFrameTime=1e3/e.minimumFPS,CLOUD.GlobalData.EnableDemolishByDClick=!1,CLOUD.GlobalData.DisableRotation=e.rotation,CLOUD.GlobalData.UseMpkWorker=!1,CLOUD.GlobalData.ZipResourcePostfix=e.suffix,CLOUD.GlobalData.LightIntensityFactor=1.2,CLOUD.GlobalData.Hover=e.enableHover,CLOUD.GlobalData.MaxMemeorySizeToFullRender=e.MaxMemeorySizeToFullRender},_config:function(e){var t=this.getViewer(),i={Left:"left",Right:"right"};t.setOrbitButton(i[e.orbitButton])},setRvtBorderLine:function(){this.getViewer().getFilter().setConditions(CLOUD.EnumConditionType.BORDERLINE,[{categoryId:categoryIds}])},setBorderLine:function(e){this.getViewer().getFilter().setConditions(CLOUD.EnumConditionType.BORDERLINE,e)},getWorldBox:function(e,t){var i=this.getViewer(),n=i.getScene(),r=n.getBoundingBoxWorld();return e&&(r.min.z=e),t&&(r.max.z=t),r},getFloorsbyFileId:function(e,t){var i=this._opt.resourceHost,n=this._data.databagId;a.ajax({async:!0,url:i+"/"+n+"/metadata/"+e+"/levels.json",success:function(e){var i=JSON.parse(e).levels;t&&t(i)}})},showAllAxisGrids:function(){var e=this._opt.resourceHost,t=this._data.databagId,i=this._data.modelType,n={},r=this;(function(){return new Promise(function(o,s){"singleModel"==i?(n.default={},a.ajax({async:!0,url:e+"/"+t+"/metadata/levels.json",success:function(e){n.default=JSON.parse(e).levels,o(n)}})):"integrateModel"==i&&r.getFiles(function(e){var t=e.length;e.forEach(function(e){var i=e.fileId.toString();n[i]={},r.getFloorsbyFileId(i,function(e){n[i]=e,0==--t&&o(n)})})})})})().then(function(i){0==i.length&&console.error("get level error");var n=r.getViewer().getScene();for(var a in i)for(var o=i[a],s=n.getAxisGridManager(),l=0;l<o.length;l++){var c=e+"/"+t+"/metadata/"+a+"/axisgrids/grids.json.gz";void 0!=a&&""!=a.trim()&&"default"!=a||(c=e+"/"+t+"/metadata/axisgrids/grids.json.gz");var u=o[l].elevation,h=o[l].id;s.loadAxisGridsByHeight(c,a,u,h,function(){r.render()})}},function(e){console.error("error",e)})},showAxisGridsByFloor:function(e,t,i){var n=new Glodon.Bimface.Plugins.AxisGrid.AxisGridManagerConfig;n.viewer=this;var r,o,s=(new Glodon.Bimface.Plugins.AxisGrid.AxisGridManager(n),this._opt.resourceHost),l=this._data.databagId,c=this._data.modelType,u=this.getViewer(),h=this.getViewer().getScene(),d=function(){u.render()};(function(){return new Promise(function(i,n){"singleModel"==c?(r=s+"/"+l+"/metadata/axisgrids/grids.json.gz",a.ajax({async:!0,url:s+"/"+l+"/metadata/levels.json",success:function(e){for(var n=JSON.parse(e).levels,r=0;r<n.length;r++)if(n[r].id==t){o=n[r].elevation;break}i(o)}})):"integrateModel"==c&&(r=s+"/"+l+"/metadata/"+e+"/axisgrids/grids.json.gz",a.ajax({async:!0,url:s+"/"+l+"/metadata/"+e+"/levels.json",success:function(e){for(var n=JSON.parse(e).levels,r=0;r<n.length;r++)if(n[r].id==t){o=n[r].elevation;break}i(o)}}))})})().then(function(n){if(void 0==n)return void console.error("get height error");var a=h.getAxisGridManager();"singleModel"==c&&(e="default"),a.loadAxisGridsByHeight(r,e,n,t,function(){d(),i&&i()})})},showAxisGridsByElevation:function(i,n,r){t.send(e,"showAxisGridsByElevation");var a=this._opt.resourceHost,o=this._data.databagId,s=null,l=this._data.modelType,c=this.getViewer(),u=this.getViewer().getScene();if(void 0==n)return void console.error("get height error");var h=u.getAxisGridManager();"singleModel"==l?(i="default",s=a+"/"+o+"/metadata/axisgrids/grids.json.gz"):"integrateModel"==l&&(s=a+"/"+o+"/metadata/"+i+"/axisgrids/grids.json.gz"),h.loadAxisGridsByHeight(s,i,n,"default",function(){c.render(),r&&r()})},bringAxisGridsToFront:function(e){this.getViewer().getScene().getAxisGridManager().enableDepthTest(!e)},removeAxisGridsByFloor:function(e,t,i){var n=this.getViewer().getScene(),r=n.getAxisGridManager();"singleModel"==this._data.modelType&&(e="default"),r.unloadAxisGridsByFloor(e,t),this.getViewer().render(),i&&i()},getCurrentAxisGridsState:function(){var e=this.getViewer().getScene(),t=e.getAxisGridManager(),i=t.getAxisGridState(),n=i.gridLineColor,r=i.gridBubbleColor;return"string"==typeof n&&(i.gridLineColor=new Glodon.Web.Graphics.Color(n,1)),"string"==typeof r&&(i.gridBubbleColor=new Glodon.Web.Graphics.Color(r,1)),i},setGridBubblesColor:function(e){this.getViewer().getScene().getAxisGridManager().setGridBubblesColor(e),this.getViewer().render()},getGridBubblesColor:function(){var e=this.getViewer().getScene(),t=e.getAxisGridManager(),i=t.getGridBubblesColor();return"string"==typeof i&&(i=new Glodon.Web.Graphics.Color(i,1)),i},setGridLinesColor:function(e){this.getViewer().getScene().getAxisGridManager().setGridLinesColor(e),this.getViewer().render()},getGridLinesColor:function(){var e=this.getViewer().getScene(),t=e.getAxisGridManager(),i=t.getGridLinesColor();return"string"==typeof i&&(i=new Glodon.Web.Graphics.Color(i,1)),i},enableAxisGridsHover:function(e){this.getViewer().getScene().getAxisGridManager().setIsEnableHover(e)},setAxisGridsState:function(e){this.removeAllAxisGrids();var t=this.getViewer(),i=this._opt.resourceHost,n=this._data.databagId,r=this.getViewer().getScene(),a=r.getAxisGridManager(),o=function(){t.render()},s=this,l=e.floorInfos;if(l instanceof Array)for(var c=i+"/"+n+"/metadata/axisgrids/grids.json.gz",u=0,h=0;h<l.length;h++){var d=l[h].id,f=l[h].height;a.loadAxisGridsByHeight(c,"default",f,d,function(){o&&o(),++u==l.length&&(s.setGridLinesColor(e.gridLineColor),s.setGridBubblesColor(e.gridBubbleColor))})}else{var u=0,p=0;for(var m in e)for(var g=e[m],h=0;h<g.length;h++){p++;var d=g[h].id,f=g[h].height,c=i+"/"+n+"/metadata/"+m+"/axisgrids/grids.json.gz";a.loadAxisGridsByHeight(c,m,f,d,function(){o&&o(),++u==p&&(s.setGridLinesColor(e.gridLineColor),s.setGridBubblesColor(e.gridBubbleColor))})}}},showAxisGrid:function(e,t,i){var n=this._opt.resourceHost,r=this._data.databagId,a=t+".json.gz",o=this.getViewer().getScene(),s=this.getViewer(),l=n+"/"+r+"/metadata/axisgrids/"+a;if("string"==typeof e&&""!=e.trim())var l=n+"/"+r+"/metadata/"+e+"/axisgrids/"+a;var c=function(){s.render()};o.getAxisGridManager().loadAxisGrid(l,e,i,void 0,t,c)},removeAxisGrid:function(e,t,i){this.getViewer().getScene().getAxisGridManager().unloadAxisGrid(e,t,i),this.getViewer().render()},removeAllAxisGrids:function(){this.getViewer().getScene().getAxisGridManager().unloadAllAxisGrids(),this.getViewer().render()},destroy:function(){t.send(e,"destroy"),this.getViewer().destroy()},addPlane:function(i,n,r,a){t.send(e,"addPlane");var o=this.getViewer();o.addPlane.apply(o,arguments)},getFloorBoundingBoxById:function(i,n){t.send(e,"getFloorBoundingBoxById"),this._getMetaDataManager().getMapInfo(function(e){for(var t=new THREE.Box3,r=0;r<e.floors.length;r++){var a=e.floors[r];if(a.id===i){var o=a.BoundingBox.Min,s=a.BoundingBox.Max;t.min=new THREE.Vector3(o.X,o.Y,o.Z),t.max=new THREE.Vector3(s.X,s.Y,s.Z);break}}n&&n(t)})},getComponentStatus:function(e){var t=this.getViewer(),i=t.getFilter(),n=i.getObjectInfoManager(),r=n.isHidden(e),a=n.isFrozen(e);return r?"hidden":a?"translucent":"show"},getMinimumDistanceByIds:function(i,n){return t.send(e,"getMinimumDistanceByIds"),console.log("This method is obsolete,  please use  getMinimumComponentDistanceById instead . "),this.getMinimumComponentDistanceById(i,n)},getMinimumComponentDistanceById:function(i,n){t.send(e,"getMinimumComponentDistanceById");var r=this.getViewer();if(i&&n){return r.calculateMinDistance(i,n)}},isEnableToggleContextMenuDisplay:function(){return this._opt.enableToggleContextMenuDisplay},isEnableHover:function(){return this._opt.enableHover},isEnableBorderLine:function(){return this._opt.enableBorderLine},getExposureShift:function(){return this._opt.exposure},getBackgroundColor:function(){return this._opt.backgroundColor},isEnableIBLBackground:function(){return this._opt.enableIBLBackground},getLoadIBLScene:function(){return this._opt.loadIBLScene},getCategoryVisibility:function(e,t){this._getMetaDataManager().getCategoryVisibility(function(t){e&&e(t)},function(e){t&&t(e)})},getSegmentGroups:function(e,t){this._getMetaDataManager().getSegmentGroups(function(t){e&&e(t)},function(e){t&&t(e)})},getSegmentFromGroups:function(e,t,i){this._getMetaDataManager().getSegmentFromGroups(e,function(e){t&&t(e)},function(e){i&&i(e)})},getSegmentTree:function(e,t){this._getMetaDataManager().getSegmentTree(function(t){e&&e(t)},function(e){t&&t(e)})},getSegmentById:function(e,t,i){this._getMetaDataManager().getSegmentById(e,function(e){t&&t(e)},function(e){i&&i(e)})},getSegmentElementIds:function(e,t,i){this._getMetaDataManager().getSegmentElementIds(e,function(e){t&&t(e)},function(e){i&&i(e)})},getPartialElementsMetadata:function(e,t,i){this._getMetaDataManager().getPartialElementsMetadata(e,function(e){t&&t(e)},function(e){i&&i(e)})},getPartialElementsMetadataFile:function(e){return this._getMetaDataManager().getPartialElementsMetadataFile(e)},getDatabagResource:function(e){return this._getMetaDataManager().getDatabagResource(e)},getSegmentManager:function(){return this.segmentManager||(this.segmentManager=new CLOUD.SegmentManager(this.getViewer())),this.segmentManager},getExternalObjectConverter:function(){return this.externalObjectConverter||(this.externalObjectConverter=new CLOUD.ExternalObjectConverter(this.getViewer())),this.externalObjectConverter},convertToExternalObject:function(i,n,r){return t.send(e,"convertToExternalObject"),this.getExternalObjectConverter().convertToExternalObject(i,n,r)},getExplosionExtent:function(){return this.getViewer().getExplosionExtent()},setExplosionExtent:function(e){var t=this.getViewer();if(e>3||e<0)return void console.log("Warning::extent should be in a range of [0,3]");0!=this.getFloorExplosionExtent&&t.setFloorExplosion(0),t.setExplosionExtent(e)},setFloorExplosion:function(i,n){t.send(e,"bf_c_explosion_floor");var r=this,a=this.getViewer(),o=function(e){e.sort(function(e,t){return e.elevation-t.elevation}),a.setFloorInfos(e),a.setFloorExplosion(i,n),r._opt.floorExplosion=!0},s=function(e){console.log(e),console.log("ERROR::Fail to get the floors message")};if(i>30||i<0)return void console.log("Warning::extent should be in a range of [0,30]");(0!=this.getExplosionExtent()&&a.setExplosionExtent(0),this._opt.floorExplosion)?a.setFloorExplosion(i,n):this._getMetaDataManager().getFloors(o,s)},getFloorExplosionExtent:function(){return this.getViewer().getFloorExplosionExtent()},getFloorExplosionList:function(){return this.getViewer().getFloorExplosionList()},clearFloorExplosion:function(){var e=this.getViewer();e.setFloorExplosion(0),e.modelManager.floorExplosionList=[]},enableSnap:function(i){if(t.send(e,"enableSnap"),this.getViewer().enableSnap(i),!1===i&&null!=this.snap)this.snap.destroy(),this.snap=null;else if(!0===i&&null==this.snap){var n=new Glodon.Bimface.Plugins.Snap.SnapConfig;n.viewer=this,this.snap=new Glodon.Bimface.Plugins.Snap.Snap(n)}},getOutlinerInfo:function(e){var t=this._opt.resourceHost,i=this._data.databagId;a.ajax({async:!0,url:t+"/"+i+"/metadata/outliner.gz",success:function(t){e&&e(t)}})}}),i.Viewer3D=l}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=function(){return{name:"defaultMap",domElement:null,width:240,height:240,viewer:null,axis:!1,host:hostConfig.resourceHost,onCameraChanged:null,inMoveOnAxisGrid:null}};e.MiniMapConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest")),i=function(e){var t=this,i=e;if(t._opt=i,!i.domElement)return console.log("domElement must not be empty."),!1;if(!i.viewer)return console.log("viewer is not defined."),!1;var n=i.viewer.getViewer();t._helper=new CLOUD.Extensions.MiniMapHelper(i.viewer.getViewer());var r=function(){t._helper.renderMiniMap()};n.addCallbacks("render",r),t.init()};i.prototype={init:function(){var e=this,i=e._opt,n={},r=[];e._helper;t.ajax({url:i.host+"/"+i.viewer._data.databagId+"/metadata/grids.json",async:!1,success:function(e){for(var t=JSON.parse(e),i=[],r=0,a=t.grids.length;r<a;r++){var o=t.grids[r];o.start.X=o.start.x,o.start.Y=o.start.y,o.start.Z=o.start.z,o.end.X=o.end.x,o.end.Y=o.end.y,o.end.Z=o.end.z,i.push(o)}n.Grids=i}}),t.ajax({async:!1,url:i.host+"/"+i.viewer._data.databagId+"/metadata/levels.json",success:function(e){n.Levels=JSON.parse(e).levels}}),t.ajax({async:!1,url:i.host+"/"+i.viewer._data.databagId+"/resource/model/maps/output.json",dataType:"text",success:function(e){var t=JSON.parse(e);for(var n in t){var a=t[n];void 0==a.id&&(a.id=n),a.path=i.host+"/"+i.viewer._data.databagId+"/resource/model/maps/"+a.id+".png",a.name=n,r.push(a)}}}),e._floors=r,e.createMap(n,r)},createMap:function(e,t){var i,n=this._helper,r=this._opt,a={left:0,bottom:0,outling:"none",position:"relative"};n.createMiniMap(r.name,r.domElement,r.width,r.height,a,r.onCameraChanged,r.inMoveOnAxisGrid),e.Grids&&e.Levels&&n.setAxisGridData(r.name,e),t.length>0&&(n.setAllFloorPlaneData(r.name,t),n.setFloorPlaneId(r.name,t[0].name)),n.generateAxisGrid(r.name),n.generateFloorPlane(r.name,!1),n.showAxisGrid(r.name,r.axis),i=n.getMiniMap(r.name),i.setMapClickCallback(function(){})},getFloors:function(){return this._floors},showAxisGrid:function(){this._helper.showAxisGrid(this._opt.name,!0)},hideAxisGrid:function(){this._helper.showAxisGrid(this._opt.name,!1)},showFloorById:function(e){var t=this,i=t._opt.name;t._helper.setFloorPlaneData(i,e),t._helper.generateFloorPlane(i,!0)},resize:function(e,t){this._helper.resize(this._opt.name,e,t)},onClick:function(e,t){var i=this,n=i._opt,e=e||"default",r=i._helper.getMiniMap(n.name);r.setMapClickMode(e),r.setMapClickCallback(function(e){t&&"function"==typeof t&&t(e)})},toLocation:function(e,t){var i=this,n=i._opt;i._helper.getMiniMap(n.name).toLocation(e,t)},imageCoord2WordCoord:function(e,t){var i=this,n=i._opt;return i._helper.getMiniMap(n.name).imageCoord2WordCoord(_defineProperty({x:e},"x",t))}},e.MiniMap=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Map"),t=function(){return{id:"defaultMap",name:"defaultMap",domElement:null,viewer:null,width:240,height:240,isShowGrid:!1,navigationMode:"Default",resourceHost:hostConfig.resourceHost}};e.MapConfig=t}(),function(){var e=Object.freeze({ViewerCameraChanged:"ViewerCameraChanged",
MouseClicked:"MouseClicked",MouseHoveredGrid:"MouseHoveredGrid",SelectionChanged:"SelectionChanged",SelectionEditor:"SelectionEditor",FloorPlaneChanged:"FloorPlaneChanged"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Map").MapEvents=e}(),function(){var e=Object.freeze({Default:"Default",Static:"Static"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Map").MapNavigationMode=e}(),function(){var e="Bimface.Plugins.Section.SectionPlane",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Map"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){var t=this,i=e;if(this.defaultFloorPlane="F01",t._opt=i,t.id=e.id,!i.domElement)return console.log("domElement must not be empty."),!1;if(!i.viewer)return console.log("viewer is not defined."),!1;var n=new Glodon.Web.Lang.EventManager;this.getEventManager=function(){return n};var r=i.viewer.getViewer();t._helper=new CLOUD.Extensions.MiniMapHelper(i.viewer.getViewer()),t.renderCB=function(){t._helper.renderMiniMap()},r.addCallbacks("render",t.renderCB),t.init()});n.prototype={addEventListener:function(e,t){this.getEventManager().addEvent(e,t)},removeEventListener:function(e,t){this.getEventManager().removeEvent(e,t)},init:function(){t.send(e,"init");var i=this;i._opt.viewer.getMapInfo(function(e){i._floors=e.floors,i.createMap(e.axisGrid,e.floors)})},createMap:function(i,n){t.send(e,"createMap");var r,a=this,o=a.getEventManager(),s=Glodon.Bimface.Plugins.Map.MapEvents,l=(Glodon.Bimface.Plugins.Map.MapNavigationMode,a._helper),c=a._opt,u={left:0,bottom:0,outling:"none",position:"relative"},h=function(e){o.fireEvent(s.ViewerCameraChanged,e)},d=function(e){o.fireEvent(s.MouseHoveredGrid,e)};if(l.createMiniMap(c.name,c.domElement,c.width,c.height,u,h,d),(i.Grids||i.Levels)&&l.setAxisGridData(c.name,i),n.length>0){l.setAllFloorPlaneData(c.name,n);var f=n.getObjectByAttribute("name",this.defaultFloorPlane);0==f?l.setFloorPlaneId(c.name,n[0].id):l.setFloorPlaneId(c.name,f.id)}l.generateAxisGrid(c.name),l.generateFloorPlane(c.name,!1),l.showAxisGrid(c.name,c.isShowGrid),r=l.getMiniMap(c.name),r.setMapClickMode(c.navigationMode.toLocaleLowerCase()),r.setMapClickCallback(function(e){o.fireEvent(s.MouseClicked,e)});var p=r.getMiniMapCallbackHandler();p.addCallbacks("MouseUp",function(e){o.fireEvent("SelectionChanged",e)}),p.addCallbacks("MouseMove",function(){o.fireEvent("SelectionEditor")}),p.addCallbacks("FloorPlaneChanged",function(e){o.fireEvent("FloorPlaneChanged",e)})},setDefaultFloorPlane:function(e){for(var t=this._floors,i=0;i<t.length;i++)if(t[i].name==e){var n=this._helper,r=this.getEventManager();return r.fireEvent("FloorPlaneChanged",e),n.setFloorPlaneId(this._opt.name,e),n.generateFloorPlane(this._opt.name,!1),!0}return!1},getFloorList:function(){return this._floors},getDefaultFloorPlane:function(){return this.defaultFloorPlane},getBoundingBox:function(){return this._helper.getMiniMap(this._opt.name).getBoundingBoxIsolate()},showGrid:function(){this._helper.showAxisGrid(this._opt.name,!0)},hideGrid:function(){this._helper.showAxisGrid(this._opt.name,!1)},showFloorById:function(e){var t=this,i=t._opt.name;t._helper.setFloorPlaneId(i,e),t._helper.generateFloorPlane(i,!0)},resize:function(e,t){this.clear(),this._helper.resize(this._opt.name,e,t)},setNavigationMode:function(e){var t=this._opt,i=this._helper,n=i.getMiniMap(t.name);t.navigationMode=e,n.setMapClickMode(t.navigationMode.toLocaleLowerCase())},clientCoord2WorldCoord:function(e,t){var i=this,n=i._opt;return i._helper.getMiniMap(n.name).imageCoord2WordCoord({x:e,y:t})},clear:function(){this._helper.getMiniMap(this._opt.name).destroyAll()},exit:function(){var e=this;e._opt.viewer.getViewer().removeCallbacks("render",e.renderCB),e.clear()}},i.Map=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=function(){function e(t,i){_classCallCheck(this,e),this.viewer=t.getViewer(),this.enumEventTypes={ON_COMPONENT_HOVER:1e3,ON_COMPONENT_CLICK:1001},this.initialize();var n=this;this.bimcube=new BimCube(i,BimfaceLanguage.name,function(){n.hookEvents(),n.bimcube.update(n.viewer.getActiveCameraInfo())})}return _createClass(e,[{key:"initialize",value:function(){this.enumViewMode={Home:0,Top:1,Bottom:2,Front:3,Back:4,Right:5,Left:6,SouthEast:7,SouthWest:8,NorthEast:9,NorthWest:10,BottomFront:11,BottomBack:12,BottomRight:13,BottomLeft:14,BottomSouthEast:15,BottomSouthWest:16,BottomNorthEast:17,BottomNorthWest:18,RoofFront:19,RoofBack:20,RoofRight:21,RoofLeft:22,RoofSouthEast:23,RoofSouthWest:24,RoofNorthEast:25,RoofNorthWest:26,TopTurnRight:27,TopTurnBack:28,TopTurnLeft:29,BottomTurnRight:30,BottomTurnBack:31,BottomTurnLeft:32,FrontTurnRight:33,FrontTurnTop:34,FrontTurnLeft:35,RightTurnBack:36,RightTurnTop:37,RightTurnFront:38,BackTurnRight:39,BackTurnTop:40,BackTurnLeft:41,LeftTurnFront:42,LeftTurnTop:43,LeftTurnBack:44}}},{key:"hookEvents",value:function(){var e=this.bimcube,t=this.viewer,i=this.enumViewMode;e.addEventListener(this.enumEventTypes.ON_COMPONENT_CLICK,function(e){var n=i[e.viewType];n&&t.setStandardView(n,null,function(){t.render()})}),t.addRenderCallback(function(){e.update(t.getActiveCameraInfo())})}},{key:"setVisible",value:function(e){!0===e?this.bimcube.show():this.bimcube.hide()}}]),e}();e.ViewHouseNavi=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=function(){return{width:140,height:140,domElement:null,viewer:null}};e.ViewHouseConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Application.UI.Menu"),t=function(e){var t=this,i=e.viewer;this.viewer=i;var n=e.domElement,r=Glodon.Bimface.UI.Control.ControlEvent,a=Glodon.Bimface.Viewer.Viewer3DEvent,o=i.getDomElement(),s=new Glodon.Bimface.UI.Menu.MenuConfig;s.element=n,this.menu=new Glodon.Bimface.UI.Menu.Menu(s),this.menu.element.style.backgroundColor="#EBEFF1",this.menu.element.style.border="1px solid #D0D6D6";var l=this.menu,c=new Glodon.Bimface.UI.Menu.MenuItemConfig;c.id="home";var u=new Glodon.Bimface.UI.Menu.MenuItem(c);u.setText(BimfaceLanguage.bf_viewHouse_home),u.element.addClass("bf-menu-item1"),i.getEventManager().addEvent(a.ToolbarHomeClick,function(){t.switchHomeView()}),u.addEventListener(r.Click,function(){t.switchHomeView(),t.setVisibility("hidden")}),this.switchHomeView=function(){var e=i.getCustomedHomeview(),t=i.getDefaultHomeview(),n=e||t,r=n.name;"orth"==r&&d.setText(BimfaceLanguage.bf_viewHouse_perspective),"persp"==r&&d.setText(BimfaceLanguage.bf_viewHouse_orthographic),i.setCameraStatus(n,function(){0==i.getCameraAnimation()&&i.render()})};var h=new Glodon.Bimface.UI.Menu.MenuItemConfig;h.id="orthographic";var d=new Glodon.Bimface.UI.Menu.MenuItem(h);d.setText(BimfaceLanguage.bf_viewHouse_orthographic),d.element.addClass("bf-menu-item1"),d.addEventListener(r.Click,function(){t.setVisibility("hidden"),d.element.textContent==BimfaceLanguage.bf_viewHouse_orthographic?(i.setCameraType("OrthographicCamera"),i.render(),d.setText(BimfaceLanguage.bf_viewHouse_perspective)):(i.setCameraType("PerspectiveCamera"),i.render(),d.setText(BimfaceLanguage.bf_viewHouse_orthographic))}),this.orthographic=d;var f=new Glodon.Bimface.UI.Menu.MenuItemConfig;f.id="setAsHome";var p=new Glodon.Bimface.UI.Menu.MenuItem(f);p.setText(BimfaceLanguage.bf_viewHouse_setAsHome),p.element.addClass("bf-menu-item1"),p.addEventListener(r.Click,function(){t.setVisibility("hidden");var e=i.getCameraStatus();i.recordCustomedHomeview(e)});var m=new Glodon.Bimface.UI.Menu.MenuItemConfig;m.id="resetHome";var g=new Glodon.Bimface.UI.Menu.MenuItem(m);g.setText(BimfaceLanguage.bf_viewHouse_resetHome),g.element.addClass("bf-menu-item1"),g.addEventListener(r.Click,function(){t.setVisibility("hidden"),i.recordCustomedHomeview(null)});var v=new Glodon.Bimface.UI.Menu.Spacer;v.element.style.backgroundColor="#D0D6D6";var y=new Glodon.Bimface.UI.Menu.Spacer;y.element.style.backgroundColor="#D0D6D6",this.menu.addControl(u),this.menu.addControl(v),this.menu.addControl(d),this.menu.addControl(y),this.menu.addControl(p),this.menu.addControl(g),this.setVisibility=function(e){this.menu.element.style.visibility=e},this.getVisibility=function(){return this.menu.element.style.visibility},this.update=function(){var e=this.viewer.getCameraStatus(),t=e.name;"orth"==t&&this.orthographic.setText(BimfaceLanguage.bf_viewHouse_perspective),"persp"==t&&this.orthographic.setText(BimfaceLanguage.bf_viewHouse_orthographic)},o.addEventListener("mousedown",function(e){l&&t.setVisibility("hidden")})};e.ViewHouseMenu=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){var i=e,n=t.create("div","bf-house");n.style.width=i.width+"px",n.style.height=i.height+"px",i.domElement.appendChild(n),this._domElement=n,this._opt=i,this.viewer=i.viewer,this.init()});i.prototype={init:function(){var e=this;this.viewHouseNavi=new Glodon.Bimface.Plugins.ViewHouseNavi(this._opt.viewer,this._domElement);var i=t.createNS("svg","bf-home-svg");i.setAttribute("viewBox","0 0 20 20");var n=t.createNS("g","");n.setAttribute("fill","none"),n.setAttribute("fill-rule","evenodd");var r=t.createNS("polygon","");r.setAttribute("fill","#E3E9EC"),r.setAttribute("points","1.207 9.5 3.5 9.5 3.5 16.499 7.501 16.499 7.503 12.5 12.5 12.5 12.5 16.499 16.5 16.499 16.5 9.5 18.793 9.5 10 .707"),i.addEventListener("mouseover",function(){r.setAttribute("fill","#BAFFEC"),a.setAttribute("fill","#32D3A6")}),i.addEventListener("mouseout",function(){r.setAttribute("fill","#E3E9EC"),a.setAttribute("fill","#BCC0C2")}),i.addEventListener("mousedown",function(){e.viewHouseMenu.switchHomeView()});var a=t.createNS("path","");a.setAttribute("fill","#BCC0C2"),a.setAttribute("d","M10,0 L0,10 L3,10 L3,17 L8,17 L8.003,13.001 L12,13.001 L12,17 L17,17 L17,10 L20,10 L10,0 Z M10,1.414 L17.586,9 L17,9 L16,9 L16,10 L16,16 L13,16 L13,13.001 L13,12 L12,12 L8.003,12 L7.004,12 L7.003,12.999 L7.001,16 L4,16 L4,10 L4,9 L3,9 L2.414,9 L10,1.414 Z"),n.appendChild(r),n.appendChild(a),i.appendChild(n),e._domElement.appendChild(i),this.homeSvg=i;var o=t.createNS("svg","bf-menu-svg");o.setAttribute("viewBox","0 0 20 20"),o.style.position="absolute";var s=t.createNS("g","");s.setAttribute("fill","none"),s.setAttribute("fill-rule","evenodd"),s.setAttribute("transform","translate(3 6)");var l=t.createNS("polygon","");l.setAttribute("fill","#E3E9EC"),l.setAttribute("points","1.207 4.5 6.999 10.292 12.793 4.5");var c=t.createNS("path","");c.setAttribute("fill","#BCC0C2"),c.setAttribute("d","M0.0004,3.9998 L6.9994,10.9998 L13.9994,3.9998 L0.0004,3.9998 Z M2.4144,4.9998 L11.5864,4.9998 L6.9994,9.5858 L2.4144,4.9998 Z");var u=t.createNS("polygon","");u.setAttribute("fill","#E3E9EC"),u.setAttribute("points",".5 2.5 13.5 2.5 13.5 .5 .5 .5");var h=t.createNS("path","");h.setAttribute("fill","#BCC0C2"),h.setAttribute("d","M0,3 L14,3 L14,0 L0,0 L0,3 Z M1,2 L13,2 L13,1 L1,1 L1,2 Z"),o.addEventListener("mouseover",function(){l.setAttribute("fill","#BAFFEC"),c.setAttribute("fill","#32D3A6"),u.setAttribute("fill","#BAFFEC"),h.setAttribute("fill","#32D3A6")}),o.addEventListener("mouseout",function(){l.setAttribute("fill","#E3E9EC"),c.setAttribute("fill","#BCC0C2"),u.setAttribute("fill","#E3E9EC"),h.setAttribute("fill","#BCC0C2")}),s.appendChild(l),s.appendChild(c),s.appendChild(u),s.appendChild(h),o.appendChild(s),e._domElement.appendChild(o),this.menuSvg=o;var d=new Glodon.Bimface.Application.UI.Menu.ViewHouseMenu(this._opt);this.viewHouseMenu=d,d.setVisibility("hidden"),o.addEventListener("click",function(t){var i=e.viewer.getDomElement(),n=i.getBoundingClientRect();if("hidden"==d.getVisibility()){var r={x:o.getBoundingClientRect().right-d.menu.element.clientWidth,y:o.getBoundingClientRect().bottom};r.x-=n.left,r.y-=n.top,d.menu.setPosition(r),d.update(),d.setVisibility("visible")}else d.setVisibility("hidden")})},enableViewHouse:function(e){this.viewHouseNavi.setVisible(e),!0===e?(this.homeSvg.style.display="block",this.menuSvg.style.display="block"):(this.homeSvg.style.display="none",this.menuSvg.style.display="none")},getDomElement:function(){return this._domElement}},e.ViewHouse=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=function(){return{background:null,domElement:null,viewer:null,style:{"stroke-width":3,"stroke-color":"#ff0000","stroke-opacity":1,"fill-color":"#ff0000","fill-opacity":0,"font-family":"Arial","font-size":16,"font-style":"italic","font-weight":"bold"}}};e.AnnotationConfig=t}(),function(){var e=Object.freeze({Arrow:"Arrow",Rectangle:"Rectangle",Circle:"Circle",Cross:"Cross",Cloud:"Cloud",Text:"Text"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins").AnnotationTypeOption=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){this._opt=e,this.init()});t.prototype={init:function(){var e,t=this,i=t._opt;if(i.viewer)e=new CLOUD.Extensions.AnnotationHelper3D(i.viewer.getViewer());else{if(!i.domElement)return alert("domElement must not be empty."),!1;e=new CLOUD.Extensions.AnnotationHelper2D,e.setDomContainer(i.domElement)}this._helper=e},begin:function(){var e=this._helper,t=this._opt;e.editAnnotationBegin(t.absBasePoint,t.screenBasePoint,t.zoomFactor)},end:function(){this._helper.editAnnotationEnd()},save:function(){return this._helper.getAnnotationInfoList()},load:function(e){var t=this._helper;this._opt;t.loadAnnotations(e)},createSnapshot:function(e,t){return this._helper.captureAnnotationsScreenSnapshot(e,t)},setType:function(e){var t={arrow:0,rectangle:1,circle:2,cross:3,cloud:4,text:5};this._helper.setAnnotationType(t[e.toLocaleLowerCase()])},setStyle:function(e){this._helper.setAnnotationStyle(e)},destroy:function(){this._helper.destroy()}},e.Annotation=t,e.Annotation.Annotation=e.Annotation,e.Annotation.AnnotationConfig=e.AnnotationConfig}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=function(){return{viewer:null,lineWidth:3,lineColor:new Glodon.Web.Graphics.Color(208,2,27,1),fillColor:new Glodon.Web.Graphics.Color(255,255,255,0),fontFamily:"Arial",fontSize:14}};e.AnnotationManagerConfig=t}(),function(){var e=Object.freeze({Arrow:"Arrow",Rectangle:"Rectangle",Circle:"Ellips",Ellips:"Ellips",Cross:"Cross",Cloud:"Cloud",CloudRect:"Cloud-rect",Text:"Text",Polyline:"Polyline"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation").AnnotationTypeOption=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){});t.prototype={init:function(){var e,t=this,i=t._opt;e=new CLOUD.Extensions.AnnotationHelper3D(i.viewer.getViewer(),i),this._helper=e},startDrawing:function(){var e=this._helper;this._opt;e.editAnnotationBegin(),this.isShowAnnotation=!0},getAnnotationList:function(){return this._helper.getAnnotationInfoList()},setAnnotationList:function(e){if(!e||0==e.length)return void this.clear();this._annotationList=e,this._helper.loadAnnotations(e),this.isShowAnnotation=!0},createSnapshot:function(e){var t=this;t._opt.viewer;t._helper.captureAnnotationsScreenSnapshot("",e)},setState:function(e){var t=this,i=t._opt.viewer;i.setState(e.state),i.render(),setTimeout(function(){t.setAnnotationList(e.annotationList)},1e3)},updateSvg:function(){var e=this,t=this._annotationList,i=e._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var n=0,r=t.length;n<r;n++)t[n].position=e.getSVGPosition(t[n],i),t[n].size.width=t[n].defaultSize.width*i,t[n].size.height=t[n].defaultSize.height*i;this.isShowAnnotation&&this.setAnnotationList(t)},getSVGPosition:function(e,t){var i=this._opt.viewer,n={x:i.screenWidth/2,y:i.screenHeight/2},r=i.worldToClient(e.worldPosition);return{x:r.x-n.x,y:n.y-r.y}},revoke:function(){}},e.AnnotationViewer3dManager=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){var t=Glodon.Bimface.Viewer.Viewer2DEvent,i=e.viewer,n=this;i.addEventListener(t.ViewMoving,function(e){n.updateSvg()}),i.addEventListener(t.ViewZooming,function(e){n.updateSvg()})});t.prototype={init:function(){var e,t=this,i=t._opt;e=new CLOUD.Extensions.AnnotationHelper2D(i),e.setDomContainer(i.viewer.getDomElement()),this._helper=e},startDrawing:function(){var e=this._helper,t=this._opt;e.editAnnotationBegin();t.viewer.getZoomScale();e.editor.svg.addEventListener("mousewheel",function(e){e.preventDefault(),e.stopPropagation()}),this.isShowAnnotation=!0},getAnnotationList:function(){var e=this,t=this._helper.getAnnotationInfoList();if(t&&t.length>0)for(var i=e._opt.viewer,n=i.getZoomScale(),r=0,a=t.length;r<a;r++)t[r].worldPosition=e.getWorldPosition(t[r]),t[r].defaultSize={width:t[r].size.width/n,height:t[r].size.height/n};return t},setAnnotationList:function(e){if(!e||0==e.length)return void this.clear();for(var t=this._opt.viewer.getZoomScale(),i=0,n=e.length;i<n;i++)e[i].position=this.getSVGPosition(e[i],t),e[i].size.width=e[i].defaultSize.width*t,e[i].size.height=e[i].defaultSize.height*t;this._annotationList=e,this._helper.loadAnnotations(e),this.isShowAnnotation=!0},createSnapshot:function(e){var t=this;t._opt.viewer.createSnapshotAsync("",function(i){t._helper.captureAnnotationsScreenSnapshot(i,e)})},setState:function(e){var t=this;t._opt.viewer.setState(e.state),t.setAnnotationList(e.annotationList)},updateSvg:function(){var e=this,t=this._annotationList,i=e._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var n=0,r=t.length;n<r;n++)t[n].position=e.getSVGPosition(t[n],i),t[n].size.width=t[n].defaultSize.width*i,t[n].size.height=t[n].defaultSize.height*i;this.isShowAnnotation&&this.setAnnotationList(t)},getSVGPosition:function(e,t){var i=this._opt.viewer,n={x:i.screenWidth/2,y:i.screenHeight/2},r=i.worldToClient(e.worldPosition);return{x:r.x-n.x,y:n.y-r.y}},revoke:function(){}},e.AnnotationViewer2dManager=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){this._viewer=e,this.drawingViewer=e.getViewer()});t.prototype={init:function(){var e,t=this,i=t._opt;e=this.drawingViewer.mouseEditorMgr,this.type="arrow",this.setLineWidth(i.lineWidth),this.setLineColor(i.lineColor),this.setFillColor(i.fillColor),this.setFontFamily(i.fontFamily),this.setFontSize(i.fontSize),this._helper=e},startDrawing:function(){var e,t=this._helper;this._opt;t.activeEditorByName("markup"),e=t.getEditor(),e.setMarkupType(this.type),this.annotationToolbar&&(this.setLineColor({red:208,green:2,blue:27,alpha:1}),this.setLineWidth(2)),this.editor=e,this.isShowAnnotation=!0},endDrawing:function(){this.drawingViewer.markupManager.setFillColor("transparent"),this.clear(),this._helper.activeEditorByName("pick"),this.drawingViewer.update(),this.isShowAnnotation=!1},getAnnotationList:function(){return this.drawingViewer.markupManager.markups},setAnnotationList:function(e){this.drawingViewer.markupManager.markups=e,this.drawingViewer.update()},clear:function(){this.drawingViewer.markupManager.clear(),this.drawingViewer.update()},createSnapshot:function(e){var t=this._viewer.getRootElement();e(this.drawingViewer.snapshot(t.style.background))},resize:function(){this._viewer.resize()},setAnnotationType:function(e){var t={arrow:"arrow",rectangle:"rectangle","cloud-rect":"cloud-rect",circle:"ellips",cross:"cross",cloud:"cloud",text:"text"};this.type=t[e.toLocaleLowerCase()],this.editor&&this.editor.setMarkupType(this.type)},setLineWidth:function(e){this.drawingViewer.markupManager.setLineWidth(e)},setLineColor:function(e){this.drawingViewer.markupManager.setColor("rgba("+e.red+","+e.green+","+e.blue+","+e.alpha+")")},setFillColor:function(e){this.drawingViewer.markupManager.setFillColor("rgba("+e.red+","+e.green+","+e.blue+","+e.alpha+")")},setFontFamily:function(e){this.drawingViewer.markupManager.setFontFamily(e)},setFontSize:function(e){this.drawingViewer.markupManager.setFontSize(e)},getCurrentState:function(){var e=this,t=e._opt.viewer,i=this.getAnnotationList();return{annotationList:this.stringifyAnnotationList(i),state:t.getCurrentState()}},stringifyAnnotationList:function(e){return this.drawingViewer.markupManager.toString(e)},jsonifyAnnotationList:function(e){return this.drawingViewer.markupManager.fromString(e)},setState:function(e){var t=this,i=t._opt.viewer;if("string"==typeof e.annotationList){var n=this.jsonifyAnnotationList(e.annotationList);this.setAnnotationList(n)}else this.setAnnotationList(e.annotationList);i.setState(e.state)},updateSvg:function(){var e=this,t=this._annotationList,i=e._opt.viewer.getZoomScale();if(!t||0==t.length)return!1;for(var n=0,r=t.length;n<r;n++)t[n].position=e.getSVGPosition(t[n],i),t[n].size.width=t[n].defaultSize.width*i,t[n].size.height=t[n].defaultSize.height*i;this.isShowAnnotation&&this.setAnnotationList(t)},getWorldPosition:function(e){var t=this._opt.viewer,i={x:t.screenWidth/2,y:t.screenHeight/2},n={x:i.x+e.position.x,y:i.y-e.position.y};return t.clientToWorld(n)},getSVGPosition:function(e,t){var i=this._opt.viewer,n={x:i.screenWidth/2,y:i.screenHeight/2},r=i.worldToClient(e.worldPosition);return{x:r.x-n.x,y:n.y-r.y}},revoke:function(){}},e.AnnotationDrawingManager=t}(),function(){var e="Bimface.Plugins.Annotation.AnnotationManager",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){var t=this,i=e.viewer;this._opt=e,this.isShowAnnotation=!1,this.historyQueue=[],Glodon.Bimface.Viewer.Viewer3D&&i instanceof Glodon.Bimface.Viewer.Viewer3D?this._helper=new MarkupViewer3D(i,i._opt.domElement):Glodon.Bimface.Viewer.Viewer2D&&i instanceof Glodon.Bimface.Viewer.Viewer2D?this._helper=new MarkupViewer2D(i,i._opt.domElement.querySelector(".bf-image")):this._helper=new MarkupDrawing(i,i._opt.domElement),this._helper.viewer.onSelectChange=function(e){t.onSelectChange(e)},this.init()});n.prototype={init:function(){var e=this,t=e._opt;t.lineWidth&&this.setLineWidth(t.lineWidth),t.lineColor&&this.setLineColor(t.lineColor),t.fillColor&&this.setFillColor(t.fillColor),t.fontFamily&&this.setFontFamily(t.fontFamily),t.fontSize&&this.setFontSize(t.fontSize)},exit:function(){this.endDrawing()},onSelectChange:function(e){},getAnnotationList:function(){return this._helper.getAnnotationList()},setAnnotationList:function(e){e.length>0&&e[0].id&&(e=this._helper.transform(e)),this._helper.setAnnotationList(e),this._helper.update()},setState:function(e){this._helper.setState(e)},createSnapshot:function(e){this._helper.createSnapshot(e)},startDrawing:function(){this._helper.startDrawing()},endDrawing:function(){t.send(e,"endDrawing"),this._helper.editAnnotationEnd(),this.isShowAnnotation=!1},clear:function(){t.send(e,"clear"),this._helper.clearAnnotations()},resize:function(){},setAnnotationType:function(i){t.send(e,"setAnnotationType"),this._helper.setAnnotationType(i.toLocaleLowerCase())},setLineWidth:function(i){t.send(e,"setLineWidth"),this._helper.setAnnotationStyle({"stroke-width":i})},setLineColor:function(i){t.send(e,"setLineColor"),this._helper.setAnnotationStyle({"stroke-color":""+i.getRGBA()})},setFillColor:function(i){t.send(e,"setFillColor"),this._helper.setAnnotationStyle({"fill-color":""+i.getRGBA()})},setFontFamily:function(i){t.send(e,"setFontFamily"),this._helper.setAnnotationStyle({"font-family":i})},setFontSize:function(i){t.send(e,"setFontSize"),this._helper.setAnnotationStyle({"font-size":i})},removeSelectedAnnotation:function(){this._helper.removeSelectedAnnotation()},showAnnotation:function(){this._helper.showAnnotation()},hideAnnotation:function(){this._helper.hideAnnotation()},setStyle:function(e){this._helper.setAnnotationStyle(e)},destroy:function(){this.endDrawing()},getCurrentState:function(){return this._helper.getCurrentState()},getWorldPosition:function(e){var t=this._opt.viewer,i={x:t.screenWidth/2,y:t.screenHeight/2},n={x:i.x+e.position.x,y:i.y-e.position.y};return t.clientToWorld(n)},inherit:function(e){for(var t in e)this[t]=e[t]},stringifyAnnotationList:function(e){return this._helper.markupManager.toString(e)},jsonifyAnnotationList:function(e){return this._helper.markupManager.fromString(e)}},i.AnnotationManager=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=function(){};e.AnnotationToolbarConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=Object.freeze({Saved:"Saved",Cancelled:"Cancelled"});e.AnnotationToolbarEvent=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Annotation"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),Glodon.Bimface.Plugins.Annotation.AnnotationToolbarEvent),n=function(e){var n=this._eventManager=new Glodon.Web.Lang.EventManager,r=[],a=e.viewer,o=Glodon.Bimface.Viewer.ViewerDrawing&&a instanceof Glodon.Bimface.Viewer.ViewerDrawing;this.isDrawing=o;var s=t.create("div","bf-annotation bf-hide");this.domElement=s;var l=Glodon.Bimface.Plugins.Annotation.AnnotationTypeOption,c=new Glodon.Bimface.Plugins.Annotation.AnnotationManagerConfig,u=c.lineColor;c.viewer=a,c.annotationCallback=e.annotationCallback;var h=new Glodon.Bimface.UI.Toolbar.ToolbarConfig;h.element=s,h.className="bf-toolbar bf-toolbar-annotation";var d=this.annotationToolbar=new Glodon.Bimface.UI.Toolbar.Toolbar(h);this.annotationToolbar=d,r.push(d),o&&(c.annotationToolbar=d);var f=this._annotationManager=new Glodon.Bimface.Plugins.Annotation.AnnotationManager(c);a.getDomElement().appendChild(s),s.addEventListener("mousedown",function(e){e.stopPropagation()}),s.addEventListener("touchstart",function(e){e.stopPropagation()}),s.addEventListener("touchmove",function(e){e.stopPropagation()});var p=new Glodon.Bimface.UI.Toolbar.ToolbarConfig;p.element=s,p.className="bf-toolbar bf-toolbar-control";var m=new Glodon.Bimface.UI.Toolbar.Toolbar(p);r.push(m);var g=new Glodon.Bimface.UI.Button.ButtonConfig;g.className="bf-button gld-bf-narrow ",g.title="ç®­å¤´",o&&(g.id="arrow"),g.groupName="Annotation";var v=new Glodon.Bimface.UI.Button.SingleButton(g);v.addEventListener("Click",function(){f.setAnnotationType(l.Arrow),X.show(),te.hide()}),d.addControl(v);var y=new Glodon.Bimface.UI.Button.ButtonConfig;y.className="bf-button gld-bf-n-cloud",y.title="äº‘çº¿æ¡†",y.groupName="Annotation";var E=new Glodon.Bimface.UI.Button.SingleButton(y);E.addEventListener("Click",function(){f.setAnnotationType(l.CloudRect),X.show(),te.hide()}),d.addControl(E);var x=new Glodon.Bimface.UI.Button.ButtonConfig;x.className="bf-button gld-bf-ncloud",x.title="äº‘çº¿",x.groupName="Annotation";var b=new Glodon.Bimface.UI.Button.SingleButton(x);b.addEventListener("Click",function(){f.setAnnotationType(l.Cloud),X.show(),te.hide()}),d.addControl(b);var C=new Glodon.Bimface.UI.Button.ButtonConfig;C.className="bf-button gld-bf-n-ployline",C.title="æŠ˜çº¿",C.groupName="Annotation";var M=new Glodon.Bimface.UI.Button.SingleButton(C);M.addEventListener("Click",function(){f.setAnnotationType(l.Polyline),X.show(),te.hide()}),d.addControl(M);var _=new Glodon.Bimface.UI.Button.ButtonConfig;_.className="bf-button gld-bf-nrectangle",_.title="çŸ©å½¢",_.groupName="Annotation";var w=new Glodon.Bimface.UI.Button.SingleButton(_);w.addEventListener("Click",function(){f.setAnnotationType(l.Rectangle),X.show(),te.hide()}),d.addControl(w);var L=new Glodon.Bimface.UI.Button.ButtonConfig;L.className="bf-button gld-bf-noval",L.title="æ¤­åœ†",L.groupName="Annotation";var T=new Glodon.Bimface.UI.Button.SingleButton(L);T.addEventListener("Click",function(){f.setAnnotationType(l.Ellips),X.show(),te.hide()}),d.addControl(T);var I=new Glodon.Bimface.UI.Button.ButtonConfig;I.className="bf-button gld-bf-mark",I.title="X",I.groupName="Annotation";var S=new Glodon.Bimface.UI.Button.SingleButton(I);S.addEventListener("Click",function(){f.setAnnotationType(l.Cross),X.show(),te.hide()}),d.addControl(S);var O=new Glodon.Bimface.UI.Button.ButtonConfig;O.className="bf-button gld-bf-ntext",O.title="æ–‡å­—",O.groupName="Annotation";var D=new Glodon.Bimface.UI.Button.SingleButton(O);D.addEventListener("Click",function(){f.setAnnotationType(l.Text),X.hide(),te.show()}),d.addControl(D);var R=new Glodon.Bimface.UI.Button.ButtonConfig;R.className="bf-combobox bf-color",R.title="é¢œè‰²",o&&(R.id="color");var A=new Glodon.Bimface.UI.Button.ComboBox(R),U=new Glodon.Bimface.UI.Button.ButtonConfig;U.className="bf-button bf-color",U.title="çº¢",o&&(U.id="red");var B=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(U);B.color=new Glodon.Web.Graphics.Color(208,2,27,1);var P=t.create("div","bf-color-button");P.setCss({backgroundColor:"#"+B.color.getHEX()}),B.setHtml(P.outerHTML),A.addControl(B);var N=new Glodon.Bimface.UI.Button.ButtonConfig;N.className="bf-button bf-color",N.title="é»„";var k=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(N);k.color=new Glodon.Web.Graphics.Color(245,166,35,1);var F=t.create("div","bf-color-button");F.setCss({backgroundColor:"#"+k.color.getHEX()}),k.setHtml(F.outerHTML),A.addControl(k);var H=new Glodon.Bimface.UI.Button.ButtonConfig;H.className="bf-button bf-color",H.title="è“";var G=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(H);G.color=new Glodon.Web.Graphics.Color(74,144,226,1);var V=t.create("div","bf-color-button");V.setCss({backgroundColor:"#"+G.color.getHEX()}),G.setHtml(V.outerHTML),A.addControl(G);var z=new Glodon.Bimface.UI.Button.ButtonConfig;z.className="bf-button bf-color",z.title="ç»¿";var W=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(z);W.color=new Glodon.Web.Graphics.Color(126,211,33,1);var q=t.create("div","bf-color-button");q.setCss({backgroundColor:"#"+W.color.getHEX()}),W.setHtml(q.outerHTML),A.addControl(W),d.addControl(A);var j=new Glodon.Bimface.UI.Button.ButtonConfig;j.className="bf-combobox",j.title="ç²—ç»†",o&&(j.id="line");var X=new Glodon.Bimface.UI.Button.ComboBox(j),j=new Glodon.Bimface.UI.Button.ButtonConfig;j.className="bf-button bf-line",j.title="ç»†",o&&(j.id="fine");var Y=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(j);Y.lineWidth=3;var Z=t.create("div","bf-line-button");Z.setCss({height:Y.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-Y.lineWidth)/2+"px 4px"}),Y.element.appendChild(Z),X.addControl(Y),j.title="ä¸­";var K=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(j);K.lineWidth=6;var Q=t.create("div","bf-line-button");Q.setCss({height:K.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-K.lineWidth)/2+"px 4px"}),K.element.appendChild(Q),X.addControl(K),j.title="ç²—"
;var J=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(j);J.lineWidth=10;var $=t.create("div","bf-line-button");$.setCss({height:J.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-J.lineWidth)/2+"px 4px"}),J.element.appendChild($),X.addControl(J),A.addEventListener("Change",function(e){f.setLineColor(e.color),u=e.color;u.getHEX();Z.setCss({height:Y.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-Y.lineWidth)/2+"px 4px"}),Q.setCss({height:K.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-K.lineWidth)/2+"px 4px"}),$.setCss({height:J.lineWidth+"px",backgroundColor:"#"+u.getHEX(),margin:(32-J.lineWidth)/2+"px 4px"});var t=X.getCurrentControl();X.setSelectedControlById(t.getId())}),X.addEventListener("Change",function(e){f.setLineWidth(e.lineWidth)}),d.addControl(X);var ee=new Glodon.Bimface.UI.Button.ButtonConfig;ee.className="bf-combobox bf-font-button",ee.title="å­—å·";var te=new Glodon.Bimface.UI.Button.ComboBox(ee),ie=new Glodon.Bimface.UI.Button.ButtonConfig;ie.className="bf-button bf-size",ie.title="14";var ne=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(ie);ne.fontSize=14,ne.setHtml("14"),te.addControl(ne),ie.title="18";var re=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(ie);re.fontSize=18,re.setHtml("18"),te.addControl(re),ie.title="24";var ae=new Glodon.Bimface.UI.Button.ComboBoxOptionButton(ie);ae.fontSize=24,ae.setHtml("24"),te.addControl(ae),te.addEventListener("Change",function(e){f.setFontSize(e.fontSize)}),te.hide(),d.addControl(te);var oe=new Glodon.Bimface.UI.Button.ButtonConfig;oe.className="bf-save",oe.title="ä¿å­˜";var se=new Glodon.Bimface.UI.Button.SingleButton(oe);se.setHtml("ä¿å­˜"),se.addEventListener("Click",function(){o?n.fireEvent(i.Saved,{annotationList:f.getAnnotationList()}):n.fireEvent(i.Saved,{annotationList:f.getAnnotationList(),state:f.getCurrentState()}),f.endDrawing(),s.addClass("bf-hide")}),m.addControl(se);var le=new Glodon.Bimface.UI.Button.ButtonConfig;le.className="bf-cancel",le.title="å–æ¶ˆ";var ce=new Glodon.Bimface.UI.Button.SingleButton(le);ce.setHtml("å–æ¶ˆ"),ce.addEventListener("Click",function(){f.endDrawing(),n.fireEvent(i.Cancelled),s.addClass("bf-hide")}),m.addControl(ce),this.getEventManager=function(){return n}};n.prototype={getEventManager:function(){return this._eventManager},addEventListener:function(e,t){this.getEventManager().addEvent(e,t)},removeEventListener:function(e,t){this.getEventManager().removeEvent(e,t)},show:function(e,t){this.isDrawing||this._annotationManager.clear(),this._annotationManager.startDrawing(),this.domElement.removeClass("bf-hide")},getAnnotationManager:function(){return this._annotationManager},exit:function(){this.annotationToolbar.hide(),this.getAnnotationManager().exit()}},e.AnnotationToolbar=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=function(){return{viewer:null}};e.TagConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(e){var t=this,i=this._viewer=e.viewer.getViewer();if(this._opt=e,this._renderCallback=function(){t.resize()},e.minimap){this.mapHelper=e.minimap;var n=new CLOUD.View2dAdapter(this.mapHelper,i);this.mapHelper.setMinimapResizeCallback(function(e){t._tagHelper.updateGroupName(),t._tagHelper.updateDomContainer(),t._tagHelper.resize(e),t._tagHelper.updateByGroup()}),this.mapHelper.setPlaneChangedCallback(function(){t._tagHelper.updateGroupName(),t._tagHelper.updateByGroup()})}else{var n=new CLOUD.View3dAdapter(i);i.addCallbacks("render",this._renderCallback)}this._tagHelper=new CLOUD.Extensions.MarkerEditor(n),this._tagHelper.disableInteractions(!0),this.init()});t.prototype={init:function(){this._tagHelper.isInitialized()||this._tagHelper.init()},addTag:function(e,t){if(!e)return!1;var i=!1,n=this.getTags();e.userId=e.objectId,e.worldBoundingBox=e.boundingBox,e.worldPosition||(e.worldPosition={x:(e.worldBoundingBox.min.x+e.worldBoundingBox.max.x)/2,y:(e.worldBoundingBox.min.y+e.worldBoundingBox.max.y)/2,z:(e.worldBoundingBox.min.z+e.worldBoundingBox.max.z)/2});for(var r=0,a=n.length;r<a;r++){if(n[r].userId==e.userId)return i=!0,!1}e.floorList?this._tagHelper.setMarkerGroups(e.floorList):this._tagHelper.setMarkerGroups([]),this._tagHelper.updateGroupName(),i||this._tagHelper.createMarkerByIntersect(e,t.shape,t.image,t.size)},deleteTag:function(e,t){var i=this;if(t)return this._tagHelper.removeMarkerInGroup(e,t),!1;for(var n=this.getTags(),r=0,a=n.length;r<a;r++){var o=n[r];if(o.userId==e)return i._tagHelper.deleteMarker(o),!1}},destroy:function(){this._viewer.removeCallbacks("render",this._renderCallback),this._tagHelper.markerClickCallback=null,this.unLoadTags(),this._tagHelper.clearMarkers(),this._tagHelper=null},loadTags:function(e){this._tagHelper.loadMarkers(e)},unLoadTags:function(){this._tagHelper.unloadMarkers()},getTags:function(){return this._tagHelper.getMarkerInfoList()},getTagById:function(e){return this._tagHelper.getMarker(e)},zoomToSelectedTag:function(){this._tagHelper.zoomToSelectedMarkers()},resize:function(){this._tagHelper.onResize()},onSelected:function(e){this._tagHelper.setMarkerClickCallback(e)}},e.Tag=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=function(){return{viewer:null,maxNum:20,affectedBySection:!0}};e.DrawableContainerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=function(){return{id:null,tooltip:"",tooltipStyle:{},draggable:!1,worldPosition:new Glodon.Web.Geometry.Point3d(0,0,0),angle:0}};e.DrawableItemConfig=t}(),function(){var e="Bimface.Plugins.Drawable.DrawableItem",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Common.MouseButton,function(e){this.id=e.id||Glodon.Web.Lang.Utility.UUID.createUUID(),e.worldPosition?this.worldPosition=e.worldPosition:console.log("worldPosition must not be empty."),void 0!=e.viewerDrawingId&&(this.viewerDrawingId=e.viewerDrawingId),this.angle=e.angle});n.prototype={draw:function(e){},onClick:function(i){t.send(e,"onClick"),this._onclick=i},onRightClick:function(i){t.send(e,"onRightClick"),this._onrightclick=i},onEndDrag:function(i){t.send(e,"onEndDrag"),this._onenddrag=i},setTooltip:function(i){t.send(e,"setTooltip"),this.tipElement.querySelector("span").innerText=i},setTooltipStyle:function(i){t.send(e,"setTooltipStyle");for(var n in i)this.tipElement.style[n]=i[n]},getTooltip:function(){return this.tipElement.querySelector("span").innerText},getTooltipStyle:function(){return this.tipElement.style},getWorldPosition:function(){return this.worldPosition},setWorldPosition:function(i){t.send(e,"setWorldPosition"),this.worldPosition=i},hide:function(){t.send(e,"hide"),this._domElement.style.display="none"},show:function(){t.send(e,"show"),this._domElement.style.display=""}},i.DrawableItem=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=function(){this.rootDomElement=t.create("div","bf-drawable-context"),this.clientPosition=null};i.prototype.destroy=function(){this.rootDomElement.parentElement&&this.rootDomElement.parentElement.removeChild(this.rootDomElement)},e.DrawableContext=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=new Glodon.Bimface.Plugins.Drawable.DrawableItemConfig,i=function(){var e={width:32,height:32,opacity:.75,src:null,offsetX:0,offsetY:0};return Object.assign({},t,e)};e.ImageConfig=i}(),function(){var e="Bimface.Plugins.Drawable.Image",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=Glodon.Bimface.Plugins.Drawable.DrawableItem,r=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),a=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),o=function(e){n.call(this,e);var t=this,i=!1,a=r.create("img","bf-drawable-image");a.draggable=!1,a.src=e.src,a.style.width=e.width+"px",a.style.height=e.height+"px",a.style.opacity=""+e.opacity,a.style.transform="rotate("+e.angle+"deg)",this._config=e,this._domElement=a,this.clientPosition={};var o,s=function(e){var n,r=t.viewer,a=r instanceof Glodon.Bimface.Viewer.Viewer3D,s={x:e.x-o.x+t.clientPosition.x,y:e.y-o.y+t.clientPosition.y};if(a){n=r.pickByPoint(s).worldPosition}else n=r.clientToWorld(s);n?(t.worldPosition=n,t.update(),t._onenddrag&&t._onenddrag(t),i=!1):t.update()},l=function(e){o=e,i=!0};e.draggable&&r.drag({element:a,cursor:"pointer",end:s,start:l}),a.addEventListener("mouseup",function(e){var n=e||window.event;"0"==n.button&&t._onclick&&(!i||o.x==n.clientX&&o.y==n.clientY)&&t._onclick(t)}),a.addEventListener("mousedown",function(e){var i=e||window.event;i.stopPropagation(),"2"==i.button&&t._onrightclick?t._onrightclick(t):"1"==i.button&&t._onmiddleclick&&t._onmiddleclick(t)})};a.Type.inheritPrototype(o,n);var s={draw:function(e){var t=this._domElement,i=this._config;this.clientPosition=e.clientPosition,t.style.left=e.clientPosition.x+i.offsetX-i.width/2+"px",t.style.top=e.clientPosition.y+i.offsetY-i.height/2+"px",e.rootDomElement.appendChild(t)},getWidth:function(){return this._config.width},setWidth:function(i){t.send(e,"setWidth");var n=this._config.width,r=this._domElement,a=(n-i)/2,o=parseInt(r.style.left);this._config.width=i,r.style.width=i+"px",r.style.left=o+a+"px"},getHeight:function(){return this._config.height},setHeight:function(i){t.send(e,"setHeight");var n=this._config.height,r=this._domElement,a=(n-i)/2,o=parseInt(r.style.top);this._config.height=i,r.style.height=i+"px",r.style.top=o+a+"px"},getOpacity:function(){return this._config.opacity},setOpacity:function(i){t.send(e,"setOpacity"),this._config.opacity=i,this._domElement.style.opacity=i},getSrc:function(){return this._config.src},setSrc:function(i){t.send(e,"setSrc"),this._config.src=i,this._domElement.src=i},getOffsetX:function(){return this._config.offsetX},setOffsetX:function(i){t.send(e,"setOffsetX");var n=this._config.offsetX,r=this._domElement,a=i-n,o=parseInt(r.style.left);this._config.offsetX=i,r.style.left=o+a+"px"},getOffsetY:function(){return this._config.offsetY},setOffsetY:function(i){t.send(e,"setOffsetY");var n=this._config.offsetY,r=this._domElement,a=i-n,o=parseInt(r.style.top);this._config.offsetY=i,r.style.top=o+a+"px"},getAngle:function(){return this.angle},setAngle:function(i){t.send(e,"setAngle"),this.angle=i,this._domElement.style.transform="rotate("+i+"deg)"}};!function(e,t){var i=t.prototype;for(var n in e)i[n]=e[n]}(s,o),i.Image=o}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=new Glodon.Bimface.Plugins.Drawable.DrawableItemConfig,i=function(){var e={width:0,height:0,opacity:.75,content:"",offsetX:0,offsetY:0,viewer:null};return Object.assign({},t,e)};e.CustomItemConfig=i}(),function(){var e="Bimface.Plugins.Drawable.CustomItem",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins"),r=Glodon.Bimface.Plugins.Drawable.DrawableItem,a=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),o=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility");n.IE11Store={};var s=function(e){r.call(this,e);var t=!1,i=this,n=Glodon.Bimface.Viewer.ViewerDrawing&&e.viewer instanceof Glodon.Bimface.Viewer.ViewerDrawing,o=a.create("div","bf-drawable-text");o.style.width=e.width+"px",o.style.height=e.height+"px";var s=a.create("div","bf-drawable-contentwrap");o.appendChild(s),this._domElement=o,this.name="customItem",this._contentElement=s,this._config=e;var l;this.clientPosition={},this.setContent(e.content);var c=a.create("div","bf-tooltip");c.style.display="none",c.innerHTML='<div class="bf-tooltip-content"><div class="bf-tooltip-arrow"></div><div class="bf-tooltip-inner"><span>'+e.tooltip+"</span></div></div>",c.style.left=e.width+"px",c.style.top="-"+e.height+"px";var u=e.tipCSS;for(var h in u)c.style[h]=u[h];this.tipElement=c,o.appendChild(c);var d=function(e){var r,a=i.viewer,o=Glodon.Bimface.Viewer.Viewer3D&&a instanceof Glodon.Bimface.Viewer.Viewer3D,s=a.getDomElement().getBoundingClientRect(),c={x:e.x-l.x+i.clientPosition.x+s.left,y:e.y-l.y+i.clientPosition.y+s.top};if(o){var u=a.pickByPoint(c);r=u.worldPosition}else if(n){var u=a.getViewer().toWorldPoint([c.x,c.y]);r={x:u[0],y:u[1]}}else r=a.clientToWorld(c);r?(i.worldPosition=r,i.update(),i._onenddrag&&i._onenddrag(i),t=!1):i.update()},f=function(e){l=e,t=!0};e.draggable&&a.drag({element:o,cursor:"pointer",end:d,start:f}),o.style.width=e.width+"px",o.style.height=e.height+"px",o.style.opacity=""+e.opacity,o.addEventListener("mouseover",function(e){i.tipElement&&i.tipElement.querySelector("span").innerText.length>0&&(i.tipElement.style.display="block")}),o.addEventListener("mouseout",function(e){i.tipElement&&(i.tipElement.style.display="none")}),o.addEventListener("keydown",function(e){e.stopPropagation()}),o.addEventListener("mouseup",function(e){var n=e||window.event;"0"==n.button&&i._onclick&&(!t||l.x==n.clientX&&l.y==n.clientY)&&i._onclick(i)}),o.addEventListener("mousedown",function(e){var t=e||window.event;t.stopPropagation(),"2"==t.button&&i._onrightclick?i._onrightclick(i):"1"==t.button&&i._onmiddleclick&&i._onmiddleclick(i)}),o.addEventListener("touchstart",function(e){(e||window.event).stopPropagation()}),o.addEventListener("touchmove",function(e){(e||window.event).stopPropagation()}),o.addEventListener("touchend",function(e){var n=e||window.event;n.stopPropagation(),i._onclick&&(!t||l.x==n.clientX&&l.y==n.clientY)&&i._onclick(i)})};o.Type.inheritPrototype(s,r);var l={draw:function(e){var t=this._domElement,i=this._config;this.clientPosition=e.clientPosition,t.style.left=e.clientPosition.x+i.offsetX-i.width/2+"px",t.style.top=e.clientPosition.y+i.offsetY-i.height/2+"px",""==t.innerHTML&&(this.dom&&this.domId?t.appendChild(n.IE11Store[this.domId].cloneNode(!0)):this.text&&(t.innerText=this.text)),e.rootDomElement.contains?e.rootDomElement.contains(t)||e.rootDomElement.appendChild(t):e.rootDomElement.appendChild(t)},getWidth:function(){return this._config.width},setWidth:function(i){t.send(e,"setWidth");var n=this._config.width,r=this._domElement,a=(n-i)/2,o=parseInt(r.style.left);this._config.width=i,r.style.width=i+"px",r.style.left=o+a+"px"},getHeight:function(){return this._config.height},setHeight:function(i){t.send(e,"setHeight");var n=this._config.height,r=this._domElement,a=(n-i)/2,o=parseInt(r.style.top);this._config.height=i,r.style.height=i+"px",r.style.top=o+a+"px"},getOpacity:function(){return this._config.opacity},setOpacity:function(i){t.send(e,"setOpacity"),this._config.opacity=i,this._domElement.style.opacity=i},getContent:function(){return this._config.content||this.text},setContent:function(i){t.send(e,"setContent"),this._contentElement.innerHTML="",i instanceof HTMLElement?(i.draggable=!1,this._config.content=i,this._domElement.content=i,this.dom=i,this.domId||(this.domId=Glodon.Web.Lang.Utility.UUID.createUUID()),n.IE11Store[this.domId]=i.cloneNode(!0),this._contentElement.appendChild(i)):(this._contentElement.innerHTML=i,this.text=i,this._config.content="")},getOffsetX:function(){return this._config.offsetX},setOffsetX:function(i){t.send(e,"setOffsetX");var n=this._config.offsetX,r=this._domElement,a=i-n,o=parseInt(r.style.left);this._config.offsetX=i,r.style.left=o+a+"px"},getOffsetY:function(){return this._config.offsetY},setOffsetY:function(i){t.send(e,"setOffsetY");var n=this._config.offsetY,r=this._domElement,a=i-n,o=parseInt(r.style.top);this._config.offsetY=i,r.style.top=o+a+"px"}};!function(e,t){var i=t.prototype;for(var n in e)i[n]=e[n]}(l,s),i.CustomItem=s}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=new Glodon.Bimface.Plugins.Drawable.DrawableItemConfig,i=function(){var e,i={text:null,viewer:null,objectId:null,containerCss:(e={boxSizing:"border-box",fontSize:"12px",lineHeight:1.5,borderWidth:"2px",borderStyle:"solid",padding:"5px",borderColor:"#1f93ff",backgroundColor:"#eeeeee"},_defineProperty(e,"padding","2px 8px"),_defineProperty(e,"opacity",.9),e),lineCss:{width:"1px",color:"#1f93ff"},pointCss:{radius:4,backgroundColor:"#1f93ff",borderColor:"#ffffff",borderStyle:"solid",borderWidth:"1px"},offset:{x:27,y:-47},height:26,width:140};return Object.assign({},t,i)};e.LeadLabelConfig=i}(),function(){var e="Bimface.Plugins.Drawable.LeadLabel",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=Glodon.Bimface.Plugins.Drawable.DrawableItem,r=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),a=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),o=function(e){n.call(this,e);var t=this,i=r.create("div","bf-drawable-lead-label"),a=r.create("div","bf-drawable-lead-label-textarea");i.appendChild(a);var o=r.createNS("line","bf-drawable-lead-line"),s=r.createNS("line","bf-drawable-lead-line"),l=r.createNS("circle","bf-drawable-lead-point"),c=r.createNS("g","bf-drawable-group"),u=e.viewer;t._text=e.text,i.setCss(e.containerCss),a.innerText=t._text.replace(/\n/g," "),i.style.width=parseFloat(e.width)+"px",i.style.height=parseFloat(e.height)+"px";var h=Math.trunc((e.height-8)/18);a.style.webkitLineClamp=h||1,s.setAttribute("stroke-width",e.lineCss.width),s.style.stroke=e.lineCss.color,o.setAttribute("stroke-width",e.lineCss.width),o.style.stroke=e.lineCss.color,l.setAttribute("r",e.pointCss.radius),l.style.fill=e.pointCss.backgroundColor,l.setAttribute("stroke-width",e.pointCss.borderWidth),l.style.stroke=e.pointCss.borderColor,s.setAttribute("x1",0),s.setAttribute("y1",0-e.offset.y+18),s.setAttribute("x2",e.offset.x),s.setAttribute("y2",18),o.setAttribute("x1",e.offset.x),o.setAttribute("y1",18),o.setAttribute("x2",e.offset.x+23),o.setAttribute("y2",18),l.setAttribute("cx",0),l.setAttribute("cy",18-e.offset.y);var d,f=function(e){d=e},p=function(i){var n={x:i.x-d.x+t.clientPosition.x,y:i.y-d.y+t.clientPosition.y};c.setAttribute("transform","translate("+n.x+","+(n.y+e.offset.y-18)+")")},m=function(e){var i=u instanceof Glodon.Bimface.Viewer.Viewer3D,n=u.getDomElement().getBoundingClientRect(),r={x:e.x-d.x+t.clientPosition.x+n.left,y:e.y-d.y+t.clientPosition.y+n.top};if(i){var a=u.pickByPoint(r);a&&(t.setWorldPosition(a.worldPosition),t.associateComponentById(a.objectId)),u.render()}else{var o=u.clientToWorld(r);o&&t.setWorldPosition(o),u.update()}t._dragEnd&&t._dragEnd()};e.draggable&&r.drag({element:i,cursor:"pointer",start:f,move:p,end:m}),i.addEventListener("mousedown",function(e){var e=e||event;e.stopPropagation()}),i.addEventListener("click",function(e){t._click&&t._click(t)}),i.addEventListener("contextmenu",function(e){t._rightClick&&t._rightClick(t)}),i.addEventListener("dblclick",function(e){t._doubleClick&&t._doubleClick(t)}),i.addEventListener("mouseenter",function(e){a.innerText=t._text;var n=i.offsetHeight;i.addClass("bf-drawable-show"),a.addClass("bf-drawable-show"),n>i.offsetHeight&&(i.removeClass("bf-drawable-show"),a.removeClass("bf-drawable-show"))}),i.addEventListener("mouseleave",function(e){a.innerText=t._text.replace(/\n/g," "),i.removeClass("bf-drawable-show"),a.removeClass("bf-drawable-show")}),c.appendChild(s),c.appendChild(o),c.appendChild(l),t._objectId=e.objectId,t._container=i,t._domTextArea=a,t._svgGroup=c,t._config=e,t._offset=e.offset};a.Type.inheritPrototype(o,n),o.prototype=Object.assign({},n.prototype,{draw:function(e,t){var i=this._container,n=this._svgGroup,a=this._offset,o=this._config.viewer,s=this._objectId;if(o&&s){var l=o.getComponentStatus(s);if("hidden"==l||"translucent"==l)return}this.clientPosition=e.clientPosition,i.style.left=e.clientPosition.x+a.x+23+"px",i.style.top=e.clientPosition.y+a.y-18+"px",n.setAttribute("transform","translate("+e.clientPosition.x+","+(e.clientPosition.y+a.y-18)+")"),e.domContainer||(e.domContainer=r.create("div","bf-drawable-container"),e.rootDomElement.appendChild(e.domContainer)),e.svgContainer||(e.svgContainer=r.createNS("svg","bf-drawable-svg"),e.rootDomElement.appendChild(e.svgContainer)),this.isShow("default"==t),e.domContainer.appendChild(i),e.svgContainer.appendChild(n)},hide:function(){t.send(e,"hide"),this._container.style.display="none",this._svgGroup.style.display="none"},show:function(){t.send(e,"show"),this._container.style.display="",this._svgGroup.style.display=""},onClick:function(i){t.send(e,"onClick"),i&&(this._click=i)},onRightClick:function(i){t.send(e,"onRightClick"),i&&(this._rightClick=i)},onDoubleClick:function(e){e&&(this._doubleClick=e)},onEndDrag:function(i){t.send(e,"onEndDrag"),i&&(this._dragEnd=i)},getText:function(){return this._text},setText:function(i){t.send(e,"setText"),this._domTextArea.innerText=i,this._text=i},getOpacity:function(){return this._container.style.opacity},setOpacity:function(i){t.send(e,"setOpacity"),this._container.style.opacity=i},getHeight:function(){return parseFloat(this._container.style.height)},setHeight:function(i){t.send(e,"setHeight"),this._container.style.height=parseFloat(i)+"px";var n=Math.trunc((i-8)/18);this._domTextArea.style.webkitLineClamp=n||1},getWidth:function(){return parseFloat(this._container.style.width)},setWidth:function(i){t.send(e,"setWidth"),this._container.style.width=parseFloat(i)+"px"},getObjectId:function(e){return this._objectId},associateComponentById:function(e){this._objectId=e},clearAssociation:function(){this._objectId=null},isShow:function(e){var t=this._container,i=this._svgGroup;e?(t.removeClass("bf-drawable-mini"),i.removeClass("bf-drawable-mini-svg")):(t.addClass("bf-drawable-mini"),i.addClass("bf-drawable-mini-svg"))}}),i.LeadLabel=o}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),t=new Glodon.Bimface.Plugins.Drawable.DrawableItemConfig,i=function(){var e={minimap:null,floorList:[],height:20,width:20,objectId:"",src:"",worldPosition:null,viewer:null};return Object.assign({},t,e)};e.MiniTagConfig=i}(),function(){var e="Bimface.Plugins.Drawable.MiniTag",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=Glodon.Bimface.Plugins.Drawable.DrawableItem,r=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility")),a=function e(t){n.call(this,t);var i=this,r=this._viewer=t.viewer.getViewer();if(this.miniTagConfig=t,this._config=t,i.worldPosition=t.worldPosition.clone(),this._renderCallback=function(){i.resize()},t.minimap){this.mapHelper=t.minimap;var a=new CLOUD.View2dAdapter(this.mapHelper,r);this.mapHelper.setMinimapResizeCallback(function(t){e._tagHelper.updateGroupName(),e._tagHelper.updateDomContainer(),e._tagHelper.resize(t),e._tagHelper.updateByGroup()}),this.mapHelper.setPlaneChangedCallback(function(){e._tagHelper.updateGroupName(),e._tagHelper.updateByGroup()})}else{var a=new CLOUD.View3dAdapter(r);r.addCallbacks("render",this._renderCallback)}void 0==e._tagHelper&&(e._tagHelper=new CLOUD.Extensions.MarkerEditor(a),e._tagHelper.disableInteractions(!0)),o()},o=function(){a._tagHelper.isInitialized()||a._tagHelper.init()},s=function(e,t){if(!e)return!1;var i=!1,n=a._tagHelper.getMarkerInfoList();e.userId=e.objectId;for(var r=0,o=n.length;r<o;r++){if(n[r].id==e.id)return i=!0,!1}e.floorList?a._tagHelper.setMarkerGroups(e.floorList):a._tagHelper.setMarkerGroups([]),a._tagHelper.updateGroupName(),i||a._tagHelper.createMarkerByIntersect(e,t.shape,t.image,t.size)},l=function(e){for(var t=a._tagHelper.getMarkerInfoList(),i=0,n=t.length;i<n;i++){var r=t[i];r.id==e&&a._tagHelper.deleteMarker(r)}};a.clear=function(){a._tagHelper&&a._tagHelper.clearMarkers()},r.Type.inheritPrototype(a,n),a.prototype=Object.assign({},n.prototype,{draw:function(){var e=this.miniTagConfig,t={id:this.id,objectId:e.objectId,worldPosition:e.worldPosition,floorList:e.floorList},i={shape:2,image:e.src,size:{width:e.width,height:e.height}};s(t,i)},show:function(){t.send(e,"show"),a._tagHelper.setVisible(this.id,!0)},hide:function(){t.send(e,"hide"),a._tagHelper.setVisible(this.id,!1)},getFloorList:function(){return this.miniTagConfig.floorList},setFloorList:function(i){t.send(e,"setFloorList"),this.miniTagConfig.floorList=i,l(this.id),this.draw()},getHeight:function(){return this.miniTagConfig.height},setHeight:function(i){t.send(e,"setHeight"),this.miniTagConfig.height=i,l(this.id),this.draw()},getId:function(){return this.id},getObjectId:function(){return this.miniTagConfig.objectId},setObjectId:function(i){t.send(e,"setObjectId");var n=this.miniTagConfig;l(this.id),n.objectId=i,this.draw()},getSrc:function(){return this.miniTagConfig.src},setSrc:function(i){t.send(e,"setSrc"),this.miniTagConfig.src=i,l(this.id),this.draw()},getWidth:function(){return this.miniTagConfig.width},setWidth:function(i){t.send(e,"setWidth"),this.miniTagConfig.width=i,l(this.id),this.draw()},getWorldPosition:function(){return this.miniTagConfig.worldPosition},setWorldPosition:function(i){t.send(e,"setWorldPosition"),this.miniTagConfig.worldPosition=i,l(this.id),this.draw()},onClick:function(i){t.send(e,"onClick"),a._tagHelper.setMarkerClickCallback(i)},onRightClick:function(i){t.send(e,"onRightClick")},onEndDrag:function(i){t.send(e,"onEndDrag")}}),i.MiniTag=a}(),function(){var e="Bimface.Plugins.Drawable.DrawableContainer",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Drawable"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),function(e){var t=this,i=this,n=e.viewer,r=Glodon.Bimface.Viewer.ViewerDrawing&&n instanceof Glodon.Bimface.Viewer.ViewerDrawing,a=Glodon.Bimface.Viewer.ViewerDrawingSet&&n instanceof Glodon.Bimface.Viewer.ViewerDrawingSet,o=new Glodon.Web.Lang.EventManager,s=new Glodon.Bimface.Plugins.Drawable.DrawableContext;if(n.addEventListener("Rendered",function(e){i.update(e)}),r){n.getRootElement().appendChild(s.rootDomElement)}else if(a){var l=n.getActiveDrawing();l.viewerDrawing.getRootElement().appendChild(s.rootDomElement)}else if(i.isViewer3D=!0,n.getDomElement().appendChild(s.rootDomElement),e.affectedBySection){if(n.addEventListener(Glodon.Bimface.Plugins.Section.SectionBoxEvent.SectionBoxUpdate,function(e){i.section=e,i.update()}),n.addEventListener(Glodon.Bimface.Plugins.Section.SectionPlaneEvent.SectionPlaneUpdate,function(e){i.section=e,i.update()}),n.floorData){var c;!function(){t.floorInfos=n.floorData;var e=t.floorInfos,r=e.floorInfos.length,a=[];for(c=0;c<r;c++)!function(){var t=e.floorInfos[c];n.getFloorBoundingBoxById(t.id,function(e){a.push({box:e,floorName:t.name,explodedOffset:t.explodedHeight-t.elevation}),a.length==r&&(i.boxs=a)})}()}()}n.addEventListener(Glodon.Bimface.Viewer.Viewer3DEvent.FloorExplosion,function(e){var t=e.floorInfos.length,r=[];i.floorInfos=e;var a=function(){for(var e=i._items,t=0,n=e.length;t<n;t++){var a=e[t].worldPosition;if(a)if(e[t].levelName){var o=r.getObjectByAttribute("floorName",e[t].levelName);o&&(e[t].explosionOffset={x:0,y:0,z:o.explodedOffset})}else for(var s=0;s<r.length;s++){var l=r[s];if(l.box.containsPoint(a)){e[t].explosionOffset={x:0,y:0,z:l.explodedOffset},e[t].levelName=l.floorName;break}}}};if(t)for(var o=0;o<t;o++)!function(){var s=e.floorInfos[o];n.getFloorBoundingBoxById(s.id,function(e){r.push({box:e,floorName:s.name,explodedOffset:s.explodedHeight-s.elevation}),r.length==t&&(a(),i.boxs=r)})}()})}i._items=[],i._viewer=n,i._context=s,i._isDrawingView=r,i._isDrawingViewSet=a,i._maxNum=e.maxNum,i.getEventManager=function(){return o}});n.prototype={addItem:function(i){t.send(e,"addItem");var n=this._items,r=this._viewer;if(i.viewer=r,i.update=this.update.bind(this),i._config.objectId){var a=this._viewer.getViewer().getComponentInfoByUserId(i._config.objectId);i.levelName=a.userData.levelName}if(this.floorInfos){var o=i.worldPosition;if(i.levelName){var s=this.boxs.getObjectByAttribute("floorName",i.levelName);if(s){var l={x:o.x,y:o.y,z:o.z-s.explodedOffset};i.explosionOffset={x:0,y:0,z:s.explodedOffset},i.worldPosition=l}}else for(var c=this.boxs,u=0;u<c.length;u++){var h=c[u];if(0!=h.explodedOffset){var d={x:o.x,y:o.y,z:o.z-h.explodedOffset};if(h.box.containsPoint(d)){i.explosionOffset={x:0,y:0,z:h.explodedOffset},i.worldPosition=d;break}}}}n.push(i),this.update()},removeItemById:function(i){t.send(e,"removeItemById");var n=this._items,r=n.removeObjectByAttribute("id",i);r&&this._context.rootDomElement.contains(r[0]._domElement)&&this._context.rootDomElement.removeChild(r[0]._domElement),this.update()},getItemById:function(e){return this._items.getObjectByAttribute("id",e)},getAllItems:function(){return this._items},addItems:function(i){if(t.send(e,"addItems"),i.length)for(var n=0;n<i.length;n++)i[n].update=this.update.bind(this);this._items=i,this.update()},clear:function(){t.send(e,"clear"),this._items=[],this._context.rootDomElement.innerHTML="",this.update()},update:function(){var e=this._items,t=this._viewer,i=this._context,n=this._maxNum,r=e.length&&"customItem"==e[0].name,a=[];r||(i.rootDomElement.innerHTML=""),i.domContainer=null,i.svgContainer=null;var o=document.body.getBoundingClientRect();if(Glodon.Bimface.Plugins.Drawable.MiniTag.clear(),this._isDrawingView&&(t=t.getViewer()),this._isDrawingView)for(var s=0,l=e.length;s<l;s++){var c=e[s].worldPosition;if(c){var u=t.toScreenPoint([c.x,c.y]),h=e[s]._domElement.offsetWidth/2,d=e[s]._domElement.offsetHeight/2;u[0]<-h||u[0]>o.width+h||u[1]<-d||u[1]>o.height+d?e[s]._domElement.style.display="none":(e[s]._domElement.style.display="block",i.clientPosition={x:u[0],y:u[1]},e[s].draw(i))}}else if(this._isDrawingViewSet)for(var f=0,p=e.length;f<p;f++){var m=e[f].worldPosition,g=t.getDrawingById(e[f].viewerDrawingId),u=g.viewerDrawing.worldToClient(m);i.clientPosition=u,e[f].draw(i)}else{for(var v=0,y=e.length;v<y;v++){var E=e[v].worldPosition;if(E){var x=e[v].explosionOffset;x&&(E={x:E.x+x.x,y:E.y+x.y,z:E.z+x.z});var b={clientPosition:t.worldToClient(E),worldPosition:E,item:e[v]};e[v]instanceof Glodon.Bimface.Plugins.Drawable.MiniTag?a.push(b):t.isInViewFrustum(E)&&a.push(b)}}a.sort(function(e,t){return e.clientPosition.z>t.clientPosition.z?1:-1});for(var C=0;C<a.length;C++)if(!this.section||this.section.isIncluded(a[C].worldPosition)){a[C].item._domElement&&(a[C].item._domElement.style.display="block");var M="default";C>=n&&(M="mini"),i.clientPosition=a[C].clientPosition,a[C].item.draw(i,M)}else a[C].item._domElement&&(a[C].item._domElement.style.display="none")}r&&(i.rootDomElement.style.display="block")},exit:function(){t.send(e,"exit"),this.clear(),this._context.destroy()},hideItemsById:function(i){t.send(e,"hideItemsById");var n=this;if(i&&i.length>0)for(var r=0;r<i.length;r++){var a=n.getItemById(i[r]);a&&a.hide()}},hideAllItems:function(){t.send(e,"hideAllItems");var i=this,n=i._items;if(n&&n.length>0)for(var r=0;r<n.length;r++)n[r].hide()},showItemsById:function(i){t.send(e,"showItemsById");var n=this;if(i&&i.length>0)for(var r=0;r<i.length;r++){var a=n.getItemById(i[r]);a&&a.show()}},showAllItems:function(){
t.send(e,"showAllItems");var i=this,n=i._items;if(n&&n.length>0)for(var r=0;r<n.length;r++)n[r].show()}},i.DrawableContainer=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=function(){return{viewer:null,measureType:Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance,color:new Glodon.Web.Graphics.Color(249,157,11,1),hoverColor:new Glodon.Web.Graphics.Color(17,218,183,.2),width:3,radius:25,snapDistance:5}};e.MeasureConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=Object.freeze({Measuring:"Measuring",Measured:"Measured",Reset:"Reset"});e.MeasureEvent=t}(),function(){var e=Object.freeze({Distance:"Distance",Area:"Area",Angle:"Angle",MinimumDistance:"MinimumDistance",Elevation:"Elevation"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure").MeasureTypeOption=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=function(){return{id:null,color:new Glodon.Web.Graphics.Color(249,157,11,1),hoverColor:new Glodon.Web.Graphics.Color(17,218,183,.2),objectColor:new Glodon.Web.Graphics.Color(17,218,183,.9),width:3,radius:25,viewer:null}};e.MeasureItemConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),new Glodon.Web.Graphics.Color(17,218,183,.2),function(e){this.id=e.id||Glodon.Web.Lang.Utility.UUID.createUUID(),this.measurePoints=[],this.maxPointsNum=2});t.prototype={draw:function(e){},reset:function(){if(this.measurePoints=[],this._svg){for(var e=this._svg.childNodes,t=e.length,i=t-1;i>-1;i--)this._svg.removeChild(e[i]);this._svg.innerHTML=""}},addPoint:function(e){this.measurePoints.length==this.maxPointsNum&&this.reset(),this.measurePoints.push(e)},redo:function(){this.measurePoints.length>0&&this.measurePoints.length<this.maxPointsNum?this.measurePoints.pop():this.measurePoints=[]},getPoints:function(e){return this.measurePoints}},e.MeasureItem=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=new Glodon.Web.Graphics.Color(17,218,183,.2),r=function(e){t.MeasureItem.call(this,e),this.maxPointsNum=2,this.measurePoints=[];var r=e.color.getRGBA(),a=i.createNS("circle","bf-measure-handle");a.setAttribute("stroke-width",0);var o=a.cloneNode();a.setAttribute("r",2*e.width),a.setAttribute("fill",r),a.style.fill=r;var s=a.cloneNode();o.setAttribute("r",e.width),o.setAttribute("fill",n.getRGB()),o.style.fill=n.getRGB();var l=i.createNS("line","bf-measure-line"),c=l.cloneNode();c.style.strokeWidth=2;var u=c.cloneNode();c.setAttribute("stroke-dasharray","6,4");var h=c.cloneNode(),d=c.cloneNode();l.style.strokeWidth=e.width,l.style.stroke=e.color.getRGBA(),u.style.stroke=n.getRGB(),c.style.stroke="#CC021B",h.style.stroke="#7CCF21",d.style.stroke="#4A90E2",l.setAttribute("stroke-width",e.width);var f=i.createNS("polygon","bf-measure-rect");f.setAttribute("fill",n.getRGBA()),f.setAttribute("stroke",n.getRGB()),f.setAttribute("stroke-width",1),this.line=l,this.lineX=c,this.lineY=h,this.lineZ=d,this.hoverLine=u,this.startPoint=a,this.endPoint=s,this.hoverPoint=o,this.hoverPanel=f,this.hoverPanelSize={width:20,height:20}};e.Type.inheritPrototype(r,t.MeasureItem);var a={stretchOnDirection:function(e,t,i){var n=e.clone().add(t).multiplyScalar(.5),r=t.clone().sub(e).normalize();return[n.clone().sub(r.clone().multiplyScalar(i/2)),n.clone().add(r.clone().multiplyScalar(i/2))]},draw:function(e){var t=this.line,i=this.lineX,n=this.lineY,r=this.lineZ,a=this.hoverLine,o=this.startPoint,s=this.endPoint,l=this.hoverPoint,c=this.hoverPanel,u=this.hoverPanelSize;switch(this._svg=e.svg,e.hoverObjectType){case"Point":l.setAttribute("cx",e.hoverPosition.x),l.setAttribute("cy",e.hoverPosition.y),e.svg.appendChild(l);break;case"Line":a.setAttribute("x1",e.lineStartPoint.x),a.setAttribute("y1",e.lineStartPoint.y),a.setAttribute("x2",e.lineEndPoint.x),a.setAttribute("y2",e.lineEndPoint.y),e.svg.appendChild(a);break;case"Panel":var h=e.clientPts,d=h[0].distanceTo(h[1]),f=h[0].distanceTo(h[3]),p=d/u.width,m=f/u.height;if(1!=p){var g=this.stretchOnDirection(h[0],h[1],u.width),v=this.stretchOnDirection(h[2],h[3],u.width);h=g.concat(v)}if(1!=m){var g=this.stretchOnDirection(h[0],h[3],u.height),v=this.stretchOnDirection(h[1],h[2],u.height);h=[g[0],v[0],v[1],g[1]]}for(var y="",E=0;E<h.length;E++)y+=h[E].x+",",y+=h[E].y+" ";c.setAttribute("points",y),e.svg.appendChild(c)}switch(e.clientPoints.length){case 2:var x=e.auxLines[0],b=e.auxLines[1],C=e.auxLines[2];x&&(i.setAttribute("x1",x.start.x),i.setAttribute("y1",x.start.y),i.setAttribute("x2",x.end.x),i.setAttribute("y2",x.end.y),e.svg.appendChild(i)),b&&(n.setAttribute("x1",b.start.x),n.setAttribute("y1",b.start.y),n.setAttribute("x2",b.end.x),n.setAttribute("y2",b.end.y),e.svg.appendChild(n)),C&&(r.setAttribute("x1",C.start.x),r.setAttribute("y1",C.start.y),r.setAttribute("x2",C.end.x),r.setAttribute("y2",C.end.y),e.svg.appendChild(r)),o.setAttribute("cx",e.clientPoints[1].x),o.setAttribute("cy",e.clientPoints[1].y),s.setAttribute("cx",e.clientPoints[0].x),s.setAttribute("cy",e.clientPoints[0].y),t.setAttribute("x1",e.clientPoints[0].x),t.setAttribute("y1",e.clientPoints[0].y),t.setAttribute("x2",e.clientPoints[1].x),t.setAttribute("y2",e.clientPoints[1].y),e.svg.appendChild(o),e.svg.appendChild(s),e.svg.appendChild(t);break;case 1:o.setAttribute("cx",e.clientPoints[0].x),o.setAttribute("cy",e.clientPoints[0].y);this.getPoints().length!=this.maxPointsNum&&e.hoverPosition&&(t.setAttribute("x1",e.clientPoints[0].x),t.setAttribute("y1",e.clientPoints[0].y),t.setAttribute("x2",e.hoverPosition.x),t.setAttribute("y2",e.hoverPosition.y),e.svg.appendChild(t)),e.svg.appendChild(o)}}};r.prototype=Object.assign(r.prototype,a),t.MeasureDistanceItem=r}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=new Glodon.Web.Graphics.Color(17,218,183,.2),r=function(e){t.MeasureItem.call(this,e),this.maxPointsNum=3,this.radius=e.radius,this.measurePoints=[];var r=e.color.getRGBA(),a=i.createNS("circle","bf-measure-handle");a.setAttribute("stroke-width",0);var o=a.cloneNode();a.setAttribute("r",2*e.width),a.setAttribute("fill",r),a.style.fill=r;var s=a.cloneNode(),l=a.cloneNode();o.setAttribute("r",e.width),o.setAttribute("fill",n.getRGB()),o.style.fill=n.getRGB();var c=i.createNS("path","bf-measure-angle");c.setAttribute("fill","rgba(0,0,0,0)"),c.setAttribute("stroke",r),c.setAttribute("stroke-width",e.width);var u=i.createNS("line","bf-measure-line"),h=u.cloneNode();u.style.strokeWidth=e.width,u.style.stroke=r,u.setAttribute("stroke-width",e.width);var d=u.cloneNode();h.setAttribute("fill","rgba(0,0,0,0)"),h.setAttribute("stroke",n.getRGB()),h.setAttribute("stroke-width",2);var f=i.createNS("polygon","bf-measure-rect");f.setAttribute("fill",n.getRGBA()),f.setAttribute("stroke",n.getRGB()),f.setAttribute("stroke-width",1);var p=i.create("span","bf-measure-number");p.style.backgroundColor=e.color.getRGBA(),this.points=[a,s,l],this.lines=[u,d],this.hoverLine=h,this.angleLine=c,this.hoverPoint=o,this.hoverPanel=f,this.hoverPanelSize={width:20,height:20},this.text=p};e.Type.inheritPrototype(r,t.MeasureItem);var a={stretchOnDirection:function(e,t,i){var n=e.clone().add(t).multiplyScalar(.5),r=t.clone().sub(e).normalize();return[n.clone().sub(r.clone().multiplyScalar(i/2)),n.clone().add(r.clone().multiplyScalar(i/2))]},draw:function(e){var t=this.points,i=this.lines,n=this.hoverLine,r=this.angleLine,a=this.hoverPoint,o=this.hoverPanel;this._svg=e.svg;for(var s=this.hoverPanelSize,l=0,c=e.clientPoints.length;l<c;l++)e.clientPoints[l]&&(t[l].setAttribute("cx",e.clientPoints[l].x),t[l].setAttribute("cy",e.clientPoints[l].y),e.svg.appendChild(t[l]));switch(e.clientPoints.length){case 3:i[0].setAttribute("x1",e.clientPoints[0].x),i[0].setAttribute("y1",e.clientPoints[0].y),i[0].setAttribute("x2",e.clientPoints[1].x),i[0].setAttribute("y2",e.clientPoints[1].y),i[1].setAttribute("x1",e.clientPoints[1].x),i[1].setAttribute("y1",e.clientPoints[1].y),i[1].setAttribute("x2",e.clientPoints[2].x),i[1].setAttribute("y2",e.clientPoints[2].y);var u=this.radius,h=function(e,t,i,n){var e=new THREE.Vector2(e.x,e.y),t=new THREE.Vector2(t.x,t.y),i=new THREE.Vector2(i.x,i.y),r=1,a=e.sub(t),o=i.sub(t);if(a.length()<n||o.length()<n)return!1;a.setLength(n),o.setLength(n);var s=a.angle(),l=o.angle(),c=180*(l-s)/Math.PI;return c<0&&(c+=360),r=c<180?1:0,{pointA:t.clone().add(a),pointB:t.clone().add(o),flag:1,direction:r}}(e.clientPoints[0],e.clientPoints[1],e.clientPoints[2],u);h&&(r.setAttribute("d","M "+h.pointA.x+" "+h.pointA.y+" A "+u+" "+u+" 0 0 "+h.direction+" "+h.pointB.x+" "+h.pointB.y),e.svg.appendChild(r)),e.svg.appendChild(i[1]),e.svg.appendChild(i[0]);break;case 2:i[0].setAttribute("x1",e.clientPoints[0].x),i[0].setAttribute("y1",e.clientPoints[0].y),i[0].setAttribute("x2",e.clientPoints[1].x),i[0].setAttribute("y2",e.clientPoints[1].y),e.svg.appendChild(i[0]);var d=this.getPoints().length!=this.maxPointsNum;d&&e.hoverPosition&&(i[1].setAttribute("x1",e.clientPoints[1].x),i[1].setAttribute("y1",e.clientPoints[1].y),i[1].setAttribute("x2",e.hoverPosition.x),i[1].setAttribute("y2",e.hoverPosition.y),e.svg.appendChild(i[1]));break;case 1:var d=this.getPoints().length!=this.maxPointsNum;d&&e.hoverPosition&&(i[0].setAttribute("x1",e.clientPoints[0].x),i[0].setAttribute("y1",e.clientPoints[0].y),i[0].setAttribute("x2",e.hoverPosition.x),i[0].setAttribute("y2",e.hoverPosition.y),e.svg.appendChild(i[0]))}switch(e.hoverObjectType){case"Point":a.setAttribute("cx",e.hoverPosition.x),a.setAttribute("cy",e.hoverPosition.y),e.svg.appendChild(a);break;case"Line":n.setAttribute("x1",e.lineStartPoint.x),n.setAttribute("y1",e.lineStartPoint.y),n.setAttribute("x2",e.lineEndPoint.x),n.setAttribute("y2",e.lineEndPoint.y),e.svg.appendChild(n);break;case"Panel":var f=e.clientPts,p=f[0].distanceTo(f[1]),m=f[0].distanceTo(f[3]),g=p/s.width,v=m/s.height;if(1!=g){var y=this.stretchOnDirection(f[0],f[1],s.width),E=this.stretchOnDirection(f[2],f[3],s.width);f=y.concat(E)}if(1!=v){var y=this.stretchOnDirection(f[0],f[3],s.height),E=this.stretchOnDirection(f[1],f[2],s.height);f=[y[0],E[0],E[1],y[1]]}for(var t="",l=0;l<f.length;l++)t+=f[l].x+",",t+=f[l].y+" ";o.setAttribute("points",t),e.svg.appendChild(o)}}};r.prototype=Object.assign(r.prototype,a),t.MeasureAngleItem=r}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=(new Glodon.Web.Graphics.Color(17,218,183,.2),function(e){t.MeasureItem.call(this,e),this.maxPointsNum=2,this.measurePoints=[],this.opt=e,this.minDistanceLine=null,this.svgContainer=i.createNS("svg","bf-minDistanceMeasure-svg"),this.startPoint=i.createNS("circle","bf-minDistanceMeasure-handle"),this.endPoint=i.createNS("circle","bf-minDistanceMeasure-handle"),this.line=i.createNS("line","bf-minDistanceMeasure-line")});e.Type.inheritPrototype(n,t.MeasureItem);var r={draw:function(e){if(null!=this.minDistanceLine){if(0==this.minDistanceLine.distance)return void this.clearMinDistanceLine();var t=this.opt.cloudViewer,i=this.minDistanceLine,n=t.worldToCanvas(i.start.clone()),r=t.worldToCanvas(i.end.clone());this.drawMinDistanceLine(n,r)}},drawMinDistanceLine:function(e,t){var i=document.getElementsByClassName("bf-measure-conext")[0];null==this.svgContainer.parentNode&&(this.svgContainer.setAttribute("width",i.offsetWidth),this.svgContainer.setAttribute("height",i.offsetHeight),i.appendChild(this.svgContainer));var n=this.opt.color.getRGBA(),r=this.startPoint;r.setAttribute("r",2*this.opt.width),r.setAttribute("fill",n),r.setAttribute("cx",e.x),r.setAttribute("cy",e.y),null==r.parentNode&&this.svgContainer.appendChild(r);var a=this.endPoint;a.setAttribute("r",2*this.opt.width),a.setAttribute("fill",n),a.setAttribute("cx",t.x),a.setAttribute("cy",t.y),null==a.parentNode&&this.svgContainer.appendChild(a);var o=this.line;o.setAttribute("stroke",n),o.setAttribute("stroke-width",this.opt.width),o.setAttribute("x1",e.x),o.setAttribute("y1",e.y),o.setAttribute("x2",t.x),o.setAttribute("y2",t.y),null==o.parentNode&&this.svgContainer.appendChild(o)},setMinDistanceLine:function(e){this.minDistanceLine=e},clearMinDistanceLine:function(){var e=this.startPoint;e.parentNode&&this.svgContainer.removeChild(e);var t=this.endPoint;t.parentNode&&this.svgContainer.removeChild(t);var i=this.line;i.parentNode&&this.svgContainer.removeChild(i)},addPoint:function(e){var t=this.opt.viewer;this.opt.objectColor;this.measurePoints.length==this.maxPointsNum&&this.reset(),-1==this.measurePoints.indexOf(e)&&(this.measurePoints.push(e),t.addSelectedComponentsById([e]),t.render())},reset:function(){var e=this.opt.viewer;e.removeSelectedId(this.measurePoints),this.measurePoints=[],this.clearMinDistanceLine(),this.minDistanceLine=null,e.render()},redo:function(){var e=this.opt.viewer;if(this.measurePoints.length>0&&this.measurePoints.length<this.maxPointsNum){var t=this.measurePoints.pop();e.removeSelectedId([t]),e.render()}else this.reset()}};n.prototype=Object.assign(n.prototype,r),t.MeasureMinimumDistanceItem=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=function(e){t.MeasureItem.call(this,e),this.viewer=e.viewer,this.maxPointsNum=1;var n=e.color.getRGBA(),r=new Glodon.Web.Graphics.Color(17,218,183,.2),a=i.createNS("circle","bf-measure-handle");a.setAttribute("r",e.width),a.setAttribute("fill",r.getRGB()),a.style.fill=r.getRGB();var o=i.createNS("line","bf-measure-line");o.style.strokeWidth=2,o.style.stroke=r.getRGB();var s=i.createNS("polygon","bf-measure-rect");s.setAttribute("fill",r.getRGBA()),s.setAttribute("stroke",r.getRGB()),s.setAttribute("stroke-width",1);var l=i.createNS("polyline","bf-measure-elevation-marker");l.setAttribute("stroke",n),l.setAttribute("stroke-width",2),l.style.fill="none",this.hoverLine=o,this.hoverPoint=a,this.hoverPanel=s,this.elevationMarker=l,this.hoverPanelSize={width:20,height:20}};e.Type.inheritPrototype(n,t.MeasureItem);var r={stretchOnDirection:function(e,t,i){var n=e.clone().add(t).multiplyScalar(.5),r=t.clone().sub(e).normalize();return[n.clone().sub(r.clone().multiplyScalar(i/2)),n.clone().add(r.clone().multiplyScalar(i/2))]},draw:function(e){var t=this.hoverLine,i=this.hoverPoint,n=this.hoverPanel,r=this.hoverPanelSize;switch(e.hoverObjectType){case"Point":i.setAttribute("cx",e.hoverPosition.x),i.setAttribute("cy",e.hoverPosition.y),e.svg.appendChild(i);break;case"Line":t.setAttribute("x1",e.lineStartPoint.x),t.setAttribute("y1",e.lineStartPoint.y),t.setAttribute("x2",e.lineEndPoint.x),t.setAttribute("y2",e.lineEndPoint.y),e.svg.appendChild(t);break;case"Panel":var a=e.clientPts,o=a[0].distanceTo(a[1]),s=a[0].distanceTo(a[3]),l=o/r.width,c=s/r.height;if(1!=l){var u=this.stretchOnDirection(a[0],a[1],r.width),h=this.stretchOnDirection(a[2],a[3],r.width);a=u.concat(h)}if(1!=c){var u=this.stretchOnDirection(a[0],a[3],r.height),h=this.stretchOnDirection(a[1],a[2],r.height);a=[u[0],h[0],h[1],u[1]]}for(var d="",f=0;f<a.length;f++)d+=a[f].x+",",d+=a[f].y+" ";n.setAttribute("points",d),e.svg.appendChild(n)}if(this.measurePoints.length>0){var p=this.measurePoints[0].clone();p=this.viewer.worldToClient(p);var m=this.makeElevationMarker(p);this.elevationMarker.setAttribute("points",m),e.svg.appendChild(this.elevationMarker)}},makeElevationMarker:function(e){for(var t=[18,-10,-8,-10,0,0,8,-10],i="",n=0;n<t.length;n+=2)t[n]+=e.x,t[n+1]+=e.y,i+=t[n]+","+t[n+1]+" ";return i}};n.prototype=Object.assign(n.prototype,r),t.MeasureElevationItem=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=null,n=[],r=null,a=null,o=function(e){var i=e.viewer,n=this,r=new Glodon.Web.Lang.EventManager,a=t.create("div","bf-measure-conext");n.isOpen=!1,i.addEventListener("Rendered",function(){n.isOpen&&n.update()}),this.context={rootDomElement:a},this._opt=e,this.type=e.measureType,this.getEventManager=function(){return r},i.getViewer().registerEventListener(CLOUD.EVENTS.ON_MEASURE_PICK,function(e){n.isOpen&&n.measureByPoint(e)})};o.prototype={init:function(){var e=this,i=e.context,n=e._opt.viewer,r=n.getViewer();n.getDomElement().appendChild(i.rootDomElement),n.setSelectedComponentsById(),n.getDomElement().style.cursor="url("+Cursor.measure+"),auto";var a=t.createNS("svg","bf-measure-svg"),o=t.create("div","bf-measure-text");i.rootDomElement.innerHTML="",i.rootDomElement.appendChild(a),i.svg=a,i.text=o,r.editorManager.enableTool(r,CLOUD.EditToolMode.PICK_BY_MEASURE);var s,l=new Glodon.Bimface.Plugins.Measure.MeasureItemConfig;switch(l=Object.assign(l,e._opt),e.type){case Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance:s=new Glodon.Bimface.Plugins.Measure.MeasureDistanceItem(l);break;case Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Angle:s=new Glodon.Bimface.Plugins.Measure.MeasureAngleItem(l);break;case Glodon.Bimface.Plugins.Measure.MeasureTypeOption.MinimumDistance:l.cloudViewer=r,s=new Glodon.Bimface.Plugins.Measure.MeasureMinimumDistanceItem(l);break;case Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Elevation:s=new Glodon.Bimface.Plugins.Measure.MeasureElevationItem(l)}e.measureItem=s,n.render()},switchOn:function(){this.isOpen||(this.type=Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance,this.setMeasureType(Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance),this.isOpen=!0)},switchOff:function(){if(this.isOpen){var e=this.context.rootDomElement,t=this,i=t._opt.viewer,n=i.getViewer();i.getDomElement().style.cursor="",n.editorManager.disableTool(CLOUD.EditToolMode.PICK_BY_MEASURE),t.reset(),e.remove(),t.measureItem=null,this.isOpen=!1}},measureByPoint:function(e){var t=this,o=t.measureItem;t.context.rootDomElement.getBoundingClientRect();if(e)if(i=e.pickPoint?e.pickPoint:null,e.pickPlane?(r="Panel",a=e.normal):e.pickLine?(r="Line",n=e.pickLine):r=e.pickPoint?"Point":null,e.pick&&e.pickPoint){var s=this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Elevation,l=this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.MinimumDistance;s?(o.redo(),o.addPoint(e.pickPoint),o.draw(this.context)):l&&e.userId?o.addPoint(e.userId):(o.addPoint(e.pickPoint),t.update());var c=o.getPoints();c.length==o.maxPointsNum?t.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.Measured,t.getInfo()):t.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.Measuring,t.getInfo())}else t.update()},measureMinimum:function(){},reset:function(){this.isOpen&&(this.measureItem.reset(),this.context.svg.innerHTML="",this.context.points=[],this.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.Reset))},update:function(){var e=this.measureItem,t=this.context,o=this._opt.viewer,s=o.getDomElement(),l=s.getBoundingClientRect(),c=o.getViewer(),u=e.getPoints(),h=[],d=[];if(this.context.svg.innerHTML="",i?(t.hoverPosition=o.worldToClient(i),t.hoverPositionDS=c.getScene().worldToDrawing(i),0!=u.length&&(h=u.concat([i]))):(t.hoverPosition=null,0!=u.length&&(h=u.concat(u[u.length-1]))),t.hoverObjectType=r,"Line"==r&&2==n.length){t.lineStartPoint=o.worldToClient(n[0]),t.lineEndPoint=o.worldToClient(n[1]);var f=new THREE.Vector2(t.lineStartPoint.x,t.lineStartPoint.y),p=new THREE.Vector2(t.lineEndPoint.x,t.lineEndPoint.y),m=new THREE.Box2;m.min.set(s.clientLeft,s.clientTop),m.max.set(m.min.x+s.clientWidth,m.min.y+s.clientHeight);var g=!m.containsPoint(f),v=!m.containsPoint(p),y={start:f,end:p},E=CLOUD.CameraUtil.lineIntersectWithRect(y,m);if(g&&v)2==E.length&&(t.lineStartPoint=E[0],t.lineEndPoint=E[1]);else if(g||v)for(var x=new THREE.Vector2(t.hoverPosition.x,t.hoverPosition.y),b=g?p.clone():f.clone(),C=b.clone().sub(x).normalize(),M=0;M<E.length;M++){var _=b.clone().sub(E[M]).normalize();if(_.dot(C)>0){t.lineStartPoint=b,t.lineEndPoint=E[M];break}}}if("Panel"==t.hoverObjectType){t.normal=c.getScene().worldToDrawing(a),t.normal.normalize();var w=c.cameraControl,L=new THREE.Plane;L.setFromNormalAndCoplanarPoint(t.normal,t.hoverPositionDS);var T=new THREE.Vector2(t.hoverPosition.x-10,t.hoverPosition.y-10),I=new THREE.Vector2(t.hoverPosition.x+10,t.hoverPosition.y-10),S=t.hoverPositionDS,O=w.getRaycaster(T.x,T.y),f=O.ray.intersectPlane(L);O=w.getRaycaster(I.x,I.y);var p=O.ray.intersectPlane(L);if(null==f||null==p)return;var D=new THREE.Vector3(1,0,0),R=new THREE.Vector3(0,1,0),A=new THREE.Vector3(0,0,1),U=Math.abs(t.normal.clone().dot(D))<=.0025,B=Math.abs(t.normal.clone().dot(A))<=.0025;if(U&&B)var P=D.clone(),N=A.clone();else var k=R.clone(),P=k.cross(t.normal).normalize(),N=t.normal.clone().cross(P).normalize();var F=f.distanceTo(p)/2,H=P.clone().multiplyScalar(F),G=N.clone().multiplyScalar(F),V=S.clone().sub(H).add(G),z=S.clone().add(H).add(G),W=S.clone().sub(H).sub(G),q=S.clone().add(H).sub(G),j=[];j.push(V,z,q,W);for(var X=[],Y=w.getContainerDimensions(),Z=0;Z<j.length;Z++){var K=CLOUD.CameraUtil.drawingToCanvas(w.camera,j[Z],Y.width,Y.height);X.push(new THREE.Vector3(K.x,K.y,0))}t.clientPts=X}for(var M=0;M<h.length-1;M++){var Q=c.worldPointsToClient(h[M],h[M+1]);if(Q){var J={x:Q.start.x-l.left,y:Q.start.y-l.top};d.push(J)}}if(this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance&&u.length==e.maxPointsNum){for(var $={x:u[1].x,y:u[0].y,z:u[0].z},ee={x:u[1].x,y:u[1].y,z:u[0].z},te=[],ie=[u[0],$,ee,u[1]],Z=0;Z<ie.length-1;Z++){var Q=c.worldPointsToClient(ie[Z],ie[Z+1]);Q&&(Q.start.x-=l.left,Q.start.y-=l.top,Q.end.x-=l.left,Q.end.y-=l.top),te.push(Q)}t.auxLines=te}t.clientPoints=d,e.draw(t)},getInfo:function(){var e={},t=this.measureItem,i=this._opt.viewer,n=t.getPoints();if(this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.MinimumDistance){if(2==n.length){var r=i.getMinimumComponentDistanceById(n[0],n[1]);e.distance=Math.round(r.minDistance),e.start=r.start,e.end=r.end}e.points=n}else if(e.points=n,e.type=this.type,this.type==Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance)n&&2==n.length&&(e.distanceX=Math.round(Math.abs(n[1].x-n[0].x)),e.distanceY=Math.round(Math.abs(n[1].y-n[0].y)),e.distanceZ=Math.round(Math.abs(n[1].z-n[0].z)),e.distance=Math.round(Math.sqrt(Math.pow(e.distanceX,2)+Math.pow(e.distanceY,2)+Math.pow(e.distanceZ,2))));else if(3==n.length){var a=new THREE.Vector3(n[0].x-n[1].x,n[0].y-n[1].y,n[0].z-n[1].z),o=new THREE.Vector3(n[2].x-n[1].x,n[2].y-n[1].y,n[2].z-n[1].z),s=a.angleTo(o);e.angle=(180*s/Math.PI).toFixed(2)}return e},redo:function(){this.measureItem.redo(),this.update(),this.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.Measuring,this.getInfo())},exit:function(){this.switchOff()}},e.MeasureViewer3D=o}(),function(){var e="Bimface.Plugins.Measure.MeasureDrawing",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),function(e){this.isOpen=!1;var t=e.viewer,i=t.getViewer();this.viewer=t,this.viewerDrawing=i,this.domElement=t.getDomElement();new Glodon.Web.Lang.EventManager;t.setSnapDistance(e.snapDistance)});n.prototype={init:function(i){t.send(e,"init");var n=this;i&&(n._callback=i),this.viewerDrawing.mouseEditorMgr.activeEditorByName("Distance"==this.type?"measure":"area-measure")},switchOn:function(i){if(t.send(e,"switchOn"),!this.isOpen){this.isOpen=!0;this.domElement.firstElementChild.style.cursor="url("+Cursor.measure+"),auto",this.type=Glodon.Bimface.Plugins.Measure.MeasureTypeOption.Distance,this.init(i)}},switchOff:function(){if(t.send(e,"switchOff"),this.isOpen){this.isOpen=!1;this.domElement.firstElementChild.style.cursor="",this.measureItem=null,this.viewerDrawing.mouseEditorMgr.activeEditorByName("pick")}},reset:function(){t.send(e,"reset");var i=this.viewerDrawing.mouseEditorMgr.getEditor();i.reset&&i.reset(),this.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureEvent.Reset),this.viewerDrawing.update()},update:function(){t.send(e,"update")},exit:function(){t.send(e,"exit"),this.switchOff()}},i.MeasureDrawing=n}(),function(){var e=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=function(e){var n=e.viewer;if(n){var r=new Glodon.Web.Lang.EventManager,a=i.create("div","bf-measure-conext");this.context={rootDomElement:a},this._opt=e,this.type=e.measureType,this.getEventManager=function(){return r},Glodon.Bimface.Viewer.Viewer3D&&n instanceof Glodon.Bimface.Viewer.Viewer3D?(t.MeasureViewer3D.call(this,e),this.inherit(Glodon.Bimface.Plugins.Measure.MeasureViewer3D.prototype)):(t.MeasureDrawing.call(this,e),this.inherit(Glodon.Bimface.Plugins.Measure.MeasureDrawing.prototype))}};n.prototype={inherit:function(e){for(var t in e)this[t]=e[t]},addEventListener:function(e,t){this.getEventManager().addEvent(e,t)},removeEventListener:function(e,t){this.getEventManager().removeEvent(e,t)},getMeasureType:function(){return this.type},setMeasureType:function(t){e.send("Bimface.Plugins.Measure.Measure","setMeasureType"),this.type=t,this.reset(),this.init(),this.getEventManager().fireEvent("typeChange",t)}},t.Measure=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=function(){return{viewer:null,targetsHintColor:new Glodon.Web.Graphics.Color(245,127,35,.6)}};e.MeasureRayConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=function(){return{id:null,color:new Glodon.Web.Graphics.Color(245,127,35,1),width:2,startPoint:new Glodon.Web.Geometry.Point3d(0,0,0),endPoint:new Glodon.Web.Geometry.Point3d(0,0,0),startObjectId:null,endObjectId:null}};e.MeasureRayItemConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=function(e){this.id=e.id||Glodon.Web.Lang.Utility.UUID.createUUID();this.startPoint=e.startPoint,this.endPoint=e.endPoint;this.startComponentId=e.startComponentId,this.endComponentId=e.endComponentId;var i=t.createNS("defs","bf-defs");i.innerHTML='\n      <marker id="end" markerWidth="6" markerHeight="6" refx="5" refy="3" orient="auto" markerUnits="strokeWidth">\n        <path d="M0,0 L0,6 L6,3 z" fill="'+e.color.getRGBA()+'" />\n      </marker>';var n=t.create("i","bf-measure-handle");n.style.width=12*e.width+"px",n.style.height=12*e.width+"px",n.style.backgroundColor=e.color.getRGBA(),n.style.lineHeight=12*e.width+"px";var r=t.createNS("line","bf-measure-line");r.style.stroke=e.color.getRGBA(),r.setAttribute("stroke-width",e.width);var a=t.create("span","bf-measure-number");a.style.backgroundColor=e.color.getRGBA(),this.domElement=i,this.line=r,this.circle=n,this.text=a};i.prototype={draw:function(e){var t=this.domElement,i=this.line,n=this.circle,r=this.text,a=Math.abs(e.endPoint.x-e.startPoint.x),o=Math.abs(e.endPoint.y-e.startPoint.y),s=Math.abs(e.endPoint.z-e.startPoint.z),l=Math.sqrt(Math.pow(a,2)+Math.pow(o,2)+Math.pow(s,2));i.setAttribute("x1",e.startPoint.x),i.setAttribute("y1",e.startPoint.y),i.setAttribute("x2",e.endPoint.x),i.setAttribute("y2",e.endPoint.y),n.style.left=e.startPoint.x+"px",n.style.top=e.startPoint.y+"px",e.isMove&&(n.style.border="2px solid #fff"),l<15?i.removeAttribute("marker-end"):i.setAttribute("marker-end","url(#end)"),r.innerText=e.distance,e.svg.appendChild(t),e.svg.appendChild(i),e.text.appendChild(n),0==e.distance?n.innerText="0":(r.style.left=(e.startPoint.x+e.endPoint.x)/2+"px",r.style.top=(e.startPoint.y+e.endPoint.y)/2+"px",r.style.transform="translate(-50%, 0)",r.style.marginTop="2px",e.text.appendChild(r))}},e.MeasureRayItem=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=Object.freeze({Measured:"Measured",Clear:"Clear"});e.MeasureRayEvent=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Measure"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=function(e){var i=e.viewer;if(i){if(!(i instanceof Glodon.Bimface.Viewer.Viewer3D))return void console.log("Viewer2D is not supported.");var n=this,r=new Glodon.Web.Lang.EventManager,a=t.create("div","bf-measure-conext");i.addEventListener("Rendered",function(){n.measureItem&&n.update()}),this.context={rootDomElement:a},this._opt=e,this._enableMove=!1,this._events={mousedown:function(){this._startTime=(new Date).getTime()},mouseup:function(e){if(0==e.button||1==e.button)if(n._enableMove)n._enableMove=!1,n.measureByPoint(e);else{var t=this._startTime,i=(new Date).getTime();i-t<300&&n.measureByPoint(e)}},mousemove:function(e){n._enableMove&&(e.stopPropagation(),n.measureByPoint(e))}},this.getEventManager=function(){return r}}};i.prototype={addEventListener:function(e,t){this.getEventManager().addEvent(e,t)},removeEventListener:function(e,t){this.getEventManager().removeEvent(e,t)},switchOn:function(e){var i=this.context,n=this;n._opt.viewer.getDomElement().appendChild(i.rootDomElement),e&&(n._callback=e),n._opt.viewer.setSelectedComponentsById();var r=t.createNS("svg","bf-measure-svg"),a=t.create("div","bf-measure-text");i.rootDomElement.appendChild(r),i.rootDomElement.appendChild(a),i.svg=r,i.text=a,i.rootDomElement.addEventListener("mousedown",n._events.mousedown),i.rootDomElement.addEventListener("mouseup",n._events.mouseup),i.rootDomElement.addEventListener("mousemove",n._events.mousemove)},switchOff:function(){var e=this.context.rootDomElement,t=this,i=t._opt.viewer;t.measureItem&&(i.restoreComponentsColorById([t.measureItem.startComponentId,t.measureItem.endComponentId]),i.render()),e.removeEventListener("mousedown",t._events.mousedown),e.removeEventListener("mouseup",t._events.mouseup),e.removeEventListener("mousemove",t._events.mousemove),e.innerHTML="",e.remove(),t.measureItem=null},reset:function(){this.clear()},clear:function(){var e=this.context,t=this,i=t._opt.viewer;t.measureItem&&(i.restoreComponentsColorById([t.measureItem.startComponentId,t.measureItem.endComponentId]),i.render()),e.svg.innerHTML="",e.text.innerHTML="",t.measureItem=null,t.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureRayEvent.Clear,data)},measureByPoint:function(e){var t=this,i=t._opt.viewer,n=i.getViewer(),r=n.pickByPointWithNormal(e);if(r){t.measureItem&&i.restoreComponentsColorById([t.measureItem.startComponentId,t.measureItem.endComponentId]);var a=(Glodon.Bimface.Viewer.Viewer3DEvent,t._getContextData(r)),o=new Glodon.Bimface.Plugins.Measure.MeasureRayItemConfig;o.startComponentId=a.startComponentId,o.endComponentId=a.endComponentId,o.startPoint=a.startPoint,o.endPoint=a.endPoint;var s=new Glodon.Bimface.Plugins.Measure.MeasureRayItem(o);s.circle.addEventListener("mousedown",function(e){2!=e.button&&(t._enableMove=!0)}),t.context.distance=a.distance,
i.overrideComponentsColorById([a.startComponentId,a.endComponentId],t._opt.targetsHintColor),setTimeout(function(){t.update(),i.render()},100),t.measureItem=s,t.getEventManager().fireEvent(Glodon.Bimface.Plugins.Measure.MeasureRayEvent.Measured,a)}},update:function(){var e=this.measureItem,t=this.context,i=this._opt.viewer;t.svg.innerHTML="",t.text.innerHTML="",t.isMove=this._enableMove;var n=i.worldToClient(e.startPoint),r=i.worldToClient(e.endPoint);n&&r&&(t.startPoint=new Glodon.Web.Geometry.Point3d(n.x,n.y,n.z),t.endPoint=new Glodon.Web.Geometry.Point3d(r.x,r.y,r.z),e.draw(t))},exit:function(){this.switchOff()},_getContextData:function(e){var t,i,n={};return t=i=e[0],e.length>1&&(i=e[1]),n.startComponentId=t.userId,n.startPoint=t.worldPosition,n.endComponentId=i.userId,n.endPoint=i.worldPosition,n.distanceX=Math.round(Math.abs(n.endPoint.x-n.startPoint.x)),n.distanceY=Math.round(Math.abs(n.endPoint.y-n.startPoint.y)),n.distanceZ=Math.round(Math.abs(n.endPoint.z-n.startPoint.z)),n.distance=Math.round(Math.sqrt(Math.pow(n.distanceX,2)+Math.pow(n.distanceY,2)+Math.pow(n.distanceZ,2))),n}},e.MeasureRay=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Marker3D"),t=function(){return{viewer:null}};e.Marker3DContainerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Marker3D"),t=function(){return{id:null,size:30,tooltip:"",tooltipStyle:{color:"#333",fontSize:"14px",borderWidth:"1px",borderColor:"#666",borderStyle:"solid",backgroundColor:"#fff"},src:null,worldPosition:new Glodon.Web.Geometry.Point3d(0,0,0)}};e.Marker3DConfig=t}(),function(){var e="Bimface.Plugins.Marker3D.Marker3D",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Marker3D"),n=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),r=function(e){var t=this;this.id=e.id||Glodon.Web.Lang.Utility.UUID.createUUID(),this.size=e.size,this.iconUrl=e.src,this.position=e.worldPosition,this.tooltip=e.tooltip,this.tooltipElement=n.create("div","bf-tooltip"),this.tooltipElement.innerHTML=e.tooltip,this.tooltipElement.setCss(e.tooltipStyle),this._tooltipCallback=function(e,i,n){var r=t.tooltipElement;n.appendChild(r);var a=r.offsetWidth,o=r.offsetHeight;r.style.left=i.x-a/2+"px",r.style.top=i.y-o-t.size+"px",t._hoverCallback&&t._hoverCallback(e)},this._config=e};r.prototype={getId:function(){return this.id},getWorldPosition:function(){return this.position},setWorldPosition:function(i){t.send(e,"setWorldPosition"),this.position=i,this.update()},getSize:function(){return this.size},setSize:function(i){t.send(e,"setSize"),this.size=i,this.update()},getSrc:function(){return this.iconUrl},setSrc:function(i){t.send(e,"setSrc"),this.iconUrl=i,this.update()},getTooltip:function(){return this.tooltip},setTooltip:function(i){t.send(e,"setTooltip"),this.tooltip=i,this.tooltipElement.innerHTML=i},onClick:function(i){t.send(e,"onClick"),i&&(this._clickCallback=i)},onHover:function(i){t.send(e,"onHover"),i&&(this._hoverCallback=i)},update:function(){t.send(e,"update"),this.container&&this.container.update()}},i.Marker3D=r}(),function(){var e="Bimface.Plugins.Marker3D.Marker3DContainer",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Marker3D"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.ClientHelper.getIsDesktop()),r=function(e){var t=this;if(!e.viewer)return void console.log("viewer must not be empty.");var i=e.viewer instanceof Glodon.Bimface.Viewer.Viewer3D,r=e.viewer.getDomElement(),a=e.viewer.getViewer();if(!i)return void console.log("Viewer2D is not supported.");var o=new CLOUD.Marker3D(a,!0),s=this;if(this._helper=o,this._viewer=e.viewer,this._items=[],this._pick=function(e){var t=e.intersectInfo;if(t&&t.objectType===CLOUD.PICKABLETYPE.Marker3d){var i=s.getItemById(t.selectedObjectId);i._clickCallback&&i._clickCallback(i)}},this._hover=function(e){s.tooltipElement&&r.contains(s.tooltipElement)&&(r.removeChild(s.tooltipElement),s.tooltipElement=null);var t=e.intersectInfo;if(t&&t.objectType===CLOUD.PICKABLETYPE.Marker3d){var i=s.getItemById(t.selectedObjectId);s.tooltipElement=i.tooltipElement,i._tooltipCallback&&""!=s.tooltipElement.innerHTML&&i._tooltipCallback(i,e.canvasPos,r)}},a.registerEventListener(CLOUD.EVENTS.ON_CLICK_PICK,s._pick),n&&a.registerEventListener(CLOUD.EVENTS.ON_HOVER_PICK,s._hover),e.viewer.floorData){var l;!function(){t.floorInfos=e.viewer.floorData;var i=t.floorInfos,n=i.floorInfos.length,r=[];for(l=0;l<n;l++)!function(){var t=i.floorInfos[l];e.viewer.getFloorBoundingBoxById(t.id,function(e){r.push({box:e,floorName:t.name,explodedOffset:t.explodedHeight-t.elevation}),r.length==n&&(s.boxs=r)})}()}()}e.viewer.addEventListener(Glodon.Bimface.Viewer.Viewer3DEvent.FloorExplosion,function(t){var i=t.floorInfos.length,n=[];s.floorInfos=t;var r=function(){for(var e=s._items,t=0,i=e.length;t<i;t++){var r=e[t].position;if(r)if(e[t].levelName){var a=n.getObjectByAttribute("floorName",e[t].levelName);a&&(e[t].explosionOffset={x:0,y:0,z:a.explodedOffset})}else for(var o=0;o<n.length;o++){var l=n[o];if(l.box.containsPoint(r)){e[t].explosionOffset={x:0,y:0,z:l.explodedOffset},e[t].levelName=l.floorName;break}}}};if(i)for(var a=0;a<i;a++)!function(){var o=t.floorInfos[a];e.viewer.getFloorBoundingBoxById(o.id,function(e){n.push({box:e,floorName:o.name,explodedOffset:o.explodedHeight-o.elevation}),n.length==i&&(r(),s.boxs=n)})}();s.update()})};r.prototype={addItem:function(i){if(t.send(e,"addItem"),i.container=this,i._config.objectId){var n=this._viewer.getViewer().getComponentInfoByUserId(i._config.objectId);i.levelName=n.userData.levelName}if(this.floorInfos){var r=i.position;if(i.levelName){var a=this.boxs.getObjectByAttribute("floorName",i.levelName);if(a){var o={x:r.x,y:r.y,z:r.z-a.explodedOffset};i.explosionOffset={x:0,y:0,z:a.explodedOffset},i.worldPosition=o,i.origin=o.z}}else for(var s=this.boxs,l=0;l<s.length;l++){var c=s[l];if(0!=c.explodedOffset){var u={x:r.x,y:r.y,z:r.z-c.explodedOffset};if(c.box.containsPoint(u)){i.explosionOffset={x:0,y:0,z:c.explodedOffset},i.position=u;break}}}}this._items.push(i),this.update()},addItems:function(i){t.send(e,"addItems"),this._items=this._items.concat(i),this.update()},removeItemById:function(i){t.send(e,"removeItemById"),this._items.removeObjectByAttribute("id",i),this.update()},getItemById:function(e){return this._items.getObjectByAttribute("id",e)},getAllItems:function(){return[].concat(_toConsumableArray(this._items))},clear:function(){t.send(e,"clear"),this._items=[],this.update()},update:function(){this._helper.clear();for(var e=this._items.slice(),t=0,i=e.length;t<i;t++){var n=e[t].position;if(n){var r=e[t].explosionOffset;r&&(e[t].origin||(e[t].origin=n.z),n.z=e[t].origin+r.z)}}this._helper.add(e),this._helper.update(),this._viewer.render()},exit:function(){t.send(e,"exit");var i=this._viewer.getViewer();i.unregisterEventListener(CLOUD.EVENTS.ON_CLICK_PICK,self._pick),n&&i.unregisterEventListener(CLOUD.EVENTS.ON_HOVER_PICK,self._hover),this.clear()},hideItemsById:function(i){t.send(e,"hideItemsById"),this._helper.hideByIds(i),this._viewer.render()},hideAllItems:function(){t.send(e,"hideAllItems"),this._helper.hide(),this._viewer.render()},showItemsById:function(i){t.send(e,"showItemsById"),this._helper.showByIds(i),this._viewer.render()},showAllItems:function(){t.send(e,"showAllItems"),this._helper.show(),this._viewer.render()}},i.Marker3DContainer=r}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=function(){return{viewer:null}};e.SectionBoxConfig=t}(),function(){var e=Object.freeze({SectionBoxUpdate:"SectionBoxUpdate"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section").SectionBoxEvent=e}(),function(){var e,t,i="Bimface.Plugins.Section.SectionBox",n=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),r=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),a=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),function(i){var n=this,r=i.viewer;return r?r instanceof Glodon.Bimface.Viewer.Viewer3D?(r._sectionPlane&&(r._sectionPlane.hidePlane(),r._sectionPlane.exit()),e&&r==t?(e.id=i.id,e.reset(),e):(e=this,t=r,r._sectionBox?(r._sectionBox.showBox(),r._sectionBox):(r._sectionBox=this,n.id=i.id,n._opt=i,n._viewer=r,n.boxState=!0,void n.init()))):void console.log("Viewer2D is not supported."):void console.log("domElement must not be empty.")});a.prototype={hookEvens:function(){var e=this._viewer.getViewer(),t=this._viewer.getDomElement();e.registerEventListener(CLOUD.EVENTS.ON_CLIP_HOVER,function(e){e.onClipBox?t.style.cursor="url("+Cursor.section+"),auto":t.removeAttribute("style")})},init:function(){n.send(i,"init");var e=this._opt.viewer.getViewer(),t=this;e.editorManager.enableTool(e,CLOUD.EditToolMode.CLIP_BY_BOX),this._sectionBox=new CLOUD.ClipPlaneService(e);var r=e.getScene().getClipPlanes(),a=this._opt.viewer;r.observer=function(){var e=Glodon.Bimface.Plugins.Section.SectionBoxEvent;a.getEventManager().fireEvent(e.SectionBoxUpdate,t)},this._sectionBox.toggle(!0,!0),this._sectionBox.setVisible(!0),this.hookEvens()},setBox:function(e){n.send(i,"setBox"),this._sectionBox.getEditor().calculateOffsetByBox(e.min,e.max)},getBox:function(){},hideBox:function(){n.send(i,"hideBox"),this._sectionBox&&this._sectionBox.setVisible(!1),this._viewer.render()},showBox:function(){n.send(i,"showBox"),this._sectionBox&&this._sectionBox.setVisible(!0),this._viewer.render()},setProgress:function(e,t){var i=this,n={x:["left","right"],y:["back","front"],z:["bottom","top"]};t&&(i._sectionBox.setProcess(n[e][0],t[0]/100),2==t.length&&i._sectionBox.setProcess(n[e][1],1-t[1]/100))},getProgress:function(e){var t=this,i=[],n={x:["left","right"],y:["back","front"],z:["bottom","top"]};return i.push(100*t._sectionBox.getProcess(n[e][0])),i.push(100-100*t._sectionBox.getProcess(n[e][1])),i},reset:function(){n.send(i,"reset"),this._sectionBox.toggle(!0,!0),this._sectionBox.reset("Rotate"),this.showBox()},fitToModel:function(){n.send(i,"fitToModel");var e=this._sectionBox.recalculate().clone();e.isEmpty()&&e.expandByPoint(new THREE.Vector3),this.setBox(e),this._sectionBox.getEditor()._isVisible()&&this.showBox()},isIncluded:function(e){var t=this._opt.viewer,i=t.getViewer().getScene(),n=i.getClipPlanes(),r=n.getClipBoundingBox(),a=t.worldToScene(e);return r.containsPoint(a)},exit:function(){n.send(i,"exit");var t=this._opt.viewer.getViewer(),r=this._viewer.getDomElement();this.reset(),t.editorManager.disableTool(CLOUD.EditToolMode.CLIP_BY_BOX),r.removeAttribute("style"),this._sectionBox=null,this._opt.viewer._sectionBox=null,e=null,t.unregisterEventListener(CLOUD.EVENTS.ON_CLIP_HOVER,function(e){e.onClipBox?r.style.cursor="url("+Cursor.section+"),auto":r.removeAttribute("style")})},getState:function(){return this._sectionBox.saveState()},setState:function(e){this._sectionBox.loadState(e)},restore:function(){var e=this._sectionBox.getEditor()._isVisible();this._sectionBox.toggle(!0,e),this._sectionBox.reset("Rotate")}},r.SectionBox=a}(),function(){var e=Object.freeze({Forward:"Forward",Reverse:"Reverse"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section").SectionPlaneDirection=e}(),function(){var e=Object.freeze({X:"X",Y:"Y",Z:"Z"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section").SectionPlanePlane=e}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=function(){return{viewer:null,progress:50,plane:Glodon.Bimface.Plugins.Section.SectionPlanePlane.X,direction:Glodon.Bimface.Plugins.Section.SectionPlaneDirection.Forward}};e.SectionPlaneConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(){function e(t,i){_classCallCheck(this,e),this.coordinateSystem=t,this.viewer=i,this.container=this.viewer.domElement,this.mapDrawables={},this.initialize()}return _createClass(e,[{key:"initialize",value:function(){this.xmlns="http://www.w3.org/2000/svg";var e=document.createElement("div");e.style.left="0px",e.style.top="0px",e.style.width=this.container.offsetWidth+"px",e.style.height=this.container.offsetHeight+"px",e.style.position="absolute",e.style.zIndex=8,this.group=document.createElementNS(this.xmlns,"svg"),this.group.setAttribute("width",this.container.offsetWidth+""),this.group.setAttribute("height",this.container.offsetHeight+""),e.appendChild(this.group),this.container.appendChild(e)}},{key:"makeCircle",value:function(e,t){var i=this.mapDrawables;void 0==i[e]&&(i[e]=document.createElementNS(this.xmlns,"circle"),this.group.appendChild(i[e]));var n=i[e];n.style.fill=t.color||"#FF0000",n.setAttribute("r",t.radius+""),n.setAttribute("transform","translate("+t.center.x+","+t.center.y+")")}},{key:"show",value:function(e,t){var i=this.getDrawable(e);i&&(i.style.display=t?"block":"none")}},{key:"fill",value:function(e,t){this.getDrawable(e).style.fill=t?"block":"none"}},{key:"makeLine",value:function(e,t){var i=this.mapDrawables;void 0==i[e]&&(i[e]=document.createElementNS(this.xmlns,"line"),this.group.appendChild(i[e]));var n=i[e];n.setAttribute("stroke",t.color||"#000000"),n.setAttribute("stroke-width",t.width||3),n.setAttribute("x1",t.start.x+""),n.setAttribute("y1",t.start.y+""),n.setAttribute("x2",t.end.x+""),n.setAttribute("y2",t.end.y+"")}},{key:"makeDashLine",value:function(e,t){this.makeLine(e,t),this.mapDrawables[e].setAttribute("stroke-dasharray",t.dashArray)}},{key:"makePolyline",value:function(e,t){var i=null,n=this.mapDrawables;void 0==n[e]&&(n[e]=document.createElementNS(this.xmlns,"polyline"),this.group.appendChild(n[e])),i=n[e],i.setAttribute("stroke",t.color||"#A9A9A9"),i.setAttribute("stroke-width",t.width||3),i.style.fill="none",i.setAttribute("points",t.points)}},{key:"makeDefs",value:function(e){var t=this.mapDrawables;void 0==t[e]&&(t[e]=document.createElementNS(this.xmlns,"defs"),void 0==t.marker&&(t.marker=this.makeMarker(),t[e].appendChild(t.marker)),this.group.appendChild(t[e]))}},{key:"makeMarker",value:function(){var e=document.createElementNS(this.xmlns,"marker");e.setAttribute("id","arrow"),e.setAttribute("viewBox","0 0 10 10"),e.setAttribute("refX","5"),e.setAttribute("refY","5"),e.setAttribute("markerWidth","6"),e.setAttribute("markerHeight","6"),e.setAttribute("orient","auto-start-reverse");var t=document.createElementNS(this.xmlns,"path");return t.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),t.style.fill="#11DAB7",this.mapDrawables.arrow=t,e.appendChild(t),e}},{key:"getDrawable",value:function(e){return this.mapDrawables[e]}},{key:"attach",value:function(){this.getDrawable("axisZ").setAttribute("marker-end","url(#arrow)")}},{key:"setColor",value:function(e,t){this.getDrawable(e).setAttribute("stroke",t)}},{key:"fill",value:function(e,t){this.getDrawable(e).style.fill=t}},{key:"hideAll",value:function(e){this.group.style.display=1==e?"none":"block"}},{key:"destroy",value:function(){for(var e=this.group.children,t=0;t<e.length;t++)this.group.removeChild(e[t]);this.group.parentNode.removeChild(this.group)}}]),e}());e.CoordinateDrawer=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(){function e(t,i){_classCallCheck(this,e),this.coordinateSystem=t,this.viewer=t.viewer,this.drawingImpl=i,this.viewportOffset=this.viewer.domElement.getBoundingClientRect(),this.cameraControl=this.viewer.cameraControl,this.fillClipPlane=this.viewer.getScene().getFillClipPlane(),this.initialize()}return _createClass(e,[{key:"initialize",value:function(){this.arrowMouseDown=!1,this.circleXMouseDown=!1,this.circleYMouseDown=!1,this.firstClickDown=!0,this.firstRotate=!0,this.lineOut=!0,this.arrowOut=!0,this.translateStartPt=new THREE.Vector2,this.translateEndPt=new THREE.Vector2,this.rotateAngleA=0,this.rotateAngleB=0,this.config=this.coordinateSystem.config}},{key:"registerArrowEvents",value:function(){var e=this.drawingImpl.getDrawable("axisZ"),t=this,i=this.config.colors;e.onmouseover=function(){1!=t.circleXMouseDown&&1!=t.circleYMouseDown&&(t.drawingImpl.setColor("axisZ",i.highLight),t.drawingImpl.fill("arrow",i.highLight),t.drawingImpl.setColor("tipArcX",i.default),t.drawingImpl.fill("cubeX",i.default),t.drawingImpl.setColor("tipArcY",i.default),t.drawingImpl.fill("cubeY",i.default),t.lineOut=!1)},e.onmouseout=function(){1!=t.circleXMouseDown&&1!=t.circleYMouseDown&&0==t.arrowMouseDown&&1==t.arrowOut&&(t.drawingImpl.setColor("axisZ",i.arrow),t.drawingImpl.fill("arrow",i.arrow),t.drawingImpl.setColor("tipArcX",i.tipArcX),t.drawingImpl.fill("cubeX",i.cubeX),t.drawingImpl.setColor("tipArcY",i.tipArcY),t.drawingImpl.fill("cubeY",i.cubeY),t.lineOut=!0)},e.onmousedown=function(e){t.arrowMouseDown=!0,t.lineOut=!1;var i=t.config.colors;t.drawingImpl.setColor("axisZ",i.highLight),t.drawingImpl.fill("arrow",i.highLight),t.coordinateSystem.colorUpdate=!1,t.translateStartPt.set(e.clientX,e.clientY)};var n=this.drawingImpl.getDrawable("arrow");n.onmouseover=function(){if(1!=t.circleXMouseDown&&1!=t.circleYMouseDown){t.arrowOut=!1;var e=t.config.colors;t.drawingImpl.fill("arrow",e.highLight),t.drawingImpl.setColor("axisZ",e.highLight),t.drawingImpl.setColor("tipArcX",e.default),t.drawingImpl.fill("cubeX",e.default),t.drawingImpl.setColor("tipArcY",e.default),t.drawingImpl.fill("cubeY",e.default)}},n.onmouseout=function(){if(1!=t.circleXMouseDown&&1!=t.circleYMouseDown&&0==t.arrowMouseDown&&1==t.lineOut){t.arrowOut=!0;var e=t.config.colors;t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow),t.drawingImpl.setColor("tipArcX",e.tipArcX),t.drawingImpl.fill("cubeX",e.cubeX),t.drawingImpl.setColor("tipArcY",e.tipArcY),t.drawingImpl.fill("cubeY",e.cubeY)}},n.onmousedown=function(e){t.arrowMouseDown=!0,t.arrowOut=!1;var i=t.config.colors;t.drawingImpl.setColor("axisZ",i.highLight),t.drawingImpl.fill("arrow",i.highLight),t.translateStartPt.set(e.clientX,e.clientY)},document.onmousemove=function(e){if(1==t.arrowMouseDown){CLOUD.GlobalData.ClippingCaps=!1;if(!(e.clientX==t.translateStartPt.x&&e.clientY==t.translateStartPt.y)){var i=t.fillClipPlane.renderClipPlane,n=i.normal.clone();n.w=i.constant;var r=t.cameraControl.movePlane(n,e,t.translateStartPt,!1,t.fillClipPlane.position.clone());null!=r&&t.fillClipPlane.offset(r),t.translateStartPt.set(e.clientX,e.clientY),t.cameraControl.update(!0)}t.coordinateSystem.update();var a=t.config.colors;t.drawingImpl.setColor("axisZ",a.highLight),t.drawingImpl.fill("arrow",a.highLight),t.drawingImpl.setColor("tipArcX",a.default),t.drawingImpl.fill("cubeX",a.default),t.drawingImpl.setColor("tipArcY",a.default),t.drawingImpl.fill("cubeY",a.default),e.preventDefault(),e.stopPropagation()}},document.onmouseup=function(){if(0!=t.arrowMouseDown){t.arrowMouseDown=!1,t.coordinateSystem.colorUpdate=!0;var e=t.config.colors;t.drawingImpl.setColor("axisZ",e.arrow),t.drawingImpl.fill("arrow",e.arrow),t.drawingImpl.setColor("tipArcX",e.tipArcX),t.drawingImpl.fill("cubeX",e.cubeX),t.drawingImpl.setColor("tipArcY",e.tipArcY),t.drawingImpl.fill("cubeY",e.cubeY),CLOUD.GlobalData.ClippingCaps=!0,t.viewer.render()}}}},{key:"registerCircleXEvents",value:function(){var e=this,t=this.config.colors,i=this.drawingImpl.getDrawable("tipArcX");i.onmousedown=function(){e.circleXMouseDown=!0,e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),e.enableCircleXMovement()},i.onmouseout=function(){0==e.circleXMouseDown&&(e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow),e.drawingImpl.setColor("tipArcY",t.tipArcY),e.drawingImpl.fill("cubeY",t.cubeY),e.coordinateSystem.circleToArc("tipArcX"))},document.addEventListener("mouseup",function(){1==e.circleXMouseDown&&(CLOUD.GlobalData.ClippingCaps=!0,e.viewer.render()),e.circleXMouseDown=!1,e.circleXMouseDown=!1,e.firstClickDown=!0,e.firstRotate=!1,e.lastRotateX=0,e.lastRotateY=0,e.drawingImpl.show("tipArcY",!0),e.drawingImpl.show("axisY",!0),e.drawingImpl.show("axisZ",!0),e.drawingImpl.show("cubeY",!0),e.coordinateSystem.update(),e.drawingImpl.show("dashLineX",!1),e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow)})}},{key:"registerCircleYEvents",value:function(){var e=this,t=this.config.colors,i=this.drawingImpl.getDrawable("tipArcY");i.onmousedown=function(){e.circleYMouseDown=!0,e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),e.enableCircleYMovement()},i.onmouseout=function(){0==e.circleYMouseDown&&(e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow),e.coordinateSystem.circleToArc("tipArcY"),e.drawingImpl.setColor("tipArcX",t.tipArcX),e.drawingImpl.fill("cubeX",t.cubeX))},document.addEventListener("mouseup",function(){1==e.circleYMouseDown&&(CLOUD.GlobalData.ClippingCaps=!0,e.viewer.render()),e.circleYMouseDown=!1,e.drawingImpl.show("tipArcX",!0),e.drawingImpl.show("cubeX",!0),e.coordinateSystem.update(),e.drawingImpl.show("dashLineY",!1),e.drawingImpl.setColor("axisZ",t.arrow),e.drawingImpl.fill("arrow",t.arrow)})}},{key:"enableCircleXMovement",value:function(){var e=this,t=this.config.colors;document.addEventListener("mousemove",function(i){if(1==e.circleXMouseDown){e.drawingImpl.show("dashLineX",!0),e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),CLOUD.GlobalData.ClippingCaps=!1;var n=e.fillClipPlane.normalIndex,r=e.viewportOffset,a=new THREE.Vector2(i.clientX-r.left,i.clientY-r.top),o=e.calcRotateAngleIndex(a,e.coordinateSystem.discretePointsX);1==e.firstClickDown&&(e.lastIndex=o);var s=2*(o-e.lastIndex);n>3&&(s=-s),e.drawingImpl.show("tipArcY",!1),e.coordinateSystem.updateAxisZ();var l=e.fillClipPlane.renderClipPlane.normal.clone(),c=e.coordinateSystem.getCoordinateAxis(),u=e.config.styles;e.coordinateSystem.drawClipPlaneCircle("tipArcZ",c.start.clone(),u.auxCircleRadius,e.coordinateSystem.dirX,l);var h=e.coordinateSystem.drawingToCanvas(c.start.clone()),d=e.coordinateSystem.drawingToCanvas(c.endY.clone());e.coordinateSystem.drawAxisY(h,d,t.highLight),e.coordinateSystem.drawCubeX("cubeX",d,u.cubeRadius),e.drawingImpl.show("cubeY",!1);var f="x";n<2&&(f="y"),e.fillClipPlane.rotateAngleOffset(s,f),e.coordinateSystem.backwardCoordinate(),1==e.firstClickDown?e.firstClickDown=!1:e.lastIndex=o,e.translateStartPt.set(i.clientX,i.clientY),e.viewer.render(),i.preventDefault(),i.stopPropagation()}})}},{key:"enableCircleYMovement",value:function(){var e=this,t=this.config.colors;document.addEventListener("mousemove",function(i){if(1==e.circleYMouseDown){e.drawingImpl.show("dashLineY",!0),e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),CLOUD.GlobalData.ClippingCaps=!1;var n=e.fillClipPlane.normalIndex,r=e.viewportOffset,a=new THREE.Vector2(i.clientX-r.left,i.clientY-r.top),o=e.calcRotateAngleIndex(a,e.coordinateSystem.discretePointsY);1==e.firstClickDown&&(e.lastIndex=o);var s=2*(o-e.lastIndex);n>3&&(s=-s),e.drawingImpl.show("tipArcX",!1),e.coordinateSystem.updateAxisZ();var l=e.fillClipPlane.renderClipPlane.normal.clone(),c=e.coordinateSystem.getCoordinateAxis(),u=e.config.styles;e.coordinateSystem.drawClipPlaneCircle("tipArcZ",c.start.clone(),u.auxCircleRadius,e.coordinateSystem.dirX.clone(),l.clone());var h=e.coordinateSystem.drawingToCanvas(c.start.clone()),d=e.coordinateSystem.drawingToCanvas(c.endX.clone());e.coordinateSystem.drawAxisX(h,d,t.highLight),e.coordinateSystem.drawCubeY("cubeY",d,u.cubeRadius),e.drawingImpl.show("cubeX",!1);var f="z";n>=3&&(f="y"),e.fillClipPlane.rotateAngleOffset(s,f),e.coordinateSystem.backwardCoordinate(),1==e.firstClickDown?e.firstClickDown=!1:e.lastIndex=o,e.translateStartPt.set(i.clientX,i.clientY),e.viewer.render(),i.preventDefault(),i.stopPropagation()}})}},{key:"registerTipArcXEvents",value:function(){var e=this,t=this.config.colors,i=this.drawingImpl.getDrawable("tipArcX");i.onmouseover=function(){0==e.circleYMouseDown&&(e.coordinateSystem.arcToCircle("tipArcX"),e.drawingImpl.setColor("tipArcY",t.default),e.drawingImpl.fill("cubeY",t.default),e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),e.registerCircleXEvents())},i.onmouseout=function(){0==e.circleXMouseDown&&e.coordinateSystem.circleToArc("tipArcX")}}},{key:"registerTipArcYEvents",value:function(){var e=this,t=this.config.colors,i=this.drawingImpl.getDrawable("tipArcY");i.onmouseover=function(){0==e.circleXMouseDown&&(e.coordinateSystem.arcToCircle("tipArcY"),e.drawingImpl.setColor("tipArcX",t.default),e.drawingImpl.fill("cubeX",t.default),e.drawingImpl.setColor("axisZ",t.default),e.drawingImpl.fill("arrow",t.default),e.registerCircleYEvents())},i.onmouseout=function(){0==e.circleYMouseDown&&e.coordinateSystem.circleToArc("tipArcY")}}},{key:"calcRotateAngleIndex",value:function(e,t){for(var i=this.coordinateSystem.cOrigin,n=this.createLine(e,i),r=-1,a=Number.POSITIVE_INFINITY,o=0;o<90;o++){var s=t[o].clone(),l=this.disPointToLine(s,n);l<a&&(a=l,r=o)}var c=90+r;return t[r].clone().distanceTo(e)<t[c].clone().distanceTo(e)?r:c}},{key:"createLine",value:function(e,t){var i={};if(e.x==t.x)i.A=1,i.B=0,i.C=-e.x;else{var n=(t.y-e.y)/(t.x-e.x),r=t.y-n*t.x;i.A=n,i.B=-1,i.C=r}return i}},{key:"disPointToLine",value:function(e,t){return Math.abs(t.A*e.x+t.B*e.y+t.C)/Math.sqrt(t.A*t.A+t.B*t.B)}}]),e}());e.CoordinateAction=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=function(){return{colors:{tipArcX:"#0000FF",cubeX:"#0000FF",tipArcY:"#FF0000",cubeY:"#FF0000",highLight:"#FFFF00",tipLine:"#11DAB7",arrow:"#11DAB7",default:"#A9A9A9"},styles:{dashArray:"10 8",originRadius:5,auxCircleRadius:100,tipLineLength:500,cubeRadius:5,axisXWidth:2,axisYWidth:2,axisZWidth:3,axisXLength:100,axisYLength:100,axisZLength:165,segments:180,tipArcLeftCounts:15,tipArcRightCounts:60}}};e.CoordinateSystemConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),t=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(){function e(t){_classCallCheck(this,e),this.viewer=t,this.cameraControl=t.cameraControl,this.fillClipPlane=t.getScene().getFillClipPlane(),this.container=t.domElement,this.config=new Glodon.Bimface.Plugins.Section.CoordinateSystemConfig,this.drawingImpl=new Glodon.Bimface.Plugins.Section.CoordinateDrawer(this,t),this.coordinateAction=new Glodon.Bimface.Plugins.Section.CoordinateAction(this,this.drawingImpl),this.initialize()}return _createClass(e,[{key:"initialize",value:function(){this.enable=!0,this.boundingBox=new THREE.Box2,this.bRegisterArrowEvent=!1,this.bRegisterAuxCircleEvent=!1,this.mapDrawableName={ORIGIN:"origin",AXISX:"axisX",AXISY:"axisY",CUBEX:"cubeX",CUBEY:"cubeY",AXISZ:"axisZ",ARROW:"arrow",DASHLINE:"dashLine",TIPARC_X:"tipArcX",TIPARC_Y:"tipArcY",TIPARC_Z:"tipArcZ",DASHLINE_X:"dashLineX",DASHLINE_Y:"dashLineY"}}},{key:"saveTransform",value:function(e){this.savedCamera=e.clone()}},{key:"drawingToCanvas",value:function(e,t){var i=this.getCoordinateAxis(),n=i.start.clone(),r=this.cameraControl.camera,a=new THREE.Vector3;if(void 0==this.cameraToCenter){var o=this.viewer.getCamera(),s=this.viewer.getScene().getBoundingBox();r.setStandardView(CLOUD.EnumStandardView.ISO,s),r.zoomToBBox(s),n=this.getCoordinateAxis().start.clone(),this.cameraToCenter=n.clone().sub(r.position.clone()).length();var l=this.viewer.getScene().getMatrixGlobal(),c=CLOUD.CameraUtil.parseCameraInfo(o),u=CLOUD.Camera.worldToDrawing(c,l),h=new THREE.Vector3;h.subVectors(u.target,u.position),r.LookAt(u.target,h,u.up),this.cameraControl.update(!0,!0)}else{var h=n.clone().sub(r.position.clone()).normalize(),d=r.position.clone().sub(n.clone()).length();a=h.multiplyScalar(this.cameraToCenter-d)}var f=this.container.offsetWidth,p=this.container.offsetHeight;!1!==t&&e.add(a);var m=CLOUD.CameraUtil.drawingToCanvas(r,e,f,p);return new THREE.Vector2(m.x,m.y)}},{key:"getCoordinateAxis",value:function(){var e=this.fillClipPlane.renderClipPlane,t=e.normal.clone(),i=this.fillClipPlane.getCoordinate(),n=i.axisY.clone(),r=t.clone().cross(n.clone());this.fillClipPlane.normalIndex>3&&(r=i.axisX.clone(),n=r.clone().cross(t.clone()));var a=this.config.styles,o=this.fillClipPlane.position.clone(),s=o.clone().add(r.clone().multiplyScalar(a.axisXLength)),l=o.clone().add(n.clone().multiplyScalar(a.axisYLength)),c=o.clone().add(t.clone().multiplyScalar(a.axisZLength));return this.dirX=r,this.dirY=n,{start:o,endX:s,endY:l,endZ:c}}},{key:"drawOrigin",value:function(e,t){var i=this.mapDrawableName,n={center:e,radius:t,color:this.config.colors.default};this.drawingImpl.makeCircle(i.ORIGIN,n)}},{key:"drawAxisX",value:function(e,t,i){var n=this.mapDrawableName,r=this.config,a={start:e,end:t,width:r.styles.axisXWidth,color:i||this.config.colors.default};this.drawingImpl.makeLine(n.AXISX,a)}},{key:"drawAxisY",value:function(e,t,i){var n=this.mapDrawableName,r=this.config,a={start:e,end:t,width:r.styles.axisYWidth,color:i||r.colors.default};this.drawingImpl.makeLine(n.AXISY,a)}},{key:"drawAxisZ",value:function(e,t){var i=this.mapDrawableName,n=this.config,r={start:e,end:t,width:n.styles.axisZWidth,color:n.colors.arrow};this.drawingImpl.makeLine(i.AXISZ,r),this.drawingImpl.attach(),0==this.bRegisterArrowEvent&&(this.coordinateAction.registerArrowEvents(),this.bRegisterArrowEvent)}},{key:"updateAxisZ",value:function(){var e=this.getCoordinateAxis(),t=this.drawingToCanvas(e.start.clone()),i=this.drawingToCanvas(e.endZ.clone()),n=this.mapDrawableName,r={start:t,end:i,color:this.config.colors.default};this.drawingImpl.makeLine(n.AXISZ,r)}},{key:"drawArrow",value:function(e,t){var i=this.mapDrawableName,n={start:e,end:t};this.drawingImpl.makeLine(i.AXISZ,n),this.drawingImpl.attach(),this.drawingImpl.setColor(i.AXISZ,this.config.colors.default),0==this.bRegisterArrowEvent&&(this.coordinateAction.registerArrowEvents(),this.bRegisterArrowEvent)}},{key:"drawClipPlaneCircle",value:function(e,t,i,n,r){for(var a={center:t.clone(),radius:i,normal:n.clone(),rotateAxis:r.clone()},o=this.config.styles,s=o.segments,l=this.discreteCircle(a,s),c="",u=0;u<s;u++)c+=l[u].x+","+l[u].y,c+=" ";c+=l[0].x+","+l[0].y,c+=" ";var h={points:c,color:this.config.colors.default,width:2};this.drawingImpl.makePolyline(e,h)}},{key:"drawTipArc",value:function(e,t,i,n,r){var a={center:t.clone(),radius:i,normal:n.clone(),rotateAxis:r.clone()},o=this.config.styles,s=o.tipArcRightCounts,l=o.tipArcLeftCounts,c=o.segments,u=this.discreteCircle(a,c);e==this.mapDrawableName.TIPARC_X?(this.discretePointsX=u,s=o.tipArcLeftCounts,l=o.tipArcRightCounts):this.discretePointsY=u;for(var h="",d=c-s-1;d<c;d++)h+=u[d].x+","+u[d].y,h+=" ";for(var f=0;f<=l;f++)h+=u[f].x+","+u[f].y,h+=" ";var p={points:h,color:this.config.colors.tipArcX};e==this.mapDrawableName.TIPARC_X?(this.drawingImpl.makePolyline(e,p),this.coordinateAction.registerTipArcXEvents()):e==this.mapDrawableName.TIPARC_Y&&(p.color=this.config.colors.tipArcY,this.drawingImpl.makePolyline(e,p),this.coordinateAction.registerTipArcYEvents())}},{key:"drawTipLine",value:function(e,t,i){var n=this.drawingToCanvas(t.clone(),!1),r=this.drawingToCanvas(i.clone(),!1),a=this.config,o={start:n,end:r,color:a.colors.tipLine,dashArray:a.styles.dashArray};this.drawingImpl.makeDashLine(e,o),
this.drawingImpl.show(e,!1)}},{key:"drawCubeX",value:function(e,t,i){var n={center:t,radius:i,color:this.config.colors.cubeX};this.drawingImpl.makeCircle(e,n)}},{key:"drawCubeY",value:function(e,t,i,n){var r={center:t,radius:i,color:n||this.config.colors.cubeY};this.drawingImpl.makeCircle(e,r)}},{key:"discreteCircle",value:function(e,t){for(var i=e.center.clone(),n=e.radius,r=e.rotateAxis.clone(),a=e.normal.clone(),o=[],s=0;s<t;s++){a.applyAxisAngle(r,2*Math.PI/t);var l=i.clone().add(a.clone().multiplyScalar(n)),c=this.drawingToCanvas(l.clone());o.push(c)}return o}},{key:"arcToCircle",value:function(e){var t="",i=this.discretePointsX;e==this.mapDrawableName.TIPARC_Y&&(i=this.discretePointsY);for(var n=0,r=i.length;n<r;n++)t+=i[n].x+","+i[n].y,t+=" ";t+=i[0].x+","+i[0].y,t+=" ";var a={points:t,color:this.config.colors.highLight};this.drawingImpl.makePolyline(e,a)}},{key:"circleToArc",value:function(e){var t=this.config.styles,i=t.tipArcLeftCounts,n=t.tipArcRightCounts,r=t.segments,a=this.discretePointsX,o={color:this.config.colors.tipArcX};e==this.mapDrawableName.TIPARC_Y&&(a=this.discretePointsY,o.color=this.config.colors.tipArcY,i=t.tipArcRightCounts,n=t.tipArcLeftCounts);for(var s="",l=r-i-1;l<r;l++)s+=a[l].x+","+a[l].y,s+=" ";for(var c=0;c<=n;c++)s+=a[c].x+","+a[c].y,s+=" ";o.points=s,this.drawingImpl.makePolyline(e,o)}},{key:"update",value:function(){var e=this.getCoordinateAxis(),t=this.drawingToCanvas(e.start.clone()),i=this.drawingToCanvas(e.endX.clone()),n=this.drawingToCanvas(e.endY.clone()),r=this.drawingToCanvas(e.endZ.clone());void 0==this.createRefs&&(this.drawingImpl.makeDefs("refs"),this.createRefs=!0),this.cOrigin=t.clone(),this.drawAxisZ(t,r),this.drawAxisX(t,i),this.drawAxisY(t,n);var a=this.config.styles,o=this.mapDrawableName,s=this.fillClipPlane.renderClipPlane.normal.clone();this.drawClipPlaneCircle(o.TIPARC_Z,e.start.clone(),a.auxCircleRadius,this.dirX,s),this.drawTipArc(o.TIPARC_X,e.start.clone(),a.auxCircleRadius,s,this.dirX),this.drawTipArc(o.TIPARC_Y,e.start.clone(),a.auxCircleRadius,s,this.dirY);var l=e.start.clone().add(this.dirX.clone().multiplyScalar(a.tipLineLength)),c=e.start.clone().sub(this.dirX.clone().multiplyScalar(a.tipLineLength));this.drawTipLine(o.DASHLINE_X,l,c);var u=e.start.clone().add(this.dirY.clone().multiplyScalar(a.tipLineLength)),h=e.start.clone().sub(this.dirY.clone().multiplyScalar(a.tipLineLength));this.drawTipLine(o.DASHLINE_Y,u,h),this.drawOrigin(t,a.originRadius);var d=this.discretePointsX[44].clone();this.drawCubeX(o.CUBEX,d,a.cubeRadius);var f=this.discretePointsY[134].clone();this.drawCubeY(o.CUBEY,f,a.cubeRadius),this.updateBbox()}},{key:"hide",value:function(e){this.drawingImpl.hideAll(e)}},{key:"destroy",value:function(){this.drawingImpl.destroy()}},{key:"updateBbox",value:function(){this.boundingBox.makeEmpty();for(var e=0;e<this.discretePointsX.length;e++){var t=this.discretePointsX[e].clone();this.boundingBox.expandByPoint(t)}for(e=0;e<this.discretePointsY.length;e++){var t=this.discretePointsY[e].clone();this.boundingBox.expandByPoint(t)}var i=this.getCoordinateAxis(),n=this.drawingToCanvas(i.start.clone()),r=this.drawingToCanvas(i.endZ.clone());this.boundingBox.expandByPoint(n),this.boundingBox.expandByPoint(r),this.boundingBox.expandByScalar(5)}},{key:"insideBoundingBox",value:function(e){return this.boundingBox.containsPoint(e.clone())}},{key:"backwardCoordinate",value:function(){var e=this.cameraControl.camera.position,t=this.cameraControl.camera.target,i=t.clone().sub(e.clone()).normalize(),n=this.fillClipPlane.renderClipPlane.normal.clone();i.angleTo(n);Math.PI}}]),e}());e.CoordinateSystem=t}(),function(){var e=Object.freeze({SectionPlaneUpdate:"SectionPlaneUpdate"});Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section").SectionPlaneEvent=e}(),function(){var e="Bimface.Plugins.Section.SectionPlane",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Section"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),{Forward:0,Reverse:1}),r={X:0,Y:2,Z:4},a=function(e){var t=this,i=e.viewer;return i?i instanceof Glodon.Bimface.Viewer.Viewer3D?(i._sectionBox&&(i._sectionBox.hideBox(),i._sectionBox.exit()),i._sectionPlane?(i._sectionPlane.showPlane(),i._sectionPlane):(i._sectionPlane=this,t.id=e.id,t._opt=e,t.mode=e.mode,t._plane=e.plane,t._direction=e.direction,t._progress=e.progress,t.init(),void t.setPlane(e.plane))):void console.log("Viewer2D is not supported."):void console.log("domElement must not be empty.")};a.prototype={init:function(){t.send(e,"init"),this.enableCoordinate=!0;var i=this._opt.viewer.getViewer(),n=this;this.coordinateSystem=new Glodon.Bimface.Plugins.Section.CoordinateSystem(i),CLOUD.GlobalData.ClippingCaps=!0,i.editorManager.enableTool(i,CLOUD.EditToolMode.CLIP_FILL),this._sectionTool=i.getScene().getFillClipPlane();var r=this._opt.viewer;this._sectionTool.observer=function(){var e=Glodon.Bimface.Plugins.Section.SectionPlaneEvent;r.getEventManager().fireEvent(e.SectionPlaneUpdate,n)},this._sectionTool.enable(!0,!0),this.hookEvens()},hookEvens:function(){var e=this,t=this.coordinateSystem,i=this._opt.viewer.getViewer(),n=this._opt.viewer.getDomElement();i.registerEventListener(CLOUD.EVENTS.ON_CLIP_HOVER,function(i){if(0!=e.enableCoordinate)if(i.onClipPlane)t.update(),t.hide(!1),n.style.cursor="default";else{n.style.cursor="";var r=new THREE.Vector2(i.event.clientX,i.event.clientY);t.insideBoundingBox(r)?t.hide(!1):t.hide(!0)}}),i.registerEventListener(CLOUD.EVENTS.ON_CLIP_MOUSE_DOWN,function(e){}),i.registerEventListener(CLOUD.EVENTS.ON_CLIP_MOUSE_MOVE,function(e){t.update()}),i.registerEventListener(CLOUD.EVENTS.ON_EDITOR_ZOOM,function(e){t.update()}),i.registerEventListener(CLOUD.EVENTS.ON_CAMERA_ANIMATION_UPDATE,function(e){t.update()})},exit:function(){var e=this._opt.viewer.getViewer(),t=e.getScene().getFillClipPlane();e.editorManager.disableTool(CLOUD.EditToolMode.CLIP_FILL),CLOUD.GlobalData.ClippingCaps=!1,t.enable(!1,!1),this.coordinateSystem.destroy(),this._sectionTool=null,this._opt.viewer._sectionPlane=null},setProgress:function(i){t.send(e,"setProgress");var n=1-i/50;this._progress=i,this._sectionTool.setProcess(n)},getProgress:function(){return 50*(1-this._sectionTool.getProcess())},setPlane:function(i){t.send(e,"setPlane");var a=n[this._direction]+r[i];this._plane=i,this._sectionTool.changeNormal(a),this.setProgress(this._opt.progress)},getPlane:function(){return this._plane},setDirection:function(i){t.send(e,"setDirection");var a=n[i]+r[this._plane];this._direction=i,this._sectionTool.changeNormal(a),this.setProgress(this._opt.progress)},getDirection:function(){return this._direction},setRotateAngle:function(e,t){this._sectionTool.setRotateAngle(e,t)},getRotateAngle:function(){return this._sectionTool.getRotateAngle()},hidePlane:function(){t.send(e,"hidePlane"),this._sectionTool&&(this._sectionTool.visible=!1),this.enableCoordinate=!1,this.coordinateSystem.hide(!0)},showPlane:function(){t.send(e,"showPlane"),this._sectionTool&&(this._sectionTool.visible=!0),this.enableCoordinate=!0},rotateByAxis:function(i,a){if(t.send(e,"rotateByAxis"),"YAxis"!==i&&"ZAxis"!==i)return void console.log("Rotate axis must be YAxis or ZAxis.");var o="",s=0,l=n[this.getDirection()]+r[this._plane];0==l||1==l?(s="YAxis"===i?-a:a,o="YAxis"===i?"y":"z"):2==l||3==l?(s="YAxis"===i?-a:a,o="YAxis"===i?"x":"z"):4!=l&&5!=l||(s="YAxis"===i?a:-a,o="YAxis"===i?"x":"y"),this._sectionTool&&this._sectionTool.rotateAngleOffset(s,o)},reset:function(){t.send(e,"reset");var i=this;i.setPlane(i._opt.plane),i.setDirection(i._opt.direction),i.setProgress(i._opt.progress)},getState:function(){return this._sectionTool.store()},isIncluded:function(e){var t=this._opt.viewer,i=t.getViewer().getScene(),n=i.getFillClipPlane(),r=n.getFillClipBoundingBox(),a=t.worldToScene(e);return r.containsPoint(a)},setState:function(i){t.send(e,"setState"),this._sectionTool.restore(i)},restoreRotation:function(){this._sectionTool.restoreRotation()}},i.SectionPlane=a}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Walkthrough"),t=function(){return{viewer:null,time:10,stopCallback:null}};e.WalkthroughConfig=t}(),function(){var e="Bimface.Plugins.Walkthrough",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Walkthrough"),n=(Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.HttpRequest"),function(){function i(e){_classCallCheck(this,i);var t=e.viewer,n=t.getViewer();return t?t instanceof Glodon.Bimface.Viewer.Viewer3D?(this._viewer=t,this.bPause=!0,this.cameraStatus=null,this._walkthrough=new CLOUD.Walkthrough,this._player=new CLOUD.WalkthroughPlayer(n),this._player.setWalkthrough(this._walkthrough),e.stopCallback&&this._player.addStopPlayCallback(e.stopCallback),void this.setWalkthroughTime(e.time)):void console.log("Viewer2D is not supported."):void console.log("viewer must be empty.")}return _createClass(i,[{key:"addKeyFrame",value:function(){t.send(e,"addKeyFrame");var i=this._viewer,n=i.getViewer().camera,r={id:Glodon.Web.Lang.Utility.UUID.createUUID(),position:n.position.clone(),target:n.target.clone()};return this._walkthrough.addKeyFrame(r),r}},{key:"setKeyFrameCallback",value:function(i){t.send(e,"setKeyFrameCallback"),this._player.setKeyFrameCallback(i)}},{key:"removeKeyFrame",value:function(i){t.send(e,"removeKeyFrame"),this._walkthrough.removeKeyFrame(i)}},{key:"clearKeyFrames",value:function(){t.send(e,"clearKeyFrames"),this._walkthrough.clearFrames()}},{key:"setKeyFrames",value:function(i){t.send(e,"setKeyFrames"),"string"==typeof i&&(i=JSON.parse(i)),this._walkthrough.setKeyFrameList(i)}},{key:"getKeyFrames",value:function(){return this._walkthrough.getKeyFrames()}},{key:"setWalkthroughTime",value:function(i){t.send(e,"setWalkthroughTime"),this._walkthrough.setWalkthroughTime(i)}},{key:"play",value:function(i){t.send(e,"play");var n=this._player,r=this.cameraStatus;if(i&&n.startFrom(i),n.stop(!1),!0===this.bPause){var a=this._viewer.getViewer().getCamera();r&&function(e){var e=JSON.parse(e),t=e.position,i=e.target,n={position:new THREE.Vector3(t.x,t.y,t.z),target:new THREE.Vector3(i.x,i.y,i.z)},a=r,o=n.position.clone().sub(a.position),s=n.target.clone().sub(a.target);return o.length()>0||s.length()>0}(a)?this._viewer.setCameraStatus(r,function(){n.play(),r=null}):n.play()}else n.play();this.bPause=!1}},{key:"pause",value:function(){t.send(e,"pause"),this.bPause=!0,this.cameraStatus=this._viewer.getCameraStatus(),this._player.pause()}},{key:"stop",value:function(){t.send(e,"stop"),this._player.stop(!0),this._stopCallback&&this._stopCallback()}},{key:"stopCallback",value:function(i){t.send(e,"stopCallback"),i&&(this._stopCallback=i,this._player.addStopPlayCallback(i))}}]),i}());i.Walkthrough=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Segment"),t=function(){return{viewer:null}};e.SegmentConfig=t}(),function(){Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Segment").IsolateOption=Object.freeze({Hidden:"Hidden",Translucent:"Translucent",PartlyTranslucent:"PartlyTranslucent"})}(),function(){var e="Bimface.Plugins.Segment",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Segment"),n=function(){function i(e){_classCallCheck(this,i),this._viewer=e.viewer,this._segmentInfoMap=null,this._segmentInfoArray=null,this._segmentIdArray=null,this._elementIdMap={},this._loading=!1,this._segmentInfoAcquired=!1,this._segmentIdMapFromComponentId=null}return _createClass(i,[{key:"destroy",value:function(){this._viewer=null,this._segmentInfoMap=null,this._segmentInfoArray=null,this._segmentIdArray=null,this._elementIdMap=null,this._segmentIdMapFromComponentId=null}},{key:"_hasSegmentInfo",value:function(e){return!(!this._segmentInfoMap||!this._segmentInfoMap[e])}},{key:"_getSegmentInfoById",value:function(e){return this._segmentInfoMap?this._segmentInfoMap[e]:null}},{key:"_removeDuplication",value:function(e){for(var t={},i=0,n=e.length;i<n;i++)this._hasSegmentInfo(e[i])&&!t[e[i]]&&(t[e[i]]=!0);return Object.keys(t)}},{key:"_getSegmentElementIdsByIdx",value:function(e,t,i){var n=this,r=this._viewer,a=e[t];r.getSegmentElementIds(a,function(e){e.data&&(n._elementIdMap[a]=e.data),i&&i()},function(){i&&i()})}},{key:"_getSegmentElementIds",value:function(e){function t(i,a){var o=a;return function(){r._getSegmentElementIdsByIdx(i,o,function(){o<n-1?requestAnimationFrame(t(i,o+1)):e&&e()})}}var i=this._segmentIdArray,n=i.length,r=this;this._elementIdMap={},n>0?requestAnimationFrame(t(i,0)):e&&e()}},{key:"_getSegmentMetadataByIdx",value:function(e,t,i){var n=this._viewer,r=e[t],a=this.segmentFilePathMap[r].metadata,o=this.segmentFilePathMap[r].databag;n.getSegmentManager().getSegmentMetadata(o,a,function(){i&&i()},function(){i&&i()})}},{key:"_getSegmentMetadata",value:function(e){function t(i,a){var o=a;return function(){r._getSegmentMetadataByIdx(i,o,function(){o<n-1?requestAnimationFrame(t(i,o+1)):e&&e()})}}var i=Object.keys(this.segmentFilePathMap),n=i.length,r=this;n>0?requestAnimationFrame(t(i,0)):e&&e()}},{key:"_loadMetadata",value:function(e){for(var t=this._viewer,i=this._segmentIdArray,n=this.segmentFilePathMap={},r=this.segmentFileInfoMap={},a=0,o=i.length;a<o;a++){var s=i[a],l=this._getSegmentInfoById(s),c=l.partialElementFiles,u=[];if(c)for(var h=0,d=c.length;h<d;h++){var f=c[h].databagId;if(f){var p=null;n[f]?p=n[f]:(p={databag:t.getDatabagResource(f),metadata:t.getPartialElementsMetadataFile(f),fileId:c[h].fileId},n[f]=p),u.push(p)}}r[s]={id:s,paths:u,elementIds:this._elementIdMap[s]}}this._getSegmentMetadata(e)}},{key:"_loadSegments",value:function(e,t){if(!(e=e||this._segmentIdArray))return void(t&&t());for(var i=this._viewer,n=this._removeDuplication(e),r=[],a=0,o=n.length;a<o;a++){var s=this.segmentFileInfoMap[n[a]];s&&r.push(s)}if(0===r.length)return void(t&&t());i.getSegmentManager().loadSegments(r,function(){t&&t()})}},{key:"getSegmentInfo",value:function(i){function n(e,t){if(e.subGroups)for(var i=e.subGroups,r=0,a=i.length;r<a;r++)n(i[r],t);else if(e.segments)for(var o=0,s=e.segments.length;o<s;o++){var l=e.segments[o];t[l.id]=l}}if(t.send(e,"getSegmentInfo"),this._loading)return null;if(this._segmentInfoAcquired)return i&&i(this._segmentInfoArray),this._segmentInfoArray;var r=this;return this._loading=!0,this._viewer.getSegmentTree(function(e){for(var t=e.data,a=r._segmentInfoMap={},o=0,s=t.length;o<s;o++)n(t[o],a);r._segmentIdArray=Object.keys(r._segmentInfoMap),r._segmentInfoArray=[];for(var l=r._segmentInfoArray.length=r._segmentIdArray.length,c=0;c<l;c++)r._segmentInfoArray[c]=r._segmentInfoMap[r._segmentIdArray[c]];r._getSegmentElementIds(function(){r._loadMetadata(function(){r._loading=!1,r._segmentInfoAcquired=!0,i&&i(r._segmentInfoArray)})})},function(e){console.error("request segment data error!")}),null}},{key:"loadSegments",value:function(i,n){if(t.send(e,"loadSegments"),this._segmentInfoAcquired)this._loadSegments(i,n);else{var r=this;this.getSegmentInfo(function(e){r._loadSegments(i,n)})}}},{key:"unloadSegments",value:function(i){t.send(e,"unloadSegments"),(i=i||this._segmentIdArray)&&(this._viewer.getSegmentManager().unloadSegments(this._removeDuplication(i)),this._viewer.render())}},{key:"hideComponentsBySegment",value:function(i){t.send(e,"hideComponentsBySegment"),this._viewer.getSegmentManager().hideComponentsBySegment(this._removeDuplication(i)),this._viewer.render()}},{key:"showComponentsBySegment",value:function(i){t.send(e,"showComponentsBySegment"),this._viewer.getSegmentManager().showComponentsBySegment(this._removeDuplication(i)),this._viewer.render()}},{key:"isolateComponentsBySegment",value:function(i,n){t.send(e,"isolateComponentsBySegment");var r=void 0,a=Glodon.Bimface.Plugins.Segment.IsolateOption;switch(n){case a.Hidden:r=this._viewer.getSegmentManager().getSegmentIsolateOption().HIDDEN;break;case a.Translucent:r=this._viewer.getSegmentManager().getSegmentIsolateOption().TRANSLUCENT;break;case a.PartlyTranslucent:r=this._viewer.getSegmentManager().getSegmentIsolateOption().PARTLYTRANSLUCENT}void 0!==r&&(this._viewer.getSegmentManager().isolateComponentsBySegment(this._removeDuplication(i),r),this._viewer.render())}},{key:"disable",value:function(){this._viewer.getSegmentManager().disable(),this._viewer.render()}},{key:"enable",value:function(){this._viewer.getSegmentManager().enable(),this._viewer.render()}},{key:"getSegementIds",value:function(e){if(!this._segmentInfoAcquired)return console.error("Call the function getSegmentInfo() first!"),null;if(this._segmentIdMapFromComponentId)return this._segmentIdMapFromComponentId[e];for(var t=this._segmentIdMapFromComponentId={},i=Object.keys(this._elementIdMap),n=0,r=i.length;n<r;n++)for(var a=i[n],o=this._elementIdMap[a],s=0,l=o.length;s<l;s++){var c=o[s];t[c]||(t[c]=[]),t[c].push(a)}var u=this._viewer.getSegmentManager().getSegmentIdsByPartialElementId(e);return u&&(t[e]=u),t[e]}}]),i}();i.Segment=n}(),function(){var e="Bimface.Plugins.Material.Material",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Material"),n=function(){function i(n){return _classCallCheck(this,i),t.send(e,"bf_c_mat_newMat"),n?(this.id=n.id,this.offset=n.offset,this.rotation=n.rotation,this.scale=n.scale,this.src=n.src,this.viewer=n.viewer,!this.viewer||!this.viewer instanceof Glodon.Bimface.Viewer.Viewer3D?void console.log("ERROR::viewer must not be empty or viewer2d."):(this.material=new THREE.MeshStandardMaterial,this.material.name=this.id,this._loadTexture(),void(this.objectList=[]))):void console.log("ERROR::materialConfig must not be empty.")}return _createClass(i,[{key:"_loadTexture",value:function(e,t){var i=new THREE.Texture,n=this,r=new THREE.ImageLoader;r.setCrossOrigin("anonymous"),r.load(this.src,function(t){i.image=CLOUD.MaterialUtil.ensurePowerOfTwo(t),i.needsUpdate=!0,i.offset.fromArray(n.offset),i.setRotateAngle(n.rotation),i.repeat.fromArray(n.scale),i.wrapS=THREE.RepeatWrapping,i.wrapT=THREE.RepeatWrapping,n.material.map=i,n.material.needsUpdate=!0,e&&onLoad(i)},null,function(e){console.log(e),t&&t(e)})}},{key:"overrideComponentsMaterialById",value:function(i){if(t.send(e,"bf_c_mat_override"),i instanceof Array){var n=this.viewer.getViewer().getFilter();this.objectList=i,n.addToOverrideListByMaterialAndId(i,this.material)}else console.log("ERROR::ids should be Array")}},{key:"clearOverrideComponentsMaterial",value:function(){this.viewer.getViewer().getFilter().addToOverrideListByMaterialAndId(this.objectList,null)}},{key:"getId",value:function(){return t.send(e,"bf_c_mat_getId"),this.id}},{key:"getOffset",value:function(){return this.offset}},{key:"getRotation",value:function(){return this.rotation}},{key:"getScale",value:function(){return this.scale}},{key:"getSrc",value:function(){return this.src}},{key:"setOffset",value:function(e){e instanceof Array&&2==e.length?(this.offset=e,this.material&&this.material.map&&(this.material.map.offset.fromArray(e),this.material.needsUpdate=!0)):console.log("ERROR::offset should be array of 2 elements")}},{key:"setRotation",value:function(i){t.send(e,"bf_c_mat_setRotation"),this.rotation=i,this.material&&this.material.map&&(this.material.map.setRotateAngle(i),this.material.needsUpdate=!0)}},{key:"setScale",value:function(i){t.send(e,"bf_c_mat_setScale"),i instanceof Array&&2==i.length?(this.scale=i,this.material&&this.material.map&&(this.material.map.repeat.fromArray(i),this.material.needsUpdate=!0)):console.log("ERROR::scale should be array of 2 elements")}},{key:"setSrc",value:function(e){this.src=e,this._loadTexture()}}]),i}();i.Material=n}(),function(){var e=(Glodon.Bimface.Data.StatisticsDataManager.getInstance(),Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Material")),t=function e(){_classCallCheck(this,e),this.id=Glodon.Web.Lang.Utility.UUID.createUUID(),this.offset=[0,0],this.rotation=0,this.scale=[1,1],this.src=null,this.viewer=null};e.MaterialConfig=t}(),function(){var e="Bimface.Plugins.Material.MaterialContainer",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Material"),n=function(){function i(){_classCallCheck(this,i),t.send(e,"bf_c_mat_newMatContainer"),this.materials={}}return _createClass(i,[{key:"addMaterial",value:function(e){this.materials[e.id]=e}},{key:"clear",value:function(){for(var e in this.materials)this.materials[e].clearOverrideComponentsMaterial();this.materials={}}},{key:"removeMaterialById",value:function(e){this.materials[e]&&(this.materials[e].clearOverrideComponentsMaterial(),delete this.materials[e])}},{key:"getAllMaterials",value:function(){return Object.values(this.materials)}},{key:"getMaterialById",value:function(e){return this.materials[e]}}]),i}();i.MaterialContainer=n}(),function(){var e="Bimface.Plugins.Animation.AnimationContainer",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Animation"),n=function(){function i(){_classCallCheck(this,i),t.send(e,"bf_c_animation_newContainer"),this.animations={}}return _createClass(i,[{key:"addAnimation",value:function(e){this.animations[e.id]=e}},{key:"clear",value:function(){for(var e in this.animations)this.animations[e].stop();this.animations={}}},{key:"getAllAnimations",value:function(){return Object.values(this.animations)}},{key:"getAnimationById",value:function(e){return this.animations[e]}},{key:"removeAnimationById",value:function(e){this.animations[e]&&(this.animations[e].stop(),delete this.animations[e])}}]),i}();i.AnimationContainer=n}(),function(){var e="Bimface.Plugins.Animation.FlowEffect",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Animation"),n=function(){function i(n){return _classCallCheck(this,i),t.send(e,"bf_c_flow_newFlow"),n?(this.material=n.material,this.speed=n.speed,this.viewer=n.viewer,this.id=n.id,!this.viewer||!this.viewer instanceof Glodon.Bimface.Viewer.Viewer3D?void console.log("ERROR::viewer must not be empty or viewer2d."):void(this.animationId=0)):void console.log("ERROR::flowEffectConfig must not be empty.")}return _createClass(i,[{key:"getSpeed",value:function(){return this.speed}},{key:"setSpeed",value:function(i){t.send(e,"bf_c_flow_setSpeed"),i instanceof Array&&2==i.length?this.speed=i:console.log("ERROR::speed should be array of 2 elements")}},{key:"play",value:function(){function e(){t.animationId=requestAnimationFrame(e);var i=t.material.getOffset();t.material.setOffset([i[0]+t.speed[0],i[1]+t.speed[1]]),t.viewer.render()}var t=this;e()}},{key:"stop",value:function(){cancelAnimationFrame(this.animationId)}},{key:"getId",value:function(){return t.send(e,"bf_c_flow_id"),this.id}}]),i}();i.FlowEffect=n}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Animation"),t=function e(){_classCallCheck(this,e),this.id=Glodon.Web.Lang.Utility.UUID.createUUID(),this.material=null,this.speed=[0,0],this.viewer=null};e.FlowEffectConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.AxisGrid"),i=function(){function t(e){_classCallCheck(this,t),this.svgContainer=e,this.initialize(),this.visibility=!1}return _createClass(t,[{key:"initialize",value:function(){var t=e.createNS("line","bf-axisgrid-line"),i=t.cloneNode();i.style.strokeWidth=1,i.style.stroke="#ffffff",i.style.opacity=.5,this.svgContainer.appendChild(i),this.lineLeft=i;var n=t.cloneNode();n.style.strokeWidth=1,n.style.stroke="#ffffff",n.style.opacity=.5,this.svgContainer.appendChild(n),this.lineRight=n}},{key:"updateBorderLeft",value:function(e,t){var i=new THREE.Vector2(e.x,e.y),n=new THREE.Vector2(t.x,t.y);e.y==t.y?(i.y-=2,n.y-=2):(i.x-=2,n.x-=2),this.moveLineTo(this.lineLeft,i,n)}},{key:"updateBorderRight",value:function(e,t){var i=new THREE.Vector2(e.x,e.y),n=new THREE.Vector2(t.x,t.y);e.y==t.y?(i.y+=2,n.y+=2):(i.x+=2,n.x+=2),this.moveLineTo(this.lineRight,i,n)}},{key:"hide",value:function(){this.lineLeft.style.display="none",this.lineRight.style.display="none",this.visibility=!1}},{key:"show",value:function(){this.lineLeft.style.display="block",this.lineRight.style.display="block",this.visibility=!0}},{key:"update",value:function(e,t){0!=this.visibility&&(this.updateBorderLeft(e,t),this.updateBorderRight(e,t))}},{key:"moveLineTo",value:function(e,t,i){e.setAttribute("x1",t.x),e.setAttribute("y1",t.y),e.setAttribute("x2",i.x),e.setAttribute("y2",i.y)}}]),t}();t.HighlightBorderLines=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.AxisGrid"),i=function(){function t(e,i){_classCallCheck(this,t),this.svgContainer=e,this.viewer=i,this.borderline=new Glodon.Bimface.Plugins.AxisGrid.HighlightBorderLines(e),this.initialize(),this.visibility=!1}return _createClass(t,[{key:"initialize",value:function(){var t=e.createNS("line","bf-axisgrid-line");t.style.strokeWidth=2,t.style.stroke="#32D5A7",this.svgContainer.appendChild(t),this.line=t}},{key:"hide",value:function(){this.line.style.display="none",this.borderline.hide(),this.visibility=!1}},{key:"show",value:function(){this.line.style.display="block",this.borderline.show(),this.visibility=!0}},{key:"setLine",value:function(e){this.highlightLine=e}},{key:"setHeight",value:function(e){this.axisgridHeight=e}},{key:"update",value:function(){if(0!=this.visibility){var e=this.highlightLine,t=new THREE.Vector3(e[0],e[1],this.axisgridHeight),i=new THREE.Vector3(e[3],e[4],this.axisgridHeight),n=this.worldPointsToClient(t,i);n&&(this.moveLineTo(this.line,n.start,n.end),this.borderline.update(n.start,n.end))}}},{key:"worldPointsToClient",value:function(e,t){var i=this.viewer.getDomElement(),n=i.getBoundingClientRect(),r=this.viewer.getViewer(),a=r.worldPointsToClient(e,t);return a&&(a.start.x-=n.left,a.start.y-=n.top,a.end.x-=n.left,a.end.y-=n.top),a}},{key:"moveLineTo",value:function(e,t,i){e.setAttribute("x1",t.x),e.setAttribute("y1",t.y),e.setAttribute("x2",i.x),e.setAttribute("y2",i.y)}}]),t}();t.HighlightLine=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.AxisGrid"),i=function(){function t(e,i){_classCallCheck(this,t),this.svgContainer=e,this.viewer=i,this.horizBorderline=new Glodon.Bimface.Plugins.AxisGrid.HighlightBorderLines(e),this.verticalBorderline=new Glodon.Bimface.Plugins.AxisGrid.HighlightBorderLines(e),this.initialize(),this.visibility=!1}return _createClass(t,[{key:"initialize",value:function(){var t=e.createNS("line","bf-axisgrid-line"),i=t.cloneNode();i.style.strokeWidth=2,i.style.stroke="#32D5A7",this.svgContainer.appendChild(i),this.svgHorizLine=i;var n=t.cloneNode();n.style.strokeWidth=2,n.style.stroke="#32D5A7",this.svgContainer.appendChild(n),this.svgVerticalLine=n;var r=e.createNS("circle","bf-axisgrid-point");r.setAttribute("r",3),r.setAttribute("fill","#32D5A7"),this.svgContainer.appendChild(r),this.hoverPoint=r}},{key:"setLine",value:function(e,t){this.horizLine=e,this.verticalLine=t}},{key:"setPoint",value:function(e){this.intersectPoint=e}},{key:"setHeight",value:function(e){this.axisgridHeight=e}},{key:"update",value:function(){if(0!=this.visibility){var e=this.horizLine,t=this.verticalLine,i=this.viewer.worldToClient(this.intersectPoint),n=new THREE.Vector3(e[0],e[1],this.axisgridHeight),r=new THREE.Vector3(e[3],e[4],this.axisgridHeight),a=new THREE.Vector3(t[0],t[1],this.axisgridHeight),o=new THREE.Vector3(t[3],t[4],this.axisgridHeight),s=this.worldPointsToClient(n,r);s&&(this.moveLineTo(this.svgHorizLine,s.start,s.end),this.horizBorderline.update(s.start,s.end));var l=this.worldPointsToClient(a,o);l&&(this.moveLineTo(this.svgVerticalLine,l.start,l.end),this.verticalBorderline.update(l.start,l.end)),this.movePointTo(this.hoverPoint,i.x,i.y)}}},{key:"worldPointsToClient",value:function(e,t){var i=this.viewer.getDomElement(),n=i.getBoundingClientRect(),r=this.viewer.getViewer(),a=r.worldPointsToClient(e,t);return a&&(a.start.x-=n.left,a.start.y-=n.top,a.end.x-=n.left,a.end.y-=n.top),a}},{key:"hide",value:function(){this.svgHorizLine.style.display="none",this.svgVerticalLine.style.display="none",this.hoverPoint.style.display="none",this.horizBorderline.hide(),this.verticalBorderline.hide(),this.visibility=!1}},{key:"show",value:function(){this.svgHorizLine.style.display="block",this.svgVerticalLine.style.display="block",this.hoverPoint.style.display="block",this.horizBorderline.show(),this.verticalBorderline.show(),this.visibility=!0}},{key:"moveLineTo",value:function(e,t,i){e.setAttribute("x1",t.x),e.setAttribute("y1",t.y),e.setAttribute("x2",i.x),e.setAttribute("y2",i.y)}},{key:"movePointTo",value:function(e,t,i){e.setAttribute("cx",t),e.setAttribute("cy",i)}}]),t}();t.HighlightIntersectLines=i}(),function(){var e="Bimface.Plugins.AxisGrid",t=Glodon.Bimface.Data.StatisticsDataManager.getInstance(),i=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),n=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.AxisGrid"),r=function(){function n(r){_classCallCheck(this,n),t.send(e,"AxisGridManager"),this.snapMinDistance=5,this.viewer=r.viewer,this.registerEvent(),this.domContainer=i.create("div","bf-axisgrid-conext"),this.domContainer.style.position="absolute",this.domContainer.style.left=0,this.domContainer.style.top=0,this.domContainer.style.width="100%",this.domContainer.style.height="100%",this.svgContainer=i.createNS("svg","bf-axisgrid-svg"),this.svgContainer.style.width="100%",this.svgContainer.style.height="100%",this.domContainer.appendChild(this.svgContainer),this.viewer.getDomElement().appendChild(this.domContainer);var a=Glodon.Bimface.Plugins.AxisGrid;this.highlightLine=new a.HighlightLine(this.svgContainer,this.viewer),this.highlightIntersectLines=new a.HighlightIntersectLines(this.svgContainer,this.viewer)}return _createClass(n,[{key:"registerEvent",value:function(){var e=Glodon.Bimface.Viewer.Viewer3DEvent,t=this,i=this.viewer.getEventManager(),n=null,r={component:"Component",room:"Room",axisGrids:"AxisGrids"};this.viewer.addEventListener(e.AxisGridHover,function(a){var o=a.snap.point,s=a.snap.height,l=a.snap.snapLines,c=a.snap.nearestPoint,u=l.intersectLines,h=l.gridLine,d=t.viewer.worldToClient(o),f=t.viewer.worldToClient(c.toGridLine),p=t.viewer.worldToClient(c.toIntersection),m=t.distance(d,f),g=t.distance(d,p),v=null;if(g<=t.snapMinDistance&&void 0!==u){t.highlightIntersectLines.show(),t.highlightLine.hide();var y=u[0],E=u[1];v=y.name+"-"+E.name,t.highlightIntersectLines.setHeight(s),t.highlightIntersectLines.setLine(y,E),t.highlightIntersectLines.setPoint(c.toIntersection),t.highlightIntersectLines.update()}else m<=t.snapMinDistance?(v=h.name,t.highlightLine.show(),t.highlightIntersectLines.hide(),t.highlightLine.setHeight(s),t.highlightLine.setLine(h),t.highlightLine.update(s)):(n=null,t.highlightLine.hide(),t.highlightIntersectLines.hide());n!=v&&(g<=t.snapMinDistance||m<=t.snapMinDistance)&&(i.fireEvent(e.Hover,{objectType:r.axisGrids,objectId:v,worldPostion:o}),n=v)}),this.viewer.addEventListener(e.Rendered,function(){t.highlightLine.update(),t.highlightIntersectLines.update()})}},{key:"distance",value:function(e,t){var i=e.x-t.x,n=e.y-t.y,r=e.z-t.z;return Math.sqrt(i*i+n*n+r*r)}}]),n}()
;n.AxisGridManager=r}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.AxisGrid"),t=function(){return{viewer:null}};e.AxisGridManagerConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Snap"),t=function(){return{id:null,color:new Glodon.Web.Graphics.Color(249,157,11,1),hoverColor:new Glodon.Web.Graphics.Color(17,218,183,.2),objectColor:new Glodon.Web.Graphics.Color(17,218,183,.9),width:3,radius:25,viewer:null}};e.SnapConfig=t}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Snap"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=function(e){this.viewer=e.viewer,this.maxPointsNum=1;var i=new Glodon.Web.Graphics.Color(17,218,183,.2),n=t.createNS("circle","bf-snap-handle");n.setAttribute("r",e.width),n.setAttribute("fill",i.getRGB()),n.style.fill=i.getRGB();var r=t.createNS("line","bf-snap-line");r.style.strokeWidth=2,r.style.stroke=i.getRGB();var a=t.createNS("polygon","bf-snap-rect");a.setAttribute("fill",i.getRGBA()),a.setAttribute("stroke",i.getRGB()),a.setAttribute("stroke-width",1),this.hoverLine=r,this.hoverPoint=n,this.hoverPanel=a,this.hoverPanelSize={width:20,height:20}},n={stretchOnDirection:function(e,t,i){var n=e.clone().add(t).multiplyScalar(.5),r=t.clone().sub(e).normalize();return[n.clone().sub(r.clone().multiplyScalar(i/2)),n.clone().add(r.clone().multiplyScalar(i/2))]},draw:function(e){var t=this.hoverLine,i=this.hoverPoint,n=this.hoverPanel,r=this.hoverPanelSize;switch(e.hoverObjectType){case"Point":i.setAttribute("cx",e.hoverPosition.x),i.setAttribute("cy",e.hoverPosition.y),e.svg.appendChild(i);break;case"Line":t.setAttribute("x1",e.lineStartPoint.x),t.setAttribute("y1",e.lineStartPoint.y),t.setAttribute("x2",e.lineEndPoint.x),t.setAttribute("y2",e.lineEndPoint.y),e.svg.appendChild(t);break;case"Panel":var a=e.clientPts,o=a[0].distanceTo(a[1]),s=a[0].distanceTo(a[3]),l=o/r.width,c=s/r.height;if(1!=l){var u=this.stretchOnDirection(a[0],a[1],r.width),h=this.stretchOnDirection(a[2],a[3],r.width);a=u.concat(h)}if(1!=c){var u=this.stretchOnDirection(a[0],a[3],r.height),h=this.stretchOnDirection(a[1],a[2],r.height);a=[u[0],h[0],h[1],u[1]]}for(var d="",f=0;f<a.length;f++)d+=a[f].x+",",d+=a[f].y+" ";n.setAttribute("points",d),e.svg.appendChild(n)}}};i.prototype=Object.assign(i.prototype,n),e.SnapItem=i}(),function(){var e=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Bimface.Plugins.Snap"),t=Glodon.Web.Lang.Utility.Namespace.ensureNamespace(Glodon,"Web.Lang.Utility.Dom"),i=null,n=[],r=null,a=null,o=function(e){var i=e.viewer,n=this;n.isOpen=!1;var r=new Glodon.Web.Lang.EventManager,a=t.create("div","bf-snap-conext");this.context={rootDomElement:a},this._opt=e,this.getEventManager=function(){return r},n.init(e),i.addEventListener("Rendered",function(){n.isOpen&&n.update()})};o.prototype={init:function(e){var i=this,n=i.context,r=i._opt.viewer;r.getViewer();i.isOpen=!0,r.getDomElement().appendChild(n.rootDomElement),r.setSelectedComponentsById();var a=(r.getDomElement(),t.createNS("svg","bf-snap-svg"));n.rootDomElement.innerHTML="",n.rootDomElement.appendChild(a),n.svg=a;var o=new Glodon.Bimface.Plugins.Snap.SnapItem(e);i.snapItem=o,r.render()},snapByPoint:function(e){var t=this;e&&(i=e.pickPoint?e.pickPoint:null,e.pickPlane?(r="Panel",a=e.normal):e.pickLine?(r="Line",n=e.pickLine):r=e.pickPoint?"Point":null,t.update())},update:function(){var e=this.context,t=this._opt.viewer,o=t.getDomElement(),s=o.getBoundingClientRect(),l=t.getViewer(),c=[],u=[];if(this.context.svg.innerHTML="",i?(e.hoverPosition=t.worldToClient(i),e.hoverPositionDS=l.getScene().worldToDrawing(i)):e.hoverPosition=null,e.hoverObjectType=r,"Line"==r&&2==n.length){e.lineStartPoint=t.worldToClient(n[0]),e.lineEndPoint=t.worldToClient(n[1]);var h=new THREE.Vector2(e.lineStartPoint.x,e.lineStartPoint.y),d=new THREE.Vector2(e.lineEndPoint.x,e.lineEndPoint.y),f=new THREE.Box2;f.min.set(o.clientLeft,o.clientTop),f.max.set(f.min.x+o.clientWidth,f.min.y+o.clientHeight);var p=!f.containsPoint(h),m=!f.containsPoint(d),g={start:h,end:d},v=CLOUD.CameraUtil.lineIntersectWithRect(g,f);if(p&&m)2==v.length&&(e.lineStartPoint=v[0],e.lineEndPoint=v[1]);else if(p||m)for(var y=new THREE.Vector2(e.hoverPosition.x,e.hoverPosition.y),E=p?d.clone():h.clone(),x=E.clone().sub(y).normalize(),b=0;b<v.length;b++){var C=E.clone().sub(v[b]).normalize();if(C.dot(x)>0){e.lineStartPoint=E,e.lineEndPoint=v[b];break}}}if("Panel"==e.hoverObjectType){e.normal=l.getScene().worldToDrawing(a),e.normal.normalize();var M=l.cameraControl,_=new THREE.Plane;_.setFromNormalAndCoplanarPoint(e.normal,e.hoverPositionDS);var w=new THREE.Vector2(e.hoverPosition.x-10,e.hoverPosition.y-10),L=new THREE.Vector2(e.hoverPosition.x+10,e.hoverPosition.y-10),T=e.hoverPositionDS,I=M.getRaycaster(w.x,w.y),h=I.ray.intersectPlane(_);I=M.getRaycaster(L.x,L.y);var d=I.ray.intersectPlane(_);if(null==h||null==d)return;var S=new THREE.Vector3(1,0,0),O=new THREE.Vector3(0,1,0),D=new THREE.Vector3(0,0,1),R=Math.abs(e.normal.clone().dot(S))<=.0025,A=Math.abs(e.normal.clone().dot(D))<=.0025;if(R&&A)var U=S.clone(),B=D.clone();else var P=O.clone(),U=P.cross(e.normal).normalize(),B=e.normal.clone().cross(U).normalize();var N=h.distanceTo(d)/2,k=U.clone().multiplyScalar(N),F=B.clone().multiplyScalar(N),H=T.clone().sub(k).add(F),G=T.clone().add(k).add(F),V=T.clone().sub(k).sub(F),z=T.clone().add(k).sub(F),W=[];W.push(H,G,z,V);for(var q=[],j=M.getContainerDimensions(),X=0;X<W.length;X++){var Y=CLOUD.CameraUtil.drawingToCanvas(M.camera,W[X],j.width,j.height);q.push(new THREE.Vector3(Y.x,Y.y,0))}e.clientPts=q}for(var b=0;b<c.length-1;b++){var Z=l.worldPointsToClient(c[b],c[b+1]);if(Z){var K={x:Z.start.x-s.left,y:Z.start.y-s.top};u.push(K)}}e.clientPoints=u,this.snapItem.draw(e)},reset:function(){this.context.svg.innerHTML=""},destroy:function(){var e=this.context.rootDomElement,t=this;t.reset(),e.remove(),t.snapItem=null,t.isOpen=!1}},e.Snap=o}(),window.Glodon=Glodon;